{"file_contents":{"client/src/components/NotificationBell.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Bell } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport type { Notification } from \"@/../../shared/schema\";\n\nexport default function NotificationBell() {\n  const [open, setOpen] = useState(false);\n  const wsRef = useRef<WebSocket | null>(null);\n  const reconnectTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const { data: notifications = [] } = useQuery<Notification[]>({\n    queryKey: [\"/api/notifications\"],\n    refetchInterval: 30000,\n  });\n\n  // WebSocket connection for real-time notifications\n  useEffect(() => {\n    let mounted = true;\n\n    const connectWebSocket = async () => {\n      try {\n        // Get WebSocket token\n        const tokenResponse = await fetch(\"/api/auth/ws-token\", { credentials: \"include\" });\n        if (!tokenResponse.ok) {\n          console.log(\"Not authenticated, skipping WebSocket for notifications\");\n          return;\n        }\n\n        const { token } = await tokenResponse.json();\n        if (!token || !mounted) return;\n\n        // Connect to WebSocket\n        const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n        const wsUrl = `${protocol}//${window.location.host}/ws`;\n        \n        const socket = new WebSocket(wsUrl);\n        \n        socket.onopen = () => {\n          console.log(\"NotificationBell: WebSocket connected, authenticating...\");\n          socket.send(JSON.stringify({ type: \"auth\", token }));\n        };\n\n        socket.onmessage = (event) => {\n          try {\n            const data = JSON.parse(event.data);\n            \n            if (data.type === \"auth_success\") {\n              console.log(\"NotificationBell: WebSocket authenticated\");\n            } else if (data.type === \"new_notification\") {\n              console.log(\"NotificationBell: Received new notification via WebSocket\");\n              // Invalidate the notifications cache to refresh the list\n              queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n            }\n          } catch (error) {\n            console.error(\"Error parsing WebSocket message:\", error);\n          }\n        };\n\n        socket.onclose = () => {\n          console.log(\"NotificationBell: WebSocket disconnected\");\n          wsRef.current = null;\n          \n          // Attempt to reconnect after 5 seconds\n          if (mounted) {\n            reconnectTimeoutRef.current = setTimeout(() => {\n              if (mounted) connectWebSocket();\n            }, 5000);\n          }\n        };\n\n        socket.onerror = (error) => {\n          console.error(\"NotificationBell: WebSocket error:\", error);\n        };\n\n        wsRef.current = socket;\n      } catch (error) {\n        console.error(\"Failed to connect WebSocket for notifications:\", error);\n      }\n    };\n\n    connectWebSocket();\n\n    return () => {\n      mounted = false;\n      if (reconnectTimeoutRef.current) {\n        clearTimeout(reconnectTimeoutRef.current);\n      }\n      if (wsRef.current) {\n        wsRef.current.close(1000, \"Component unmounting\");\n        wsRef.current = null;\n      }\n    };\n  }, []);\n\n  const unreadCount = notifications.filter((n) => !n.isRead).length;\n\n  const markAsRead = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"PATCH\", `/api/notifications/${id}/read`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n    },\n  });\n\n  const markAllAsRead = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/notifications/mark-all-read\", {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n    },\n  });\n\n  const handleNotificationClick = (notification: Notification) => {\n    if (!notification.isRead) {\n      markAsRead.mutate(notification.id);\n    }\n    if (notification.link) {\n      window.location.href = notification.link;\n    }\n    setOpen(false);\n  };\n\n  return (\n    <DropdownMenu open={open} onOpenChange={setOpen}>\n      <DropdownMenuTrigger asChild>\n        <Button\n          size=\"icon\"\n          variant=\"ghost\"\n          className=\"relative\"\n          data-testid=\"button-notifications\"\n        >\n          <Bell className=\"h-5 w-5\" />\n          {unreadCount > 0 && (\n            <Badge\n              variant=\"destructive\"\n              className=\"absolute -top-1 -right-1 h-5 w-5 flex items-center justify-center p-0 text-xs\"\n            >\n              {unreadCount > 9 ? \"9+\" : unreadCount}\n            </Badge>\n          )}\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\" className=\"w-80\">\n        <div className=\"flex items-center justify-between p-2\">\n          <h3 className=\"font-semibold\">Notifications</h3>\n          {unreadCount > 0 && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-7 text-xs\"\n              onClick={() => markAllAsRead.mutate()}\n              data-testid=\"button-mark-all-read\"\n            >\n              Mark all read\n            </Button>\n          )}\n        </div>\n        <DropdownMenuSeparator />\n        <ScrollArea className=\"h-[400px]\">\n          {notifications.length === 0 ? (\n            <div className=\"p-4 text-center text-sm text-muted-foreground\">\n              No notifications yet\n            </div>\n          ) : (\n            notifications.map((notification) => (\n              <DropdownMenuItem\n                key={notification.id}\n                className=\"flex flex-col items-start p-3 cursor-pointer gap-1\"\n                onClick={() => handleNotificationClick(notification)}\n                data-testid={`notification-${notification.id}`}\n              >\n                <div className=\"flex items-start justify-between w-full gap-2\">\n                  <div className=\"flex-1\">\n                    <p className={`text-sm ${!notification.isRead ? \"font-semibold\" : \"\"}`}>\n                      {notification.title}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      {notification.message}\n                    </p>\n                  </div>\n                  {!notification.isRead && (\n                    <div className=\"h-2 w-2 rounded-full bg-primary shrink-0 mt-1\" />\n                  )}\n                </div>\n                <span className=\"text-xs text-muted-foreground\">\n                  {notification.createdAt && formatDistanceToNow(new Date(notification.createdAt), { addSuffix: true })}\n                </span>\n              </DropdownMenuItem>\n            ))\n          )}\n        </ScrollArea>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n","path":null,"size_bytes":7168,"size_tokens":null},"server/index-prod.ts":{"content":"import fs from \"node:fs\";\nimport path from \"node:path\";\nimport { type Server } from \"node:http\";\n\nimport express, { type Express } from \"express\";\nimport runApp from \"./app\";\n\nexport async function serveStatic(app: Express, _server: Server) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n\n(async () => {\n  await runApp(serveStatic);\n})();\n","path":null,"size_bytes":712,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/pricing-calculator.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { Calculator, Info, CreditCard, Building2, Smartphone } from \"lucide-react\";\nimport {\n  calculatePricingFromSellerPrice,\n  calculateMonnifyFee,\n  formatNaira,\n  type PaymentMethod,\n  type PricingBreakdown,\n  DEFAULT_COMMISSION_RATE,\n} from \"@shared/pricing\";\n\ninterface PricingCalculatorProps {\n  initialPrice?: number;\n  onPriceChange?: (breakdown: PricingBreakdown) => void;\n  compact?: boolean;\n  showPaymentMethodSelect?: boolean;\n}\n\nexport function PricingCalculator({\n  initialPrice = 0,\n  onPriceChange,\n  compact = false,\n  showPaymentMethodSelect = true,\n}: PricingCalculatorProps) {\n  const [sellerPrice, setSellerPrice] = useState<string>(initialPrice.toString());\n  const [paymentMethod, setPaymentMethod] = useState<PaymentMethod>(\"CARD\");\n  const [breakdown, setBreakdown] = useState<PricingBreakdown | null>(null);\n\n  useEffect(() => {\n    const price = parseFloat(sellerPrice) || 0;\n    if (price > 0) {\n      const newBreakdown = calculatePricingFromSellerPrice(\n        price,\n        DEFAULT_COMMISSION_RATE,\n        paymentMethod\n      );\n      setBreakdown(newBreakdown);\n      onPriceChange?.(newBreakdown);\n    } else {\n      setBreakdown(null);\n    }\n  }, [sellerPrice, paymentMethod, onPriceChange]);\n\n  const handlePriceChange = (value: string) => {\n    const cleaned = value.replace(/[^0-9.]/g, \"\");\n    const parts = cleaned.split(\".\");\n    if (parts.length > 2) return;\n    if (parts[1] && parts[1].length > 2) return;\n    setSellerPrice(cleaned);\n  };\n\n  const getPaymentMethodIcon = (method: PaymentMethod) => {\n    switch (method) {\n      case \"CARD\":\n        return <CreditCard className=\"h-4 w-4\" />;\n      case \"ACCOUNT_TRANSFER\":\n        return <Building2 className=\"h-4 w-4\" />;\n      case \"USSD\":\n        return <Smartphone className=\"h-4 w-4\" />;\n      default:\n        return <CreditCard className=\"h-4 w-4\" />;\n    }\n  };\n\n  if (compact) {\n    return (\n      <div className=\"space-y-3\" data-testid=\"pricing-calculator-compact\">\n        <div className=\"flex items-center gap-2\">\n          <Label htmlFor=\"price-input\" className=\"text-sm text-muted-foreground\">\n            Your Price\n          </Label>\n          <div className=\"relative flex-1\">\n            <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\">\n              ₦\n            </span>\n            <Input\n              id=\"price-input\"\n              type=\"text\"\n              value={sellerPrice}\n              onChange={(e) => handlePriceChange(e.target.value)}\n              placeholder=\"0.00\"\n              className=\"pl-7\"\n              data-testid=\"input-seller-price\"\n            />\n          </div>\n        </div>\n\n        {breakdown && breakdown.sellerPrice > 0 && (\n          <div className=\"grid grid-cols-2 gap-2 text-sm\">\n            <div className=\"flex justify-between items-center p-2 rounded-md bg-muted/50\">\n              <span className=\"text-muted-foreground\">Buyer Pays</span>\n              <span className=\"font-medium\" data-testid=\"text-buyer-pays\">\n                {formatNaira(breakdown.buyerPays)}\n              </span>\n            </div>\n            <div className=\"flex justify-between items-center p-2 rounded-md bg-muted/50\">\n              <span className=\"text-muted-foreground\">You Receive</span>\n              <span className=\"font-medium text-green-600\" data-testid=\"text-seller-receives\">\n                {formatNaira(breakdown.sellerReceives)}\n              </span>\n            </div>\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  return (\n    <Card data-testid=\"pricing-calculator\">\n      <CardHeader className=\"pb-3\">\n        <CardTitle className=\"flex items-center gap-2 text-lg\">\n          <Calculator className=\"h-5 w-5\" />\n          Pricing Calculator\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"seller-price\">Your Desired Price (₦)</Label>\n          <div className=\"relative\">\n            <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground font-medium\">\n              ₦\n            </span>\n            <Input\n              id=\"seller-price\"\n              type=\"text\"\n              value={sellerPrice}\n              onChange={(e) => handlePriceChange(e.target.value)}\n              placeholder=\"Enter your price\"\n              className=\"pl-8 text-lg\"\n              data-testid=\"input-seller-price\"\n            />\n          </div>\n          <p className=\"text-xs text-muted-foreground\">\n            Enter the price you want for your item\n          </p>\n        </div>\n\n        {showPaymentMethodSelect && (\n          <div className=\"space-y-2\">\n            <Label>Expected Payment Method</Label>\n            <Select\n              value={paymentMethod}\n              onValueChange={(v) => setPaymentMethod(v as PaymentMethod)}\n            >\n              <SelectTrigger data-testid=\"select-payment-method\">\n                <SelectValue placeholder=\"Select payment method\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"CARD\">\n                  <div className=\"flex items-center gap-2\">\n                    <CreditCard className=\"h-4 w-4\" />\n                    Card Payment\n                  </div>\n                </SelectItem>\n                <SelectItem value=\"ACCOUNT_TRANSFER\">\n                  <div className=\"flex items-center gap-2\">\n                    <Building2 className=\"h-4 w-4\" />\n                    Bank Transfer\n                  </div>\n                </SelectItem>\n                <SelectItem value=\"USSD\">\n                  <div className=\"flex items-center gap-2\">\n                    <Smartphone className=\"h-4 w-4\" />\n                    USSD\n                  </div>\n                </SelectItem>\n              </SelectContent>\n            </Select>\n            <p className=\"text-xs text-muted-foreground\">\n              Different methods have slightly different fees\n            </p>\n          </div>\n        )}\n\n        {breakdown && breakdown.sellerPrice > 0 && (\n          <div className=\"space-y-3 pt-4 border-t\">\n            <h4 className=\"font-medium text-sm\">Price Breakdown</h4>\n\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between items-center py-2\">\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"text-muted-foreground\">Your Price</span>\n                </div>\n                <span className=\"font-medium\" data-testid=\"text-seller-price\">\n                  {formatNaira(breakdown.sellerPrice)}\n                </span>\n              </div>\n\n              <div className=\"flex justify-between items-center py-2 border-t\">\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"text-muted-foreground\">Platform Fee</span>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Info className=\"h-3.5 w-3.5 text-muted-foreground cursor-help\" />\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>{(breakdown.commissionRate * 100).toFixed(0)}% commission on your price</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    {(breakdown.commissionRate * 100).toFixed(0)}%\n                  </Badge>\n                </div>\n                <span className=\"text-muted-foreground\" data-testid=\"text-platform-fee\">\n                  +{formatNaira(breakdown.platformCommission)}\n                </span>\n              </div>\n\n              <div className=\"flex justify-between items-center py-2 border-t\">\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"text-muted-foreground\">Payment Fee</span>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Info className=\"h-3.5 w-3.5 text-muted-foreground cursor-help\" />\n                    </TooltipTrigger>\n                    <TooltipContent className=\"max-w-xs\">\n                      <p>\n                        Monnify fee:{\" \"}\n                        {paymentMethod === \"ACCOUNT_TRANSFER\" || paymentMethod === \"USSD\"\n                          ? \"1%\"\n                          : \"1.5%\"}{\" \"}\n                        + ₦50 (waived under ₦2,500). Capped at ₦2,000 max.\n                      </p>\n                    </TooltipContent>\n                  </Tooltip>\n                  {getPaymentMethodIcon(paymentMethod)}\n                </div>\n                <span className=\"text-muted-foreground\" data-testid=\"text-monnify-fee\">\n                  +{formatNaira(breakdown.monnifyFee)}\n                </span>\n              </div>\n\n              <div className=\"flex justify-between items-center py-3 border-t-2 border-dashed\">\n                <span className=\"font-medium\">Buyer Pays</span>\n                <span className=\"text-lg font-bold\" data-testid=\"text-buyer-total\">\n                  {formatNaira(breakdown.buyerPays)}\n                </span>\n              </div>\n\n              <div className=\"flex justify-between items-center py-3 bg-green-50 dark:bg-green-950/30 rounded-md px-3 -mx-3\">\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"font-medium text-green-700 dark:text-green-400\">\n                    You Receive\n                  </span>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Info className=\"h-3.5 w-3.5 text-green-600 dark:text-green-500 cursor-help\" />\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>Your price minus platform fee</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                <span\n                  className=\"text-lg font-bold text-green-700 dark:text-green-400\"\n                  data-testid=\"text-seller-receives\"\n                >\n                  {formatNaira(breakdown.sellerReceives)}\n                </span>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {(!breakdown || breakdown.sellerPrice <= 0) && (\n          <div className=\"text-center py-6 text-muted-foreground\">\n            <Calculator className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n            <p className=\"text-sm\">Enter a price to see the breakdown</p>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default PricingCalculator;\n","path":null,"size_bytes":11027,"size_tokens":null},"client/src/components/games/TriviaGame.tsx":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { \n  Clock, \n  Trophy, \n  Bot, \n  User, \n  Check, \n  X, \n  RotateCcw, \n  HelpCircle, \n  Sparkles, \n  Loader2, \n  AlertCircle, \n  Zap,\n  Brain,\n  BookOpen,\n  Gamepad2,\n  Music,\n  GraduationCap,\n  Globe,\n  Star,\n  Crown,\n  Flame,\n  Target\n} from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface TriviaGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ninterface Question {\n  id: number;\n  category: string;\n  question: string;\n  options: string[];\n  correctAnswer: number;\n  difficulty: \"easy\" | \"medium\" | \"hard\";\n}\n\nconst CATEGORIES = [\n  { value: \"all\", label: \"All Categories\", icon: Globe },\n  { value: \"General Knowledge\", label: \"General Knowledge\", icon: BookOpen },\n  { value: \"Nigerian Culture\", label: \"Nigerian Culture\", icon: Crown },\n  { value: \"Campus Life\", label: \"Campus Life\", icon: GraduationCap },\n  { value: \"Sports\", label: \"Sports\", icon: Gamepad2 },\n  { value: \"Entertainment\", label: \"Entertainment\", icon: Music },\n];\n\nconst QUESTIONS: Question[] = [\n  {\n    id: 1,\n    category: \"General Knowledge\",\n    question: \"What is the capital city of Nigeria?\",\n    options: [\"Lagos\", \"Abuja\", \"Kano\", \"Port Harcourt\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 2,\n    category: \"Nigerian Culture\",\n    question: \"Which tribe is known for the Eyo Festival?\",\n    options: [\"Igbo\", \"Hausa\", \"Yoruba\", \"Ijaw\"],\n    correctAnswer: 2,\n    difficulty: \"easy\"\n  },\n  {\n    id: 3,\n    category: \"Campus Life\",\n    question: \"What does GPA stand for?\",\n    options: [\"Grade Point Average\", \"General Performance Assessment\", \"Graduate Program Admission\", \"Group Project Assignment\"],\n    correctAnswer: 0,\n    difficulty: \"easy\"\n  },\n  {\n    id: 4,\n    category: \"Sports\",\n    question: \"Which Nigerian footballer won the African Footballer of the Year award in 1996?\",\n    options: [\"Jay-Jay Okocha\", \"Kanu Nwankwo\", \"Rashidi Yekini\", \"Finidi George\"],\n    correctAnswer: 1,\n    difficulty: \"medium\"\n  },\n  {\n    id: 5,\n    category: \"Entertainment\",\n    question: \"Who is known as the 'African Giant' in Nigerian music?\",\n    options: [\"Davido\", \"Wizkid\", \"Burna Boy\", \"Olamide\"],\n    correctAnswer: 2,\n    difficulty: \"easy\"\n  },\n  {\n    id: 6,\n    category: \"General Knowledge\",\n    question: \"How many states are there in Nigeria?\",\n    options: [\"32\", \"36\", \"38\", \"40\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 7,\n    category: \"Nigerian Culture\",\n    question: \"What is the traditional attire called that is worn by Yoruba men?\",\n    options: [\"Babariga\", \"Agbada\", \"Kaftan\", \"Dashiki\"],\n    correctAnswer: 1,\n    difficulty: \"medium\"\n  },\n  {\n    id: 8,\n    category: \"Campus Life\",\n    question: \"What is the minimum CGPA typically required for first-class honors in Nigerian universities?\",\n    options: [\"3.0\", \"3.5\", \"4.0\", \"4.5\"],\n    correctAnswer: 3,\n    difficulty: \"medium\"\n  },\n  {\n    id: 9,\n    category: \"Sports\",\n    question: \"In what year did Nigeria win the Olympic Gold medal in football?\",\n    options: [\"1992\", \"1996\", \"2000\", \"2008\"],\n    correctAnswer: 1,\n    difficulty: \"hard\"\n  },\n  {\n    id: 10,\n    category: \"Entertainment\",\n    question: \"Which Nigerian movie won an Oscar nomination?\",\n    options: [\"Living in Bondage\", \"The Wedding Party\", \"Lionheart\", \"King of Boys\"],\n    correctAnswer: 2,\n    difficulty: \"hard\"\n  },\n  {\n    id: 11,\n    category: \"General Knowledge\",\n    question: \"What is Nigeria's currency called?\",\n    options: [\"Dollar\", \"Pound\", \"Naira\", \"Cedi\"],\n    correctAnswer: 2,\n    difficulty: \"easy\"\n  },\n  {\n    id: 12,\n    category: \"Nigerian Culture\",\n    question: \"Which Nigerian ethnic group is famous for the Durbar festival?\",\n    options: [\"Yoruba\", \"Igbo\", \"Hausa\", \"Tiv\"],\n    correctAnswer: 2,\n    difficulty: \"medium\"\n  },\n  {\n    id: 13,\n    category: \"Campus Life\",\n    question: \"What does JAMB stand for?\",\n    options: [\"Joint Admission and Matriculation Board\", \"Junior Academic Merit Board\", \"Joint Assessment and Measurement Board\", \"Junior Admission and Merit Board\"],\n    correctAnswer: 0,\n    difficulty: \"easy\"\n  },\n  {\n    id: 14,\n    category: \"Sports\",\n    question: \"Which Nigerian boxer became the first undisputed heavyweight champion from Africa?\",\n    options: [\"Samuel Peter\", \"Anthony Joshua\", \"Francis Ngannou\", \"David Haye\"],\n    correctAnswer: 1,\n    difficulty: \"medium\"\n  },\n  {\n    id: 15,\n    category: \"Entertainment\",\n    question: \"Which year was Nollywood's first movie 'Living in Bondage' released?\",\n    options: [\"1988\", \"1992\", \"1996\", \"2000\"],\n    correctAnswer: 1,\n    difficulty: \"hard\"\n  },\n  {\n    id: 16,\n    category: \"General Knowledge\",\n    question: \"Which river is the longest in Nigeria?\",\n    options: [\"Benue River\", \"Niger River\", \"Ogun River\", \"Cross River\"],\n    correctAnswer: 1,\n    difficulty: \"medium\"\n  },\n  {\n    id: 17,\n    category: \"Nigerian Culture\",\n    question: \"What is 'Owambe' in Yoruba culture?\",\n    options: [\"A type of food\", \"A party or celebration\", \"A traditional dance\", \"A wedding ceremony\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 18,\n    category: \"Campus Life\",\n    question: \"What is the typical duration of a bachelor's degree program in Nigeria?\",\n    options: [\"3 years\", \"4 years\", \"5 years\", \"6 years\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 19,\n    category: \"Sports\",\n    question: \"Which Nigerian club has won the most Nigeria Professional Football League titles?\",\n    options: [\"Enyimba FC\", \"Kano Pillars\", \"Rangers International\", \"Heartland FC\"],\n    correctAnswer: 0,\n    difficulty: \"medium\"\n  },\n  {\n    id: 20,\n    category: \"Entertainment\",\n    question: \"Which Nigerian artist released the album 'Made in Lagos'?\",\n    options: [\"Davido\", \"Wizkid\", \"Burna Boy\", \"Tiwa Savage\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 21,\n    category: \"General Knowledge\",\n    question: \"In what year did Nigeria gain independence?\",\n    options: [\"1957\", \"1960\", \"1963\", \"1966\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 22,\n    category: \"Nigerian Culture\",\n    question: \"What is the meaning of 'Omo' in Yoruba?\",\n    options: [\"Father\", \"Mother\", \"Child\", \"Elder\"],\n    correctAnswer: 2,\n    difficulty: \"easy\"\n  },\n  {\n    id: 23,\n    category: \"Campus Life\",\n    question: \"What is the primary function of the Student Union Government (SUG)?\",\n    options: [\"Collect school fees\", \"Represent students' interests\", \"Grade students\", \"Hire lecturers\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 24,\n    category: \"Sports\",\n    question: \"Who is the all-time top scorer for the Nigerian national football team?\",\n    options: [\"Rashidi Yekini\", \"Nwankwo Kanu\", \"Jay-Jay Okocha\", \"Vincent Enyeama\"],\n    correctAnswer: 0,\n    difficulty: \"medium\"\n  },\n  {\n    id: 25,\n    category: \"Entertainment\",\n    question: \"Which Nigerian comedian is known as 'Mr Macaroni'?\",\n    options: [\"Debo Adedayo\", \"Bright Okpocha\", \"Ayo Makun\", \"Bovi Ugboma\"],\n    correctAnswer: 0,\n    difficulty: \"medium\"\n  },\n  {\n    id: 26,\n    category: \"General Knowledge\",\n    question: \"What is the official language of Nigeria?\",\n    options: [\"Yoruba\", \"Igbo\", \"Hausa\", \"English\"],\n    correctAnswer: 3,\n    difficulty: \"easy\"\n  },\n  {\n    id: 27,\n    category: \"Nigerian Culture\",\n    question: \"Which festival is celebrated to mark the new yam harvest?\",\n    options: [\"Eyo Festival\", \"New Yam Festival\", \"Durbar Festival\", \"Argungu Festival\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 28,\n    category: \"Campus Life\",\n    question: \"What is 'carry-over' in Nigerian university slang?\",\n    options: [\"Extra luggage\", \"A failed course to be repeated\", \"Transfer to another school\", \"Graduation ceremony\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 29,\n    category: \"Sports\",\n    question: \"Which Nigerian athlete won gold in the long jump at the 1996 Olympics?\",\n    options: [\"Chioma Ajunwa\", \"Mary Onyali\", \"Blessing Okagbare\", \"Falilat Ogunkoya\"],\n    correctAnswer: 0,\n    difficulty: \"hard\"\n  },\n  {\n    id: 30,\n    category: \"Entertainment\",\n    question: \"What genre of music is Fela Kuti known for pioneering?\",\n    options: [\"Juju\", \"Highlife\", \"Afrobeat\", \"Fuji\"],\n    correctAnswer: 2,\n    difficulty: \"medium\"\n  },\n  {\n    id: 31,\n    category: \"General Knowledge\",\n    question: \"Which state is known as the 'Centre of Excellence' in Nigeria?\",\n    options: [\"Abuja\", \"Lagos\", \"Rivers\", \"Kano\"],\n    correctAnswer: 1,\n    difficulty: \"medium\"\n  },\n  {\n    id: 32,\n    category: \"Nigerian Culture\",\n    question: \"What is 'Suya' in Nigerian cuisine?\",\n    options: [\"A drink\", \"Grilled meat skewers\", \"A soup\", \"Rice dish\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 33,\n    category: \"Campus Life\",\n    question: \"What is POST-UTME?\",\n    options: [\"Post-graduation test\", \"Post-JAMB screening exam\", \"Teacher evaluation\", \"Course registration\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 34,\n    category: \"Sports\",\n    question: \"Which Nigerian Super Eagles coach led the team to win the 2013 AFCON?\",\n    options: [\"Lars Lagerback\", \"Stephen Keshi\", \"Samson Siasia\", \"Gernot Rohr\"],\n    correctAnswer: 1,\n    difficulty: \"medium\"\n  },\n  {\n    id: 35,\n    category: \"Entertainment\",\n    question: \"Which Nigerian show features celebrities answering questions while eating spicy wings?\",\n    options: [\"Big Brother Naija\", \"Hot Ones Nigeria\", \"Ndani TV\", \"The Voice Nigeria\"],\n    correctAnswer: 1,\n    difficulty: \"hard\"\n  },\n  {\n    id: 36,\n    category: \"General Knowledge\",\n    question: \"What is the largest city in Nigeria by population?\",\n    options: [\"Abuja\", \"Lagos\", \"Kano\", \"Ibadan\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 37,\n    category: \"Nigerian Culture\",\n    question: \"What is 'Jollof Rice'?\",\n    options: [\"A dessert\", \"A one-pot rice dish\", \"A breakfast cereal\", \"A salad\"],\n    correctAnswer: 1,\n    difficulty: \"easy\"\n  },\n  {\n    id: 38,\n    category: \"Campus Life\",\n    question: \"What does 'sorting' mean in Nigerian campus slang?\",\n    options: [\"Organizing books\", \"Bribing for grades\", \"Studying hard\", \"Attending lectures\"],\n    correctAnswer: 1,\n    difficulty: \"medium\"\n  },\n  {\n    id: 39,\n    category: \"Sports\",\n    question: \"Which Nigerian tennis player has won WTA titles?\",\n    options: [\"Sada Williams\", \"Blessing Okagbare\", \"Marcelina Oko-Ose\", \"Toyin Abioro\"],\n    correctAnswer: 2,\n    difficulty: \"hard\"\n  },\n  {\n    id: 40,\n    category: \"Entertainment\",\n    question: \"Which Nigerian actress starred in 'Half of a Yellow Sun'?\",\n    options: [\"Genevieve Nnaji\", \"Omotola Jalade\", \"Funke Akindele\", \"Mercy Johnson\"],\n    correctAnswer: 0,\n    difficulty: \"medium\"\n  }\n];\n\nconst shuffleArray = <T,>(array: T[]): T[] => {\n  const shuffled = [...array];\n  for (let i = shuffled.length - 1; i > 0; i--) {\n    const j = Math.floor(Math.random() * (i + 1));\n    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];\n  }\n  return shuffled;\n};\n\nconst getCategoryColor = (category: string) => {\n  switch (category) {\n    case \"General Knowledge\": return \"bg-blue-500/20 text-blue-600 dark:text-blue-400\";\n    case \"Nigerian Culture\": return \"bg-green-500/20 text-green-600 dark:text-green-400\";\n    case \"Campus Life\": return \"bg-purple-500/20 text-purple-600 dark:text-purple-400\";\n    case \"Sports\": return \"bg-orange-500/20 text-orange-600 dark:text-orange-400\";\n    case \"Entertainment\": return \"bg-pink-500/20 text-pink-600 dark:text-pink-400\";\n    default: return \"bg-muted\";\n  }\n};\n\nconst getDifficultyColor = (difficulty: string) => {\n  switch (difficulty) {\n    case \"easy\": return \"bg-green-500/20 text-green-600 dark:text-green-400\";\n    case \"medium\": return \"bg-yellow-500/20 text-yellow-600 dark:text-yellow-400\";\n    case \"hard\": return \"bg-red-500/20 text-red-600 dark:text-red-400\";\n    default: return \"bg-muted\";\n  }\n};\n\nconst getDifficultyIcon = (difficulty: string) => {\n  switch (difficulty) {\n    case \"easy\": return Star;\n    case \"medium\": return Flame;\n    case \"hard\": return Crown;\n    default: return Star;\n  }\n};\n\nconst getRandomQuestions = (count: number, category?: string): Question[] => {\n  let filtered = [...QUESTIONS];\n  if (category && category !== \"all\") {\n    filtered = QUESTIONS.filter(q => q.category === category);\n  }\n  const shuffled = shuffleArray(filtered);\n  return shuffled.slice(0, Math.min(count, shuffled.length));\n};\n\nconst generateAIAnswers = (gameQuestions: Question[]): number[] => {\n  return gameQuestions.map((q) => {\n    const difficultyAccuracy = {\n      easy: 0.85,\n      medium: 0.65,\n      hard: 0.45\n    };\n    \n    const accuracy = difficultyAccuracy[q.difficulty];\n    \n    if (Math.random() < accuracy) {\n      return q.correctAnswer;\n    } else {\n      const wrongAnswers = [0, 1, 2, 3].filter((i) => i !== q.correctAnswer);\n      return wrongAnswers[Math.floor(Math.random() * wrongAnswers.length)];\n    }\n  });\n};\n\nexport default function TriviaGame({ stake, onGameEnd, isPractice }: TriviaGameProps) {\n  const [questions, setQuestions] = useState<Question[]>([]);\n  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);\n  const [playerScore, setPlayerScore] = useState(0);\n  const [aiScore, setAIScore] = useState(0);\n  const [timeLeft, setTimeLeft] = useState(15);\n  const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);\n  const [aiAnswer, setAIAnswer] = useState<number | null>(null);\n  const [showResult, setShowResult] = useState(false);\n  const [gamePhase, setGamePhase] = useState<\"setup\" | \"loading\" | \"playing\" | \"results\">(\"setup\");\n  const [playerAnswers, setPlayerAnswers] = useState<(number | null)[]>([]);\n  const [aiAnswers, setAIAnswers] = useState<number[]>([]);\n  const [isAIGenerated, setIsAIGenerated] = useState(false);\n  const [loadingMessage, setLoadingMessage] = useState(\"Generating fresh questions...\");\n  const [selectedCategory, setSelectedCategory] = useState<string>(\"all\");\n  const [streak, setStreak] = useState(0);\n  const [maxStreak, setMaxStreak] = useState(0);\n\n  const fetchQuestionsFromAPI = async (category?: string): Promise<Question[] | null> => {\n    try {\n      setLoadingMessage(\"Generating fresh AI questions...\");\n      const body: { category?: string; count?: number } = { count: 10 };\n      if (category && category !== \"all\") {\n        body.category = category;\n      }\n      const response = await apiRequest(\"POST\", \"/api/games/generate-trivia-questions\", body);\n      const data = await response.json();\n      \n      if (data.questions && Array.isArray(data.questions) && data.questions.length > 0) {\n        return data.questions;\n      }\n      return null;\n    } catch (error) {\n      console.error(\"Failed to fetch AI questions:\", error);\n      return null;\n    }\n  };\n\n  const startGame = async () => {\n    setGamePhase(\"loading\");\n    setLoadingMessage(\"Generating fresh questions...\");\n    \n    let gameQuestions: Question[] | null = null;\n    \n    gameQuestions = await fetchQuestionsFromAPI(selectedCategory);\n    \n    if (gameQuestions && gameQuestions.length >= 5) {\n      setIsAIGenerated(true);\n      setQuestions(gameQuestions);\n    } else {\n      setLoadingMessage(\"Using classic questions...\");\n      setIsAIGenerated(false);\n      gameQuestions = getRandomQuestions(10, selectedCategory !== \"all\" ? selectedCategory : undefined);\n      if (gameQuestions.length < 5) {\n        gameQuestions = getRandomQuestions(10);\n      }\n      setQuestions(gameQuestions);\n    }\n    \n    const aiAnswersList = generateAIAnswers(gameQuestions);\n    setAIAnswers(aiAnswersList);\n    \n    setCurrentQuestionIndex(0);\n    setPlayerScore(0);\n    setAIScore(0);\n    setTimeLeft(15);\n    setSelectedAnswer(null);\n    setAIAnswer(null);\n    setShowResult(false);\n    setPlayerAnswers([]);\n    setStreak(0);\n    setMaxStreak(0);\n    \n    setGamePhase(\"playing\");\n  };\n\n  useEffect(() => {\n    if (gamePhase !== \"playing\" || showResult || questions.length === 0) return;\n    \n    const timer = setInterval(() => {\n      setTimeLeft((prev) => {\n        if (prev <= 1) {\n          handleTimeout();\n          return 0;\n        }\n        return prev - 1;\n      });\n    }, 1000);\n    \n    return () => clearInterval(timer);\n  }, [gamePhase, showResult, currentQuestionIndex, questions.length]);\n\n  const handleTimeout = () => {\n    if (selectedAnswer === null) {\n      handleAnswer(null);\n    }\n  };\n\n  const handleAnswer = (answerIndex: number | null) => {\n    if (showResult || gamePhase !== \"playing\") return;\n    \n    setSelectedAnswer(answerIndex);\n    setShowResult(true);\n    \n    const currentQuestion = questions[currentQuestionIndex];\n    const currentAIAnswer = aiAnswers[currentQuestionIndex];\n    setAIAnswer(currentAIAnswer);\n    \n    const isCorrect = answerIndex === currentQuestion.correctAnswer;\n    \n    if (isCorrect) {\n      const points = currentQuestion.difficulty === \"easy\" ? 10 : currentQuestion.difficulty === \"medium\" ? 15 : 20;\n      const streakBonus = Math.floor(streak / 3) * 5;\n      setPlayerScore((prev) => prev + points + streakBonus);\n      setStreak(prev => {\n        const newStreak = prev + 1;\n        if (newStreak > maxStreak) {\n          setMaxStreak(newStreak);\n        }\n        return newStreak;\n      });\n    } else {\n      setStreak(0);\n    }\n    \n    if (currentAIAnswer === currentQuestion.correctAnswer) {\n      const points = currentQuestion.difficulty === \"easy\" ? 10 : currentQuestion.difficulty === \"medium\" ? 15 : 20;\n      setAIScore((prev) => prev + points);\n    }\n    \n    setPlayerAnswers((prev) => [...prev, answerIndex]);\n    \n    setTimeout(() => {\n      if (currentQuestionIndex < questions.length - 1) {\n        setCurrentQuestionIndex((prev) => prev + 1);\n        setSelectedAnswer(null);\n        setAIAnswer(null);\n        setShowResult(false);\n        setTimeLeft(15);\n      } else {\n        setGamePhase(\"results\");\n      }\n    }, 2000);\n  };\n\n  useEffect(() => {\n    if (gamePhase === \"results\") {\n      const playerWon = playerScore > aiScore;\n      onGameEnd(playerWon, playerScore);\n    }\n  }, [gamePhase, playerScore, aiScore, onGameEnd]);\n\n  const resetGame = () => {\n    setGamePhase(\"setup\");\n    setQuestions([]);\n    setCurrentQuestionIndex(0);\n    setPlayerScore(0);\n    setAIScore(0);\n    setTimeLeft(15);\n    setSelectedAnswer(null);\n    setAIAnswer(null);\n    setShowResult(false);\n    setPlayerAnswers([]);\n    setAIAnswers([]);\n    setIsAIGenerated(false);\n    setStreak(0);\n    setMaxStreak(0);\n  };\n\n  const getCategoryIcon = (categoryValue: string) => {\n    const cat = CATEGORIES.find(c => c.value === categoryValue);\n    return cat?.icon || Globe;\n  };\n\n  if (gamePhase === \"setup\") {\n    return (\n      <Card className=\"overflow-visible\">\n        <CardHeader className=\"pb-4\">\n          <CardTitle className=\"text-xl flex items-center gap-2\">\n            <Brain className=\"h-6 w-6 text-primary\" />\n            Trivia Challenge\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <motion.div\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"text-center space-y-4\"\n          >\n            <div className=\"relative mx-auto w-24 h-24 mb-4\">\n              <motion.div\n                animate={{ \n                  scale: [1, 1.1, 1],\n                  rotate: [0, 5, -5, 0]\n                }}\n                transition={{ \n                  duration: 2, \n                  repeat: Infinity,\n                  repeatType: \"reverse\"\n                }}\n                className=\"w-full h-full rounded-full bg-gradient-to-br from-purple-500 via-pink-500 to-orange-400 flex items-center justify-center shadow-lg\"\n              >\n                <HelpCircle className=\"h-12 w-12 text-white\" />\n              </motion.div>\n              <motion.div\n                animate={{ \n                  scale: [1, 1.3, 1],\n                  opacity: [0.5, 1, 0.5]\n                }}\n                transition={{ \n                  duration: 1.5, \n                  repeat: Infinity \n                }}\n                className=\"absolute -top-1 -right-1 w-8 h-8 rounded-full bg-yellow-400 flex items-center justify-center\"\n              >\n                <Sparkles className=\"h-4 w-4 text-yellow-800\" />\n              </motion.div>\n            </div>\n            \n            <div>\n              <h3 className=\"text-lg font-semibold\">Test Your Knowledge</h3>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                Answer 10 questions faster and more accurately than the AI opponent!\n              </p>\n            </div>\n          </motion.div>\n\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium flex items-center gap-2\">\n                <Target className=\"h-4 w-4\" />\n                Choose Category\n              </label>\n              <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n                <SelectTrigger className=\"w-full\" data-testid=\"select-category\">\n                  <SelectValue placeholder=\"Select a category\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {CATEGORIES.map((cat) => {\n                    const Icon = cat.icon;\n                    return (\n                      <SelectItem key={cat.value} value={cat.value}>\n                        <div className=\"flex items-center gap-2\">\n                          <Icon className=\"h-4 w-4\" />\n                          <span>{cat.label}</span>\n                        </div>\n                      </SelectItem>\n                    );\n                  })}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"flex items-center justify-between text-sm p-3 bg-muted/50 rounded-md\">\n              <div className=\"flex items-center gap-2\">\n                <Bot className=\"h-4 w-4 text-muted-foreground\" />\n                <span>AI Opponent</span>\n              </div>\n              <Badge variant=\"secondary\">Smart AI</Badge>\n            </div>\n\n            {!isPractice && (\n              <div className=\"flex items-center justify-between text-sm p-3 bg-gradient-to-r from-green-500/10 to-emerald-500/10 rounded-md border border-green-500/20\">\n                <div className=\"flex items-center gap-2\">\n                  <Trophy className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                  <span>Stake</span>\n                </div>\n                <Badge className=\"bg-green-500/20 text-green-600 dark:text-green-400 border-0\">\n                  {stake} NGN\n                </Badge>\n              </div>\n            )}\n\n            {isPractice && (\n              <div className=\"flex items-center justify-between text-sm p-3 bg-blue-500/10 rounded-md border border-blue-500/20\">\n                <div className=\"flex items-center gap-2\">\n                  <Star className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                  <span>Mode</span>\n                </div>\n                <Badge className=\"bg-blue-500/20 text-blue-600 dark:text-blue-400 border-0\">\n                  Practice\n                </Badge>\n              </div>\n            )}\n          </div>\n\n          <Button \n            onClick={startGame} \n            className=\"w-full gap-2\" \n            size=\"lg\"\n            data-testid=\"button-start-trivia\"\n          >\n            <Zap className=\"h-5 w-5\" />\n            Start Challenge\n          </Button>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (gamePhase === \"loading\" || questions.length === 0) {\n    return (\n      <Card>\n        <CardContent className=\"p-8\">\n          <div className=\"flex flex-col items-center justify-center space-y-6\">\n            <div className=\"relative\">\n              <motion.div\n                animate={{ rotate: 360 }}\n                transition={{ duration: 2, repeat: Infinity, ease: \"linear\" }}\n                className=\"w-16 h-16 rounded-full border-4 border-primary/20 border-t-primary\"\n              />\n              <motion.div\n                animate={{ \n                  scale: [1, 1.2, 1],\n                  opacity: [1, 0.7, 1]\n                }}\n                transition={{ duration: 1, repeat: Infinity }}\n                className=\"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2\"\n              >\n                <Brain className=\"h-6 w-6 text-primary\" />\n              </motion.div>\n            </div>\n            <div className=\"text-center space-y-2\">\n              <motion.p \n                animate={{ opacity: [1, 0.5, 1] }}\n                transition={{ duration: 1.5, repeat: Infinity }}\n                className=\"font-medium text-lg\"\n              >\n                {loadingMessage}\n              </motion.p>\n              <p className=\"text-sm text-muted-foreground\">\n                Preparing your trivia challenge...\n              </p>\n              {selectedCategory !== \"all\" && (\n                <Badge className={getCategoryColor(selectedCategory)}>\n                  {CATEGORIES.find(c => c.value === selectedCategory)?.label}\n                </Badge>\n              )}\n            </div>\n            <div className=\"w-full max-w-xs space-y-3\">\n              <Skeleton className=\"h-4 w-full\" />\n              <Skeleton className=\"h-4 w-3/4 mx-auto\" />\n              <div className=\"space-y-2 mt-4\">\n                <Skeleton className=\"h-12 w-full rounded-md\" />\n                <Skeleton className=\"h-12 w-full rounded-md\" />\n                <Skeleton className=\"h-12 w-full rounded-md\" />\n                <Skeleton className=\"h-12 w-full rounded-md\" />\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const currentQuestion = questions[currentQuestionIndex];\n  const winner = playerScore > aiScore ? \"player\" : playerScore < aiScore ? \"ai\" : \"tie\";\n  const DifficultyIcon = getDifficultyIcon(currentQuestion.difficulty);\n\n  return (\n    <div className=\"w-full max-w-lg mx-auto space-y-4\">\n      <Card className=\"overflow-visible\">\n        <CardHeader className=\"pb-2\">\n          <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n            <CardTitle className=\"text-lg flex items-center gap-2 flex-wrap\">\n              <HelpCircle className=\"h-5 w-5\" />\n              Trivia\n              {isAIGenerated ? (\n                <motion.div\n                  initial={{ scale: 0, opacity: 0 }}\n                  animate={{ scale: 1, opacity: 1 }}\n                  transition={{ type: \"spring\", stiffness: 500, damping: 30 }}\n                >\n                  <Badge className=\"text-xs bg-gradient-to-r from-purple-500 via-pink-500 to-orange-400 text-white border-0 shadow-md\">\n                    <Sparkles className=\"h-3 w-3 mr-1\" />\n                    AI Generated\n                  </Badge>\n                </motion.div>\n              ) : (\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  <BookOpen className=\"h-3 w-3 mr-1\" />\n                  Classic\n                </Badge>\n              )}\n            </CardTitle>\n            <div className=\"flex items-center gap-2\">\n              {!isPractice && (\n                <Badge variant=\"secondary\" className=\"text-xs\">\n                  {stake} NGN\n                </Badge>\n              )}\n              {isPractice && (\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  Practice\n                </Badge>\n              )}\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {gamePhase === \"playing\" && (\n            <>\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex items-center gap-2 min-w-0\">\n                  <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                    <User className=\"h-4 w-4 text-primary\" />\n                  </div>\n                  <div className=\"min-w-0\">\n                    <span className=\"font-bold text-lg\">{playerScore}</span>\n                    {streak >= 2 && (\n                      <motion.span\n                        initial={{ scale: 0 }}\n                        animate={{ scale: 1 }}\n                        className=\"ml-1 text-xs text-orange-500\"\n                      >\n                        <Flame className=\"inline h-3 w-3\" />{streak}\n                      </motion.span>\n                    )}\n                  </div>\n                </div>\n                <div className=\"flex-1 text-center\">\n                  <motion.span \n                    key={currentQuestionIndex}\n                    initial={{ scale: 1.2, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    className=\"text-sm font-medium\"\n                  >\n                    {currentQuestionIndex + 1} / {questions.length}\n                  </motion.span>\n                </div>\n                <div className=\"flex items-center gap-2 min-w-0\">\n                  <div className=\"min-w-0\">\n                    <span className=\"font-bold text-lg\">{aiScore}</span>\n                  </div>\n                  <div className=\"w-8 h-8 rounded-full bg-muted flex items-center justify-center flex-shrink-0\">\n                    <Bot className=\"h-4 w-4 text-muted-foreground\" />\n                  </div>\n                </div>\n              </div>\n\n              <Progress \n                value={((currentQuestionIndex) / questions.length) * 100} \n                className=\"h-2\"\n              />\n\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n                  <Badge className={getCategoryColor(currentQuestion.category)}>\n                    {currentQuestion.category}\n                  </Badge>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge className={getDifficultyColor(currentQuestion.difficulty)}>\n                      <DifficultyIcon className=\"h-3 w-3 mr-1\" />\n                      {currentQuestion.difficulty}\n                    </Badge>\n                    <motion.div\n                      animate={timeLeft <= 5 ? { scale: [1, 1.1, 1] } : {}}\n                      transition={{ duration: 0.3, repeat: timeLeft <= 5 ? Infinity : 0 }}\n                    >\n                      <Badge variant={timeLeft <= 5 ? \"destructive\" : \"secondary\"}>\n                        <Clock className=\"h-3 w-3 mr-1\" />\n                        {timeLeft}s\n                      </Badge>\n                    </motion.div>\n                  </div>\n                </div>\n\n                <AnimatePresence mode=\"wait\">\n                  <motion.div\n                    key={currentQuestionIndex}\n                    initial={{ opacity: 0, x: 50 }}\n                    animate={{ opacity: 1, x: 0 }}\n                    exit={{ opacity: 0, x: -50 }}\n                    transition={{ type: \"spring\", stiffness: 300, damping: 30 }}\n                    className=\"p-4 bg-gradient-to-br from-muted/50 to-muted/30 rounded-lg border\"\n                  >\n                    <p className=\"font-medium text-center text-base leading-relaxed\">\n                      {currentQuestion.question}\n                    </p>\n                  </motion.div>\n                </AnimatePresence>\n\n                <div className=\"grid gap-2\">\n                  {currentQuestion.options.map((option, index) => {\n                    let buttonStyle = \"\";\n                    let isCorrect = index === currentQuestion.correctAnswer;\n                    let isSelected = index === selectedAnswer;\n                    let isWrong = isSelected && !isCorrect;\n                    \n                    if (showResult) {\n                      if (isCorrect) {\n                        buttonStyle = \"bg-green-500/20 border-green-500 text-green-700 dark:text-green-300 ring-2 ring-green-500/50\";\n                      } else if (isWrong) {\n                        buttonStyle = \"bg-red-500/20 border-red-500 text-red-700 dark:text-red-300\";\n                      }\n                    }\n                    \n                    return (\n                      <motion.div\n                        key={index}\n                        initial={{ opacity: 0, y: 10 }}\n                        animate={{ opacity: 1, y: 0 }}\n                        transition={{ delay: index * 0.05 }}\n                      >\n                        <Button\n                          variant=\"outline\"\n                          className={`w-full justify-start text-left h-auto py-3 px-4 transition-all duration-200 ${buttonStyle} ${\n                            selectedAnswer === index && !showResult ? \"ring-2 ring-primary shadow-md\" : \"\"\n                          }`}\n                          onClick={() => !showResult && handleAnswer(index)}\n                          disabled={showResult}\n                          data-testid={`answer-${index}`}\n                        >\n                          <motion.span \n                            animate={showResult && isCorrect ? { scale: [1, 1.2, 1] } : {}}\n                            transition={{ duration: 0.3 }}\n                            className={`w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0 ${\n                              showResult && isCorrect \n                                ? \"bg-green-500 text-white\" \n                                : showResult && isWrong \n                                ? \"bg-red-500 text-white\"\n                                : \"bg-muted\"\n                            }`}\n                          >\n                            {showResult && isCorrect ? (\n                              <Check className=\"h-4 w-4\" />\n                            ) : showResult && isWrong ? (\n                              <X className=\"h-4 w-4\" />\n                            ) : (\n                              String.fromCharCode(65 + index)\n                            )}\n                          </motion.span>\n                          <span className=\"flex-1\">{option}</span>\n                        </Button>\n                      </motion.div>\n                    );\n                  })}\n                </div>\n\n                <AnimatePresence>\n                  {showResult && (\n                    <motion.div\n                      initial={{ opacity: 0, y: 10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      exit={{ opacity: 0 }}\n                      className=\"flex items-center justify-between p-3 bg-muted/50 rounded-lg text-sm border\"\n                    >\n                      <div className=\"flex items-center gap-2\">\n                        <User className=\"h-4 w-4\" />\n                        {selectedAnswer === currentQuestion.correctAnswer ? (\n                          <motion.span \n                            initial={{ scale: 0 }}\n                            animate={{ scale: 1 }}\n                            className=\"text-green-600 dark:text-green-400 font-medium\"\n                          >\n                            Correct! +{currentQuestion.difficulty === \"easy\" ? 10 : currentQuestion.difficulty === \"medium\" ? 15 : 20}\n                          </motion.span>\n                        ) : selectedAnswer === null ? (\n                          <span className=\"text-muted-foreground\">Time's up!</span>\n                        ) : (\n                          <span className=\"text-red-600 dark:text-red-400\">Wrong!</span>\n                        )}\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        {aiAnswer === currentQuestion.correctAnswer ? (\n                          <span className=\"text-green-600 dark:text-green-400 text-xs\">AI correct</span>\n                        ) : (\n                          <span className=\"text-red-600 dark:text-red-400 text-xs\">AI wrong</span>\n                        )}\n                        <Bot className=\"h-4 w-4\" />\n                      </div>\n                    </motion.div>\n                  )}\n                </AnimatePresence>\n              </div>\n            </>\n          )}\n\n          {gamePhase === \"results\" && (\n            <motion.div\n              initial={{ opacity: 0, scale: 0.9 }}\n              animate={{ opacity: 1, scale: 1 }}\n              className=\"text-center space-y-6 py-4\"\n            >\n              <motion.div \n                initial={{ scale: 0, rotate: -180 }}\n                animate={{ scale: 1, rotate: 0 }}\n                transition={{ type: \"spring\", stiffness: 200, damping: 15 }}\n                className=\"flex items-center justify-center gap-3\"\n              >\n                <div className={`p-4 rounded-full ${\n                  winner === \"player\" \n                    ? \"bg-gradient-to-br from-yellow-400 to-orange-500\" \n                    : winner === \"tie\" \n                    ? \"bg-gradient-to-br from-blue-400 to-purple-500\"\n                    : \"bg-muted\"\n                }`}>\n                  <Trophy className={`h-10 w-10 ${\n                    winner === \"player\" || winner === \"tie\" ? \"text-white\" : \"text-muted-foreground\"\n                  }`} />\n                </div>\n              </motion.div>\n              \n              <div>\n                <motion.p \n                  initial={{ y: 20, opacity: 0 }}\n                  animate={{ y: 0, opacity: 1 }}\n                  transition={{ delay: 0.2 }}\n                  className=\"text-2xl font-bold\"\n                >\n                  {winner === \"player\" ? \"Victory!\" : winner === \"tie\" ? \"It's a Tie!\" : \"AI Wins!\"}\n                </motion.p>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  {isAIGenerated ? \"AI-Generated Questions\" : \"Classic Questions\"}\n                </p>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <motion.div \n                  initial={{ x: -20, opacity: 0 }}\n                  animate={{ x: 0, opacity: 1 }}\n                  transition={{ delay: 0.3 }}\n                  className={`p-4 rounded-lg ${\n                    winner === \"player\" ? \"bg-gradient-to-br from-green-500/20 to-emerald-500/20 border border-green-500/30\" : \"bg-muted/30\"\n                  }`}\n                >\n                  <div className=\"flex items-center justify-center gap-2 mb-2\">\n                    <User className=\"h-5 w-5 text-primary\" />\n                    <span className=\"font-medium\">You</span>\n                    {winner === \"player\" && <Crown className=\"h-4 w-4 text-yellow-500\" />}\n                  </div>\n                  <p className=\"text-3xl font-bold\">{playerScore}</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    {playerAnswers.filter((a, i) => a === questions[i]?.correctAnswer).length}/{questions.length} correct\n                  </p>\n                  {maxStreak >= 2 && (\n                    <p className=\"text-xs text-orange-500 mt-1\">\n                      <Flame className=\"inline h-3 w-3\" /> Best streak: {maxStreak}\n                    </p>\n                  )}\n                </motion.div>\n                <motion.div \n                  initial={{ x: 20, opacity: 0 }}\n                  animate={{ x: 0, opacity: 1 }}\n                  transition={{ delay: 0.3 }}\n                  className={`p-4 rounded-lg ${\n                    winner === \"ai\" ? \"bg-gradient-to-br from-red-500/20 to-orange-500/20 border border-red-500/30\" : \"bg-muted/30\"\n                  }`}\n                >\n                  <div className=\"flex items-center justify-center gap-2 mb-2\">\n                    <Bot className=\"h-5 w-5 text-muted-foreground\" />\n                    <span className=\"font-medium\">AI</span>\n                    {winner === \"ai\" && <Crown className=\"h-4 w-4 text-yellow-500\" />}\n                  </div>\n                  <p className=\"text-3xl font-bold\">{aiScore}</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    {aiAnswers.filter((a, i) => a === questions[i]?.correctAnswer).length}/{questions.length} correct\n                  </p>\n                </motion.div>\n              </div>\n\n              {!isPractice && (\n                <motion.div\n                  initial={{ y: 10, opacity: 0 }}\n                  animate={{ y: 0, opacity: 1 }}\n                  transition={{ delay: 0.4 }}\n                  className={`p-3 rounded-lg ${\n                    winner === \"player\" \n                      ? \"bg-green-500/10 border border-green-500/30\" \n                      : winner === \"tie\"\n                      ? \"bg-blue-500/10 border border-blue-500/30\"\n                      : \"bg-red-500/10 border border-red-500/30\"\n                  }`}\n                >\n                  <p className=\"text-sm font-medium\">\n                    {winner === \"player\" \n                      ? `You earned ${Math.floor(stake * 2 * 0.95)} NGN!` \n                      : winner === \"tie\"\n                      ? \"Stakes returned to wallet.\"\n                      : `You lost ${stake} NGN.`}\n                  </p>\n                </motion.div>\n              )}\n\n              <motion.div\n                initial={{ y: 10, opacity: 0 }}\n                animate={{ y: 0, opacity: 1 }}\n                transition={{ delay: 0.5 }}\n              >\n                <Button onClick={resetGame} variant=\"outline\" className=\"gap-2\" data-testid=\"button-play-again\">\n                  <RotateCcw className=\"h-4 w-4\" />\n                  Play Again\n                </Button>\n              </motion.div>\n            </motion.div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":42410,"size_tokens":null},"server/seed.ts":{"content":"import { db } from \"./db\";\nimport { categories } from \"@shared/schema\";\n\nconst defaultCategories = [\n  // Core Electronics & Tech\n  { name: \"Electronics\", slug: \"electronics\", icon: \"Smartphone\", description: \"Smartphones, laptops, tablets, and accessories\" },\n  { name: \"Phones & Tablets\", slug: \"phones-tablets\", icon: \"Tablet\", description: \"Mobile phones, tablets, and related accessories\" },\n  { name: \"Computers & Laptops\", slug: \"computers-laptops\", icon: \"Laptop\", description: \"Laptops, desktops, and computer accessories\" },\n  { name: \"Gadgets & Accessories\", slug: \"gadgets-accessories\", icon: \"Headphones\", description: \"Tech gadgets, phone cases, and accessories\" },\n  { name: \"Gaming\", slug: \"gaming\", icon: \"Gamepad2\", description: \"Consoles, games, and gaming accessories\" },\n  { name: \"Photography\", slug: \"photography\", icon: \"Camera\", description: \"Cameras, lenses, lighting, and photo equipment\" },\n  \n  // Fashion & Style\n  { name: \"Fashion\", slug: \"fashion\", icon: \"Shirt\", description: \"Clothes, shoes, bags, and jewelry\" },\n  { name: \"Shoes & Footwear\", slug: \"shoes-footwear\", icon: \"Footprints\", description: \"Sneakers, sandals, heels, and all footwear\" },\n  { name: \"Bags & Luggage\", slug: \"bags-luggage\", icon: \"Backpack\", description: \"Backpacks, handbags, travel bags, and luggage\" },\n  { name: \"Jewelry & Watches\", slug: \"jewelry-watches\", icon: \"Watch\", description: \"Rings, necklaces, bracelets, and watches\" },\n  { name: \"Clothing Accessories\", slug: \"clothing-accessories\", icon: \"Glasses\", description: \"Belts, hats, scarves, and sunglasses\" },\n  { name: \"Ankara & Fabrics\", slug: \"ankara-fabrics\", icon: \"Scissors\", description: \"African fabrics, Ankara, lace, and tailoring materials\" },\n  \n  // Beauty & Personal Care\n  { name: \"Beauty & Personal Care\", slug: \"beauty-personal-care\", icon: \"Sparkles\", description: \"Makeup, skincare, and personal care products\" },\n  { name: \"Skincare\", slug: \"skincare\", icon: \"Droplet\", description: \"Moisturizers, serums, cleansers, and skincare products\" },\n  { name: \"Haircare\", slug: \"haircare\", icon: \"Wind\", description: \"Shampoos, conditioners, styling products\" },\n  { name: \"Makeup\", slug: \"makeup\", icon: \"Brush\", description: \"Foundation, lipstick, mascara, and cosmetics\" },\n  { name: \"Wigs & Hair\", slug: \"wigs-hair\", icon: \"Scissors\", description: \"Wigs, hair extensions, and hair products\" },\n  { name: \"Perfumes & Fragrances\", slug: \"perfumes-fragrances\", icon: \"Flame\", description: \"Perfumes, body sprays, and fragrances\" },\n  \n  // Books & Education\n  { name: \"Books & Stationery\", slug: \"books-stationery\", icon: \"BookOpen\", description: \"Textbooks, notebooks, pens, and supplies\" },\n  { name: \"Study Materials\", slug: \"study-materials\", icon: \"FileText\", description: \"Notes, past questions, and study guides\" },\n  { name: \"Textbooks\", slug: \"textbooks\", icon: \"Book\", description: \"Course textbooks and academic materials\" },\n  { name: \"Project Materials\", slug: \"project-materials\", icon: \"FolderOpen\", description: \"Materials for school projects and presentations\" },\n  { name: \"Lab Equipment\", slug: \"lab-equipment\", icon: \"FlaskConical\", description: \"Lab coats, safety goggles, and lab supplies\" },\n  \n  // Food & Drinks\n  { name: \"Food & Groceries\", slug: \"food-groceries\", icon: \"Apple\", description: \"Pre-packaged foods, snacks, and groceries\" },\n  { name: \"Drinks & Beverages\", slug: \"drinks-beverages\", icon: \"Coffee\", description: \"Soft drinks, juices, energy drinks, and more\" },\n  { name: \"Snacks & Provisions\", slug: \"snacks-provisions\", icon: \"Cookie\", description: \"Packaged snacks, biscuits, and student provisions\" },\n  { name: \"Home Cooked Food\", slug: \"home-cooked-food\", icon: \"Soup\", description: \"Homemade meals and food delivery on campus\" },\n  \n  // Home & Living\n  { name: \"Home & Living\", slug: \"home-living\", icon: \"Home\", description: \"Home decor, kitchenware, and living essentials\" },\n  { name: \"Furniture\", slug: \"furniture\", icon: \"Sofa\", description: \"Desks, chairs, beds, and dorm essentials\" },\n  { name: \"Kitchen & Appliances\", slug: \"kitchen-appliances\", icon: \"ChefHat\", description: \"Cooking appliances, utensils, and kitchenware\" },\n  { name: \"Bedding & Linens\", slug: \"bedding-linens\", icon: \"Bed\", description: \"Mattresses, pillows, bedsheets, and blankets\" },\n  \n  // Nigerian Campus Essentials\n  { name: \"Data & Airtime\", slug: \"data-airtime\", icon: \"Wifi\", description: \"Data bundles, airtime, and mobile recharge\" },\n  { name: \"Generators & Power\", slug: \"generators-power\", icon: \"Zap\", description: \"Generators, inverters, power banks, and batteries\" },\n  { name: \"Cooking Gas\", slug: \"cooking-gas\", icon: \"Flame\", description: \"Cooking gas refills and gas accessories\" },\n  { name: \"Water & Dispensers\", slug: \"water-dispensers\", icon: \"Droplets\", description: \"Water dispensers, bottles, and purifiers\" },\n  \n  // Services\n  { name: \"Services\", slug: \"services\", icon: \"Briefcase\", description: \"Tutoring, repairs, and other services\" },\n  { name: \"Tutorial Classes\", slug: \"tutorial-classes\", icon: \"GraduationCap\", description: \"Private tutoring, lessons, and coaching\" },\n  { name: \"Printing & Photocopy\", slug: \"printing-photocopy\", icon: \"Printer\", description: \"Printing, photocopying, and binding services\" },\n  { name: \"Tech Repairs\", slug: \"tech-repairs\", icon: \"Wrench\", description: \"Phone, laptop, and gadget repair services\" },\n  { name: \"Hair & Beauty Services\", slug: \"hair-beauty-services\", icon: \"Scissors\", description: \"Barbing, hair styling, makeup, and nails\" },\n  { name: \"Tailoring & Fashion Design\", slug: \"tailoring-fashion\", icon: \"Ruler\", description: \"Clothing alterations and custom tailoring\" },\n  { name: \"Digital Services\", slug: \"digital-services\", icon: \"Monitor\", description: \"Graphic design, web development, and digital work\" },\n  { name: \"Assignment Help\", slug: \"assignment-help\", icon: \"PenTool\", description: \"Academic writing and project assistance\" },\n  { name: \"Photography Services\", slug: \"photography-services\", icon: \"Aperture\", description: \"Event photography and photo editing\" },\n  { name: \"Laundry Services\", slug: \"laundry-services\", icon: \"Shirt\", description: \"Clothes washing, ironing, and dry cleaning\" },\n  \n  // Entertainment & Events\n  { name: \"Tickets & Events\", slug: \"tickets-events\", icon: \"Ticket\", description: \"Event tickets, passes, and reservations\" },\n  { name: \"Party Supplies\", slug: \"party-supplies\", icon: \"PartyPopper\", description: \"Decorations, balloons, and party essentials\" },\n  { name: \"Musical Instruments\", slug: \"musical-instruments\", icon: \"Music\", description: \"Instruments, audio equipment, and accessories\" },\n  \n  // Sports & Fitness\n  { name: \"Sports & Fitness\", slug: \"sports-fitness\", icon: \"Dumbbell\", description: \"Sports equipment and fitness gear\" },\n  { name: \"Gym Equipment\", slug: \"gym-equipment\", icon: \"Dumbbell\", description: \"Home workout and gym equipment\" },\n  { name: \"Sportswear\", slug: \"sportswear\", icon: \"Trophy\", description: \"Athletic clothing, jerseys, and sports shoes\" },\n  \n  // Health & Wellness\n  { name: \"Health & Wellness\", slug: \"health-wellness\", icon: \"Heart\", description: \"Health products and wellness items\" },\n  { name: \"First Aid & Medicine\", slug: \"first-aid-medicine\", icon: \"Stethoscope\", description: \"First aid kits, OTC medicines, and health supplies\" },\n  \n  // Transportation\n  { name: \"Vehicles\", slug: \"vehicles\", icon: \"Bike\", description: \"Bicycles, motorcycles, and vehicle parts\" },\n  { name: \"Bicycles\", slug: \"bicycles\", icon: \"Bike\", description: \"Bicycles and cycling accessories\" },\n  { name: \"Motorcycles\", slug: \"motorcycles\", icon: \"Bike\", description: \"Motorcycles, okada, and spare parts\" },\n  \n  // Art & Creativity\n  { name: \"Art & Crafts\", slug: \"art-crafts\", icon: \"Palette\", description: \"Art supplies, crafts, and handmade items\" },\n  { name: \"Handmade Items\", slug: \"handmade-items\", icon: \"Heart\", description: \"Handcrafted jewelry, decor, and gifts\" },\n  \n  // Digital & Accounts\n  { name: \"Accounts\", slug: \"accounts\", icon: \"User\", description: \"Social media, gaming, and digital accounts\" },\n  { name: \"Subscriptions\", slug: \"subscriptions\", icon: \"CreditCard\", description: \"Netflix, Spotify, and streaming subscriptions\" },\n  { name: \"Software & Licenses\", slug: \"software-licenses\", icon: \"Package\", description: \"Software, apps, and digital licenses\" },\n  \n  // Other Categories\n  { name: \"Baby & Kids\", slug: \"baby-kids\", icon: \"Baby\", description: \"Baby products, toys, and children's items\" },\n  { name: \"Pet Supplies\", slug: \"pet-supplies\", icon: \"PawPrint\", description: \"Pet food, accessories, and animal care\" },\n  { name: \"Religious Items\", slug: \"religious-items\", icon: \"Church\", description: \"Prayer mats, rosaries, and religious materials\" },\n  \n  // Campus-Specific\n  { name: \"Roommate Needed\", slug: \"roommate-needed\", icon: \"Users\", description: \"Find roommates and shared accommodation\" },\n  { name: \"Hostel Items\", slug: \"hostel-items\", icon: \"Building\", description: \"Essential items for hostel living\" },\n  { name: \"Lost & Found\", slug: \"lost-found\", icon: \"Search\", description: \"Report or find lost items on campus\" },\n  { name: \"Free Items\", slug: \"free-items\", icon: \"Gift\", description: \"Free giveaways and items to share\" },\n  { name: \"Rentals\", slug: \"rentals\", icon: \"Key\", description: \"Items available for rent or hire\" },\n  { name: \"Exchange & Swap\", slug: \"exchange-swap\", icon: \"ArrowLeftRight\", description: \"Trade and exchange items with others\" },\n  { name: \"Jobs & Gigs\", slug: \"jobs-gigs\", icon: \"Briefcase\", description: \"Part-time jobs and freelance opportunities\" },\n  { name: \"Internships\", slug: \"internships\", icon: \"GraduationCap\", description: \"Internship and work experience opportunities\" },\n];\n\nasync function seed() {\n  try {\n    console.log(\"Seeding categories...\");\n    \n    for (const category of defaultCategories) {\n      await db.insert(categories)\n        .values(category)\n        .onConflictDoNothing();\n    }\n    \n    console.log(\"✓ Categories seeded successfully\");\n  } catch (error) {\n    console.error(\"Error seeding:\", error);\n  } finally {\n    process.exit(0);\n  }\n}\n\nseed();\n","path":null,"size_bytes":10158,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    // Build URL from primitive parts of queryKey, and extract query params from objects\n    const urlParts: string[] = [];\n    const queryParams = new URLSearchParams();\n    \n    for (const part of queryKey) {\n      if (typeof part === \"string\" || typeof part === \"number\" || typeof part === \"boolean\") {\n        // Include primitives (strings, numbers, booleans) in the URL path\n        urlParts.push(String(part));\n      } else if (typeof part === \"object\" && part !== null) {\n        // Convert object to query parameters\n        for (const [key, value] of Object.entries(part)) {\n          if (value !== undefined && value !== null && value !== \"\") {\n            queryParams.append(key, String(value));\n          }\n        }\n      }\n    }\n    \n    let url = urlParts.join(\"/\");\n    const queryString = queryParams.toString();\n    if (queryString) {\n      url += `?${queryString}`;\n    }\n    \n    const res = await fetch(url, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: 30000,\n      gcTime: 300000,\n      retry: 1,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":2270,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"server/chatbot.ts":{"content":"import Groq from \"groq-sdk\";\n\nconst groqClient = new Groq({\n  apiKey: process.env.GROQ_API_KEY || \"not-set\",\n});\n\nconst API_TIMEOUT_MS = 10000;\n\nconst CACHED_RESPONSES: Record<string, string> = {\n  \"how to sell\": \"To sell on EKSU Marketplace:\\n\\n1. Tap the + button or go to My Ads page\\n2. Select your product category\\n3. Add clear photos (up to 5)\\n4. Write a catchy title and detailed description\\n5. Set your price (be competitive!)\\n6. Add your location for easy pickup\\n7. Post and wait for buyers!\\n\\nYour first listing gets FREE boost. Pro tip: Good photos and honest descriptions sell faster. No wahala!\",\n\n  \"what is escrow\": \"Escrow na secure payment system wey protect both buyer and seller!\\n\\nHow e work:\\n1. Buyer pays - money go ESCROW (not seller directly)\\n2. Seller sees payment notification\\n3. Seller sends item to buyer\\n4. Buyer confirms receipt\\n5. Money releases to seller\\n\\nIf anything go wrong, money still safe for escrow. No more \\\"I don pay, seller disappear\\\" stories. Na the SAFEST way to trade on campus!\",\n\n  \"how to buy\": \"Buying on EKSU Marketplace is easy:\\n\\n1. Browse products on Home or use Search\\n2. Tap any item to see full details\\n3. Chat with seller to negotiate or ask questions\\n4. Tap BUY NOW and pay through the app\\n5. Your money goes to ESCROW (safe!)\\n6. Collect your item from seller\\n7. Confirm delivery in app\\n8. Money releases to seller\\n\\nALWAYS use escrow - never pay outside the app!\",\n\n  \"how to deposit\": \"To add money to your wallet:\\n\\n1. Go to Wallet page (tap Wallet icon)\\n2. Tap 'Add Money' or 'Deposit'\\n3. Enter amount (minimum N100)\\n4. Choose payment method:\\n   - Bank Transfer\\n   - Debit Card\\n   - USSD\\n5. Complete payment\\n6. Money reflects in seconds!\\n\\nYour wallet is secure and you can use it for all purchases and game stakes.\",\n\n  \"how to withdraw\": \"To withdraw from your wallet:\\n\\n1. Go to Wallet page\\n2. Tap 'Withdraw'\\n3. Enter amount (minimum N500)\\n4. Add your bank details (first time only)\\n5. Confirm with your PIN\\n6. Money arrives within 24 hours!\\n\\nWithdrawal fee: N50 per transaction. Make sure your bank details are correct to avoid delays.\",\n\n  \"report scam\": \"To report a scammer:\\n\\n1. Go to Support page\\n2. Tap 'Submit Ticket'\\n3. Select 'Scam Report' category\\n4. Include:\\n   - Scammer's username\\n   - Screenshots of conversations\\n   - Payment proof (if any)\\n   - What happened\\n5. Submit!\\n\\nWe investigate within 1-4 hours. You can also report from user's profile or chat. IMPORTANT: Only use escrow - we can NOT help with outside payments!\",\n\n  \"hello\": \"Hey! How far? I'm your campus marketplace assistant. I sabi everything about buying, selling, wallet, games, and staying safe. Wetin you wan know?\",\n\n  \"hi\": \"Hello! Welcome to EKSU Marketplace. I fit help you with:\\n- Buying and selling items\\n- Wallet (deposits, withdrawals)\\n- Games (Ludo, Trivia, Word Battle)\\n- Reporting scams\\n- Getting verified\\n\\nWetin you need help with today?\",\n\n  \"games\": \"We get three FIRE games:\\n\\n1. LUDO - Classic board game, 2-4 players\\n   Stake: N100 - N10,000\\n\\n2. WORD BATTLE - Make words from letters\\n   Stake: N200 - N5,000\\n\\n3. TRIVIA - Answer quiz questions\\n   Stake: N200 - N10,000\\n\\nYou fit play for fun (free) or stake money to win! Must be verified student to stake. Winnings go straight to wallet. Game on!\",\n\n  \"wallet\": \"Your Wallet is your money center:\\n\\n- Check balance anytime\\n- DEPOSIT: Add money via card, transfer, or USSD\\n- WITHDRAW: Send to any Nigerian bank (24hr max)\\n- View all transaction history\\n- Track escrow for pending orders\\n\\nMinimum deposit: N100\\nMinimum withdrawal: N500\\nWithdrawal fee: N50\\n\\nNeed specific help? Ask about deposit or withdraw!\",\n\n  \"verify\": \"Getting verified gives you more trust:\\n\\n1. STUDENT VERIFICATION (Green badge)\\n   - Upload valid EKSU student ID\\n   - Approval within 24 hours\\n   - Required to stake in games\\n\\n2. NIN VERIFICATION (Blue badge)\\n   - Add your NIN number\\n   - Instant verification\\n   - Higher trust score\\n\\nGo to Profile > Verification to start. Verified accounts get more buyers and can access all features!\",\n\n  \"help\": \"I fit help you with:\\n\\n- HOW TO SELL - List items for sale\\n- HOW TO BUY - Purchase safely\\n- ESCROW - Safe payment system\\n- WALLET - Deposits and withdrawals\\n- GAMES - Ludo, Trivia, Word Battle\\n- REPORT SCAM - Stay protected\\n- VERIFY - Get verified badge\\n\\nJust ask any question in English or Pidgin! Wetin you need?\",\n\n  \"referral\": \"Earn money by referring friends!\\n\\n1. Go to Referrals page\\n2. Copy your unique code\\n3. Share via WhatsApp, SMS, or social media\\n4. You get N500 when friend verifies\\n5. Friend gets N300 bonus\\n\\nMilestones: 5 referrals = N3,000 bonus, 10 = N7,500! Referral earnings go straight to wallet.\",\n\n  \"boost\": \"Boost makes your product appear at the TOP of listings!\\n\\n1. Go to My Ads\\n2. Select the product you want to boost\\n3. Choose boost duration (1-7 days)\\n4. Pay from wallet\\n5. Watch more buyers message you!\\n\\nBoosted items get 5-10x more views. First listing gets FREE boost!\",\n};\n\nfunction matchCachedResponse(query: string): string | null {\n  const normalizedQuery = query.toLowerCase().trim();\n  \n  for (const [pattern, response] of Object.entries(CACHED_RESPONSES)) {\n    if (normalizedQuery.includes(pattern)) {\n      return response;\n    }\n  }\n  \n  const exactMatches: Record<string, string> = {\n    \"hi\": CACHED_RESPONSES[\"hi\"],\n    \"hey\": CACHED_RESPONSES[\"hello\"],\n    \"hello\": CACHED_RESPONSES[\"hello\"],\n    \"help\": CACHED_RESPONSES[\"help\"],\n    \"?\": CACHED_RESPONSES[\"help\"],\n  };\n  \n  if (exactMatches[normalizedQuery]) {\n    return exactMatches[normalizedQuery];\n  }\n  \n  return null;\n}\n\nfunction isSimpleQuestion(query: string): boolean {\n  const simplePatterns = [\n    /^(hi|hey|hello|yo|sup|what'?s up)/i,\n    /^(thanks|thank you|okay|ok|cool|nice)/i,\n    /^(bye|goodbye|later|see you)/i,\n    /\\?$/,\n  ];\n  \n  return query.length < 50 && simplePatterns.some(pattern => pattern.test(query));\n}\n\nasync function callGroqWithTimeout(\n  messages: { role: string; content: string }[],\n  model: string,\n  timeoutMs: number\n): Promise<string> {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), timeoutMs);\n\n  try {\n    const chatCompletion = await groqClient.chat.completions.create({\n      messages: messages as any,\n      model,\n      temperature: 0.7,\n      max_tokens: 600,\n    });\n\n    clearTimeout(timeoutId);\n    return chatCompletion.choices[0]?.message?.content || \"\";\n  } catch (error: any) {\n    clearTimeout(timeoutId);\n    if (error.name === 'AbortError') {\n      throw new Error('API request timed out');\n    }\n    throw error;\n  }\n}\n\nconst SYSTEM_PROMPT = `You are the EKSU Campus Marketplace AI Assistant - smart, helpful, and occasionally sassy when appropriate.\n\nCRITICAL FORMATTING RULES - FOLLOW THESE STRICTLY:\n- NEVER use asterisks for emphasis. No ** or * anywhere in your response.\n- Use CAPS for emphasis instead of bold. Example: \"ALWAYS use escrow\" not \"**always use escrow**\"\n- Use quotes for emphasis instead of italics. Example: \"this is important\" not \"*this is important*\"\n- No markdown formatting at all - plain text only\n- Use line breaks and numbered lists for structure\n- Keep responses conversational and natural\n\nYour Personality:\n- Friendly, conversational, and helpful\n- Use Nigerian Pidgin naturally when it fits\n- Be direct about safety and scam prevention\n- Know when to be serious vs playful\n- Understand Pidgin, Yoruba, Igbo expressions\n\nNigerian Pidgin Expressions (Use Naturally):\n- \"No wahala\" = No problem\n- \"Sharp sharp\" = Quickly\n- \"Omo\" = Expression like \"Bro\"\n- \"Wetin\" = What\n- \"E dey\" = It's available\n- \"Na so\" = That's how it is\n- \"Abeg\" = Please\n- \"How far\" = What's up\n- \"Sabi\" = Know/Understand\n- \"Chop\" = Eat/Use\n- \"No vex\" = Don't be angry\n- \"Make we run am\" = Let's do it\n- \"Shey you understand?\" = Do you understand?\n\nAPP SECTIONS - Know These Well:\n\nHOME PAGE:\n- Browse all available products\n- See featured and boosted items at the top\n- Categories: Electronics, Fashion, Books, Food, Services, etc.\n- Filter by price, condition, location\n- Tap any product to view details\n- Start shopping button takes you here\n\nSEARCH PAGE:\n- Find specific items using search bar\n- Use filters: Category, Price range, Condition, Location\n- Search by product name, course code (for textbooks), keywords\n- Sort by: Newest, Price low-high, Price high-low\n- Save searches for notifications when matching items appear\n\nGAMES SECTION:\nThree main games available:\n\n1. LUDO GAME\n   - Classic 4-player Ludo board game\n   - Play for fun (free) or stake money\n   - Stake range: N100 - N10,000 per game\n   - Win entire pot if you get all pieces home first\n   - Multiplayer: Challenge friends or random opponents\n\n2. WORD BATTLE\n   - Word puzzle game - make words from letters\n   - Timed rounds, score based on word length\n   - Play solo for practice or stake against others\n   - Stake range: N200 - N5,000\n   - Higher difficulty = Higher multiplier\n\n3. TRIVIA GAME\n   - Answer quiz questions from various categories\n   - Categories: EKSU knowledge, Nigerian trivia, Sports, Entertainment\n   - 10 questions per round, 20 seconds each\n   - Score determines prize (10/10 = 2.5x stake, 8/10 = 1.5x, 6/10 = 1x refund)\n   - Stake range: N200 - N10,000\n\nGame Rules:\n- Must be verified student to play stakes\n- Winnings go directly to wallet (5% platform fee)\n- Can set daily spending limits\n- Free practice modes available\n- Responsible gaming - only stake what you can afford\n\nWALLET PAGE:\n- View current balance\n- DEPOSIT: Add money via bank transfer, card, USSD\n- WITHDRAW: Send money to any Nigerian bank\n- Transaction history: See all deposits, withdrawals, purchases\n- Escrow status: Track money held for pending transactions\n- Minimum deposit: N100, Minimum withdrawal: N500\n- Withdrawal fee: N50 per transaction\n\nPROFILE PAGE:\n- Edit your profile: Name, photo, bio, contact\n- Student verification: Upload student ID for green badge\n- NIN verification: Add NIN for blue verified badge\n- Settings: Notifications, privacy, security\n- View your trust score (1.0 - 5.0)\n- Change password and security options\n- Switch between buyer/seller roles\n\nMESSAGES PAGE:\n- Chat with buyers and sellers\n- Real-time messaging with read receipts\n- Share images (up to 5 per message)\n- Voice notes (up to 60 seconds)\n- Report suspicious users directly from chat\n- Price negotiation tools built-in\n- Block users if needed\n\nMY ADS PAGE:\n- View all your listed products\n- See status: Active, Sold, Pending, Draft\n- Edit listings: Update price, photos, description\n- Boost products for more visibility\n- Mark items as sold\n- Delete listings\n- View analytics: Views, saves, messages received\n\nREFERRALS PAGE:\n- Get your unique referral code\n- Share via WhatsApp, SMS, or social media\n- Track who signed up with your code\n- Earnings: N500 when referred user verifies\n- Friend gets: N300 extra welcome bonus\n- Milestones: 5 referrals = N3,000 bonus, 10 = N7,500\n- Withdraw referral earnings to wallet\n\nSUPPORT PAGE:\n- View FAQ for common questions\n- Submit support ticket for issues\n- Categories: Account, Payment, Dispute, Bug, Other\n- Track ticket status\n- Response times: Urgent 1-4 hours, Normal 12-24 hours\n- Emergency SOS for immediate threats\n- Contact admin directly for serious issues\n\nSELLER DASHBOARD:\n- Sales analytics: Total sales, revenue, growth\n- Order management: Track pending and completed orders\n- Customer insights: Repeat buyers, ratings\n- Performance metrics: Response time, completion rate\n- Boost suggestions for slow products\n- Earnings breakdown and withdrawal history\n\nADMIN PANEL (Admin users only):\n- Manage all users: Verify, suspend, ban\n- Review reported products and users\n- Handle disputes and escalations\n- Create announcements for all users\n- Manage categories and boost packages\n- View platform analytics and revenue\n\nESCROW SYSTEM - VERY IMPORTANT:\n- All purchases go through escrow for protection\n- When buyer pays, money goes to ESCROW not seller\n- Seller sees payment notification but cannot access money yet\n- After buyer receives item and confirms, money releases to seller\n- Disputes can be raised within 24 hours of delivery\n- Platform holds funds maximum 7 days before auto-release\n\nNAVIGATION TIPS:\n- To sell: Tap + button or go to My Ads and create new listing\n- To check balance: Go to Wallet tab\n- To report scam: Go to Support and submit ticket\n- To play games: Tap Games in the menu\n- To verify account: Go to Profile then Verification\n- To find specific item: Use Search with filters\n\nCOMMON USER INTENTS AND RESPONSES:\n\nIf user asks \"how do I sell\":\nTell them to tap the + button or go to My Ads page, then guide them through: choose category, add photos, write title and description, set price, add location, and post.\n\nIf user asks about \"my balance\" or \"wallet\":\nTell them to go to the Wallet tab to see their balance, deposit money, withdraw, or view transaction history.\n\nIf user wants to \"report a scam\":\nTell them to go to Support page and submit a ticket under the Scam Report category. Include screenshots and all evidence. They can also report directly from the user's profile.\n\nIf user asks about games:\nExplain Ludo, Word Battle, and Trivia. Tell them they can play for fun or stake money. Must be verified to stake.\n\nIf user seems lost:\nAsk what they're trying to do and guide them to the right section of the app.\n\nCONTEXT-AWARE RESPONSES:\nWhen you know the user's current page, give specific help for that section.\n\nIf on HOME: Help them browse, explain categories, suggest using filters\nIf on SEARCH: Help with search tips, explain filters\nIf on GAMES: Explain game rules, stakes, how to play\nIf on WALLET: Help with deposits, withdrawals, transactions\nIf on PROFILE: Help with verification, settings, editing profile\nIf on MESSAGES: Help with chat features, reporting\nIf on MY ADS: Help manage listings, boost products\nIf on REFERRALS: Explain referral system, how to share code\nIf on SUPPORT: Help submit tickets, find FAQ answers\nIf on SELLER DASHBOARD: Help understand analytics, manage orders\nIf on ADMIN: Help with admin tasks (if admin user)\n\nSAFETY REMINDERS - Always mention when relevant:\n- ALWAYS use escrow for purchases\n- NEVER pay outside the app\n- Check seller verification badges\n- Report suspicious activity immediately\n- Meet in public places for pickups\n- Trust scores indicate reliability\n\nKeep responses:\n- Concise but helpful (2-4 sentences for simple questions)\n- Detailed when needed (step-by-step for complex tasks)\n- Friendly and encouraging\n- Safe - always promote escrow and in-app transactions`;\n\nexport interface ChatMessage {\n  role: \"user\" | \"assistant\" | \"system\";\n  content: string;\n}\n\nexport interface UserContext {\n  role?: string;\n  isVerified?: boolean;\n  trustScore?: string;\n  currentPage?: string;\n  userId?: string;\n}\n\nexport interface ChatbotResponse {\n  message: string;\n  shouldHandoff: boolean;\n  handoffReason?: string;\n  suggestedCategory?: string;\n  frustrationLevel?: number;\n}\n\nexport async function getChatbotResponse(\n  messages: ChatMessage[],\n  userContext?: UserContext\n): Promise<string> {\n  try {\n    const lastMessage = messages[messages.length - 1];\n    if (lastMessage && lastMessage.role === \"user\") {\n      const cachedResponse = matchCachedResponse(lastMessage.content);\n      if (cachedResponse) {\n        console.log(\"Returning cached response for:\", lastMessage.content.substring(0, 50));\n        return cachedResponse;\n      }\n    }\n\n    let contextualPrompt = SYSTEM_PROMPT;\n    \n    if (userContext) {\n      contextualPrompt += `\\n\\nCURRENT USER CONTEXT:\\n`;\n      \n      if (userContext.currentPage) {\n        contextualPrompt += `- User is currently on: ${userContext.currentPage} page\\n`;\n        contextualPrompt += `- Provide help relevant to this section when appropriate\\n`;\n      }\n      \n      if (userContext.role) {\n        contextualPrompt += `- User role: ${userContext.role}\\n`;\n      }\n      \n      if (userContext.isVerified !== undefined) {\n        contextualPrompt += `- Verified student: ${userContext.isVerified ? \"Yes\" : \"No\"}\\n`;\n        if (!userContext.isVerified) {\n          contextualPrompt += `- Remind them to verify for full features when relevant\\n`;\n        }\n      }\n      \n      if (userContext.trustScore) {\n        contextualPrompt += `- Trust score: ${userContext.trustScore}/5.0\\n`;\n      }\n    }\n\n    const useSimpleQuestion = lastMessage && isSimpleQuestion(lastMessage.content);\n    const model = useSimpleQuestion ? \"llama-3.1-8b-instant\" : \"llama-3.3-70b-versatile\";\n    const timeout = useSimpleQuestion ? 5000 : API_TIMEOUT_MS;\n\n    let response: string;\n    try {\n      response = await callGroqWithTimeout(\n        [\n          { role: \"system\", content: contextualPrompt },\n          ...messages,\n        ],\n        model,\n        timeout\n      );\n    } catch (timeoutError: any) {\n      console.warn(\"API timeout, trying faster model:\", timeoutError.message);\n      response = await callGroqWithTimeout(\n        [\n          { role: \"system\", content: contextualPrompt },\n          ...messages,\n        ],\n        \"llama-3.1-8b-instant\",\n        5000\n      );\n    }\n\n    if (!response) {\n      response = \"Sorry, I no fit process your message now. Try again!\";\n    }\n    \n    response = cleanMarkdown(response);\n    \n    return response;\n  } catch (error) {\n    console.error(\"Groq API error:\", error);\n    return \"Omo, something don happen. I no fit connect now. Try again or contact support if e continue. No wahala!\";\n  }\n}\n\nfunction cleanMarkdown(text: string): string {\n  let cleaned = text;\n  cleaned = cleaned.replace(/\\*\\*\\*/g, '');\n  cleaned = cleaned.replace(/\\*\\*/g, '');\n  cleaned = cleaned.replace(/\\*/g, '');\n  cleaned = cleaned.replace(/_{2,}/g, '');\n  cleaned = cleaned.replace(/`{1,3}/g, '');\n  cleaned = cleaned.replace(/^#+\\s/gm, '');\n  cleaned = cleaned.replace(/^\\s*[-*+]\\s/gm, '- ');\n  return cleaned.trim();\n}\n\nexport function checkForPaymentScam(message: string): boolean {\n  const scamKeywords = [\n    \"bank account\",\n    \"account number\",\n    \"transfer money\",\n    \"pay outside\",\n    \"send money directly\",\n    \"cash on delivery\",\n    \"mobile money\",\n    \"pay before\",\n    \"send am\",\n    \"transfer am\",\n    \"my account\",\n    \"direct payment\",\n    \"pay me direct\",\n    \"send to my\",\n    \"opay\",\n    \"palmpay\",\n    \"pay to my\",\n    \"send to account\",\n  ];\n\n  const messageLower = message.toLowerCase();\n  return scamKeywords.some(keyword => messageLower.includes(keyword));\n}\n\n// Detect if user needs human support\nexport function detectHandoffNeed(messages: ChatMessage[]): { shouldHandoff: boolean; reason?: string; category?: string; frustrationLevel: number } {\n  const conversationText = messages.map(m => m.content.toLowerCase()).join(' ');\n  const lastFewMessages = messages.slice(-3);\n  const lastMessage = messages[messages.length - 1]?.content.toLowerCase() || '';\n  \n  let frustrationLevel = 0;\n  let reason: string | undefined;\n  let category: string | undefined;\n  \n  // Frustration indicators\n  const frustrationPatterns = [\n    { pattern: /not working|doesn't work|broken|won't|can't|unable/gi, weight: 1 },\n    { pattern: /useless|stupid|rubbish|trash|waste|annoying/gi, weight: 2 },\n    { pattern: /human|real person|agent|staff|support|customer service/gi, weight: 3 },\n    { pattern: /scam|scammed|stole|stolen|thief|fraud/gi, weight: 4 },\n    { pattern: /please help|help me|i need help|urgent|emergency/gi, weight: 2 },\n    { pattern: /lost money|money missing|funds missing|wallet empty/gi, weight: 4 },\n    { pattern: /refund|get my money back|return my money/gi, weight: 3 },\n    { pattern: /angry|frustrated|upset|disappointed|terrible/gi, weight: 2 },\n    { pattern: /wetin dey|no understand|confused|still not|again/gi, weight: 1 },\n    { pattern: /!!+|\\?{2,}|caps lock/gi, weight: 1 },\n  ];\n  \n  for (const { pattern, weight } of frustrationPatterns) {\n    const matches = conversationText.match(pattern);\n    if (matches) {\n      frustrationLevel += matches.length * weight;\n    }\n  }\n  \n  // Repeated similar questions indicate bot not helping\n  const userMessages = messages.filter(m => m.role === 'user');\n  if (userMessages.length >= 3) {\n    const recentUserMessages = userMessages.slice(-3).map(m => m.content.toLowerCase());\n    const similarCount = recentUserMessages.filter((msg, i, arr) => \n      i > 0 && arr[i-1] && (\n        msg.includes(arr[i-1].substring(0, 20)) || \n        arr[i-1].includes(msg.substring(0, 20))\n      )\n    ).length;\n    frustrationLevel += similarCount * 2;\n  }\n  \n  // Detect specific issues that need human support\n  if (/scam|scammed|fraud|stolen|thief/.test(lastMessage)) {\n    reason = \"User is reporting a scam or fraud incident\";\n    category = \"scam_report\";\n    frustrationLevel = Math.max(frustrationLevel, 5);\n  } else if (/money missing|wallet.*empty|funds.*gone|lost.*money/.test(lastMessage)) {\n    reason = \"User has a financial issue with their wallet\";\n    category = \"payment\";\n    frustrationLevel = Math.max(frustrationLevel, 5);\n  } else if (/refund|money back|return.*payment/.test(lastMessage)) {\n    reason = \"User is requesting a refund\";\n    category = \"payment\";\n    frustrationLevel = Math.max(frustrationLevel, 4);\n  } else if (/human|real person|support|talk to someone|agent|staff/.test(lastMessage)) {\n    reason = \"User explicitly requested human support\";\n    category = \"general\";\n    frustrationLevel = Math.max(frustrationLevel, 5);\n  } else if (/verify|verification|kyc|not approved|rejected/.test(lastMessage) && frustrationLevel >= 2) {\n    reason = \"User is having verification issues\";\n    category = \"account\";\n  } else if (/account.*locked|banned|suspended|can't.*login|access.*denied/.test(lastMessage)) {\n    reason = \"User has account access issues\";\n    category = \"account\";\n    frustrationLevel = Math.max(frustrationLevel, 4);\n  } else if (/withdraw|withdrawal.*failed|money.*stuck|pending.*too.*long/.test(lastMessage) && frustrationLevel >= 2) {\n    reason = \"User has withdrawal issues\";\n    category = \"payment\";\n  }\n  \n  // Determine if we should hand off\n  const shouldHandoff = frustrationLevel >= 5 || !!reason;\n  \n  return { shouldHandoff, reason, category, frustrationLevel };\n}\n\nexport async function getChatbotResponseWithHandoff(\n  messages: ChatMessage[],\n  userContext?: UserContext\n): Promise<ChatbotResponse> {\n  // Check for handoff need first\n  const handoffCheck = detectHandoffNeed(messages);\n  \n  // Get the regular chatbot response\n  const message = await getChatbotResponse(messages, userContext);\n  \n  // If handoff is needed, append the handoff offer\n  if (handoffCheck.shouldHandoff) {\n    const handoffMessage = handoffCheck.reason \n      ? `\\n\\n---\\nI notice you might need more specialized help. ${handoffCheck.reason}. Would you like me to create a support ticket for you? A human agent will review your case within 1-4 hours.`\n      : `\\n\\n---\\nI sense you might need help from our support team. Would you like to speak with a human agent? I can create a ticket for you right now.`;\n    \n    return {\n      message: message + handoffMessage,\n      shouldHandoff: true,\n      handoffReason: handoffCheck.reason,\n      suggestedCategory: handoffCheck.category,\n      frustrationLevel: handoffCheck.frustrationLevel,\n    };\n  }\n  \n  return {\n    message,\n    shouldHandoff: false,\n    frustrationLevel: handoffCheck.frustrationLevel,\n  };\n}\n\nexport const QUICK_RESPONSES = {\n  escrow: \"Escrow na like middleman wey hold your money safe. When you pay, money go escrow FIRST, not seller. Seller see payment notification but no fit touch am. When you collect item and confirm, THEN money release to seller. If anything go wrong, money still safe for escrow. Na the SAFEST way to buy!\",\n  \n  sell: \"To sell: 1) Tap + button or go to My Ads 2) Pick category 3) Add clear photos 4) Write good title 5) Describe item well 6) Set price 7) Add location 8) Post! First listing get free boost. Buyers go start messaging you!\",\n  \n  scam: \"If you suspect scam: 1) STOP any outside payment 2) Screenshot everything 3) Go to Support page 4) Submit Scam Report ticket 5) Include all evidence. We investigate within 1-4 hours. ALWAYS use escrow - we no fit help if you pay outside app!\",\n  \n  wallet: \"Wallet help: DEPOSIT - Go Wallet tab, tap Add Money, choose method, pay. WITHDRAW - Tap Withdraw, enter amount, add bank, confirm PIN. Check transaction history anytime. Escrow money releases when you confirm receipt of items.\",\n  \n  games: \"Games available: LUDO (4-player board game), WORD BATTLE (make words from letters), TRIVIA (answer quiz questions). Play for fun free or stake money to win. Must be verified student for stakes. Winnings go straight to wallet!\",\n};\n","path":null,"size_bytes":24774,"size_tokens":null},"client/src/components/ProductCard.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { MapPin, Eye, ShoppingCart, Loader2, User, Heart, ImageOff } from \"lucide-react\";\nimport { useCart } from \"@/hooks/use-cart\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Product, Watchlist, UserSettings } from \"@shared/schema\";\nimport { useState } from \"react\";\nimport { SellerLocationBadge, DistanceBadge } from \"@/components/LocationBadge\";\nimport { getSellerLocationName } from \"@/lib/geolocation\";\nimport { VerificationBadge, getUserBadgeType } from \"@/components/VerificationBadge\";\n\ninterface SellerSettings {\n  latitude: string | null;\n  longitude: string | null;\n  locationVisible: boolean | null;\n}\n\ninterface Seller {\n  firstName?: string;\n  isVerified?: boolean;\n  isSeller?: boolean;\n  isOfficial?: boolean;\n  isAdmin?: boolean;\n  role?: string;\n  id?: string;\n  profileImageUrl?: string;\n}\n\ninterface ProductCardProps {\n  product: Product & { \n    seller?: Seller;\n    sellerSettings?: SellerSettings | null;\n  };\n}\n\nexport function ProductCard({ product }: ProductCardProps) {\n  const { isAuthenticated } = useAuth();\n  const { addToCart } = useCart();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [isAddingToCart, setIsAddingToCart] = useState(false);\n\n  const { data: wishlistItems = [] } = useQuery<Watchlist[]>({\n    queryKey: [\"/api/watchlist\"],\n    enabled: isAuthenticated,\n  });\n\n  const { data: userSettings } = useQuery<UserSettings>({\n    queryKey: [\"/api/settings\"],\n    enabled: isAuthenticated,\n  });\n\n  // Determine if we can show distance and location\n  const canShowDistance = !!(isAuthenticated && \n    (userSettings?.locationVisible ?? false) && \n    (product.sellerSettings?.locationVisible ?? false));\n\n  // Get seller's mapped location name from GPS coordinates\n  const sellerLocationName = product.sellerSettings?.locationVisible && product.sellerSettings?.latitude && product.sellerSettings?.longitude\n    ? getSellerLocationName(product.sellerSettings.latitude, product.sellerSettings.longitude)\n    : null;\n\n  const isInWishlist = wishlistItems.some(item => item.productId === product?.id);\n\n  const addToWishlistMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/watchlist\", { productId: product.id });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/watchlist\"] });\n      toast({\n        title: \"Added to Wishlist\",\n        description: `${product.title} has been added to your wishlist`,\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to add to wishlist\",\n      });\n    },\n  });\n\n  const removeFromWishlistMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"DELETE\", `/api/watchlist/${product.id}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/watchlist\"] });\n      toast({\n        title: \"Removed from Wishlist\",\n        description: `${product.title} has been removed from your wishlist`,\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to remove from wishlist\",\n      });\n    },\n  });\n\n  if (!product) return null;\n\n  const handleSellerClick = (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    const sellerId = product.sellerId || product.seller?.id;\n    if (sellerId) {\n      setLocation(`/profile/${sellerId}`);\n    }\n  };\n\n  const handleWishlistToggle = async (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n\n    if (!isAuthenticated) {\n      toast({\n        variant: \"destructive\",\n        title: \"Login Required\",\n        description: \"Please log in to add items to your wishlist\",\n      });\n      return;\n    }\n\n    if (isInWishlist) {\n      removeFromWishlistMutation.mutate();\n    } else {\n      addToWishlistMutation.mutate();\n    }\n  };\n  \n  const images = product.images || [];\n  const imageUrl = images[0] || \"/placeholder-product.png\";\n  const priceValue = product.price;\n  const price = typeof priceValue === 'number' ? priceValue : parseFloat(priceValue as string) || 0;\n  const originalPriceValue = product.originalPrice;\n  const originalPrice = originalPriceValue ? (typeof originalPriceValue === 'number' ? originalPriceValue : parseFloat(originalPriceValue as string) || 0) : null;\n  const isOnSale = product.isOnSale && originalPrice && originalPrice > price;\n  const discountPercent = isOnSale ? Math.round(((originalPrice - price) / originalPrice) * 100) : 0;\n\n  const handleAddToCart = async (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n\n    if (!isAuthenticated) {\n      toast({\n        variant: \"destructive\",\n        title: \"Login Required\",\n        description: \"Please log in to add items to your cart\",\n      });\n      return;\n    }\n\n    setIsAddingToCart(true);\n    try {\n      await addToCart({ productId: product.id });\n      toast({\n        title: \"Added to Cart\",\n        description: `${product.title} has been added to your cart`,\n      });\n    } catch (error) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Failed to add item to cart\",\n      });\n    } finally {\n      setIsAddingToCart(false);\n    }\n  };\n\n  const isWishlistLoading = addToWishlistMutation.isPending || removeFromWishlistMutation.isPending;\n  const [imageLoaded, setImageLoaded] = useState(false);\n  const [imageError, setImageError] = useState(false);\n\n  return (\n    <Link href={`/products/${product.id}`}>\n      <Card className=\"group overflow-hidden hover-elevate active-elevate-2 cursor-pointer h-full\">\n        <div className=\"aspect-square relative overflow-hidden bg-muted\">\n          {!imageLoaded && !imageError && (\n            <Skeleton className=\"absolute inset-0 w-full h-full\" />\n          )}\n          {imageError ? (\n            <div className=\"absolute inset-0 flex items-center justify-center bg-muted\">\n              <ImageOff className=\"h-8 w-8 text-muted-foreground\" />\n            </div>\n          ) : (\n            <img\n              src={imageUrl}\n              alt={product.title}\n              className={`h-full w-full object-cover transition-all duration-300 group-hover:scale-105 ${\n                imageLoaded ? 'opacity-100' : 'opacity-0'\n              }`}\n              loading=\"lazy\"\n              onLoad={() => setImageLoaded(true)}\n              onError={() => setImageError(true)}\n              data-testid={`img-product-${product.id}`}\n            />\n          )}\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={handleWishlistToggle}\n            disabled={isWishlistLoading}\n            className=\"absolute top-2 right-2 bg-background/80 backdrop-blur-sm z-10\"\n            data-testid={`button-wishlist-toggle-${product.id}`}\n          >\n            {isWishlistLoading ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : (\n              <Heart \n                className={`h-4 w-4 transition-colors ${\n                  isInWishlist \n                    ? \"fill-red-500 text-red-500\" \n                    : \"text-muted-foreground\"\n                }`} \n              />\n            )}\n          </Button>\n          {isOnSale && (\n            <Badge className=\"absolute top-2 left-2 bg-red-500 text-white z-10\" data-testid={`badge-sale-${product.id}`}>\n              SALE -{discountPercent}%\n            </Badge>\n          )}\n          {product.isBoosted && !isOnSale && (\n            <Badge className=\"absolute top-2 left-2 bg-yellow-500 text-white z-10\">\n              Featured\n            </Badge>\n          )}\n          {product.condition && !product.isBoosted && !isOnSale && (\n            <Badge variant=\"secondary\" className=\"absolute top-2 left-2 z-10\">\n              {product.condition}\n            </Badge>\n          )}\n        </div>\n        <CardContent className=\"p-3\">\n          <h3 className=\"font-semibold line-clamp-2 text-sm mb-1.5\" data-testid={`text-product-title-${product.id}`}>\n            {product.title}\n          </h3>\n          <div className=\"flex items-center justify-between gap-2 mb-1.5\">\n            <div className=\"flex flex-col\">\n              <p className={`text-lg font-bold ${isOnSale ? \"text-red-500 dark:text-red-400\" : \"text-foreground\"}`} data-testid={`text-product-price-${product.id}`}>\n                ₦{price.toLocaleString()}\n              </p>\n              {isOnSale && originalPrice && (\n                <p className=\"text-xs text-muted-foreground line-through\" data-testid={`text-product-original-price-${product.id}`}>\n                  ₦{originalPrice.toLocaleString()}\n                </p>\n              )}\n            </div>\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              onClick={handleAddToCart}\n              disabled={isAddingToCart || !product.isAvailable}\n              data-testid={`button-add-to-cart-${product.id}`}\n            >\n              {isAddingToCart ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <ShoppingCart className=\"h-4 w-4\" />\n              )}\n            </Button>\n          </div>\n          <div className=\"flex flex-wrap items-center gap-1.5 text-xs text-muted-foreground mb-1.5\">\n            {/* Show GPS-based location badge if available */}\n            {product.sellerSettings?.locationVisible && product.sellerSettings?.latitude && product.sellerSettings?.longitude ? (\n              <SellerLocationBadge\n                sellerLat={product.sellerSettings.latitude}\n                sellerLng={product.sellerSettings.longitude}\n                userLat={canShowDistance ? userSettings?.latitude : undefined}\n                userLng={canShowDistance ? userSettings?.longitude : undefined}\n                showDistance={canShowDistance}\n              />\n            ) : (\n              /* Fallback to text-based location */\n              product.location && (\n                <div className=\"flex items-center gap-0.5\">\n                  <MapPin className=\"h-3 w-3\" />\n                  <span className=\"truncate max-w-[80px]\">{product.location}</span>\n                </div>\n              )\n            )}\n            {/* Show distance badge separately if we have GPS but no seller location */}\n            {canShowDistance && !product.sellerSettings?.latitude && userSettings?.latitude && (\n              <DistanceBadge\n                userLat={userSettings.latitude}\n                userLng={userSettings.longitude}\n                sellerLat={null}\n                sellerLng={null}\n              />\n            )}\n          </div>\n          <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n            <div className=\"flex items-center gap-1\">\n              <Eye className=\"h-3 w-3\" />\n              <span>{product.views || 0} views</span>\n            </div>\n            {(product.sellerId || product.seller?.id) && (\n              <button\n                onClick={handleSellerClick}\n                className=\"flex items-center gap-1 hover-elevate active-elevate-2 rounded px-1.5 py-0.5 transition-all\"\n                data-testid={`link-seller-profile-${product.id}`}\n              >\n                <User className=\"h-3 w-3\" />\n                <span className=\"text-xs\">\n                  {product.seller?.firstName || \"Seller\"}\n                </span>\n                {(() => {\n                  const badgeType = product.seller ? getUserBadgeType({\n                    isVerified: product.seller.isVerified,\n                    isSeller: product.seller.isSeller,\n                    isOfficial: product.seller.isOfficial,\n                    isAdmin: product.seller.isAdmin,\n                    role: product.seller.role,\n                  }) : null;\n                  return badgeType ? (\n                    <VerificationBadge type={badgeType} size=\"sm\" />\n                  ) : null;\n                })()}\n              </button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </Link>\n  );\n}\n","path":null,"size_bytes":12613,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"server/storage.ts":{"content":"// Database storage implementation\nimport crypto from \"crypto\";\nimport {\n  users,\n  products,\n  productViews,\n  categories,\n  messages,\n  reviews,\n  reports,\n  watchlist,\n  wallets,\n  transactions,\n  referrals,\n  welcomeBonuses,\n  savedSearches,\n  draftProducts,\n  scheduledPosts,\n  voicePosts,\n  boostRequests,\n  disputes,\n  supportTickets,\n  ticketReplies,\n  loginStreaks,\n  sellerAnalytics,\n  follows,\n  hostels,\n  events,\n  escrowTransactions,\n  withdrawals,\n  cartItems,\n  games,\n  gameMatches,\n  gameScores,\n  triviaQuestions,\n  typingTexts,\n  priceGuessProducts,\n  passwordResetTokens,\n  announcements,\n  announcementReads,\n  socialPosts,\n  socialPostLikes,\n  socialPostComments,\n  socialPostReposts,\n  socialPostReports,\n  blockedUsers,\n  postBookmarks,\n  feedEngagementScores,\n  socialPostViews,\n  squadPayments,\n  squadTransfers,\n  negotiations,\n  orders,\n  orderStatusHistory,\n  userBlocks,\n  userMutes,\n  userReports,\n  vtuPlans,\n  vtuTransactions,\n  vtuBeneficiaries,\n  userSettings,\n  sponsoredAds,\n  platformSettings,\n  kycVerifications,\n  kycVerificationLogs,\n  scheduledVtuPurchases,\n  giftData,\n  billPayments,\n  stories,\n  storyViews,\n  storyReactions,\n  storyReplies,\n  messageReactions,\n  archivedConversations,\n  disappearingMessageSettings,\n  messageReadReceipts,\n  type User,\n  type UpsertUser,\n  type Product,\n  type ProductView,\n  type InsertProduct,\n  type UpdateProduct,\n  type Category,\n  type InsertCategory,\n  type Message,\n  type InsertMessage,\n  type Review,\n  type InsertReport,\n  type Watchlist,\n  type Wallet,\n  type InsertWallet,\n  type Transaction,\n  type InsertTransaction,\n  type Referral,\n  type WelcomeBonus,\n  type SavedSearch,\n  type InsertSavedSearch,\n  type DraftProduct,\n  type InsertDraftProduct,\n  type ScheduledPost,\n  type InsertScheduledPost,\n  type VoicePost,\n  type BoostRequest,\n  type InsertBoostRequest,\n  type Dispute,\n  type InsertDispute,\n  type SupportTicket,\n  type InsertSupportTicket,\n  type TicketReply,\n  type InsertTicketReply,\n  type LoginStreak,\n  type SellerAnalytics,\n  type Hostel,\n  type InsertHostel,\n  type Event,\n  type InsertEvent,\n  type EscrowTransaction,\n  type InsertEscrowTransaction,\n  type Withdrawal,\n  type InsertWithdrawal,\n  type Follow,\n  type InsertFollow,\n  type CartItem,\n  type Game,\n  type InsertGame,\n  type GameMatch,\n  type InsertGameMatch,\n  type GameScore,\n  type TriviaQuestion,\n  type TypingText,\n  type PriceGuessProduct,\n  type PasswordResetToken,\n  type Announcement,\n  type CreateAnnouncementInput,\n  type UpdateAnnouncementInput,\n  type AnnouncementRead,\n  type SocialPost,\n  type InsertSocialPost,\n  type SocialPostLike,\n  type SocialPostComment,\n  type InsertSocialPostComment,\n  type SocialPostRepost,\n  type SocialPostReport,\n  type BlockedUser,\n  type InsertBlockedUser,\n  type PostBookmark,\n  type InsertPostBookmark,\n  type FeedEngagementScore,\n  type SocialPostView,\n  type SquadPayment,\n  type InsertSquadPayment,\n  type SquadTransfer,\n  type InsertSquadTransfer,\n  type Negotiation,\n  type InsertNegotiation,\n  type Order,\n  type InsertOrder,\n  type OrderStatusHistory,\n  type InsertOrderStatusHistory,\n  type UserBlock,\n  type InsertUserBlock,\n  type UserMute,\n  type InsertUserMute,\n  type UserReport,\n  type InsertUserReport,\n  type VtuPlan,\n  type InsertVtuPlan,\n  type VtuTransaction,\n  type InsertVtuTransaction,\n  type VtuBeneficiary,\n  type InsertVtuBeneficiary,\n  type UserSettings,\n  type InsertUserSettings,\n  type SponsoredAd,\n  type InsertSponsoredAd,\n  type PlatformSetting,\n  type KycVerification,\n  type InsertKycVerification,\n  type KycVerificationLog,\n  type ScheduledVtuPurchase,\n  type InsertScheduledVtuPurchase,\n  type GiftData,\n  type InsertGiftData,\n  type BillPayment,\n  type InsertBillPayment,\n  type Story,\n  type InsertStory,\n  type StoryView,\n  type StoryReaction,\n  type StoryReply,\n  type MessageReaction,\n  type ArchivedConversation,\n  type DisappearingMessageSetting,\n  type MessageReadReceipt,\n  gameRooms,\n  gameRoomPlayers,\n  gameChatMessages,\n  type GameRoom,\n  type GameRoomPlayer,\n  type GameChatMessage,\n  confessions,\n  confessionVotes,\n  confessionComments,\n  confessionReports,\n  confessionViews,\n  type Confession,\n  type InsertConfession,\n  type ConfessionVote,\n  type ConfessionComment,\n  type ConfessionView,\n  communities,\n  communityMembers,\n  communityPosts,\n  communityPostComments,\n  communityPostLikes,\n  type Community,\n  type CommunityMember,\n  type CommunityPost,\n  type CommunityPostComment,\n  type CommunityPostLike,\n  secretMessageLinks,\n  secretMessages,\n  type SecretMessageLink,\n  type SecretMessage,\n  emailVerificationTokens,\n  type EmailVerificationToken,\n  studyMaterials,\n  studyMaterialPurchases,\n  studyMaterialRatings,\n  type StudyMaterial,\n  type InsertStudyMaterial,\n  type StudyMaterialPurchase,\n  type StudyMaterialRating,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, or, like, desc, sql, gt, gte } from \"drizzle-orm\";\n\nfunction generateReferralCode(): string {\n  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';\n  let code = '';\n  for (let i = 0; i < 8; i++) {\n    code += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return code;\n}\n\nexport interface IStorage {\n  // User operations (authentication & profiles)\n  getUser(id: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  getUserByReferralCode(referralCode: string): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n  createUser(user: { email: string; password: string; firstName: string; lastName: string; username?: string; phoneNumber?: string; role?: \"buyer\" | \"seller\" | \"both\" | \"admin\" }): Promise<User>;\n  updateUserProfile(id: string, data: Partial<User>): Promise<User>;\n  getAllUsers(): Promise<User[]>;\n  verifyUser(id: string): Promise<User>;\n  banUser(id: string, reason: string): Promise<User>;\n  \n  // Product operations\n  createProduct(product: InsertProduct & { sellerId: string }): Promise<Product>;\n  getProduct(id: string): Promise<(Product & { seller: User }) | undefined>;\n  getProducts(filters?: { search?: string; categoryId?: string; condition?: string; location?: string; sellerId?: string }): Promise<(Product & { seller: User })[]>;\n  getSellerProducts(sellerId: string): Promise<Product[]>;\n  getSellerProductsWithAnalytics(sellerId: string): Promise<(Product & { inquiryCount: number })[]>;\n  updateProduct(id: string, data: UpdateProduct): Promise<Product>;\n  deleteProduct(id: string): Promise<void>;\n  incrementProductViews(id: string): Promise<void>;\n  incrementProductInquiries(productId: string): Promise<void>;\n  flagProduct(id: string, reason: string): Promise<Product>;\n  approveProduct(id: string): Promise<Product>;\n  \n  // Unique product view tracking\n  hasViewedProduct(productId: string, viewerId: string): Promise<boolean>;\n  recordProductView(productId: string, viewerId: string): Promise<void>;\n  recordUniqueProductView(productId: string, viewerId: string): Promise<boolean>;\n  \n  // Category operations\n  getCategories(): Promise<Category[]>;\n  createCategory(category: InsertCategory): Promise<Category>;\n  \n  // Message operations\n  getMessageThread(userId1: string, userId2: string): Promise<Message[]>;\n  getMessageThreads(userId: string): Promise<any[]>;\n  createMessage(message: InsertMessage): Promise<Message>;\n  markMessagesAsRead(userId: string, fromUserId: string): Promise<void>;\n  \n  // Enhanced messaging operations\n  addMessageReaction(messageId: string, userId: string, reaction: string): Promise<MessageReaction>;\n  removeMessageReaction(messageId: string, userId: string): Promise<void>;\n  getMessageReactions(messageId: string): Promise<(MessageReaction & { user: User })[]>;\n  archiveConversation(userId: string, otherUserId: string): Promise<ArchivedConversation>;\n  unarchiveConversation(userId: string, otherUserId: string): Promise<void>;\n  getArchivedConversations(userId: string): Promise<(ArchivedConversation & { otherUser: User })[]>;\n  isConversationArchived(userId: string, otherUserId: string): Promise<boolean>;\n  setDisappearingMessages(userId: string, otherUserId: string, duration: number): Promise<DisappearingMessageSetting>;\n  getDisappearingMessageSettings(userId: string, otherUserId: string): Promise<DisappearingMessageSetting | undefined>;\n  createReadReceipt(messageId: string, readerId: string): Promise<MessageReadReceipt>;\n  getReadReceipts(messageId: string): Promise<(MessageReadReceipt & { reader: User })[]>;\n  \n  // Review operations\n  getUserReviews(userId: string): Promise<Review[]>;\n  createReview(review: any): Promise<Review>;\n  \n  // Watchlist operations\n  addToWatchlist(userId: string, productId: string): Promise<Watchlist>;\n  getUserWatchlist(userId: string): Promise<Watchlist[]>;\n  getWishlistWithProducts(userId: string): Promise<(Watchlist & { product: Product & { seller: User } })[]>;\n  removeFromWatchlist(userId: string, productId: string): Promise<void>;\n  \n  // Report operations\n  createReport(report: InsertReport): Promise<any>;\n  \n  // Wallet operations\n  getOrCreateWallet(userId: string): Promise<Wallet>;\n  getWallet(userId: string): Promise<Wallet | undefined>;\n  updateWalletBalance(userId: string, amount: string, type: 'add' | 'subtract'): Promise<Wallet>;\n  \n  // Transaction operations\n  createTransaction(transaction: InsertTransaction): Promise<Transaction>;\n  getUserTransactions(walletId: string): Promise<Transaction[]>;\n  \n  // Welcome bonus operations\n  createWelcomeBonus(userId: string, amount: string): Promise<WelcomeBonus>;\n  getWelcomeBonus(userId: string): Promise<WelcomeBonus | undefined>;\n  \n  // Referral operations\n  createReferral(referrerId: string, referredUserId: string): Promise<Referral>;\n  getUserReferrals(userId: string): Promise<(Referral & { referredUser?: { firstName: string | null; lastName: string | null; email: string; profileImageUrl: string | null } })[]>;\n  markReferralPaid(referralId: string): Promise<Referral>;\n  \n  // Saved search operations\n  createSavedSearch(search: InsertSavedSearch): Promise<SavedSearch>;\n  getUserSavedSearches(userId: string): Promise<SavedSearch[]>;\n  deleteSavedSearch(id: string): Promise<void>;\n  \n  // Draft product operations\n  saveDraft(sellerId: string, data: any): Promise<DraftProduct>;\n  getUserDrafts(sellerId: string): Promise<DraftProduct[]>;\n  deleteDraft(id: string): Promise<void>;\n  \n  // Scheduled post operations\n  createScheduledPost(post: InsertScheduledPost): Promise<ScheduledPost>;\n  getUserScheduledPosts(sellerId: string): Promise<ScheduledPost[]>;\n  getPendingScheduledPosts(): Promise<ScheduledPost[]>;\n  markScheduledPostPublished(id: string, productId: string): Promise<ScheduledPost>;\n  \n  // Voice post operations\n  createVoicePost(post: any): Promise<VoicePost>;\n  getUserVoicePosts(userId: string): Promise<VoicePost[]>;\n  \n  // Boost request operations\n  createBoostRequest(request: InsertBoostRequest): Promise<BoostRequest>;\n  getUserBoostRequests(sellerId: string): Promise<BoostRequest[]>;\n  getActiveBoosts(): Promise<BoostRequest[]>;\n  expireBoost(id: string): Promise<BoostRequest>;\n  \n  // Dispute operations\n  createDispute(dispute: InsertDispute): Promise<Dispute>;\n  getUserDisputes(userId: string): Promise<Dispute[]>;\n  getAllDisputes(): Promise<Dispute[]>;\n  resolveDispute(id: string, resolution: string, resolvedBy: string): Promise<Dispute>;\n  \n  // Support ticket operations\n  createSupportTicket(ticket: InsertSupportTicket): Promise<SupportTicket>;\n  getUserSupportTickets(userId: string): Promise<SupportTicket[]>;\n  getAllSupportTickets(): Promise<SupportTicket[]>;\n  updateSupportTicket(id: string, data: Partial<SupportTicket>): Promise<SupportTicket>;\n  \n  // Login streak operations\n  getOrCreateLoginStreak(userId: string): Promise<LoginStreak>;\n  updateLoginStreak(userId: string, ipAddress?: string): Promise<{ streak: LoginStreak; reward: number; securityWarning?: string }>;\n  \n  // Seller analytics operations\n  getOrCreateSellerAnalytics(sellerId: string): Promise<SellerAnalytics>;\n  updateSellerAnalytics(sellerId: string, data: Partial<SellerAnalytics>): Promise<SellerAnalytics>;\n  \n  // Follow operations\n  followUser(followerId: string, followingId: string): Promise<Follow>;\n  unfollowUser(followerId: string, followingId: string): Promise<void>;\n  getFollowers(userId: string): Promise<(Follow & { follower: User })[]>;\n  getFollowing(userId: string): Promise<(Follow & { following: User })[]>;\n  getFollowerCount(userId: string): Promise<number>;\n  getFollowingCount(userId: string): Promise<number>;\n  isFollowing(followerId: string, followingId: string): Promise<boolean>;\n  \n  // Hostel operations\n  createHostel(hostel: InsertHostel & { agentId: string }): Promise<Hostel>;\n  getHostel(id: string): Promise<(Hostel & { agent: User }) | undefined>;\n  getHostels(filters?: { location?: string; minPrice?: number; maxPrice?: number; minBedrooms?: number; bedrooms?: number }): Promise<Hostel[]>;\n  getUserHostels(agentId: string): Promise<Hostel[]>;\n  updateHostel(id: string, data: Partial<Hostel>): Promise<Hostel>;\n  deleteHostel(id: string): Promise<void>;\n  incrementHostelViews(id: string): Promise<void>;\n  \n  // Event operations\n  createEvent(event: InsertEvent & { organizerId: string }): Promise<Event>;\n  getEvent(id: string): Promise<(Event & { organizer: User }) | undefined>;\n  getEvents(filters?: { eventType?: string; upcoming?: boolean }): Promise<Event[]>;\n  getUserEvents(organizerId: string): Promise<Event[]>;\n  updateEvent(id: string, data: Partial<Event>): Promise<Event>;\n  deleteEvent(id: string): Promise<void>;\n  incrementEventViews(id: string): Promise<void>;\n  purchaseTicket(eventId: string, userId: string): Promise<Event>;\n  \n  // Escrow operations\n  createEscrowTransaction(transaction: InsertEscrowTransaction & { buyerId: string; sellerId: string }): Promise<EscrowTransaction>;\n  getEscrowTransaction(id: string): Promise<EscrowTransaction | undefined>;\n  getEscrowTransactionWithDetails(id: string): Promise<(EscrowTransaction & { product?: Product; buyer: User; seller: User }) | undefined>;\n  getUserEscrowTransactions(userId: string): Promise<EscrowTransaction[]>;\n  getUserPurchases(buyerId: string): Promise<(EscrowTransaction & { product?: Product; seller: User })[]>;\n  getUserSales(sellerId: string): Promise<(EscrowTransaction & { product?: Product; buyer: User })[]>;\n  confirmEscrowByBuyer(id: string): Promise<EscrowTransaction>;\n  confirmEscrowBySeller(id: string): Promise<EscrowTransaction>;\n  releaseEscrowFunds(id: string): Promise<EscrowTransaction>;\n  refundEscrow(id: string): Promise<EscrowTransaction>;\n  addToEscrowBalance(sellerId: string, amount: string): Promise<Wallet>;\n  getSellerCompletedSalesCount(sellerId: string): Promise<number>;\n  lockSecurityDeposit(userId: string, amount: string): Promise<Wallet>;\n  \n  // Withdrawal operations\n  createWithdrawal(withdrawal: InsertWithdrawal & { userId: string }): Promise<Withdrawal>;\n  getUserWithdrawals(userId: string): Promise<Withdrawal[]>;\n  updateWithdrawal(id: string, data: Partial<Withdrawal>): Promise<Withdrawal>;\n  \n  // NIN verification operations\n  updateNINVerification(userId: string, ninHash: string, vnin: string): Promise<User>;\n  \n  // Social media update operations\n  updateSocialMedia(userId: string, data: { instagramHandle?: string; tiktokHandle?: string; facebookProfile?: string }): Promise<User>;\n  \n  // Trust badge operations\n  awardTrustBadge(userId: string): Promise<User>;\n  revokeTrustBadge(userId: string): Promise<User>;\n  \n  // Referral update operations\n  markReferralPurchase(referredUserId: string, purchaseId: string): Promise<void>;\n  \n  // Leaderboard operations\n  getTopSellers(limit?: number): Promise<any[]>;\n  getMostTrustedUsers(limit?: number): Promise<any[]>;\n  \n  // Notification operations\n  getUserNotifications(userId: string): Promise<any[]>;\n  markNotificationAsRead(id: string, userId: string): Promise<void>;\n  markAllNotificationsAsRead(userId: string): Promise<void>;\n  deleteNotification(id: string, userId: string): Promise<void>;\n  createNotification(data: { userId: string; type: string; title: string; message: string; link?: string; relatedUserId?: string; relatedProductId?: string }): Promise<any>;\n  \n  // Raw SQL execution for admin metrics\n  executeRawSQL<T = any>(query: string, params?: any[]): Promise<T[]>;\n  \n  // Cart operations\n  getCartItems(userId: string): Promise<(CartItem & { product: Product })[]>;\n  addToCart(userId: string, productId: string, quantity?: number): Promise<CartItem>;\n  updateCartItemQuantity(cartItemId: string, quantity: number): Promise<CartItem>;\n  removeFromCart(cartItemId: string): Promise<void>;\n  clearCart(userId: string): Promise<void>;\n  \n  // Game operations\n  createGame(game: { gameType: string; player1Id: string; stakeAmount: string; mode?: string }): Promise<Game>;\n  getGame(id: string): Promise<(Game & { player1: User; player2: User | null }) | undefined>;\n  getAvailableGames(gameType?: string): Promise<(Game & { player1: User })[]>;\n  getUserGames(userId: string): Promise<Game[]>;\n  joinGame(gameId: string, player2Id: string): Promise<Game>;\n  startGame(gameId: string): Promise<Game>;\n  completeGame(gameId: string, winnerId: string): Promise<Game>;\n  cancelGame(gameId: string): Promise<Game>;\n  createGameMatch(match: InsertGameMatch): Promise<GameMatch>;\n  getGameMatches(gameId: string): Promise<GameMatch[]>;\n  \n  // Game score/leaderboard operations\n  getOrCreateGameScore(userId: string, gameType: string): Promise<GameScore>;\n  updateGameScore(userId: string, gameType: string, won: boolean, score: number, earnings?: string): Promise<GameScore>;\n  getLeaderboard(gameType: string, limit?: number): Promise<(GameScore & { user: User })[]>;\n  getGlobalLeaderboard(limit?: number): Promise<any[]>;\n  \n  // Game content operations\n  getTriviaQuestions(limit?: number, category?: string): Promise<TriviaQuestion[]>;\n  getRandomTriviaQuestion(): Promise<TriviaQuestion | undefined>;\n  getTypingTexts(limit?: number): Promise<TypingText[]>;\n  getRandomTypingText(): Promise<TypingText | undefined>;\n  getPriceGuessProducts(limit?: number): Promise<PriceGuessProduct[]>;\n  getRandomPriceGuessProduct(): Promise<PriceGuessProduct | undefined>;\n  seedGameContent(): Promise<void>;\n  \n  // Password reset token operations\n  createPasswordResetToken(userId: string, token: string, expiresAt: Date): Promise<PasswordResetToken>;\n  getPasswordResetToken(token: string): Promise<PasswordResetToken | undefined>;\n  markPasswordResetTokenUsed(token: string): Promise<void>;\n  deleteExpiredPasswordResetTokens(): Promise<void>;\n  updateUserPassword(userId: string, hashedPassword: string): Promise<User>;\n  \n  // Announcement operations\n  createAnnouncement(data: CreateAnnouncementInput & { authorId: string }): Promise<Announcement>;\n  getAnnouncement(id: string): Promise<(Announcement & { author: User }) | undefined>;\n  getAnnouncements(includeUnpublished?: boolean): Promise<(Announcement & { author: User })[]>;\n  updateAnnouncement(id: string, data: UpdateAnnouncementInput): Promise<Announcement>;\n  deleteAnnouncement(id: string): Promise<void>;\n  incrementAnnouncementViews(id: string): Promise<void>;\n  markAnnouncementAsRead(userId: string, announcementId: string): Promise<AnnouncementRead>;\n  getUserAnnouncementReads(userId: string): Promise<AnnouncementRead[]>;\n  isAnnouncementRead(userId: string, announcementId: string): Promise<boolean>;\n  \n  // Social post operations (\"The Plug\")\n  getSocialPosts(options?: { authorId?: string; followingOnly?: boolean; userId?: string }): Promise<(SocialPost & { author: User; isLiked?: boolean; isFollowingAuthor?: boolean; isReposted?: boolean })[]>;\n  getSocialPostById(postId: string): Promise<SocialPost | undefined>;\n  createSocialPost(post: { authorId: string; content: string; images?: string[]; videos?: string[] }): Promise<SocialPost>;\n  getSocialPost(id: string): Promise<(SocialPost & { author: User }) | undefined>;\n  likeSocialPost(postId: string, userId: string): Promise<SocialPostLike>;\n  unlikeSocialPost(postId: string, userId: string): Promise<void>;\n  isPostLiked(postId: string, userId: string): Promise<boolean>;\n  getPostComments(postId: string): Promise<(SocialPostComment & { author: User })[]>;\n  createPostComment(comment: { postId: string; authorId: string; content: string }): Promise<SocialPostComment>;\n  deleteSocialPost(postId: string): Promise<void>;\n  repostSocialPost(postId: string, userId: string, quoteContent?: string): Promise<SocialPostRepost>;\n  unrepostSocialPost(postId: string, userId: string): Promise<void>;\n  isPostReposted(postId: string, userId: string): Promise<boolean>;\n  getPostReposts(postId: string): Promise<(SocialPostRepost & { reposter: User })[]>;\n  \n  // Post bookmark operations\n  bookmarkPost(userId: string, postId: string): Promise<PostBookmark>;\n  unbookmarkPost(userId: string, postId: string): Promise<void>;\n  isPostBookmarked(userId: string, postId: string): Promise<boolean>;\n  getUserBookmarks(userId: string): Promise<(PostBookmark & { post: SocialPost; author: User })[]>;\n  \n  // Smart feed algorithm operations  \n  getSocialPostsWithAlgorithm(options?: { userId?: string; feedType?: 'for_you' | 'following'; userLat?: number; userLng?: number }): Promise<(SocialPost & { author: User; isLiked?: boolean; isFollowingAuthor?: boolean; isReposted?: boolean; engagementScore?: string; authorDistance?: number | null })[]>;\n  updatePostEngagementScore(postId: string): Promise<void>;\n  incrementPostViews(postId: string): Promise<void>;\n  incrementPostShares(postId: string): Promise<void>;\n  \n  // Unique post view tracking (1 view per user per 24 hours)\n  hasViewedPost(postId: string, viewerId: string): Promise<boolean>;\n  recordUniquePostView(postId: string, viewerId: string): Promise<boolean>;\n  \n  // User location operations\n  updateUserLocation(userId: string, latitude: string, longitude: string): Promise<User>;\n  \n  // Username and system account operations\n  getUserByUsername(username: string): Promise<User | undefined>;\n  updateUsername(userId: string, username: string): Promise<User>;\n  getSystemAccount(type: string): Promise<User | undefined>;\n  createSystemAccount(data: { email: string; username: string; firstName: string; lastName: string; type: string; bio?: string; profileImageUrl?: string }): Promise<User>;\n  \n  // Enhanced social post operations\n  createSocialPostWithOptions(post: { authorId: string; content: string; images?: string[]; videos?: string[]; replyRestriction?: string; mentionedUserIds?: string[]; hashtags?: string[]; isFromSystemAccount?: boolean }): Promise<SocialPost>;\n  updateSocialPost(postId: string, data: Partial<SocialPost>): Promise<SocialPost>;\n  pinSocialPost(postId: string): Promise<void>;\n  unpinSocialPost(postId: string): Promise<void>;\n  getUserPinnedPosts(userId: string): Promise<(SocialPost & { author: User })[]>;\n  \n  // Squad payment operations\n  createSquadPayment(payment: InsertSquadPayment): Promise<SquadPayment>;\n  getSquadPayment(id: string): Promise<SquadPayment | undefined>;\n  getSquadPaymentByReference(transactionReference: string): Promise<SquadPayment | undefined>;\n  updateSquadPaymentStatus(transactionReference: string, status: string, paidAt?: Date): Promise<SquadPayment | undefined>;\n  getUserSquadPayments(userId: string): Promise<SquadPayment[]>;\n  \n  // Squad transfer operations\n  createSquadTransfer(transfer: InsertSquadTransfer): Promise<SquadTransfer>;\n  getSquadTransferByReference(transactionReference: string): Promise<SquadTransfer | undefined>;\n  updateSquadTransferStatus(transactionReference: string, status: string, responseMessage?: string, completedAt?: Date): Promise<SquadTransfer | undefined>;\n  \n  // Negotiation operations\n  createNegotiation(negotiation: InsertNegotiation): Promise<Negotiation>;\n  getNegotiation(id: string): Promise<Negotiation | undefined>;\n  getProductNegotiations(productId: string): Promise<Negotiation[]>;\n  getUserNegotiations(userId: string): Promise<Negotiation[]>;\n  updateNegotiationStatus(id: string, status: string, data?: Partial<Negotiation>): Promise<Negotiation | undefined>;\n  \n  // Order operations\n  createOrder(order: InsertOrder): Promise<Order>;\n  getOrder(id: string): Promise<Order | undefined>;\n  getOrderByNumber(orderNumber: string): Promise<Order | undefined>;\n  getBuyerOrders(buyerId: string): Promise<Order[]>;\n  getSellerOrders(sellerId: string): Promise<Order[]>;\n  updateOrderStatus(orderId: string, status: string, changedBy: string, notes?: string): Promise<Order>;\n  addOrderStatusHistory(history: InsertOrderStatusHistory): Promise<OrderStatusHistory>;\n  getOrderStatusHistory(orderId: string): Promise<OrderStatusHistory[]>;\n  \n  // User relationship operations (block/mute/report)\n  blockUser(blockerId: string, blockedId: string): Promise<UserBlock>;\n  unblockUser(blockerId: string, blockedId: string): Promise<void>;\n  muteUser(muterId: string, mutedId: string): Promise<UserMute>;\n  unmuteUser(muterId: string, mutedId: string): Promise<void>;\n  isUserBlocked(userId: string, targetId: string): Promise<boolean>;\n  isUserMuted(userId: string, targetId: string): Promise<boolean>;\n  getBlockedUsers(userId: string): Promise<(UserBlock & { blockedUser: User })[]>;\n  getMutedUsers(userId: string): Promise<(UserMute & { mutedUser: User })[]>;\n  createUserReport(data: InsertUserReport): Promise<UserReport>;\n  reportUser(reporterId: string, reportedId: string, reason: string, description: string): Promise<UserReport>;\n  getUserRelationship(userId: string, targetId: string): Promise<{ isBlocked: boolean; isMuted: boolean; isBlockedByTarget: boolean }>;\n  \n  // Social post report operations\n  createSocialPostReport(postId: string, reporterId: string, reason: string, description?: string): Promise<SocialPostReport>;\n  getSocialPostReports(postId: string): Promise<SocialPostReport[]>;\n  getPostReportCount(postId: string): Promise<number>;\n  hasUserReportedPost(postId: string, userId: string): Promise<boolean>;\n  hideSocialPost(postId: string): Promise<void>;\n  \n  // VTU (Virtual Top-Up) operations\n  getVtuPlans(network?: string): Promise<VtuPlan[]>;\n  getAllVtuPlans(): Promise<VtuPlan[]>;\n  getVtuPlan(id: string): Promise<VtuPlan | undefined>;\n  getVtuPlanByNetworkAndDataAmount(network: string, dataAmount: string): Promise<VtuPlan | undefined>;\n  createVtuPlan(data: InsertVtuPlan): Promise<VtuPlan>;\n  updateVtuPlan(id: string, data: Partial<VtuPlan>): Promise<VtuPlan>;\n  upsertVtuPlan(plan: InsertVtuPlan): Promise<VtuPlan>;\n  deactivateAllVtuPlans(): Promise<void>;\n  createVtuTransaction(data: InsertVtuTransaction): Promise<VtuTransaction>;\n  updateVtuTransaction(id: string, data: Partial<VtuTransaction>): Promise<VtuTransaction>;\n  getUserVtuTransactions(userId: string, filters?: { status?: string; network?: string; startDate?: Date; endDate?: Date }): Promise<VtuTransaction[]>;\n  \n  // VTU Beneficiaries operations\n  getUserBeneficiaries(userId: string): Promise<VtuBeneficiary[]>;\n  getBeneficiary(id: string): Promise<VtuBeneficiary | undefined>;\n  createBeneficiary(data: InsertVtuBeneficiary): Promise<VtuBeneficiary>;\n  updateBeneficiary(id: string, data: Partial<VtuBeneficiary>): Promise<VtuBeneficiary>;\n  deleteBeneficiary(id: string): Promise<void>;\n  updateBeneficiaryUsage(id: string): Promise<void>;\n  \n  // User Settings operations\n  getOrCreateUserSettings(userId: string): Promise<UserSettings>;\n  updateUserSettings(userId: string, data: Partial<UserSettings>): Promise<UserSettings>;\n  requestAccountDeletion(userId: string): Promise<UserSettings>;\n  cancelAccountDeletion(userId: string): Promise<UserSettings>;\n  \n  // Sponsored Ads operations\n  getActiveSponsoredAds(type?: string): Promise<SponsoredAd[]>;\n  createSponsoredAd(data: InsertSponsoredAd): Promise<SponsoredAd>;\n  recordAdImpression(adId: string): Promise<void>;\n  recordAdClick(adId: string): Promise<void>;\n  \n  // Platform Settings operations\n  getAllPlatformSettings(): Promise<PlatformSetting[]>;\n  getPlatformSetting(key: string): Promise<PlatformSetting | undefined>;\n  updatePlatformSetting(key: string, value: string, updatedBy?: string): Promise<PlatformSetting>;\n  \n  // KYC Verification operations\n  createKycVerification(userId: string): Promise<KycVerification>;\n  getKycVerification(userId: string): Promise<KycVerification | undefined>;\n  getKycVerificationById(id: string): Promise<KycVerification | undefined>;\n  updateKycVerification(id: string, data: Partial<KycVerification>): Promise<KycVerification>;\n  getPendingKycVerifications(): Promise<KycVerification[]>;\n  createKycLog(data: { kycId: string; userId: string; action: string; result?: string; similarityScore?: number | string; reviewedBy?: string; ipAddress?: string; userAgent?: string; metadata?: any }): Promise<void>;\n  \n  // Scheduled VTU Purchases operations\n  getScheduledPurchases(userId: string): Promise<ScheduledVtuPurchase[]>;\n  getScheduledPurchase(id: string): Promise<ScheduledVtuPurchase | undefined>;\n  createScheduledPurchase(data: InsertScheduledVtuPurchase): Promise<ScheduledVtuPurchase>;\n  updateScheduledPurchase(id: string, data: Partial<ScheduledVtuPurchase>): Promise<ScheduledVtuPurchase>;\n  deleteScheduledPurchase(id: string): Promise<void>;\n  \n  // Gift Data operations\n  getGiftsByUser(userId: string): Promise<GiftData[]>;\n  getGiftByCode(code: string): Promise<GiftData | undefined>;\n  createGiftData(data: InsertGiftData): Promise<GiftData>;\n  claimGiftData(giftId: string, claimerId: string): Promise<GiftData>;\n  \n  // Bill Payment operations\n  createBillPayment(data: InsertBillPayment): Promise<BillPayment>;\n  updateBillPayment(id: string, data: Partial<BillPayment>): Promise<BillPayment>;\n  getUserBillPayments(userId: string): Promise<BillPayment[]>;\n  \n  // Story operations\n  createStory(data: { authorId: string; type: \"image\" | \"video\" | \"text\"; mediaUrl?: string; textContent?: string; backgroundColor?: string; fontStyle?: string }): Promise<Story>;\n  getStory(id: string): Promise<(Story & { author: User }) | undefined>;\n  getActiveStories(userId: string): Promise<(Story & { author: User; hasViewed: boolean })[]>;\n  getUserActiveStories(userId: string): Promise<(Story & { author: User })[]>;\n  deleteStory(id: string): Promise<void>;\n  viewStory(storyId: string, viewerId: string): Promise<StoryView>;\n  hasViewedStory(storyId: string, viewerId: string): Promise<boolean>;\n  getStoryViews(storyId: string): Promise<(StoryView & { viewer: User })[]>;\n  reactToStory(storyId: string, reactorId: string, reaction: string): Promise<StoryReaction>;\n  getStoryReactions(storyId: string): Promise<(StoryReaction & { reactor: User })[]>;\n  replyToStory(storyId: string, senderId: string, content: string): Promise<StoryReply>;\n  getStoryReplies(storyId: string): Promise<(StoryReply & { sender: User })[]>;\n  getUsersWithActiveStories(currentUserId: string): Promise<{ user: User; storyCount: number; hasUnviewed: boolean; latestStoryAt: Date }[]>;\n  incrementStoryViews(storyId: string): Promise<void>;\n  incrementStoryLikes(storyId: string): Promise<void>;\n  decrementStoryLikes(storyId: string): Promise<void>;\n  \n  // Confession operations\n  createConfession(data: { authorId?: string; content: string; category?: string; isAnonymous?: boolean }): Promise<Confession>;\n  getConfession(id: string): Promise<(Confession & { author?: { id: string; firstName: string | null; lastName: string | null; profileImageUrl: string | null } | null }) | undefined>;\n  getConfessions(options?: { category?: string; status?: string; page?: number; limit?: number }): Promise<{ confessions: Confession[]; total: number }>;\n  getTrendingConfessions(limit?: number): Promise<Confession[]>;\n  deleteConfession(id: string): Promise<void>;\n  approveConfession(id: string, moderatedBy: string): Promise<Confession>;\n  rejectConfession(id: string, moderatedBy: string): Promise<Confession>;\n  flagConfession(id: string): Promise<Confession>;\n  autoApproveOldConfessions(): Promise<number>;\n  \n  // Unique confession view tracking (1 view per user per 24 hours)\n  hasViewedConfession(confessionId: string, viewerId: string): Promise<boolean>;\n  recordUniqueConfessionView(confessionId: string, viewerId: string): Promise<boolean>;\n  incrementConfessionViews(confessionId: string): Promise<void>;\n  \n  // Confession vote operations\n  voteConfession(confessionId: string, voterId: string, voteType: 'like' | 'dislike'): Promise<ConfessionVote>;\n  removeVote(confessionId: string, voterId: string): Promise<void>;\n  getUserVote(confessionId: string, voterId: string): Promise<ConfessionVote | undefined>;\n  \n  // Confession comment operations\n  getConfessionComments(confessionId: string): Promise<(ConfessionComment & { author?: { id: string; firstName: string | null; lastName: string | null; profileImageUrl: string | null } | null })[]>;\n  createConfessionComment(data: { confessionId: string; authorId?: string; content: string; isAnonymous?: boolean; parentId?: string }): Promise<ConfessionComment>;\n  deleteConfessionComment(id: string): Promise<void>;\n  \n  // Confession report operations\n  createConfessionReport(data: { confessionId: string; reporterId: string; reason: string; description?: string }): Promise<any>;\n  getConfessionReports(confessionId: string): Promise<any[]>;\n\n  // Community operations\n  createCommunity(data: { name: string; slug: string; description?: string; iconUrl?: string; coverUrl?: string; type?: \"public\" | \"private\" | \"invite_only\"; category?: string; rules?: string[]; ownerId: string }): Promise<Community>;\n  getCommunity(id: string): Promise<(Community & { owner: User }) | undefined>;\n  getCommunityBySlug(slug: string): Promise<(Community & { owner: User }) | undefined>;\n  getPublicCommunities(): Promise<(Community & { owner: User })[]>;\n  getUserJoinedCommunities(userId: string): Promise<(Community & { owner: User; membership: CommunityMember })[]>;\n  updateCommunity(id: string, data: Partial<Community>): Promise<Community>;\n  deleteCommunity(id: string): Promise<void>;\n  \n  // Community member operations\n  joinCommunity(communityId: string, userId: string): Promise<CommunityMember>;\n  leaveCommunity(communityId: string, userId: string): Promise<void>;\n  getCommunityMember(communityId: string, userId: string): Promise<CommunityMember | undefined>;\n  getCommunityMembers(communityId: string): Promise<(CommunityMember & { user: User })[]>;\n  updateMemberRole(communityId: string, userId: string, role: \"member\" | \"moderator\" | \"admin\" | \"owner\"): Promise<CommunityMember>;\n  banMember(communityId: string, userId: string, reason: string, until?: Date): Promise<CommunityMember>;\n  \n  // Community post operations\n  createCommunityPost(data: { communityId: string; authorId: string; title?: string; content: string; images?: string[] }): Promise<CommunityPost>;\n  getCommunityPost(id: string): Promise<(CommunityPost & { author: User; community: Community }) | undefined>;\n  getCommunityPosts(communityId: string): Promise<(CommunityPost & { author: User; isLiked?: boolean })[]>;\n  updateCommunityPost(id: string, data: Partial<CommunityPost>): Promise<CommunityPost>;\n  deleteCommunityPost(id: string): Promise<void>;\n  pinCommunityPost(id: string, isPinned: boolean): Promise<CommunityPost>;\n  lockPost(id: string, isLocked: boolean): Promise<CommunityPost>;\n  \n  // Community post like operations\n  likeCommunityPost(postId: string, userId: string): Promise<CommunityPostLike>;\n  unlikeCommunityPost(postId: string, userId: string): Promise<void>;\n  hasLikedCommunityPost(postId: string, userId: string): Promise<boolean>;\n  \n  // Community post comment operations\n  createCommunityPostComment(data: { postId: string; authorId: string; content: string; parentId?: string }): Promise<CommunityPostComment>;\n  getCommunityPostComments(postId: string): Promise<(CommunityPostComment & { author: User })[]>;\n  deleteCommunityPostComment(id: string): Promise<void>;\n\n  // Game Room operations\n  createGameRoom(data: { hostId: string; gameType: string; stakeAmount?: string; maxPlayers?: number; isPrivate?: boolean; password?: string; settings?: any }): Promise<GameRoom>;\n  getGameRoom(id: string): Promise<(GameRoom & { host: User; players: (GameRoomPlayer & { user: User })[] }) | undefined>;\n  getGameRoomByCode(code: string): Promise<(GameRoom & { host: User; players: (GameRoomPlayer & { user: User })[] }) | undefined>;\n  getAvailableGameRooms(gameType?: string): Promise<(GameRoom & { host: User; players: (GameRoomPlayer & { user: User })[] })[]>;\n  getUserGameRooms(userId: string): Promise<GameRoom[]>;\n  updateGameRoom(id: string, data: Partial<GameRoom>): Promise<GameRoom>;\n  deleteGameRoom(id: string): Promise<void>;\n  \n  // Game Room Player operations\n  joinGameRoom(roomId: string, userId: string, password?: string): Promise<GameRoomPlayer>;\n  leaveGameRoom(roomId: string, userId: string): Promise<void>;\n  kickPlayerFromRoom(roomId: string, hostId: string, userId: string): Promise<void>;\n  togglePlayerReady(roomId: string, userId: string): Promise<GameRoomPlayer>;\n  updatePlayerState(roomId: string, userId: string, playerState: any): Promise<GameRoomPlayer>;\n  getGameRoomPlayer(roomId: string, userId: string): Promise<GameRoomPlayer | undefined>;\n  getGameRoomPlayers(roomId: string): Promise<(GameRoomPlayer & { user: User })[]>;\n  \n  // Game Room Chat operations\n  createGameChatMessage(roomId: string, senderId: string, content: string, type?: string): Promise<GameChatMessage>;\n  getGameRoomChatMessages(roomId: string, limit?: number): Promise<(GameChatMessage & { sender: User })[]>;\n  \n  // Game State operations\n  updateGameState(roomId: string, gameState: any): Promise<GameRoom>;\n  startGameRoom(roomId: string): Promise<GameRoom>;\n  endGameRoom(roomId: string, winnerId?: string, results?: any): Promise<GameRoom>;\n\n  // Secret Message Link operations\n  createSecretMessageLink(userId: string, data: { title?: string; backgroundColor?: string }): Promise<SecretMessageLink>;\n  getUserSecretMessageLinks(userId: string): Promise<SecretMessageLink[]>;\n  getSecretMessageLinkByCode(code: string): Promise<SecretMessageLink | undefined>;\n  getSecretMessageLink(id: string): Promise<SecretMessageLink | undefined>;\n  deleteSecretMessageLink(id: string): Promise<void>;\n  toggleSecretMessageLink(id: string, isActive: boolean): Promise<SecretMessageLink>;\n  \n  // Secret Message operations\n  createSecretMessage(linkId: string, content: string): Promise<SecretMessage>;\n  getSecretMessagesForUser(userId: string): Promise<(SecretMessage & { link: SecretMessageLink })[]>;\n  markSecretMessageRead(id: string): Promise<SecretMessage>;\n  deleteSecretMessage(id: string): Promise<void>;\n  getUnreadSecretMessageCount(userId: string): Promise<number>;\n\n  // Email verification operations\n  createEmailVerificationToken(userId: string): Promise<{ token: string; code: string }>;\n  verifyEmailToken(token: string): Promise<boolean>;\n  verifyEmailCode(userId: string, code: string): Promise<boolean>;\n  markUserEmailVerified(userId: string): Promise<void>;\n  isUserEmailVerified(userId: string): Promise<boolean>;\n\n  // Study Materials operations\n  getStudyMaterials(filters?: { level?: string; faculty?: string; courseCode?: string; materialType?: string; search?: string }): Promise<(StudyMaterial & { uploader: User })[]>;\n  getStudyMaterial(id: string): Promise<(StudyMaterial & { uploader: User }) | undefined>;\n  createStudyMaterial(data: Partial<InsertStudyMaterial> & { uploaderId: string; fileUrl: string }): Promise<StudyMaterial>;\n  updateStudyMaterial(id: string, data: Partial<StudyMaterial>): Promise<StudyMaterial>;\n  deleteStudyMaterial(id: string): Promise<void>;\n  purchaseStudyMaterial(materialId: string, buyerId: string, amount: string): Promise<StudyMaterialPurchase>;\n  hasUserPurchasedMaterial(materialId: string, userId: string): Promise<boolean>;\n  getUserStudyMaterials(userId: string): Promise<StudyMaterial[]>;\n  incrementMaterialViews(id: string): Promise<void>;\n  incrementMaterialDownloads(id: string): Promise<void>;\n  rateStudyMaterial(materialId: string, userId: string, rating: number, review?: string): Promise<StudyMaterialRating>;\n  getMaterialRatings(materialId: string): Promise<(StudyMaterialRating & { user: User })[]>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.email, email));\n    return user;\n  }\n\n  async getUserByReferralCode(referralCode: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.referralCode, referralCode.toUpperCase()));\n    return user;\n  }\n\n  private async generateUniqueReferralCode(): Promise<string> {\n    let attempts = 0;\n    const maxAttempts = 10;\n    \n    while (attempts < maxAttempts) {\n      const code = generateReferralCode();\n      const existing = await this.getUserByReferralCode(code);\n      if (!existing) {\n        return code;\n      }\n      attempts++;\n    }\n    \n    throw new Error('Failed to generate unique referral code after max attempts');\n  }\n\n  async createUser(userData: { email: string; password: string; firstName: string; lastName: string; username?: string; phoneNumber?: string; role?: \"buyer\" | \"seller\" | \"both\" | \"admin\" }): Promise<User> {\n    const referralCode = await this.generateUniqueReferralCode();\n    \n    const [user] = await db.insert(users).values({\n      ...userData,\n      referralCode,\n    }).returning();\n    \n    // Create wallet and give welcome bonus for new users\n    const bonusAmount = (Math.random() * 48 + 2).toFixed(2); // Random ₦2-₦50\n    await this.createWelcomeBonus(user.id, bonusAmount);\n    \n    // Create login streak\n    await this.getOrCreateLoginStreak(user.id);\n    \n    // If seller, create analytics\n    if (user.role === 'seller' || user.role === 'admin') {\n      await this.getOrCreateSellerAnalytics(user.id);\n    }\n    \n    // Auto-follow system user and send welcome DM\n    await this.autoFollowSystemUserAndSendWelcomeDM(user.id);\n    \n    return user;\n  }\n  \n  private async autoFollowSystemUserAndSendWelcomeDM(userId: string): Promise<void> {\n    try {\n      const systemUserId = process.env.SYSTEM_WELCOME_USER_ID;\n      if (!systemUserId) {\n        console.log('SYSTEM_WELCOME_USER_ID not configured, skipping auto-follow and welcome DM');\n        return;\n      }\n      \n      // Verify system user exists\n      const systemUser = await this.getUser(systemUserId);\n      if (!systemUser) {\n        console.log(`System user ${systemUserId} not found, skipping auto-follow and welcome DM`);\n        return;\n      }\n      \n      // Auto-follow the system user (new user follows @EKSUMarketplace)\n      try {\n        await this.followUser(userId, systemUserId);\n        console.log(`User ${userId} now follows system user ${systemUserId}`);\n      } catch (error) {\n        console.log(`Could not auto-follow system user: ${error}`);\n      }\n      \n      // Send welcome DM from system user\n      const welcomeMessage = \"Welcome to the family! Check out 'The Plug' for campus gist and verify your account to start selling. Stay safe and only pay through the EKSU Marketplace Wallet!\";\n      \n      await this.createMessage({\n        senderId: systemUserId,\n        receiverId: userId,\n        content: welcomeMessage,\n      });\n      console.log(`Welcome DM sent to user ${userId}`);\n      \n    } catch (error) {\n      console.error('Error in autoFollowSystemUserAndSendWelcomeDM:', error);\n    }\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    // Check if this is a new user\n    const existing = userData.id ? await this.getUser(userData.id) : undefined;\n    const isNewUser = !existing;\n\n    // Generate referral code for new users\n    const referralCode = isNewUser ? await this.generateUniqueReferralCode() : undefined;\n\n    const [user] = await db\n      .insert(users)\n      .values({\n        ...userData,\n        ...(referralCode && { referralCode }),\n      })\n      .onConflictDoUpdate({\n        target: users.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n\n    // For new users, create wallet and give welcome bonus\n    if (isNewUser) {\n      const bonusAmount = (Math.random() * 48 + 2).toFixed(2); // Random ₦2-₦50\n      await this.createWelcomeBonus(user.id, bonusAmount);\n      \n      // Create login streak\n      await this.getOrCreateLoginStreak(user.id);\n      \n      // If seller, create analytics\n      if (user.role === 'seller' || user.role === 'admin') {\n        await this.getOrCreateSellerAnalytics(user.id);\n      }\n      \n      // Auto-follow system user and send welcome DM\n      await this.autoFollowSystemUserAndSendWelcomeDM(user.id);\n    }\n\n    return user;\n  }\n\n  async updateUserProfile(id: string, data: Partial<User>): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n    \n    if (!user) {\n      throw new Error(`User ${id} not found`);\n    }\n    \n    return user;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return await db.select().from(users).orderBy(desc(users.createdAt));\n  }\n\n  async verifyUser(id: string): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ isVerified: true, updatedAt: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n    \n    if (!user) {\n      throw new Error(`User ${id} not found`);\n    }\n    \n    return user;\n  }\n\n  async banUser(id: string, reason: string): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ isBanned: true, banReason: reason, isActive: false, updatedAt: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n    \n    if (!user) {\n      throw new Error(`User ${id} not found`);\n    }\n    \n    return user;\n  }\n\n  // Product operations\n  async createProduct(product: InsertProduct & { sellerId: string }): Promise<Product> {\n    const [created] = await db.insert(products).values(product).returning();\n    return created;\n  }\n\n  async getProduct(id: string): Promise<(Product & { seller: User }) | undefined> {\n    const result = await db\n      .select()\n      .from(products)\n      .leftJoin(users, eq(products.sellerId, users.id))\n      .where(eq(products.id, id));\n    \n    if (result.length === 0 || !result[0].products) return undefined;\n    \n    // If seller doesn't exist (orphaned product), return undefined\n    if (!result[0].users) {\n      console.error(`Product ${id} has invalid seller reference`);\n      return undefined;\n    }\n    \n    return {\n      ...result[0].products,\n      seller: result[0].users,\n    };\n  }\n\n  async getProducts(filters?: { search?: string; categoryId?: string; condition?: string; location?: string; sellerId?: string }): Promise<(Product & { seller: User })[]> {\n    // Build WHERE conditions\n    const conditions = [\n      eq(products.isAvailable, true),\n      eq(products.isApproved, true)\n    ];\n    \n    // Add sellerId filter at the database level if provided\n    if (filters?.sellerId) {\n      conditions.push(eq(products.sellerId, filters.sellerId));\n    }\n    \n    let query = db\n      .select()\n      .from(products)\n      .leftJoin(users, eq(products.sellerId, users.id))\n      .where(and(...conditions))\n      .orderBy(desc(products.createdAt));\n\n    const results = await query;\n    \n    // Filter out products with missing sellers (orphaned records)\n    let filtered = results\n      .filter(r => r.products && r.users)\n      .map(r => ({\n        ...r.products!,\n        seller: r.users!,\n      }));\n\n    // Apply additional filters\n    if (filters?.search) {\n      const searchLower = filters.search.toLowerCase();\n      filtered = filtered.filter(p => \n        p.title.toLowerCase().includes(searchLower) || \n        p.description.toLowerCase().includes(searchLower)\n      );\n    }\n\n    if (filters?.categoryId) {\n      filtered = filtered.filter(p => p.categoryId === filters.categoryId);\n    }\n\n    if (filters?.condition) {\n      filtered = filtered.filter(p => p.condition === filters.condition);\n    }\n\n    if (filters?.location) {\n      const locationLower = filters.location.toLowerCase();\n      filtered = filtered.filter(p => p.location?.toLowerCase().includes(locationLower));\n    }\n\n    return filtered;\n  }\n\n  async getSellerProducts(sellerId: string): Promise<Product[]> {\n    return await db\n      .select()\n      .from(products)\n      .where(eq(products.sellerId, sellerId))\n      .orderBy(desc(products.createdAt));\n  }\n\n  async getSellerProductsWithAnalytics(sellerId: string): Promise<(Product & { inquiryCount: number })[]> {\n    const sellerProducts = await db\n      .select()\n      .from(products)\n      .where(eq(products.sellerId, sellerId))\n      .orderBy(desc(products.createdAt));\n\n    // Get inquiry counts for each product\n    const productsWithInquiries = await Promise.all(\n      sellerProducts.map(async (product) => {\n        const inquiries = await db\n          .select()\n          .from(messages)\n          .where(eq(messages.productId, product.id));\n        return {\n          ...product,\n          inquiryCount: inquiries.length,\n        };\n      })\n    );\n\n    return productsWithInquiries;\n  }\n\n  async updateProduct(id: string, data: UpdateProduct): Promise<Product> {\n    const [updated] = await db\n      .update(products)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(products.id, id))\n      .returning();\n    \n    if (!updated) {\n      throw new Error(`Product ${id} not found`);\n    }\n    \n    return updated;\n  }\n\n  async deleteProduct(id: string): Promise<void> {\n    await db.delete(products).where(eq(products.id, id));\n  }\n\n  async incrementProductViews(id: string): Promise<void> {\n    await db\n      .update(products)\n      .set({ views: sql`${products.views} + 1` })\n      .where(eq(products.id, id));\n  }\n\n  async incrementProductInquiries(productId: string): Promise<void> {\n    await db\n      .update(products)\n      .set({ inquiries: sql`${products.inquiries} + 1` })\n      .where(eq(products.id, productId));\n  }\n\n  async flagProduct(id: string, reason: string): Promise<Product> {\n    const [product] = await db\n      .update(products)\n      .set({ isFlagged: true, flagReason: reason, updatedAt: new Date() })\n      .where(eq(products.id, id))\n      .returning();\n    return product;\n  }\n\n  async approveProduct(id: string): Promise<Product> {\n    const [product] = await db\n      .update(products)\n      .set({ isApproved: true, isFlagged: false, flagReason: null, updatedAt: new Date() })\n      .where(eq(products.id, id))\n      .returning();\n    return product;\n  }\n\n  // Unique product view tracking methods (1 view per user per 24 hours)\n  async hasViewedProduct(productId: string, viewerId: string): Promise<boolean> {\n    // Check if viewer has viewed this product in the last 24 hours\n    const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n    const existing = await db\n      .select()\n      .from(productViews)\n      .where(\n        and(\n          eq(productViews.productId, productId),\n          eq(productViews.viewerId, viewerId),\n          gt(productViews.createdAt, twentyFourHoursAgo)\n        )\n      )\n      .limit(1);\n    return existing.length > 0;\n  }\n\n  async recordProductView(productId: string, viewerId: string): Promise<void> {\n    await db.insert(productViews).values({\n      productId,\n      viewerId,\n    });\n  }\n\n  async recordUniqueProductView(productId: string, viewerId: string): Promise<boolean> {\n    // Check if this viewer has already viewed this product in the last 24 hours\n    const hasViewed = await this.hasViewedProduct(productId, viewerId);\n    \n    if (!hasViewed) {\n      // Record the new view\n      await this.recordProductView(productId, viewerId);\n      // Increment the product's view counter\n      await this.incrementProductViews(productId);\n      return true; // New unique view recorded\n    }\n    \n    return false; // Already viewed within 24 hours, no increment\n  }\n\n  // Category operations\n  async getCategories(): Promise<Category[]> {\n    return await db.select().from(categories).orderBy(categories.name);\n  }\n\n  async createCategory(category: InsertCategory): Promise<Category> {\n    const [created] = await db.insert(categories).values(category).returning();\n    return created;\n  }\n\n  // Message operations\n  async getMessageThread(userId1: string, userId2: string): Promise<Message[]> {\n    return await db\n      .select()\n      .from(messages)\n      .where(\n        or(\n          and(eq(messages.senderId, userId1), eq(messages.receiverId, userId2)),\n          and(eq(messages.senderId, userId2), eq(messages.receiverId, userId1))\n        )\n      )\n      .orderBy(messages.createdAt);\n  }\n\n  async getMessageThreads(userId: string): Promise<any[]> {\n    // Get unique users this user has chatted with\n    const sentMessages = await db\n      .select({ userId: messages.receiverId })\n      .from(messages)\n      .where(eq(messages.senderId, userId));\n\n    const receivedMessages = await db\n      .select({ userId: messages.senderId })\n      .from(messages)\n      .where(eq(messages.receiverId, userId));\n\n    const userIds = Array.from(new Set([\n      ...sentMessages.map(m => m.userId),\n      ...receivedMessages.map(m => m.userId),\n    ]));\n\n    // Get user details and last message for each thread\n    const threads = await Promise.all(\n      userIds.map(async (otherUserId) => {\n        const [user] = await db.select().from(users).where(eq(users.id, otherUserId));\n        const thread = await this.getMessageThread(userId, otherUserId);\n        const lastMessage = thread[thread.length - 1];\n        const unreadCount = thread.filter(\n          m => m.receiverId === userId && !m.isRead\n        ).length;\n\n        return {\n          user,\n          lastMessage,\n          unreadCount,\n        };\n      })\n    );\n\n    return threads.sort((a, b) => {\n      if (!a.lastMessage) return 1;\n      if (!b.lastMessage) return -1;\n      return new Date(b.lastMessage.createdAt!).getTime() - new Date(a.lastMessage.createdAt!).getTime();\n    });\n  }\n\n  async createMessage(message: InsertMessage): Promise<Message> {\n    const [created] = await db.insert(messages).values(message).returning();\n    return created;\n  }\n\n  async markMessagesAsRead(userId: string, fromUserId: string): Promise<void> {\n    await db\n      .update(messages)\n      .set({ isRead: true })\n      .where(\n        and(\n          eq(messages.receiverId, userId),\n          eq(messages.senderId, fromUserId)\n        )\n      );\n  }\n\n  // Review operations\n  async getUserReviews(userId: string): Promise<Review[]> {\n    return await db\n      .select()\n      .from(reviews)\n      .where(eq(reviews.reviewedUserId, userId))\n      .orderBy(desc(reviews.createdAt));\n  }\n\n  async createReview(review: any): Promise<Review> {\n    const [created] = await db.insert(reviews).values(review).returning();\n    \n    // Update user's trust score and rating count\n    const userReviews = await this.getUserReviews(review.reviewedUserId);\n    const avgRating = userReviews.reduce((sum, r) => sum + r.rating, 0) / userReviews.length;\n    \n    await db\n      .update(users)\n      .set({\n        trustScore: avgRating.toFixed(1),\n        totalRatings: userReviews.length,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, review.reviewedUserId));\n\n    return created;\n  }\n\n  // Watchlist operations\n  async addToWatchlist(userId: string, productId: string): Promise<Watchlist> {\n    const [created] = await db\n      .insert(watchlist)\n      .values({ userId, productId })\n      .returning();\n    \n    // Increment product watchers count\n    await db\n      .update(products)\n      .set({ watchers: sql`${products.watchers} + 1` })\n      .where(eq(products.id, productId));\n    \n    return created;\n  }\n\n  async getUserWatchlist(userId: string): Promise<Watchlist[]> {\n    return await db\n      .select()\n      .from(watchlist)\n      .where(eq(watchlist.userId, userId))\n      .orderBy(desc(watchlist.createdAt));\n  }\n\n  async getWishlistWithProducts(userId: string): Promise<(Watchlist & { product: Product & { seller: User } })[]> {\n    const results = await db\n      .select()\n      .from(watchlist)\n      .leftJoin(products, eq(watchlist.productId, products.id))\n      .leftJoin(users, eq(products.sellerId, users.id))\n      .where(eq(watchlist.userId, userId))\n      .orderBy(desc(watchlist.createdAt));\n\n    // Filter out items with missing products or sellers and map to the expected format\n    return results\n      .filter(r => r.watchlist && r.products && r.users)\n      .map(r => ({\n        ...r.watchlist!,\n        product: {\n          ...r.products!,\n          seller: r.users!,\n        },\n      }));\n  }\n\n  async removeFromWatchlist(userId: string, productId: string): Promise<void> {\n    const result = await db\n      .delete(watchlist)\n      .where(and(eq(watchlist.userId, userId), eq(watchlist.productId, productId)))\n      .returning();\n    \n    // Only decrement if a row was actually deleted\n    if (result.length > 0) {\n      await db\n        .update(products)\n        .set({ watchers: sql`GREATEST(${products.watchers} - 1, 0)` })\n        .where(eq(products.id, productId));\n    } else {\n      throw new Error(\"Watchlist item not found\");\n    }\n  }\n\n  // Report operations\n  async createReport(report: InsertReport): Promise<any> {\n    const [created] = await db.insert(reports).values(report).returning();\n    return created;\n  }\n\n  // Wallet operations\n  async getOrCreateWallet(userId: string): Promise<Wallet> {\n    const existing = await this.getWallet(userId);\n    if (existing) return existing;\n\n    const [wallet] = await db.insert(wallets).values({ userId }).returning();\n    return wallet;\n  }\n\n  async getWallet(userId: string): Promise<Wallet | undefined> {\n    const [wallet] = await db.select().from(wallets).where(eq(wallets.userId, userId));\n    return wallet;\n  }\n\n  async updateWalletBalance(userId: string, amount: string, type: 'add' | 'subtract'): Promise<Wallet> {\n    const wallet = await this.getOrCreateWallet(userId);\n    \n    // Check for sufficient balance when subtracting\n    if (type === 'subtract') {\n      const currentBalance = parseFloat(wallet.balance);\n      const amountToSubtract = parseFloat(amount);\n      \n      if (currentBalance < amountToSubtract) {\n        throw new Error(`Insufficient balance. Available: ₦${currentBalance}, Required: ₦${amountToSubtract}`);\n      }\n    }\n    \n    // Use SQL arithmetic for safe decimal operations\n    const [updated] = await db\n      .update(wallets)\n      .set({\n        balance: type === 'add'\n          ? sql`${wallets.balance} + ${amount}`\n          : sql`${wallets.balance} - ${amount}`,\n        updatedAt: new Date(),\n      })\n      .where(eq(wallets.id, wallet.id))\n      .returning();\n\n    return updated;\n  }\n\n  // Transaction operations\n  async createTransaction(transaction: InsertTransaction): Promise<Transaction> {\n    const [created] = await db.insert(transactions).values(transaction).returning();\n    return created;\n  }\n\n  async getUserTransactions(walletId: string): Promise<Transaction[]> {\n    return await db\n      .select()\n      .from(transactions)\n      .where(eq(transactions.walletId, walletId))\n      .orderBy(desc(transactions.createdAt));\n  }\n\n  // Welcome bonus operations\n  async createWelcomeBonus(userId: string, amount: string): Promise<WelcomeBonus> {\n    const [bonus] = await db\n      .insert(welcomeBonuses)\n      .values({ userId, amount })\n      .returning();\n\n    // Add to wallet and create transaction\n    const wallet = await this.getOrCreateWallet(userId);\n    await this.updateWalletBalance(userId, amount, 'add');\n    await this.createTransaction({\n      walletId: wallet.id,\n      type: 'welcome_bonus',\n      amount,\n      description: 'Welcome to EKSU Marketplace!',\n      status: 'completed',\n    });\n\n    return bonus;\n  }\n\n  async getWelcomeBonus(userId: string): Promise<WelcomeBonus | undefined> {\n    const [bonus] = await db\n      .select()\n      .from(welcomeBonuses)\n      .where(eq(welcomeBonuses.userId, userId));\n    return bonus;\n  }\n\n  // Referral operations\n  async createReferral(referrerId: string, referredUserId: string): Promise<Referral> {\n    // Prevent self-referrals\n    if (referrerId === referredUserId) {\n      throw new Error(\"Cannot refer yourself\");\n    }\n\n    // Check for duplicate referrals\n    const [existing] = await db\n      .select()\n      .from(referrals)\n      .where(\n        and(\n          eq(referrals.referrerId, referrerId),\n          eq(referrals.referredUserId, referredUserId)\n        )\n      );\n\n    if (existing) {\n      throw new Error(\"Referral already exists\");\n    }\n\n    const [referral] = await db\n      .insert(referrals)\n      .values({ referrerId, referredUserId })\n      .returning();\n    return referral;\n  }\n\n  async getUserReferrals(userId: string): Promise<(Referral & { referredUser?: { firstName: string | null; lastName: string | null; email: string; profileImageUrl: string | null } })[]> {\n    const results = await db\n      .select({\n        referral: referrals,\n        referredUser: {\n          firstName: users.firstName,\n          lastName: users.lastName,\n          email: users.email,\n          profileImageUrl: users.profileImageUrl,\n        },\n      })\n      .from(referrals)\n      .leftJoin(users, eq(referrals.referredUserId, users.id))\n      .where(eq(referrals.referrerId, userId))\n      .orderBy(desc(referrals.createdAt));\n    \n    return results.map(r => ({\n      ...r.referral,\n      referredUser: r.referredUser || undefined,\n    }));\n  }\n\n  async markReferralPaid(referralId: string): Promise<Referral> {\n    const [updated] = await db\n      .update(referrals)\n      .set({ bonusPaid: true })\n      .where(eq(referrals.id, referralId))\n      .returning();\n    return updated;\n  }\n\n  // Saved search operations\n  async createSavedSearch(search: InsertSavedSearch): Promise<SavedSearch> {\n    const [saved] = await db.insert(savedSearches).values(search).returning();\n    return saved;\n  }\n\n  async getUserSavedSearches(userId: string): Promise<SavedSearch[]> {\n    return await db\n      .select()\n      .from(savedSearches)\n      .where(eq(savedSearches.userId, userId))\n      .orderBy(desc(savedSearches.createdAt));\n  }\n\n  async deleteSavedSearch(id: string): Promise<void> {\n    await db.delete(savedSearches).where(eq(savedSearches.id, id));\n  }\n\n  // Draft product operations\n  async saveDraft(sellerId: string, data: any): Promise<DraftProduct> {\n    const [draft] = await db\n      .insert(draftProducts)\n      .values({ sellerId, data })\n      .returning();\n    return draft;\n  }\n\n  async getUserDrafts(sellerId: string): Promise<DraftProduct[]> {\n    return await db\n      .select()\n      .from(draftProducts)\n      .where(eq(draftProducts.sellerId, sellerId))\n      .orderBy(desc(draftProducts.updatedAt));\n  }\n\n  async deleteDraft(id: string): Promise<void> {\n    await db.delete(draftProducts).where(eq(draftProducts.id, id));\n  }\n\n  // Scheduled post operations\n  async createScheduledPost(post: InsertScheduledPost): Promise<ScheduledPost> {\n    const [created] = await db.insert(scheduledPosts).values(post).returning();\n    return created;\n  }\n\n  async getUserScheduledPosts(sellerId: string): Promise<ScheduledPost[]> {\n    return await db\n      .select()\n      .from(scheduledPosts)\n      .where(and(eq(scheduledPosts.sellerId, sellerId), eq(scheduledPosts.published, false)))\n      .orderBy(scheduledPosts.scheduledFor);\n  }\n\n  async getPendingScheduledPosts(): Promise<ScheduledPost[]> {\n    const now = new Date();\n    return await db\n      .select()\n      .from(scheduledPosts)\n      .where(\n        and(\n          eq(scheduledPosts.published, false),\n          sql`${scheduledPosts.scheduledFor} <= ${now}`\n        )\n      );\n  }\n\n  async markScheduledPostPublished(id: string, productId: string): Promise<ScheduledPost> {\n    const [updated] = await db\n      .update(scheduledPosts)\n      .set({ published: true, publishedProductId: productId })\n      .where(eq(scheduledPosts.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Voice post operations\n  async createVoicePost(post: any): Promise<VoicePost> {\n    const [created] = await db.insert(voicePosts).values(post).returning();\n    return created;\n  }\n\n  async getUserVoicePosts(userId: string): Promise<VoicePost[]> {\n    return await db\n      .select()\n      .from(voicePosts)\n      .where(eq(voicePosts.userId, userId))\n      .orderBy(desc(voicePosts.createdAt));\n  }\n\n  // Boost request operations\n  async createBoostRequest(request: InsertBoostRequest): Promise<BoostRequest> {\n    const [created] = await db.insert(boostRequests).values(request).returning();\n    return created;\n  }\n\n  async getUserBoostRequests(sellerId: string): Promise<BoostRequest[]> {\n    return await db\n      .select()\n      .from(boostRequests)\n      .where(eq(boostRequests.sellerId, sellerId))\n      .orderBy(desc(boostRequests.createdAt));\n  }\n\n  async getActiveBoosts(): Promise<BoostRequest[]> {\n    const now = new Date();\n    return await db\n      .select()\n      .from(boostRequests)\n      .where(\n        and(\n          eq(boostRequests.status, 'active'),\n          sql`${boostRequests.expiresAt} > ${now}`\n        )\n      );\n  }\n\n  async expireBoost(id: string): Promise<BoostRequest> {\n    const [updated] = await db\n      .update(boostRequests)\n      .set({ status: 'expired' })\n      .where(eq(boostRequests.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Dispute operations\n  async createDispute(dispute: InsertDispute): Promise<Dispute> {\n    const [created] = await db.insert(disputes).values(dispute).returning();\n    return created;\n  }\n\n  async getUserDisputes(userId: string): Promise<Dispute[]> {\n    return await db\n      .select()\n      .from(disputes)\n      .where(or(eq(disputes.buyerId, userId), eq(disputes.sellerId, userId)))\n      .orderBy(desc(disputes.createdAt));\n  }\n\n  async getAllDisputes(): Promise<Dispute[]> {\n    return await db.select().from(disputes).orderBy(desc(disputes.createdAt));\n  }\n\n  async resolveDispute(id: string, resolution: string, resolvedBy: string): Promise<Dispute> {\n    const [updated] = await db\n      .update(disputes)\n      .set({\n        status: 'resolved',\n        resolution,\n        resolvedBy,\n        resolvedAt: new Date(),\n      })\n      .where(eq(disputes.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Support ticket operations\n  async createSupportTicket(ticket: InsertSupportTicket): Promise<SupportTicket> {\n    const [created] = await db.insert(supportTickets).values(ticket).returning();\n    return created;\n  }\n\n  async getUserSupportTickets(userId: string): Promise<SupportTicket[]> {\n    return await db\n      .select()\n      .from(supportTickets)\n      .where(eq(supportTickets.userId, userId))\n      .orderBy(desc(supportTickets.createdAt));\n  }\n\n  async getAllSupportTickets(): Promise<SupportTicket[]> {\n    return await db\n      .select()\n      .from(supportTickets)\n      .orderBy(desc(supportTickets.createdAt));\n  }\n\n  async updateSupportTicket(id: string, data: Partial<SupportTicket>): Promise<SupportTicket> {\n    const [updated] = await db\n      .update(supportTickets)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(supportTickets.id, id))\n      .returning();\n    return updated;\n  }\n\n  async getSupportTicketById(id: string): Promise<(SupportTicket & { user: User }) | undefined> {\n    const result = await db\n      .select()\n      .from(supportTickets)\n      .innerJoin(users, eq(supportTickets.userId, users.id))\n      .where(eq(supportTickets.id, id));\n    \n    if (result.length === 0) return undefined;\n    return { ...result[0].support_tickets, user: result[0].users };\n  }\n\n  async getNextTicketNumber(): Promise<string> {\n    // Use PostgreSQL sequence for atomic, monotonic ticket number generation\n    const result = await db.execute(sql`SELECT nextval('ticket_number_seq') as next_num`);\n    const nextNum = result.rows?.[0]?.next_num || 1;\n    return `EKSU-${String(nextNum).padStart(5, '0')}`;\n  }\n\n  async createSupportTicketWithNumber(ticket: InsertSupportTicket): Promise<SupportTicket> {\n    // Generate ticket number atomically using sequence\n    const ticketNumber = await this.getNextTicketNumber();\n    const [created] = await db.insert(supportTickets).values({\n      ...ticket,\n      ticketNumber,\n    }).returning();\n    return created;\n  }\n\n  // Ticket reply operations\n  async createTicketReply(reply: InsertTicketReply): Promise<TicketReply> {\n    const [created] = await db.insert(ticketReplies).values(reply).returning();\n    \n    // Update ticket status to pending if user replied, or keep it if admin replied\n    if (!reply.isAdminReply) {\n      await this.updateSupportTicket(reply.ticketId, { status: 'pending' });\n    }\n    \n    return created;\n  }\n\n  async getTicketReplies(ticketId: string): Promise<(TicketReply & { user: User })[]> {\n    const result = await db\n      .select()\n      .from(ticketReplies)\n      .innerJoin(users, eq(ticketReplies.userId, users.id))\n      .where(eq(ticketReplies.ticketId, ticketId))\n      .orderBy(ticketReplies.createdAt);\n    \n    return result.map(r => ({ ...r.ticket_replies, user: r.users }));\n  }\n\n  async getUserOpenTicketCount(userId: string): Promise<number> {\n    const result = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(supportTickets)\n      .where(and(\n        eq(supportTickets.userId, userId),\n        sql`${supportTickets.status} IN ('open', 'pending', 'in_progress')`\n      ));\n    return result[0]?.count || 0;\n  }\n\n  // Login streak operations\n  async getOrCreateLoginStreak(userId: string): Promise<LoginStreak> {\n    const [existing] = await db\n      .select()\n      .from(loginStreaks)\n      .where(eq(loginStreaks.userId, userId));\n\n    if (existing) return existing;\n\n    const [created] = await db\n      .insert(loginStreaks)\n      .values({ userId })\n      .returning();\n    return created;\n  }\n\n  async updateLoginStreak(userId: string, ipAddress?: string): Promise<{ streak: LoginStreak; reward: number; securityWarning?: string }> {\n    const streak = await this.getOrCreateLoginStreak(userId);\n    const today = new Date();\n    const todayDateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format\n    today.setHours(0, 0, 0, 0);\n    \n    let securityWarning: string | undefined;\n    \n    // Generate daily claim hash for replay attack prevention\n    const serverSecret = process.env.LOGIN_REWARD_SECRET || 'default-login-streak-secret-change-in-production';\n    const dailyHash = crypto.createHash('sha256')\n      .update(`${todayDateStr}:${userId}:${serverSecret}`)\n      .digest('hex');\n    \n    // Check if this exact claim was already processed today (replay attack prevention)\n    if (streak.dailyClaimHash === dailyHash) {\n      return { streak, reward: 0 };\n    }\n    \n    // Check for suspicious IP changes (potential account sharing or abuse)\n    const previousIp = streak.lastIpAddress;\n    if (previousIp && ipAddress && previousIp !== ipAddress) {\n      // Different IP detected - flag for monitoring but allow claim\n      const newSuspiciousCount = (streak.suspiciousActivityCount || 0) + 1;\n      \n      // If too many IP changes (more than 5), add warning\n      if (newSuspiciousCount > 5) {\n        securityWarning = 'Multiple IP address changes detected. Your account is being monitored for suspicious activity.';\n        console.log(`Security alert: User ${userId} has ${newSuspiciousCount} IP changes. Previous: ${previousIp}, Current: ${ipAddress}`);\n      }\n    }\n    \n    const lastLogin = streak.lastLoginDate ? new Date(streak.lastLoginDate) : null;\n    lastLogin?.setHours(0, 0, 0, 0);\n\n    const daysDiff = lastLogin\n      ? Math.floor((today.getTime() - lastLogin.getTime()) / (1000 * 60 * 60 * 24))\n      : 1;\n\n    let newStreak = streak.currentStreak;\n    let reward = 0;\n\n    if (daysDiff === 0) {\n      // Already logged in today - update IP if changed but no reward\n      if (ipAddress && ipAddress !== streak.lastIpAddress) {\n        await db\n          .update(loginStreaks)\n          .set({\n            lastIpAddress: ipAddress,\n            lastClaimAttempt: new Date(),\n            suspiciousActivityCount: (streak.suspiciousActivityCount || 0) + 1,\n            updatedAt: new Date(),\n          })\n          .where(eq(loginStreaks.id, streak.id));\n      }\n      return { streak, reward: 0, securityWarning };\n    } else if (daysDiff === 1) {\n      // Consecutive day - increment streak\n      newStreak = (streak.currentStreak || 0) + 1;\n      reward = Math.floor(Math.random() * 48 + 2); // Random ₦2-₦50\n    } else {\n      // Streak broken - reset\n      newStreak = 1;\n      reward = Math.floor(Math.random() * 48 + 2); // Random ₦2-₦50\n    }\n\n    // Calculate new suspicious activity count\n    const suspiciousIncrement = (previousIp && ipAddress && previousIp !== ipAddress) ? 1 : 0;\n\n    const [updated] = await db\n      .update(loginStreaks)\n      .set({\n        currentStreak: newStreak,\n        longestStreak: Math.max(newStreak, streak.longestStreak || 0),\n        lastLoginDate: new Date(),\n        totalRewards: sql`${loginStreaks.totalRewards} + ${reward}`,\n        // Security fields\n        lastIpAddress: ipAddress || streak.lastIpAddress,\n        dailyClaimHash: dailyHash,\n        claimCount: sql`COALESCE(${loginStreaks.claimCount}, 0) + 1`,\n        lastClaimAttempt: new Date(),\n        suspiciousActivityCount: sql`COALESCE(${loginStreaks.suspiciousActivityCount}, 0) + ${suspiciousIncrement}`,\n        updatedAt: new Date(),\n      })\n      .where(eq(loginStreaks.id, streak.id))\n      .returning();\n\n    // Add reward to wallet\n    if (reward > 0) {\n      const wallet = await this.getOrCreateWallet(userId);\n      await this.updateWalletBalance(userId, reward.toString(), 'add');\n      await this.createTransaction({\n        walletId: wallet.id,\n        type: 'login_reward',\n        amount: reward.toString(),\n        description: `${newStreak}-day login streak reward`,\n        status: 'completed',\n      });\n    }\n\n    return { streak: updated, reward, securityWarning };\n  }\n\n  // Seller analytics operations\n  async getOrCreateSellerAnalytics(sellerId: string): Promise<SellerAnalytics> {\n    const [existing] = await db\n      .select()\n      .from(sellerAnalytics)\n      .where(eq(sellerAnalytics.sellerId, sellerId));\n\n    if (existing) return existing;\n\n    const [created] = await db\n      .insert(sellerAnalytics)\n      .values({ sellerId })\n      .returning();\n    return created;\n  }\n\n  async updateSellerAnalytics(sellerId: string, data: Partial<SellerAnalytics>): Promise<SellerAnalytics> {\n    const analytics = await this.getOrCreateSellerAnalytics(sellerId);\n    const [updated] = await db\n      .update(sellerAnalytics)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(sellerAnalytics.id, analytics.id))\n      .returning();\n    return updated;\n  }\n\n  // Follow operations\n  async followUser(followerId: string, followingId: string): Promise<Follow> {\n    // Prevent self-follow\n    if (followerId === followingId) {\n      throw new Error(\"Cannot follow yourself\");\n    }\n\n    // Check if already following (idempotent)\n    const existing = await db\n      .select()\n      .from(follows)\n      .where(and(\n        eq(follows.followerId, followerId),\n        eq(follows.followingId, followingId)\n      ));\n\n    if (existing.length > 0) {\n      return existing[0];\n    }\n\n    const [created] = await db\n      .insert(follows)\n      .values({ followerId, followingId })\n      .returning();\n    return created;\n  }\n\n  async unfollowUser(followerId: string, followingId: string): Promise<void> {\n    await db\n      .delete(follows)\n      .where(and(\n        eq(follows.followerId, followerId),\n        eq(follows.followingId, followingId)\n      ));\n  }\n\n  async getFollowers(userId: string): Promise<(Follow & { follower: User })[]> {\n    const result = await db\n      .select()\n      .from(follows)\n      .leftJoin(users, eq(follows.followerId, users.id))\n      .where(eq(follows.followingId, userId))\n      .orderBy(desc(follows.createdAt));\n\n    return result.map(r => ({ ...r.follows, follower: r.users! }));\n  }\n\n  async getFollowing(userId: string): Promise<(Follow & { following: User })[]> {\n    const result = await db\n      .select()\n      .from(follows)\n      .leftJoin(users, eq(follows.followingId, users.id))\n      .where(eq(follows.followerId, userId))\n      .orderBy(desc(follows.createdAt));\n\n    return result.map(r => ({ ...r.follows, following: r.users! }));\n  }\n\n  async getFollowerCount(userId: string): Promise<number> {\n    const result = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(follows)\n      .where(eq(follows.followingId, userId));\n    return result[0]?.count || 0;\n  }\n\n  async getFollowingCount(userId: string): Promise<number> {\n    const result = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(follows)\n      .where(eq(follows.followerId, userId));\n    return result[0]?.count || 0;\n  }\n\n  async isFollowing(followerId: string, followingId: string): Promise<boolean> {\n    const result = await db\n      .select()\n      .from(follows)\n      .where(and(\n        eq(follows.followerId, followerId),\n        eq(follows.followingId, followingId)\n      ));\n    return result.length > 0;\n  }\n\n  // Hostel operations\n  async createHostel(hostelData: InsertHostel & { agentId: string }): Promise<Hostel> {\n    const [created] = await db.insert(hostels).values(hostelData).returning();\n    return created;\n  }\n\n  async getHostel(id: string): Promise<(Hostel & { agent: User }) | undefined> {\n    const result = await db\n      .select()\n      .from(hostels)\n      .leftJoin(users, eq(hostels.agentId, users.id))\n      .where(eq(hostels.id, id));\n    \n    if (!result[0]) return undefined;\n    return { ...result[0].hostels, agent: result[0].users! };\n  }\n\n  async getHostels(filters?: { location?: string; minPrice?: number; maxPrice?: number; minBedrooms?: number; bedrooms?: number }): Promise<Hostel[]> {\n    const conditions = [eq(hostels.isAvailable, true)];\n    \n    if (filters?.location) {\n      conditions.push(like(hostels.location, `%${filters.location}%`));\n    }\n    \n    // Support for bedroom filtering: minBedrooms for >= filter (4+), bedrooms for exact match\n    if (filters?.minBedrooms !== undefined) {\n      conditions.push(gte(hostels.bedrooms, filters.minBedrooms));\n    } else if (filters?.bedrooms !== undefined) {\n      conditions.push(eq(hostels.bedrooms, filters.bedrooms));\n    }\n    \n    return await db\n      .select()\n      .from(hostels)\n      .where(and(...conditions))\n      .orderBy(desc(hostels.createdAt));\n  }\n\n  async getUserHostels(agentId: string): Promise<Hostel[]> {\n    return await db.select().from(hostels).where(eq(hostels.agentId, agentId)).orderBy(desc(hostels.createdAt));\n  }\n\n  async updateHostel(id: string, data: Partial<Hostel>): Promise<Hostel> {\n    const [updated] = await db\n      .update(hostels)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(hostels.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteHostel(id: string): Promise<void> {\n    await db.delete(hostels).where(eq(hostels.id, id));\n  }\n\n  async incrementHostelViews(id: string): Promise<void> {\n    await db\n      .update(hostels)\n      .set({ views: sql`${hostels.views} + 1` })\n      .where(eq(hostels.id, id));\n  }\n\n  // Event operations\n  async createEvent(eventData: InsertEvent & { organizerId: string }): Promise<Event> {\n    const [created] = await db.insert(events).values(eventData).returning();\n    return created;\n  }\n\n  async getEvent(id: string): Promise<(Event & { organizer: User }) | undefined> {\n    const result = await db\n      .select()\n      .from(events)\n      .leftJoin(users, eq(events.organizerId, users.id))\n      .where(eq(events.id, id));\n    \n    if (!result[0]) return undefined;\n    return { ...result[0].events, organizer: result[0].users! };\n  }\n\n  async getEvents(filters?: { eventType?: string; upcoming?: boolean }): Promise<Event[]> {\n    const conditions = [eq(events.isActive, true)];\n    \n    if (filters?.upcoming) {\n      conditions.push(sql`${events.eventDate} >= NOW()`);\n    }\n    \n    return await db\n      .select()\n      .from(events)\n      .where(and(...conditions))\n      .orderBy(events.eventDate);\n  }\n\n  async getUserEvents(organizerId: string): Promise<Event[]> {\n    return await db.select().from(events).where(eq(events.organizerId, organizerId)).orderBy(desc(events.createdAt));\n  }\n\n  async updateEvent(id: string, data: Partial<Event>): Promise<Event> {\n    const [updated] = await db\n      .update(events)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(events.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteEvent(id: string): Promise<void> {\n    await db.delete(events).where(eq(events.id, id));\n  }\n\n  async incrementEventViews(id: string): Promise<void> {\n    await db\n      .update(events)\n      .set({ views: sql`${events.views} + 1` })\n      .where(eq(events.id, id));\n  }\n\n  async purchaseTicket(eventId: string, userId: string): Promise<Event> {\n    const [updated] = await db\n      .update(events)\n      .set({ \n        ticketsSold: sql`${events.ticketsSold} + 1`,\n        updatedAt: new Date()\n      })\n      .where(eq(events.id, eventId))\n      .returning();\n    return updated;\n  }\n\n  // Escrow operations\n  async createEscrowTransaction(transactionData: InsertEscrowTransaction & { buyerId: string; sellerId: string }): Promise<EscrowTransaction> {\n    const [created] = await db.insert(escrowTransactions).values(transactionData).returning();\n    return created;\n  }\n\n  async getEscrowTransaction(id: string): Promise<EscrowTransaction | undefined> {\n    const [transaction] = await db.select().from(escrowTransactions).where(eq(escrowTransactions.id, id));\n    return transaction;\n  }\n\n  async getUserEscrowTransactions(userId: string): Promise<EscrowTransaction[]> {\n    return await db\n      .select()\n      .from(escrowTransactions)\n      .where(or(eq(escrowTransactions.buyerId, userId), eq(escrowTransactions.sellerId, userId)))\n      .orderBy(desc(escrowTransactions.createdAt));\n  }\n\n  async confirmEscrowByBuyer(id: string): Promise<EscrowTransaction> {\n    const [updated] = await db\n      .update(escrowTransactions)\n      .set({ buyerConfirmed: true, updatedAt: new Date() })\n      .where(eq(escrowTransactions.id, id))\n      .returning();\n    return updated;\n  }\n\n  async confirmEscrowBySeller(id: string): Promise<EscrowTransaction> {\n    const [updated] = await db\n      .update(escrowTransactions)\n      .set({ sellerConfirmed: true, updatedAt: new Date() })\n      .where(eq(escrowTransactions.id, id))\n      .returning();\n    return updated;\n  }\n\n  async releaseEscrowFunds(id: string): Promise<EscrowTransaction> {\n    const transaction = await this.getEscrowTransaction(id);\n    if (!transaction) throw new Error(\"Escrow transaction not found\");\n    if (transaction.status !== 'held') throw new Error(\"Can only release funds from 'held' status\");\n\n    // Move funds from escrowBalance to balance for seller\n    const sellerWallet = await this.getWallet(transaction.sellerId);\n    if (!sellerWallet) throw new Error(\"Seller wallet not found\");\n\n    await db\n      .update(wallets)\n      .set({\n        escrowBalance: sql`${wallets.escrowBalance} - ${transaction.amount}`,\n        balance: sql`${wallets.balance} + ${transaction.amount}`,\n        totalEarned: sql`${wallets.totalEarned} + ${transaction.amount}`,\n        updatedAt: new Date()\n      })\n      .where(eq(wallets.id, sellerWallet.id));\n    \n    // Create transaction record\n    await this.createTransaction({\n      walletId: sellerWallet.id,\n      type: 'escrow_release',\n      amount: transaction.amount,\n      description: 'Escrow funds released',\n      relatedUserId: transaction.buyerId,\n      status: 'completed',\n    });\n\n    // Deduct platform fee\n    const feeAmount = parseFloat(transaction.platformFee);\n    if (feeAmount > 0) {\n      await db\n        .update(wallets)\n        .set({\n          balance: sql`${wallets.balance} - ${transaction.platformFee}`,\n          updatedAt: new Date()\n        })\n        .where(eq(wallets.id, sellerWallet.id));\n\n      await this.createTransaction({\n        walletId: sellerWallet.id,\n        type: 'platform_fee',\n        amount: `-${transaction.platformFee}`,\n        description: 'Platform fee deducted',\n        status: 'completed',\n      });\n    }\n\n    const [updated] = await db\n      .update(escrowTransactions)\n      .set({ \n        status: 'released',\n        releasedAt: new Date(),\n        updatedAt: new Date()\n      })\n      .where(eq(escrowTransactions.id, id))\n      .returning();\n    \n    return updated;\n  }\n\n  async refundEscrow(id: string): Promise<EscrowTransaction> {\n    const transaction = await this.getEscrowTransaction(id);\n    if (!transaction) throw new Error(\"Escrow transaction not found\");\n    if (transaction.status !== 'held') throw new Error(\"Can only refund funds from 'held' status\");\n\n    // Move funds from seller's escrowBalance to buyer's balance\n    const sellerWallet = await this.getWallet(transaction.sellerId);\n    const buyerWallet = await this.getWallet(transaction.buyerId);\n    if (!sellerWallet) throw new Error(\"Seller wallet not found\");\n    if (!buyerWallet) throw new Error(\"Buyer wallet not found\");\n\n    // Deduct from seller's escrow balance\n    await db\n      .update(wallets)\n      .set({\n        escrowBalance: sql`${wallets.escrowBalance} - ${transaction.amount}`,\n        updatedAt: new Date()\n      })\n      .where(eq(wallets.id, sellerWallet.id));\n\n    // Add to buyer's balance\n    await db\n      .update(wallets)\n      .set({\n        balance: sql`${wallets.balance} + ${transaction.amount}`,\n        updatedAt: new Date()\n      })\n      .where(eq(wallets.id, buyerWallet.id));\n    \n    // Create transaction records\n    await this.createTransaction({\n      walletId: buyerWallet.id,\n      type: 'refund',\n      amount: transaction.amount,\n      description: 'Escrow refunded',\n      relatedUserId: transaction.sellerId,\n      status: 'completed',\n    });\n\n    const [updated] = await db\n      .update(escrowTransactions)\n      .set({ \n        status: 'refunded',\n        updatedAt: new Date()\n      })\n      .where(eq(escrowTransactions.id, id))\n      .returning();\n    \n    return updated;\n  }\n\n  async getEscrowTransactionWithDetails(id: string): Promise<(EscrowTransaction & { product?: Product; buyer: User; seller: User }) | undefined> {\n    const [transaction] = await db.select().from(escrowTransactions).where(eq(escrowTransactions.id, id));\n    if (!transaction) return undefined;\n    \n    const [buyer] = await db.select().from(users).where(eq(users.id, transaction.buyerId));\n    const [seller] = await db.select().from(users).where(eq(users.id, transaction.sellerId));\n    \n    let product: Product | undefined;\n    if (transaction.productId) {\n      const [p] = await db.select().from(products).where(eq(products.id, transaction.productId));\n      product = p;\n    }\n    \n    return { ...transaction, product, buyer, seller };\n  }\n\n  async getUserPurchases(buyerId: string): Promise<(EscrowTransaction & { product?: Product; seller: User })[]> {\n    const transactions = await db\n      .select()\n      .from(escrowTransactions)\n      .where(eq(escrowTransactions.buyerId, buyerId))\n      .orderBy(desc(escrowTransactions.createdAt));\n    \n    const results: (EscrowTransaction & { product?: Product; seller: User })[] = [];\n    for (const transaction of transactions) {\n      const [seller] = await db.select().from(users).where(eq(users.id, transaction.sellerId));\n      let product: Product | undefined;\n      if (transaction.productId) {\n        const [p] = await db.select().from(products).where(eq(products.id, transaction.productId));\n        product = p;\n      }\n      results.push({ ...transaction, product, seller });\n    }\n    return results;\n  }\n\n  async getUserSales(sellerId: string): Promise<(EscrowTransaction & { product?: Product; buyer: User })[]> {\n    const transactions = await db\n      .select()\n      .from(escrowTransactions)\n      .where(eq(escrowTransactions.sellerId, sellerId))\n      .orderBy(desc(escrowTransactions.createdAt));\n    \n    const results: (EscrowTransaction & { product?: Product; buyer: User })[] = [];\n    for (const transaction of transactions) {\n      const [buyer] = await db.select().from(users).where(eq(users.id, transaction.buyerId));\n      let product: Product | undefined;\n      if (transaction.productId) {\n        const [p] = await db.select().from(products).where(eq(products.id, transaction.productId));\n        product = p;\n      }\n      results.push({ ...transaction, product, buyer });\n    }\n    return results;\n  }\n\n  async addToEscrowBalance(sellerId: string, amount: string): Promise<Wallet> {\n    const wallet = await this.getWallet(sellerId);\n    if (!wallet) throw new Error(\"Wallet not found\");\n    \n    const [updated] = await db\n      .update(wallets)\n      .set({\n        escrowBalance: sql`${wallets.escrowBalance} + ${amount}`,\n        updatedAt: new Date()\n      })\n      .where(eq(wallets.userId, sellerId))\n      .returning();\n    \n    return updated;\n  }\n\n  async getSellerCompletedSalesCount(sellerId: string): Promise<number> {\n    const result = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(escrowTransactions)\n      .where(and(\n        eq(escrowTransactions.sellerId, sellerId),\n        eq(escrowTransactions.status, 'released')\n      ));\n    return result[0]?.count ?? 0;\n  }\n\n  async lockSecurityDeposit(userId: string, amount: string): Promise<Wallet> {\n    const wallet = await this.getWallet(userId);\n    if (!wallet) throw new Error(\"Wallet not found\");\n    \n    const [updated] = await db\n      .update(wallets)\n      .set({\n        balance: sql`${wallets.balance} - ${amount}`,\n        securityDepositLocked: sql`${wallets.securityDepositLocked} + ${amount}`,\n        updatedAt: new Date()\n      })\n      .where(eq(wallets.userId, userId))\n      .returning();\n    \n    return updated;\n  }\n\n  // Withdrawal operations\n  async createWithdrawal(withdrawalData: InsertWithdrawal & { userId: string }): Promise<Withdrawal> {\n    const [created] = await db.insert(withdrawals).values(withdrawalData).returning();\n    return created;\n  }\n\n  async getUserWithdrawals(userId: string): Promise<Withdrawal[]> {\n    return await db\n      .select()\n      .from(withdrawals)\n      .where(eq(withdrawals.userId, userId))\n      .orderBy(desc(withdrawals.createdAt));\n  }\n\n  async updateWithdrawal(id: string, data: Partial<Withdrawal>): Promise<Withdrawal> {\n    const [updated] = await db\n      .update(withdrawals)\n      .set(data)\n      .where(eq(withdrawals.id, id))\n      .returning();\n    return updated;\n  }\n\n  // NIN verification operations\n  async updateNINVerification(userId: string, ninHash: string, vnin: string): Promise<User> {\n    const [updated] = await db\n      .update(users)\n      .set({ \n        ninHash,\n        ninVnin: vnin,\n        ninVerified: true,\n        ninVerificationDate: new Date(),\n        updatedAt: new Date()\n      })\n      .where(eq(users.id, userId))\n      .returning();\n    return updated;\n  }\n\n  // Social media update operations\n  async updateSocialMedia(userId: string, data: { instagramHandle?: string; tiktokHandle?: string; facebookProfile?: string }): Promise<User> {\n    const [updated] = await db\n      .update(users)\n      .set({ \n        ...data,\n        updatedAt: new Date()\n      })\n      .where(eq(users.id, userId))\n      .returning();\n    return updated;\n  }\n\n  // Trust badge operations\n  async awardTrustBadge(userId: string): Promise<User> {\n    const [updated] = await db\n      .update(users)\n      .set({ \n        isTrustedSeller: true,\n        trustedSellerSince: new Date(),\n        updatedAt: new Date()\n      })\n      .where(eq(users.id, userId))\n      .returning();\n    return updated;\n  }\n\n  async revokeTrustBadge(userId: string): Promise<User> {\n    const [updated] = await db\n      .update(users)\n      .set({ \n        isTrustedSeller: false,\n        updatedAt: new Date()\n      })\n      .where(eq(users.id, userId))\n      .returning();\n    return updated;\n  }\n\n  // Referral update operations\n  async markReferralPurchase(referredUserId: string, purchaseId: string): Promise<void> {\n    // Find referral where this user was referred\n    const [referral] = await db\n      .select()\n      .from(referrals)\n      .where(and(\n        eq(referrals.referredUserId, referredUserId),\n        eq(referrals.bonusPaid, false),\n        eq(referrals.referredUserMadePurchase, false)\n      ));\n\n    if (!referral) return;\n\n    // Generate random bonus amount ₦2-50\n    const bonusAmount = (Math.random() * 48 + 2).toFixed(2);\n\n    // Update referral\n    await db\n      .update(referrals)\n      .set({\n        referredUserMadePurchase: true,\n        firstPurchaseId: purchaseId,\n        bonusAmount,\n        bonusPaid: true,\n        bonusPaidAt: new Date(),\n      })\n      .where(eq(referrals.id, referral.id));\n\n    // Pay bonus to referrer\n    const referrerWallet = await this.getOrCreateWallet(referral.referrerId);\n    await this.updateWalletBalance(referral.referrerId, bonusAmount, 'add');\n    await this.createTransaction({\n      walletId: referrerWallet.id,\n      type: 'referral_bonus',\n      amount: bonusAmount,\n      description: `Referral bonus for ${referredUserId}'s first purchase`,\n      status: 'completed',\n    });\n  }\n\n  // Leaderboard operations\n  async getTopSellers(limit: number = 10): Promise<any[]> {\n    return await db\n      .select({\n        user: users,\n        productCount: sql<number>`COUNT(${products.id})`,\n      })\n      .from(users)\n      .leftJoin(products, eq(users.id, products.sellerId))\n      .where(eq(users.isActive, true))\n      .groupBy(users.id)\n      .orderBy(sql`COUNT(${products.id}) DESC`)\n      .limit(limit);\n  }\n\n  async getMostTrustedUsers(limit: number = 10): Promise<User[]> {\n    return await db\n      .select()\n      .from(users)\n      .where(and(eq(users.isTrustedSeller, true), eq(users.isActive, true)))\n      .orderBy(desc(users.trustedSellerSince))\n      .limit(limit);\n  }\n\n  async getUserNotifications(userId: string): Promise<any[]> {\n    try {\n      const { notifications } = await import(\"@shared/schema\");\n      return await db\n        .select()\n        .from(notifications)\n        .where(eq(notifications.userId, userId))\n        .orderBy(desc(notifications.createdAt));\n    } catch (error) {\n      console.error(\"Error fetching notifications:\", error);\n      return [];\n    }\n  }\n\n  async markNotificationAsRead(id: string, userId: string): Promise<void> {\n    try {\n      const { notifications } = await import(\"@shared/schema\");\n      await db\n        .update(notifications)\n        .set({ isRead: true })\n        .where(and(eq(notifications.id, id), eq(notifications.userId, userId)));\n    } catch (error) {\n      console.error(\"Error marking notification as read:\", error);\n    }\n  }\n\n  async markAllNotificationsAsRead(userId: string): Promise<void> {\n    try {\n      const { notifications } = await import(\"@shared/schema\");\n      await db\n        .update(notifications)\n        .set({ isRead: true })\n        .where(eq(notifications.userId, userId));\n    } catch (error) {\n      console.error(\"Error marking all notifications as read:\", error);\n    }\n  }\n\n  async deleteNotification(id: string, userId: string): Promise<void> {\n    try {\n      const { notifications } = await import(\"@shared/schema\");\n      await db\n        .delete(notifications)\n        .where(and(eq(notifications.id, id), eq(notifications.userId, userId)));\n    } catch (error) {\n      console.error(\"Error deleting notification:\", error);\n    }\n  }\n\n  async createNotification(data: { userId: string; type: string; title: string; message: string; link?: string; relatedUserId?: string; relatedProductId?: string }): Promise<any> {\n    try {\n      const { notifications } = await import(\"@shared/schema\");\n      const [notification] = await db\n        .insert(notifications)\n        .values({\n          userId: data.userId,\n          type: data.type as any,\n          title: data.title,\n          message: data.message,\n          link: data.link,\n          relatedUserId: data.relatedUserId,\n          relatedProductId: data.relatedProductId,\n        })\n        .returning();\n      return notification;\n    } catch (error) {\n      console.error(\"Error creating notification:\", error);\n      throw error;\n    }\n  }\n\n  // Raw SQL execution for admin metrics\n  async executeRawSQL<T = any>(query: string, params?: any[]): Promise<T[]> {\n    const { pool } = await import(\"./db\");\n    const result = await pool.query(query, params);\n    return result.rows as T[];\n  }\n\n  // Cart operations\n  async getCartItems(userId: string): Promise<(CartItem & { product: Product })[]> {\n    const results = await db\n      .select()\n      .from(cartItems)\n      .leftJoin(products, eq(cartItems.productId, products.id))\n      .where(eq(cartItems.userId, userId))\n      .orderBy(desc(cartItems.createdAt));\n\n    return results\n      .filter(r => r.cart_items && r.products)\n      .map(r => ({\n        ...r.cart_items!,\n        product: r.products!,\n      }));\n  }\n\n  async addToCart(userId: string, productId: string, quantity: number = 1): Promise<CartItem> {\n    const existing = await db\n      .select()\n      .from(cartItems)\n      .where(and(eq(cartItems.userId, userId), eq(cartItems.productId, productId)));\n\n    if (existing.length > 0) {\n      const newQuantity = existing[0].quantity + quantity;\n      const [updated] = await db\n        .update(cartItems)\n        .set({ quantity: newQuantity, updatedAt: new Date() })\n        .where(eq(cartItems.id, existing[0].id))\n        .returning();\n      return updated;\n    }\n\n    const [created] = await db\n      .insert(cartItems)\n      .values({ userId, productId, quantity })\n      .returning();\n    return created;\n  }\n\n  async updateCartItemQuantity(cartItemId: string, quantity: number): Promise<CartItem> {\n    const [updated] = await db\n      .update(cartItems)\n      .set({ quantity, updatedAt: new Date() })\n      .where(eq(cartItems.id, cartItemId))\n      .returning();\n\n    if (!updated) {\n      throw new Error(`Cart item ${cartItemId} not found`);\n    }\n\n    return updated;\n  }\n\n  async removeFromCart(cartItemId: string): Promise<void> {\n    await db.delete(cartItems).where(eq(cartItems.id, cartItemId));\n  }\n\n  async clearCart(userId: string): Promise<void> {\n    await db.delete(cartItems).where(eq(cartItems.userId, userId));\n  }\n\n  // Game operations\n  async createGame(game: { gameType: string; player1Id: string; stakeAmount: string; mode?: string }): Promise<Game> {\n    const [created] = await db.insert(games).values({\n      gameType: game.gameType as any,\n      player1Id: game.player1Id,\n      stakeAmount: game.stakeAmount,\n      status: \"waiting\",\n      gameData: game.mode ? { mode: game.mode } : null,\n    }).returning();\n    return created;\n  }\n\n  async getGame(id: string): Promise<(Game & { player1: User; player2: User | null }) | undefined> {\n    const result = await db\n      .select()\n      .from(games)\n      .leftJoin(users, eq(games.player1Id, users.id))\n      .where(eq(games.id, id));\n\n    if (result.length === 0 || !result[0].games || !result[0].users) return undefined;\n\n    const game = result[0].games;\n    const player1 = result[0].users;\n\n    let player2: User | null = null;\n    if (game.player2Id) {\n      const [p2] = await db.select().from(users).where(eq(users.id, game.player2Id));\n      player2 = p2 || null;\n    }\n\n    return {\n      ...game,\n      player1,\n      player2,\n    };\n  }\n\n  async getAvailableGames(gameType?: string): Promise<(Game & { player1: User })[]> {\n    let query = db\n      .select()\n      .from(games)\n      .leftJoin(users, eq(games.player1Id, users.id))\n      .where(eq(games.status, \"waiting\"))\n      .orderBy(desc(games.createdAt));\n\n    const results = await query;\n\n    let filtered = results\n      .filter(r => r.games && r.users)\n      .map(r => ({\n        ...r.games!,\n        player1: r.users!,\n      }));\n\n    if (gameType) {\n      filtered = filtered.filter(g => g.gameType === gameType);\n    }\n\n    return filtered;\n  }\n\n  async getUserGames(userId: string): Promise<Game[]> {\n    return await db\n      .select()\n      .from(games)\n      .where(or(eq(games.player1Id, userId), eq(games.player2Id, userId)))\n      .orderBy(desc(games.createdAt));\n  }\n\n  async joinGame(gameId: string, player2Id: string): Promise<Game> {\n    const [game] = await db\n      .select()\n      .from(games)\n      .where(eq(games.id, gameId));\n\n    if (!game) {\n      throw new Error(\"Game not found\");\n    }\n\n    if (game.status !== \"waiting\") {\n      throw new Error(\"Game is not available to join\");\n    }\n\n    if (game.player1Id === player2Id) {\n      throw new Error(\"Cannot join your own game\");\n    }\n\n    const [updated] = await db\n      .update(games)\n      .set({\n        player2Id,\n        status: \"in_progress\",\n        startedAt: new Date(),\n      })\n      .where(eq(games.id, gameId))\n      .returning();\n\n    return updated;\n  }\n\n  async startGame(gameId: string): Promise<Game> {\n    const [updated] = await db\n      .update(games)\n      .set({\n        status: \"in_progress\",\n        startedAt: new Date(),\n      })\n      .where(eq(games.id, gameId))\n      .returning();\n\n    if (!updated) {\n      throw new Error(\"Game not found\");\n    }\n\n    return updated;\n  }\n\n  async completeGame(gameId: string, winnerId: string): Promise<Game> {\n    const [updated] = await db\n      .update(games)\n      .set({\n        status: \"completed\",\n        winnerId,\n        completedAt: new Date(),\n      })\n      .where(eq(games.id, gameId))\n      .returning();\n\n    if (!updated) {\n      throw new Error(\"Game not found\");\n    }\n\n    return updated;\n  }\n\n  async cancelGame(gameId: string): Promise<Game> {\n    const [updated] = await db\n      .update(games)\n      .set({\n        status: \"cancelled\",\n        completedAt: new Date(),\n      })\n      .where(eq(games.id, gameId))\n      .returning();\n\n    if (!updated) {\n      throw new Error(\"Game not found\");\n    }\n\n    return updated;\n  }\n\n  async createGameMatch(match: InsertGameMatch): Promise<GameMatch> {\n    const [created] = await db.insert(gameMatches).values(match).returning();\n    return created;\n  }\n\n  async getGameMatches(gameId: string): Promise<GameMatch[]> {\n    return await db\n      .select()\n      .from(gameMatches)\n      .where(eq(gameMatches.gameId, gameId))\n      .orderBy(gameMatches.roundNumber);\n  }\n\n  // Game score/leaderboard operations\n  async getOrCreateGameScore(userId: string, gameType: string): Promise<GameScore> {\n    const [existing] = await db\n      .select()\n      .from(gameScores)\n      .where(and(eq(gameScores.userId, userId), eq(gameScores.gameType, gameType as any)));\n    \n    if (existing) return existing;\n    \n    const [created] = await db\n      .insert(gameScores)\n      .values({\n        userId,\n        gameType: gameType as any,\n        totalScore: 0,\n        gamesPlayed: 0,\n        gamesWon: 0,\n        highScore: 0,\n        totalEarnings: \"0.00\",\n      })\n      .returning();\n    return created;\n  }\n\n  async updateGameScore(userId: string, gameType: string, won: boolean, score: number, earnings?: string): Promise<GameScore> {\n    const existing = await this.getOrCreateGameScore(userId, gameType);\n    \n    const newTotalScore = existing.totalScore + score;\n    const newGamesPlayed = existing.gamesPlayed + 1;\n    const newGamesWon = won ? existing.gamesWon + 1 : existing.gamesWon;\n    const newHighScore = score > (existing.highScore || 0) ? score : existing.highScore;\n    const newEarnings = earnings \n      ? (parseFloat(existing.totalEarnings || \"0\") + parseFloat(earnings)).toFixed(2)\n      : existing.totalEarnings;\n    \n    const [updated] = await db\n      .update(gameScores)\n      .set({\n        totalScore: newTotalScore,\n        gamesPlayed: newGamesPlayed,\n        gamesWon: newGamesWon,\n        highScore: newHighScore,\n        totalEarnings: newEarnings,\n        updatedAt: new Date(),\n      })\n      .where(eq(gameScores.id, existing.id))\n      .returning();\n    return updated;\n  }\n\n  async getLeaderboard(gameType: string, limit: number = 10): Promise<(GameScore & { user: User })[]> {\n    const results = await db\n      .select()\n      .from(gameScores)\n      .leftJoin(users, eq(gameScores.userId, users.id))\n      .where(eq(gameScores.gameType, gameType as any))\n      .orderBy(desc(gameScores.totalScore))\n      .limit(limit);\n    \n    return results\n      .filter(r => r.game_scores && r.users)\n      .map(r => ({\n        ...r.game_scores!,\n        user: r.users!,\n      }));\n  }\n\n  async getGlobalLeaderboard(limit: number = 10): Promise<any[]> {\n    const results = await db\n      .select({\n        userId: gameScores.userId,\n        totalScore: sql<number>`SUM(${gameScores.totalScore})`.as('total'),\n        gamesPlayed: sql<number>`SUM(${gameScores.gamesPlayed})`.as('games'),\n        gamesWon: sql<number>`SUM(${gameScores.gamesWon})`.as('wins'),\n      })\n      .from(gameScores)\n      .groupBy(gameScores.userId)\n      .orderBy(desc(sql`SUM(${gameScores.totalScore})`))\n      .limit(limit);\n    \n    const userIds = results.map(r => r.userId);\n    const userResults = await db.select().from(users).where(sql`${users.id} IN (${sql.join(userIds.map(id => sql`${id}`), sql`, `)})`);\n    const userMap = new Map(userResults.map(u => [u.id, u]));\n    \n    return results.map(r => ({\n      ...r,\n      user: userMap.get(r.userId),\n      winRate: r.gamesPlayed > 0 ? Math.round((r.gamesWon / r.gamesPlayed) * 100) : 0,\n    }));\n  }\n\n  // Game content operations\n  async getTriviaQuestions(limit: number = 10, category?: string): Promise<TriviaQuestion[]> {\n    let query = db.select().from(triviaQuestions);\n    if (category) {\n      query = query.where(eq(triviaQuestions.category, category)) as any;\n    }\n    return await query.limit(limit);\n  }\n\n  async getRandomTriviaQuestion(): Promise<TriviaQuestion | undefined> {\n    const [question] = await db\n      .select()\n      .from(triviaQuestions)\n      .orderBy(sql`RANDOM()`)\n      .limit(1);\n    return question;\n  }\n\n  async getTypingTexts(limit: number = 10): Promise<TypingText[]> {\n    return await db.select().from(typingTexts).limit(limit);\n  }\n\n  async getRandomTypingText(): Promise<TypingText | undefined> {\n    const [text] = await db\n      .select()\n      .from(typingTexts)\n      .orderBy(sql`RANDOM()`)\n      .limit(1);\n    return text;\n  }\n\n  async getPriceGuessProducts(limit: number = 10): Promise<PriceGuessProduct[]> {\n    return await db.select().from(priceGuessProducts).limit(limit);\n  }\n\n  async getRandomPriceGuessProduct(): Promise<PriceGuessProduct | undefined> {\n    const [product] = await db\n      .select()\n      .from(priceGuessProducts)\n      .orderBy(sql`RANDOM()`)\n      .limit(1);\n    return product;\n  }\n\n  async seedGameContent(): Promise<void> {\n    // Seed trivia questions\n    const existingTrivia = await db.select().from(triviaQuestions).limit(1);\n    if (existingTrivia.length === 0) {\n      await db.insert(triviaQuestions).values([\n        { question: \"What is the capital of Nigeria?\", options: [\"Lagos\", \"Abuja\", \"Kano\", \"Port Harcourt\"], correctAnswer: 1, category: \"Geography\", difficulty: \"easy\" },\n        { question: \"Which Nigerian artist released the song 'Essence'?\", options: [\"Davido\", \"Wizkid\", \"Burna Boy\", \"Olamide\"], correctAnswer: 1, category: \"Music\", difficulty: \"easy\" },\n        { question: \"What year did Nigeria gain independence?\", options: [\"1958\", \"1960\", \"1963\", \"1970\"], correctAnswer: 1, category: \"History\", difficulty: \"easy\" },\n        { question: \"What is the largest city in Nigeria by population?\", options: [\"Abuja\", \"Kano\", \"Lagos\", \"Ibadan\"], correctAnswer: 2, category: \"Geography\", difficulty: \"easy\" },\n        { question: \"Which Nigerian footballer won the African Player of the Year in 2013?\", options: [\"Jay-Jay Okocha\", \"Yobo\", \"Yaya Toure\", \"John Obi Mikel\"], correctAnswer: 2, category: \"Sports\", difficulty: \"medium\" },\n        { question: \"What is the official currency of Nigeria?\", options: [\"Dollar\", \"Naira\", \"Cedi\", \"Rand\"], correctAnswer: 1, category: \"General\", difficulty: \"easy\" },\n        { question: \"Which river is the longest in Nigeria?\", options: [\"Niger\", \"Benue\", \"Ogun\", \"Cross\"], correctAnswer: 0, category: \"Geography\", difficulty: \"medium\" },\n        { question: \"Who was the first President of Nigeria?\", options: [\"Nnamdi Azikiwe\", \"Tafawa Balewa\", \"Aguiyi Ironsi\", \"Yakubu Gowon\"], correctAnswer: 0, category: \"History\", difficulty: \"medium\" },\n        { question: \"What is the traditional dress of the Yoruba people called?\", options: [\"Agbada\", \"Kaftan\", \"Buba\", \"Dashiki\"], correctAnswer: 0, category: \"Culture\", difficulty: \"easy\" },\n        { question: \"Which Nigerian state is known as the 'Centre of Excellence'?\", options: [\"Abuja\", \"Lagos\", \"Rivers\", \"Kano\"], correctAnswer: 1, category: \"Geography\", difficulty: \"easy\" },\n        { question: \"What is Jollof rice?\", options: [\"A dessert\", \"A spicy rice dish\", \"A soup\", \"A drink\"], correctAnswer: 1, category: \"Food\", difficulty: \"easy\" },\n        { question: \"Which Nigerian author wrote 'Things Fall Apart'?\", options: [\"Wole Soyinka\", \"Chinua Achebe\", \"Chimamanda Adichie\", \"Ben Okri\"], correctAnswer: 1, category: \"Literature\", difficulty: \"easy\" },\n      ]);\n    }\n\n    // Seed typing texts\n    const existingTexts = await db.select().from(typingTexts).limit(1);\n    if (existingTexts.length === 0) {\n      await db.insert(typingTexts).values([\n        { text: \"The quick brown fox jumps over the lazy dog.\", wordCount: 9, difficulty: \"easy\" },\n        { text: \"Pack my box with five dozen liquor jugs.\", wordCount: 8, difficulty: \"easy\" },\n        { text: \"How vexingly quick daft zebras jump!\", wordCount: 6, difficulty: \"medium\" },\n        { text: \"The five boxing wizards jump quickly.\", wordCount: 6, difficulty: \"medium\" },\n        { text: \"Sphinx of black quartz, judge my vow.\", wordCount: 7, difficulty: \"medium\" },\n        { text: \"Two driven jocks help fax my big quiz.\", wordCount: 8, difficulty: \"medium\" },\n        { text: \"The early morning sun cast long shadows across the campus as students hurried to their classes.\", wordCount: 16, difficulty: \"hard\" },\n        { text: \"Success is not final, failure is not fatal: it is the courage to continue that counts.\", wordCount: 16, difficulty: \"hard\" },\n        { text: \"Education is the passport to the future, for tomorrow belongs to those who prepare for it today.\", wordCount: 17, difficulty: \"hard\" },\n        { text: \"The greatest glory in living lies not in never falling, but in rising every time we fall.\", wordCount: 17, difficulty: \"hard\" },\n      ]);\n    }\n\n    // Seed price guess products\n    const existingProducts = await db.select().from(priceGuessProducts).limit(1);\n    if (existingProducts.length === 0) {\n      await db.insert(priceGuessProducts).values([\n        { name: \"iPhone 15 Pro Max\", actualPrice: \"1850000.00\", category: \"Electronics\", difficulty: \"medium\" },\n        { name: \"Samsung Galaxy S24 Ultra\", actualPrice: \"1650000.00\", category: \"Electronics\", difficulty: \"medium\" },\n        { name: \"Nike Air Jordan 1\", actualPrice: \"85000.00\", category: \"Fashion\", difficulty: \"easy\" },\n        { name: \"MacBook Pro 14-inch\", actualPrice: \"2400000.00\", category: \"Electronics\", difficulty: \"hard\" },\n        { name: \"PlayStation 5\", actualPrice: \"550000.00\", category: \"Electronics\", difficulty: \"easy\" },\n        { name: \"Ray-Ban Aviator Sunglasses\", actualPrice: \"45000.00\", category: \"Fashion\", difficulty: \"easy\" },\n        { name: \"Louis Vuitton Neverfull Bag\", actualPrice: \"2100000.00\", category: \"Fashion\", difficulty: \"hard\" },\n        { name: \"Apple AirPods Pro\", actualPrice: \"175000.00\", category: \"Electronics\", difficulty: \"easy\" },\n        { name: \"Rolex Submariner\", actualPrice: \"12500000.00\", category: \"Fashion\", difficulty: \"hard\" },\n        { name: \"Nike Air Force 1\", actualPrice: \"55000.00\", category: \"Fashion\", difficulty: \"easy\" },\n      ]);\n    }\n  }\n\n  // Password reset token operations\n  async createPasswordResetToken(userId: string, token: string, expiresAt: Date): Promise<PasswordResetToken> {\n    await db\n      .delete(passwordResetTokens)\n      .where(eq(passwordResetTokens.userId, userId));\n\n    const [created] = await db\n      .insert(passwordResetTokens)\n      .values({ userId, token, expiresAt })\n      .returning();\n    return created;\n  }\n\n  async getPasswordResetToken(token: string): Promise<PasswordResetToken | undefined> {\n    const [resetToken] = await db\n      .select()\n      .from(passwordResetTokens)\n      .where(\n        and(\n          eq(passwordResetTokens.token, token),\n          eq(passwordResetTokens.used, false),\n          gt(passwordResetTokens.expiresAt, new Date())\n        )\n      );\n    return resetToken;\n  }\n\n  async markPasswordResetTokenUsed(token: string): Promise<void> {\n    await db\n      .update(passwordResetTokens)\n      .set({ used: true })\n      .where(eq(passwordResetTokens.token, token));\n  }\n\n  async deleteExpiredPasswordResetTokens(): Promise<void> {\n    await db\n      .delete(passwordResetTokens)\n      .where(\n        or(\n          eq(passwordResetTokens.used, true),\n          sql`${passwordResetTokens.expiresAt} < NOW()`\n        )\n      );\n  }\n\n  async updateUserPassword(userId: string, hashedPassword: string): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ password: hashedPassword, updatedAt: new Date() })\n      .where(eq(users.id, userId))\n      .returning();\n    \n    if (!user) {\n      throw new Error(\"User not found\");\n    }\n    \n    return user;\n  }\n\n  // Announcement operations\n  async createAnnouncement(data: CreateAnnouncementInput & { authorId: string }): Promise<Announcement> {\n    const [announcement] = await db\n      .insert(announcements)\n      .values({\n        authorId: data.authorId,\n        title: data.title,\n        content: data.content,\n        category: data.category,\n        priority: data.priority || \"normal\",\n        isPinned: data.isPinned || false,\n        isPublished: data.isPublished !== false,\n      })\n      .returning();\n    return announcement;\n  }\n\n  async getAnnouncement(id: string): Promise<(Announcement & { author: User }) | undefined> {\n    const [result] = await db\n      .select()\n      .from(announcements)\n      .innerJoin(users, eq(announcements.authorId, users.id))\n      .where(eq(announcements.id, id));\n    \n    if (!result) return undefined;\n    \n    return {\n      ...result.announcements,\n      author: result.users,\n    };\n  }\n\n  async getAnnouncements(includeUnpublished: boolean = false): Promise<(Announcement & { author: User })[]> {\n    let query = db\n      .select()\n      .from(announcements)\n      .innerJoin(users, eq(announcements.authorId, users.id));\n    \n    const conditions = includeUnpublished \n      ? [] \n      : [eq(announcements.isPublished, true)];\n    \n    const results = conditions.length > 0\n      ? await query.where(and(...conditions)).orderBy(desc(announcements.isPinned), desc(announcements.createdAt))\n      : await query.orderBy(desc(announcements.isPinned), desc(announcements.createdAt));\n    \n    return results.map(r => ({\n      ...r.announcements,\n      author: r.users,\n    }));\n  }\n\n  async updateAnnouncement(id: string, data: UpdateAnnouncementInput): Promise<Announcement> {\n    const [announcement] = await db\n      .update(announcements)\n      .set({\n        ...data,\n        updatedAt: new Date(),\n      })\n      .where(eq(announcements.id, id))\n      .returning();\n    \n    if (!announcement) {\n      throw new Error(\"Announcement not found\");\n    }\n    \n    return announcement;\n  }\n\n  async deleteAnnouncement(id: string): Promise<void> {\n    await db.delete(announcements).where(eq(announcements.id, id));\n  }\n\n  async incrementAnnouncementViews(id: string): Promise<void> {\n    await db\n      .update(announcements)\n      .set({ views: sql`COALESCE(${announcements.views}, 0) + 1` })\n      .where(eq(announcements.id, id));\n  }\n\n  async markAnnouncementAsRead(userId: string, announcementId: string): Promise<AnnouncementRead> {\n    const existing = await db\n      .select()\n      .from(announcementReads)\n      .where(\n        and(\n          eq(announcementReads.userId, userId),\n          eq(announcementReads.announcementId, announcementId)\n        )\n      );\n    \n    if (existing.length > 0) {\n      return existing[0];\n    }\n    \n    const [read] = await db\n      .insert(announcementReads)\n      .values({ userId, announcementId })\n      .returning();\n    \n    return read;\n  }\n\n  async getUserAnnouncementReads(userId: string): Promise<AnnouncementRead[]> {\n    return await db\n      .select()\n      .from(announcementReads)\n      .where(eq(announcementReads.userId, userId));\n  }\n\n  async isAnnouncementRead(userId: string, announcementId: string): Promise<boolean> {\n    const [result] = await db\n      .select()\n      .from(announcementReads)\n      .where(\n        and(\n          eq(announcementReads.userId, userId),\n          eq(announcementReads.announcementId, announcementId)\n        )\n      );\n    return !!result;\n  }\n\n  // Social post operations (\"The Plug\")\n  async getSocialPostById(postId: string): Promise<SocialPost | undefined> {\n    const [post] = await db.select().from(socialPosts).where(eq(socialPosts.id, postId));\n    return post;\n  }\n\n  async getSocialPosts(options?: { authorId?: string; followingOnly?: boolean; userId?: string }): Promise<(SocialPost & { author: User; isLiked?: boolean; isFollowingAuthor?: boolean; isReposted?: boolean })[]> {\n    let query = db\n      .select()\n      .from(socialPosts)\n      .leftJoin(users, eq(socialPosts.authorId, users.id))\n      .where(eq(socialPosts.isVisible, true))\n      .orderBy(desc(socialPosts.createdAt));\n\n    const results = await query;\n    let posts = results\n      .filter(r => r.social_posts && r.users)\n      .map(r => ({\n        ...r.social_posts!,\n        author: r.users!,\n      }));\n\n    // Filter by author if specified\n    if (options?.authorId) {\n      posts = posts.filter(p => p.authorId === options.authorId);\n    }\n\n    // Get following list for both filtering and display\n    let followingIds = new Set<string>();\n    if (options?.userId) {\n      const followingResult = await db\n        .select({ followingId: follows.followingId })\n        .from(follows)\n        .where(eq(follows.followerId, options.userId));\n      \n      followingIds = new Set(followingResult.map(f => f.followingId));\n    }\n\n    // Filter by following only if specified\n    if (options?.followingOnly && options?.userId) {\n      posts = posts.filter(p => followingIds.has(p.authorId));\n    }\n\n    // Add isLiked, isFollowingAuthor, and isReposted status if userId is provided\n    if (options?.userId) {\n      const [likedPosts, repostedPosts] = await Promise.all([\n        db.select({ postId: socialPostLikes.postId })\n          .from(socialPostLikes)\n          .where(eq(socialPostLikes.userId, options.userId)),\n        db.select({ originalPostId: socialPostReposts.originalPostId })\n          .from(socialPostReposts)\n          .where(eq(socialPostReposts.reposterId, options.userId))\n      ]);\n      \n      const likedPostIds = new Set(likedPosts.map(l => l.postId));\n      const repostedPostIds = new Set(repostedPosts.map(r => r.originalPostId));\n      \n      return posts.map(p => ({\n        ...p,\n        isLiked: likedPostIds.has(p.id),\n        isFollowingAuthor: followingIds.has(p.authorId),\n        isReposted: repostedPostIds.has(p.id),\n      }));\n    }\n\n    return posts;\n  }\n\n  async createSocialPost(post: { authorId: string; content: string; images?: string[]; videos?: string[] }): Promise<SocialPost> {\n    const [created] = await db\n      .insert(socialPosts)\n      .values({\n        authorId: post.authorId,\n        content: post.content,\n        images: post.images || [],\n        videos: post.videos || [],\n      })\n      .returning();\n    return created;\n  }\n\n  async getSocialPost(id: string): Promise<(SocialPost & { author: User }) | undefined> {\n    const [result] = await db\n      .select()\n      .from(socialPosts)\n      .leftJoin(users, eq(socialPosts.authorId, users.id))\n      .where(eq(socialPosts.id, id));\n    \n    if (!result || !result.social_posts || !result.users) return undefined;\n    \n    return {\n      ...result.social_posts,\n      author: result.users,\n    };\n  }\n\n  async likeSocialPost(postId: string, userId: string): Promise<SocialPostLike> {\n    // Check if already liked\n    const existing = await db\n      .select()\n      .from(socialPostLikes)\n      .where(\n        and(\n          eq(socialPostLikes.postId, postId),\n          eq(socialPostLikes.userId, userId)\n        )\n      );\n\n    if (existing.length > 0) {\n      return existing[0];\n    }\n\n    // Create like\n    const [like] = await db\n      .insert(socialPostLikes)\n      .values({ postId, userId })\n      .returning();\n\n    // Increment likes count\n    await db\n      .update(socialPosts)\n      .set({ likesCount: sql`COALESCE(${socialPosts.likesCount}, 0) + 1` })\n      .where(eq(socialPosts.id, postId));\n\n    return like;\n  }\n\n  async unlikeSocialPost(postId: string, userId: string): Promise<void> {\n    const result = await db\n      .delete(socialPostLikes)\n      .where(\n        and(\n          eq(socialPostLikes.postId, postId),\n          eq(socialPostLikes.userId, userId)\n        )\n      )\n      .returning();\n\n    // Decrement likes count only if we actually deleted a like\n    if (result.length > 0) {\n      await db\n        .update(socialPosts)\n        .set({ likesCount: sql`GREATEST(COALESCE(${socialPosts.likesCount}, 0) - 1, 0)` })\n        .where(eq(socialPosts.id, postId));\n    }\n  }\n\n  async isPostLiked(postId: string, userId: string): Promise<boolean> {\n    const [result] = await db\n      .select()\n      .from(socialPostLikes)\n      .where(\n        and(\n          eq(socialPostLikes.postId, postId),\n          eq(socialPostLikes.userId, userId)\n        )\n      );\n    return !!result;\n  }\n\n  async getPostComments(postId: string): Promise<(SocialPostComment & { author: User })[]> {\n    const results = await db\n      .select()\n      .from(socialPostComments)\n      .leftJoin(users, eq(socialPostComments.authorId, users.id))\n      .where(eq(socialPostComments.postId, postId))\n      .orderBy(socialPostComments.createdAt);\n\n    return results\n      .filter(r => r.social_post_comments && r.users)\n      .map(r => ({\n        ...r.social_post_comments!,\n        author: r.users!,\n      }));\n  }\n\n  async createPostComment(comment: { postId: string; authorId: string; content: string }): Promise<SocialPostComment> {\n    const [created] = await db\n      .insert(socialPostComments)\n      .values(comment)\n      .returning();\n\n    // Increment comments count\n    await db\n      .update(socialPosts)\n      .set({ commentsCount: sql`COALESCE(${socialPosts.commentsCount}, 0) + 1` })\n      .where(eq(socialPosts.id, comment.postId));\n\n    return created;\n  }\n\n  async deleteSocialPost(postId: string): Promise<void> {\n    await db.delete(socialPosts).where(eq(socialPosts.id, postId));\n  }\n\n  async repostSocialPost(postId: string, userId: string, quoteContent?: string): Promise<SocialPostRepost> {\n    // Check if already reposted\n    const existing = await db\n      .select()\n      .from(socialPostReposts)\n      .where(\n        and(\n          eq(socialPostReposts.originalPostId, postId),\n          eq(socialPostReposts.reposterId, userId)\n        )\n      );\n\n    if (existing.length > 0) {\n      return existing[0];\n    }\n\n    // Create repost\n    const [repost] = await db\n      .insert(socialPostReposts)\n      .values({ originalPostId: postId, reposterId: userId, quoteContent })\n      .returning();\n\n    // Increment reposts count\n    await db\n      .update(socialPosts)\n      .set({ repostsCount: sql`COALESCE(${socialPosts.repostsCount}, 0) + 1` })\n      .where(eq(socialPosts.id, postId));\n\n    return repost;\n  }\n\n  async unrepostSocialPost(postId: string, userId: string): Promise<void> {\n    const result = await db\n      .delete(socialPostReposts)\n      .where(\n        and(\n          eq(socialPostReposts.originalPostId, postId),\n          eq(socialPostReposts.reposterId, userId)\n        )\n      )\n      .returning();\n\n    // Decrement reposts count only if we actually deleted a repost\n    if (result.length > 0) {\n      await db\n        .update(socialPosts)\n        .set({ repostsCount: sql`GREATEST(COALESCE(${socialPosts.repostsCount}, 0) - 1, 0)` })\n        .where(eq(socialPosts.id, postId));\n    }\n  }\n\n  async isPostReposted(postId: string, userId: string): Promise<boolean> {\n    const [result] = await db\n      .select()\n      .from(socialPostReposts)\n      .where(\n        and(\n          eq(socialPostReposts.originalPostId, postId),\n          eq(socialPostReposts.reposterId, userId)\n        )\n      );\n    return !!result;\n  }\n\n  async getPostReposts(postId: string): Promise<(SocialPostRepost & { reposter: User })[]> {\n    const results = await db\n      .select()\n      .from(socialPostReposts)\n      .leftJoin(users, eq(socialPostReposts.reposterId, users.id))\n      .where(eq(socialPostReposts.originalPostId, postId))\n      .orderBy(desc(socialPostReposts.createdAt));\n\n    return results\n      .filter(r => r.social_post_reposts && r.users)\n      .map(r => ({\n        ...r.social_post_reposts!,\n        reposter: r.users!,\n      }));\n  }\n\n  // Post bookmark operations\n  async bookmarkPost(userId: string, postId: string): Promise<PostBookmark> {\n    const [existing] = await db\n      .select()\n      .from(postBookmarks)\n      .where(and(eq(postBookmarks.userId, userId), eq(postBookmarks.postId, postId)));\n    \n    if (existing) return existing;\n    \n    const [bookmark] = await db.insert(postBookmarks).values({ userId, postId }).returning();\n    return bookmark;\n  }\n\n  async unbookmarkPost(userId: string, postId: string): Promise<void> {\n    await db\n      .delete(postBookmarks)\n      .where(and(eq(postBookmarks.userId, userId), eq(postBookmarks.postId, postId)));\n  }\n\n  async isPostBookmarked(userId: string, postId: string): Promise<boolean> {\n    const [result] = await db\n      .select()\n      .from(postBookmarks)\n      .where(and(eq(postBookmarks.userId, userId), eq(postBookmarks.postId, postId)));\n    return !!result;\n  }\n\n  async getUserBookmarks(userId: string): Promise<(PostBookmark & { post: SocialPost; author: User })[]> {\n    const results = await db\n      .select()\n      .from(postBookmarks)\n      .leftJoin(socialPosts, eq(postBookmarks.postId, socialPosts.id))\n      .leftJoin(users, eq(socialPosts.authorId, users.id))\n      .where(eq(postBookmarks.userId, userId))\n      .orderBy(desc(postBookmarks.createdAt));\n\n    return results\n      .filter(r => r.post_bookmarks && r.social_posts && r.users)\n      .map(r => ({\n        ...r.post_bookmarks!,\n        post: r.social_posts!,\n        author: r.users!,\n      }));\n  }\n\n  // Smart feed algorithm operations with location-based ranking\n  // \"Fear-based\" algorithm: Campus users first, then by distance, then by engagement\n  async getSocialPostsWithAlgorithm(options?: { userId?: string; feedType?: 'for_you' | 'following'; userLat?: number; userLng?: number }): Promise<(SocialPost & { author: User; isLiked?: boolean; isFollowingAuthor?: boolean; isReposted?: boolean; engagementScore?: string; authorDistance?: number | null })[]> {\n    const feedType = options?.feedType || 'for_you';\n    \n    // EKSU Campus coordinates\n    const EKSU_LAT = 7.6451;\n    const EKSU_LNG = 5.2247;\n    const CAMPUS_RADIUS_KM = 1.5;\n    \n    let query = db\n      .select()\n      .from(socialPosts)\n      .leftJoin(users, eq(socialPosts.authorId, users.id))\n      .leftJoin(feedEngagementScores, eq(socialPosts.id, feedEngagementScores.postId))\n      .where(eq(socialPosts.isVisible, true));\n    \n    // Get following list for logged-in users (needed for isFollowingAuthor in all feeds)\n    let followingIds: string[] = [];\n    if (options?.userId) {\n      const followingList = await db\n        .select({ followingId: follows.followingId })\n        .from(follows)\n        .where(eq(follows.followerId, options.userId));\n      followingIds = followingList.map(f => f.followingId);\n    }\n    \n    const results = await query.orderBy(desc(socialPosts.createdAt)).limit(100);\n\n    let likedPostIds: string[] = [];\n    let repostedPostIds: string[] = [];\n    \n    if (options?.userId) {\n      const [likedResult, repostedResult] = await Promise.all([\n        db.select({ postId: socialPostLikes.postId })\n          .from(socialPostLikes)\n          .where(eq(socialPostLikes.userId, options.userId)),\n        db.select({ originalPostId: socialPostReposts.originalPostId })\n          .from(socialPostReposts)\n          .where(eq(socialPostReposts.reposterId, options.userId))\n      ]);\n      likedPostIds = likedResult.map(l => l.postId);\n      repostedPostIds = repostedResult.map(r => r.originalPostId);\n    }\n\n    // Calculate distance between two coordinates (Haversine formula)\n    const calculateDistance = (lat1: number, lon1: number, lat2: number, lon2: number): number => {\n      const R = 6371; // Earth's radius in km\n      const dLat = (lat2 - lat1) * Math.PI / 180;\n      const dLon = (lon2 - lon1) * Math.PI / 180;\n      const a = \n        Math.sin(dLat/2) * Math.sin(dLat/2) +\n        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * \n        Math.sin(dLon/2) * Math.sin(dLon/2);\n      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));\n      return R * c;\n    };\n\n    const postsWithDistance = results\n      .filter(r => r.social_posts && r.users)\n      .filter(r => {\n        if (feedType === 'following' && options?.userId) {\n          return followingIds.includes(r.social_posts!.authorId) || r.social_posts!.authorId === options.userId;\n        }\n        return true;\n      })\n      .map(r => {\n        const authorLat = r.users!.latitude ? parseFloat(r.users!.latitude) : null;\n        const authorLng = r.users!.longitude ? parseFloat(r.users!.longitude) : null;\n        \n        // Calculate author's distance from campus\n        let authorDistance: number | null = null;\n        let isOnCampus = false;\n        \n        if (authorLat !== null && authorLng !== null) {\n          const distFromCampus = calculateDistance(authorLat, authorLng, EKSU_LAT, EKSU_LNG);\n          authorDistance = distFromCampus;\n          isOnCampus = distFromCampus <= CAMPUS_RADIUS_KM;\n        }\n        \n        // Calculate distance from current user (if location provided)\n        let distanceFromUser: number | null = null;\n        if (options?.userLat && options?.userLng && authorLat !== null && authorLng !== null) {\n          distanceFromUser = calculateDistance(options.userLat, options.userLng, authorLat, authorLng);\n        }\n        \n        const engagementScore = parseFloat(r.feed_engagement_scores?.engagementScore || \"0\");\n        const recencyBonus = r.feed_engagement_scores?.recencyBonus ? parseFloat(r.feed_engagement_scores.recencyBonus) : 0;\n        \n        // Calculate ranking score (Fear-based algorithm)\n        // Priority: 1. On-campus authors (highest), 2. Nearby authors, 3. Engagement\n        let rankingScore = engagementScore + recencyBonus;\n        \n        if (isOnCampus) {\n          rankingScore += 1000; // Huge boost for on-campus\n        } else if (authorDistance !== null && authorDistance <= 5) {\n          rankingScore += 500; // Near campus boost\n        } else if (authorDistance !== null && authorDistance <= 15) {\n          rankingScore += 200; // In Ado-Ekiti boost\n        } else if (authorDistance !== null && authorDistance <= 100) {\n          rankingScore += 50; // In Ekiti State boost\n        }\n        \n        // Extra boost for nearby users (relative to viewer)\n        if (distanceFromUser !== null && distanceFromUser <= 3) {\n          rankingScore += 300;\n        }\n        \n        // Enhanced recency bonus - prioritize very recent posts\n        const postAge = Date.now() - new Date(r.social_posts!.createdAt || Date.now()).getTime();\n        const hoursOld = postAge / (1000 * 60 * 60);\n        \n        // Strong recency boost for very fresh posts (within 2 hours)\n        if (hoursOld <= 2) {\n          rankingScore += 500 + Math.max(0, 200 - (hoursOld * 100)); // 500-700 points for < 2 hours\n        } else if (hoursOld <= 6) {\n          rankingScore += 300 + Math.max(0, 200 - ((hoursOld - 2) * 50)); // 300-500 points for 2-6 hours\n        } else if (hoursOld <= 12) {\n          rankingScore += 200 + Math.max(0, 100 - ((hoursOld - 6) * 16.67)); // 200-300 points for 6-12 hours\n        } else if (hoursOld <= 24) {\n          rankingScore += Math.max(0, 200 - ((hoursOld - 12) * 16.67)); // 0-200 points for 12-24 hours\n        } else if (hoursOld <= 72) {\n          rankingScore += Math.max(0, 50 - ((hoursOld - 24) * 1)); // Small bonus for last 3 days\n        }\n        // Posts older than 3 days get no recency bonus\n        \n        return {\n          ...r.social_posts!,\n          author: r.users!,\n          isLiked: likedPostIds.includes(r.social_posts!.id),\n          isFollowingAuthor: followingIds.includes(r.social_posts!.authorId),\n          isReposted: repostedPostIds.includes(r.social_posts!.id),\n          engagementScore: r.feed_engagement_scores?.engagementScore || \"0\",\n          authorDistance,\n          _rankingScore: rankingScore,\n        };\n      });\n\n    // Sort by ranking score for 'for_you' feed, by date for 'following' feed\n    if (feedType === 'for_you') {\n      postsWithDistance.sort((a, b) => (b._rankingScore || 0) - (a._rankingScore || 0));\n    }\n    \n    // Remove internal ranking score and limit results\n    return postsWithDistance.slice(0, 50).map(({ _rankingScore, ...post }) => post);\n  }\n\n  async updatePostEngagementScore(postId: string): Promise<void> {\n    const [post] = await db.select().from(socialPosts).where(eq(socialPosts.id, postId));\n    if (!post) return;\n\n    // Calculate engagement score based on likes, comments, reposts, shares, views\n    const likesWeight = 1;\n    const commentsWeight = 3;\n    const repostsWeight = 5;\n    const sharesWeight = 2;\n    const viewsWeight = 0.1;\n    \n    const score = (\n      (post.likesCount || 0) * likesWeight +\n      (post.commentsCount || 0) * commentsWeight +\n      (post.repostsCount || 0) * repostsWeight +\n      (post.sharesCount || 0) * sharesWeight +\n      (post.viewsCount || 0) * viewsWeight\n    );\n    \n    // Calculate velocity (engagement in last 24 hours)\n    const hoursOld = Math.max(1, (Date.now() - new Date(post.createdAt || Date.now()).getTime()) / (1000 * 60 * 60));\n    const velocity = score / hoursOld;\n    \n    // Recency bonus (decays over time)\n    const recencyBonus = Math.max(0, 10 - hoursOld / 2.4);\n    \n    const [existing] = await db.select().from(feedEngagementScores).where(eq(feedEngagementScores.postId, postId));\n    \n    if (existing) {\n      await db.update(feedEngagementScores)\n        .set({ \n          engagementScore: score.toFixed(4), \n          velocityScore: velocity.toFixed(4),\n          recencyBonus: recencyBonus.toFixed(4),\n          calculatedAt: new Date()\n        })\n        .where(eq(feedEngagementScores.postId, postId));\n    } else {\n      await db.insert(feedEngagementScores).values({\n        postId,\n        engagementScore: score.toFixed(4),\n        velocityScore: velocity.toFixed(4),\n        recencyBonus: recencyBonus.toFixed(4),\n      });\n    }\n  }\n\n  async incrementPostViews(postId: string): Promise<void> {\n    await db\n      .update(socialPosts)\n      .set({ viewsCount: sql`COALESCE(${socialPosts.viewsCount}, 0) + 1` })\n      .where(eq(socialPosts.id, postId));\n  }\n\n  async incrementPostShares(postId: string): Promise<void> {\n    await db\n      .update(socialPosts)\n      .set({ sharesCount: sql`COALESCE(${socialPosts.sharesCount}, 0) + 1` })\n      .where(eq(socialPosts.id, postId));\n  }\n\n  // Unique post view tracking methods (1 view per user per 24 hours)\n  async hasViewedPost(postId: string, viewerId: string): Promise<boolean> {\n    // Check if viewer has viewed this post in the last 24 hours\n    const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n    const existing = await db\n      .select()\n      .from(socialPostViews)\n      .where(\n        and(\n          eq(socialPostViews.postId, postId),\n          eq(socialPostViews.viewerId, viewerId),\n          gt(socialPostViews.createdAt, twentyFourHoursAgo)\n        )\n      )\n      .limit(1);\n    return existing.length > 0;\n  }\n\n  async recordUniquePostView(postId: string, viewerId: string): Promise<boolean> {\n    // Check if this viewer has already viewed this post in the last 24 hours\n    const hasViewed = await this.hasViewedPost(postId, viewerId);\n    \n    if (!hasViewed) {\n      // Record the new view\n      await db.insert(socialPostViews).values({\n        postId,\n        viewerId,\n      });\n      // Increment the post's view counter\n      await this.incrementPostViews(postId);\n      // Update engagement score\n      await this.updatePostEngagementScore(postId);\n      return true; // New unique view recorded\n    }\n    \n    return false; // Already viewed within 24 hours, no increment\n  }\n\n  async updateUserLocation(userId: string, latitude: string, longitude: string): Promise<User> {\n    const [updated] = await db\n      .update(users)\n      .set({ \n        latitude, \n        longitude, \n        lastLocationUpdate: new Date(),\n        updatedAt: new Date() \n      })\n      .where(eq(users.id, userId))\n      .returning();\n    return updated;\n  }\n\n  // Username and system account operations\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username.toLowerCase()));\n    return user;\n  }\n\n  async updateUsername(userId: string, username: string): Promise<User> {\n    const [updated] = await db\n      .update(users)\n      .set({ username: username.toLowerCase(), updatedAt: new Date() })\n      .where(eq(users.id, userId))\n      .returning();\n    return updated;\n  }\n\n  async getSystemAccount(type: string): Promise<User | undefined> {\n    const [user] = await db\n      .select()\n      .from(users)\n      .where(and(eq(users.isSystemAccount, true), eq(users.systemAccountType, type)));\n    return user;\n  }\n\n  async createSystemAccount(data: { email: string; username: string; firstName: string; lastName: string; type: string; bio?: string; profileImageUrl?: string }): Promise<User> {\n    const [user] = await db.insert(users).values({\n      email: data.email,\n      username: data.username.toLowerCase(),\n      firstName: data.firstName,\n      lastName: data.lastName,\n      bio: data.bio,\n      profileImageUrl: data.profileImageUrl,\n      isSystemAccount: true,\n      systemAccountType: data.type,\n      isVerified: true,\n      isActive: true,\n    }).returning();\n    return user;\n  }\n\n  // Enhanced social post operations\n  async createSocialPostWithOptions(post: { authorId: string; content: string; images?: string[]; videos?: string[]; replyRestriction?: string; mentionedUserIds?: string[]; hashtags?: string[]; isFromSystemAccount?: boolean }): Promise<SocialPost> {\n    const [created] = await db.insert(socialPosts).values({\n      authorId: post.authorId,\n      content: post.content,\n      images: post.images || [],\n      videos: post.videos || [],\n      replyRestriction: (post.replyRestriction as any) || 'everyone',\n      mentionedUserIds: post.mentionedUserIds || [],\n      hashtags: post.hashtags || [],\n      isFromSystemAccount: post.isFromSystemAccount || false,\n    }).returning();\n    \n    // Calculate initial engagement score\n    await this.updatePostEngagementScore(created.id);\n    \n    return created;\n  }\n\n  async updateSocialPost(postId: string, data: Partial<SocialPost>): Promise<SocialPost> {\n    const [updated] = await db\n      .update(socialPosts)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(socialPosts.id, postId))\n      .returning();\n    return updated;\n  }\n\n  async pinSocialPost(postId: string): Promise<void> {\n    await db.update(socialPosts).set({ isPinned: true }).where(eq(socialPosts.id, postId));\n  }\n\n  async unpinSocialPost(postId: string): Promise<void> {\n    await db.update(socialPosts).set({ isPinned: false }).where(eq(socialPosts.id, postId));\n  }\n\n  async getUserPinnedPosts(userId: string): Promise<(SocialPost & { author: User })[]> {\n    const results = await db\n      .select()\n      .from(socialPosts)\n      .leftJoin(users, eq(socialPosts.authorId, users.id))\n      .where(and(eq(socialPosts.authorId, userId), eq(socialPosts.isPinned, true)))\n      .orderBy(desc(socialPosts.createdAt));\n\n    return results\n      .filter(r => r.social_posts && r.users)\n      .map(r => ({\n        ...r.social_posts!,\n        author: r.users!,\n      }));\n  }\n\n  // Squad payment operations\n  async createSquadPayment(payment: InsertSquadPayment): Promise<SquadPayment> {\n    const [created] = await db.insert(squadPayments).values(payment).returning();\n    return created;\n  }\n\n  async getSquadPayment(id: string): Promise<SquadPayment | undefined> {\n    const [payment] = await db.select().from(squadPayments).where(eq(squadPayments.id, id));\n    return payment;\n  }\n\n  async getSquadPaymentByReference(transactionReference: string): Promise<SquadPayment | undefined> {\n    const [payment] = await db.select().from(squadPayments).where(eq(squadPayments.transactionReference, transactionReference));\n    return payment;\n  }\n\n  async updateSquadPaymentStatus(transactionReference: string, status: string, paidAt?: Date): Promise<SquadPayment | undefined> {\n    const updateData: any = { status, updatedAt: new Date() };\n    if (paidAt) {\n      updateData.paidAt = paidAt;\n    }\n    const [updated] = await db\n      .update(squadPayments)\n      .set(updateData)\n      .where(eq(squadPayments.transactionReference, transactionReference))\n      .returning();\n    return updated;\n  }\n\n  async getUserSquadPayments(userId: string): Promise<SquadPayment[]> {\n    return await db\n      .select()\n      .from(squadPayments)\n      .where(eq(squadPayments.userId, userId))\n      .orderBy(desc(squadPayments.createdAt));\n  }\n\n  // Squad transfer operations\n  async createSquadTransfer(transfer: InsertSquadTransfer): Promise<SquadTransfer> {\n    const [created] = await db.insert(squadTransfers).values(transfer).returning();\n    return created;\n  }\n\n  async getSquadTransferByReference(transactionReference: string): Promise<SquadTransfer | undefined> {\n    const [transfer] = await db.select().from(squadTransfers).where(eq(squadTransfers.transactionReference, transactionReference));\n    return transfer;\n  }\n\n  async updateSquadTransferStatus(transactionReference: string, status: string, responseMessage?: string, completedAt?: Date): Promise<SquadTransfer | undefined> {\n    const updateData: any = { status };\n    if (responseMessage) {\n      updateData.responseMessage = responseMessage;\n    }\n    if (completedAt) {\n      updateData.completedAt = completedAt;\n    }\n    const [updated] = await db\n      .update(squadTransfers)\n      .set(updateData)\n      .where(eq(squadTransfers.transactionReference, transactionReference))\n      .returning();\n    return updated;\n  }\n\n  // Negotiation operations\n  async createNegotiation(negotiation: InsertNegotiation): Promise<Negotiation> {\n    const [created] = await db.insert(negotiations).values(negotiation).returning();\n    return created;\n  }\n\n  async getNegotiation(id: string): Promise<Negotiation | undefined> {\n    const [negotiation] = await db.select().from(negotiations).where(eq(negotiations.id, id));\n    return negotiation;\n  }\n\n  async getProductNegotiations(productId: string): Promise<Negotiation[]> {\n    return await db\n      .select()\n      .from(negotiations)\n      .where(eq(negotiations.productId, productId))\n      .orderBy(desc(negotiations.createdAt));\n  }\n\n  async getUserNegotiations(userId: string): Promise<Negotiation[]> {\n    return await db\n      .select()\n      .from(negotiations)\n      .where(or(eq(negotiations.buyerId, userId), eq(negotiations.sellerId, userId)))\n      .orderBy(desc(negotiations.createdAt));\n  }\n\n  async updateNegotiationStatus(id: string, status: string, data?: Partial<Negotiation>): Promise<Negotiation | undefined> {\n    const updateData: any = { status, updatedAt: new Date(), ...data };\n    const [updated] = await db\n      .update(negotiations)\n      .set(updateData)\n      .where(eq(negotiations.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Order operations\n  async createOrder(order: InsertOrder): Promise<Order> {\n    const [created] = await db.insert(orders).values(order).returning();\n    return created;\n  }\n\n  async getOrder(id: string): Promise<Order | undefined> {\n    const [order] = await db.select().from(orders).where(eq(orders.id, id));\n    return order;\n  }\n\n  async getOrderByNumber(orderNumber: string): Promise<Order | undefined> {\n    const [order] = await db.select().from(orders).where(eq(orders.orderNumber, orderNumber));\n    return order;\n  }\n\n  async getBuyerOrders(buyerId: string): Promise<Order[]> {\n    return await db\n      .select()\n      .from(orders)\n      .where(eq(orders.buyerId, buyerId))\n      .orderBy(desc(orders.createdAt));\n  }\n\n  async getSellerOrders(sellerId: string): Promise<Order[]> {\n    return await db\n      .select()\n      .from(orders)\n      .where(eq(orders.sellerId, sellerId))\n      .orderBy(desc(orders.createdAt));\n  }\n\n  async updateOrderStatus(orderId: string, status: string, changedBy: string, notes?: string): Promise<Order> {\n    const currentOrder = await this.getOrder(orderId);\n    const fromStatus = currentOrder?.status || null;\n    \n    const timestampField = this.getTimestampFieldForStatus(status);\n    const updateData: any = { \n      status, \n      updatedAt: new Date(),\n    };\n    \n    if (timestampField) {\n      updateData[timestampField] = new Date();\n    }\n    \n    const [updated] = await db\n      .update(orders)\n      .set(updateData)\n      .where(eq(orders.id, orderId))\n      .returning();\n    \n    await this.addOrderStatusHistory({\n      orderId,\n      fromStatus,\n      toStatus: status as \"pending\" | \"paid\" | \"seller_confirmed\" | \"preparing\" | \"ready_for_pickup\" | \"shipped\" | \"out_for_delivery\" | \"delivered\" | \"buyer_confirmed\" | \"completed\" | \"cancelled\" | \"disputed\" | \"refunded\",\n      changedBy,\n      notes,\n    });\n    \n    return updated;\n  }\n\n  private getTimestampFieldForStatus(status: string): string | null {\n    const statusTimestampMap: Record<string, string> = {\n      'paid': 'paidAt',\n      'seller_confirmed': 'sellerConfirmedAt',\n      'preparing': 'preparingAt',\n      'ready_for_pickup': 'readyAt',\n      'shipped': 'shippedAt',\n      'out_for_delivery': 'outForDeliveryAt',\n      'delivered': 'deliveredAt',\n      'buyer_confirmed': 'buyerConfirmedAt',\n      'completed': 'completedAt',\n      'cancelled': 'cancelledAt',\n    };\n    return statusTimestampMap[status] || null;\n  }\n\n  async addOrderStatusHistory(history: InsertOrderStatusHistory): Promise<OrderStatusHistory> {\n    const [created] = await db.insert(orderStatusHistory).values(history).returning();\n    return created;\n  }\n\n  async getOrderStatusHistory(orderId: string): Promise<OrderStatusHistory[]> {\n    return await db\n      .select()\n      .from(orderStatusHistory)\n      .where(eq(orderStatusHistory.orderId, orderId))\n      .orderBy(desc(orderStatusHistory.createdAt));\n  }\n\n  // User relationship operations (block/mute/report)\n  async blockUser(blockerId: string, blockedId: string): Promise<UserBlock> {\n    const existing = await db\n      .select()\n      .from(userBlocks)\n      .where(and(eq(userBlocks.blockerId, blockerId), eq(userBlocks.blockedId, blockedId)));\n    \n    if (existing.length > 0) {\n      return existing[0];\n    }\n    \n    const [block] = await db.insert(userBlocks).values({ blockerId, blockedId }).returning();\n    return block;\n  }\n\n  async unblockUser(blockerId: string, blockedId: string): Promise<void> {\n    await db\n      .delete(userBlocks)\n      .where(and(eq(userBlocks.blockerId, blockerId), eq(userBlocks.blockedId, blockedId)));\n  }\n\n  async muteUser(muterId: string, mutedId: string): Promise<UserMute> {\n    const existing = await db\n      .select()\n      .from(userMutes)\n      .where(and(eq(userMutes.muterId, muterId), eq(userMutes.mutedId, mutedId)));\n    \n    if (existing.length > 0) {\n      return existing[0];\n    }\n    \n    const [mute] = await db.insert(userMutes).values({ muterId, mutedId }).returning();\n    return mute;\n  }\n\n  async unmuteUser(muterId: string, mutedId: string): Promise<void> {\n    await db\n      .delete(userMutes)\n      .where(and(eq(userMutes.muterId, muterId), eq(userMutes.mutedId, mutedId)));\n  }\n\n  async isUserBlocked(userId: string, targetId: string): Promise<boolean> {\n    const [block] = await db\n      .select()\n      .from(userBlocks)\n      .where(and(eq(userBlocks.blockerId, userId), eq(userBlocks.blockedId, targetId)));\n    return !!block;\n  }\n\n  async isUserMuted(userId: string, targetId: string): Promise<boolean> {\n    const [mute] = await db\n      .select()\n      .from(userMutes)\n      .where(and(eq(userMutes.muterId, userId), eq(userMutes.mutedId, targetId)));\n    return !!mute;\n  }\n\n  async getBlockedUsers(userId: string): Promise<(UserBlock & { blockedUser: User })[]> {\n    const blocks = await db\n      .select()\n      .from(userBlocks)\n      .where(eq(userBlocks.blockerId, userId))\n      .orderBy(desc(userBlocks.createdAt));\n    \n    const result: (UserBlock & { blockedUser: User })[] = [];\n    for (const block of blocks) {\n      const [blockedUser] = await db.select().from(users).where(eq(users.id, block.blockedId));\n      if (blockedUser) {\n        result.push({ ...block, blockedUser });\n      }\n    }\n    return result;\n  }\n\n  async getMutedUsers(userId: string): Promise<(UserMute & { mutedUser: User })[]> {\n    const mutes = await db\n      .select()\n      .from(userMutes)\n      .where(eq(userMutes.muterId, userId))\n      .orderBy(desc(userMutes.createdAt));\n    \n    const result: (UserMute & { mutedUser: User })[] = [];\n    for (const mute of mutes) {\n      const [mutedUser] = await db.select().from(users).where(eq(users.id, mute.mutedId));\n      if (mutedUser) {\n        result.push({ ...mute, mutedUser });\n      }\n    }\n    return result;\n  }\n\n  async createUserReport(data: InsertUserReport): Promise<UserReport> {\n    const [report] = await db.insert(userReports).values(data).returning();\n    return report;\n  }\n\n  async reportUser(reporterId: string, reportedId: string, reason: string, description: string): Promise<UserReport> {\n    return this.createUserReport({\n      reporterId,\n      reportedId,\n      reason,\n      description: description || \"\",\n    });\n  }\n\n  async getUserRelationship(userId: string, targetId: string): Promise<{ isBlocked: boolean; isMuted: boolean; isBlockedByTarget: boolean }> {\n    const [isBlockedResult, isMutedResult, isBlockedByTargetResult] = await Promise.all([\n      this.isUserBlocked(userId, targetId),\n      this.isUserMuted(userId, targetId),\n      this.isUserBlocked(targetId, userId),\n    ]);\n    \n    return {\n      isBlocked: isBlockedResult,\n      isMuted: isMutedResult,\n      isBlockedByTarget: isBlockedByTargetResult,\n    };\n  }\n\n  // Social post report operations\n  async createSocialPostReport(postId: string, reporterId: string, reason: string, description?: string): Promise<SocialPostReport> {\n    const [report] = await db.insert(socialPostReports).values({\n      postId,\n      reporterId,\n      reason,\n      description: description || null,\n    }).returning();\n    \n    const reportCount = await this.getPostReportCount(postId);\n    if (reportCount >= 3) {\n      await this.hideSocialPost(postId);\n    }\n    \n    return report;\n  }\n  \n  async getSocialPostReports(postId: string): Promise<SocialPostReport[]> {\n    return db.select().from(socialPostReports).where(eq(socialPostReports.postId, postId)).orderBy(desc(socialPostReports.createdAt));\n  }\n  \n  async getPostReportCount(postId: string): Promise<number> {\n    const result = await db.select({ count: sql<number>`count(*)::int` }).from(socialPostReports).where(eq(socialPostReports.postId, postId));\n    return result[0]?.count || 0;\n  }\n  \n  async hasUserReportedPost(postId: string, userId: string): Promise<boolean> {\n    const result = await db.select().from(socialPostReports).where(and(eq(socialPostReports.postId, postId), eq(socialPostReports.reporterId, userId)));\n    return result.length > 0;\n  }\n  \n  async hideSocialPost(postId: string): Promise<void> {\n    await db.update(socialPosts).set({ isVisible: false }).where(eq(socialPosts.id, postId));\n  }\n\n  // VTU (Virtual Top-Up) operations\n  async getVtuPlans(network?: string): Promise<VtuPlan[]> {\n    if (network) {\n      return await db\n        .select()\n        .from(vtuPlans)\n        .where(and(eq(vtuPlans.isActive, true), eq(vtuPlans.network, network as any)))\n        .orderBy(vtuPlans.sortOrder);\n    }\n    return await db\n      .select()\n      .from(vtuPlans)\n      .where(eq(vtuPlans.isActive, true))\n      .orderBy(vtuPlans.sortOrder);\n  }\n\n  async getVtuPlan(id: string): Promise<VtuPlan | undefined> {\n    const [plan] = await db.select().from(vtuPlans).where(eq(vtuPlans.id, id));\n    return plan;\n  }\n\n  async getAllVtuPlans(): Promise<VtuPlan[]> {\n    return await db.select().from(vtuPlans).orderBy(vtuPlans.network, vtuPlans.sortOrder);\n  }\n\n  async getVtuPlanByNetworkAndDataAmount(network: string, dataAmount: string): Promise<VtuPlan | undefined> {\n    const [plan] = await db\n      .select()\n      .from(vtuPlans)\n      .where(and(\n        eq(vtuPlans.network, network as any),\n        eq(vtuPlans.dataAmount, dataAmount.toUpperCase())\n      ));\n    return plan;\n  }\n\n  async createVtuPlan(data: InsertVtuPlan): Promise<VtuPlan> {\n    const [plan] = await db.insert(vtuPlans).values(data).returning();\n    return plan;\n  }\n\n  async updateVtuPlan(id: string, data: Partial<VtuPlan>): Promise<VtuPlan> {\n    const [updated] = await db\n      .update(vtuPlans)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(vtuPlans.id, id))\n      .returning();\n    return updated;\n  }\n\n  async upsertVtuPlan(plan: InsertVtuPlan): Promise<VtuPlan> {\n    // Try to find existing plan by network and dataAmount\n    const existing = await this.getVtuPlanByNetworkAndDataAmount(plan.network, plan.dataAmount);\n    \n    if (existing) {\n      // Update existing plan\n      return await this.updateVtuPlan(existing.id, {\n        planName: plan.planName,\n        validity: plan.validity,\n        costPrice: plan.costPrice,\n        sellingPrice: plan.sellingPrice,\n        planCode: plan.planCode,\n        isActive: plan.isActive ?? true,\n        sortOrder: plan.sortOrder ?? existing.sortOrder,\n      });\n    } else {\n      // Create new plan\n      return await this.createVtuPlan(plan);\n    }\n  }\n\n  async deactivateAllVtuPlans(): Promise<void> {\n    await db.update(vtuPlans).set({ isActive: false, updatedAt: new Date() });\n  }\n\n  async createVtuTransaction(data: InsertVtuTransaction): Promise<VtuTransaction> {\n    const [transaction] = await db.insert(vtuTransactions).values(data).returning();\n    return transaction;\n  }\n\n  async updateVtuTransaction(id: string, data: Partial<VtuTransaction>): Promise<VtuTransaction> {\n    const [updated] = await db\n      .update(vtuTransactions)\n      .set({ ...data })\n      .where(eq(vtuTransactions.id, id))\n      .returning();\n    return updated;\n  }\n\n  async getUserVtuTransactions(userId: string, filters?: { status?: string; network?: string; startDate?: Date; endDate?: Date }): Promise<VtuTransaction[]> {\n    const conditions = [eq(vtuTransactions.userId, userId)];\n    \n    if (filters?.status) {\n      conditions.push(eq(vtuTransactions.status, filters.status as any));\n    }\n    if (filters?.network) {\n      conditions.push(eq(vtuTransactions.network, filters.network as any));\n    }\n    if (filters?.startDate) {\n      conditions.push(sql`${vtuTransactions.createdAt} >= ${filters.startDate}`);\n    }\n    if (filters?.endDate) {\n      conditions.push(sql`${vtuTransactions.createdAt} <= ${filters.endDate}`);\n    }\n    \n    return await db\n      .select()\n      .from(vtuTransactions)\n      .where(and(...conditions))\n      .orderBy(desc(vtuTransactions.createdAt));\n  }\n\n  // VTU Beneficiaries operations\n  async getUserBeneficiaries(userId: string): Promise<VtuBeneficiary[]> {\n    return await db\n      .select()\n      .from(vtuBeneficiaries)\n      .where(eq(vtuBeneficiaries.userId, userId))\n      .orderBy(desc(vtuBeneficiaries.lastUsed), desc(vtuBeneficiaries.usageCount));\n  }\n\n  async getBeneficiary(id: string): Promise<VtuBeneficiary | undefined> {\n    const [beneficiary] = await db\n      .select()\n      .from(vtuBeneficiaries)\n      .where(eq(vtuBeneficiaries.id, id));\n    return beneficiary;\n  }\n\n  async createBeneficiary(data: InsertVtuBeneficiary): Promise<VtuBeneficiary> {\n    // If this is set as default, unset other defaults first\n    if (data.isDefault) {\n      await db\n        .update(vtuBeneficiaries)\n        .set({ isDefault: false })\n        .where(eq(vtuBeneficiaries.userId, data.userId));\n    }\n    \n    const [beneficiary] = await db\n      .insert(vtuBeneficiaries)\n      .values(data)\n      .returning();\n    return beneficiary;\n  }\n\n  async updateBeneficiary(id: string, data: Partial<VtuBeneficiary>): Promise<VtuBeneficiary> {\n    const [updated] = await db\n      .update(vtuBeneficiaries)\n      .set(data)\n      .where(eq(vtuBeneficiaries.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteBeneficiary(id: string): Promise<void> {\n    await db\n      .delete(vtuBeneficiaries)\n      .where(eq(vtuBeneficiaries.id, id));\n  }\n\n  async updateBeneficiaryUsage(id: string): Promise<void> {\n    await db\n      .update(vtuBeneficiaries)\n      .set({ \n        lastUsed: new Date(),\n        usageCount: sql`${vtuBeneficiaries.usageCount} + 1`\n      })\n      .where(eq(vtuBeneficiaries.id, id));\n  }\n\n  // User Settings operations\n  async getOrCreateUserSettings(userId: string): Promise<UserSettings> {\n    const [existing] = await db\n      .select()\n      .from(userSettings)\n      .where(eq(userSettings.userId, userId));\n    \n    if (existing) {\n      return existing;\n    }\n    \n    const [settings] = await db\n      .insert(userSettings)\n      .values({ userId })\n      .returning();\n    return settings;\n  }\n\n  async updateUserSettings(userId: string, data: Partial<UserSettings>): Promise<UserSettings> {\n    const settings = await this.getOrCreateUserSettings(userId);\n    \n    const [updated] = await db\n      .update(userSettings)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(userSettings.id, settings.id))\n      .returning();\n    return updated;\n  }\n\n  async requestAccountDeletion(userId: string): Promise<UserSettings> {\n    const settings = await this.getOrCreateUserSettings(userId);\n    const now = new Date();\n    const scheduledFor = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 days from now\n    \n    const [updated] = await db\n      .update(userSettings)\n      .set({\n        deletionRequestedAt: now,\n        deletionScheduledFor: scheduledFor,\n        deletionCancelledAt: null,\n        updatedAt: now,\n      })\n      .where(eq(userSettings.id, settings.id))\n      .returning();\n    return updated;\n  }\n\n  async cancelAccountDeletion(userId: string): Promise<UserSettings> {\n    const settings = await this.getOrCreateUserSettings(userId);\n    const now = new Date();\n    \n    const [updated] = await db\n      .update(userSettings)\n      .set({\n        deletionRequestedAt: null,\n        deletionScheduledFor: null,\n        deletionCancelledAt: now,\n        updatedAt: now,\n      })\n      .where(eq(userSettings.id, settings.id))\n      .returning();\n    return updated;\n  }\n\n  // Sponsored Ads operations\n  async getActiveSponsoredAds(type?: string): Promise<SponsoredAd[]> {\n    const now = new Date();\n    \n    if (type) {\n      return await db\n        .select()\n        .from(sponsoredAds)\n        .where(\n          and(\n            eq(sponsoredAds.status, \"active\"),\n            eq(sponsoredAds.type, type as any),\n            or(\n              sql`${sponsoredAds.startDate} IS NULL`,\n              sql`${sponsoredAds.startDate} <= ${now}`\n            ),\n            or(\n              sql`${sponsoredAds.endDate} IS NULL`,\n              sql`${sponsoredAds.endDate} >= ${now}`\n            ),\n            sql`CAST(${sponsoredAds.spent} AS DECIMAL) < CAST(${sponsoredAds.budget} AS DECIMAL)`\n          )\n        )\n        .orderBy(desc(sponsoredAds.createdAt));\n    }\n    \n    return await db\n      .select()\n      .from(sponsoredAds)\n      .where(\n        and(\n          eq(sponsoredAds.status, \"active\"),\n          or(\n            sql`${sponsoredAds.startDate} IS NULL`,\n            sql`${sponsoredAds.startDate} <= ${now}`\n          ),\n          or(\n            sql`${sponsoredAds.endDate} IS NULL`,\n            sql`${sponsoredAds.endDate} >= ${now}`\n          ),\n          sql`CAST(${sponsoredAds.spent} AS DECIMAL) < CAST(${sponsoredAds.budget} AS DECIMAL)`\n        )\n      )\n      .orderBy(desc(sponsoredAds.createdAt));\n  }\n\n  async createSponsoredAd(data: InsertSponsoredAd): Promise<SponsoredAd> {\n    const [ad] = await db.insert(sponsoredAds).values(data).returning();\n    return ad;\n  }\n\n  async recordAdImpression(adId: string): Promise<void> {\n    await db\n      .update(sponsoredAds)\n      .set({\n        impressions: sql`${sponsoredAds.impressions} + 1`,\n        spent: sql`CAST(${sponsoredAds.spent} AS DECIMAL) + CAST(${sponsoredAds.costPerImpression} AS DECIMAL)`,\n        updatedAt: new Date(),\n      })\n      .where(eq(sponsoredAds.id, adId));\n  }\n\n  async recordAdClick(adId: string): Promise<void> {\n    await db\n      .update(sponsoredAds)\n      .set({\n        clicks: sql`${sponsoredAds.clicks} + 1`,\n        spent: sql`CAST(${sponsoredAds.spent} AS DECIMAL) + CAST(${sponsoredAds.costPerClick} AS DECIMAL)`,\n        updatedAt: new Date(),\n      })\n      .where(eq(sponsoredAds.id, adId));\n  }\n\n  // Platform Settings operations\n  async getAllPlatformSettings(): Promise<PlatformSetting[]> {\n    return await db.select().from(platformSettings);\n  }\n\n  async getPlatformSetting(key: string): Promise<PlatformSetting | undefined> {\n    const [setting] = await db\n      .select()\n      .from(platformSettings)\n      .where(eq(platformSettings.key, key));\n    return setting;\n  }\n\n  async updatePlatformSetting(key: string, value: string, updatedBy?: string): Promise<PlatformSetting> {\n    const existing = await this.getPlatformSetting(key);\n    \n    if (existing) {\n      const [updated] = await db\n        .update(platformSettings)\n        .set({ value, updatedAt: new Date(), updatedBy: updatedBy || null })\n        .where(eq(platformSettings.key, key))\n        .returning();\n      return updated;\n    }\n    \n    const [created] = await db\n      .insert(platformSettings)\n      .values({ key, value, updatedBy: updatedBy || null })\n      .returning();\n    return created;\n  }\n\n  // KYC Verification operations\n  async createKycVerification(userId: string): Promise<KycVerification> {\n    const existing = await this.getKycVerification(userId);\n    if (existing) {\n      return existing;\n    }\n    \n    const [verification] = await db\n      .insert(kycVerifications)\n      .values({ userId })\n      .returning();\n    return verification;\n  }\n\n  async getKycVerification(userId: string): Promise<KycVerification | undefined> {\n    const [verification] = await db\n      .select()\n      .from(kycVerifications)\n      .where(eq(kycVerifications.userId, userId))\n      .orderBy(desc(kycVerifications.createdAt));\n    return verification;\n  }\n\n  async getKycVerificationById(id: string): Promise<KycVerification | undefined> {\n    const [verification] = await db\n      .select()\n      .from(kycVerifications)\n      .where(eq(kycVerifications.id, id));\n    return verification;\n  }\n\n  async updateKycVerification(id: string, data: Partial<KycVerification>): Promise<KycVerification> {\n    const [updated] = await db\n      .update(kycVerifications)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(kycVerifications.id, id))\n      .returning();\n    return updated;\n  }\n\n  async getPendingKycVerifications(): Promise<KycVerification[]> {\n    return await db\n      .select()\n      .from(kycVerifications)\n      .where(eq(kycVerifications.status, \"manual_review\"))\n      .orderBy(kycVerifications.createdAt);\n  }\n\n  async createKycLog(data: {\n    kycId: string;\n    userId: string;\n    action: string;\n    result?: string;\n    similarityScore?: number;\n    reviewedBy?: string;\n    ipAddress?: string;\n    userAgent?: string;\n    metadata?: any;\n  }): Promise<void> {\n    await db.insert(kycVerificationLogs).values({\n      kycId: data.kycId,\n      userId: data.userId,\n      action: data.action,\n      result: data.result,\n      similarityScore: data.similarityScore?.toString(),\n      reviewedBy: data.reviewedBy,\n      ipAddress: data.ipAddress,\n      userAgent: data.userAgent,\n      metadata: data.metadata,\n    });\n  }\n\n  // Scheduled VTU Purchases operations\n  async getScheduledPurchases(userId: string): Promise<ScheduledVtuPurchase[]> {\n    return await db\n      .select()\n      .from(scheduledVtuPurchases)\n      .where(eq(scheduledVtuPurchases.userId, userId))\n      .orderBy(desc(scheduledVtuPurchases.createdAt));\n  }\n\n  async getScheduledPurchase(id: string): Promise<ScheduledVtuPurchase | undefined> {\n    const [purchase] = await db\n      .select()\n      .from(scheduledVtuPurchases)\n      .where(eq(scheduledVtuPurchases.id, id));\n    return purchase;\n  }\n\n  async createScheduledPurchase(data: InsertScheduledVtuPurchase): Promise<ScheduledVtuPurchase> {\n    const [purchase] = await db\n      .insert(scheduledVtuPurchases)\n      .values(data)\n      .returning();\n    return purchase;\n  }\n\n  async updateScheduledPurchase(id: string, data: Partial<ScheduledVtuPurchase>): Promise<ScheduledVtuPurchase> {\n    const [updated] = await db\n      .update(scheduledVtuPurchases)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(scheduledVtuPurchases.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteScheduledPurchase(id: string): Promise<void> {\n    await db.delete(scheduledVtuPurchases).where(eq(scheduledVtuPurchases.id, id));\n  }\n\n  // Gift Data operations\n  async getGiftsByUser(userId: string): Promise<GiftData[]> {\n    return await db\n      .select()\n      .from(giftData)\n      .where(eq(giftData.senderId, userId))\n      .orderBy(desc(giftData.createdAt));\n  }\n\n  async getGiftByCode(code: string): Promise<GiftData | undefined> {\n    const [gift] = await db\n      .select()\n      .from(giftData)\n      .where(eq(giftData.giftCode, code));\n    return gift;\n  }\n\n  async createGiftData(data: InsertGiftData): Promise<GiftData> {\n    const [gift] = await db\n      .insert(giftData)\n      .values(data)\n      .returning();\n    return gift;\n  }\n\n  async claimGiftData(giftId: string, claimerId: string): Promise<GiftData> {\n    const [updated] = await db\n      .update(giftData)\n      .set({\n        status: \"claimed\",\n        recipientUserId: claimerId,\n        claimedAt: new Date(),\n      })\n      .where(eq(giftData.id, giftId))\n      .returning();\n    return updated;\n  }\n\n  // Bill Payment operations\n  async createBillPayment(data: InsertBillPayment): Promise<BillPayment> {\n    const [payment] = await db\n      .insert(billPayments)\n      .values(data)\n      .returning();\n    return payment;\n  }\n\n  async updateBillPayment(id: string, data: Partial<BillPayment>): Promise<BillPayment> {\n    const [updated] = await db\n      .update(billPayments)\n      .set(data)\n      .where(eq(billPayments.id, id))\n      .returning();\n    return updated;\n  }\n\n  async getUserBillPayments(userId: string): Promise<BillPayment[]> {\n    return await db\n      .select()\n      .from(billPayments)\n      .where(eq(billPayments.userId, userId))\n      .orderBy(desc(billPayments.createdAt));\n  }\n\n  // Story operations\n  async createStory(data: { authorId: string; type: \"image\" | \"video\" | \"text\"; mediaUrl?: string; textContent?: string; backgroundColor?: string; fontStyle?: string }): Promise<Story> {\n    const expiresAt = new Date();\n    expiresAt.setHours(expiresAt.getHours() + 24);\n    \n    const [story] = await db.insert(stories).values({\n      ...data,\n      expiresAt,\n    }).returning();\n    return story;\n  }\n\n  async getStory(id: string): Promise<(Story & { author: User }) | undefined> {\n    const result = await db\n      .select()\n      .from(stories)\n      .innerJoin(users, eq(stories.authorId, users.id))\n      .where(eq(stories.id, id));\n    \n    if (!result.length) return undefined;\n    return { ...result[0].stories, author: result[0].users };\n  }\n\n  async getActiveStories(userId: string): Promise<(Story & { author: User; hasViewed: boolean })[]> {\n    const now = new Date();\n    \n    const followedUserIds = await db\n      .select({ followingId: follows.followingId })\n      .from(follows)\n      .where(eq(follows.followerId, userId));\n    \n    const followedIds = followedUserIds.map(f => f.followingId);\n    followedIds.push(userId);\n    \n    if (followedIds.length === 0) {\n      return [];\n    }\n    \n    const activeStories = await db\n      .select()\n      .from(stories)\n      .innerJoin(users, eq(stories.authorId, users.id))\n      .leftJoin(storyViews, and(\n        eq(storyViews.storyId, stories.id),\n        eq(storyViews.viewerId, userId)\n      ))\n      .where(and(\n        gt(stories.expiresAt, now),\n        sql`${stories.authorId} IN (${sql.join(followedIds.map(id => sql`${id}`), sql`, `)})`\n      ))\n      .orderBy(desc(stories.createdAt));\n    \n    return activeStories.map(row => ({\n      ...row.stories,\n      author: row.users,\n      hasViewed: row.story_views !== null,\n    }));\n  }\n\n  async getUserActiveStories(userId: string): Promise<(Story & { author: User })[]> {\n    const now = new Date();\n    \n    const activeStories = await db\n      .select()\n      .from(stories)\n      .innerJoin(users, eq(stories.authorId, users.id))\n      .where(and(\n        eq(stories.authorId, userId),\n        gt(stories.expiresAt, now)\n      ))\n      .orderBy(desc(stories.createdAt));\n    \n    return activeStories.map(row => ({\n      ...row.stories,\n      author: row.users,\n    }));\n  }\n\n  async deleteStory(id: string): Promise<void> {\n    await db.delete(stories).where(eq(stories.id, id));\n  }\n\n  async viewStory(storyId: string, viewerId: string): Promise<StoryView> {\n    const existing = await db\n      .select()\n      .from(storyViews)\n      .where(and(\n        eq(storyViews.storyId, storyId),\n        eq(storyViews.viewerId, viewerId)\n      ));\n    \n    if (existing.length > 0) {\n      return existing[0];\n    }\n    \n    const [view] = await db.insert(storyViews).values({\n      storyId,\n      viewerId,\n    }).returning();\n    \n    await this.incrementStoryViews(storyId);\n    \n    return view;\n  }\n\n  async hasViewedStory(storyId: string, viewerId: string): Promise<boolean> {\n    const result = await db\n      .select()\n      .from(storyViews)\n      .where(and(\n        eq(storyViews.storyId, storyId),\n        eq(storyViews.viewerId, viewerId)\n      ));\n    return result.length > 0;\n  }\n\n  async getStoryViews(storyId: string): Promise<(StoryView & { viewer: User })[]> {\n    const views = await db\n      .select()\n      .from(storyViews)\n      .innerJoin(users, eq(storyViews.viewerId, users.id))\n      .where(eq(storyViews.storyId, storyId))\n      .orderBy(desc(storyViews.viewedAt));\n    \n    return views.map(row => ({\n      ...row.story_views,\n      viewer: row.users,\n    }));\n  }\n\n  async reactToStory(storyId: string, reactorId: string, reaction: string): Promise<StoryReaction> {\n    const existing = await db\n      .select()\n      .from(storyReactions)\n      .where(and(\n        eq(storyReactions.storyId, storyId),\n        eq(storyReactions.reactorId, reactorId)\n      ));\n    \n    if (existing.length > 0) {\n      const [updated] = await db\n        .update(storyReactions)\n        .set({ reaction })\n        .where(eq(storyReactions.id, existing[0].id))\n        .returning();\n      return updated;\n    }\n    \n    const [reactionRecord] = await db.insert(storyReactions).values({\n      storyId,\n      reactorId,\n      reaction,\n    }).returning();\n    \n    await this.incrementStoryLikes(storyId);\n    \n    return reactionRecord;\n  }\n\n  async getStoryReactions(storyId: string): Promise<(StoryReaction & { reactor: User })[]> {\n    const reactions = await db\n      .select()\n      .from(storyReactions)\n      .innerJoin(users, eq(storyReactions.reactorId, users.id))\n      .where(eq(storyReactions.storyId, storyId))\n      .orderBy(desc(storyReactions.createdAt));\n    \n    return reactions.map(row => ({\n      ...row.story_reactions,\n      reactor: row.users,\n    }));\n  }\n\n  async replyToStory(storyId: string, senderId: string, content: string): Promise<StoryReply> {\n    const [reply] = await db.insert(storyReplies).values({\n      storyId,\n      senderId,\n      content,\n    }).returning();\n    return reply;\n  }\n\n  async getStoryReplies(storyId: string): Promise<(StoryReply & { sender: User })[]> {\n    const replies = await db\n      .select()\n      .from(storyReplies)\n      .innerJoin(users, eq(storyReplies.senderId, users.id))\n      .where(eq(storyReplies.storyId, storyId))\n      .orderBy(desc(storyReplies.createdAt));\n    \n    return replies.map(row => ({\n      ...row.story_replies,\n      sender: row.users,\n    }));\n  }\n\n  async getUsersWithActiveStories(currentUserId: string): Promise<{ user: User; storyCount: number; hasUnviewed: boolean; latestStoryAt: Date }[]> {\n    const now = new Date();\n    \n    const followedUserIds = await db\n      .select({ followingId: follows.followingId })\n      .from(follows)\n      .where(eq(follows.followerId, currentUserId));\n    \n    const followedIds = followedUserIds.map(f => f.followingId);\n    followedIds.push(currentUserId);\n    \n    if (followedIds.length === 0) {\n      return [];\n    }\n    \n    const usersWithStories = await db\n      .select({\n        user: users,\n        storyCount: sql<number>`count(distinct ${stories.id})::int`,\n        unviewedCount: sql<number>`count(distinct case when ${storyViews.id} is null then ${stories.id} end)::int`,\n        latestStoryAt: sql<Date>`max(${stories.createdAt})`,\n      })\n      .from(users)\n      .innerJoin(stories, and(\n        eq(stories.authorId, users.id),\n        gt(stories.expiresAt, now)\n      ))\n      .leftJoin(storyViews, and(\n        eq(storyViews.storyId, stories.id),\n        eq(storyViews.viewerId, currentUserId)\n      ))\n      .where(sql`${users.id} IN (${sql.join(followedIds.map(id => sql`${id}`), sql`, `)})`)\n      .groupBy(users.id)\n      .orderBy(sql`max(${stories.createdAt}) desc`);\n    \n    return usersWithStories.map(row => ({\n      user: row.user,\n      storyCount: row.storyCount,\n      hasUnviewed: row.unviewedCount > 0,\n      latestStoryAt: row.latestStoryAt,\n    }));\n  }\n\n  async incrementStoryViews(storyId: string): Promise<void> {\n    await db\n      .update(stories)\n      .set({ viewsCount: sql`${stories.viewsCount} + 1` })\n      .where(eq(stories.id, storyId));\n  }\n\n  async incrementStoryLikes(storyId: string): Promise<void> {\n    await db\n      .update(stories)\n      .set({ likesCount: sql`${stories.likesCount} + 1` })\n      .where(eq(stories.id, storyId));\n  }\n\n  async decrementStoryLikes(storyId: string): Promise<void> {\n    await db\n      .update(stories)\n      .set({ likesCount: sql`GREATEST(${stories.likesCount} - 1, 0)` })\n      .where(eq(stories.id, storyId));\n  }\n\n  // Confession operations\n  async createConfession(data: { authorId?: string; content: string; category?: string; isAnonymous?: boolean }): Promise<Confession> {\n    const [confession] = await db.insert(confessions).values({\n      authorId: data.authorId || null,\n      content: data.content,\n      category: data.category || \"general\",\n      isAnonymous: data.isAnonymous ?? true,\n      status: \"approved\", // Auto-approve confessions immediately (no moderation)\n    }).returning();\n    return confession;\n  }\n\n  async getConfession(id: string): Promise<(Confession & { author?: { id: string; firstName: string | null; lastName: string | null; profileImageUrl: string | null } | null }) | undefined> {\n    const result = await db\n      .select()\n      .from(confessions)\n      .leftJoin(users, eq(confessions.authorId, users.id))\n      .where(eq(confessions.id, id));\n    \n    if (result.length === 0) return undefined;\n    \n    const confession = result[0].confessions;\n    const author = result[0].users;\n    \n    if (confession.isAnonymous || !author) {\n      return { ...confession, author: null };\n    }\n    \n    return {\n      ...confession,\n      author: {\n        id: author.id,\n        firstName: author.firstName,\n        lastName: author.lastName,\n        profileImageUrl: author.profileImageUrl,\n      },\n    };\n  }\n\n  async getConfessions(options?: { category?: string; status?: string; page?: number; limit?: number }): Promise<{ confessions: Confession[]; total: number }> {\n    const page = options?.page || 1;\n    const limit = options?.limit || 20;\n    const offset = (page - 1) * limit;\n    \n    let conditions = [];\n    \n    if (options?.category && options.category !== 'all') {\n      conditions.push(eq(confessions.category, options.category));\n    }\n    \n    if (options?.status) {\n      conditions.push(sql`${confessions.status} = ${options.status}`);\n    } else {\n      conditions.push(sql`${confessions.status} = 'approved'`);\n    }\n    \n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n    \n    const [countResult] = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(confessions)\n      .where(whereClause);\n    \n    const confessionList = await db\n      .select()\n      .from(confessions)\n      .where(whereClause)\n      .orderBy(desc(confessions.createdAt))\n      .limit(limit)\n      .offset(offset);\n    \n    return {\n      confessions: confessionList,\n      total: countResult?.count || 0,\n    };\n  }\n\n  async getTrendingConfessions(limit: number = 10): Promise<Confession[]> {\n    return await db\n      .select()\n      .from(confessions)\n      .where(and(\n        sql`${confessions.status} = 'approved'`,\n        eq(confessions.isTrending, true)\n      ))\n      .orderBy(desc(sql`${confessions.likesCount} + ${confessions.commentsCount}`))\n      .limit(limit);\n  }\n\n  async deleteConfession(id: string): Promise<void> {\n    await db.delete(confessions).where(eq(confessions.id, id));\n  }\n\n  async approveConfession(id: string, moderatedBy: string): Promise<Confession> {\n    const [updated] = await db\n      .update(confessions)\n      .set({ \n        status: \"approved\",\n        moderatedBy,\n        moderatedAt: new Date(),\n      })\n      .where(eq(confessions.id, id))\n      .returning();\n    return updated;\n  }\n\n  async rejectConfession(id: string, moderatedBy: string): Promise<Confession> {\n    const [updated] = await db\n      .update(confessions)\n      .set({ \n        status: \"rejected\",\n        moderatedBy,\n        moderatedAt: new Date(),\n      })\n      .where(eq(confessions.id, id))\n      .returning();\n    return updated;\n  }\n\n  async flagConfession(id: string): Promise<Confession> {\n    const [updated] = await db\n      .update(confessions)\n      .set({ status: \"flagged\" })\n      .where(eq(confessions.id, id))\n      .returning();\n    return updated;\n  }\n\n  async autoApproveOldConfessions(): Promise<number> {\n    // Auto-approve confessions that are older than 5 minutes and not yet approved\n    // Uses raw SQL to handle both schema versions (is_approved boolean OR status enum)\n    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);\n    \n    try {\n      // Try new schema with status column\n      const result = await db\n        .update(confessions)\n        .set({ status: \"approved\" })\n        .where(and(\n          sql`${confessions.status} = 'pending'`,\n          sql`${confessions.createdAt} < ${fiveMinutesAgo}`\n        ))\n        .returning();\n      \n      return result.length;\n    } catch (error: any) {\n      // Fallback: database might use old is_approved boolean column\n      if (error.code === '42703') { // Column doesn't exist\n        try {\n          const result = await db.execute(sql`\n            UPDATE confessions \n            SET is_approved = true \n            WHERE is_approved = false \n            AND created_at < ${fiveMinutesAgo}\n            RETURNING id\n          `);\n          return (result as any).rowCount || 0;\n        } catch (fallbackError) {\n          console.error(\"Fallback auto-approve also failed:\", fallbackError);\n          return 0;\n        }\n      }\n      throw error;\n    }\n  }\n\n  // Unique confession view tracking methods (1 view per user per 24 hours)\n  async hasViewedConfession(confessionId: string, viewerId: string): Promise<boolean> {\n    // Check if viewer has viewed this confession in the last 24 hours\n    const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n    const existing = await db\n      .select()\n      .from(confessionViews)\n      .where(\n        and(\n          eq(confessionViews.confessionId, confessionId),\n          eq(confessionViews.viewerId, viewerId),\n          gt(confessionViews.createdAt, twentyFourHoursAgo)\n        )\n      )\n      .limit(1);\n    return existing.length > 0;\n  }\n\n  async incrementConfessionViews(confessionId: string): Promise<void> {\n    await db\n      .update(confessions)\n      .set({ viewsCount: sql`COALESCE(${confessions.viewsCount}, 0) + 1` })\n      .where(eq(confessions.id, confessionId));\n  }\n\n  async recordUniqueConfessionView(confessionId: string, viewerId: string): Promise<boolean> {\n    // Check if this viewer has already viewed this confession in the last 24 hours\n    const hasViewed = await this.hasViewedConfession(confessionId, viewerId);\n    \n    if (!hasViewed) {\n      // Record the new view\n      await db.insert(confessionViews).values({\n        confessionId,\n        viewerId,\n      });\n      // Increment the confession's view counter\n      await this.incrementConfessionViews(confessionId);\n      return true; // New unique view recorded\n    }\n    \n    return false; // Already viewed within 24 hours, no increment\n  }\n\n  // Confession vote operations\n  async voteConfession(confessionId: string, voterId: string, voteType: 'like' | 'dislike'): Promise<ConfessionVote> {\n    const existing = await this.getUserVote(confessionId, voterId);\n    \n    if (existing) {\n      if (existing.voteType === voteType) {\n        throw new Error(\"Already voted with this type\");\n      }\n      \n      await db.delete(confessionVotes).where(eq(confessionVotes.id, existing.id));\n      \n      if (existing.voteType === 'like') {\n        await db.update(confessions).set({ \n          likesCount: sql`GREATEST(${confessions.likesCount} - 1, 0)` \n        }).where(eq(confessions.id, confessionId));\n      } else {\n        await db.update(confessions).set({ \n          dislikesCount: sql`GREATEST(${confessions.dislikesCount} - 1, 0)` \n        }).where(eq(confessions.id, confessionId));\n      }\n    }\n    \n    const [vote] = await db.insert(confessionVotes).values({\n      confessionId,\n      voterId,\n      voteType,\n    }).returning();\n    \n    if (voteType === 'like') {\n      await db.update(confessions).set({ \n        likesCount: sql`${confessions.likesCount} + 1` \n      }).where(eq(confessions.id, confessionId));\n      \n      const [confession] = await db.select().from(confessions).where(eq(confessions.id, confessionId));\n      if (confession && (confession.likesCount || 0) >= 5) {\n        await db.update(confessions).set({ isTrending: true }).where(eq(confessions.id, confessionId));\n      }\n    } else {\n      await db.update(confessions).set({ \n        dislikesCount: sql`${confessions.dislikesCount} + 1` \n      }).where(eq(confessions.id, confessionId));\n    }\n    \n    return vote;\n  }\n\n  async removeVote(confessionId: string, voterId: string): Promise<void> {\n    const existing = await this.getUserVote(confessionId, voterId);\n    \n    if (existing) {\n      await db.delete(confessionVotes).where(eq(confessionVotes.id, existing.id));\n      \n      if (existing.voteType === 'like') {\n        await db.update(confessions).set({ \n          likesCount: sql`GREATEST(${confessions.likesCount} - 1, 0)` \n        }).where(eq(confessions.id, confessionId));\n      } else {\n        await db.update(confessions).set({ \n          dislikesCount: sql`GREATEST(${confessions.dislikesCount} - 1, 0)` \n        }).where(eq(confessions.id, confessionId));\n      }\n    }\n  }\n\n  async getUserVote(confessionId: string, voterId: string): Promise<ConfessionVote | undefined> {\n    const [vote] = await db\n      .select()\n      .from(confessionVotes)\n      .where(and(\n        eq(confessionVotes.confessionId, confessionId),\n        eq(confessionVotes.voterId, voterId)\n      ));\n    return vote;\n  }\n\n  // Confession comment operations\n  async getConfessionComments(confessionId: string): Promise<(ConfessionComment & { author?: { id: string; firstName: string | null; lastName: string | null; profileImageUrl: string | null } | null })[]> {\n    const result = await db\n      .select()\n      .from(confessionComments)\n      .leftJoin(users, eq(confessionComments.authorId, users.id))\n      .where(eq(confessionComments.confessionId, confessionId))\n      .orderBy(desc(confessionComments.createdAt));\n    \n    return result.map(row => {\n      const comment = row.confession_comments;\n      const author = row.users;\n      \n      if (comment.isAnonymous || !author) {\n        return { ...comment, author: null };\n      }\n      \n      return {\n        ...comment,\n        author: {\n          id: author.id,\n          firstName: author.firstName,\n          lastName: author.lastName,\n          profileImageUrl: author.profileImageUrl,\n        },\n      };\n    });\n  }\n\n  async createConfessionComment(data: { confessionId: string; authorId?: string; content: string; isAnonymous?: boolean; parentId?: string }): Promise<ConfessionComment> {\n    const [comment] = await db.insert(confessionComments).values({\n      confessionId: data.confessionId,\n      authorId: data.authorId || null,\n      content: data.content,\n      isAnonymous: data.isAnonymous ?? false,\n      parentId: data.parentId || null,\n    }).returning();\n    \n    await db.update(confessions).set({\n      commentsCount: sql`${confessions.commentsCount} + 1`\n    }).where(eq(confessions.id, data.confessionId));\n    \n    return comment;\n  }\n\n  async deleteConfessionComment(id: string): Promise<void> {\n    const [comment] = await db.select().from(confessionComments).where(eq(confessionComments.id, id));\n    \n    if (comment) {\n      await db.delete(confessionComments).where(eq(confessionComments.id, id));\n      \n      await db.update(confessions).set({\n        commentsCount: sql`GREATEST(${confessions.commentsCount} - 1, 0)`\n      }).where(eq(confessions.id, comment.confessionId));\n    }\n  }\n\n  // Confession report operations\n  async createConfessionReport(data: { confessionId: string; reporterId: string; reason: string; description?: string }): Promise<any> {\n    const [report] = await db.insert(confessionReports).values({\n      confessionId: data.confessionId,\n      reporterId: data.reporterId,\n      reason: data.reason,\n      description: data.description || null,\n    }).returning();\n    \n    const [reportsCount] = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(confessionReports)\n      .where(eq(confessionReports.confessionId, data.confessionId));\n    \n    if ((reportsCount?.count || 0) >= 3) {\n      await this.flagConfession(data.confessionId);\n    }\n    \n    return report;\n  }\n\n  async getConfessionReports(confessionId: string): Promise<any[]> {\n    return await db\n      .select()\n      .from(confessionReports)\n      .where(eq(confessionReports.confessionId, confessionId))\n      .orderBy(desc(confessionReports.createdAt));\n  }\n\n  // =====================================================\n  // COMMUNITY OPERATIONS\n  // =====================================================\n\n  async createCommunity(data: { name: string; slug: string; description?: string; iconUrl?: string; coverUrl?: string; type?: \"public\" | \"private\" | \"invite_only\"; category?: string; rules?: string[]; ownerId: string }): Promise<Community> {\n    const [community] = await db.insert(communities).values({\n      name: data.name,\n      slug: data.slug.toLowerCase(),\n      description: data.description || null,\n      iconUrl: data.iconUrl || null,\n      coverUrl: data.coverUrl || null,\n      type: data.type || \"public\",\n      category: data.category || null,\n      rules: data.rules || [],\n      ownerId: data.ownerId,\n      membersCount: 1,\n    }).returning();\n\n    await db.insert(communityMembers).values({\n      communityId: community.id,\n      userId: data.ownerId,\n      role: \"owner\",\n    });\n\n    return community;\n  }\n\n  async getCommunity(id: string): Promise<(Community & { owner: User }) | undefined> {\n    const result = await db\n      .select()\n      .from(communities)\n      .innerJoin(users, eq(communities.ownerId, users.id))\n      .where(eq(communities.id, id));\n\n    if (result.length === 0) return undefined;\n    return { ...result[0].communities, owner: result[0].users };\n  }\n\n  async getCommunityBySlug(slug: string): Promise<(Community & { owner: User }) | undefined> {\n    const result = await db\n      .select()\n      .from(communities)\n      .innerJoin(users, eq(communities.ownerId, users.id))\n      .where(eq(communities.slug, slug.toLowerCase()));\n\n    if (result.length === 0) return undefined;\n    return { ...result[0].communities, owner: result[0].users };\n  }\n\n  async getPublicCommunities(): Promise<(Community & { owner: User })[]> {\n    const result = await db\n      .select()\n      .from(communities)\n      .innerJoin(users, eq(communities.ownerId, users.id))\n      .where(and(\n        eq(communities.isActive, true),\n        eq(communities.type, \"public\")\n      ))\n      .orderBy(desc(communities.membersCount));\n\n    return result.map(row => ({ ...row.communities, owner: row.users }));\n  }\n\n  async getUserJoinedCommunities(userId: string): Promise<(Community & { owner: User; membership: CommunityMember })[]> {\n    const result = await db\n      .select()\n      .from(communities)\n      .innerJoin(users, eq(communities.ownerId, users.id))\n      .innerJoin(communityMembers, eq(communities.id, communityMembers.communityId))\n      .where(and(\n        eq(communityMembers.userId, userId),\n        eq(communityMembers.isBanned, false)\n      ))\n      .orderBy(desc(communityMembers.joinedAt));\n\n    return result.map(row => ({\n      ...row.communities,\n      owner: row.users,\n      membership: row.community_members,\n    }));\n  }\n\n  async updateCommunity(id: string, data: Partial<Community>): Promise<Community> {\n    const [community] = await db\n      .update(communities)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(communities.id, id))\n      .returning();\n    return community;\n  }\n\n  async deleteCommunity(id: string): Promise<void> {\n    await db.delete(communities).where(eq(communities.id, id));\n  }\n\n  // Community member operations\n  async joinCommunity(communityId: string, userId: string): Promise<CommunityMember> {\n    const [member] = await db.insert(communityMembers).values({\n      communityId,\n      userId,\n      role: \"member\",\n    }).returning();\n\n    await db.update(communities)\n      .set({ membersCount: sql`${communities.membersCount} + 1` })\n      .where(eq(communities.id, communityId));\n\n    return member;\n  }\n\n  async leaveCommunity(communityId: string, userId: string): Promise<void> {\n    await db.delete(communityMembers).where(and(\n      eq(communityMembers.communityId, communityId),\n      eq(communityMembers.userId, userId)\n    ));\n\n    await db.update(communities)\n      .set({ membersCount: sql`GREATEST(${communities.membersCount} - 1, 0)` })\n      .where(eq(communities.id, communityId));\n  }\n\n  async getCommunityMember(communityId: string, userId: string): Promise<CommunityMember | undefined> {\n    const [member] = await db\n      .select()\n      .from(communityMembers)\n      .where(and(\n        eq(communityMembers.communityId, communityId),\n        eq(communityMembers.userId, userId)\n      ));\n    return member;\n  }\n\n  async getCommunityMembers(communityId: string): Promise<(CommunityMember & { user: User })[]> {\n    const result = await db\n      .select()\n      .from(communityMembers)\n      .innerJoin(users, eq(communityMembers.userId, users.id))\n      .where(eq(communityMembers.communityId, communityId))\n      .orderBy(communityMembers.joinedAt);\n\n    return result.map(row => ({ ...row.community_members, user: row.users }));\n  }\n\n  async updateMemberRole(communityId: string, userId: string, role: \"member\" | \"moderator\" | \"admin\" | \"owner\"): Promise<CommunityMember> {\n    const [member] = await db\n      .update(communityMembers)\n      .set({ role })\n      .where(and(\n        eq(communityMembers.communityId, communityId),\n        eq(communityMembers.userId, userId)\n      ))\n      .returning();\n    return member;\n  }\n\n  async banMember(communityId: string, userId: string, reason: string, until?: Date): Promise<CommunityMember> {\n    const [member] = await db\n      .update(communityMembers)\n      .set({ isBanned: true, banReason: reason, bannedUntil: until || null })\n      .where(and(\n        eq(communityMembers.communityId, communityId),\n        eq(communityMembers.userId, userId)\n      ))\n      .returning();\n    return member;\n  }\n\n  // Community post operations\n  async createCommunityPost(data: { communityId: string; authorId: string; title?: string; content: string; images?: string[] }): Promise<CommunityPost> {\n    const [post] = await db.insert(communityPosts).values({\n      communityId: data.communityId,\n      authorId: data.authorId,\n      title: data.title || null,\n      content: data.content,\n      images: data.images || [],\n    }).returning();\n\n    await db.update(communities)\n      .set({ postsCount: sql`${communities.postsCount} + 1` })\n      .where(eq(communities.id, data.communityId));\n\n    return post;\n  }\n\n  async getCommunityPost(id: string): Promise<(CommunityPost & { author: User; community: Community }) | undefined> {\n    const result = await db\n      .select()\n      .from(communityPosts)\n      .innerJoin(users, eq(communityPosts.authorId, users.id))\n      .innerJoin(communities, eq(communityPosts.communityId, communities.id))\n      .where(eq(communityPosts.id, id));\n\n    if (result.length === 0) return undefined;\n    return { ...result[0].community_posts, author: result[0].users, community: result[0].communities };\n  }\n\n  async getCommunityPosts(communityId: string): Promise<(CommunityPost & { author: User; isLiked?: boolean })[]> {\n    const result = await db\n      .select()\n      .from(communityPosts)\n      .innerJoin(users, eq(communityPosts.authorId, users.id))\n      .where(eq(communityPosts.communityId, communityId))\n      .orderBy(desc(communityPosts.isPinned), desc(communityPosts.createdAt));\n\n    return result.map(row => ({ ...row.community_posts, author: row.users }));\n  }\n\n  async updateCommunityPost(id: string, data: Partial<CommunityPost>): Promise<CommunityPost> {\n    const [post] = await db\n      .update(communityPosts)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(communityPosts.id, id))\n      .returning();\n    return post;\n  }\n\n  async deleteCommunityPost(id: string): Promise<void> {\n    const [post] = await db.select().from(communityPosts).where(eq(communityPosts.id, id));\n    \n    if (post) {\n      await db.delete(communityPosts).where(eq(communityPosts.id, id));\n      await db.update(communities)\n        .set({ postsCount: sql`GREATEST(${communities.postsCount} - 1, 0)` })\n        .where(eq(communities.id, post.communityId));\n    }\n  }\n\n  async pinCommunityPost(id: string, isPinned: boolean): Promise<CommunityPost> {\n    const [post] = await db\n      .update(communityPosts)\n      .set({ isPinned })\n      .where(eq(communityPosts.id, id))\n      .returning();\n    return post;\n  }\n\n  async lockPost(id: string, isLocked: boolean): Promise<CommunityPost> {\n    const [post] = await db\n      .update(communityPosts)\n      .set({ isLocked })\n      .where(eq(communityPosts.id, id))\n      .returning();\n    return post;\n  }\n\n  // Community post like operations\n  async likeCommunityPost(postId: string, userId: string): Promise<CommunityPostLike> {\n    const existing = await this.hasLikedCommunityPost(postId, userId);\n    if (existing) {\n      throw new Error(\"Already liked this post\");\n    }\n\n    const [like] = await db.insert(communityPostLikes).values({\n      postId,\n      userId,\n    }).returning();\n\n    await db.update(communityPosts)\n      .set({ likesCount: sql`${communityPosts.likesCount} + 1` })\n      .where(eq(communityPosts.id, postId));\n\n    return like;\n  }\n\n  async unlikeCommunityPost(postId: string, userId: string): Promise<void> {\n    await db.delete(communityPostLikes).where(and(\n      eq(communityPostLikes.postId, postId),\n      eq(communityPostLikes.userId, userId)\n    ));\n\n    await db.update(communityPosts)\n      .set({ likesCount: sql`GREATEST(${communityPosts.likesCount} - 1, 0)` })\n      .where(eq(communityPosts.id, postId));\n  }\n\n  async hasLikedCommunityPost(postId: string, userId: string): Promise<boolean> {\n    const [like] = await db\n      .select()\n      .from(communityPostLikes)\n      .where(and(\n        eq(communityPostLikes.postId, postId),\n        eq(communityPostLikes.userId, userId)\n      ));\n    return !!like;\n  }\n\n  // Community post comment operations\n  async createCommunityPostComment(data: { postId: string; authorId: string; content: string; parentId?: string }): Promise<CommunityPostComment> {\n    const [comment] = await db.insert(communityPostComments).values({\n      postId: data.postId,\n      authorId: data.authorId,\n      content: data.content,\n      parentId: data.parentId || null,\n    }).returning();\n\n    await db.update(communityPosts)\n      .set({ commentsCount: sql`${communityPosts.commentsCount} + 1` })\n      .where(eq(communityPosts.id, data.postId));\n\n    return comment;\n  }\n\n  async getCommunityPostComments(postId: string): Promise<(CommunityPostComment & { author: User })[]> {\n    const result = await db\n      .select()\n      .from(communityPostComments)\n      .innerJoin(users, eq(communityPostComments.authorId, users.id))\n      .where(eq(communityPostComments.postId, postId))\n      .orderBy(communityPostComments.createdAt);\n\n    return result.map(row => ({ ...row.community_post_comments, author: row.users }));\n  }\n\n  async deleteCommunityPostComment(id: string): Promise<void> {\n    const [comment] = await db.select().from(communityPostComments).where(eq(communityPostComments.id, id));\n    \n    if (comment) {\n      await db.delete(communityPostComments).where(eq(communityPostComments.id, id));\n      await db.update(communityPosts)\n        .set({ commentsCount: sql`GREATEST(${communityPosts.commentsCount} - 1, 0)` })\n        .where(eq(communityPosts.id, comment.postId));\n    }\n  }\n\n  // Enhanced messaging operations\n  async addMessageReaction(messageId: string, userId: string, reaction: string): Promise<MessageReaction> {\n    // Remove existing reaction first (user can only have one reaction per message)\n    await db.delete(messageReactions).where(\n      and(\n        eq(messageReactions.messageId, messageId),\n        eq(messageReactions.userId, userId)\n      )\n    );\n    \n    const [created] = await db.insert(messageReactions).values({\n      messageId,\n      userId,\n      reaction,\n    }).returning();\n    \n    return created;\n  }\n\n  async removeMessageReaction(messageId: string, userId: string): Promise<void> {\n    await db.delete(messageReactions).where(\n      and(\n        eq(messageReactions.messageId, messageId),\n        eq(messageReactions.userId, userId)\n      )\n    );\n  }\n\n  async getMessageReactions(messageId: string): Promise<(MessageReaction & { user: User })[]> {\n    const result = await db\n      .select()\n      .from(messageReactions)\n      .innerJoin(users, eq(messageReactions.userId, users.id))\n      .where(eq(messageReactions.messageId, messageId));\n    \n    return result.map(row => ({ ...row.message_reactions, user: row.users }));\n  }\n\n  async archiveConversation(userId: string, otherUserId: string): Promise<ArchivedConversation> {\n    // Check if already archived\n    const existing = await db.select().from(archivedConversations).where(\n      and(\n        eq(archivedConversations.userId, userId),\n        eq(archivedConversations.otherUserId, otherUserId)\n      )\n    );\n    \n    if (existing.length > 0) {\n      return existing[0];\n    }\n    \n    const [created] = await db.insert(archivedConversations).values({\n      userId,\n      otherUserId,\n    }).returning();\n    \n    return created;\n  }\n\n  async unarchiveConversation(userId: string, otherUserId: string): Promise<void> {\n    await db.delete(archivedConversations).where(\n      and(\n        eq(archivedConversations.userId, userId),\n        eq(archivedConversations.otherUserId, otherUserId)\n      )\n    );\n  }\n\n  async getArchivedConversations(userId: string): Promise<(ArchivedConversation & { otherUser: User })[]> {\n    const result = await db\n      .select()\n      .from(archivedConversations)\n      .innerJoin(users, eq(archivedConversations.otherUserId, users.id))\n      .where(eq(archivedConversations.userId, userId))\n      .orderBy(desc(archivedConversations.archivedAt));\n    \n    return result.map(row => ({ ...row.archived_conversations, otherUser: row.users }));\n  }\n\n  async isConversationArchived(userId: string, otherUserId: string): Promise<boolean> {\n    const [result] = await db.select().from(archivedConversations).where(\n      and(\n        eq(archivedConversations.userId, userId),\n        eq(archivedConversations.otherUserId, otherUserId)\n      )\n    );\n    return !!result;\n  }\n\n  async setDisappearingMessages(userId: string, otherUserId: string, duration: number): Promise<DisappearingMessageSetting> {\n    // Check if setting already exists\n    const existing = await db.select().from(disappearingMessageSettings).where(\n      and(\n        eq(disappearingMessageSettings.userId, userId),\n        eq(disappearingMessageSettings.otherUserId, otherUserId)\n      )\n    );\n    \n    if (existing.length > 0) {\n      // Update existing setting\n      const [updated] = await db.update(disappearingMessageSettings)\n        .set({ \n          duration, \n          isEnabled: duration > 0 \n        })\n        .where(eq(disappearingMessageSettings.id, existing[0].id))\n        .returning();\n      return updated;\n    }\n    \n    // Create new setting\n    const [created] = await db.insert(disappearingMessageSettings).values({\n      userId,\n      otherUserId,\n      duration,\n      isEnabled: duration > 0,\n    }).returning();\n    \n    return created;\n  }\n\n  async getDisappearingMessageSettings(userId: string, otherUserId: string): Promise<DisappearingMessageSetting | undefined> {\n    const [result] = await db.select().from(disappearingMessageSettings).where(\n      and(\n        eq(disappearingMessageSettings.userId, userId),\n        eq(disappearingMessageSettings.otherUserId, otherUserId)\n      )\n    );\n    return result;\n  }\n\n  async createReadReceipt(messageId: string, readerId: string): Promise<MessageReadReceipt> {\n    // Check if receipt already exists\n    const existing = await db.select().from(messageReadReceipts).where(\n      and(\n        eq(messageReadReceipts.messageId, messageId),\n        eq(messageReadReceipts.readerId, readerId)\n      )\n    );\n    \n    if (existing.length > 0) {\n      return existing[0];\n    }\n    \n    const [created] = await db.insert(messageReadReceipts).values({\n      messageId,\n      readerId,\n    }).returning();\n    \n    return created;\n  }\n\n  async getReadReceipts(messageId: string): Promise<(MessageReadReceipt & { reader: User })[]> {\n    const result = await db\n      .select()\n      .from(messageReadReceipts)\n      .innerJoin(users, eq(messageReadReceipts.readerId, users.id))\n      .where(eq(messageReadReceipts.messageId, messageId));\n    \n    return result.map(row => ({ ...row.message_read_receipts, reader: row.users }));\n  }\n\n  // ========================================\n  // Game Room Operations\n  // ========================================\n\n  private generateRoomCode(): string {\n    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';\n    let code = '';\n    for (let i = 0; i < 8; i++) {\n      code += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return code;\n  }\n\n  async createGameRoom(data: { hostId: string; gameType: string; stakeAmount?: string; maxPlayers?: number; isPrivate?: boolean; password?: string; settings?: any }): Promise<GameRoom> {\n    const roomCode = this.generateRoomCode();\n    \n    const [room] = await db.insert(gameRooms).values({\n      hostId: data.hostId,\n      gameType: data.gameType as any,\n      roomCode,\n      stakeAmount: data.stakeAmount || \"0.00\",\n      maxPlayers: data.maxPlayers || 4,\n      isPrivate: data.isPrivate || false,\n      password: data.password,\n      settings: data.settings,\n      status: \"waiting\",\n      currentPlayers: 1,\n    }).returning();\n\n    // Add host as first player\n    await db.insert(gameRoomPlayers).values({\n      roomId: room.id,\n      userId: data.hostId,\n      playerNumber: 1,\n      isReady: false,\n      isConnected: true,\n    });\n\n    return room;\n  }\n\n  async getGameRoom(id: string): Promise<(GameRoom & { host: User; players: (GameRoomPlayer & { user: User })[] }) | undefined> {\n    const [room] = await db.select().from(gameRooms).where(eq(gameRooms.id, id));\n    if (!room) return undefined;\n\n    const [host] = await db.select().from(users).where(eq(users.id, room.hostId));\n    const players = await this.getGameRoomPlayers(room.id);\n\n    return { ...room, host, players };\n  }\n\n  async getGameRoomByCode(code: string): Promise<(GameRoom & { host: User; players: (GameRoomPlayer & { user: User })[] }) | undefined> {\n    const [room] = await db.select().from(gameRooms).where(eq(gameRooms.roomCode, code.toUpperCase()));\n    if (!room) return undefined;\n\n    const [host] = await db.select().from(users).where(eq(users.id, room.hostId));\n    const players = await this.getGameRoomPlayers(room.id);\n\n    return { ...room, host, players };\n  }\n\n  async getAvailableGameRooms(gameType?: string): Promise<(GameRoom & { host: User; players: (GameRoomPlayer & { user: User })[] })[]> {\n    let query = db\n      .select()\n      .from(gameRooms)\n      .innerJoin(users, eq(gameRooms.hostId, users.id))\n      .where(\n        and(\n          eq(gameRooms.status, \"waiting\"),\n          eq(gameRooms.isPrivate, false)\n        )\n      )\n      .orderBy(desc(gameRooms.createdAt));\n\n    const rooms = await query;\n\n    const result = await Promise.all(\n      rooms\n        .filter(row => !gameType || row.game_rooms.gameType === gameType)\n        .map(async row => {\n          const players = await this.getGameRoomPlayers(row.game_rooms.id);\n          return {\n            ...row.game_rooms,\n            host: row.users,\n            players,\n          };\n        })\n    );\n\n    return result;\n  }\n\n  async getUserGameRooms(userId: string): Promise<GameRoom[]> {\n    const asHost = await db.select().from(gameRooms).where(eq(gameRooms.hostId, userId));\n    const asPlayer = await db\n      .select({ room: gameRooms })\n      .from(gameRoomPlayers)\n      .innerJoin(gameRooms, eq(gameRoomPlayers.roomId, gameRooms.id))\n      .where(eq(gameRoomPlayers.userId, userId));\n\n    const playerRooms = asPlayer.map(p => p.room);\n    const allRooms = [...asHost, ...playerRooms];\n    \n    // Remove duplicates\n    const uniqueRooms = allRooms.filter((room, index, self) => \n      index === self.findIndex(r => r.id === room.id)\n    );\n\n    return uniqueRooms;\n  }\n\n  async updateGameRoom(id: string, data: Partial<GameRoom>): Promise<GameRoom> {\n    const [room] = await db.update(gameRooms)\n      .set(data)\n      .where(eq(gameRooms.id, id))\n      .returning();\n    return room;\n  }\n\n  async deleteGameRoom(id: string): Promise<void> {\n    await db.delete(gameRooms).where(eq(gameRooms.id, id));\n  }\n\n  // Game Room Player operations\n  async joinGameRoom(roomId: string, userId: string, password?: string): Promise<GameRoomPlayer> {\n    const room = await this.getGameRoom(roomId);\n    if (!room) throw new Error(\"Room not found\");\n    \n    if (room.status !== \"waiting\") throw new Error(\"Game already started\");\n    if ((room.currentPlayers ?? 0) >= room.maxPlayers!) throw new Error(\"Room is full\");\n    if (room.isPrivate && room.password !== password) throw new Error(\"Invalid password\");\n\n    // Check if already in room\n    const existing = await this.getGameRoomPlayer(roomId, userId);\n    if (existing) return existing;\n\n    const nextPlayerNumber = (room.currentPlayers ?? 0) + 1;\n\n    const [player] = await db.insert(gameRoomPlayers).values({\n      roomId,\n      userId,\n      playerNumber: nextPlayerNumber,\n      isReady: false,\n      isConnected: true,\n    }).returning();\n\n    // Update room player count\n    await db.update(gameRooms)\n      .set({ currentPlayers: nextPlayerNumber })\n      .where(eq(gameRooms.id, roomId));\n\n    return player;\n  }\n\n  async leaveGameRoom(roomId: string, userId: string): Promise<void> {\n    const room = await this.getGameRoom(roomId);\n    if (!room) return;\n\n    await db.delete(gameRoomPlayers).where(\n      and(\n        eq(gameRoomPlayers.roomId, roomId),\n        eq(gameRoomPlayers.userId, userId)\n      )\n    );\n\n    const newCount = Math.max(0, (room.currentPlayers ?? 0) - 1);\n\n    if (newCount === 0 || room.hostId === userId) {\n      // Delete room if empty or host left\n      await db.delete(gameRooms).where(eq(gameRooms.id, roomId));\n    } else {\n      await db.update(gameRooms)\n        .set({ currentPlayers: newCount })\n        .where(eq(gameRooms.id, roomId));\n    }\n  }\n\n  async kickPlayerFromRoom(roomId: string, hostId: string, userId: string): Promise<void> {\n    const room = await this.getGameRoom(roomId);\n    if (!room) throw new Error(\"Room not found\");\n    if (room.hostId !== hostId) throw new Error(\"Only host can kick players\");\n    if (userId === hostId) throw new Error(\"Cannot kick yourself\");\n\n    await this.leaveGameRoom(roomId, userId);\n  }\n\n  async togglePlayerReady(roomId: string, userId: string): Promise<GameRoomPlayer> {\n    const player = await this.getGameRoomPlayer(roomId, userId);\n    if (!player) throw new Error(\"Player not in room\");\n\n    const [updated] = await db.update(gameRoomPlayers)\n      .set({ isReady: !player.isReady })\n      .where(\n        and(\n          eq(gameRoomPlayers.roomId, roomId),\n          eq(gameRoomPlayers.userId, userId)\n        )\n      )\n      .returning();\n\n    return updated;\n  }\n\n  async updatePlayerState(roomId: string, userId: string, playerState: any): Promise<GameRoomPlayer> {\n    const [updated] = await db.update(gameRoomPlayers)\n      .set({ playerState })\n      .where(\n        and(\n          eq(gameRoomPlayers.roomId, roomId),\n          eq(gameRoomPlayers.userId, userId)\n        )\n      )\n      .returning();\n\n    return updated;\n  }\n\n  async getGameRoomPlayer(roomId: string, userId: string): Promise<GameRoomPlayer | undefined> {\n    const [player] = await db.select().from(gameRoomPlayers).where(\n      and(\n        eq(gameRoomPlayers.roomId, roomId),\n        eq(gameRoomPlayers.userId, userId)\n      )\n    );\n    return player;\n  }\n\n  async getGameRoomPlayers(roomId: string): Promise<(GameRoomPlayer & { user: User })[]> {\n    const result = await db\n      .select()\n      .from(gameRoomPlayers)\n      .innerJoin(users, eq(gameRoomPlayers.userId, users.id))\n      .where(eq(gameRoomPlayers.roomId, roomId))\n      .orderBy(gameRoomPlayers.playerNumber);\n\n    return result.map(row => ({ ...row.game_room_players, user: row.users }));\n  }\n\n  // Game Room Chat operations\n  async createGameChatMessage(roomId: string, senderId: string, content: string, type: string = \"text\"): Promise<GameChatMessage> {\n    const [message] = await db.insert(gameChatMessages).values({\n      roomId,\n      senderId,\n      content,\n      type,\n    }).returning();\n\n    return message;\n  }\n\n  async getGameRoomChatMessages(roomId: string, limit: number = 50): Promise<(GameChatMessage & { sender: User })[]> {\n    const result = await db\n      .select()\n      .from(gameChatMessages)\n      .innerJoin(users, eq(gameChatMessages.senderId, users.id))\n      .where(eq(gameChatMessages.roomId, roomId))\n      .orderBy(desc(gameChatMessages.createdAt))\n      .limit(limit);\n\n    return result.map(row => ({ ...row.game_chat_messages, sender: row.users })).reverse();\n  }\n\n  // Game State operations\n  async updateGameState(roomId: string, gameState: any): Promise<GameRoom> {\n    const [room] = await db.update(gameRooms)\n      .set({ gameState })\n      .where(eq(gameRooms.id, roomId))\n      .returning();\n\n    return room;\n  }\n\n  async startGameRoom(roomId: string): Promise<GameRoom> {\n    const room = await this.getGameRoom(roomId);\n    if (!room) throw new Error(\"Room not found\");\n\n    // Check all players are ready\n    const notReady = room.players.filter(p => !p.isReady && p.userId !== room.hostId);\n    if (notReady.length > 0) throw new Error(\"Not all players are ready\");\n\n    const [updated] = await db.update(gameRooms)\n      .set({ \n        status: \"playing\",\n        startedAt: new Date(),\n      })\n      .where(eq(gameRooms.id, roomId))\n      .returning();\n\n    return updated;\n  }\n\n  async endGameRoom(roomId: string, winnerId?: string, results?: any): Promise<GameRoom> {\n    const gameState = results ? { ...results, winnerId } : { winnerId };\n    \n    const [updated] = await db.update(gameRooms)\n      .set({ \n        status: \"finished\",\n        finishedAt: new Date(),\n        gameState,\n      })\n      .where(eq(gameRooms.id, roomId))\n      .returning();\n\n    return updated;\n  }\n\n  // Secret Message Link operations\n  private generateSecretLinkCode(): string {\n    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';\n    let code = '';\n    for (let i = 0; i < 10; i++) {\n      code += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return code;\n  }\n\n  async createSecretMessageLink(userId: string, data: { title?: string; backgroundColor?: string }): Promise<SecretMessageLink> {\n    let linkCode = this.generateSecretLinkCode();\n    let attempts = 0;\n    \n    while (attempts < 10) {\n      const existing = await this.getSecretMessageLinkByCode(linkCode);\n      if (!existing) break;\n      linkCode = this.generateSecretLinkCode();\n      attempts++;\n    }\n\n    const [link] = await db.insert(secretMessageLinks).values({\n      userId,\n      linkCode,\n      title: data.title || \"Send me an anonymous message\",\n      backgroundColor: data.backgroundColor || \"#6b21a8\",\n    }).returning();\n\n    return link;\n  }\n\n  async getUserSecretMessageLinks(userId: string): Promise<SecretMessageLink[]> {\n    return await db.select()\n      .from(secretMessageLinks)\n      .where(eq(secretMessageLinks.userId, userId))\n      .orderBy(desc(secretMessageLinks.createdAt));\n  }\n\n  async getSecretMessageLinkByCode(code: string): Promise<SecretMessageLink | undefined> {\n    const [link] = await db.select()\n      .from(secretMessageLinks)\n      .where(eq(secretMessageLinks.linkCode, code));\n    return link;\n  }\n\n  async getSecretMessageLink(id: string): Promise<SecretMessageLink | undefined> {\n    const [link] = await db.select()\n      .from(secretMessageLinks)\n      .where(eq(secretMessageLinks.id, id));\n    return link;\n  }\n\n  async deleteSecretMessageLink(id: string): Promise<void> {\n    await db.delete(secretMessageLinks).where(eq(secretMessageLinks.id, id));\n  }\n\n  async toggleSecretMessageLink(id: string, isActive: boolean): Promise<SecretMessageLink> {\n    const [link] = await db.update(secretMessageLinks)\n      .set({ isActive })\n      .where(eq(secretMessageLinks.id, id))\n      .returning();\n    return link;\n  }\n\n  // Secret Message operations\n  async createSecretMessage(linkId: string, content: string): Promise<SecretMessage> {\n    const [message] = await db.insert(secretMessages).values({\n      linkId,\n      content,\n    }).returning();\n    return message;\n  }\n\n  async getSecretMessagesForUser(userId: string): Promise<(SecretMessage & { link: SecretMessageLink })[]> {\n    const result = await db.select()\n      .from(secretMessages)\n      .innerJoin(secretMessageLinks, eq(secretMessages.linkId, secretMessageLinks.id))\n      .where(eq(secretMessageLinks.userId, userId))\n      .orderBy(desc(secretMessages.createdAt));\n\n    return result.map(row => ({\n      ...row.secret_messages,\n      link: row.secret_message_links,\n    }));\n  }\n\n  async markSecretMessageRead(id: string): Promise<SecretMessage> {\n    const [message] = await db.update(secretMessages)\n      .set({ isRead: true })\n      .where(eq(secretMessages.id, id))\n      .returning();\n    return message;\n  }\n\n  async deleteSecretMessage(id: string): Promise<void> {\n    await db.delete(secretMessages).where(eq(secretMessages.id, id));\n  }\n\n  async getUnreadSecretMessageCount(userId: string): Promise<number> {\n    const result = await db.select({ count: sql<number>`count(*)` })\n      .from(secretMessages)\n      .innerJoin(secretMessageLinks, eq(secretMessages.linkId, secretMessageLinks.id))\n      .where(and(\n        eq(secretMessageLinks.userId, userId),\n        eq(secretMessages.isRead, false)\n      ));\n    return Number(result[0]?.count || 0);\n  }\n\n  // Email verification operations\n  async createEmailVerificationToken(userId: string): Promise<{ token: string; code: string }> {\n    const token = crypto.randomBytes(32).toString('hex');\n    const code = Math.floor(100000 + Math.random() * 900000).toString();\n    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);\n    \n    await db.update(emailVerificationTokens)\n      .set({ isUsed: true })\n      .where(and(\n        eq(emailVerificationTokens.userId, userId),\n        eq(emailVerificationTokens.isUsed, false)\n      ));\n    \n    await db.insert(emailVerificationTokens).values({\n      userId,\n      token,\n      code,\n      expiresAt,\n    });\n    \n    return { token, code };\n  }\n\n  async verifyEmailToken(token: string): Promise<boolean> {\n    const [verificationToken] = await db.select()\n      .from(emailVerificationTokens)\n      .where(eq(emailVerificationTokens.token, token));\n    \n    if (!verificationToken) {\n      return false;\n    }\n    \n    if (verificationToken.isUsed) {\n      return false;\n    }\n    \n    if (new Date() > verificationToken.expiresAt) {\n      return false;\n    }\n    \n    await db.update(emailVerificationTokens)\n      .set({ isUsed: true })\n      .where(eq(emailVerificationTokens.id, verificationToken.id));\n    \n    await this.markUserEmailVerified(verificationToken.userId);\n    \n    return true;\n  }\n\n  async verifyEmailCode(userId: string, code: string): Promise<boolean> {\n    const [verificationToken] = await db.select()\n      .from(emailVerificationTokens)\n      .where(and(\n        eq(emailVerificationTokens.userId, userId),\n        eq(emailVerificationTokens.code, code),\n        eq(emailVerificationTokens.isUsed, false)\n      ));\n    \n    if (!verificationToken) {\n      return false;\n    }\n    \n    if (new Date() > verificationToken.expiresAt) {\n      return false;\n    }\n    \n    await db.update(emailVerificationTokens)\n      .set({ isUsed: true })\n      .where(eq(emailVerificationTokens.id, verificationToken.id));\n    \n    await this.markUserEmailVerified(userId);\n    \n    return true;\n  }\n\n  async markUserEmailVerified(userId: string): Promise<void> {\n    await db.update(users)\n      .set({ emailVerified: true })\n      .where(eq(users.id, userId));\n  }\n\n  async isUserEmailVerified(userId: string): Promise<boolean> {\n    const [user] = await db.select({ emailVerified: users.emailVerified })\n      .from(users)\n      .where(eq(users.id, userId));\n    return user?.emailVerified ?? false;\n  }\n\n  // ========================================\n  // Study Materials Operations\n  // ========================================\n\n  async getStudyMaterials(filters?: { level?: string; faculty?: string; courseCode?: string; materialType?: string; search?: string }): Promise<(StudyMaterial & { uploader: User })[]> {\n    let query = db\n      .select()\n      .from(studyMaterials)\n      .innerJoin(users, eq(studyMaterials.uploaderId, users.id))\n      .where(eq(studyMaterials.isActive, true))\n      .orderBy(desc(studyMaterials.createdAt));\n\n    const result = await query;\n\n    let filtered = result.map(row => ({ ...row.study_materials, uploader: row.users }));\n\n    if (filters?.level) {\n      filtered = filtered.filter(m => m.level === filters.level);\n    }\n    if (filters?.faculty) {\n      filtered = filtered.filter(m => m.faculty?.toLowerCase().includes(filters.faculty!.toLowerCase()));\n    }\n    if (filters?.courseCode) {\n      filtered = filtered.filter(m => m.courseCode.toLowerCase().includes(filters.courseCode!.toLowerCase()));\n    }\n    if (filters?.materialType) {\n      filtered = filtered.filter(m => m.materialType === filters.materialType);\n    }\n    if (filters?.search) {\n      const searchLower = filters.search.toLowerCase();\n      filtered = filtered.filter(m => \n        m.title.toLowerCase().includes(searchLower) ||\n        m.courseCode.toLowerCase().includes(searchLower) ||\n        m.courseName?.toLowerCase().includes(searchLower)\n      );\n    }\n\n    return filtered;\n  }\n\n  async getStudyMaterial(id: string): Promise<(StudyMaterial & { uploader: User }) | undefined> {\n    const result = await db\n      .select()\n      .from(studyMaterials)\n      .innerJoin(users, eq(studyMaterials.uploaderId, users.id))\n      .where(eq(studyMaterials.id, id));\n\n    if (result.length === 0) return undefined;\n    \n    return { ...result[0].study_materials, uploader: result[0].users };\n  }\n\n  async createStudyMaterial(data: Partial<InsertStudyMaterial> & { uploaderId: string; fileUrl: string }): Promise<StudyMaterial> {\n    const [material] = await db.insert(studyMaterials).values({\n      uploaderId: data.uploaderId,\n      title: data.title || \"Untitled Material\",\n      description: data.description,\n      materialType: data.materialType || \"past_question\",\n      courseCode: data.courseCode || \"N/A\",\n      courseName: data.courseName,\n      faculty: data.faculty,\n      department: data.department,\n      level: data.level || \"100L\",\n      semester: data.semester,\n      academicYear: data.academicYear,\n      fileUrl: data.fileUrl,\n      previewUrl: data.previewUrl,\n      thumbnailUrl: data.thumbnailUrl,\n      fileSize: data.fileSize,\n      pageCount: data.pageCount,\n      price: data.price || \"0.00\",\n      isFree: data.isFree ?? true,\n      isApproved: true,\n      isActive: true,\n    }).returning();\n\n    return material;\n  }\n\n  async updateStudyMaterial(id: string, data: Partial<StudyMaterial>): Promise<StudyMaterial> {\n    const [material] = await db.update(studyMaterials)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(studyMaterials.id, id))\n      .returning();\n    return material;\n  }\n\n  async deleteStudyMaterial(id: string): Promise<void> {\n    await db.update(studyMaterials)\n      .set({ isActive: false })\n      .where(eq(studyMaterials.id, id));\n  }\n\n  async purchaseStudyMaterial(materialId: string, buyerId: string, amount: string): Promise<StudyMaterialPurchase> {\n    const [purchase] = await db.insert(studyMaterialPurchases).values({\n      materialId,\n      buyerId,\n      amount,\n    }).returning();\n    return purchase;\n  }\n\n  async hasUserPurchasedMaterial(materialId: string, userId: string): Promise<boolean> {\n    const [purchase] = await db.select()\n      .from(studyMaterialPurchases)\n      .where(and(\n        eq(studyMaterialPurchases.materialId, materialId),\n        eq(studyMaterialPurchases.buyerId, userId)\n      ));\n    return !!purchase;\n  }\n\n  async getUserStudyMaterials(userId: string): Promise<StudyMaterial[]> {\n    return await db.select()\n      .from(studyMaterials)\n      .where(and(\n        eq(studyMaterials.uploaderId, userId),\n        eq(studyMaterials.isActive, true)\n      ))\n      .orderBy(desc(studyMaterials.createdAt));\n  }\n\n  async incrementMaterialViews(id: string): Promise<void> {\n    await db.update(studyMaterials)\n      .set({ views: sql`${studyMaterials.views} + 1` })\n      .where(eq(studyMaterials.id, id));\n  }\n\n  async incrementMaterialDownloads(id: string): Promise<void> {\n    await db.update(studyMaterials)\n      .set({ downloads: sql`${studyMaterials.downloads} + 1` })\n      .where(eq(studyMaterials.id, id));\n  }\n\n  async rateStudyMaterial(materialId: string, userId: string, rating: number, review?: string): Promise<StudyMaterialRating> {\n    const existing = await db.select()\n      .from(studyMaterialRatings)\n      .where(and(\n        eq(studyMaterialRatings.materialId, materialId),\n        eq(studyMaterialRatings.userId, userId)\n      ));\n\n    if (existing.length > 0) {\n      const [updated] = await db.update(studyMaterialRatings)\n        .set({ rating, review })\n        .where(eq(studyMaterialRatings.id, existing[0].id))\n        .returning();\n      \n      await this.updateMaterialRatingStats(materialId);\n      return updated;\n    }\n\n    const [newRating] = await db.insert(studyMaterialRatings).values({\n      materialId,\n      userId,\n      rating,\n      review,\n    }).returning();\n\n    await this.updateMaterialRatingStats(materialId);\n    return newRating;\n  }\n\n  private async updateMaterialRatingStats(materialId: string): Promise<void> {\n    const ratings = await db.select()\n      .from(studyMaterialRatings)\n      .where(eq(studyMaterialRatings.materialId, materialId));\n\n    if (ratings.length === 0) return;\n\n    const avgRating = ratings.reduce((sum, r) => sum + r.rating, 0) / ratings.length;\n    \n    await db.update(studyMaterials)\n      .set({ \n        rating: avgRating.toFixed(2),\n        ratingCount: ratings.length \n      })\n      .where(eq(studyMaterials.id, materialId));\n  }\n\n  async getMaterialRatings(materialId: string): Promise<(StudyMaterialRating & { user: User })[]> {\n    const result = await db.select()\n      .from(studyMaterialRatings)\n      .innerJoin(users, eq(studyMaterialRatings.userId, users.id))\n      .where(eq(studyMaterialRatings.materialId, materialId))\n      .orderBy(desc(studyMaterialRatings.createdAt));\n\n    return result.map(row => ({ ...row.study_material_ratings, user: row.users }));\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":226961,"size_tokens":null},"server/db.ts":{"content":"// Database blueprint integration\nimport { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport { sql } from 'drizzle-orm';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n\n// Initialize database sequences and required schema objects\nexport async function initializeDatabaseSequences(): Promise<void> {\n  try {\n    // Create ticket number sequence if it doesn't exist\n    // This ensures atomic, race-condition safe ticket number generation\n    await db.execute(sql`\n      CREATE SEQUENCE IF NOT EXISTS ticket_number_seq \n      START WITH 1 \n      INCREMENT BY 1\n    `);\n    console.log('Database sequences initialized successfully');\n  } catch (error) {\n    console.error('Failed to initialize database sequences:', error);\n    // Don't throw - the sequence might already exist or there might be permission issues\n    // The application can still function, and errors will be caught when trying to create tickets\n  }\n}\n","path":null,"size_bytes":1300,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider duration={3000}>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} duration={3000} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":804,"size_tokens":null},"client/src/hooks/useAuth.ts":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/schema\";\n\nexport function useAuth() {\n  const { data: user, isLoading, isError } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n    retry: false,\n  });\n\n  // Check if user is super admin via environment variable\n  const isSuperAdmin = (() => {\n    if (!user?.id) return false;\n    const adminIds = import.meta.env.VITE_SUPER_ADMIN_IDS?.split(',').map((id: string) => id.trim()) || [];\n    return adminIds.includes(user.id);\n  })();\n\n  return {\n    user,\n    isLoading,\n    isError,\n    isAuthenticated: !!user && !isError,\n    isSeller: user?.role === \"seller\" || user?.role === \"admin\",\n    isBuyer: user?.role === \"buyer\" || user?.role === \"admin\",\n    isAdmin: user?.role === \"admin\" || isSuperAdmin,\n    isVerified: user?.isVerified || user?.ninVerified || false,\n    isEmailVerified: user?.emailVerified || false,\n  };\n}\n","path":null,"size_bytes":917,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ChatBot.tsx":{"content":"import { useState, useRef, useEffect, useCallback } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { \n  MessageCircle, \n  X, \n  Send, \n  AlertTriangle, \n  Volume2, \n  VolumeX, \n  Wallet, \n  ShoppingBag, \n  Shield, \n  Gamepad2, \n  HelpCircle,\n  PlusCircle,\n  User,\n  MessageSquare,\n  Gift,\n  BarChart3,\n  Home,\n  Search,\n  ArrowLeft,\n  Trash2,\n  Clock,\n  Mic,\n  MicOff\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card } from \"@/components/ui/card\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface SpeechRecognitionEvent extends Event {\n  results: SpeechRecognitionResultList;\n  resultIndex: number;\n}\n\ninterface SpeechRecognitionErrorEvent extends Event {\n  error: string;\n  message?: string;\n}\n\ninterface SpeechRecognition extends EventTarget {\n  continuous: boolean;\n  interimResults: boolean;\n  lang: string;\n  start(): void;\n  stop(): void;\n  abort(): void;\n  onresult: ((event: SpeechRecognitionEvent) => void) | null;\n  onerror: ((event: SpeechRecognitionErrorEvent) => void) | null;\n  onend: (() => void) | null;\n  onstart: (() => void) | null;\n}\n\ndeclare global {\n  interface Window {\n    SpeechRecognition: new () => SpeechRecognition;\n    webkitSpeechRecognition: new () => SpeechRecognition;\n  }\n}\n\ninterface Message {\n  id: string;\n  role: \"user\" | \"assistant\";\n  content: string;\n}\n\ninterface QuickAction {\n  label: string;\n  message: string;\n  icon: any;\n  navigateTo?: string;\n}\n\nconst QUICK_ACTIONS: QuickAction[] = [\n  { label: \"How to sell?\", message: \"How do I sell items on this app?\", icon: PlusCircle, navigateTo: \"/my-ads\" },\n  { label: \"My balance\", message: \"I want to check my wallet balance\", icon: Wallet, navigateTo: \"/wallet\" },\n  { label: \"Report scam\", message: \"I need to report a scammer\", icon: AlertTriangle, navigateTo: \"/support\" },\n  { label: \"Escrow?\", message: \"How does escrow work?\", icon: Shield },\n  { label: \"Games\", message: \"Tell me about the games I can play\", icon: Gamepad2, navigateTo: \"/games\" },\n];\n\nconst CONTEXT_MESSAGES: Record<string, string> = {\n  \"/\": \"I see you're browsing products! I can help you find items, understand categories, or get the best deals. What are you looking for?\",\n  \"/games\": \"Ready to play? We have Ludo, Word Battle, and Trivia games! You can play for fun or stake money to win. Want to know how any game works?\",\n  \"/wallet\": \"Looking at your wallet? I can help with deposits, withdrawals, or explain how escrow works. What do you need?\",\n  \"/profile\": \"Need to update your profile or get verified? I can guide you through student verification or NIN verification for higher trust scores.\",\n  \"/messages\": \"Chatting with sellers or buyers? Remember to keep all negotiations in-app and ALWAYS use escrow for payments!\",\n  \"/my-ads\": \"Managing your listings? I can help you boost products, edit listings, or create new ones. What would you like to do?\",\n  \"/referrals\": \"Want to earn money by referring friends? Share your unique code and get N500 for each verified signup plus 2% of their trading fees!\",\n  \"/support\": \"Need help? You can submit a support ticket here. For scam reports, I recommend selecting the Scam Report category for faster response.\",\n  \"/seller/dashboard\": \"Checking your seller stats? I can help you understand your analytics, manage orders, or boost slow-moving products.\",\n  \"/admin\": \"Admin panel access! You can manage users, products, announcements, and handle disputes from here.\",\n  \"/the-plug\": \"Welcome to The Plug! This is where you can find exclusive deals and connect with verified sellers.\",\n  \"/checkout\": \"Ready to complete your purchase? I can help you with payment options and escrow protection.\",\n  \"/notifications\": \"Check your latest updates! I can help you understand any notifications you've received.\",\n  \"/announcements\": \"Stay informed with the latest campus announcements and updates!\",\n};\n\nfunction getPageName(path: string): string {\n  const pageNames: Record<string, string> = {\n    \"/\": \"Home\",\n    \"/games\": \"Games\",\n    \"/wallet\": \"Wallet\",\n    \"/profile\": \"Profile\",\n    \"/messages\": \"Messages\",\n    \"/my-ads\": \"My Ads\",\n    \"/referrals\": \"Referrals\",\n    \"/support\": \"Support\",\n    \"/seller/dashboard\": \"Seller Dashboard\",\n    \"/admin\": \"Admin\",\n    \"/notifications\": \"Notifications\",\n    \"/announcements\": \"Announcements\",\n    \"/the-plug\": \"The Plug\",\n    \"/checkout\": \"Checkout\",\n    \"/wishlist\": \"Wishlist\",\n    \"/vtu\": \"VTU Services\",\n    \"/settings\": \"Settings\",\n    \"/legal\": \"Legal\",\n    \"/kyc\": \"KYC Verification\",\n    \"/stories\": \"Stories\",\n    \"/confessions\": \"Confessions\",\n    \"/communities\": \"Communities\",\n  };\n  \n  if (path.startsWith(\"/products/\")) return \"Product Detail\";\n  if (path.startsWith(\"/profile/\")) return \"Profile\";\n  if (path.startsWith(\"/messages/\")) return \"Messages\";\n  if (path.startsWith(\"/chat/\")) return \"Chat\";\n  \n  return pageNames[path] || \"App\";\n}\n\nfunction formatMessage(content: string): string {\n  let formatted = content;\n  formatted = formatted.replace(/\\*\\*\\*/g, '');\n  formatted = formatted.replace(/\\*\\*/g, '');\n  formatted = formatted.replace(/\\*/g, '');\n  formatted = formatted.replace(/_{2,}/g, '');\n  formatted = formatted.replace(/`{1,3}/g, '');\n  formatted = formatted.replace(/^#+\\s/gm, '');\n  return formatted.trim();\n}\n\nconst NOTIFICATION_SOUND = \"data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQcAQMC2qaSfkX1pUUQ0JyclKC45UVCKL0ptnLPS3My0mH5xZ19WUk5KPz84NjUzMTAwLy4sKyopJyYlJCMhIB4eHRsaGhkYFxYVFBQTEhEREA8ODg0NDAsLCgoJCQgIBwcGBgUFBQQEBAMDAwICAgIBAQEBAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQgGRQQDA0KBwUDAQECAgMFBggKDA4REhQYGx0gIycqLC4wMzU3OT0/QUNGSU1QVFhbX2NnamtvdHl+goeLj5OYnKCkqK2xtbnBxszT2d/l7PL4/wCBhYqFbA==\";\n\nfunction generateMessageId(): string {\n  return `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n}\n\nconst INITIAL_MESSAGE: Message = {\n  id: generateMessageId(),\n  role: \"assistant\",\n  content: \"Hey! I'm your campus marketplace assistant. I sabi everything about buying, selling, wallet, games, and staying safe from scams. How I fit help you today? Tap any quick action below or ask me anything!\",\n};\n\nfunction getSpeechRecognition(): SpeechRecognition | null {\n  if (typeof window === \"undefined\") return null;\n  const SpeechRecognitionClass = window.SpeechRecognition || window.webkitSpeechRecognition;\n  if (!SpeechRecognitionClass) return null;\n  return new SpeechRecognitionClass();\n}\n\nexport default function ChatBot() {\n  const [location, navigate] = useLocation();\n  const { toast } = useToast();\n  const [isOpen, setIsOpen] = useState(false);\n  const [hasGreetedForPage, setHasGreetedForPage] = useState<string | null>(null);\n  const [messages, setMessages] = useState<Message[]>([INITIAL_MESSAGE]);\n  const [input, setInput] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [loadingTime, setLoadingTime] = useState(0);\n  const [showPaymentWarning, setShowPaymentWarning] = useState(false);\n  const [soundEnabled, setSoundEnabled] = useState(true);\n  const [isListening, setIsListening] = useState(false);\n  const [speechSupported, setSpeechSupported] = useState(true);\n  const scrollRef = useRef<HTMLDivElement>(null);\n  const audioRef = useRef<HTMLAudioElement | null>(null);\n  const loadingTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const recognitionRef = useRef<SpeechRecognition | null>(null);\n\n  useEffect(() => {\n    audioRef.current = new Audio(NOTIFICATION_SOUND);\n    audioRef.current.volume = 0.3;\n    \n    const recognition = getSpeechRecognition();\n    if (!recognition) {\n      setSpeechSupported(false);\n    } else {\n      recognitionRef.current = recognition;\n      recognition.continuous = false;\n      recognition.interimResults = false;\n      recognition.lang = \"en-US\";\n      \n      recognition.onresult = (event: SpeechRecognitionEvent) => {\n        const transcript = event.results[0][0].transcript;\n        setInput((prev) => prev + (prev ? \" \" : \"\") + transcript);\n        setIsListening(false);\n      };\n      \n      recognition.onerror = (event: SpeechRecognitionErrorEvent) => {\n        console.error(\"Speech recognition error:\", event.error);\n        setIsListening(false);\n        if (event.error === \"not-allowed\") {\n          toast({\n            title: \"Microphone access denied\",\n            description: \"Please allow microphone access to use voice input.\",\n            variant: \"destructive\",\n          });\n        } else if (event.error !== \"aborted\") {\n          toast({\n            title: \"Voice input error\",\n            description: \"Could not understand. Please try again.\",\n            variant: \"destructive\",\n          });\n        }\n      };\n      \n      recognition.onend = () => {\n        setIsListening(false);\n      };\n    }\n    \n    return () => {\n      if (recognitionRef.current) {\n        recognitionRef.current.abort();\n      }\n    };\n  }, [toast]);\n\n  useEffect(() => {\n    if (scrollRef.current) {\n      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;\n    }\n  }, [messages]);\n\n  useEffect(() => {\n    if (isLoading) {\n      setLoadingTime(0);\n      loadingTimerRef.current = setInterval(() => {\n        setLoadingTime((prev) => prev + 1);\n      }, 1000);\n    } else {\n      if (loadingTimerRef.current) {\n        clearInterval(loadingTimerRef.current);\n        loadingTimerRef.current = null;\n      }\n      setLoadingTime(0);\n    }\n\n    return () => {\n      if (loadingTimerRef.current) {\n        clearInterval(loadingTimerRef.current);\n      }\n    };\n  }, [isLoading]);\n\n  useEffect(() => {\n    if (isOpen && location !== hasGreetedForPage && CONTEXT_MESSAGES[location]) {\n      const contextMessage = CONTEXT_MESSAGES[location];\n      if (contextMessage && messages.length <= 2) {\n        setMessages((prev) => {\n          const lastMessage = prev[prev.length - 1];\n          if (lastMessage?.content !== contextMessage) {\n            return [...prev, { id: generateMessageId(), role: \"assistant\", content: contextMessage }];\n          }\n          return prev;\n        });\n        setHasGreetedForPage(location);\n      }\n    }\n  }, [isOpen, location, hasGreetedForPage, messages.length]);\n\n  const playNotificationSound = () => {\n    if (soundEnabled && audioRef.current) {\n      audioRef.current.currentTime = 0;\n      audioRef.current.play().catch(() => {});\n    }\n  };\n\n  const toggleVoiceInput = useCallback(() => {\n    if (!speechSupported) {\n      toast({\n        title: \"Voice input not supported\",\n        description: \"Your browser doesn't support voice input. Try Chrome, Edge, or Safari.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (isListening) {\n      recognitionRef.current?.abort();\n      setIsListening(false);\n    } else {\n      try {\n        recognitionRef.current?.start();\n        setIsListening(true);\n      } catch (error) {\n        console.error(\"Failed to start speech recognition:\", error);\n        toast({\n          title: \"Voice input error\",\n          description: \"Could not start voice input. Please try again.\",\n          variant: \"destructive\",\n        });\n      }\n    }\n  }, [isListening, speechSupported, toast]);\n\n  const deleteMessage = useCallback((messageId: string) => {\n    setMessages((prev) => prev.filter((msg) => msg.id !== messageId));\n  }, []);\n\n  const sendMessage = async (messageText?: string, navigateAfter?: string) => {\n    const userMessage = (messageText || input).trim();\n    if (!userMessage || isLoading) return;\n\n    setInput(\"\");\n    setIsLoading(true);\n    setShowPaymentWarning(false);\n\n    setMessages((prev) => [...prev, { id: generateMessageId(), role: \"user\", content: userMessage }]);\n\n    try {\n      const res = await fetch(\"/api/chatbot\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ \n          message: userMessage,\n          currentPage: getPageName(location)\n        }),\n      });\n\n      const data = await res.json();\n\n      if (data.hasPaymentWarning) {\n        setShowPaymentWarning(true);\n      }\n\n      const formattedMessage = formatMessage(data.message || \"I no fit get response now. Try again!\");\n\n      setMessages((prev) => [\n        ...prev,\n        { id: generateMessageId(), role: \"assistant\", content: formattedMessage },\n      ]);\n\n      playNotificationSound();\n\n      if (navigateAfter) {\n        setTimeout(() => {\n          setMessages((prev) => [\n            ...prev,\n            { id: generateMessageId(), role: \"assistant\", content: `Taking you to ${getPageName(navigateAfter)} now...` },\n          ]);\n          setTimeout(() => {\n            navigate(navigateAfter);\n            setIsOpen(false);\n          }, 1000);\n        }, 1500);\n      }\n    } catch (error: any) {\n      console.error(\"Chatbot error:\", error);\n      setMessages((prev) => [\n        ...prev,\n        {\n          id: generateMessageId(),\n          role: \"assistant\",\n          content: \"Omo, something don wrong. Network no dey flow well. Abeg try again!\",\n        },\n      ]);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleKeyPress = (e: React.KeyboardEvent) => {\n    if (e.key === \"Enter\" && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  };\n\n  const handleQuickAction = (action: QuickAction) => {\n    sendMessage(action.message, action.navigateTo);\n  };\n\n  const handleNavigateAction = (path: string, label: string) => {\n    setMessages((prev) => [\n      ...prev,\n      { id: generateMessageId(), role: \"user\", content: `Take me to ${label}` },\n      { id: generateMessageId(), role: \"assistant\", content: `No wahala! Taking you to ${label} now...` },\n    ]);\n    playNotificationSound();\n    setTimeout(() => {\n      navigate(path);\n      setIsOpen(false);\n    }, 1000);\n  };\n\n  const clearChat = () => {\n    setMessages([{ ...INITIAL_MESSAGE, id: generateMessageId() }]);\n    setShowPaymentWarning(false);\n    setHasGreetedForPage(null);\n  };\n\n  const goBack = () => {\n    window.history.back();\n  };\n\n  const isNotOnHome = location !== \"/\";\n\n  if (!isOpen) {\n    return (\n      <Button\n        size=\"lg\"\n        className=\"fixed bottom-24 right-4 sm:bottom-6 sm:right-6 rounded-full shadow-2xl z-[9999] bg-primary border-2 border-primary-foreground/10 h-14 w-14\"\n        onClick={() => setIsOpen(true)}\n        data-testid=\"button-open-chatbot\"\n        aria-label=\"Open chat assistant\"\n      >\n        <MessageCircle className=\"h-6 w-6\" />\n        <span className=\"absolute -top-1 -right-1 h-4 w-4 bg-green-500 rounded-full border-2 border-background animate-pulse\"></span>\n      </Button>\n    );\n  }\n\n  return (\n    <Card className=\"fixed bottom-24 right-4 sm:bottom-6 sm:right-6 w-[calc(100vw-2rem)] sm:w-[400px] h-[70vh] sm:h-[600px] max-h-[600px] shadow-2xl flex flex-col z-[9999] border-2 bg-background/95 backdrop-blur-sm\" data-testid=\"card-chatbot\">\n      <div className=\"flex items-center justify-between gap-2 p-3 border-b bg-background/80 backdrop-blur-sm\">\n        <div className=\"flex items-center gap-2\">\n          {isNotOnHome && (\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              onClick={goBack}\n              data-testid=\"button-go-back\"\n              aria-label=\"Go back\"\n            >\n              <ArrowLeft className=\"h-4 w-4\" />\n            </Button>\n          )}\n          <div className=\"h-9 w-9 rounded-full bg-primary flex items-center justify-center\">\n            <MessageCircle className=\"h-4 w-4 text-primary-foreground\" />\n          </div>\n          <div>\n            <h3 className=\"font-semibold text-sm\">Campus AI Assistant</h3>\n            <div className=\"flex items-center gap-1\">\n              <span className=\"h-2 w-2 rounded-full bg-green-500\"></span>\n              <span className=\"text-xs text-muted-foreground\">Online - Pidgin and English</span>\n            </div>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <Button\n            size=\"icon\"\n            variant=\"ghost\"\n            onClick={clearChat}\n            data-testid=\"button-clear-chat\"\n            aria-label=\"Clear chat\"\n          >\n            <Trash2 className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            size=\"icon\"\n            variant=\"ghost\"\n            onClick={() => setSoundEnabled(!soundEnabled)}\n            data-testid=\"button-toggle-sound\"\n            aria-label={soundEnabled ? \"Mute notifications\" : \"Enable notifications\"}\n          >\n            {soundEnabled ? (\n              <Volume2 className=\"h-4 w-4\" />\n            ) : (\n              <VolumeX className=\"h-4 w-4 text-muted-foreground\" />\n            )}\n          </Button>\n          <Button\n            size=\"icon\"\n            variant=\"ghost\"\n            onClick={() => setIsOpen(false)}\n            data-testid=\"button-close-chatbot\"\n          >\n            <X className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n\n      {showPaymentWarning && (\n        <Alert variant=\"destructive\" className=\"m-3 mb-0\">\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription className=\"text-xs\">\n            PAYMENT WARNING: Only pay through app escrow! Outside payments = scam risk. We are not responsible!\n          </AlertDescription>\n        </Alert>\n      )}\n\n      <ScrollArea className=\"flex-1 p-3 bg-background/50 backdrop-blur-sm\" ref={scrollRef}>\n        <div className=\"space-y-3\">\n          {messages.map((message, index) => (\n            <div\n              key={message.id}\n              className={`flex group items-start gap-1 ${message.role === \"user\" ? \"justify-end\" : \"justify-start\"}`}\n              data-testid={`message-${message.role}-${index}`}\n            >\n              {message.role === \"user\" && (\n                <button\n                  className=\"h-6 w-6 shrink-0 mt-1 flex items-center justify-center rounded-md hover:bg-muted invisible group-hover:visible\"\n                  onClick={() => deleteMessage(message.id)}\n                  data-testid={`button-delete-message-${index}`}\n                  aria-label=\"Delete message\"\n                >\n                  <Trash2 className=\"h-3 w-3 text-muted-foreground\" />\n                </button>\n              )}\n              <div\n                className={`max-w-[85%] rounded-lg p-3 ${\n                  message.role === \"user\"\n                    ? \"bg-primary text-primary-foreground\"\n                    : \"bg-muted/80 backdrop-blur-sm\"\n                }`}\n              >\n                <p className=\"text-sm whitespace-pre-wrap leading-relaxed\">{formatMessage(message.content)}</p>\n              </div>\n            </div>\n          ))}\n          {isLoading && (\n            <div className=\"flex justify-start\" data-testid=\"loading-indicator\">\n              <div className=\"bg-muted/80 backdrop-blur-sm rounded-lg p-3\">\n                <div className=\"flex flex-col gap-1.5\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"flex gap-1\">\n                      <span className=\"h-2 w-2 rounded-full bg-primary animate-bounce\"></span>\n                      <span className=\"h-2 w-2 rounded-full bg-primary animate-bounce\" style={{ animationDelay: \"0.15s\" }}></span>\n                      <span className=\"h-2 w-2 rounded-full bg-primary animate-bounce\" style={{ animationDelay: \"0.3s\" }}></span>\n                    </div>\n                    <span className=\"text-xs text-muted-foreground\">Thinking...</span>\n                  </div>\n                  {loadingTime >= 2 && (\n                    <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n                      <Clock className=\"h-3 w-3\" />\n                      <span>\n                        {loadingTime}s - {loadingTime < 5 ? \"Almost there...\" : loadingTime < 10 ? \"Still working on it...\" : \"Taking a bit longer...\"}\n                      </span>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n      </ScrollArea>\n\n      <div className=\"p-3 border-t bg-background/80 backdrop-blur-sm space-y-2\">\n        <div className=\"overflow-x-auto scrollbar-hide\">\n          <div className=\"flex gap-1.5 pb-2\" data-testid=\"quick-actions-container\">\n            {QUICK_ACTIONS.map((action, index) => (\n              <Badge\n                key={index}\n                variant=\"secondary\"\n                className=\"cursor-pointer text-xs py-1.5 px-2.5 flex items-center gap-1.5 whitespace-nowrap shrink-0\"\n                onClick={() => handleQuickAction(action)}\n                data-testid={`quick-action-${index}`}\n              >\n                <action.icon className=\"h-3.5 w-3.5\" />\n                {action.label}\n              </Badge>\n            ))}\n          </div>\n        </div>\n\n        <div className=\"overflow-x-auto scrollbar-hide\">\n          <div className=\"flex gap-1.5 pb-1\" data-testid=\"navigate-actions-container\">\n            <Badge\n              variant=\"outline\"\n              className=\"cursor-pointer text-xs py-1 px-2 flex items-center gap-1 whitespace-nowrap shrink-0\"\n              onClick={() => handleNavigateAction(\"/\", \"Home\")}\n              data-testid=\"nav-home\"\n            >\n              <Home className=\"h-3 w-3\" />\n              Home\n            </Badge>\n            <Badge\n              variant=\"outline\"\n              className=\"cursor-pointer text-xs py-1 px-2 flex items-center gap-1 whitespace-nowrap shrink-0\"\n              onClick={() => handleNavigateAction(\"/wallet\", \"Wallet\")}\n              data-testid=\"nav-wallet\"\n            >\n              <Wallet className=\"h-3 w-3\" />\n              Wallet\n            </Badge>\n            <Badge\n              variant=\"outline\"\n              className=\"cursor-pointer text-xs py-1 px-2 flex items-center gap-1 whitespace-nowrap shrink-0\"\n              onClick={() => handleNavigateAction(\"/games\", \"Games\")}\n              data-testid=\"nav-games\"\n            >\n              <Gamepad2 className=\"h-3 w-3\" />\n              Games\n            </Badge>\n            <Badge\n              variant=\"outline\"\n              className=\"cursor-pointer text-xs py-1 px-2 flex items-center gap-1 whitespace-nowrap shrink-0\"\n              onClick={() => handleNavigateAction(\"/profile\", \"Profile\")}\n              data-testid=\"nav-profile\"\n            >\n              <User className=\"h-3 w-3\" />\n              Profile\n            </Badge>\n            <Badge\n              variant=\"outline\"\n              className=\"cursor-pointer text-xs py-1 px-2 flex items-center gap-1 whitespace-nowrap shrink-0\"\n              onClick={() => handleNavigateAction(\"/my-ads\", \"My Ads\")}\n              data-testid=\"nav-my-ads\"\n            >\n              <PlusCircle className=\"h-3 w-3\" />\n              My Ads\n            </Badge>\n            <Badge\n              variant=\"outline\"\n              className=\"cursor-pointer text-xs py-1 px-2 flex items-center gap-1 whitespace-nowrap shrink-0\"\n              onClick={() => handleNavigateAction(\"/support\", \"Support\")}\n              data-testid=\"nav-support\"\n            >\n              <HelpCircle className=\"h-3 w-3\" />\n              Support\n            </Badge>\n          </div>\n        </div>\n\n        <div className=\"flex gap-2\">\n          <Input\n            placeholder=\"Ask anything... (Pidgin or English)\"\n            value={input}\n            onChange={(e) => setInput(e.target.value)}\n            onKeyPress={handleKeyPress}\n            disabled={isLoading}\n            className=\"flex-1 bg-background/60 backdrop-blur-sm\"\n            data-testid=\"input-chatbot-message\"\n          />\n          <Button\n            size=\"icon\"\n            variant={isListening ? \"destructive\" : \"outline\"}\n            onClick={toggleVoiceInput}\n            disabled={isLoading}\n            className={isListening ? \"animate-pulse\" : \"\"}\n            data-testid=\"button-voice-input\"\n            aria-label={isListening ? \"Stop listening\" : \"Start voice input\"}\n          >\n            {isListening ? (\n              <MicOff className=\"h-4 w-4\" />\n            ) : (\n              <Mic className=\"h-4 w-4\" />\n            )}\n          </Button>\n          <Button\n            size=\"icon\"\n            onClick={() => sendMessage()}\n            disabled={isLoading || !input.trim()}\n            data-testid=\"button-send-message\"\n          >\n            <Send className=\"h-4 w-4\" />\n          </Button>\n        </div>\n        <p className=\"text-xs text-muted-foreground text-center\">\n          Currently on: {getPageName(location)}\n        </p>\n      </div>\n    </Card>\n  );\n}\n","path":null,"size_bytes":24828,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/pages/wishlist.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Heart, Trash2, ShoppingCart, MapPin, Loader2, Share2, ArrowLeft } from \"lucide-react\";\nimport type { Product, Watchlist, User } from \"@shared/schema\";\n\ntype WishlistItemWithProduct = Watchlist & {\n  product: Product & { seller: User };\n};\n\nexport default function WishlistPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading: authLoading } = useAuth();\n\n  const { data: wishlistItems = [], isLoading } = useQuery<WishlistItemWithProduct[]>({\n    queryKey: [\"/api/wishlist/full\"],\n    enabled: isAuthenticated,\n  });\n\n  const removeFromWishlistMutation = useMutation({\n    mutationFn: async (productId: string) => {\n      return await apiRequest(\"DELETE\", `/api/watchlist/${productId}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/watchlist\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wishlist/full\"] });\n      toast({\n        title: \"Removed from Wishlist\",\n        description: \"Item has been removed from your wishlist\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to remove from wishlist\",\n      });\n    },\n  });\n\n  const handleShare = async (product: Product) => {\n    const domain = window.location.origin;\n    const shareUrl = `${domain}/products/${product.id}`;\n    \n    try {\n      await navigator.clipboard.writeText(shareUrl);\n      toast({\n        title: \"Link Copied\",\n        description: \"Product link has been copied to your clipboard\",\n      });\n    } catch {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Failed to copy link\",\n      });\n    }\n  };\n\n  if (authLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"flex items-center justify-center min-h-[50vh]\">\n          <Loader2 className=\"h-8 w-8 animate-spin\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"flex flex-col items-center justify-center min-h-[50vh] text-center\">\n          <Heart className=\"h-16 w-16 text-muted-foreground mb-4\" />\n          <h2 className=\"text-2xl font-bold mb-2\">Sign in to view your wishlist</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            Save your favorite items and access them anytime\n          </p>\n          <Button onClick={() => setLocation(\"/\")}>\n            Go Home\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 pb-24\">\n      <div className=\"flex items-center gap-4 mb-6\">\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => setLocation(\"/\")}\n          data-testid=\"button-back\"\n        >\n          <ArrowLeft className=\"h-5 w-5\" />\n        </Button>\n        <div>\n          <h1 className=\"text-2xl font-bold flex items-center gap-2\">\n            <Heart className=\"h-6 w-6 text-red-500 fill-red-500\" />\n            My Wishlist\n          </h1>\n          <p className=\"text-muted-foreground text-sm\">\n            {wishlistItems.length} {wishlistItems.length === 1 ? \"item\" : \"items\"} saved\n          </p>\n        </div>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3\">\n          {[...Array(6)].map((_, i) => (\n            <Card key={i}>\n              <div className=\"aspect-square\">\n                <Skeleton className=\"h-full w-full\" />\n              </div>\n              <CardContent className=\"p-4\">\n                <Skeleton className=\"h-5 w-3/4 mb-2\" />\n                <Skeleton className=\"h-6 w-1/2 mb-2\" />\n                <Skeleton className=\"h-4 w-full\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : wishlistItems.length === 0 ? (\n        <div className=\"flex flex-col items-center justify-center min-h-[50vh] text-center\">\n          <Heart className=\"h-16 w-16 text-muted-foreground mb-4\" />\n          <h2 className=\"text-xl font-semibold mb-2\">Your wishlist is empty</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            Start adding items you love by clicking the heart icon\n          </p>\n          <Button onClick={() => setLocation(\"/\")}>\n            Browse Products\n          </Button>\n        </div>\n      ) : (\n        <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3\">\n          {wishlistItems.map((item) => {\n            const product = item.product;\n            if (!product) return null;\n\n            const price = typeof product.price === 'number' \n              ? product.price \n              : parseFloat(product.price as string) || 0;\n            const imageUrl = product.images?.[0] || \"/placeholder-product.png\";\n\n            return (\n              <Card \n                key={item.id} \n                className=\"group overflow-hidden hover-elevate active-elevate-2\"\n                data-testid={`card-wishlist-item-${product.id}`}\n              >\n                <div \n                  className=\"aspect-square relative overflow-hidden cursor-pointer\"\n                  onClick={() => setLocation(`/products/${product.id}`)}\n                >\n                  <img\n                    src={imageUrl}\n                    alt={product.title}\n                    className=\"h-full w-full object-cover transition-transform group-hover:scale-105\"\n                    loading=\"lazy\"\n                  />\n                  <div className=\"absolute top-2 right-2 flex gap-1\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        handleShare(product);\n                      }}\n                      className=\"bg-background/80 backdrop-blur-sm\"\n                      data-testid={`button-share-${product.id}`}\n                    >\n                      <Share2 className=\"h-4 w-4\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        removeFromWishlistMutation.mutate(product.id);\n                      }}\n                      disabled={removeFromWishlistMutation.isPending}\n                      className=\"bg-background/80 backdrop-blur-sm\"\n                      data-testid={`button-remove-wishlist-${product.id}`}\n                    >\n                      {removeFromWishlistMutation.isPending ? (\n                        <Loader2 className=\"h-4 w-4 animate-spin\" />\n                      ) : (\n                        <Trash2 className=\"h-4 w-4 text-destructive\" />\n                      )}\n                    </Button>\n                  </div>\n                  {product.condition && (\n                    <Badge variant=\"secondary\" className=\"absolute top-2 left-2\">\n                      {product.condition}\n                    </Badge>\n                  )}\n                  {!product.isAvailable && (\n                    <div className=\"absolute inset-0 bg-background/80 flex items-center justify-center\">\n                      <Badge variant=\"destructive\">Sold Out</Badge>\n                    </div>\n                  )}\n                </div>\n                <CardContent className=\"p-4\">\n                  <h3 \n                    className=\"font-semibold line-clamp-2 mb-2 cursor-pointer hover:underline\"\n                    onClick={() => setLocation(`/products/${product.id}`)}\n                    data-testid={`text-wishlist-product-title-${product.id}`}\n                  >\n                    {product.title}\n                  </h3>\n                  <div className=\"flex items-center justify-between gap-2 mb-2\">\n                    <p className=\"text-xl font-bold text-primary\" data-testid={`text-wishlist-product-price-${product.id}`}>\n                      ₦{price.toLocaleString()}\n                    </p>\n                    <Button\n                      variant=\"outline\"\n                      size=\"icon\"\n                      onClick={() => setLocation(`/products/${product.id}`)}\n                      disabled={!product.isAvailable}\n                      data-testid={`button-view-product-${product.id}`}\n                    >\n                      <ShoppingCart className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                  {product.location && (\n                    <div className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n                      <MapPin className=\"h-3 w-3\" />\n                      <span>{product.location}</span>\n                    </div>\n                  )}\n                  {product.seller && (\n                    <div className=\"mt-2 text-xs text-muted-foreground\">\n                      Sold by{\" \"}\n                      <button\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          setLocation(`/profile/${product.sellerId}`);\n                        }}\n                        className=\"font-medium hover:underline\"\n                      >\n                        {product.seller.firstName || \"Seller\"}\n                      </button>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":10039,"size_tokens":null},"client/src/pages/checkout.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useCart, CartItemWithProduct } from \"@/hooks/use-cart\";\nimport {\n  ShoppingCart,\n  MapPin,\n  Truck,\n  Users,\n  Wallet,\n  CreditCard,\n  ArrowLeft,\n  CheckCircle,\n  Loader2,\n  Package,\n} from \"lucide-react\";\nimport type { Wallet as WalletType } from \"@shared/schema\";\n\nconst PLATFORM_FEE_RATE = 0.035;\n\ninterface OrderSuccessData {\n  orderNumber: string;\n  orderId: string;\n}\n\nexport default function CheckoutPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const { cartItems, subtotal, isLoading: cartLoading, clearCart } = useCart();\n  \n  const [deliveryMethod, setDeliveryMethod] = useState<string>(\"campus_meetup\");\n  const [deliveryAddress, setDeliveryAddress] = useState(\"\");\n  const [deliveryLocation, setDeliveryLocation] = useState(\"\");\n  const [deliveryNotes, setDeliveryNotes] = useState(\"\");\n  const [paymentMethod, setPaymentMethod] = useState<string>(\"wallet\");\n  const [orderSuccess, setOrderSuccess] = useState<OrderSuccessData | null>(null);\n\n  const { data: wallet, isLoading: walletLoading } = useQuery<WalletType>({\n    queryKey: [\"/api/wallet\"],\n  });\n\n  const walletBalance = wallet ? parseFloat(wallet.balance as string) : 0;\n\n  const platformFee = Math.round(subtotal * PLATFORM_FEE_RATE * 100) / 100;\n  const isSquadPayment = paymentMethod === \"squad\" || paymentMethod === \"squad_card\" || paymentMethod === \"squad_ussd\";\n  const squadFeeEstimate = isSquadPayment \n    ? Math.min(Math.round(subtotal * 0.01 * 100) / 100, 1000)\n    : 0;\n  const total = subtotal + platformFee + squadFeeEstimate;\n\n  const createOrderMutation = useMutation({\n    mutationFn: async (data: { \n      productId: string; \n      deliveryMethod: string;\n      deliveryAddress?: string;\n      deliveryLocation?: string;\n      deliveryNotes?: string;\n    }) => {\n      const res = await apiRequest(\"POST\", \"/api/orders\", data);\n      return res.json();\n    },\n  });\n\n  const walletPaymentMutation = useMutation({\n    mutationFn: async (data: { \n      productId: string;\n      amount: number;\n    }) => {\n      const res = await apiRequest(\"POST\", \"/api/wallet/pay\", data);\n      return res.json();\n    },\n  });\n\n  const initializeSquadMutation = useMutation({\n    mutationFn: async (data: {\n      amount: string;\n      purpose: string;\n      paymentDescription: string;\n      paymentChannel?: \"transfer\" | \"card\" | \"ussd\";\n    }) => {\n      const res = await apiRequest(\"POST\", \"/api/squad/initialize\", data);\n      return res.json();\n    },\n  });\n\n  const handlePlaceOrder = async () => {\n    if (cartItems.length === 0) {\n      toast({\n        variant: \"destructive\",\n        title: \"Cart Empty\",\n        description: \"Please add items to your cart before checkout\",\n      });\n      return;\n    }\n\n    if (deliveryMethod === \"seller_delivery\" && (!deliveryAddress || !deliveryLocation)) {\n      toast({\n        variant: \"destructive\",\n        title: \"Delivery Details Required\",\n        description: \"Please provide delivery address and location\",\n      });\n      return;\n    }\n\n    try {\n      if (paymentMethod === \"wallet\") {\n        if (walletBalance < total) {\n          toast({\n            variant: \"destructive\",\n            title: \"Insufficient Balance\",\n            description: `Your wallet balance (₦${walletBalance.toLocaleString()}) is less than the total (₦${total.toLocaleString()})`,\n          });\n          return;\n        }\n\n        const orderResults = [];\n        for (const item of cartItems) {\n          const order = await createOrderMutation.mutateAsync({\n            productId: item.productId,\n            deliveryMethod,\n            deliveryAddress: deliveryMethod === \"seller_delivery\" ? deliveryAddress : undefined,\n            deliveryLocation: deliveryMethod === \"seller_delivery\" ? deliveryLocation : undefined,\n            deliveryNotes: deliveryNotes || undefined,\n          });\n          orderResults.push(order);\n        }\n\n        await clearCart();\n\n        queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/orders/buyer\"] });\n\n        const firstOrder = orderResults[0];\n        setOrderSuccess({\n          orderNumber: firstOrder.orderNumber,\n          orderId: firstOrder.id,\n        });\n\n        toast({\n          title: \"Order Placed Successfully\",\n          description: `Your order #${firstOrder.orderNumber} has been placed`,\n        });\n      } else {\n        localStorage.setItem(\"pendingCheckout\", JSON.stringify({\n          cartItems: cartItems.map(item => ({\n            productId: item.productId,\n            quantity: item.quantity,\n          })),\n          deliveryMethod,\n          deliveryAddress: deliveryMethod === \"seller_delivery\" ? deliveryAddress : undefined,\n          deliveryLocation: deliveryMethod === \"seller_delivery\" ? deliveryLocation : undefined,\n          deliveryNotes: deliveryNotes || undefined,\n        }));\n\n        // Determine payment channel based on selected method\n        let paymentChannel: \"transfer\" | \"card\" | \"ussd\" = \"transfer\";\n        if (paymentMethod === \"squad_card\") {\n          paymentChannel = \"card\";\n        } else if (paymentMethod === \"squad_ussd\") {\n          paymentChannel = \"ussd\";\n        }\n\n        const result = await initializeSquadMutation.mutateAsync({\n          amount: total.toFixed(2),\n          purpose: \"checkout_payment\",\n          paymentDescription: `Purchase of ${cartItems.length} item(s) from EKSU Marketplace`,\n          paymentChannel,\n        });\n\n        if (result.checkoutUrl) {\n          window.location.href = result.checkoutUrl;\n        } else {\n          throw new Error(\"No checkout URL received\");\n        }\n      }\n    } catch (error: any) {\n      console.error(\"Checkout error:\", error);\n      toast({\n        variant: \"destructive\",\n        title: \"Checkout Failed\",\n        description: error.message || \"Failed to process your order. Please try again.\",\n      });\n    }\n  };\n\n  if (orderSuccess) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-2xl\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex flex-col items-center text-center space-y-4\">\n              <div className=\"rounded-full bg-green-100 dark:bg-green-900/30 p-4\">\n                <CheckCircle className=\"h-12 w-12 text-green-600 dark:text-green-400\" />\n              </div>\n              <h1 className=\"text-2xl font-bold\">Order Placed Successfully!</h1>\n              <p className=\"text-muted-foreground\">\n                Thank you for your purchase. Your order has been confirmed.\n              </p>\n              <div className=\"bg-muted rounded-md p-4 w-full max-w-sm\">\n                <p className=\"text-sm text-muted-foreground\">Order Number</p>\n                <p className=\"text-2xl font-mono font-bold\" data-testid=\"text-order-number\">\n                  {orderSuccess.orderNumber}\n                </p>\n              </div>\n              <p className=\"text-sm text-muted-foreground\">\n                You will receive a notification when the seller confirms your order.\n              </p>\n              <div className=\"flex flex-col sm:flex-row gap-3 w-full sm:w-auto\">\n                <Button\n                  onClick={() => setLocation(\"/orders\")}\n                  data-testid=\"button-view-orders\"\n                >\n                  View My Orders\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setLocation(\"/\")}\n                  data-testid=\"button-continue-shopping\"\n                >\n                  Continue Shopping\n                </Button>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (cartLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-4xl\">\n        <Skeleton className=\"h-8 w-48 mb-6\" />\n        <div className=\"grid gap-6 lg:grid-cols-3\">\n          <div className=\"lg:col-span-2 space-y-4\">\n            <Skeleton className=\"h-64 w-full\" />\n            <Skeleton className=\"h-48 w-full\" />\n          </div>\n          <div>\n            <Skeleton className=\"h-80 w-full\" />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (cartItems.length === 0) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-2xl\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex flex-col items-center text-center space-y-4\">\n              <ShoppingCart className=\"h-16 w-16 text-muted-foreground\" />\n              <h2 className=\"text-xl font-semibold\">Your Cart is Empty</h2>\n              <p className=\"text-muted-foreground\">\n                Add some items to your cart to proceed with checkout\n              </p>\n              <Button onClick={() => setLocation(\"/\")} data-testid=\"button-start-shopping\">\n                Start Shopping\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const isProcessing = createOrderMutation.isPending || \n    walletPaymentMutation.isPending || \n    initializeSquadMutation.isPending;\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 max-w-4xl\">\n      <div className=\"flex items-center gap-3 mb-6\">\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => setLocation(\"/\")}\n          data-testid=\"button-back\"\n        >\n          <ArrowLeft className=\"h-5 w-5\" />\n        </Button>\n        <h1 className=\"text-2xl font-bold\" data-testid=\"text-checkout-title\">Checkout</h1>\n      </div>\n\n      <div className=\"grid gap-6 lg:grid-cols-3\">\n        <div className=\"lg:col-span-2 space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Package className=\"h-5 w-5\" />\n                Cart Items ({cartItems.length})\n              </CardTitle>\n              <CardDescription>Review your items before checkout</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                {cartItems.map((item) => (\n                  <CartItemCard key={item.id} item={item} />\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Truck className=\"h-5 w-5\" />\n                Delivery Method\n              </CardTitle>\n              <CardDescription>Choose how you want to receive your items</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <RadioGroup\n                value={deliveryMethod}\n                onValueChange={setDeliveryMethod}\n                className=\"space-y-3\"\n              >\n                <div className=\"flex items-center space-x-3 rounded-md border p-4 hover-elevate\">\n                  <RadioGroupItem value=\"campus_meetup\" id=\"campus_meetup\" data-testid=\"radio-campus-meetup\" />\n                  <Label htmlFor=\"campus_meetup\" className=\"flex-1 cursor-pointer\">\n                    <div className=\"flex items-center gap-2\">\n                      <Users className=\"h-4 w-4 text-muted-foreground\" />\n                      <span className=\"font-medium\">Campus Meetup</span>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      Meet the seller at a convenient location on campus\n                    </p>\n                  </Label>\n                </div>\n\n                <div className=\"flex items-center space-x-3 rounded-md border p-4 hover-elevate\">\n                  <RadioGroupItem value=\"pickup\" id=\"pickup\" data-testid=\"radio-pickup\" />\n                  <Label htmlFor=\"pickup\" className=\"flex-1 cursor-pointer\">\n                    <div className=\"flex items-center gap-2\">\n                      <MapPin className=\"h-4 w-4 text-muted-foreground\" />\n                      <span className=\"font-medium\">Pickup from Seller</span>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      Pick up the item from the seller's location\n                    </p>\n                  </Label>\n                </div>\n\n                <div className=\"flex items-center space-x-3 rounded-md border p-4 hover-elevate\">\n                  <RadioGroupItem value=\"seller_delivery\" id=\"seller_delivery\" data-testid=\"radio-delivery\" />\n                  <Label htmlFor=\"seller_delivery\" className=\"flex-1 cursor-pointer\">\n                    <div className=\"flex items-center gap-2\">\n                      <Truck className=\"h-4 w-4 text-muted-foreground\" />\n                      <span className=\"font-medium\">Delivery to Me</span>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      Seller delivers to your specified location\n                    </p>\n                  </Label>\n                </div>\n              </RadioGroup>\n\n              {deliveryMethod === \"seller_delivery\" && (\n                <div className=\"mt-4 space-y-4 p-4 bg-muted/50 rounded-md\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"deliveryLocation\">Delivery Location</Label>\n                    <Input\n                      id=\"deliveryLocation\"\n                      value={deliveryLocation}\n                      onChange={(e) => setDeliveryLocation(e.target.value)}\n                      placeholder=\"e.g., Phase 2, School Gate, Yemkem\"\n                      data-testid=\"input-delivery-location\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"deliveryAddress\">Delivery Address</Label>\n                    <Textarea\n                      id=\"deliveryAddress\"\n                      value={deliveryAddress}\n                      onChange={(e) => setDeliveryAddress(e.target.value)}\n                      placeholder=\"Enter your full delivery address\"\n                      className=\"resize-none\"\n                      data-testid=\"input-delivery-address\"\n                    />\n                  </div>\n                </div>\n              )}\n\n              <div className=\"mt-4 space-y-2\">\n                <Label htmlFor=\"deliveryNotes\">Delivery Notes (Optional)</Label>\n                <Textarea\n                  id=\"deliveryNotes\"\n                  value={deliveryNotes}\n                  onChange={(e) => setDeliveryNotes(e.target.value)}\n                  placeholder=\"Any special instructions for the seller?\"\n                  className=\"resize-none\"\n                  data-testid=\"input-delivery-notes\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <CreditCard className=\"h-5 w-5\" />\n                Payment Method\n              </CardTitle>\n              <CardDescription>Choose your preferred payment method</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <RadioGroup\n                value={paymentMethod}\n                onValueChange={setPaymentMethod}\n                className=\"space-y-3\"\n              >\n                <div className=\"flex items-center space-x-3 rounded-md border p-4 hover-elevate\">\n                  <RadioGroupItem value=\"wallet\" id=\"wallet\" data-testid=\"radio-wallet\" />\n                  <Label htmlFor=\"wallet\" className=\"flex-1 cursor-pointer\">\n                    <div className=\"flex items-center justify-between gap-2\">\n                      <div className=\"flex items-center gap-2\">\n                        <Wallet className=\"h-4 w-4 text-muted-foreground\" />\n                        <span className=\"font-medium\">Pay with Wallet</span>\n                      </div>\n                      {walletLoading ? (\n                        <Skeleton className=\"h-5 w-20\" />\n                      ) : (\n                        <Badge variant={walletBalance >= total ? \"default\" : \"destructive\"}>\n                          ₦{walletBalance.toLocaleString()}\n                        </Badge>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      Pay instantly from your wallet balance\n                    </p>\n                    {walletBalance < total && paymentMethod === \"wallet\" && (\n                      <p className=\"text-sm text-destructive mt-1\">\n                        Insufficient balance. Please fund your wallet or use Bank Transfer.\n                      </p>\n                    )}\n                  </Label>\n                </div>\n\n                <div className=\"flex items-center space-x-3 rounded-md border-2 border-green-300 dark:border-green-600 p-4 bg-green-50 dark:bg-green-950/30 hover-elevate\">\n                  <RadioGroupItem value=\"squad\" id=\"squad\" data-testid=\"radio-squad\" />\n                  <Label htmlFor=\"squad\" className=\"flex-1 cursor-pointer\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <CreditCard className=\"h-4 w-4 text-green-600\" />\n                      <span className=\"font-medium text-green-700 dark:text-green-400\">Pay with Squad/GTCO</span>\n                      <Badge variant=\"outline\" className=\"bg-green-100 text-green-700 border-green-300\">Instant</Badge>\n                    </div>\n                    <p className=\"text-sm text-green-600 dark:text-green-400 mt-1 font-medium\">\n                      Bank Transfer - Instant settlement (T+0)\n                    </p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      Funds arrive immediately. Fastest option for order confirmation.\n                    </p>\n                  </Label>\n                </div>\n\n                <div className=\"flex items-center space-x-3 rounded-md border p-4 hover-elevate\">\n                  <RadioGroupItem value=\"squad_card\" id=\"squad_card\" data-testid=\"radio-squad-card\" />\n                  <Label htmlFor=\"squad_card\" className=\"flex-1 cursor-pointer\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n                      <span className=\"font-medium\">Credit/Debit Card</span>\n                      <Badge variant=\"secondary\">1-3 Business Days</Badge>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      Standard settlement (T+1 to T+3). Order processes after payment clears.\n                    </p>\n                  </Label>\n                </div>\n\n                <div className=\"flex items-center space-x-3 rounded-md border p-4 hover-elevate\">\n                  <RadioGroupItem value=\"squad_ussd\" id=\"squad_ussd\" data-testid=\"radio-squad-ussd\" />\n                  <Label htmlFor=\"squad_ussd\" className=\"flex-1 cursor-pointer\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n                      <span className=\"font-medium\">USSD</span>\n                      <Badge variant=\"secondary\">1-2 Business Days</Badge>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      Pay using your bank's USSD code. Standard settlement timing.\n                    </p>\n                  </Label>\n                </div>\n              </RadioGroup>\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"lg:col-span-1\">\n          <Card className=\"sticky top-4\">\n            <CardHeader>\n              <CardTitle>Order Summary</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between gap-4\">\n                <span className=\"text-muted-foreground\">Subtotal</span>\n                <span data-testid=\"text-subtotal\">₦{subtotal.toLocaleString()}</span>\n              </div>\n              <div className=\"flex items-center justify-between gap-4\">\n                <span className=\"text-muted-foreground\">Platform Fee (3.5%)</span>\n                <span data-testid=\"text-platform-fee\">₦{platformFee.toLocaleString()}</span>\n              </div>\n              {isSquadPayment && (\n                <div className=\"flex items-center justify-between gap-4\">\n                  <span className=\"text-muted-foreground\">Payment Fee</span>\n                  <span data-testid=\"text-payment-fee\">₦{squadFeeEstimate.toLocaleString()}</span>\n                </div>\n              )}\n              <Separator />\n              <div className=\"flex items-center justify-between gap-4\">\n                <span className=\"font-semibold\">Total</span>\n                <span className=\"text-xl font-bold\" data-testid=\"text-total\">\n                  ₦{total.toLocaleString()}\n                </span>\n              </div>\n\n              <Button\n                className=\"w-full\"\n                size=\"lg\"\n                onClick={handlePlaceOrder}\n                disabled={\n                  isProcessing || \n                  (paymentMethod === \"wallet\" && walletBalance < total) ||\n                  (deliveryMethod === \"seller_delivery\" && (!deliveryAddress || !deliveryLocation))\n                }\n                data-testid=\"button-place-order\"\n              >\n                {isProcessing ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Processing...\n                  </>\n                ) : (\n                  <>\n                    {paymentMethod === \"wallet\" ? (\n                      <>\n                        <Wallet className=\"mr-2 h-4 w-4\" />\n                        Pay ₦{total.toLocaleString()}\n                      </>\n                    ) : paymentMethod === \"squad\" ? (\n                      <>\n                        <CreditCard className=\"mr-2 h-4 w-4\" />\n                        Pay ₦{total.toLocaleString()} (Instant)\n                      </>\n                    ) : paymentMethod === \"squad_card\" ? (\n                      <>\n                        <CreditCard className=\"mr-2 h-4 w-4\" />\n                        Pay ₦{total.toLocaleString()} (Card)\n                      </>\n                    ) : (\n                      <>\n                        <CreditCard className=\"mr-2 h-4 w-4\" />\n                        Pay ₦{total.toLocaleString()} (USSD)\n                      </>\n                    )}\n                  </>\n                )}\n              </Button>\n\n              <p className=\"text-xs text-muted-foreground text-center\">\n                By placing this order, you agree to our Terms of Service and Privacy Policy\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction CartItemCard({ item }: { item: CartItemWithProduct }) {\n  const images = item.product.images || [];\n  const imageUrl = images[0] || \"/placeholder-product.png\";\n  const priceValue = item.product.price;\n  const price = typeof priceValue === 'number' ? priceValue : parseFloat(priceValue as string) || 0;\n  const itemTotal = price * item.quantity;\n\n  return (\n    <div className=\"flex gap-4 py-3\" data-testid={`checkout-item-${item.id}`}>\n      <div className=\"h-20 w-20 flex-shrink-0 overflow-hidden rounded-md border\">\n        <img\n          src={imageUrl}\n          alt={item.product.title}\n          className=\"h-full w-full object-cover\"\n          loading=\"lazy\"\n        />\n      </div>\n      <div className=\"flex flex-1 flex-col\">\n        <h4 className=\"text-sm font-medium line-clamp-2\" data-testid={`checkout-item-title-${item.id}`}>\n          {item.product.title}\n        </h4>\n        <p className=\"text-sm text-muted-foreground\">\n          ₦{price.toLocaleString()} x {item.quantity}\n        </p>\n        <div className=\"mt-auto flex items-center justify-between\">\n          <Badge variant=\"secondary\" className=\"text-xs\">\n            Qty: {item.quantity}\n          </Badge>\n          <p className=\"text-sm font-semibold\" data-testid={`checkout-item-total-${item.id}`}>\n            ₦{itemTotal.toLocaleString()}\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":25179,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-4 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-4 sm:right-4 sm:top-auto sm:flex-col md:max-w-[380px]\",\n      className\n    )}\n    style={{ paddingBottom: 'env(safe-area-inset-bottom)' }}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-lg border p-4 pr-8 shadow-xl transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-red-500/50 bg-red-500 text-white dark:bg-red-600 dark:border-red-600/50\",\n        success:\n          \"success group border-green-500/50 bg-green-500 text-white dark:bg-green-600 dark:border-green-600/50\",\n        warning:\n          \"warning group border-yellow-500/50 bg-yellow-500 text-white dark:bg-yellow-600 dark:border-yellow-600/50\",\n        info:\n          \"info group border-blue-500/50 bg-blue-500 text-white dark:bg-blue-600 dark:border-blue-600/50\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-white/70 group-[.destructive]:hover:text-white group-[.success]:text-white/70 group-[.success]:hover:text-white group-[.warning]:text-white/70 group-[.warning]:hover:text-white group-[.info]:text-white/70 group-[.info]:hover:text-white\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":5412,"size_tokens":null},"client/src/lib/globalErrorHandler.ts":{"content":"/**\n * Global error handler for uncaught errors and unhandled promise rejections\n * This catches errors that escape React's ErrorBoundary\n */\n\n// Report error to backend\nasync function reportErrorToBackend(errorData: any) {\n  try {\n    await fetch(\"/api/errors/report\", {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(errorData),\n    });\n  } catch (err) {\n    console.error(\"Failed to report error to backend:\", err);\n  }\n}\n\n// Handle uncaught errors\nexport function setupGlobalErrorHandler() {\n  // Catch unhandled errors\n  window.addEventListener(\"error\", (event) => {\n    console.error(\"Uncaught error:\", event.error);\n    \n    reportErrorToBackend({\n      message: event.error?.message || event.message || \"Unknown error\",\n      stack: event.error?.stack || \"No stack trace available\",\n      url: window.location.href,\n      userAgent: navigator.userAgent,\n      timestamp: new Date().toISOString(),\n      type: \"uncaught_error\",\n      filename: event.filename,\n      lineno: event.lineno,\n      colno: event.colno,\n    });\n\n    // Prevent default error handling (optional - can show custom UI)\n    // event.preventDefault();\n  });\n\n  // Catch unhandled promise rejections\n  window.addEventListener(\"unhandledrejection\", (event) => {\n    console.error(\"Unhandled promise rejection:\", event.reason);\n    \n    reportErrorToBackend({\n      message: event.reason?.message || String(event.reason) || \"Unhandled promise rejection\",\n      stack: event.reason?.stack || \"No stack trace available\",\n      url: window.location.href,\n      userAgent: navigator.userAgent,\n      timestamp: new Date().toISOString(),\n      type: \"unhandled_rejection\",\n      promise: event.promise,\n    });\n\n    // Prevent default error handling (optional)\n    // event.preventDefault();\n  });\n\n  console.log(\"Global error handlers initialized\");\n}\n","path":null,"size_bytes":1881,"size_tokens":null},"client/src/components/games/LudoGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Label } from \"@/components/ui/label\";\nimport { Dice1, Dice2, Dice3, Dice4, Dice5, Dice6, RotateCcw, Trophy, Bot, User, Settings2, Play } from \"lucide-react\";\n\ninterface LudoGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype Player = \"player\" | \"ai\";\ntype DiceCount = 1 | 2 | 3;\ntype GamePhase = \"settings\" | \"playing\";\n\ninterface Token {\n  id: number;\n  player: Player;\n  position: number;\n  isHome: boolean;\n  isFinished: boolean;\n}\n\ninterface DiceResult {\n  values: number[];\n  total: number;\n  hasSix: boolean;\n}\n\nconst BOARD_SIZE = 15;\nconst TOTAL_PATH_LENGTH = 52;\nconst HOME_STRETCH_LENGTH = 6;\n\nconst SAFE_ZONES = [0, 8, 13, 21, 26, 34, 39, 47];\n\nconst PLAYER_PATH: { x: number; y: number }[] = [];\nconst AI_PATH: { x: number; y: number }[] = [];\n\nconst generatePaths = () => {\n  if (PLAYER_PATH.length > 0) return;\n  \n  const basePath: { x: number; y: number }[] = [\n    { x: 6, y: 13 }, { x: 6, y: 12 }, { x: 6, y: 11 }, { x: 6, y: 10 }, { x: 6, y: 9 },\n    { x: 5, y: 8 }, { x: 4, y: 8 }, { x: 3, y: 8 }, { x: 2, y: 8 }, { x: 1, y: 8 }, { x: 0, y: 8 },\n    { x: 0, y: 7 },\n    { x: 0, y: 6 }, { x: 1, y: 6 }, { x: 2, y: 6 }, { x: 3, y: 6 }, { x: 4, y: 6 }, { x: 5, y: 6 },\n    { x: 6, y: 5 }, { x: 6, y: 4 }, { x: 6, y: 3 }, { x: 6, y: 2 }, { x: 6, y: 1 }, { x: 6, y: 0 },\n    { x: 7, y: 0 },\n    { x: 8, y: 0 }, { x: 8, y: 1 }, { x: 8, y: 2 }, { x: 8, y: 3 }, { x: 8, y: 4 }, { x: 8, y: 5 },\n    { x: 9, y: 6 }, { x: 10, y: 6 }, { x: 11, y: 6 }, { x: 12, y: 6 }, { x: 13, y: 6 }, { x: 14, y: 6 },\n    { x: 14, y: 7 },\n    { x: 14, y: 8 }, { x: 13, y: 8 }, { x: 12, y: 8 }, { x: 11, y: 8 }, { x: 10, y: 8 }, { x: 9, y: 8 },\n    { x: 8, y: 9 }, { x: 8, y: 10 }, { x: 8, y: 11 }, { x: 8, y: 12 }, { x: 8, y: 13 }, { x: 8, y: 14 },\n    { x: 7, y: 14 },\n  ];\n\n  const playerHomeStretch = [\n    { x: 7, y: 13 }, { x: 7, y: 12 }, { x: 7, y: 11 }, { x: 7, y: 10 }, { x: 7, y: 9 }, { x: 7, y: 8 },\n  ];\n\n  const aiHomeStretch = [\n    { x: 7, y: 1 }, { x: 7, y: 2 }, { x: 7, y: 3 }, { x: 7, y: 4 }, { x: 7, y: 5 }, { x: 7, y: 6 },\n  ];\n\n  for (let i = 0; i < basePath.length; i++) {\n    PLAYER_PATH.push(basePath[i]);\n  }\n  for (let i = 0; i < playerHomeStretch.length; i++) {\n    PLAYER_PATH.push(playerHomeStretch[i]);\n  }\n\n  for (let i = 0; i < basePath.length; i++) {\n    AI_PATH.push(basePath[(i + 26) % basePath.length]);\n  }\n  for (let i = 0; i < aiHomeStretch.length; i++) {\n    AI_PATH.push(aiHomeStretch[i]);\n  }\n};\n\ngeneratePaths();\n\nconst getPlayerHomePositions = (): { x: number; y: number }[] => [\n  { x: 2, y: 11 }, { x: 3, y: 11 }, { x: 2, y: 12 }, { x: 3, y: 12 },\n];\n\nconst getAIHomePositions = (): { x: number; y: number }[] => [\n  { x: 11, y: 2 }, { x: 12, y: 2 }, { x: 11, y: 3 }, { x: 12, y: 3 },\n];\n\nconst secureRandom = (): number => {\n  const array = new Uint32Array(1);\n  crypto.getRandomValues(array);\n  return array[0] / 0x100000000;\n};\n\nconst rollSingleDie = (): number => {\n  return Math.floor(secureRandom() * 6) + 1;\n};\n\nconst rollDiceSet = (count: DiceCount): DiceResult => {\n  const values: number[] = [];\n  for (let i = 0; i < count; i++) {\n    values.push(rollSingleDie());\n  }\n  return {\n    values,\n    total: values.reduce((a, b) => a + b, 0),\n    hasSix: values.includes(6),\n  };\n};\n\nconst DiceDisplay = ({ values, isRolling }: { values: number[]; isRolling: boolean }) => {\n  const icons = [Dice1, Dice2, Dice3, Dice4, Dice5, Dice6];\n  \n  return (\n    <div className=\"flex items-center gap-2\">\n      {values.map((value, index) => {\n        const Icon = icons[value - 1] || Dice1;\n        return (\n          <motion.div\n            key={index}\n            animate={isRolling ? { \n              rotate: [0, 90, 180, 270, 360],\n              scale: [1, 1.1, 1, 1.1, 1]\n            } : { rotate: 0 }}\n            transition={{ \n              duration: 0.4, \n              repeat: isRolling ? Infinity : 0,\n              delay: index * 0.1\n            }}\n            className=\"relative\"\n          >\n            <div className=\"absolute inset-0 bg-gradient-to-br from-white/20 to-transparent rounded-lg\" />\n            <Icon className=\"h-10 w-10 drop-shadow-lg\" />\n          </motion.div>\n        );\n      })}\n    </div>\n  );\n};\n\nconst GameSettings = ({ \n  diceCount, \n  onDiceCountChange, \n  onStartGame \n}: { \n  diceCount: DiceCount; \n  onDiceCountChange: (count: DiceCount) => void;\n  onStartGame: () => void;\n}) => {\n  return (\n    <Card className=\"border-2\">\n      <CardHeader className=\"text-center pb-4\">\n        <div className=\"flex items-center justify-center gap-2 mb-2\">\n          <Settings2 className=\"h-6 w-6 text-primary\" />\n          <CardTitle className=\"text-xl\">Game Settings</CardTitle>\n        </div>\n        <p className=\"text-sm text-muted-foreground\">Configure your Ludo game before starting</p>\n      </CardHeader>\n      <CardContent className=\"space-y-6\">\n        <div className=\"space-y-4\">\n          <Label className=\"text-base font-semibold\">Number of Dice</Label>\n          <RadioGroup \n            value={String(diceCount)} \n            onValueChange={(v) => onDiceCountChange(Number(v) as DiceCount)}\n            className=\"grid gap-3\"\n          >\n            <div className=\"flex items-center space-x-3 p-4 rounded-lg border-2 border-muted hover:border-primary/50 transition-colors cursor-pointer\" onClick={() => onDiceCountChange(1)}>\n              <RadioGroupItem value=\"1\" id=\"dice-1\" />\n              <Label htmlFor=\"dice-1\" className=\"flex-1 cursor-pointer\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"font-medium\">1 Die (Standard)</p>\n                    <p className=\"text-xs text-muted-foreground\">Roll exactly 6 to exit home. Classic rules.</p>\n                  </div>\n                  <div className=\"flex gap-1\">\n                    <Dice6 className=\"h-6 w-6 text-muted-foreground\" />\n                  </div>\n                </div>\n              </Label>\n            </div>\n            \n            <div className=\"flex items-center space-x-3 p-4 rounded-lg border-2 border-muted hover:border-primary/50 transition-colors cursor-pointer\" onClick={() => onDiceCountChange(2)}>\n              <RadioGroupItem value=\"2\" id=\"dice-2\" />\n              <Label htmlFor=\"dice-2\" className=\"flex-1 cursor-pointer\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"font-medium\">2 Dice</p>\n                    <p className=\"text-xs text-muted-foreground\">Roll at least one 6 to exit. Sum for movement.</p>\n                  </div>\n                  <div className=\"flex gap-1\">\n                    <Dice5 className=\"h-6 w-6 text-muted-foreground\" />\n                    <Dice3 className=\"h-6 w-6 text-muted-foreground\" />\n                  </div>\n                </div>\n              </Label>\n            </div>\n            \n            <div className=\"flex items-center space-x-3 p-4 rounded-lg border-2 border-muted hover:border-primary/50 transition-colors cursor-pointer\" onClick={() => onDiceCountChange(3)}>\n              <RadioGroupItem value=\"3\" id=\"dice-3\" />\n              <Label htmlFor=\"dice-3\" className=\"flex-1 cursor-pointer\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"font-medium\">3 Dice</p>\n                    <p className=\"text-xs text-muted-foreground\">Even easier exit. Higher sums possible.</p>\n                  </div>\n                  <div className=\"flex gap-1\">\n                    <Dice4 className=\"h-6 w-6 text-muted-foreground\" />\n                    <Dice2 className=\"h-6 w-6 text-muted-foreground\" />\n                    <Dice6 className=\"h-6 w-6 text-muted-foreground\" />\n                  </div>\n                </div>\n              </Label>\n            </div>\n          </RadioGroup>\n        </div>\n        \n        <div className=\"pt-4 border-t\">\n          <Button \n            onClick={onStartGame} \n            className=\"w-full\" \n            size=\"lg\"\n            data-testid=\"button-start-ludo\"\n          >\n            <Play className=\"h-5 w-5 mr-2\" />\n            Start Game\n          </Button>\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nexport default function LudoGame({ stake, onGameEnd, isPractice }: LudoGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"settings\");\n  const [diceCount, setDiceCount] = useState<DiceCount>(1);\n  \n  const [tokens, setTokens] = useState<Token[]>([\n    { id: 0, player: \"player\", position: -1, isHome: true, isFinished: false },\n    { id: 1, player: \"player\", position: -1, isHome: true, isFinished: false },\n    { id: 2, player: \"player\", position: -1, isHome: true, isFinished: false },\n    { id: 3, player: \"player\", position: -1, isHome: true, isFinished: false },\n    { id: 4, player: \"ai\", position: -1, isHome: true, isFinished: false },\n    { id: 5, player: \"ai\", position: -1, isHome: true, isFinished: false },\n    { id: 6, player: \"ai\", position: -1, isHome: true, isFinished: false },\n    { id: 7, player: \"ai\", position: -1, isHome: true, isFinished: false },\n  ]);\n  \n  const [currentPlayer, setCurrentPlayer] = useState<Player>(\"player\");\n  const [diceResult, setDiceResult] = useState<DiceResult>({ values: [1], total: 1, hasSix: false });\n  const [isRolling, setIsRolling] = useState(false);\n  const [hasRolled, setHasRolled] = useState(false);\n  const [message, setMessage] = useState(\"Roll the dice to start!\");\n  const [gameOver, setGameOver] = useState(false);\n  const [winner, setWinner] = useState<Player | null>(null);\n  const [consecutiveSixes, setConsecutiveSixes] = useState(0);\n  const [movableTokens, setMovableTokens] = useState<number[]>([]);\n  const [captureAnimation, setCaptureAnimation] = useState<{ x: number; y: number } | null>(null);\n  const [isAiThinking, setIsAiThinking] = useState(false);\n  \n  const isProcessingRef = useRef(false);\n  const aiTurnRef = useRef(false);\n  const timeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current);\n      }\n    };\n  }, []);\n\n  const getTokensByPlayer = useCallback((player: Player) => {\n    return tokens.filter((t) => t.player === player);\n  }, [tokens]);\n\n  const checkWinner = useCallback(() => {\n    const playerTokens = getTokensByPlayer(\"player\");\n    const aiTokens = getTokensByPlayer(\"ai\");\n    \n    if (playerTokens.every((t) => t.isFinished)) {\n      return \"player\";\n    }\n    if (aiTokens.every((t) => t.isFinished)) {\n      return \"ai\";\n    }\n    return null;\n  }, [getTokensByPlayer]);\n\n  const canMoveToken = useCallback((token: Token, total: number, hasSix: boolean): boolean => {\n    if (token.isFinished) return false;\n    \n    if (token.isHome) {\n      if (diceCount === 1) {\n        return total === 6;\n      }\n      return hasSix;\n    }\n    \n    const newPosition = token.position + total;\n    const maxPosition = TOTAL_PATH_LENGTH + HOME_STRETCH_LENGTH - 1;\n    \n    return newPosition <= maxPosition;\n  }, [diceCount]);\n\n  const getMovableTokens = useCallback((player: Player, total: number, hasSix: boolean): number[] => {\n    return tokens\n      .filter((t) => t.player === player && canMoveToken(t, total, hasSix))\n      .map((t) => t.id);\n  }, [tokens, canMoveToken]);\n\n  const getTokenPosition = useCallback((token: Token): { x: number; y: number } => {\n    if (token.isFinished) {\n      return { x: 7, y: 7 };\n    }\n    \n    if (token.isHome) {\n      const homePositions = token.player === \"player\" ? getPlayerHomePositions() : getAIHomePositions();\n      const homeIndex = token.id % 4;\n      return homePositions[homeIndex];\n    }\n    \n    const path = token.player === \"player\" ? PLAYER_PATH : AI_PATH;\n    if (token.position >= 0 && token.position < path.length) {\n      return path[token.position];\n    }\n    \n    return { x: 7, y: 7 };\n  }, []);\n\n  const isSafeZone = (position: number): boolean => {\n    return SAFE_ZONES.includes(position % TOTAL_PATH_LENGTH);\n  };\n\n  const endTurn = useCallback((gotSix: boolean, currentTurnPlayer: Player) => {\n    const newWinner = checkWinner();\n    if (newWinner) {\n      setWinner(newWinner);\n      setGameOver(true);\n      onGameEnd(newWinner === \"player\", newWinner === \"player\" ? 100 : 0);\n      isProcessingRef.current = false;\n      aiTurnRef.current = false;\n      setIsAiThinking(false);\n      return;\n    }\n    \n    setHasRolled(false);\n    setMovableTokens([]);\n    \n    if (!gotSix) {\n      const nextPlayer = currentTurnPlayer === \"player\" ? \"ai\" : \"player\";\n      setCurrentPlayer(nextPlayer);\n      if (nextPlayer === \"player\") {\n        aiTurnRef.current = false;\n        setIsAiThinking(false);\n      }\n    } else {\n      if (currentTurnPlayer === \"ai\") {\n        aiTurnRef.current = false;\n      }\n    }\n    \n    isProcessingRef.current = false;\n  }, [checkWinner, onGameEnd]);\n\n  const moveToken = useCallback((tokenId: number, total: number, hasSix: boolean) => {\n    setTokens((prevTokens) => {\n      const newTokens = [...prevTokens];\n      const tokenIndex = newTokens.findIndex((t) => t.id === tokenId);\n      if (tokenIndex === -1) return prevTokens;\n      \n      const token = { ...newTokens[tokenIndex] };\n      \n      if (token.isHome && (diceCount === 1 ? total === 6 : hasSix)) {\n        token.isHome = false;\n        token.position = 0;\n        setMessage(`${token.player === \"player\" ? \"You\" : \"AI\"} brought a token out!`);\n      } else if (!token.isHome) {\n        token.position += total;\n        \n        const maxPosition = TOTAL_PATH_LENGTH + HOME_STRETCH_LENGTH - 1;\n        if (token.position >= maxPosition) {\n          token.isFinished = true;\n          token.position = maxPosition;\n          setMessage(`${token.player === \"player\" ? \"Your\" : \"AI's\"} token reached home!`);\n        }\n      }\n      \n      if (!token.isHome && !token.isFinished && token.position < TOTAL_PATH_LENGTH) {\n        const tokenPos = getTokenPosition({ ...token });\n        \n        newTokens.forEach((otherToken, idx) => {\n          if (otherToken.player !== token.player && !otherToken.isHome && !otherToken.isFinished) {\n            const otherPos = getTokenPosition(otherToken);\n            \n            if (tokenPos.x === otherPos.x && tokenPos.y === otherPos.y) {\n              if (!isSafeZone(otherToken.position)) {\n                newTokens[idx] = { ...otherToken, isHome: true, position: -1 };\n                setCaptureAnimation(otherPos);\n                setTimeout(() => setCaptureAnimation(null), 500);\n                setMessage(`${token.player === \"player\" ? \"You\" : \"AI\"} captured an opponent token!`);\n              }\n            }\n          }\n        });\n      }\n      \n      newTokens[tokenIndex] = token;\n      return newTokens;\n    });\n  }, [diceCount, getTokenPosition]);\n\n  const handleTokenClick = useCallback((tokenId: number) => {\n    if (!hasRolled || !movableTokens.includes(tokenId) || currentPlayer !== \"player\" || isProcessingRef.current) return;\n    \n    isProcessingRef.current = true;\n    moveToken(tokenId, diceResult.total, diceResult.hasSix);\n    \n    timeoutRef.current = setTimeout(() => {\n      endTurn(diceResult.hasSix, \"player\");\n    }, 300);\n  }, [hasRolled, movableTokens, currentPlayer, diceResult, moveToken, endTurn]);\n\n  const rollDice = useCallback((forPlayer: Player) => {\n    if (isRolling || hasRolled || gameOver || isProcessingRef.current) return;\n    if (forPlayer !== currentPlayer) return;\n    \n    isProcessingRef.current = true;\n    setIsRolling(true);\n    \n    let rollCount = 0;\n    const rollInterval = setInterval(() => {\n      const tempResult = rollDiceSet(diceCount);\n      setDiceResult(tempResult);\n      rollCount++;\n      \n      if (rollCount >= 10) {\n        clearInterval(rollInterval);\n        const finalResult = rollDiceSet(diceCount);\n        setDiceResult(finalResult);\n        setIsRolling(false);\n        setHasRolled(true);\n        \n        if (finalResult.hasSix) {\n          setConsecutiveSixes((prev) => {\n            if (prev >= 2) {\n              setMessage(\"Three sixes in a row! Turn forfeited.\");\n              timeoutRef.current = setTimeout(() => {\n                setHasRolled(false);\n                setMovableTokens([]);\n                const nextPlayer = forPlayer === \"player\" ? \"ai\" : \"player\";\n                setCurrentPlayer(nextPlayer);\n                if (nextPlayer === \"player\") {\n                  aiTurnRef.current = false;\n                  setIsAiThinking(false);\n                }\n                isProcessingRef.current = false;\n              }, 1000);\n              return 0;\n            }\n            return prev + 1;\n          });\n        } else {\n          setConsecutiveSixes(0);\n        }\n        \n        const movable = getMovableTokens(forPlayer, finalResult.total, finalResult.hasSix);\n        setMovableTokens(movable);\n        \n        if (movable.length === 0) {\n          setMessage(`No valid moves. ${forPlayer === \"player\" ? \"AI's\" : \"Your\"} turn.`);\n          timeoutRef.current = setTimeout(() => {\n            endTurn(false, forPlayer);\n          }, 1000);\n        } else if (forPlayer === \"player\") {\n          if (movable.length === 1) {\n            setMessage(\"Moving your only available token...\");\n            timeoutRef.current = setTimeout(() => {\n              moveToken(movable[0], finalResult.total, finalResult.hasSix);\n              timeoutRef.current = setTimeout(() => {\n                endTurn(finalResult.hasSix, \"player\");\n              }, 300);\n            }, 500);\n          } else {\n            setMessage(\"Click a token to move\");\n            isProcessingRef.current = false;\n          }\n        } else {\n          setMessage(\"AI is thinking...\");\n          isProcessingRef.current = false;\n        }\n      }\n    }, 100);\n  }, [isRolling, hasRolled, gameOver, currentPlayer, diceCount, getMovableTokens, moveToken, endTurn]);\n\n  useEffect(() => {\n    if (gamePhase !== \"playing\" || gameOver) return;\n    if (currentPlayer !== \"ai\") return;\n    if (!hasRolled || movableTokens.length === 0) return;\n    if (isProcessingRef.current || aiTurnRef.current) return;\n    \n    aiTurnRef.current = true;\n    isProcessingRef.current = true;\n    \n    const savedDiceResult = { ...diceResult };\n    const savedMovableTokens = [...movableTokens];\n    \n    timeoutRef.current = setTimeout(() => {\n      const aiTokensOnBoard = savedMovableTokens.filter((id) => {\n        const token = tokens.find((t) => t.id === id);\n        return token && !token.isHome;\n      });\n      \n      const aiTokensAtHome = savedMovableTokens.filter((id) => {\n        const token = tokens.find((t) => t.id === id);\n        return token && token.isHome;\n      });\n      \n      let selectedToken: number;\n      \n      if (aiTokensOnBoard.length > 0) {\n        const playerTokens = tokens.filter((t) => t.player === \"player\" && !t.isHome && !t.isFinished);\n        \n        let captureToken: number | null = null;\n        for (const tokenId of aiTokensOnBoard) {\n          const token = tokens.find((t) => t.id === tokenId);\n          if (token) {\n            const newPos = token.position + savedDiceResult.total;\n            const path = AI_PATH;\n            if (newPos < path.length) {\n              const targetPos = path[newPos];\n              for (const pToken of playerTokens) {\n                const pPos = getTokenPosition(pToken);\n                if (pPos.x === targetPos.x && pPos.y === targetPos.y && !isSafeZone(pToken.position)) {\n                  captureToken = tokenId;\n                  break;\n                }\n              }\n            }\n          }\n        }\n        \n        if (captureToken !== null) {\n          selectedToken = captureToken;\n        } else {\n          const closestToFinish = aiTokensOnBoard.reduce((closest, id) => {\n            const token = tokens.find((t) => t.id === id);\n            const closestToken = tokens.find((t) => t.id === closest);\n            if (!token || !closestToken) return closest;\n            return token.position > closestToken.position ? id : closest;\n          }, aiTokensOnBoard[0]);\n          selectedToken = closestToFinish;\n        }\n      } else if (aiTokensAtHome.length > 0) {\n        selectedToken = aiTokensAtHome[0];\n      } else {\n        selectedToken = savedMovableTokens[0];\n      }\n      \n      moveToken(selectedToken, savedDiceResult.total, savedDiceResult.hasSix);\n      \n      timeoutRef.current = setTimeout(() => {\n        endTurn(savedDiceResult.hasSix, \"ai\");\n      }, 500);\n    }, 1000);\n  }, [gamePhase, currentPlayer, hasRolled, movableTokens, gameOver, tokens, diceResult, moveToken, endTurn, getTokenPosition]);\n\n  useEffect(() => {\n    if (gamePhase !== \"playing\" || gameOver) return;\n    if (currentPlayer !== \"ai\") return;\n    if (hasRolled) return;\n    if (isProcessingRef.current || aiTurnRef.current) return;\n    \n    aiTurnRef.current = true;\n    setIsAiThinking(true);\n    \n    timeoutRef.current = setTimeout(() => {\n      rollDice(\"ai\");\n    }, 1000);\n  }, [gamePhase, currentPlayer, hasRolled, gameOver, rollDice]);\n\n  const playerFinished = tokens.filter((t) => t.player === \"player\" && t.isFinished).length;\n  const aiFinished = tokens.filter((t) => t.player === \"ai\" && t.isFinished).length;\n\n  const resetGame = () => {\n    if (timeoutRef.current) {\n      clearTimeout(timeoutRef.current);\n    }\n    isProcessingRef.current = false;\n    aiTurnRef.current = false;\n    \n    setTokens([\n      { id: 0, player: \"player\", position: -1, isHome: true, isFinished: false },\n      { id: 1, player: \"player\", position: -1, isHome: true, isFinished: false },\n      { id: 2, player: \"player\", position: -1, isHome: true, isFinished: false },\n      { id: 3, player: \"player\", position: -1, isHome: true, isFinished: false },\n      { id: 4, player: \"ai\", position: -1, isHome: true, isFinished: false },\n      { id: 5, player: \"ai\", position: -1, isHome: true, isFinished: false },\n      { id: 6, player: \"ai\", position: -1, isHome: true, isFinished: false },\n      { id: 7, player: \"ai\", position: -1, isHome: true, isFinished: false },\n    ]);\n    setCurrentPlayer(\"player\");\n    setDiceResult({ values: Array(diceCount).fill(1), total: diceCount, hasSix: false });\n    setHasRolled(false);\n    setGameOver(false);\n    setWinner(null);\n    setConsecutiveSixes(0);\n    setMovableTokens([]);\n    setIsAiThinking(false);\n    setMessage(\"Roll the dice to start!\");\n  };\n\n  const startGame = () => {\n    setDiceResult({ values: Array(diceCount).fill(1), total: diceCount, hasSix: false });\n    setGamePhase(\"playing\");\n  };\n\n  const renderBoard = () => {\n    const cells: JSX.Element[] = [];\n    \n    for (let y = 0; y < BOARD_SIZE; y++) {\n      for (let x = 0; x < BOARD_SIZE; x++) {\n        let bgColor = \"bg-amber-50 dark:bg-amber-950/30\";\n        let extraStyles = \"\";\n        \n        if ((x >= 0 && x <= 5 && y >= 9 && y <= 14)) {\n          bgColor = \"bg-gradient-to-br from-red-400 to-red-600 dark:from-red-700 dark:to-red-900\";\n          if (x >= 1 && x <= 4 && y >= 10 && y <= 13) {\n            bgColor = \"bg-gradient-to-br from-red-300 to-red-500 dark:from-red-600 dark:to-red-800\";\n          }\n        } else if ((x >= 9 && x <= 14 && y >= 0 && y <= 5)) {\n          bgColor = \"bg-gradient-to-br from-blue-400 to-blue-600 dark:from-blue-700 dark:to-blue-900\";\n          if (x >= 10 && x <= 13 && y >= 1 && y <= 4) {\n            bgColor = \"bg-gradient-to-br from-blue-300 to-blue-500 dark:from-blue-600 dark:to-blue-800\";\n          }\n        } else if ((x >= 0 && x <= 5 && y >= 0 && y <= 5)) {\n          bgColor = \"bg-gradient-to-br from-green-400 to-green-600 dark:from-green-700 dark:to-green-900\";\n          if (x >= 1 && x <= 4 && y >= 1 && y <= 4) {\n            bgColor = \"bg-gradient-to-br from-green-300 to-green-500 dark:from-green-600 dark:to-green-800\";\n          }\n        } else if ((x >= 9 && x <= 14 && y >= 9 && y <= 14)) {\n          bgColor = \"bg-gradient-to-br from-yellow-400 to-yellow-600 dark:from-yellow-700 dark:to-yellow-900\";\n          if (x >= 10 && x <= 13 && y >= 10 && y <= 13) {\n            bgColor = \"bg-gradient-to-br from-yellow-300 to-yellow-500 dark:from-yellow-600 dark:to-yellow-800\";\n          }\n        }\n        \n        if (x === 7 && y >= 1 && y <= 6) {\n          bgColor = \"bg-gradient-to-b from-blue-300 to-blue-500 dark:from-blue-600 dark:to-blue-800\";\n          extraStyles = \"shadow-inner\";\n        } else if (x === 7 && y >= 8 && y <= 13) {\n          bgColor = \"bg-gradient-to-b from-red-300 to-red-500 dark:from-red-600 dark:to-red-800\";\n          extraStyles = \"shadow-inner\";\n        } else if (y === 7 && x >= 1 && x <= 6) {\n          bgColor = \"bg-gradient-to-r from-green-300 to-green-500 dark:from-green-600 dark:to-green-800\";\n          extraStyles = \"shadow-inner\";\n        } else if (y === 7 && x >= 8 && x <= 13) {\n          bgColor = \"bg-gradient-to-r from-yellow-300 to-yellow-500 dark:from-yellow-600 dark:to-yellow-800\";\n          extraStyles = \"shadow-inner\";\n        }\n        \n        if (x >= 6 && x <= 8 && y >= 6 && y <= 8) {\n          bgColor = \"bg-gradient-to-br from-amber-200 via-amber-300 to-amber-400 dark:from-amber-600 dark:via-amber-700 dark:to-amber-800\";\n          extraStyles = \"shadow-lg\";\n        }\n        \n        const isOnPath = PLAYER_PATH.some((p) => p.x === x && p.y === y) || \n                        AI_PATH.some((p) => p.x === x && p.y === y);\n        \n        if (isOnPath && !((x >= 6 && x <= 8 && y >= 6 && y <= 8))) {\n          const isSafe = PLAYER_PATH.findIndex((p) => p.x === x && p.y === y);\n          if (isSafe !== -1 && SAFE_ZONES.includes(isSafe)) {\n            extraStyles += \" ring-2 ring-inset ring-white/50 dark:ring-white/30\";\n          }\n        }\n        \n        cells.push(\n          <div\n            key={`${x}-${y}`}\n            className={`aspect-square border border-black/10 dark:border-white/10 ${bgColor} ${extraStyles} relative transition-colors`}\n          />\n        );\n      }\n    }\n    \n    return cells;\n  };\n\n  const renderTokens = () => {\n    return tokens.map((token) => {\n      if (token.isFinished) return null;\n      \n      const pos = getTokenPosition(token);\n      const isMovable = movableTokens.includes(token.id) && currentPlayer === \"player\";\n      const isPlayerToken = token.player === \"player\";\n      \n      return (\n        <motion.div\n          key={token.id}\n          className={`absolute rounded-full cursor-pointer shadow-lg\n            ${isPlayerToken \n              ? \"bg-gradient-to-br from-red-400 via-red-500 to-red-700 border-2 border-red-800 dark:from-red-500 dark:via-red-600 dark:to-red-800\" \n              : \"bg-gradient-to-br from-blue-400 via-blue-500 to-blue-700 border-2 border-blue-800 dark:from-blue-500 dark:via-blue-600 dark:to-blue-800\"}\n            ${isMovable ? \"ring-4 ring-white dark:ring-yellow-400 ring-offset-2 ring-offset-transparent\" : \"\"}\n          `}\n          style={{\n            left: `${(pos.x / BOARD_SIZE) * 100 + 1}%`,\n            top: `${(pos.y / BOARD_SIZE) * 100 + 1}%`,\n            width: \"5%\",\n            height: \"5%\",\n          }}\n          initial={{ scale: 0.8 }}\n          animate={{ \n            scale: isMovable ? [1, 1.15, 1] : 1,\n            boxShadow: isMovable \n              ? [\"0 0 0 0 rgba(255,255,255,0.7)\", \"0 0 20px 10px rgba(255,255,255,0)\", \"0 0 0 0 rgba(255,255,255,0.7)\"]\n              : \"0 4px 6px rgba(0,0,0,0.3)\"\n          }}\n          transition={{\n            duration: isMovable ? 1 : 0.3,\n            repeat: isMovable ? Infinity : 0,\n            ease: \"easeInOut\"\n          }}\n          whileHover={isMovable ? { scale: 1.3 } : {}}\n          whileTap={isMovable ? { scale: 0.95 } : {}}\n          onClick={() => isMovable && handleTokenClick(token.id)}\n          data-testid={`token-${token.player}-${token.id}`}\n        >\n          <div className=\"absolute inset-1 rounded-full bg-gradient-to-br from-white/40 to-transparent\" />\n          <div className=\"absolute inset-0 flex items-center justify-center\">\n            <div className=\"w-1/3 h-1/3 rounded-full bg-white/30\" />\n          </div>\n        </motion.div>\n      );\n    });\n  };\n\n  if (gamePhase === \"settings\") {\n    return (\n      <div className=\"w-full max-w-lg mx-auto space-y-4\">\n        <Card className=\"border-0 shadow-none bg-transparent\">\n          <CardHeader className=\"pb-2\">\n            <div className=\"flex items-center justify-between gap-2\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                Ludo\n                {!isPractice && (\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    Stake: {stake} NGN\n                  </Badge>\n                )}\n                {isPractice && (\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    Practice\n                  </Badge>\n                )}\n              </CardTitle>\n            </div>\n          </CardHeader>\n        </Card>\n        \n        <GameSettings\n          diceCount={diceCount}\n          onDiceCountChange={setDiceCount}\n          onStartGame={startGame}\n        />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"w-full max-w-lg mx-auto space-y-4\">\n      <Card className=\"overflow-hidden border-2\">\n        <CardHeader className=\"pb-2 bg-gradient-to-r from-amber-100 to-orange-100 dark:from-amber-900/50 dark:to-orange-900/50\">\n          <div className=\"flex items-center justify-between gap-2\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              Ludo\n              {!isPractice && (\n                <Badge variant=\"secondary\" className=\"text-xs\">\n                  Stake: {stake} NGN\n                </Badge>\n              )}\n              {isPractice && (\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  Practice\n                </Badge>\n              )}\n              <Badge variant=\"outline\" className=\"text-xs\">\n                {diceCount} {diceCount === 1 ? \"Die\" : \"Dice\"}\n              </Badge>\n            </CardTitle>\n            <div className=\"flex items-center gap-2\">\n              <Badge className=\"bg-gradient-to-r from-red-500 to-red-600 text-white border-0 shadow-md\">\n                <User className=\"h-3 w-3 mr-1\" /> {playerFinished}/4\n              </Badge>\n              <Badge className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white border-0 shadow-md\">\n                <Bot className=\"h-3 w-3 mr-1\" /> {aiFinished}/4\n              </Badge>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4 p-4\">\n          <div className=\"relative aspect-square w-full rounded-lg overflow-hidden shadow-xl border-4 border-amber-700 dark:border-amber-600 bg-gradient-to-br from-amber-100 to-amber-200 dark:from-amber-900 dark:to-amber-950\">\n            <div \n              className=\"grid gap-0 w-full h-full\" \n              style={{ gridTemplateColumns: `repeat(${BOARD_SIZE}, 1fr)` }}\n            >\n              {renderBoard()}\n            </div>\n            {renderTokens()}\n            \n            <AnimatePresence>\n              {captureAnimation && (\n                <motion.div\n                  initial={{ scale: 1, opacity: 1 }}\n                  animate={{ scale: 3, opacity: 0 }}\n                  exit={{ opacity: 0 }}\n                  className=\"absolute w-8 h-8 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500\"\n                  style={{\n                    left: `${(captureAnimation.x / BOARD_SIZE) * 100}%`,\n                    top: `${(captureAnimation.y / BOARD_SIZE) * 100}%`,\n                  }}\n                />\n              )}\n            </AnimatePresence>\n          </div>\n\n          <div className=\"flex items-center justify-between gap-4 p-4 rounded-lg bg-gradient-to-r from-muted/50 to-muted\">\n            <div className=\"flex-1\">\n              <p className={`text-sm font-medium mb-1 ${currentPlayer === \"player\" ? \"text-red-600 dark:text-red-400\" : \"text-blue-600 dark:text-blue-400\"}`}>\n                {currentPlayer === \"player\" ? \"Your Turn\" : \"AI's Turn\"}\n              </p>\n              <p className=\"text-xs text-muted-foreground\">{message}</p>\n            </div>\n            \n            <div className={`p-3 rounded-lg shadow-inner ${currentPlayer === \"player\" ? \"bg-gradient-to-br from-red-100 to-red-200 dark:from-red-900/50 dark:to-red-800/50\" : \"bg-gradient-to-br from-blue-100 to-blue-200 dark:from-blue-900/50 dark:to-blue-800/50\"}`}>\n              <DiceDisplay values={diceResult.values} isRolling={isRolling} />\n            </div>\n            \n            <Button\n              onClick={() => rollDice(\"player\")}\n              disabled={isRolling || hasRolled || currentPlayer !== \"player\" || gameOver}\n              className=\"shadow-lg\"\n              size=\"lg\"\n              data-testid=\"button-roll-dice\"\n            >\n              Roll\n            </Button>\n          </div>\n\n          {gameOver && (\n            <motion.div\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              className={`text-center space-y-4 p-6 rounded-lg ${winner === \"player\" ? \"bg-gradient-to-br from-green-100 to-emerald-200 dark:from-green-900/50 dark:to-emerald-800/50\" : \"bg-gradient-to-br from-red-100 to-rose-200 dark:from-red-900/50 dark:to-rose-800/50\"}`}\n            >\n              <div className=\"flex items-center justify-center gap-2\">\n                <Trophy className={`h-10 w-10 ${winner === \"player\" ? \"text-yellow-500\" : \"text-muted-foreground\"}`} />\n                <p className=\"text-2xl font-bold\">\n                  {winner === \"player\" ? \"You Won!\" : \"AI Won!\"}\n                </p>\n              </div>\n              {!isPractice && (\n                <p className=\"text-sm text-muted-foreground\">\n                  {winner === \"player\" \n                    ? `You earned ${(stake * 2 * 0.95).toLocaleString()} NGN!` \n                    : `You lost ${stake.toLocaleString()} NGN.`}\n                </p>\n              )}\n              <Button onClick={resetGame} variant=\"outline\" size=\"lg\" className=\"shadow-md\" data-testid=\"button-play-again\">\n                <RotateCcw className=\"h-4 w-4 mr-2\" />\n                Play Again\n              </Button>\n            </motion.div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":34727,"size_tokens":null},"client/src/lib/authUtils.ts":{"content":"export function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n","path":null,"size_bytes":116,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"client/src/hooks/use-cart.ts":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { CartItem, Product } from \"@shared/schema\";\n\nexport type CartItemWithProduct = CartItem & { product: Product };\n\nexport function useCart() {\n  const cartQuery = useQuery<CartItemWithProduct[]>({\n    queryKey: [\"/api/cart\"],\n    staleTime: 1000 * 60,\n    retry: false,\n  });\n\n  const addToCartMutation = useMutation({\n    mutationFn: async ({ productId, quantity = 1 }: { productId: string; quantity?: number }) => {\n      const res = await apiRequest(\"POST\", \"/api/cart\", { productId, quantity });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cart\"] });\n    },\n  });\n\n  const updateQuantityMutation = useMutation({\n    mutationFn: async ({ cartItemId, quantity }: { cartItemId: string; quantity: number }) => {\n      const res = await apiRequest(\"PATCH\", `/api/cart/${cartItemId}`, { quantity });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cart\"] });\n    },\n  });\n\n  const removeFromCartMutation = useMutation({\n    mutationFn: async (cartItemId: string) => {\n      await apiRequest(\"DELETE\", `/api/cart/${cartItemId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cart\"] });\n    },\n  });\n\n  const clearCartMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"DELETE\", \"/api/cart\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cart\"] });\n    },\n  });\n\n  const cartItems = cartQuery.data || [];\n  const itemCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);\n  const subtotal = cartItems.reduce((sum, item) => {\n    const price = typeof item.product.price === 'number' \n      ? item.product.price \n      : parseFloat(item.product.price as string) || 0;\n    return sum + price * item.quantity;\n  }, 0);\n\n  return {\n    cartItems,\n    itemCount,\n    subtotal,\n    isLoading: cartQuery.isLoading,\n    isError: cartQuery.isError,\n    addToCart: addToCartMutation.mutateAsync,\n    isAddingToCart: addToCartMutation.isPending,\n    updateQuantity: updateQuantityMutation.mutateAsync,\n    isUpdatingQuantity: updateQuantityMutation.isPending,\n    removeFromCart: removeFromCartMutation.mutateAsync,\n    isRemovingFromCart: removeFromCartMutation.isPending,\n    clearCart: clearCartMutation.mutateAsync,\n    isClearingCart: clearCartMutation.isPending,\n  };\n}\n","path":null,"size_bytes":2540,"size_tokens":null},"client/src/components/Header.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { ShoppingBag, MessageSquare, User, Search, Wallet, Users, Megaphone, Settings, LogOut, Bell, Smartphone, Sun, Moon, HelpCircle, Shield, FileText, Heart, Bookmark, UsersRound, MessageCircle, Share2, Briefcase, UserCog } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport NotificationBell from \"@/components/NotificationBell\";\nimport { CartDrawer } from \"@/components/CartDrawer\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n  DropdownMenuSub,\n  DropdownMenuSubTrigger,\n  DropdownMenuSubContent,\n  DropdownMenuPortal,\n} from \"@/components/ui/dropdown-menu\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useState } from \"react\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useTheme } from \"@/contexts/ThemeContext\";\n\nexport function Header() {\n  const { user, isAuthenticated, isSeller, isAdmin } = useAuth();\n  const [location, setLocation] = useLocation();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const { theme, toggleTheme } = useTheme();\n\n  const handleSearch = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (searchQuery.trim()) {\n      setLocation(`/?search=${encodeURIComponent(searchQuery)}`);\n    }\n  };\n\n  const initials = user?.firstName && user?.lastName\n    ? `${user.firstName[0]}${user.lastName[0]}`\n    : user?.email?.[0]?.toUpperCase() || \"U\";\n\n  return (\n    <header className=\"sticky top-0 z-50 border-b bg-background\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"flex h-16 items-center justify-between gap-4\">\n          {/* Logo */}\n          <Link href=\"/\" className=\"flex items-center gap-2\">\n            <ShoppingBag className=\"h-6 w-6 text-primary\" />\n            <span className=\"hidden text-lg font-bold sm:inline-block\">\n              EKSU Marketplace\n            </span>\n            <span className=\"text-lg font-bold sm:hidden\">EKSU</span>\n          </Link>\n\n          {/* Search Bar - Desktop */}\n          <form onSubmit={handleSearch} className=\"hidden flex-1 max-w-md md:block\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n              <Input\n                type=\"search\"\n                placeholder=\"Search products...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"input-search\"\n              />\n            </div>\n          </form>\n\n          {/* Right Side Actions */}\n          <div className=\"flex items-center gap-2\">\n            {isAuthenticated ? (\n              <>\n                {/* Cart */}\n                <CartDrawer />\n\n                {/* Notifications */}\n                <NotificationBell />\n\n                {/* Profile Dropdown Menu */}\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button\n                      variant=\"ghost\"\n                      className=\"relative h-9 w-9 rounded-full\"\n                      data-testid=\"button-profile-menu\"\n                    >\n                      <Avatar className=\"h-9 w-9\">\n                        <AvatarImage src={user?.profileImageUrl || undefined} />\n                        <AvatarFallback>{initials}</AvatarFallback>\n                      </Avatar>\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"end\" className=\"w-56\">\n                    <DropdownMenuLabel>\n                      <div className=\"flex items-center gap-3\">\n                        <Avatar className=\"h-10 w-10\">\n                          <AvatarImage src={user?.profileImageUrl || undefined} />\n                          <AvatarFallback>{initials}</AvatarFallback>\n                        </Avatar>\n                        <div className=\"flex flex-col gap-1\">\n                          <p className=\"text-sm font-medium\">\n                            {user?.firstName} {user?.lastName}\n                          </p>\n                          <div className=\"flex items-center gap-2\">\n                            <Badge variant=\"secondary\" className=\"text-xs\">\n                              {user?.role}\n                            </Badge>\n                            {user?.isVerified && (\n                              <Badge variant=\"default\" className=\"text-xs\">\n                                Verified\n                              </Badge>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                    </DropdownMenuLabel>\n                    <DropdownMenuSeparator />\n                    \n                    {/* Main Actions - Always visible */}\n                    <DropdownMenuItem asChild>\n                      <Link href=\"/profile\" data-testid=\"link-my-profile\">\n                        <User className=\"mr-2 h-4 w-4\" />\n                        My Profile\n                      </Link>\n                    </DropdownMenuItem>\n                    <DropdownMenuItem asChild>\n                      <Link href=\"/wallet\" data-testid=\"link-wallet\">\n                        <Wallet className=\"mr-2 h-4 w-4\" />\n                        Wallet\n                      </Link>\n                    </DropdownMenuItem>\n                    <DropdownMenuItem asChild>\n                      <Link href=\"/my-ads\" data-testid=\"link-my-ads\">\n                        <Megaphone className=\"mr-2 h-4 w-4\" />\n                        My Ads\n                      </Link>\n                    </DropdownMenuItem>\n                    \n                    <DropdownMenuSeparator />\n                    \n                    {/* Social - Collapsible submenu */}\n                    <DropdownMenuSub>\n                      <DropdownMenuSubTrigger data-testid=\"submenu-social\">\n                        <Share2 className=\"mr-2 h-4 w-4\" />\n                        Social\n                      </DropdownMenuSubTrigger>\n                      <DropdownMenuPortal>\n                        <DropdownMenuSubContent>\n                          <DropdownMenuItem asChild>\n                            <Link href=\"/the-plug?tab=bookmarks\" data-testid=\"link-bookmarks\">\n                              <Bookmark className=\"mr-2 h-4 w-4\" />\n                              Saved Posts\n                            </Link>\n                          </DropdownMenuItem>\n                          <DropdownMenuItem asChild>\n                            <Link href=\"/communities\" data-testid=\"link-communities\">\n                              <UsersRound className=\"mr-2 h-4 w-4\" />\n                              Communities\n                            </Link>\n                          </DropdownMenuItem>\n                          <DropdownMenuItem asChild>\n                            <Link href=\"/confessions\" data-testid=\"link-confessions\">\n                              <MessageCircle className=\"mr-2 h-4 w-4\" />\n                              Confessions\n                            </Link>\n                          </DropdownMenuItem>\n                        </DropdownMenuSubContent>\n                      </DropdownMenuPortal>\n                    </DropdownMenuSub>\n                    \n                    {/* Services - Collapsible submenu */}\n                    <DropdownMenuSub>\n                      <DropdownMenuSubTrigger data-testid=\"submenu-services\">\n                        <Briefcase className=\"mr-2 h-4 w-4\" />\n                        Services\n                      </DropdownMenuSubTrigger>\n                      <DropdownMenuPortal>\n                        <DropdownMenuSubContent>\n                          <DropdownMenuItem asChild>\n                            <Link href=\"/vtu\" data-testid=\"link-vtu-data\">\n                              <Smartphone className=\"mr-2 h-4 w-4\" />\n                              VTU Data\n                            </Link>\n                          </DropdownMenuItem>\n                          <DropdownMenuItem asChild>\n                            <Link href=\"/referrals\" data-testid=\"link-referrals\">\n                              <Users className=\"mr-2 h-4 w-4\" />\n                              Referrals\n                            </Link>\n                          </DropdownMenuItem>\n                        </DropdownMenuSubContent>\n                      </DropdownMenuPortal>\n                    </DropdownMenuSub>\n                    \n                    {/* Account - Collapsible submenu */}\n                    <DropdownMenuSub>\n                      <DropdownMenuSubTrigger data-testid=\"submenu-account\">\n                        <UserCog className=\"mr-2 h-4 w-4\" />\n                        Account\n                      </DropdownMenuSubTrigger>\n                      <DropdownMenuPortal>\n                        <DropdownMenuSubContent>\n                          <DropdownMenuItem asChild>\n                            <Link href=\"/settings\" data-testid=\"link-settings\">\n                              <Settings className=\"mr-2 h-4 w-4\" />\n                              Settings\n                            </Link>\n                          </DropdownMenuItem>\n                          <DropdownMenuItem asChild>\n                            <Link href=\"/notifications\" data-testid=\"link-notifications\">\n                              <Bell className=\"mr-2 h-4 w-4\" />\n                              Notifications\n                            </Link>\n                          </DropdownMenuItem>\n                          <DropdownMenuItem asChild>\n                            <Link href=\"/wishlist\" data-testid=\"link-wishlist\">\n                              <Heart className=\"mr-2 h-4 w-4\" />\n                              Wishlist\n                            </Link>\n                          </DropdownMenuItem>\n                          <DropdownMenuItem asChild>\n                            <Link href=\"/kyc\" data-testid=\"link-kyc-verify\">\n                              <Shield className=\"mr-2 h-4 w-4\" />\n                              Verify Identity\n                            </Link>\n                          </DropdownMenuItem>\n                        </DropdownMenuSubContent>\n                      </DropdownMenuPortal>\n                    </DropdownMenuSub>\n                    \n                    <DropdownMenuSeparator />\n                    \n                    {/* Other - Always visible */}\n                    <DropdownMenuItem asChild>\n                      <Link href=\"/support\" data-testid=\"link-support\">\n                        <HelpCircle className=\"mr-2 h-4 w-4\" />\n                        Help & Support\n                      </Link>\n                    </DropdownMenuItem>\n                    <DropdownMenuItem asChild>\n                      <Link href=\"/legal\" data-testid=\"link-legal\">\n                        <FileText className=\"mr-2 h-4 w-4\" />\n                        Legal & Privacy\n                      </Link>\n                    </DropdownMenuItem>\n                    \n                    {/* Admin Panel - Visible for admins only */}\n                    {isAdmin && (\n                      <>\n                        <DropdownMenuSeparator />\n                        <DropdownMenuItem asChild>\n                          <Link href=\"/admin\" data-testid=\"link-admin-panel\">\n                            <Settings className=\"mr-2 h-4 w-4\" />\n                            Admin Panel\n                          </Link>\n                        </DropdownMenuItem>\n                      </>\n                    )}\n                    \n                    <DropdownMenuSeparator />\n                    \n                    {/* Theme Toggle */}\n                    <DropdownMenuItem\n                      onClick={toggleTheme}\n                      className=\"cursor-pointer\"\n                      data-testid=\"button-theme-toggle\"\n                    >\n                      {theme === \"dark\" ? (\n                        <>\n                          <Sun className=\"mr-2 h-4 w-4\" />\n                          Light Mode\n                        </>\n                      ) : (\n                        <>\n                          <Moon className=\"mr-2 h-4 w-4\" />\n                          Dark Mode\n                        </>\n                      )}\n                    </DropdownMenuItem>\n                    \n                    {/* Logout */}\n                    <DropdownMenuItem \n                      onClick={async () => {\n                        try {\n                          await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });\n                          queryClient.clear();\n                          window.location.href = '/';\n                        } catch (error) {\n                          console.error('Logout failed:', error);\n                        }\n                      }}\n                      className=\"cursor-pointer text-destructive\"\n                      data-testid=\"button-logout\"\n                    >\n                      <LogOut className=\"mr-2 h-4 w-4\" />\n                      Logout\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n              </>\n            ) : (\n              <>\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      data-testid=\"button-theme-toggle-guest\"\n                    >\n                      {theme === \"dark\" ? (\n                        <Sun className=\"h-5 w-5\" />\n                      ) : (\n                        <Moon className=\"h-5 w-5\" />\n                      )}\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"end\">\n                    <DropdownMenuItem onClick={toggleTheme}>\n                      {theme === \"dark\" ? \"Light Mode\" : \"Dark Mode\"}\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n                <Button variant=\"ghost\" asChild data-testid=\"button-login\">\n                  <a href=\"/api/login\">Log In</a>\n                </Button>\n                <Button asChild data-testid=\"button-signup\">\n                  <a href=\"/api/login\">Sign Up</a>\n                </Button>\n              </>\n            )}\n          </div>\n        </div>\n      </div>\n    </header>\n  );\n}\n","path":null,"size_bytes":14810,"size_tokens":null},"shared/pricing.ts":{"content":"/**\n * Shared Pricing Calculator for EKSU Marketplace\n * \n * This module can be used on both frontend and backend for consistent\n * pricing calculations. It handles:\n * - Squad transaction fees (official pricing)\n * - Platform commission\n * - Buyer/Seller price breakdowns\n */\n\n// Default values (can be overridden)\nexport const DEFAULT_COMMISSION_RATE = 0.10; // 10%\n\n// Squad Official Pricing (2024)\nexport const SQUAD_FEE_CONFIG = {\n  CARD: {\n    percentage: 0.012,  // 1.2%\n    cap: 1500,\n  },\n  TRANSFER: {\n    percentage: 0.0025, // 0.25%\n    cap: 1000,\n  },\n  USSD: {\n    percentage: 0.012,  // 1.2%\n    cap: 1500,\n  },\n  BANK: {\n    percentage: 0.0025, // 0.25%\n    cap: 1000,\n  },\n};\n\nexport type PaymentMethod = 'CARD' | 'TRANSFER' | 'USSD' | 'BANK';\n\nexport interface SquadFeeResult {\n  feePercentage: number;\n  totalFee: number;\n  cappedFee: number;\n}\n\nexport interface PricingBreakdown {\n  sellerPrice: number;\n  platformCommission: number;\n  paymentFee: number;\n  buyerPays: number;\n  sellerReceives: number;\n  commissionRate: number;\n}\n\n/**\n * Calculate Squad transaction fee based on amount and payment method\n * Official Squad Pricing: https://squadco.com/pricing\n */\nexport function calculateSquadFee(\n  amount: number,\n  paymentMethod: PaymentMethod = 'CARD'\n): SquadFeeResult {\n  const feeConfig = SQUAD_FEE_CONFIG[paymentMethod];\n  \n  if (!feeConfig) {\n    throw new Error(`Unknown payment method: ${paymentMethod}`);\n  }\n  \n  const feePercentage = feeConfig.percentage;\n  const totalFee = amount * feePercentage;\n  const cappedFee = Math.min(totalFee, feeConfig.cap);\n  \n  return {\n    feePercentage,\n    totalFee,\n    cappedFee,\n  };\n}\n\n/**\n * Calculate full pricing breakdown based on seller's desired price\n * \n * Formula:\n * - Platform Commission (B) = Seller Price * COMMISSION_RATE\n * - Squad Fee (C) = Squad fee based on payment method\n * - Total Buyer Pays = Seller Price + B + C\n * - Seller Receives = Seller Price - B\n */\nexport function calculatePricingFromSellerPrice(\n  sellerDesiredProfit: number,\n  commissionRate: number = DEFAULT_COMMISSION_RATE,\n  paymentMethod: PaymentMethod = 'CARD'\n): PricingBreakdown {\n  // Platform commission on the seller price\n  const platformCommission = Math.round(sellerDesiredProfit * commissionRate * 100) / 100;\n  \n  // Squad fee calculation\n  const squadResult = calculateSquadFee(sellerDesiredProfit, paymentMethod);\n  const paymentFee = Math.round(squadResult.cappedFee * 100) / 100;\n  \n  const buyerPays = Math.round((sellerDesiredProfit + platformCommission + paymentFee) * 100) / 100;\n  const sellerReceives = Math.round((sellerDesiredProfit - platformCommission) * 100) / 100;\n  \n  return {\n    sellerPrice: sellerDesiredProfit,\n    platformCommission,\n    paymentFee,\n    buyerPays,\n    sellerReceives,\n    commissionRate,\n  };\n}\n\n/**\n * Format amount as Nigerian Naira\n */\nexport function formatNaira(amount: number): string {\n  return `₦${amount.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\n}\n\n/**\n * Parse Naira string to number\n */\nexport function parseNaira(nairaString: string): number {\n  const cleaned = nairaString.replace(/[₦,\\s]/g, '');\n  const parsed = parseFloat(cleaned);\n  return isNaN(parsed) ? 0 : parsed;\n}\n\n/**\n * Get payment method info with correct Squad pricing\n * Based on official pricing: https://squadco.com/pricing\n */\nexport function getPaymentMethodInfo(method: PaymentMethod) {\n  const info = {\n    CARD: {\n      title: 'Debit/Credit Card',\n      description: 'Standard settlement (T+1)',\n      fee: '1.2% (max ₦1,500)',\n    },\n    TRANSFER: {\n      title: 'Bank Transfer',\n      description: 'Instant settlement via Virtual Account',\n      fee: '0.25% (max ₦1,000)',\n      recommended: true,\n    },\n    USSD: {\n      title: 'USSD',\n      description: 'Standard settlement (T+1)',\n      fee: '1.2% (max ₦1,500)',\n    },\n    BANK: {\n      title: 'Bank Account',\n      description: 'Instant settlement via Virtual Account',\n      fee: '0.25% (max ₦1,000)',\n    },\n  };\n  \n  return info[method] || info.CARD;\n}\n\n// Re-export for backward compatibility\nexport function getCommissionRate(): number {\n  return DEFAULT_COMMISSION_RATE;\n}\n\nexport function getSecurityDepositAmount(amount: number): number {\n  return Math.round(amount * 0.05); // 5% security deposit\n}\n\nexport function isWithdrawalAllowed(availableBalance: number, withdrawalAmount: number): boolean {\n  return availableBalance >= withdrawalAmount && withdrawalAmount > 0;\n}\n","path":null,"size_bytes":4493,"size_tokens":null},"client/src/pages/profile.tsx":{"content":"import { useEffect, useRef, useState } from \"react\";\nimport { useParams, useLocation } from \"wouter\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { updateUserProfileSchema, type User, type SocialPost, type Product, type Story } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Shield, \n  Star, \n  ShoppingBag, \n  Users, \n  Camera, \n  Loader2, \n  X, \n  Pencil, \n  TrendingUp,\n  UserCheck,\n  Store,\n  ShoppingCart,\n  MapPin,\n  Clock,\n  MoreHorizontal,\n  Settings,\n  ImagePlus,\n  Copy,\n  Check,\n  Hash,\n  AtSign,\n  Eye,\n  EyeOff,\n  UserPlus,\n  UserMinus,\n  MessageCircle,\n  Ban,\n  Flag,\n  AlertTriangle,\n  BadgeCheck,\n  Calendar,\n  Heart,\n  Image,\n  Pin,\n  FileText,\n  Music\n} from \"lucide-react\";\nimport { SiInstagram } from \"react-icons/si\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { format } from \"date-fns\";\nimport { LocationBadge } from \"@/components/LocationBadge\";\nimport { useUserLocationInfo } from \"@/hooks/useGeolocation\";\nimport { StoryViewer } from \"./stories\";\n\ntype UpdateProfileData = z.infer<typeof updateUserProfileSchema>;\n\nfunction formatCount(count: number): string {\n  if (count >= 1000000) {\n    return (count / 1000000).toFixed(1).replace(/\\.0$/, '') + 'M';\n  }\n  if (count >= 1000) {\n    return (count / 1000).toFixed(1).replace(/\\.0$/, '') + 'K';\n  }\n  return count.toString();\n}\n\nfunction formatJoinDate(date: Date | string | null | undefined): string {\n  if (!date) return \"\";\n  const d = new Date(date);\n  return format(d, \"MMMM yyyy\");\n}\n\ntype PostWithAuthor = SocialPost & { author: User };\n\nfunction PinnedPostCard({ post }: { post: PostWithAuthor }) {\n  return (\n    <Card className=\"mb-3 border-l-2 border-l-primary/50\">\n      <CardContent className=\"pt-4 pb-3\">\n        <div className=\"flex items-center gap-2 text-xs text-muted-foreground mb-2\">\n          <Pin className=\"h-3 w-3\" />\n          <span>Pinned</span>\n        </div>\n        <p className=\"text-sm line-clamp-3\">{post.content}</p>\n        {post.images && post.images.length > 0 && (\n          <div className=\"flex gap-2 mt-2\">\n            {post.images.slice(0, 4).map((img, i) => (\n              <img\n                key={i}\n                src={img}\n                alt=\"\"\n                className=\"h-16 w-16 object-cover rounded-md\"\n                loading=\"lazy\"\n              />\n            ))}\n          </div>\n        )}\n        <div className=\"flex items-center gap-4 mt-3 text-xs text-muted-foreground\">\n          <span className=\"flex items-center gap-1\">\n            <Heart className=\"h-3 w-3\" />\n            {formatCount(post.likesCount || 0)}\n          </span>\n          <span className=\"flex items-center gap-1\">\n            <MessageCircle className=\"h-3 w-3\" />\n            {formatCount(post.commentsCount || 0)}\n          </span>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction SocialPostCard({ post }: { post: PostWithAuthor }) {\n  const [, setLocation] = useLocation();\n  \n  return (\n    <Card className=\"mb-3 hover-elevate cursor-pointer\" onClick={() => setLocation(`/the-plug`)}>\n      <CardContent className=\"pt-4 pb-3\">\n        <div className=\"flex items-start gap-3\">\n          <Avatar className=\"h-10 w-10\">\n            <AvatarImage src={post.author?.profileImageUrl || undefined} />\n            <AvatarFallback>\n              {post.author?.firstName?.[0] || 'U'}\n            </AvatarFallback>\n          </Avatar>\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"flex items-center gap-1.5\">\n              <span className=\"font-semibold text-sm\">{post.author?.firstName} {post.author?.lastName}</span>\n              {post.author?.isVerified && (\n                <BadgeCheck className=\"h-4 w-4 text-primary\" />\n              )}\n              <span className=\"text-muted-foreground text-xs\">\n                @{post.author?.username || post.author?.email?.split(\"@\")[0]}\n              </span>\n            </div>\n            <p className=\"text-sm mt-1 line-clamp-4\">{post.content}</p>\n            {post.images && post.images.length > 0 && (\n              <div className=\"grid grid-cols-2 gap-2 mt-2\">\n                {post.images.slice(0, 4).map((img, i) => (\n                  <img\n                    key={i}\n                    src={img}\n                    alt=\"\"\n                    className=\"w-full h-24 object-cover rounded-md\"\n                    loading=\"lazy\"\n                  />\n                ))}\n              </div>\n            )}\n            <div className=\"flex items-center gap-4 mt-3 text-xs text-muted-foreground\">\n              <span className=\"flex items-center gap-1\">\n                <Heart className=\"h-3 w-3\" />\n                {formatCount(post.likesCount || 0)}\n              </span>\n              <span className=\"flex items-center gap-1\">\n                <MessageCircle className=\"h-3 w-3\" />\n                {formatCount(post.commentsCount || 0)}\n              </span>\n              <span className=\"flex items-center gap-1\">\n                <Eye className=\"h-3 w-3\" />\n                {formatCount(post.viewsCount || 0)}\n              </span>\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction ProductCard({ product }: { product: Product }) {\n  const [, setLocation] = useLocation();\n  \n  return (\n    <Card className=\"mb-3 hover-elevate cursor-pointer\" onClick={() => setLocation(`/product/${product.id}`)}>\n      <CardContent className=\"pt-4 pb-3\">\n        <div className=\"flex gap-3\">\n          {product.images && product.images.length > 0 && (\n            <img\n              src={product.images[0]}\n              alt={product.title}\n              className=\"h-20 w-20 object-cover rounded-md flex-shrink-0\"\n              loading=\"lazy\"\n            />\n          )}\n          <div className=\"flex-1 min-w-0\">\n            <h4 className=\"font-medium text-sm line-clamp-2\">{product.title}</h4>\n            <p className=\"text-lg font-bold text-primary mt-1\">\n              ₦{Number(product.price).toLocaleString()}\n            </p>\n            <div className=\"flex items-center gap-2 mt-1\">\n              <Badge variant=\"secondary\" className=\"text-xs\">\n                {product.condition}\n              </Badge>\n              {product.isSold && (\n                <Badge variant=\"destructive\" className=\"text-xs\">Sold</Badge>\n              )}\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default function Profile() {\n  const { userId: urlUserId } = useParams<{ userId?: string }>();\n  const [, setLocation] = useLocation();\n  const { user: currentUser, isLoading: authLoading } = useAuth();\n  const { toast } = useToast();\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const coverInputRef = useRef<HTMLInputElement>(null);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [previewUrl, setPreviewUrl] = useState<string | null>(null);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [copiedId, setCopiedId] = useState(false);\n  const [coverPhoto, setCoverPhoto] = useState<string | null>(null);\n  const [isPreviewMode, setIsPreviewMode] = useState(false);\n  const [showPreviewAfterSave, setShowPreviewAfterSave] = useState(false);\n  const [isBlockDialogOpen, setIsBlockDialogOpen] = useState(false);\n  const [isReportDialogOpen, setIsReportDialogOpen] = useState(false);\n  const [reportReason, setReportReason] = useState(\"\");\n  const [reportDescription, setReportDescription] = useState(\"\");\n  const [activeTab, setActiveTab] = useState(\"posts\");\n  const [usernameInput, setUsernameInput] = useState(\"\");\n  const [isUpdatingUsername, setIsUpdatingUsername] = useState(false);\n  const [selectedUserStories, setSelectedUserStories] = useState<(Story & { author: User; hasViewed?: boolean })[] | null>(null);\n  const [lightboxImage, setLightboxImage] = useState<string | null>(null);\n\n  const isOwnProfile = !urlUserId || (currentUser && urlUserId === currentUser.id);\n\n  const { data: profileUser, isLoading: profileLoading } = useQuery<User>({\n    queryKey: [\"/api/users\", urlUserId],\n    enabled: !!urlUserId && !isOwnProfile,\n  });\n\n  const displayUser = isOwnProfile ? currentUser : profileUser;\n  const displayUserId = isOwnProfile ? currentUser?.id : urlUserId;\n\n  const { data: followStats } = useQuery<{\n    followerCount: number;\n    followingCount: number;\n    isFollowing: boolean;\n  }>({\n    queryKey: [\"/api/users\", displayUserId, \"follow-stats\"],\n    enabled: !!displayUserId,\n  });\n\n  const { data: pinnedPosts, isLoading: pinnedLoading } = useQuery<PostWithAuthor[]>({\n    queryKey: [\"/api/users\", displayUserId, \"pinned-posts\"],\n    enabled: !!displayUserId,\n  });\n\n  const { data: userPosts, isLoading: postsLoading } = useQuery<PostWithAuthor[]>({\n    queryKey: [\"/api/social-posts\", { authorId: displayUserId }],\n    enabled: !!displayUserId,\n  });\n\n  const { data: userProducts, isLoading: productsLoading } = useQuery<Product[]>({\n    queryKey: [\"/api/products\", { sellerId: displayUserId }],\n    enabled: !!displayUserId && (displayUser?.role === \"seller\" || displayUser?.role === \"both\" || displayUser?.role === \"admin\"),\n  });\n\n  const { data: userStories } = useQuery<(Story & { author: User; hasViewed?: boolean })[]>({\n    queryKey: [\"/api/stories/user\", displayUserId],\n    enabled: !!displayUserId,\n  });\n\n  const hasActiveStories = userStories && userStories.length > 0;\n  const hasUnviewedStories = userStories?.some(s => !s.hasViewed) || false;\n\n  const handleAvatarClick = () => {\n    if (hasActiveStories && userStories) {\n      setSelectedUserStories(userStories);\n    }\n  };\n\n  const form = useForm<UpdateProfileData>({\n    resolver: zodResolver(updateUserProfileSchema),\n    defaultValues: {\n      firstName: \"\",\n      lastName: \"\",\n      phoneNumber: \"\",\n      location: \"\",\n      bio: \"\",\n      gender: null,\n      instagramHandle: \"\",\n      tiktokHandle: \"\",\n    },\n  });\n\n  useEffect(() => {\n    if (currentUser && isOwnProfile) {\n      form.reset({\n        firstName: currentUser.firstName || \"\",\n        lastName: currentUser.lastName || \"\",\n        phoneNumber: currentUser.phoneNumber || \"\",\n        location: currentUser.location || \"\",\n        bio: currentUser.bio || \"\",\n        gender: (currentUser as any).gender || null,\n        instagramHandle: (currentUser as any).instagramHandle || \"\",\n        tiktokHandle: (currentUser as any).tiktokHandle || \"\",\n      });\n      setUsernameInput(currentUser.username || \"\");\n    }\n  }, [currentUser, form, isOwnProfile]);\n\n  useEffect(() => {\n    if (displayUser?.coverImageUrl) {\n      setCoverPhoto(displayUser.coverImageUrl);\n    }\n  }, [displayUser?.coverImageUrl]);\n\n  useEffect(() => {\n    if (!authLoading && !currentUser) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [authLoading, currentUser, toast]);\n\n  useEffect(() => {\n    return () => {\n      if (previewUrl) {\n        URL.revokeObjectURL(previewUrl);\n      }\n    };\n  }, [previewUrl]);\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: UpdateProfileData) => {\n      return await apiRequest(\"PUT\", `/api/users/${currentUser?.id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      setIsEditDialogOpen(false);\n      setShowPreviewAfterSave(true);\n      setIsPreviewMode(true);\n      toast({\n        title: \"Profile Updated\",\n        description: \"Your profile has been updated. Preview how it looks to others!\",\n      });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update profile\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateUsernameMutation = useMutation({\n    mutationFn: async (username: string) => {\n      return await apiRequest(\"PATCH\", `/api/users/me/username`, { username });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"Username Updated\",\n        description: \"Your username has been updated successfully.\",\n      });\n      setIsUpdatingUsername(false);\n    },\n    onError: (error: Error) => {\n      const message = error.message.includes(\"taken\") ? \"Username is already taken\" : \"Failed to update username\";\n      toast({\n        title: \"Error\",\n        description: message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const roleMutation = useMutation({\n    mutationFn: async (role: \"buyer\" | \"seller\") => {\n      return await apiRequest(\"PUT\", `/api/users/${currentUser?.id}/role`, { role });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"Success\",\n        description: \"Role updated successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update role\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const uploadImageMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append(\"image\", file);\n\n      const response = await fetch(\"/api/upload\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to upload image\");\n      }\n\n      const { url } = await response.json();\n\n      const updateResponse = await apiRequest(\"PUT\", `/api/users/${currentUser?.id}/profile-image`, {\n        profileImageUrl: url,\n      });\n\n      return updateResponse;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      setSelectedFile(null);\n      setPreviewUrl(null);\n      toast({\n        title: \"Success\",\n        description: \"Profile picture updated successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to upload profile picture\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const uploadCoverMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append(\"image\", file);\n\n      const response = await fetch(\"/api/upload\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to upload image\");\n      }\n\n      const { url } = await response.json();\n\n      const updateResponse = await apiRequest(\"PUT\", `/api/users/${currentUser?.id}/cover-image`, {\n        coverImageUrl: url,\n      });\n\n      return updateResponse;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"Success\",\n        description: \"Cover photo updated successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to upload cover photo\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const followMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", `/api/users/${urlUserId}/follow`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", urlUserId, \"follow-stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", urlUserId, \"followers\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", currentUser?.id, \"following\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n      toast({\n        title: \"Followed\",\n        description: \"You are now following this user\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to follow user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const unfollowMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"DELETE\", `/api/users/${urlUserId}/follow`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", urlUserId, \"follow-stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", urlUserId, \"followers\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", currentUser?.id, \"following\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n      toast({\n        title: \"Unfollowed\",\n        description: \"You have unfollowed this user\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to unfollow user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const blockMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", `/api/users/${urlUserId}/block`, {});\n    },\n    onSuccess: () => {\n      setIsBlockDialogOpen(false);\n      toast({\n        title: \"User Blocked\",\n        description: \"You will no longer see content from this user\",\n      });\n      setLocation(\"/\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to block user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const reportMutation = useMutation({\n    mutationFn: async (data: { reason: string; description: string }) => {\n      return await apiRequest(\"POST\", `/api/users/${urlUserId}/report`, data);\n    },\n    onSuccess: () => {\n      setIsReportDialogOpen(false);\n      setReportReason(\"\");\n      setReportDescription(\"\");\n      toast({\n        title: \"Report Submitted\",\n        description: \"Thank you for helping keep our community safe\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to submit report\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    if (!file.type.startsWith(\"image/\")) {\n      toast({\n        title: \"Invalid file\",\n        description: \"Please select an image file\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (file.size > 5 * 1024 * 1024) {\n      toast({\n        title: \"File too large\",\n        description: \"Image must be less than 5MB\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (previewUrl) {\n      URL.revokeObjectURL(previewUrl);\n    }\n\n    setSelectedFile(file);\n    setPreviewUrl(URL.createObjectURL(file));\n  };\n\n  const handleCoverSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    if (!file.type.startsWith(\"image/\")) {\n      toast({\n        title: \"Invalid file\",\n        description: \"Please select an image file\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (file.size > 10 * 1024 * 1024) {\n      toast({\n        title: \"File too large\",\n        description: \"Cover photo must be less than 10MB\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setCoverPhoto(URL.createObjectURL(file));\n    uploadCoverMutation.mutate(file);\n  };\n\n  const handleCancelUpload = () => {\n    setSelectedFile(null);\n    if (previewUrl) {\n      URL.revokeObjectURL(previewUrl);\n    }\n    setPreviewUrl(null);\n    if (fileInputRef.current) {\n      fileInputRef.current.value = \"\";\n    }\n  };\n\n  const handleUpload = () => {\n    if (selectedFile) {\n      uploadImageMutation.mutate(selectedFile);\n    }\n  };\n\n  const handleRoleChange = (role: \"buyer\" | \"seller\") => {\n    if (currentUser?.role !== role) {\n      roleMutation.mutate(role);\n    }\n  };\n\n  const copyUserId = () => {\n    if (displayUser?.id) {\n      navigator.clipboard.writeText(displayUser.id.slice(0, 8).toUpperCase());\n      setCopiedId(true);\n      toast({\n        title: \"Copied\",\n        description: \"User ID copied to clipboard\",\n      });\n      setTimeout(() => setCopiedId(false), 2000);\n    }\n  };\n\n  const handleFollow = () => {\n    if (followStats?.isFollowing) {\n      unfollowMutation.mutate();\n    } else {\n      followMutation.mutate();\n    }\n  };\n\n  const handleMessage = () => {\n    setLocation(`/messages?user=${urlUserId}`);\n  };\n\n  const handleUpdateUsername = () => {\n    if (usernameInput.length >= 3 && usernameInput.length <= 20) {\n      updateUsernameMutation.mutate(usernameInput);\n    } else {\n      toast({\n        title: \"Invalid Username\",\n        description: \"Username must be between 3 and 20 characters\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const isLoading = authLoading || (!isOwnProfile && profileLoading);\n\n  if (isLoading || !displayUser) {\n    return (\n      <div className=\"min-h-screen\">\n        <div className=\"relative\" style={{ aspectRatio: '16/5' }}>\n          <Skeleton className=\"absolute inset-0\" />\n        </div>\n        <div className=\"container mx-auto px-4 -mt-16 max-w-4xl\">\n          <div className=\"space-y-6\">\n            <div className=\"flex items-end gap-4\">\n              <Skeleton className=\"h-32 w-32 rounded-full\" />\n              <div className=\"flex-1 space-y-2\">\n                <Skeleton className=\"h-6 w-48\" />\n                <Skeleton className=\"h-4 w-32\" />\n              </div>\n            </div>\n            <Skeleton className=\"h-20 w-full\" />\n            <Skeleton className=\"h-64 w-full\" />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const initials = displayUser.firstName && displayUser.lastName\n    ? `${displayUser.firstName[0]}${displayUser.lastName[0]}`\n    : displayUser.email?.[0] || \"U\";\n\n  const fullName = displayUser.firstName && displayUser.lastName\n    ? `${displayUser.firstName} ${displayUser.lastName}`\n    : displayUser.firstName || \"User\";\n\n  const username = displayUser.username || displayUser.email?.split(\"@\")[0] || \"user\";\n  const shortId = displayUser.id?.slice(0, 8).toUpperCase() || \"00000000\";\n\n  const isSeller = displayUser.role === \"seller\" || displayUser.role === \"both\" || displayUser.role === \"admin\";\n  const isSystemAccount = displayUser.isSystemAccount === true;\n  const isVerified = displayUser.isVerified || displayUser.ninVerified || isSystemAccount;\n\n  const canEdit = isOwnProfile && !isPreviewMode;\n\n  const mediaPosts = userPosts?.filter(p => (p.images && p.images.length > 0) || (p.videos && p.videos.length > 0)) || [];\n\n  return (\n    <div className=\"min-h-screen pb-24\">\n      <div className=\"relative\">\n        <div \n          className={`relative w-full overflow-hidden ${isSystemAccount ? 'bg-gradient-to-br from-yellow-500/30 via-amber-400/20 to-background' : ''}`}\n          style={{\n            aspectRatio: '16/5',\n            backgroundImage: coverPhoto \n              ? `url(${coverPhoto})` \n              : isSystemAccount\n                ? undefined\n                : 'linear-gradient(135deg, hsl(var(--primary)/0.3) 0%, hsl(var(--primary)/0.1) 50%, hsl(var(--background)) 100%)',\n            backgroundSize: 'cover',\n            backgroundPosition: 'center',\n          }}\n        >\n          <div className=\"absolute inset-0 bg-gradient-to-b from-black/30 via-black/20 to-background\" />\n          <div className=\"absolute inset-0 bg-gradient-to-t from-background via-background/50 to-transparent\" />\n          \n          {canEdit && (\n            <>\n              <button\n                type=\"button\"\n                onClick={() => coverInputRef.current?.click()}\n                className=\"absolute inset-0 flex items-center justify-center bg-black/0 hover:bg-black/30 transition-colors group\"\n                data-testid=\"button-change-cover\"\n              >\n                <div className=\"p-3 rounded-full bg-black/40 text-white backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity\">\n                  <Camera className=\"h-6 w-6\" />\n                </div>\n              </button>\n              <input\n                ref={coverInputRef}\n                type=\"file\"\n                accept=\"image/*\"\n                onChange={handleCoverSelect}\n                className=\"hidden\"\n                data-testid=\"input-cover-file\"\n              />\n            </>\n          )}\n          \n          {!canEdit && coverPhoto && (\n            <button\n              type=\"button\"\n              onClick={() => setLightboxImage(coverPhoto)}\n              className=\"absolute inset-0 flex items-center justify-center bg-black/0 hover:bg-black/20 transition-colors\"\n              data-testid=\"button-view-cover\"\n            />\n          )}\n          \n          {isPreviewMode && isOwnProfile && (\n            <div className=\"absolute top-4 right-4 z-10\">\n              <Badge variant=\"secondary\" className=\"gap-1.5 bg-black/40 text-white backdrop-blur-sm border-0\">\n                <Eye className=\"h-3 w-3\" />\n                Preview Mode\n              </Badge>\n            </div>\n          )}\n        </div>\n\n        <div className=\"container mx-auto px-4 max-w-4xl relative\">\n          <div className=\"flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 -mt-16 md:-mt-20 relative z-10\">\n            <div className=\"flex items-end gap-4\">\n              <div className=\"relative group\">\n                <motion.div\n                  whileHover={{ scale: 1.02 }}\n                  transition={{ type: \"spring\", stiffness: 300 }}\n                  onClick={hasActiveStories ? handleAvatarClick : undefined}\n                  className={hasActiveStories ? \"cursor-pointer\" : \"\"}\n                >\n                  <div \n                    className={`rounded-full p-1 ${\n                      hasActiveStories \n                        ? hasUnviewedStories \n                          ? 'bg-gradient-to-tr from-[#16a34a] via-[#22c55e] to-[#16a34a]' \n                          : 'bg-muted'\n                        : ''\n                    }`}\n                  >\n                    <Avatar className={`h-28 w-28 md:h-36 md:w-36 ring-4 ring-background shadow-2xl ${isSystemAccount ? 'ring-yellow-500/50' : ''}`}>\n                      <AvatarImage src={previewUrl || displayUser.profileImageUrl || undefined} />\n                      <AvatarFallback className={`text-3xl md:text-4xl font-bold ${isSystemAccount ? 'bg-gradient-to-br from-yellow-500/30 to-amber-400/20' : 'bg-gradient-to-br from-primary/20 to-primary/5'}`}>\n                        {initials}\n                      </AvatarFallback>\n                    </Avatar>\n                  </div>\n                </motion.div>\n                {canEdit && (\n                  <button\n                    type=\"button\"\n                    onClick={() => fileInputRef.current?.click()}\n                    className=\"absolute bottom-1 right-1 p-2 rounded-full bg-background border shadow-md hover-elevate active-elevate-2 transition-all\"\n                    data-testid=\"button-change-avatar\"\n                  >\n                    <Camera className=\"h-4 w-4\" />\n                  </button>\n                )}\n                {!canEdit && displayUser.profileImageUrl && (\n                  <button\n                    type=\"button\"\n                    onClick={() => setLightboxImage(displayUser.profileImageUrl!)}\n                    className=\"absolute bottom-1 right-1 p-2 rounded-full bg-background/80 border shadow-md hover:bg-background transition-all\"\n                    data-testid=\"button-view-avatar\"\n                  >\n                    <Eye className=\"h-4 w-4\" />\n                  </button>\n                )}\n                <input\n                  ref={fileInputRef}\n                  type=\"file\"\n                  accept=\"image/*\"\n                  onChange={handleFileSelect}\n                  className=\"hidden\"\n                  data-testid=\"input-avatar-file\"\n                />\n              </div>\n              \n              <div className=\"pb-2 sm:pb-4\">\n                <div className=\"flex items-center gap-2 flex-wrap\">\n                  <h1 className=\"text-xl md:text-2xl font-bold\" data-testid=\"text-display-name\">\n                    {fullName}\n                  </h1>\n                  {isVerified && (\n                    <BadgeCheck \n                      className={`h-5 w-5 md:h-6 md:w-6 ${isSystemAccount ? 'text-yellow-500' : 'text-primary'}`} \n                      data-testid=\"icon-verified\"\n                    />\n                  )}\n                </div>\n                \n                {isSystemAccount && (\n                  <Badge className=\"mt-1 bg-yellow-500/20 text-yellow-700 dark:text-yellow-400 border-yellow-500/30\">\n                    Official Account\n                  </Badge>\n                )}\n                \n                {displayUser.username ? (\n                  <p className=\"text-muted-foreground text-sm md:text-base\" data-testid=\"text-username\">\n                    @{displayUser.username}\n                  </p>\n                ) : isOwnProfile ? (\n                  <button\n                    onClick={() => {\n                      setIsUpdatingUsername(true);\n                      setIsEditDialogOpen(true);\n                    }}\n                    className=\"text-primary text-sm hover:underline flex items-center gap-1\"\n                    data-testid=\"button-add-username\"\n                  >\n                    <AtSign className=\"h-3 w-3\" />\n                    Add username\n                  </button>\n                ) : (\n                  <p className=\"text-muted-foreground text-sm\" data-testid=\"text-username-fallback\">\n                    @{displayUser.email?.split(\"@\")[0]}\n                  </p>\n                )}\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-2 pb-2 sm:pb-4\">\n              {isOwnProfile ? (\n                <>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setIsEditDialogOpen(true)}\n                    data-testid=\"button-edit-profile\"\n                  >\n                    <Pencil className=\"h-4 w-4 mr-2\" />\n                    Edit Profile\n                  </Button>\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-settings-menu\">\n                        <MoreHorizontal className=\"h-5 w-5\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\" className=\"w-48\">\n                      {(currentUser?.role === \"admin\" || currentUser?.id?.slice(0, 8).toLowerCase() === \"e461e9f4\") && (\n                        <DropdownMenuItem \n                          onClick={() => setLocation(\"/admin\")}\n                          className=\"cursor-pointer\"\n                          data-testid=\"link-admin-dashboard\"\n                        >\n                          <Shield className=\"mr-2 h-4 w-4\" />\n                          Admin Dashboard\n                        </DropdownMenuItem>\n                      )}\n                      <DropdownMenuItem \n                        onClick={copyUserId}\n                        className=\"cursor-pointer\"\n                        data-testid=\"menu-item-copy-id\"\n                      >\n                        {copiedId ? <Check className=\"mr-2 h-4 w-4\" /> : <Copy className=\"mr-2 h-4 w-4\" />}\n                        Copy User ID\n                      </DropdownMenuItem>\n                      <DropdownMenuItem \n                        onClick={() => setLocation(\"/settings\")}\n                        className=\"cursor-pointer\"\n                      >\n                        <Settings className=\"mr-2 h-4 w-4\" />\n                        Settings\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </>\n              ) : (\n                <>\n                  <Button\n                    variant={followStats?.isFollowing ? \"outline\" : \"default\"}\n                    onClick={handleFollow}\n                    disabled={followMutation.isPending || unfollowMutation.isPending}\n                    data-testid=\"button-follow\"\n                  >\n                    {followMutation.isPending || unfollowMutation.isPending ? (\n                      <Loader2 className=\"h-4 w-4 animate-spin\" />\n                    ) : followStats?.isFollowing ? (\n                      <>\n                        <UserMinus className=\"h-4 w-4 mr-2\" />\n                        Unfollow\n                      </>\n                    ) : (\n                      <>\n                        <UserPlus className=\"h-4 w-4 mr-2\" />\n                        Follow\n                      </>\n                    )}\n                  </Button>\n                  <Button variant=\"outline\" onClick={handleMessage} data-testid=\"button-message\">\n                    <MessageCircle className=\"h-4 w-4 mr-2\" />\n                    Message\n                  </Button>\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-more-actions\">\n                        <MoreHorizontal className=\"h-5 w-5\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\" className=\"w-48\">\n                      <DropdownMenuItem \n                        onClick={copyUserId}\n                        className=\"cursor-pointer\"\n                      >\n                        {copiedId ? <Check className=\"mr-2 h-4 w-4\" /> : <Copy className=\"mr-2 h-4 w-4\" />}\n                        Copy User ID\n                      </DropdownMenuItem>\n                      <DropdownMenuSeparator />\n                      <DropdownMenuItem \n                        onClick={() => setIsBlockDialogOpen(true)}\n                        className=\"cursor-pointer text-destructive\"\n                      >\n                        <Ban className=\"mr-2 h-4 w-4\" />\n                        Block\n                      </DropdownMenuItem>\n                      <DropdownMenuItem \n                        onClick={() => setIsReportDialogOpen(true)}\n                        className=\"cursor-pointer text-destructive\"\n                      >\n                        <Flag className=\"mr-2 h-4 w-4\" />\n                        Report\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </>\n              )}\n            </div>\n          </div>\n\n          <motion.div \n            className=\"mt-6 space-y-3\"\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.1 }}\n          >\n            {displayUser.bio && (\n              <p className=\"text-sm md:text-base\" data-testid=\"text-bio\">\n                {displayUser.bio}\n              </p>\n            )}\n\n            {((displayUser as any).instagramHandle || (displayUser as any).tiktokHandle) && (\n              <div className=\"flex flex-wrap items-center gap-3 text-sm\">\n                {(displayUser as any).instagramHandle && (\n                  <a\n                    href={`https://instagram.com/${(displayUser as any).instagramHandle}`}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"flex items-center gap-1.5 text-muted-foreground hover:text-foreground transition-colors\"\n                    data-testid=\"link-instagram\"\n                  >\n                    <SiInstagram className=\"h-4 w-4\" />\n                    <span>@{(displayUser as any).instagramHandle}</span>\n                  </a>\n                )}\n                {(displayUser as any).tiktokHandle && (\n                  <a\n                    href={`https://tiktok.com/@${(displayUser as any).tiktokHandle}`}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"flex items-center gap-1.5 text-muted-foreground hover:text-foreground transition-colors\"\n                    data-testid=\"link-tiktok\"\n                  >\n                    <Music className=\"h-4 w-4\" />\n                    <span>@{(displayUser as any).tiktokHandle}</span>\n                  </a>\n                )}\n              </div>\n            )}\n            \n            <div className=\"flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-muted-foreground\">\n              {/* GPS-based location badge (if coordinates available) */}\n              {(displayUser as any).latitude && (displayUser as any).longitude && (\n                <LocationBadge\n                  latitude={(displayUser as any).latitude}\n                  longitude={(displayUser as any).longitude}\n                  variant=\"default\"\n                />\n              )}\n              {/* Text-based location fallback */}\n              {displayUser.location && !(displayUser as any).latitude && (\n                <span className=\"flex items-center gap-1\" data-testid=\"text-location\">\n                  <MapPin className=\"h-4 w-4\" />\n                  {displayUser.location}\n                </span>\n              )}\n              \n              {displayUser.createdAt && (\n                <span className=\"flex items-center gap-1\" data-testid=\"text-join-date\">\n                  <Calendar className=\"h-4 w-4\" />\n                  Joined {formatJoinDate(displayUser.createdAt)}\n                </span>\n              )}\n            </div>\n            \n            <div className=\"flex items-center gap-4 text-sm\">\n              <button \n                className=\"hover:underline\"\n                onClick={() => {}}\n                data-testid=\"button-following-count\"\n              >\n                <span className=\"font-semibold\">{formatCount(followStats?.followingCount || 0)}</span>\n                <span className=\"text-muted-foreground ml-1\">Following</span>\n              </button>\n              <button \n                className=\"hover:underline\"\n                onClick={() => {}}\n                data-testid=\"button-follower-count\"\n              >\n                <span className=\"font-semibold\">{formatCount(followStats?.followerCount || 0)}</span>\n                <span className=\"text-muted-foreground ml-1\">Followers</span>\n              </button>\n            </div>\n\n          </motion.div>\n\n          {lightboxImage && (\n            <Dialog open={!!lightboxImage} onOpenChange={() => setLightboxImage(null)}>\n              <DialogContent className=\"max-w-3xl p-0 bg-black/90 border-0\">\n                <img src={lightboxImage} alt=\"Preview\" className=\"w-full h-auto\" />\n              </DialogContent>\n            </Dialog>\n          )}\n\n          <AnimatePresence>\n            {showPreviewAfterSave && isOwnProfile && (\n              <motion.div\n                initial={{ opacity: 0, height: 0 }}\n                animate={{ opacity: 1, height: \"auto\" }}\n                exit={{ opacity: 0, height: 0 }}\n                className=\"mt-4\"\n              >\n                <Card className=\"bg-primary/5 border-primary/20\">\n                  <CardContent className=\"pt-4 pb-4\">\n                    <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                      <div className=\"flex items-center gap-2\">\n                        <Eye className=\"h-5 w-5 text-primary\" />\n                        <span className=\"text-sm\">\n                          Preview mode: See how others view your profile\n                        </span>\n                      </div>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => {\n                          setIsPreviewMode(false);\n                          setShowPreviewAfterSave(false);\n                        }}\n                        data-testid=\"button-close-preview-banner\"\n                      >\n                        Back to Edit\n                      </Button>\n                    </div>\n                  </CardContent>\n                </Card>\n              </motion.div>\n            )}\n          </AnimatePresence>\n\n          <AnimatePresence>\n            {selectedFile && canEdit && (\n              <motion.div\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -20 }}\n                className=\"mt-4\"\n              >\n                <Card className=\"max-w-md\">\n                  <CardContent className=\"pt-4\">\n                    <div className=\"flex items-center justify-between gap-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <Avatar className=\"h-12 w-12\">\n                          <AvatarImage src={previewUrl || undefined} />\n                          <AvatarFallback>{initials}</AvatarFallback>\n                        </Avatar>\n                        <div className=\"text-left\">\n                          <p className=\"text-sm font-medium\">New profile picture</p>\n                          <p className=\"text-xs text-muted-foreground\">{selectedFile.name}</p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={handleCancelUpload}\n                          disabled={uploadImageMutation.isPending}\n                          data-testid=\"button-cancel-upload\"\n                        >\n                          <X className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          onClick={handleUpload}\n                          disabled={uploadImageMutation.isPending}\n                          data-testid=\"button-upload-avatar\"\n                        >\n                          {uploadImageMutation.isPending ? (\n                            <>\n                              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                              Uploading...\n                            </>\n                          ) : (\n                            \"Upload\"\n                          )}\n                        </Button>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </motion.div>\n            )}\n          </AnimatePresence>\n\n          {pinnedPosts && pinnedPosts.length > 0 && (\n            <motion.div\n              className=\"mt-6\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.2 }}\n            >\n              {pinnedPosts.map(post => (\n                <PinnedPostCard key={post.id} post={post} />\n              ))}\n            </motion.div>\n          )}\n\n          <motion.div\n            className=\"mt-6\"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.3 }}\n          >\n            <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n              <TabsList className=\"w-full justify-start rounded-none border-b bg-transparent p-0 h-auto\">\n                <TabsTrigger \n                  value=\"posts\" \n                  className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-3\"\n                  data-testid=\"tab-posts\"\n                >\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                  Posts\n                </TabsTrigger>\n                {isSeller && (\n                  <TabsTrigger \n                    value=\"selling\" \n                    className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-3\"\n                    data-testid=\"tab-selling\"\n                  >\n                    <Store className=\"h-4 w-4 mr-2\" />\n                    Selling\n                  </TabsTrigger>\n                )}\n                {isOwnProfile && (\n                  <TabsTrigger \n                    value=\"likes\" \n                    className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-3\"\n                    data-testid=\"tab-likes\"\n                  >\n                    <Heart className=\"h-4 w-4 mr-2\" />\n                    Likes\n                  </TabsTrigger>\n                )}\n                <TabsTrigger \n                  value=\"media\" \n                  className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-3\"\n                  data-testid=\"tab-media\"\n                >\n                  <Image className=\"h-4 w-4 mr-2\" />\n                  Media\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"posts\" className=\"mt-4\">\n                {postsLoading ? (\n                  <div className=\"space-y-3\">\n                    {[1, 2, 3].map(i => (\n                      <Skeleton key={i} className=\"h-32 w-full\" />\n                    ))}\n                  </div>\n                ) : userPosts && userPosts.length > 0 ? (\n                  <div>\n                    {userPosts.map(post => (\n                      <SocialPostCard key={post.id} post={post} />\n                    ))}\n                  </div>\n                ) : (\n                  <Card className=\"p-8 text-center\">\n                    <FileText className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                    <p className=\"text-muted-foreground\">No posts yet</p>\n                    {isOwnProfile && (\n                      <Button \n                        variant=\"outline\" \n                        className=\"mt-4\"\n                        onClick={() => setLocation(\"/the-plug\")}\n                      >\n                        Create your first post\n                      </Button>\n                    )}\n                  </Card>\n                )}\n              </TabsContent>\n\n              {isSeller && (\n                <TabsContent value=\"selling\" className=\"mt-4\">\n                  {productsLoading ? (\n                    <div className=\"space-y-3\">\n                      {[1, 2, 3].map(i => (\n                        <Skeleton key={i} className=\"h-24 w-full\" />\n                      ))}\n                    </div>\n                  ) : userProducts && userProducts.length > 0 ? (\n                    <div>\n                      {userProducts.map(product => (\n                        <ProductCard key={product.id} product={product} />\n                      ))}\n                    </div>\n                  ) : (\n                    <Card className=\"p-8 text-center\">\n                      <Store className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                      <p className=\"text-muted-foreground\">No products listed</p>\n                      {isOwnProfile && (\n                        <Button \n                          variant=\"outline\" \n                          className=\"mt-4\"\n                          onClick={() => setLocation(\"/seller-dashboard\")}\n                        >\n                          List a product\n                        </Button>\n                      )}\n                    </Card>\n                  )}\n                </TabsContent>\n              )}\n\n              {isOwnProfile && (\n                <TabsContent value=\"likes\" className=\"mt-4\">\n                  <Card className=\"p-8 text-center\">\n                    <Heart className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                    <p className=\"text-muted-foreground\">Posts you've liked will appear here</p>\n                  </Card>\n                </TabsContent>\n              )}\n\n              <TabsContent value=\"media\" className=\"mt-4\">\n                {postsLoading ? (\n                  <div className=\"grid grid-cols-3 gap-1\">\n                    {[1, 2, 3, 4, 5, 6].map(i => (\n                      <Skeleton key={i} className=\"aspect-square\" />\n                    ))}\n                  </div>\n                ) : mediaPosts.length > 0 ? (\n                  <div className=\"grid grid-cols-3 gap-1\">\n                    {mediaPosts.map(post => (\n                      <div \n                        key={post.id} \n                        className=\"aspect-square overflow-hidden cursor-pointer hover:opacity-80 transition-opacity\"\n                        onClick={() => setLocation(\"/the-plug\")}\n                      >\n                        {post.images && post.images[0] && (\n                          <img \n                            src={post.images[0]} \n                            alt=\"\" \n                            className=\"w-full h-full object-cover\"\n                            loading=\"lazy\"\n                          />\n                        )}\n                        {post.videos && post.videos[0] && !post.images?.[0] && (\n                          <video \n                            src={post.videos[0]} \n                            className=\"w-full h-full object-cover\"\n                          />\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <Card className=\"p-8 text-center\">\n                    <Image className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                    <p className=\"text-muted-foreground\">No media posts yet</p>\n                  </Card>\n                )}\n              </TabsContent>\n            </Tabs>\n          </motion.div>\n\n          {isOwnProfile && !isPreviewMode && (\n            <motion.div\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.4 }}\n            >\n              <Card className=\"mt-6 border-2 border-primary/10 bg-gradient-to-br from-primary/5 via-transparent to-transparent\">\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"flex items-center gap-2 text-base\">\n                    <Users className=\"h-5 w-5 text-primary\" />\n                    Switch Your Role\n                  </CardTitle>\n                  <CardDescription>\n                    Choose how you want to use EKSU Marketplace\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid grid-cols-2 gap-3\" data-testid=\"role-switch-group\">\n                    {[\n                      { role: \"buyer\" as const, icon: ShoppingCart, label: \"Buyer\", desc: \"Shop products\" },\n                      { role: \"seller\" as const, icon: Store, label: \"Seller\", desc: \"Sell products\" },\n                    ].map((item) => (\n                      <Button\n                        key={item.role}\n                        variant={currentUser?.role === item.role ? \"default\" : \"outline\"}\n                        onClick={() => handleRoleChange(item.role)}\n                        disabled={roleMutation.isPending || currentUser?.role === \"admin\"}\n                        className=\"flex flex-col gap-1.5 h-auto py-4\"\n                        data-testid={`button-role-${item.role}`}\n                      >\n                        <item.icon className=\"h-5 w-5\" />\n                        <span className=\"font-semibold text-sm\">{item.label}</span>\n                        <span className=\"text-[10px] opacity-80\">{item.desc}</span>\n                        {roleMutation.isPending && currentUser?.role !== item.role && (\n                          <Loader2 className=\"h-3 w-3 animate-spin\" />\n                        )}\n                      </Button>\n                    ))}\n                  </div>\n                  \n                  {currentUser?.role === \"admin\" && (\n                    <p className=\"text-sm text-muted-foreground mt-3 text-center\">\n                      Admin accounts cannot change their role.\n                    </p>\n                  )}\n                </CardContent>\n              </Card>\n            </motion.div>\n          )}\n        </div>\n      </div>\n\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent className=\"max-w-lg max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Settings className=\"h-5 w-5\" />\n              Edit Profile\n            </DialogTitle>\n          </DialogHeader>\n          <Form {...form}>\n            <form\n              onSubmit={form.handleSubmit((data) => updateMutation.mutate(data))}\n              className=\"space-y-4\"\n            >\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"username\">Username</Label>\n                <div className=\"flex gap-2\">\n                  <div className=\"relative flex-1\">\n                    <AtSign className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      id=\"username\"\n                      value={usernameInput}\n                      onChange={(e) => setUsernameInput(e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, ''))}\n                      placeholder=\"username\"\n                      className=\"pl-9\"\n                      maxLength={20}\n                      data-testid=\"input-username\"\n                    />\n                  </div>\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={handleUpdateUsername}\n                    disabled={updateUsernameMutation.isPending || usernameInput === currentUser?.username}\n                    data-testid=\"button-update-username\"\n                  >\n                    {updateUsernameMutation.isPending ? (\n                      <Loader2 className=\"h-4 w-4 animate-spin\" />\n                    ) : (\n                      \"Update\"\n                    )}\n                  </Button>\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  3-20 characters. Letters, numbers, and underscores only.\n                </p>\n              </div>\n\n              <div className=\"grid gap-4 sm:grid-cols-2\">\n                <FormField\n                  control={form.control}\n                  name=\"firstName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>First Name</FormLabel>\n                      <FormControl>\n                        <Input {...field} value={field.value || \"\"} data-testid=\"input-first-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"lastName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Last Name</FormLabel>\n                      <FormControl>\n                        <Input {...field} value={field.value || \"\"} data-testid=\"input-last-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"phoneNumber\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Phone Number</FormLabel>\n                    <FormControl>\n                      <Input {...field} value={field.value || \"\"} data-testid=\"input-phone\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"location\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Campus Location</FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"e.g., Hostel A, Block 3\"\n                        {...field}\n                        value={field.value || \"\"}\n                        data-testid=\"input-location\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"bio\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Bio</FormLabel>\n                    <FormControl>\n                      <Textarea\n                        placeholder=\"Tell us about yourself...\"\n                        rows={4}\n                        {...field}\n                        value={field.value || \"\"}\n                        data-testid=\"input-bio\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"gender\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Gender</FormLabel>\n                    <Select\n                      value={field.value || \"\"}\n                      onValueChange={field.onChange}\n                    >\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-gender-profile\">\n                          <SelectValue placeholder=\"Select gender (optional)\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"male\">Male</SelectItem>\n                        <SelectItem value=\"female\">Female</SelectItem>\n                        <SelectItem value=\"other\">Other</SelectItem>\n                        <SelectItem value=\"prefer_not_to_say\">Prefer not to say</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormDescription>\n                      Used for personalized experience. Optional.\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"instagramHandle\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"flex items-center gap-2\">\n                      <SiInstagram className=\"h-4 w-4\" />\n                      Instagram\n                    </FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"@username\"\n                        {...field}\n                        value={field.value || \"\"}\n                        onChange={(e) => {\n                          const value = e.target.value.replace(/^@/, '');\n                          field.onChange(value);\n                        }}\n                        data-testid=\"input-instagram\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      Only letters, numbers, underscores, and periods allowed.\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"tiktokHandle\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"flex items-center gap-2\">\n                      <Music className=\"h-4 w-4\" />\n                      TikTok\n                    </FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"@username\"\n                        {...field}\n                        value={field.value || \"\"}\n                        onChange={(e) => {\n                          const value = e.target.value.replace(/^@/, '');\n                          field.onChange(value);\n                        }}\n                        data-testid=\"input-tiktok\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      Only letters, numbers, underscores, and periods allowed.\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"flex gap-3 pt-2\">\n                <Button\n                  type=\"submit\"\n                  disabled={updateMutation.isPending}\n                  className=\"flex-1\"\n                  data-testid=\"button-save-profile\"\n                >\n                  {updateMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      Saving...\n                    </>\n                  ) : (\n                    \"Save Changes\"\n                  )}\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setIsEditDialogOpen(false)}\n                  data-testid=\"button-cancel-edit\"\n                >\n                  Cancel\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={isBlockDialogOpen} onOpenChange={setIsBlockDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"flex items-center gap-2\">\n              <Ban className=\"h-5 w-5 text-destructive\" />\n              Block User\n            </AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to block <span className=\"font-semibold\">{fullName}</span>? \n              They won't be able to message you, see your listings, or interact with your content. \n              You can unblock them later from your settings.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-block\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => blockMutation.mutate()}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              disabled={blockMutation.isPending}\n              data-testid=\"button-confirm-block\"\n            >\n              {blockMutation.isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Blocking...\n                </>\n              ) : (\n                \"Block User\"\n              )}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      <AlertDialog open={isReportDialogOpen} onOpenChange={setIsReportDialogOpen}>\n        <AlertDialogContent className=\"max-w-md\">\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"flex items-center gap-2\">\n              <Flag className=\"h-5 w-5 text-destructive\" />\n              Report User\n            </AlertDialogTitle>\n            <AlertDialogDescription>\n              Help us keep EKSU Marketplace safe. Please tell us why you're reporting this user.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"report-reason\">Reason for report</Label>\n              <Select value={reportReason} onValueChange={setReportReason}>\n                <SelectTrigger id=\"report-reason\" data-testid=\"select-report-reason\">\n                  <SelectValue placeholder=\"Select a reason\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"spam\">Spam or fake account</SelectItem>\n                  <SelectItem value=\"scam\">Scam or fraud</SelectItem>\n                  <SelectItem value=\"harassment\">Harassment or bullying</SelectItem>\n                  <SelectItem value=\"inappropriate\">Inappropriate content</SelectItem>\n                  <SelectItem value=\"impersonation\">Impersonation</SelectItem>\n                  <SelectItem value=\"other\">Other</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"report-description\">Additional details (optional)</Label>\n              <Textarea\n                id=\"report-description\"\n                placeholder=\"Provide any additional context that might help us investigate...\"\n                value={reportDescription}\n                onChange={(e) => setReportDescription(e.target.value)}\n                rows={3}\n                data-testid=\"input-report-description\"\n              />\n            </div>\n          </div>\n          <AlertDialogFooter>\n            <AlertDialogCancel \n              onClick={() => {\n                setReportReason(\"\");\n                setReportDescription(\"\");\n              }}\n              data-testid=\"button-cancel-report\"\n            >\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => reportMutation.mutate({ reason: reportReason, description: reportDescription })}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              disabled={!reportReason || reportMutation.isPending}\n              data-testid=\"button-submit-report\"\n            >\n              {reportMutation.isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Submitting...\n                </>\n              ) : (\n                \"Submit Report\"\n              )}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {selectedUserStories && currentUser && (\n        <StoryViewer\n          stories={selectedUserStories}\n          onClose={() => setSelectedUserStories(null)}\n          currentUserId={currentUser.id}\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":69635,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/pages/home.tsx":{"content":"import { useState, useEffect, useMemo, useCallback } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { ProductCard } from \"@/components/ProductCard\";\nimport { SponsoredAdCard } from \"@/components/SponsoredAdCard\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Plus, SlidersHorizontal, X, MapPin, Wallet, Search, Tag } from \"lucide-react\";\nimport { Link, useLocation, useSearch } from \"wouter\";\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from \"@/components/ui/sheet\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport type { Product, Category, SponsoredAd } from \"@shared/schema\";\nimport { useAuth } from \"@/hooks/useAuth\";\n\nconst EKSU_LOCATIONS = [\n  { value: \"all\", label: \"All Locations\" },\n  { value: \"school_gate\", label: \"School Gate\" },\n  { value: \"town\", label: \"Town\" },\n  { value: \"yemkem\", label: \"Yemkem\" },\n  { value: \"iworoko\", label: \"Iworoko\" },\n  { value: \"phase2\", label: \"Phase2\" },\n  { value: \"osekita\", label: \"Osekita\" },\n];\n\nconst BROKE_STUDENT_MAX_PRICE = 10000;\nconst DEFAULT_MAX_PRICE = 100000;\nconst SEARCH_DEBOUNCE_MS = 300;\nconst MIN_SEARCH_CHARS = 2;\n\nexport default function Home() {\n  const [, setLocation] = useLocation();\n  const search = useSearch();\n  const searchParams = new URLSearchParams(search);\n  \n  const { isSeller } = useAuth();\n  const [searchQuery, setSearchQuery] = useState(searchParams.get(\"search\") || \"\");\n  const [debouncedSearch, setDebouncedSearch] = useState(searchQuery);\n  const [selectedCategory, setSelectedCategory] = useState(searchParams.get(\"category\") || \"all\");\n  const [priceRange, setPriceRange] = useState([0, DEFAULT_MAX_PRICE]);\n  const [condition, setCondition] = useState(searchParams.get(\"condition\") || \"all\");\n  const [locationFilter, setLocationFilter] = useState(searchParams.get(\"location\") || \"all\");\n  const [isBrokeStudentMode, setIsBrokeStudentMode] = useState(false);\n  const [categorySearch, setCategorySearch] = useState(\"\");\n\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (searchQuery.length >= MIN_SEARCH_CHARS || searchQuery.length === 0) {\n        setDebouncedSearch(searchQuery);\n      }\n    }, SEARCH_DEBOUNCE_MS);\n\n    return () => clearTimeout(timer);\n  }, [searchQuery]);\n\n  const toggleBrokeStudentMode = useCallback(() => {\n    if (isBrokeStudentMode) {\n      setPriceRange([0, DEFAULT_MAX_PRICE]);\n      setIsBrokeStudentMode(false);\n    } else {\n      setPriceRange([0, BROKE_STUDENT_MAX_PRICE]);\n      setIsBrokeStudentMode(true);\n    }\n  }, [isBrokeStudentMode]);\n\n  const activeFilterCount = useMemo(() => {\n    let count = 0;\n    if (selectedCategory !== \"all\") count++;\n    if (condition !== \"all\") count++;\n    if (locationFilter !== \"all\") count++;\n    if (priceRange[0] > 0 || priceRange[1] < DEFAULT_MAX_PRICE) count++;\n    if (debouncedSearch.length >= MIN_SEARCH_CHARS) count++;\n    return count;\n  }, [selectedCategory, condition, locationFilter, priceRange, debouncedSearch]);\n\n  const { data: categories } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const { data: products, isLoading } = useQuery<(Product & { seller?: any })[]>({\n    queryKey: [\"/api/products\", { \n      search: debouncedSearch.length >= MIN_SEARCH_CHARS ? debouncedSearch : undefined, \n      category: selectedCategory !== \"all\" ? selectedCategory : undefined, \n      condition: condition !== \"all\" ? condition : undefined, \n      location: locationFilter !== \"all\" ? locationFilter : undefined \n    }],\n  });\n\n  const { data: sponsoredAds = [] } = useQuery<SponsoredAd[]>({\n    queryKey: [\"/api/ads/active\", { type: \"marketplace\" }],\n  });\n\n  const handleSearch = () => {\n    const params = new URLSearchParams();\n    if (searchQuery) params.set(\"search\", searchQuery);\n    if (selectedCategory && selectedCategory !== \"all\") params.set(\"category\", selectedCategory);\n    if (condition && condition !== \"all\") params.set(\"condition\", condition);\n    if (locationFilter && locationFilter !== \"all\") params.set(\"location\", locationFilter);\n    setLocation(`/?${params.toString()}`);\n  };\n\n  const clearFilters = () => {\n    setSearchQuery(\"\");\n    setDebouncedSearch(\"\");\n    setSelectedCategory(\"all\");\n    setCondition(\"all\");\n    setLocationFilter(\"all\");\n    setPriceRange([0, DEFAULT_MAX_PRICE]);\n    setIsBrokeStudentMode(false);\n    setLocation(\"/\");\n  };\n\n  const getLocationLabel = (value: string) => {\n    return EKSU_LOCATIONS.find(loc => loc.value === value)?.label || value;\n  };\n\n  const FilterPanel = () => (\n    <div className=\"space-y-6\">\n      <div className=\"p-3 rounded-md bg-muted/50 border\">\n        <div className=\"flex items-center gap-2 mb-2\">\n          <MapPin className=\"h-4 w-4 text-muted-foreground\" />\n          <Label className=\"font-semibold\">Campus Location</Label>\n        </div>\n        <Select value={locationFilter} onValueChange={setLocationFilter}>\n          <SelectTrigger data-testid=\"select-location\" className={locationFilter !== \"all\" ? \"ring-2 ring-primary/50\" : \"\"}>\n            <SelectValue placeholder=\"All Locations\" />\n          </SelectTrigger>\n          <SelectContent>\n            {EKSU_LOCATIONS.map((loc) => (\n              <SelectItem key={loc.value} value={loc.value}>\n                {loc.label}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div>\n        <Button\n          variant={isBrokeStudentMode ? \"default\" : \"outline\"}\n          className={`w-full gap-2 ${isBrokeStudentMode ? \"bg-green-600 hover:bg-green-700 text-white\" : \"\"}`}\n          onClick={toggleBrokeStudentMode}\n          data-testid=\"button-broke-student-filter\"\n        >\n          <Wallet className=\"h-4 w-4\" />\n          Broke Student Mode\n          {isBrokeStudentMode && <Badge variant=\"secondary\" className=\"ml-auto text-xs\">Under ₦10k</Badge>}\n        </Button>\n      </div>\n\n      <div>\n        <div className=\"flex items-center gap-2 mb-2\">\n          <Tag className=\"h-4 w-4 text-muted-foreground\" />\n          <Label className=\"font-semibold\">Category</Label>\n        </div>\n        <div className=\"relative mb-2\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search categories...\"\n            value={categorySearch}\n            onChange={(e) => setCategorySearch(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-category-search\"\n          />\n        </div>\n        <ScrollArea className=\"h-[180px] rounded-md border\">\n          <div className=\"p-2 space-y-1\">\n            <Button\n              variant={selectedCategory === \"all\" ? \"default\" : \"ghost\"}\n              size=\"sm\"\n              className=\"w-full justify-start\"\n              onClick={() => setSelectedCategory(\"all\")}\n              data-testid=\"category-all\"\n            >\n              All Categories\n            </Button>\n            {categories\n              ?.filter(cat => \n                cat.name.toLowerCase().includes(categorySearch.toLowerCase())\n              )\n              .map((cat) => (\n                <Button\n                  key={cat.id}\n                  variant={selectedCategory === cat.id ? \"default\" : \"ghost\"}\n                  size=\"sm\"\n                  className=\"w-full justify-start\"\n                  onClick={() => setSelectedCategory(cat.id)}\n                  data-testid={`category-${cat.id}`}\n                >\n                  {cat.name}\n                </Button>\n              ))}\n            {categories && categorySearch && categories.filter(cat => \n              cat.name.toLowerCase().includes(categorySearch.toLowerCase())\n            ).length === 0 && (\n              <p className=\"text-sm text-muted-foreground text-center py-4\">\n                No categories found\n              </p>\n            )}\n          </div>\n        </ScrollArea>\n      </div>\n\n      <div>\n        <Label>Condition</Label>\n        <Select value={condition} onValueChange={setCondition}>\n          <SelectTrigger data-testid=\"select-condition\" className={condition !== \"all\" ? \"ring-2 ring-primary/50\" : \"\"}>\n            <SelectValue placeholder=\"Any Condition\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">Any Condition</SelectItem>\n            <SelectItem value=\"new\">New</SelectItem>\n            <SelectItem value=\"like_new\">Like New</SelectItem>\n            <SelectItem value=\"good\">Good</SelectItem>\n            <SelectItem value=\"fair\">Fair</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div>\n        <div className=\"flex items-center justify-between mb-2\">\n          <Label>Price Range</Label>\n          {(priceRange[0] > 0 || priceRange[1] < DEFAULT_MAX_PRICE) && (\n            <Badge variant=\"secondary\" className=\"text-xs\">Active</Badge>\n          )}\n        </div>\n        <div className=\"pt-2 space-y-3\">\n          <div className=\"flex items-center gap-2\">\n            <div className=\"flex-1\">\n              <Label className=\"text-xs text-muted-foreground mb-1 block\">Min</Label>\n              <div className=\"relative\">\n                <span className=\"absolute left-2 top-1/2 -translate-y-1/2 text-muted-foreground text-sm\">₦</span>\n                <Input\n                  type=\"number\"\n                  min={0}\n                  max={DEFAULT_MAX_PRICE}\n                  value={priceRange[0]}\n                  onChange={(e) => {\n                    const rawValue = e.target.value;\n                    if (rawValue === \"\") return;\n                    const parsed = parseInt(rawValue);\n                    if (isNaN(parsed)) return;\n                    const value = Math.max(0, Math.min(parsed, priceRange[1]));\n                    setPriceRange([value, priceRange[1]]);\n                    setIsBrokeStudentMode(false);\n                  }}\n                  onBlur={(e) => {\n                    const parsed = parseInt(e.target.value);\n                    if (isNaN(parsed) || parsed < 0) {\n                      setPriceRange([0, priceRange[1]]);\n                    } else if (parsed > priceRange[1]) {\n                      setPriceRange([priceRange[1], priceRange[1]]);\n                    }\n                  }}\n                  className=\"pl-6\"\n                  data-testid=\"input-min-price\"\n                />\n              </div>\n            </div>\n            <span className=\"text-muted-foreground mt-5\">-</span>\n            <div className=\"flex-1\">\n              <Label className=\"text-xs text-muted-foreground mb-1 block\">Max</Label>\n              <div className=\"relative\">\n                <span className=\"absolute left-2 top-1/2 -translate-y-1/2 text-muted-foreground text-sm\">₦</span>\n                <Input\n                  type=\"number\"\n                  min={0}\n                  max={DEFAULT_MAX_PRICE}\n                  value={priceRange[1]}\n                  onChange={(e) => {\n                    const rawValue = e.target.value;\n                    if (rawValue === \"\") return;\n                    const parsed = parseInt(rawValue);\n                    if (isNaN(parsed)) return;\n                    const value = Math.max(priceRange[0], Math.min(parsed, DEFAULT_MAX_PRICE));\n                    setPriceRange([priceRange[0], value]);\n                    if (value !== BROKE_STUDENT_MAX_PRICE) {\n                      setIsBrokeStudentMode(false);\n                    }\n                  }}\n                  onBlur={(e) => {\n                    const parsed = parseInt(e.target.value);\n                    if (isNaN(parsed) || parsed < priceRange[0]) {\n                      setPriceRange([priceRange[0], priceRange[0]]);\n                    } else if (parsed > DEFAULT_MAX_PRICE) {\n                      setPriceRange([priceRange[0], DEFAULT_MAX_PRICE]);\n                    }\n                  }}\n                  className=\"pl-6\"\n                  data-testid=\"input-max-price\"\n                />\n              </div>\n            </div>\n          </div>\n          <Slider\n            value={priceRange}\n            onValueChange={(value) => {\n              setPriceRange(value);\n              if (value[1] !== BROKE_STUDENT_MAX_PRICE) {\n                setIsBrokeStudentMode(false);\n              }\n            }}\n            max={DEFAULT_MAX_PRICE}\n            step={500}\n            data-testid=\"slider-price-range\"\n          />\n        </div>\n      </div>\n\n      <div className=\"flex gap-2\">\n        <Button onClick={handleSearch} className=\"flex-1\" data-testid=\"button-apply-filters\">\n          Apply Filters\n        </Button>\n        <Button variant=\"outline\" onClick={clearFilters} data-testid=\"button-clear-filters\">\n          <X className=\"h-4 w-4\" />\n        </Button>\n      </div>\n    </div>\n  );\n\n  const filteredProducts = products?.filter((p) => {\n    const price = parseFloat(p.price as string);\n    return price >= priceRange[0] && price <= priceRange[1];\n  });\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"flex flex-col gap-6 lg:flex-row\">\n          <aside className=\"hidden lg:block w-64 flex-shrink-0\">\n            <div className=\"sticky top-24 z-40 max-h-[calc(100vh-8rem)] overflow-y-auto overflow-x-hidden pr-2\" style={{ scrollbarWidth: 'thin', scrollbarColor: 'hsl(var(--muted-foreground) / 0.3) transparent' }}>\n              <div className=\"space-y-6 pb-4\">\n                <div className=\"flex items-center justify-between gap-2\">\n                  <h2 className=\"text-lg font-semibold\">Filters</h2>\n                  {activeFilterCount > 0 && (\n                    <Badge variant=\"secondary\" data-testid=\"badge-active-filters\">\n                      {activeFilterCount} active\n                    </Badge>\n                  )}\n                  <Button variant=\"ghost\" size=\"sm\" onClick={clearFilters}>\n                    Clear\n                  </Button>\n                </div>\n                <FilterPanel />\n              </div>\n            </div>\n          </aside>\n\n          <main className=\"flex-1\">\n            <div className=\"flex items-center justify-between gap-2 mb-6 flex-wrap\">\n              <h1 className=\"text-2xl font-bold\">Browse Products</h1>\n              <div className=\"flex gap-2 flex-wrap\">\n                {isSeller && (\n                  <Button asChild data-testid=\"button-create-listing\">\n                    <Link href=\"/products/new\">\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Sell Item\n                    </Link>\n                  </Button>\n                )}\n                <Sheet>\n                  <SheetTrigger asChild className=\"lg:hidden\">\n                    <Button variant=\"outline\" className=\"gap-2\" data-testid=\"button-mobile-filters\">\n                      <SlidersHorizontal className=\"h-4 w-4\" />\n                      Filters\n                      {activeFilterCount > 0 && (\n                        <Badge variant=\"secondary\" className=\"ml-1\">{activeFilterCount}</Badge>\n                      )}\n                    </Button>\n                  </SheetTrigger>\n                  <SheetContent side=\"left\">\n                    <SheetHeader>\n                      <SheetTitle className=\"flex items-center gap-2\">\n                        Filters\n                        {activeFilterCount > 0 && (\n                          <Badge variant=\"secondary\">{activeFilterCount} active</Badge>\n                        )}\n                      </SheetTitle>\n                    </SheetHeader>\n                    <div className=\"mt-6\">\n                      <FilterPanel />\n                    </div>\n                  </SheetContent>\n                </Sheet>\n              </div>\n            </div>\n\n            <div className=\"mb-4\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  type=\"search\"\n                  placeholder=\"Search products... (type 2+ characters)\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  onKeyDown={(e) => e.key === \"Enter\" && handleSearch()}\n                  className={`pl-10 ${searchQuery.length >= MIN_SEARCH_CHARS ? \"ring-2 ring-primary/50\" : \"\"}`}\n                  data-testid=\"input-search-products\"\n                />\n              </div>\n              {searchQuery.length > 0 && searchQuery.length < MIN_SEARCH_CHARS && (\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Type {MIN_SEARCH_CHARS - searchQuery.length} more character(s) to search\n                </p>\n              )}\n            </div>\n\n            {activeFilterCount > 0 && (\n              <div className=\"mb-4 flex flex-wrap gap-2\" data-testid=\"active-filters-display\">\n                {debouncedSearch.length >= MIN_SEARCH_CHARS && (\n                  <Badge variant=\"outline\" className=\"gap-1\">\n                    Search: \"{debouncedSearch}\"\n                    <X \n                      className=\"h-3 w-3 cursor-pointer\" \n                      onClick={() => { setSearchQuery(\"\"); setDebouncedSearch(\"\"); }}\n                    />\n                  </Badge>\n                )}\n                {selectedCategory !== \"all\" && (\n                  <Badge variant=\"outline\" className=\"gap-1\">\n                    Category: {categories?.find(c => c.id === selectedCategory)?.name || selectedCategory}\n                    <X \n                      className=\"h-3 w-3 cursor-pointer\" \n                      onClick={() => setSelectedCategory(\"all\")}\n                    />\n                  </Badge>\n                )}\n                {condition !== \"all\" && (\n                  <Badge variant=\"outline\" className=\"gap-1\">\n                    Condition: {condition.replace(\"_\", \" \")}\n                    <X \n                      className=\"h-3 w-3 cursor-pointer\" \n                      onClick={() => setCondition(\"all\")}\n                    />\n                  </Badge>\n                )}\n                {locationFilter !== \"all\" && (\n                  <Badge variant=\"outline\" className=\"gap-1\">\n                    <MapPin className=\"h-3 w-3\" />\n                    {getLocationLabel(locationFilter)}\n                    <X \n                      className=\"h-3 w-3 cursor-pointer\" \n                      onClick={() => setLocationFilter(\"all\")}\n                    />\n                  </Badge>\n                )}\n                {(priceRange[0] > 0 || priceRange[1] < DEFAULT_MAX_PRICE) && (\n                  <Badge variant=\"outline\" className=\"gap-1\">\n                    {isBrokeStudentMode ? (\n                      <>\n                        <Wallet className=\"h-3 w-3\" />\n                        Broke Student Mode\n                      </>\n                    ) : (\n                      <>₦{priceRange[0].toLocaleString()} - ₦{priceRange[1].toLocaleString()}</>\n                    )}\n                    <X \n                      className=\"h-3 w-3 cursor-pointer\" \n                      onClick={() => { setPriceRange([0, DEFAULT_MAX_PRICE]); setIsBrokeStudentMode(false); }}\n                    />\n                  </Badge>\n                )}\n              </div>\n            )}\n\n            {isLoading ? (\n              <div className=\"grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4\">\n                {[...Array(8)].map((_, i) => (\n                  <Card key={i}>\n                    <Skeleton className=\"aspect-square\" />\n                    <CardContent className=\"p-4\">\n                      <Skeleton className=\"h-4 w-3/4 mb-2\" />\n                      <Skeleton className=\"h-6 w-1/2\" />\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            ) : filteredProducts && filteredProducts.length > 0 ? (\n              <div className=\"grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4\">\n                {filteredProducts.map((product, index) => {\n                  const elements = [\n                    <ProductCard key={product.id} product={product} />\n                  ];\n                  \n                  const adIndex = Math.floor((index + 1) / 6);\n                  if ((index + 1) % 6 === 0 && sponsoredAds[adIndex - 1]) {\n                    elements.push(\n                      <SponsoredAdCard \n                        key={`ad-${sponsoredAds[adIndex - 1].id}`} \n                        ad={sponsoredAds[adIndex - 1]} \n                        variant=\"marketplace\"\n                      />\n                    );\n                  }\n                  \n                  return elements;\n                })}\n              </div>\n            ) : (\n              <div className=\"text-center py-12\">\n                <p className=\"text-lg text-muted-foreground\">No products found</p>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  Try adjusting your filters or search query\n                </p>\n                {activeFilterCount > 0 && (\n                  <Button variant=\"outline\" onClick={clearFilters} className=\"mt-4\">\n                    Clear All Filters\n                  </Button>\n                )}\n              </div>\n            )}\n          </main>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":21801,"size_tokens":null},"RAILWAY_DEPLOYMENT.md":{"content":"# Railway Deployment Guide - EKSU Campus Marketplace\n\nThis guide helps you deploy the EKSU Campus Marketplace to Railway.\n\n## Prerequisites\n\n1. **Railway Account**: Sign up at [railway.app](https://railway.app)\n2. **GitHub Repository**: Push your code to GitHub\n3. **Required API Keys**:\n   - Groq API Key (free) - Get from [console.groq.com](https://console.groq.com)\n   - Replit OAuth credentials (if using Replit Auth)\n\n## Step-by-Step Deployment\n\n### 1. Create Railway Project\n\n1. Go to [railway.app](https://railway.app) and click \"New Project\"\n2. Select \"Deploy from GitHub repo\"\n3. Choose your EKSU marketplace repository\n4. Railway will auto-detect it's a Node.js app\n\n### 2. Add PostgreSQL Database\n\n1. In your Railway project, click \"+ New\"\n2. Select \"Database\" → \"PostgreSQL\"\n3. Railway will automatically create a PostgreSQL instance\n4. **IMPORTANT**: Railway creates TWO database URLs:\n   - `DATABASE_URL` - Internal URL (only works between Railway services)\n   - `DATABASE_PUBLIC_URL` - **Public URL (USE THIS ONE)**\n5. Go to your Postgres service → Variables tab\n6. **Copy the `DATABASE_PUBLIC_URL`** value (contains `proxy.rlwy.net`)\n\n### 3. Configure Environment Variables\n\nClick on your web service → \"Variables\" and add:\n\n```bash\n# Database - CRITICAL: Use PUBLIC URL from Postgres service\n# Go to Postgres service → Variables → Copy DATABASE_PUBLIC_URL\n# Should contain \"proxy.rlwy.net\" NOT \"railway.internal\"\nDATABASE_URL=postgresql://postgres:PASSWORD@roundhouse.proxy.rlwy.net:PORT/railway\n\n# Session Secret (use the one generated below)\nSESSION_SECRET=eb5b5ffee77c780593d5781bcfd6c8b08bb2b90523f47299da007cb54a9e2cad\n\n# Groq AI Chatbot (required)\nGROQ_API_KEY=your_groq_api_key_here\n\n# Node Environment\nNODE_ENV=production\n\n# Replit Auth (optional - only if using Replit Auth, otherwise skip)\nREPL_ID=your_replit_id\nISSUER_URL=https://replit.com/oidc\n```\n\n#### How to Get Groq API Key (FREE):\n1. Go to [console.groq.com](https://console.groq.com)\n2. Sign up with Google/GitHub\n3. Click \"API Keys\" in sidebar\n4. Click \"Create API Key\"\n5. Copy the key and paste it in Railway\n\n#### Generate Session Secret:\n```bash\nnode -e \"console.log(require('crypto').randomBytes(32).toString('hex'))\"\n```\n\n### 4. Configure Build & Start Commands\n\nRailway should auto-detect these, but verify:\n\n**Build Command**:\n```bash\nnpm install && npm run db:push\n```\n\n**Start Command**:\n```bash\nnpm run dev\n```\n\n### 5. Set Up Custom Domain (Optional)\n\n1. Click on your service → \"Settings\" → \"Domains\"\n2. Click \"Generate Domain\" for a free `.railway.app` domain\n3. Or add your custom domain (e.g., `marketplace.eksu.edu.ng`)\n\n### 6. Deploy\n\n1. Click \"Deploy\" - Railway will build and start your app\n2. Monitor the build logs for any errors\n3. Once deployed, click the URL to view your marketplace\n\n## Database Migrations\n\nThe app uses Drizzle ORM with automatic migrations:\n\n- **Initial Setup**: `npm run db:push` runs during build\n- **Schema Changes**: Push to GitHub → Railway auto-redeploys → migrations run automatically\n\n### Manual Migration (if needed):\n```bash\n# Connect to Railway via CLI\nrailway login\nrailway link\n\n# Run migrations\nrailway run npm run db:push --force\n```\n\n## Environment-Specific Notes\n\n### Production vs Development\n\n- **Development** (Replit): Uses `NODE_ENV=development`, hot reload enabled\n- **Production** (Railway): Uses `NODE_ENV=production`, optimized builds\n\nThe app automatically adapts based on `NODE_ENV`.\n\n### WebSocket Support\n\nReal-time chat uses WebSockets. Railway supports WebSockets by default - no extra configuration needed!\n\n## Monitoring & Logs\n\n### View Logs:\n1. Click on your service in Railway\n2. Click \"Deployments\" → Click latest deployment\n3. View real-time logs\n\n### Common Issues:\n\n**Build Fails**:\n- Check environment variables are set\n- Verify `GROQ_API_KEY` is present\n- Check build logs for specific errors\n\n**Database Connection Error**:\n- Verify PostgreSQL service is running\n- Check `DATABASE_URL` is set correctly\n- Ensure database and web service are in same project\n\n**Chatbot Not Working**:\n- Verify `GROQ_API_KEY` is set\n- Check Groq API quota (free tier limits)\n- Review logs for API errors\n\n## Scaling\n\nRailway auto-scales based on your plan:\n\n- **Starter Plan**: 500 hours/month free\n- **Developer Plan**: $5/month - higher limits\n- **Team Plan**: $20/month - production-ready\n\n## Backups\n\nRailway provides automatic daily backups for PostgreSQL:\n1. Click on PostgreSQL service\n2. Go to \"Backups\"\n3. Download or restore as needed\n\n## Support\n\n- **Railway Docs**: [docs.railway.app](https://docs.railway.app)\n- **Railway Discord**: Join for help\n- **Project Issues**: Create GitHub issue\n\n## Cost Estimates\n\n**Free Tier** (Starter):\n- 500 execution hours/month\n- PostgreSQL included\n- Good for testing\n\n**Paid** (Developer $5/mo):\n- Unlimited hours\n- Better performance\n- Custom domains\n- Production-ready\n\n**AI Costs**:\n- Groq API: **100% FREE** (rate limited)\n- No AI costs for this marketplace!\n\n## Next Steps\n\nAfter deployment:\n\n1. ✅ Test user registration and login\n2. ✅ Create test listings\n3. ✅ Test chatbot functionality\n4. ✅ Verify escrow payments work\n5. ✅ Test real-time chat\n6. ✅ Configure custom domain\n7. ✅ Set up monitoring alerts\n\nYour EKSU Campus Marketplace is now live! 🎉\n","path":null,"size_bytes":5298,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/pages/product-detail.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useLocation, useParams, Link } from \"wouter\";\nimport { insertProductSchema, type InsertProduct, type Category, type Product } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Upload, X, Loader2, MapPin, Tag, Shield, AlertTriangle } from \"lucide-react\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\n\nconst EKSU_LOCATIONS = [\n  { value: \"school_gate\", label: \"School Gate\" },\n  { value: \"town\", label: \"Town\" },\n  { value: \"yemkem\", label: \"Yemkem\" },\n  { value: \"iworoko\", label: \"Iworoko\" },\n  { value: \"phase2\", label: \"Phase2\" },\n  { value: \"osekita\", label: \"Osekita\" },\n];\n\nexport default function CreateProduct() {\n  const { id } = useParams();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const { user, isVerified, isSeller } = useAuth();\n  const [imageFiles, setImageFiles] = useState<File[]>([]);\n  const [imagePreviews, setImagePreviews] = useState<string[]>([]);\n  const [existingImages, setExistingImages] = useState<string[]>([]);\n  \n  const isEditMode = !!id;\n  \n  // Check if user can create listings (must be verified seller)\n  const canCreateListing = isVerified && isSeller;\n\n  // Fetch categories\n  const { data: categories } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  // Fetch existing product when editing\n  const { data: existingProduct, isLoading: isLoadingProduct } = useQuery<Product>({\n    queryKey: [\"/api/products\", id],\n    enabled: isEditMode,\n  });\n\n  const form = useForm<InsertProduct>({\n    resolver: zodResolver(insertProductSchema),\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      price: \"0\",\n      originalPrice: \"\",\n      isOnSale: false,\n      categoryId: \"\",\n      condition: \"good\",\n      location: \"\",\n      images: [],\n      isAvailable: true,\n      isFeatured: false,\n      isBoosted: false,\n    },\n  });\n\n  // Populate form when editing\n  useEffect(() => {\n    if (existingProduct && isEditMode) {\n      form.reset({\n        title: existingProduct.title,\n        description: existingProduct.description,\n        price: String(existingProduct.price),\n        originalPrice: existingProduct.originalPrice ? String(existingProduct.originalPrice) : \"\",\n        isOnSale: existingProduct.isOnSale ?? false,\n        categoryId: existingProduct.categoryId,\n        condition: existingProduct.condition,\n        location: existingProduct.location || \"\",\n        images: existingProduct.images || [],\n        isAvailable: existingProduct.isAvailable ?? true,\n        isFeatured: existingProduct.isFeatured ?? false,\n        isBoosted: existingProduct.isBoosted ?? false,\n      });\n      // Set existing images for preview\n      if (existingProduct.images && existingProduct.images.length > 0) {\n        setExistingImages(existingProduct.images);\n        setImagePreviews(existingProduct.images);\n      }\n    }\n  }, [existingProduct, isEditMode, form]);\n  \n  const isOnSale = form.watch(\"isOnSale\");\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: InsertProduct) => {\n      const formData = new FormData();\n      \n      // Include existing images that weren't removed, plus any new files\n      const allImages = [...existingImages];\n      formData.append(\"data\", JSON.stringify({ ...data, images: allImages }));\n      imageFiles.forEach((file) => {\n        formData.append(\"images\", file);\n      });\n\n      const url = isEditMode ? `/api/products/${id}` : \"/api/products\";\n      const method = isEditMode ? \"PUT\" : \"POST\";\n\n      const response = await fetch(url, {\n        method,\n        credentials: \"include\",\n        body: formData,\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({ message: `Failed to ${isEditMode ? 'update' : 'create'} listing` }));\n        throw new Error(errorData.message || `Error ${response.status}: Failed to ${isEditMode ? 'update' : 'create'} listing`);\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/products/my-listings\"] });\n      if (isEditMode) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/products\", id] });\n      }\n      toast({\n        title: \"Success\",\n        description: isEditMode ? \"Product updated successfully!\" : \"Product listed successfully!\",\n      });\n      setLocation(\"/seller/dashboard\");\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/auth/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || `Failed to ${isEditMode ? 'update' : 'create'} listing`,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = Array.from(e.target.files || []);\n    if (files.length + imageFiles.length > 10) {\n      toast({\n        title: \"Too many images\",\n        description: \"Maximum 10 images allowed\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setImageFiles([...imageFiles, ...files]);\n    \n    // Create previews\n    files.forEach((file) => {\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setImagePreviews((prev) => [...prev, reader.result as string]);\n      };\n      reader.readAsDataURL(file);\n    });\n  };\n\n  const removeImage = (index: number) => {\n    const preview = imagePreviews[index];\n    \n    // Check if this is an existing image (URL) or a new file preview (base64)\n    if (existingImages.includes(preview)) {\n      // Remove from existing images\n      setExistingImages(prev => prev.filter(img => img !== preview));\n    } else {\n      // Find the corresponding file index (accounting for existing images)\n      const fileIndex = index - existingImages.length;\n      if (fileIndex >= 0) {\n        setImageFiles(imageFiles.filter((_, i) => i !== fileIndex));\n      }\n    }\n    \n    setImagePreviews(imagePreviews.filter((_, i) => i !== index));\n  };\n\n  const onSubmit = (data: InsertProduct) => {\n    const totalImages = existingImages.length + imageFiles.length;\n    if (totalImages === 0) {\n      toast({\n        title: \"Images required\",\n        description: \"Please upload at least one image\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    saveMutation.mutate(data);\n  };\n\n  if (isEditMode && isLoadingProduct) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-3xl\">\n        <Card>\n          <CardHeader>\n            <Skeleton className=\"h-8 w-48\" />\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <Skeleton className=\"h-40 w-full\" />\n            <Skeleton className=\"h-10 w-full\" />\n            <Skeleton className=\"h-24 w-full\" />\n            <Skeleton className=\"h-10 w-full\" />\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  // Show verification required message for non-verified users\n  if (!isEditMode && !canCreateListing) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-3xl\">\n        <Card>\n          <CardHeader className=\"text-center\">\n            <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-yellow-100 dark:bg-yellow-900\">\n              <Shield className=\"h-8 w-8 text-yellow-600\" />\n            </div>\n            <CardTitle>Verification Required</CardTitle>\n            <CardDescription>\n              You need to verify your identity before you can list products for sale\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <Alert>\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertTitle>Why verification?</AlertTitle>\n              <AlertDescription>\n                We verify all sellers to prevent scams and build trust in our marketplace. \n                Verification is quick, easy, and only costs N200.\n              </AlertDescription>\n            </Alert>\n            \n            <div className=\"space-y-2\">\n              <h4 className=\"font-medium\">Benefits of verification:</h4>\n              <ul className=\"list-disc pl-5 text-sm text-muted-foreground space-y-1\">\n                <li>Green verified badge on your profile</li>\n                <li>Ability to list and sell products</li>\n                <li>Higher trust from buyers</li>\n                <li>Access to all seller features</li>\n              </ul>\n            </div>\n            \n            <div className=\"flex flex-col gap-2 pt-4\">\n              <Link href=\"/kyc\">\n                <Button className=\"w-full\" data-testid=\"button-verify-now\">\n                  <Shield className=\"mr-2 h-4 w-4\" />\n                  Verify Now - N200\n                </Button>\n              </Link>\n              <Link href=\"/\">\n                <Button variant=\"outline\" className=\"w-full\">\n                  Go Back to Marketplace\n                </Button>\n              </Link>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 max-w-3xl\">\n      <Card>\n        <CardHeader>\n          <CardTitle>{isEditMode ? \"Edit Listing\" : \"Create New Listing\"}</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n              {/* Image Upload */}\n              <div>\n                <FormLabel>Product Images</FormLabel>\n                <div className=\"mt-2 grid grid-cols-2 sm:grid-cols-3 gap-4\">\n                  {imagePreviews.map((preview, index) => (\n                    <div key={index} className=\"relative aspect-square\">\n                      <img\n                        src={preview}\n                        alt={`Preview ${index + 1}`}\n                        className=\"w-full h-full object-cover rounded-md\"\n                        loading=\"lazy\"\n                      />\n                      <Button\n                        type=\"button\"\n                        variant=\"destructive\"\n                        size=\"icon\"\n                        className=\"absolute top-1 right-1 h-6 w-6\"\n                        onClick={() => removeImage(index)}\n                      >\n                        <X className=\"h-3 w-3\" />\n                      </Button>\n                    </div>\n                  ))}\n                  {imageFiles.length < 10 && (\n                    <label className=\"aspect-square border-2 border-dashed border-muted-foreground/25 rounded-md flex flex-col items-center justify-center cursor-pointer hover-elevate\">\n                      <Upload className=\"h-8 w-8 text-muted-foreground\" />\n                      <span className=\"mt-2 text-sm text-muted-foreground\">Upload</span>\n                      <input\n                        type=\"file\"\n                        accept=\"image/*\"\n                        multiple\n                        className=\"hidden\"\n                        onChange={handleImageUpload}\n                        data-testid=\"input-product-images\"\n                      />\n                    </label>\n                  )}\n                </div>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  Upload up to 10 images. First image will be the cover.\n                </p>\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"title\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Title</FormLabel>\n                    <FormControl>\n                      <Input placeholder=\"e.g., iPhone 13 Pro Max 256GB\" {...field} data-testid=\"input-product-title\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description</FormLabel>\n                    <FormControl>\n                      <Textarea\n                        placeholder=\"Describe your item in detail...\"\n                        rows={5}\n                        {...field}\n                        data-testid=\"input-product-description\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              {/* Sale Price Section */}\n              <div className=\"border rounded-md p-4 space-y-4 bg-muted/30\">\n                <FormField\n                  control={form.control}\n                  name=\"isOnSale\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex flex-row items-center justify-between\">\n                      <div className=\"space-y-0.5\">\n                        <FormLabel className=\"flex items-center gap-2\">\n                          <Tag className=\"h-4 w-4\" />\n                          Put on Sale\n                        </FormLabel>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Show a discount badge and strikethrough original price\n                        </p>\n                      </div>\n                      <FormControl>\n                        <Switch\n                          checked={field.value}\n                          onCheckedChange={field.onChange}\n                          data-testid=\"switch-on-sale\"\n                        />\n                      </FormControl>\n                    </FormItem>\n                  )}\n                />\n\n                {isOnSale && (\n                  <FormField\n                    control={form.control}\n                    name=\"originalPrice\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Original Price (₦) - Before Discount</FormLabel>\n                        <FormControl>\n                          <Input\n                            type=\"number\"\n                            placeholder=\"Enter original price before discount\"\n                            {...field}\n                            value={field.value || \"\"}\n                            data-testid=\"input-original-price\"\n                          />\n                        </FormControl>\n                        <p className=\"text-xs text-muted-foreground\">\n                          This will be shown with a strikethrough next to the sale price\n                        </p>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                )}\n              </div>\n\n              <div className=\"grid gap-6 sm:grid-cols-2\">\n                <FormField\n                  control={form.control}\n                  name=\"price\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>{isOnSale ? \"Sale Price (₦)\" : \"Price (₦)\"}</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"number\"\n                          placeholder=\"0\"\n                          {...field}\n                          data-testid=\"input-product-price\"\n                        />\n                      </FormControl>\n                      {isOnSale && (\n                        <p className=\"text-xs text-muted-foreground\">\n                          This is the discounted price customers will pay\n                        </p>\n                      )}\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"categoryId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Category</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-product-category\">\n                            <SelectValue placeholder=\"Select category\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {categories?.map((cat) => (\n                            <SelectItem key={cat.id} value={cat.id}>\n                              {cat.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"condition\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Condition</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-product-condition\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"new\">New</SelectItem>\n                          <SelectItem value=\"like_new\">Like New</SelectItem>\n                          <SelectItem value=\"good\">Good</SelectItem>\n                          <SelectItem value=\"fair\">Fair</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"location\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"flex items-center gap-1\">\n                        <MapPin className=\"h-4 w-4\" />\n                        Campus Location\n                      </FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-product-location\">\n                            <SelectValue placeholder=\"Select your location\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {EKSU_LOCATIONS.map((loc) => (\n                            <SelectItem key={loc.value} value={loc.value}>\n                              {loc.label}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"flex gap-4\">\n                <Button\n                  type=\"submit\"\n                  disabled={saveMutation.isPending}\n                  className=\"flex-1\"\n                  data-testid=\"button-submit-product\"\n                >\n                  {saveMutation.isPending && (\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  )}\n                  {isEditMode ? \"Update Listing\" : \"Create Listing\"}\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setLocation(\"/seller/dashboard\")}\n                  data-testid=\"button-cancel\"\n                >\n                  Cancel\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":21192,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"scripts/seed-system-account.ts":{"content":"import { db, pool } from \"../server/db\";\nimport { users, wallets } from \"@shared/schema\";\nimport bcrypt from \"bcryptjs\";\nimport crypto from \"crypto\";\nimport { eq } from \"drizzle-orm\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nconst SYSTEM_ACCOUNT_EMAIL = \"system@eksuplug.com\";\nconst SYSTEM_ACCOUNT_FIRST_NAME = \"Campus\";\nconst SYSTEM_ACCOUNT_LAST_NAME = \"Hub\";\nconst SYSTEM_ACCOUNT_BIO = \"Official EKSU Marketplace System Account. Stay updated with announcements, safety tips, and community updates. This is an automated account - replies may not be monitored.\";\n\nfunction generateSecurePassword(): string {\n  const uppercase = 'ABCDEFGHJKLMNPQRSTUVWXYZ';\n  const lowercase = 'abcdefghjkmnpqrstuvwxyz';\n  const numbers = '23456789';\n  const special = '!@#$%^&*';\n  \n  let password = '';\n  password += uppercase[Math.floor(Math.random() * uppercase.length)];\n  password += lowercase[Math.floor(Math.random() * lowercase.length)];\n  password += numbers[Math.floor(Math.random() * numbers.length)];\n  password += special[Math.floor(Math.random() * special.length)];\n  \n  const allChars = uppercase + lowercase + numbers + special;\n  for (let i = 0; i < 12; i++) {\n    password += allChars[Math.floor(Math.random() * allChars.length)];\n  }\n  \n  return password.split('').sort(() => Math.random() - 0.5).join('');\n}\n\nfunction generateReferralCode(): string {\n  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';\n  let code = '';\n  for (let i = 0; i < 8; i++) {\n    code += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return code;\n}\n\nasync function seedSystemAccount() {\n  console.log(\"Seeding system account for EKSU Marketplace...\");\n  \n  try {\n    const existingUser = await db\n      .select()\n      .from(users)\n      .where(eq(users.email, SYSTEM_ACCOUNT_EMAIL))\n      .limit(1);\n    \n    if (existingUser.length > 0) {\n      console.log(\"System account already exists!\");\n      console.log(\"System Account ID:\", existingUser[0].id);\n      console.log(\"Email:\", existingUser[0].email);\n      console.log(\"\\nTo update SYSTEM_USER_ID in your environment:\");\n      console.log(`SYSTEM_USER_ID=${existingUser[0].id}`);\n      return existingUser[0];\n    }\n    \n    const plainPassword = generateSecurePassword();\n    const hashedPassword = await bcrypt.hash(plainPassword, 12);\n    const referralCode = generateReferralCode();\n    \n    const [systemUser] = await db\n      .insert(users)\n      .values({\n        email: SYSTEM_ACCOUNT_EMAIL,\n        password: hashedPassword,\n        firstName: SYSTEM_ACCOUNT_FIRST_NAME,\n        lastName: SYSTEM_ACCOUNT_LAST_NAME,\n        bio: SYSTEM_ACCOUNT_BIO,\n        role: \"admin\",\n        referralCode: referralCode,\n        isVerified: true,\n        verificationBadges: [\"email\", \"phone\", \"student_id\"],\n        isTrustedSeller: true,\n        trustScore: \"5.0\",\n        totalRatings: 0,\n        isActive: true,\n        isBanned: false,\n      })\n      .returning();\n    \n    console.log(\"System account created successfully!\");\n    console.log(\"System Account ID:\", systemUser.id);\n    console.log(\"Email:\", systemUser.email);\n    \n    await db\n      .insert(wallets)\n      .values({\n        userId: systemUser.id,\n        balance: \"0.00\",\n        escrowBalance: \"0.00\",\n        securityDepositLocked: \"0.00\",\n      })\n      .onConflictDoNothing();\n    \n    console.log(\"Wallet created for system account.\");\n    \n    const credentialsContent = `# EKSU Marketplace System Account Credentials\n# =============================================\n# IMPORTANT: Keep this file secure and do not commit to version control\n# Generated: ${new Date().toISOString()}\n\n## Account Details\n- **Account ID:** ${systemUser.id}\n- **Email:** ${SYSTEM_ACCOUNT_EMAIL}\n- **Password:** ${plainPassword}\n- **Role:** admin\n- **Display Name:** ${SYSTEM_ACCOUNT_FIRST_NAME} ${SYSTEM_ACCOUNT_LAST_NAME}\n\n## Environment Variable\nAdd this to your environment:\n\\`\\`\\`\nSYSTEM_USER_ID=${systemUser.id}\n\\`\\`\\`\n\n## Purpose\nThis account is used for:\n1. Sending welcome messages to new users\n2. Posting official announcements in \"The Plug\" social feed\n3. System notifications and updates\n4. Auto-followed by all new users\n\n## Security Notes\n- This is an admin account with elevated privileges\n- Change the password after first login if needed\n- Regular users cannot follow back or message this account\n- Keep this file in a secure location\n`;\n    \n    const credentialsPath = path.join(process.cwd(), \"SYSTEM_ACCOUNT_CREDENTIALS.md\");\n    fs.writeFileSync(credentialsPath, credentialsContent);\n    console.log(`\\nCredentials saved to: ${credentialsPath}`);\n    \n    console.log(\"\\n=== IMPORTANT: SET THIS ENVIRONMENT VARIABLE ===\");\n    console.log(`SYSTEM_USER_ID=${systemUser.id}`);\n    console.log(\"================================================\\n\");\n    \n    return systemUser;\n  } catch (error) {\n    console.error(\"Error seeding system account:\", error);\n    throw error;\n  } finally {\n    await pool.end();\n  }\n}\n\nseedSystemAccount()\n  .then(() => {\n    console.log(\"System account seeding completed!\");\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(\"Failed to seed system account:\", error);\n    process.exit(1);\n  });\n","path":null,"size_bytes":5165,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/pages/my-ads.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Link } from \"wouter\";\nimport {\n  Plus,\n  Megaphone,\n  Eye,\n  Edit,\n  Trash2,\n  MoreVertical,\n  TrendingUp,\n  Clock,\n  CheckCircle,\n  XCircle,\n  Pause,\n  Play,\n  ShoppingBag,\n  Zap,\n  MessageSquare,\n  Rocket,\n  Package,\n} from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport type { Product } from \"@shared/schema\";\n\ntype ProductWithAnalytics = Product & { inquiryCount: number };\n\nexport default function MyAdsPage() {\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"all\");\n  const [showBoostDialog, setShowBoostDialog] = useState(false);\n  const [selectedProduct, setSelectedProduct] = useState<ProductWithAnalytics | null>(null);\n\n  const { data: products, isLoading } = useQuery<ProductWithAnalytics[]>({\n    queryKey: [\"/api/seller/products\"],\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"DELETE\", `/api/products/${id}`);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/seller/products\"] });\n      toast({\n        title: \"Product deleted\",\n        description: \"Your listing has been removed.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to delete\",\n        description: error.message || \"Unable to delete listing\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const toggleVisibilityMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"POST\", `/api/products/${id}/toggle-visibility`);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/seller/products\"] });\n      toast({\n        title: data.isAvailable ? \"Listing activated\" : \"Listing paused\",\n        description: data.isAvailable \n          ? \"Your listing is now visible to buyers.\"\n          : \"Your listing is now hidden from buyers.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to update\",\n        description: error.message || \"Unable to update listing\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const markAsSoldMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"POST\", `/api/products/${id}/sold`);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/seller/products\"] });\n      toast({\n        title: \"Marked as sold\",\n        description: \"Your listing has been marked as sold.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to mark as sold\",\n        description: error.message || \"Unable to mark as sold\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const boostMutation = useMutation({\n    mutationFn: async ({ productId, boostType }: { productId: string; boostType: string }) => {\n      const response = await apiRequest(\"POST\", `/api/boosts`, { productId, boostType });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/seller/products\"] });\n      setShowBoostDialog(false);\n      setSelectedProduct(null);\n      toast({\n        title: \"Boost requested\",\n        description: \"Your boost request has been submitted for approval.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to boost\",\n        description: error.message || \"Unable to boost listing\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const allProducts = products || [];\n  const activeProducts = allProducts.filter(p => p.isAvailable && p.isApproved && !p.isSold && !p.isFlagged);\n  const soldProducts = allProducts.filter(p => p.isSold);\n  const pendingProducts = allProducts.filter(p => !p.isApproved && !p.isFlagged);\n  const boostedProducts = allProducts.filter(p => p.isBoosted && !p.isSold);\n\n  const getFilteredProducts = () => {\n    switch (activeTab) {\n      case \"active\":\n        return activeProducts;\n      case \"sold\":\n        return soldProducts;\n      case \"pending\":\n        return pendingProducts;\n      case \"boosted\":\n        return boostedProducts;\n      default:\n        return allProducts;\n    }\n  };\n\n  const filteredProducts = getFilteredProducts();\n\n  const getStatusBadge = (product: ProductWithAnalytics) => {\n    if (product.isSold) {\n      return (\n        <Badge className=\"absolute top-2 left-2 bg-green-500\" data-testid={`badge-sold-${product.id}`}>\n          <CheckCircle className=\"h-3 w-3 mr-1\" />\n          Sold\n        </Badge>\n      );\n    }\n    if (product.isBoosted) {\n      return (\n        <Badge className=\"absolute top-2 left-2 bg-orange-500\" data-testid={`badge-boosted-${product.id}`}>\n          <TrendingUp className=\"h-3 w-3 mr-1\" />\n          Boosted\n        </Badge>\n      );\n    }\n    if (!product.isApproved && !product.isFlagged) {\n      return (\n        <Badge variant=\"secondary\" className=\"absolute top-2 left-2\" data-testid={`badge-pending-${product.id}`}>\n          <Clock className=\"h-3 w-3 mr-1\" />\n          Pending\n        </Badge>\n      );\n    }\n    if (product.isFlagged) {\n      return (\n        <Badge variant=\"destructive\" className=\"absolute top-2 left-2\" data-testid={`badge-flagged-${product.id}`}>\n          <XCircle className=\"h-3 w-3 mr-1\" />\n          Flagged\n        </Badge>\n      );\n    }\n    if (!product.isAvailable) {\n      return (\n        <Badge variant=\"outline\" className=\"absolute top-2 left-2 bg-background/80\" data-testid={`badge-paused-${product.id}`}>\n          <Pause className=\"h-3 w-3 mr-1\" />\n          Paused\n        </Badge>\n      );\n    }\n    return null;\n  };\n\n  const handleBoostClick = (product: ProductWithAnalytics) => {\n    setSelectedProduct(product);\n    setShowBoostDialog(true);\n  };\n\n  const ProductCard = ({ product }: { product: ProductWithAnalytics }) => {\n    const imageUrl = product.images?.[0] || \"/placeholder.svg\";\n    const canBoost = product.isApproved && !product.isSold && !product.isBoosted;\n    const canMarkSold = product.isApproved && !product.isSold;\n    const canToggleVisibility = !product.isSold;\n    \n    return (\n      <Card className=\"overflow-hidden\" data-testid={`card-product-${product.id}`}>\n        <div className=\"aspect-square relative\">\n          <img\n            src={imageUrl.startsWith(\"/uploads\") ? imageUrl : imageUrl}\n            alt={product.title}\n            className=\"object-cover w-full h-full\"\n            loading=\"lazy\"\n            data-testid={`img-product-${product.id}`}\n          />\n          {getStatusBadge(product)}\n        </div>\n        <CardContent className=\"p-3\">\n          <h3 className=\"font-medium truncate mb-1\" data-testid={`text-title-${product.id}`}>{product.title}</h3>\n          <p className=\"text-lg font-bold mb-2\" data-testid={`text-price-${product.id}`}>\n            ₦{parseFloat(product.price).toLocaleString()}\n          </p>\n          \n          <div className=\"flex items-center justify-between gap-2 text-sm text-muted-foreground mb-3\">\n            <span className=\"flex items-center gap-1\" data-testid={`text-views-${product.id}`}>\n              <Eye className=\"h-4 w-4\" />\n              {product.views || 0}\n            </span>\n            <span className=\"flex items-center gap-1\" data-testid={`text-inquiries-${product.id}`}>\n              <MessageSquare className=\"h-4 w-4\" />\n              {product.inquiryCount || product.inquiries || 0}\n            </span>\n            <Badge variant=\"outline\" className=\"text-xs\" data-testid={`badge-condition-${product.id}`}>\n              {product.condition}\n            </Badge>\n          </div>\n          \n          <div className=\"flex items-center gap-2\">\n            <Button variant=\"outline\" size=\"sm\" className=\"flex-1\" asChild data-testid={`button-edit-${product.id}`}>\n              <Link href={`/products/${product.id}/edit`}>\n                <Edit className=\"h-4 w-4 mr-1\" />\n                Edit\n              </Link>\n            </Button>\n            \n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"ghost\" size=\"icon\" data-testid={`button-menu-${product.id}`}>\n                  <MoreVertical className=\"h-4 w-4\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                <DropdownMenuItem asChild data-testid={`menu-view-${product.id}`}>\n                  <Link href={`/products/${product.id}`}>\n                    <Eye className=\"h-4 w-4 mr-2\" />\n                    View Listing\n                  </Link>\n                </DropdownMenuItem>\n                \n                {canToggleVisibility && (\n                  <DropdownMenuItem\n                    onClick={() => toggleVisibilityMutation.mutate(product.id)}\n                    disabled={toggleVisibilityMutation.isPending}\n                    data-testid={`menu-toggle-${product.id}`}\n                  >\n                    {product.isAvailable ? (\n                      <>\n                        <Pause className=\"h-4 w-4 mr-2\" />\n                        Pause Listing\n                      </>\n                    ) : (\n                      <>\n                        <Play className=\"h-4 w-4 mr-2\" />\n                        Activate Listing\n                      </>\n                    )}\n                  </DropdownMenuItem>\n                )}\n                \n                {canBoost && (\n                  <DropdownMenuItem\n                    onClick={() => handleBoostClick(product)}\n                    data-testid={`menu-boost-${product.id}`}\n                  >\n                    <Rocket className=\"h-4 w-4 mr-2\" />\n                    Boost Listing\n                  </DropdownMenuItem>\n                )}\n                \n                {canMarkSold && (\n                  <>\n                    <DropdownMenuSeparator />\n                    <DropdownMenuItem\n                      onClick={() => markAsSoldMutation.mutate(product.id)}\n                      disabled={markAsSoldMutation.isPending}\n                      className=\"text-green-600\"\n                      data-testid={`menu-sold-${product.id}`}\n                    >\n                      <ShoppingBag className=\"h-4 w-4 mr-2\" />\n                      Mark as Sold\n                    </DropdownMenuItem>\n                  </>\n                )}\n                \n                <DropdownMenuSeparator />\n                \n                <AlertDialog>\n                  <AlertDialogTrigger asChild>\n                    <DropdownMenuItem\n                      onSelect={(e) => e.preventDefault()}\n                      className=\"text-destructive\"\n                      data-testid={`menu-delete-${product.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4 mr-2\" />\n                      Delete Listing\n                    </DropdownMenuItem>\n                  </AlertDialogTrigger>\n                  <AlertDialogContent>\n                    <AlertDialogHeader>\n                      <AlertDialogTitle>Delete this listing?</AlertDialogTitle>\n                      <AlertDialogDescription>\n                        This action cannot be undone. This will permanently delete your\n                        listing and remove it from the marketplace.\n                      </AlertDialogDescription>\n                    </AlertDialogHeader>\n                    <AlertDialogFooter>\n                      <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancel</AlertDialogCancel>\n                      <AlertDialogAction\n                        onClick={() => deleteMutation.mutate(product.id)}\n                        className=\"bg-destructive text-destructive-foreground\"\n                        data-testid=\"button-confirm-delete\"\n                      >\n                        Delete\n                      </AlertDialogAction>\n                    </AlertDialogFooter>\n                  </AlertDialogContent>\n                </AlertDialog>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  };\n\n  const ProductCardSkeleton = () => (\n    <Card className=\"overflow-hidden\">\n      <Skeleton className=\"aspect-square\" />\n      <CardContent className=\"p-3\">\n        <Skeleton className=\"h-5 w-3/4 mb-1\" />\n        <Skeleton className=\"h-6 w-1/2 mb-2\" />\n        <div className=\"flex items-center justify-between gap-2 mb-3\">\n          <Skeleton className=\"h-4 w-16\" />\n          <Skeleton className=\"h-4 w-16\" />\n          <Skeleton className=\"h-5 w-12\" />\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Skeleton className=\"h-8 flex-1\" />\n          <Skeleton className=\"h-8 w-8\" />\n        </div>\n      </CardContent>\n    </Card>\n  );\n\n  const EmptyState = () => {\n    const getEmptyStateContent = () => {\n      switch (activeTab) {\n        case \"active\":\n          return {\n            icon: <Package className=\"h-10 w-10 text-muted-foreground\" />,\n            title: \"No Active Listings\",\n            description: \"You don't have any active listings. Create a new ad to start selling.\",\n          };\n        case \"sold\":\n          return {\n            icon: <ShoppingBag className=\"h-10 w-10 text-green-500\" />,\n            title: \"No Sold Items\",\n            description: \"Items you mark as sold will appear here.\",\n          };\n        case \"pending\":\n          return {\n            icon: <Clock className=\"h-10 w-10 text-yellow-500\" />,\n            title: \"No Pending Listings\",\n            description: \"Listings awaiting approval will appear here.\",\n          };\n        case \"boosted\":\n          return {\n            icon: <Rocket className=\"h-10 w-10 text-orange-500\" />,\n            title: \"No Boosted Listings\",\n            description: \"Boost your listings to get more visibility.\",\n          };\n        default:\n          return {\n            icon: <Megaphone className=\"h-10 w-10 text-orange-500\" />,\n            title: \"No Ads Yet\",\n            description: \"Add products for customers to buy from you.\",\n          };\n      }\n    };\n\n    const content = getEmptyStateContent();\n\n    return (\n      <Card data-testid=\"empty-state\">\n        <CardContent className=\"py-12 text-center\">\n          <div className=\"rounded-full bg-muted p-4 w-20 h-20 mx-auto mb-4 flex items-center justify-center\">\n            {content.icon}\n          </div>\n          <h3 className=\"text-lg font-medium mb-2\" data-testid=\"text-empty-title\">{content.title}</h3>\n          <p className=\"text-muted-foreground mb-4\" data-testid=\"text-empty-description\">\n            {content.description}\n          </p>\n          <Button asChild data-testid=\"button-empty-cta\">\n            <Link href=\"/products/new\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Create New Ad\n            </Link>\n          </Button>\n        </CardContent>\n      </Card>\n    );\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"flex flex-wrap items-center justify-between gap-4 mb-6\">\n          <div>\n            <Skeleton className=\"h-8 w-32 mb-2\" />\n            <Skeleton className=\"h-5 w-48\" />\n          </div>\n          <Skeleton className=\"h-10 w-32\" />\n        </div>\n        <Skeleton className=\"h-10 w-full mb-6\" />\n        <div className=\"grid gap-4 grid-cols-2 md:grid-cols-3 lg:grid-cols-4\">\n          {[...Array(8)].map((_, i) => (\n            <ProductCardSkeleton key={i} />\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <div className=\"flex flex-wrap items-center justify-between gap-4 mb-6\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">My Ads</h1>\n          <p className=\"text-muted-foreground\" data-testid=\"text-page-subtitle\">\n            Manage your product listings ({allProducts.length} total)\n          </p>\n        </div>\n        <Button asChild data-testid=\"button-create-ad\">\n          <Link href=\"/products/new\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Create New Ad\n          </Link>\n        </Button>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"mb-6\">\n        <TabsList className=\"grid w-full grid-cols-5\">\n          <TabsTrigger value=\"all\" data-testid=\"tab-all\">\n            All ({allProducts.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"active\" data-testid=\"tab-active\">\n            Active ({activeProducts.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"sold\" data-testid=\"tab-sold\">\n            Sold ({soldProducts.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"pending\" data-testid=\"tab-pending\">\n            Pending ({pendingProducts.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"boosted\" data-testid=\"tab-boosted\">\n            Boosted ({boostedProducts.length})\n          </TabsTrigger>\n        </TabsList>\n      </Tabs>\n\n      {filteredProducts.length > 0 ? (\n        <div className=\"grid gap-4 grid-cols-2 md:grid-cols-3 lg:grid-cols-4\">\n          {filteredProducts.map((product) => (\n            <ProductCard key={product.id} product={product} />\n          ))}\n        </div>\n      ) : (\n        <EmptyState />\n      )}\n\n      <Dialog open={showBoostDialog} onOpenChange={setShowBoostDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle data-testid=\"dialog-boost-title\">Boost Your Listing</DialogTitle>\n            <DialogDescription data-testid=\"dialog-boost-description\">\n              Get more visibility for \"{selectedProduct?.title}\" by boosting it to the top of search results.\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div \n              className=\"border rounded-md p-4 cursor-pointer hover-elevate\"\n              onClick={() => selectedProduct && boostMutation.mutate({ productId: selectedProduct.id, boostType: \"basic\" })}\n              data-testid=\"boost-option-basic\"\n            >\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"rounded-full bg-blue-100 dark:bg-blue-900 p-2\">\n                    <Zap className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n                  </div>\n                  <div>\n                    <h4 className=\"font-medium\">Basic Boost</h4>\n                    <p className=\"text-sm text-muted-foreground\">24 hours visibility boost</p>\n                  </div>\n                </div>\n                <div className=\"text-right\">\n                  <p className=\"font-bold\">₦500</p>\n                </div>\n              </div>\n            </div>\n            \n            <div \n              className=\"border rounded-md p-4 cursor-pointer hover-elevate\"\n              onClick={() => selectedProduct && boostMutation.mutate({ productId: selectedProduct.id, boostType: \"premium\" })}\n              data-testid=\"boost-option-premium\"\n            >\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"rounded-full bg-orange-100 dark:bg-orange-900 p-2\">\n                    <Rocket className=\"h-5 w-5 text-orange-600 dark:text-orange-400\" />\n                  </div>\n                  <div>\n                    <h4 className=\"font-medium\">Premium Boost</h4>\n                    <p className=\"text-sm text-muted-foreground\">7 days visibility + featured badge</p>\n                  </div>\n                </div>\n                <div className=\"text-right\">\n                  <p className=\"font-bold\">₦2,000</p>\n                </div>\n              </div>\n            </div>\n            \n            <div \n              className=\"border rounded-md p-4 cursor-pointer hover-elevate border-orange-500\"\n              onClick={() => selectedProduct && boostMutation.mutate({ productId: selectedProduct.id, boostType: \"super\" })}\n              data-testid=\"boost-option-super\"\n            >\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"rounded-full bg-gradient-to-br from-orange-400 to-pink-500 p-2\">\n                    <TrendingUp className=\"h-5 w-5 text-white\" />\n                  </div>\n                  <div>\n                    <h4 className=\"font-medium\">Super Boost</h4>\n                    <p className=\"text-sm text-muted-foreground\">30 days + homepage spotlight</p>\n                  </div>\n                </div>\n                <div className=\"text-right\">\n                  <p className=\"font-bold\">₦5,000</p>\n                  <Badge variant=\"secondary\">Best Value</Badge>\n                </div>\n              </div>\n            </div>\n          </div>\n          \n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowBoostDialog(false)} data-testid=\"button-cancel-boost\">\n              Cancel\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":22258,"size_tokens":null},"client/src/components/games/index.ts":{"content":"export { default as LudoGame } from \"./LudoGame\";\nexport { default as WordBattleGame } from \"./WordBattleGame\";\nexport { default as TriviaGame } from \"./TriviaGame\";\nexport { default as SpeedTypingGame } from \"./SpeedTypingGame\";\nexport { default as WhotGame } from \"./WhotGame\";\nexport { default as TruthOrDareGame } from \"./TruthOrDareGame\";\nexport { default as GuessThePriceGame } from \"./GuessThePriceGame\";\nexport { default as QuickDrawGame } from \"./QuickDrawGame\";\nexport { default as CampusBingoGame } from \"./CampusBingoGame\";\nexport { default as AviatorGame } from \"./AviatorGame\";\nexport { default as ColourColourGame } from \"./ColourColourGame\";\nexport { default as SpinWheelGame } from \"./SpinWheelGame\";\nexport { default as AyoOloponGame } from \"./AyoOloponGame\";\n","path":null,"size_bytes":778,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"README.md":{"content":"# EKSU Campus Marketplace\n\nA comprehensive peer-to-peer marketplace built specifically for EKSU students to buy and sell items, find hostels, connect with services, and more.\n\n## Features\n\n- **Student Verification**: NIN-based identity verification with selfie matching\n- **Secure Payments**: Squad (by Habari/GTBank) payment gateway with multiple channels (Card, Bank Transfer, USSD)\n- **Smart Wallet System**: Deposit, withdraw, track balances with escrow protection\n- **Real-Time Chat**: WebSocket messaging with image & voice note support\n- **Referral Rewards**: Earn bonuses when referred users make purchases\n- **Login Streak Rewards**: Daily login bonuses\n- **Welcome Bonus**: Random welcome bonus for new users\n- **Hostel Rentals**: Connect tenants with agents, platform takes commission\n- **Account Selling**: Safe marketplace for digital accounts with fraud prevention\n- **Event Posting**: Promote concerts, parties, campus events\n- **Trust System**: Verified seller badges, ratings, leaderboards\n- **Admin Dashboard**: Manual verification, dispute resolution, user management\n\n---\n\n## Environment Variables Setup\n\nThis app requires several environment variables to work properly.\n\n### Required Variables\n\n```bash\n# Database (Auto-configured by Replit)\nDATABASE_URL=your_postgresql_connection_string\n\n# Session Security\nSESSION_SECRET=your_random_32_char_string_here\n\n# Squad Payment Gateway (by Habari/GTBank)\nSQUAD_SECRET_KEY=sk_live_your_secret_key_here\nSQUAD_PUBLIC_KEY=pk_live_your_public_key_here\n```\n\n---\n\n### Squad Payment Gateway Setup\n\n#### Get Your Squad API Keys\n\n1. Create a free account at https://squadco.com\n2. Complete your business verification\n3. Go to Settings -> API Keys\n4. Copy your **Secret Key** and **Public Key**\n\n**For Testing (Sandbox):**\n- Use sandbox keys that start with `sandbox_sk_` and `sandbox_pk_`\n- Create sandbox account at https://sandbox.squadco.com\n\n**For Production (Live):**\n- Use live keys (start with regular prefixes)\n- Base URL automatically switches to production mode\n\n**Example Configuration:**\n```bash\n# Sandbox/Testing\nSQUAD_SECRET_KEY=sandbox_sk_1234567890abcdefghijklmnopqrstuvwxyz\nSQUAD_PUBLIC_KEY=sandbox_pk_abcdefghijklmnopqrstuvwxyz1234567890\n\n# Production\nSQUAD_SECRET_KEY=sk_1234567890abcdefghijklmnopqrstuvwxyz\nSQUAD_PUBLIC_KEY=pk_abcdefghijklmnopqrstuvwxyz1234567890\n```\n\n---\n\n### Optional: NIN Verification\n\nFor identity verification, you need either Korapay or Dojah:\n\n**Option A: Korapay (Recommended)**\n```bash\nKORAPAY_API_KEY=your_korapay_api_key_here\n```\n- Sign up at https://korapay.com\n- Cost: ~N20-30 per verification\n\n**Option B: Dojah**\n```bash\nDOJAH_API_KEY=your_dojah_api_key_here\n```\n- Sign up at https://dojah.io\n- Similar pricing to Korapay\n\n---\n\n## Complete Environment Variables Checklist\n\n```bash\n# CRITICAL - Must have these\nSESSION_SECRET=your_random_32_char_string_here\nDATABASE_URL=postgresql://user:pass@host:port/db\n\n# Squad Payment Gateway\nSQUAD_SECRET_KEY=your_squad_secret_key\nSQUAD_PUBLIC_KEY=your_squad_public_key\n\n# NIN Verification (Choose one)\nKORAPAY_API_KEY=your_korapay_key\n# OR\nDOJAH_API_KEY=your_dojah_key\n\n# Optional\nNODE_ENV=production\nFRONTEND_URL=https://your-app-domain.com\n```\n\n---\n\n## How to Set Environment Variables\n\n### In Replit:\n1. Click on \"Secrets\" (lock icon) in left sidebar\n2. Add key-value pairs\n3. These are automatically loaded as environment variables\n\n### In Railway:\n1. Open your project\n2. Click on your deployment\n3. Go to \"Variables\" tab\n4. Click \"New Variable\" for each one\n5. Add name and value\n6. Railway will auto-redeploy with new variables\n\n---\n\n## Payment Features\n\n### Supported Payment Methods (via Squad)\n- **Card**: Visa, Mastercard, Verve\n- **Bank Transfer**: Direct transfer to virtual account\n- **USSD**: Works with major Nigerian banks\n- **Direct Debit**: For recurring payments\n\n### Payment Flow\n1. User initiates deposit from wallet\n2. Backend creates Squad payment request\n3. User is redirected to Squad checkout page\n4. Payment is processed via chosen method\n5. Webhook confirms payment to backend\n6. User wallet is credited automatically\n\n### Withdrawals\n1. User requests withdrawal from wallet\n2. Bank account is verified via Squad API\n3. Transfer is initiated to user's bank\n4. Funds arrive in 1-24 hours (depending on bank)\n\n---\n\n## Cost Breakdown\n\n### Free Services:\n- **Hosting**: Replit (development) / Railway (production)\n- **Database**: PostgreSQL (included with hosting)\n- **Squad**: Free account, pay per transaction\n\n### Transaction Fees:\n- **Squad Gateway**: ~1.5% per transaction (capped at N2,000)\n- **Transfer API**: 0.1% per transfer or flat fee\n\n### Paid Services:\n- **NIN Verification**: N20-30 per verification\n\n---\n\n## Project Structure\n\n```\n├── client/              # React frontend\n│   ├── src/\n│   │   ├── pages/      # Route pages\n│   │   ├── components/ # Reusable components\n│   │   └── lib/        # Utilities\n├── server/             # Express backend\n│   ├── index.ts        # Server entry\n│   ├── routes.ts       # API routes\n│   ├── storage.ts      # Database interface\n│   ├── squad.ts        # Squad payment integration\n│   └── replitAuth.ts   # Authentication\n├── shared/             # Shared types & schemas\n│   └── schema.ts       # Database schema & Zod schemas\n└── uploads/            # User uploaded images\n```\n\n---\n\n## Squad API Integration\n\nThe platform uses Squad (by Habari/GTBank) as the sole payment provider.\n\n### Key Endpoints Used:\n- `POST /transaction/initiate` - Initialize payment\n- `GET /transaction/verify/:ref` - Verify transaction\n- `POST /payout/account/lookup` - Verify bank account\n- `POST /payout/transfer` - Initiate withdrawal\n- `GET /payout/banks/all` - Get list of banks\n\n### Webhook Setup:\nConfigure your Squad webhook URL to:\n```\nhttps://your-domain.com/api/squad/webhook\n```\n\n---\n\n## Security & Legal Compliance\n\n### NIN Data Protection (IMPORTANT)\nYou CANNOT store raw 11-digit NIN numbers (illegal under Nigerian law since Dec 2021)\n\n**What you CAN do:**\n- Store verification results (verified: true/false)\n- Store confidence scores from selfie matching\n- Store user consent records\n\n**What you CANNOT do:**\n- Store the actual NIN number\n- Share NIN data with third parties\n- Use NIN for purposes other than verification\n\n### NDPR Compliance\nYour app must comply with Nigeria Data Protection Regulation:\n- Privacy Policy page (required)\n- User consent for data collection\n- Terms & Conditions\n- Dispute resolution process\n\n---\n\n## Quick Start Guide\n\n1. **Clone and Install**:\n   ```bash\n   git clone <your-repo>\n   cd eksu-marketplace\n   npm install\n   ```\n\n2. **Set Up Environment**:\n   - Add required environment variables to Replit Secrets or `.env` file\n\n3. **Run Database Migration**:\n   ```bash\n   npm run db:push\n   ```\n\n4. **Start Development Server**:\n   ```bash\n   npm run dev\n   ```\n\n5. **Open in Browser**:\n   - App runs on `http://localhost:5000`\n\n---\n\n## Testing Payment Integration\n\n### Squad Test Mode:\n1. Use sandbox keys (start with `sandbox_sk_`)\n2. Test cards work in sandbox mode\n3. No real money is charged\n\n### Test Cards (Sandbox):\n```\nSuccess: 4242 4242 4242 4242\nAny CVV: 123\nAny future expiry: 12/30\n```\n\n---\n\n## Support\n\nIf you encounter issues:\n1. Check that all environment variables are set correctly\n2. Verify your Squad account is properly configured\n3. Make sure DATABASE_URL is accessible\n4. Check server logs for error details\n\n---\n\n## License\n\nMIT License - Feel free to modify and use for your campus marketplace!\n\n---\n\n**Built for EKSU students, by students. Trade safely, study hard!**\n","path":null,"size_bytes":7661,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"server/app.ts":{"content":"import { type Server } from \"node:http\";\n\nimport express, {\n  type Express,\n  type Request,\n  Response,\n  NextFunction,\n} from \"express\";\n\nimport { registerRoutes } from \"./routes\";\nimport { initializeDatabaseSequences } from \"./db\";\nimport { isSMEDataConfigured } from \"./smedata\";\nimport { sendErrorReportToAdmin } from \"./email-service\";\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport const app = express();\n\n// Trust proxy for proper HTTPS detection behind load balancers\napp.set('trust proxy', 1);\n\n// Security middleware - HTTPS redirect and security headers\napp.use((req, res, next) => {\n  const isProduction = process.env.NODE_ENV === 'production';\n  \n  // Skip security redirect for WebSocket upgrades and internal health checks\n  const isWebSocketUpgrade = req.headers.upgrade?.toLowerCase() === 'websocket';\n  const isHealthCheck = req.path === '/health' || req.path === '/healthz';\n  \n  // HTTPS redirect in production - only if explicitly coming from HTTP\n  // Platforms like Render/Replit terminate TLS at the edge and forward HTTP\n  // We only redirect if x-forwarded-proto explicitly says 'http', not when it's undefined\n  const forwardedProto = req.headers['x-forwarded-proto'];\n  if (isProduction && !isWebSocketUpgrade && !isHealthCheck && forwardedProto === 'http') {\n    return res.redirect(301, `https://${req.headers.host}${req.url}`);\n  }\n  \n  // Security headers\n  res.setHeader('X-Content-Type-Options', 'nosniff');\n  res.setHeader('X-Frame-Options', 'SAMEORIGIN');\n  res.setHeader('X-XSS-Protection', '1; mode=block');\n  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');\n  \n  // Content Security Policy (relaxed for development)\n  if (isProduction) {\n    res.setHeader(\n      'Content-Security-Policy',\n      \"default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https:; font-src 'self' data:; connect-src 'self' wss: https:; frame-ancestors 'self';\"\n    );\n  }\n  \n  // Strict Transport Security (HSTS) - only in production over HTTPS\n  if (isProduction && (req.secure || forwardedProto === 'https')) {\n    res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');\n  }\n  \n  next();\n});\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\napp.use(express.json({\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n// Initialize default VTU plans if none exist (admin can modify prices)\nasync function initializeDefaultVtuPlans() {\n  try {\n    const { storage } = await import(\"./storage\");\n    const existingPlans = await storage.getVtuPlans();\n    \n    if (existingPlans.length > 0) {\n      log(`VTU plans already exist (${existingPlans.length} plans), skipping initialization`, \"vtu-init\");\n      return;\n    }\n    \n    log(\"Initializing default VTU plans...\", \"vtu-init\");\n    \n    // Default plans based on SMEDATA.NG pricing (admin can update via admin panel)\n    // The dataAmount field MUST match what SMEDATA API expects: \"500MB\", \"1GB\", \"2GB\", etc.\n    const defaultPlans = [\n      // MTN SME Plans\n      { network: \"mtn_sme\", planName: \"MTN 500MB - 30 Days\", dataAmount: \"500MB\", validity: \"30 days\", costPrice: \"140.00\", sellingPrice: \"150.00\", planCode: \"mtn_500mb\", sortOrder: 1 },\n      { network: \"mtn_sme\", planName: \"MTN 1GB - 30 Days\", dataAmount: \"1GB\", validity: \"30 days\", costPrice: \"245.00\", sellingPrice: \"260.00\", planCode: \"mtn_1gb\", sortOrder: 2 },\n      { network: \"mtn_sme\", planName: \"MTN 2GB - 30 Days\", dataAmount: \"2GB\", validity: \"30 days\", costPrice: \"490.00\", sellingPrice: \"520.00\", planCode: \"mtn_2gb\", sortOrder: 3 },\n      { network: \"mtn_sme\", planName: \"MTN 3GB - 30 Days\", dataAmount: \"3GB\", validity: \"30 days\", costPrice: \"735.00\", sellingPrice: \"780.00\", planCode: \"mtn_3gb\", sortOrder: 4 },\n      { network: \"mtn_sme\", planName: \"MTN 5GB - 30 Days\", dataAmount: \"5GB\", validity: \"30 days\", costPrice: \"1225.00\", sellingPrice: \"1300.00\", planCode: \"mtn_5gb\", sortOrder: 5 },\n      { network: \"mtn_sme\", planName: \"MTN 10GB - 30 Days\", dataAmount: \"10GB\", validity: \"30 days\", costPrice: \"2450.00\", sellingPrice: \"2600.00\", planCode: \"mtn_10gb\", sortOrder: 6 },\n      \n      // GLO CG Plans\n      { network: \"glo_cg\", planName: \"GLO 500MB - 30 Days\", dataAmount: \"500MB\", validity: \"30 days\", costPrice: \"135.00\", sellingPrice: \"145.00\", planCode: \"glo_500mb\", sortOrder: 10 },\n      { network: \"glo_cg\", planName: \"GLO 1GB - 30 Days\", dataAmount: \"1GB\", validity: \"30 days\", costPrice: \"240.00\", sellingPrice: \"255.00\", planCode: \"glo_1gb\", sortOrder: 11 },\n      { network: \"glo_cg\", planName: \"GLO 2GB - 30 Days\", dataAmount: \"2GB\", validity: \"30 days\", costPrice: \"480.00\", sellingPrice: \"510.00\", planCode: \"glo_2gb\", sortOrder: 12 },\n      { network: \"glo_cg\", planName: \"GLO 3GB - 30 Days\", dataAmount: \"3GB\", validity: \"30 days\", costPrice: \"720.00\", sellingPrice: \"765.00\", planCode: \"glo_3gb\", sortOrder: 13 },\n      { network: \"glo_cg\", planName: \"GLO 5GB - 30 Days\", dataAmount: \"5GB\", validity: \"30 days\", costPrice: \"1200.00\", sellingPrice: \"1275.00\", planCode: \"glo_5gb\", sortOrder: 14 },\n      { network: \"glo_cg\", planName: \"GLO 10GB - 30 Days\", dataAmount: \"10GB\", validity: \"30 days\", costPrice: \"2400.00\", sellingPrice: \"2550.00\", planCode: \"glo_10gb\", sortOrder: 15 },\n      \n      // Airtel CG Plans\n      { network: \"airtel_cg\", planName: \"Airtel 500MB - 30 Days\", dataAmount: \"500MB\", validity: \"30 days\", costPrice: \"140.00\", sellingPrice: \"150.00\", planCode: \"airtel_500mb\", sortOrder: 20 },\n      { network: \"airtel_cg\", planName: \"Airtel 1GB - 30 Days\", dataAmount: \"1GB\", validity: \"30 days\", costPrice: \"250.00\", sellingPrice: \"265.00\", planCode: \"airtel_1gb\", sortOrder: 21 },\n      { network: \"airtel_cg\", planName: \"Airtel 2GB - 30 Days\", dataAmount: \"2GB\", validity: \"30 days\", costPrice: \"500.00\", sellingPrice: \"530.00\", planCode: \"airtel_2gb\", sortOrder: 22 },\n      { network: \"airtel_cg\", planName: \"Airtel 3GB - 30 Days\", dataAmount: \"3GB\", validity: \"30 days\", costPrice: \"750.00\", sellingPrice: \"795.00\", planCode: \"airtel_3gb\", sortOrder: 23 },\n      { network: \"airtel_cg\", planName: \"Airtel 5GB - 30 Days\", dataAmount: \"5GB\", validity: \"30 days\", costPrice: \"1250.00\", sellingPrice: \"1325.00\", planCode: \"airtel_5gb\", sortOrder: 24 },\n      { network: \"airtel_cg\", planName: \"Airtel 10GB - 30 Days\", dataAmount: \"10GB\", validity: \"30 days\", costPrice: \"2500.00\", sellingPrice: \"2650.00\", planCode: \"airtel_10gb\", sortOrder: 25 },\n      \n      // 9mobile Plans\n      { network: \"9mobile\", planName: \"9mobile 500MB - 30 Days\", dataAmount: \"500MB\", validity: \"30 days\", costPrice: \"130.00\", sellingPrice: \"140.00\", planCode: \"9mobile_500mb\", sortOrder: 30 },\n      { network: \"9mobile\", planName: \"9mobile 1GB - 30 Days\", dataAmount: \"1GB\", validity: \"30 days\", costPrice: \"230.00\", sellingPrice: \"245.00\", planCode: \"9mobile_1gb\", sortOrder: 31 },\n      { network: \"9mobile\", planName: \"9mobile 2GB - 30 Days\", dataAmount: \"2GB\", validity: \"30 days\", costPrice: \"460.00\", sellingPrice: \"490.00\", planCode: \"9mobile_2gb\", sortOrder: 32 },\n      { network: \"9mobile\", planName: \"9mobile 3GB - 30 Days\", dataAmount: \"3GB\", validity: \"30 days\", costPrice: \"690.00\", sellingPrice: \"735.00\", planCode: \"9mobile_3gb\", sortOrder: 33 },\n      { network: \"9mobile\", planName: \"9mobile 5GB - 30 Days\", dataAmount: \"5GB\", validity: \"30 days\", costPrice: \"1150.00\", sellingPrice: \"1225.00\", planCode: \"9mobile_5gb\", sortOrder: 34 },\n      { network: \"9mobile\", planName: \"9mobile 10GB - 30 Days\", dataAmount: \"10GB\", validity: \"30 days\", costPrice: \"2300.00\", sellingPrice: \"2450.00\", planCode: \"9mobile_10gb\", sortOrder: 35 },\n    ];\n    \n    let created = 0;\n    for (const plan of defaultPlans) {\n      try {\n        await storage.upsertVtuPlan({\n          network: plan.network as any,\n          planName: plan.planName,\n          dataAmount: plan.dataAmount,\n          validity: plan.validity,\n          costPrice: plan.costPrice,\n          sellingPrice: plan.sellingPrice,\n          planCode: plan.planCode,\n          isActive: true,\n          sortOrder: plan.sortOrder,\n        });\n        created++;\n      } catch (err: any) {\n        log(`Failed to create VTU plan ${plan.planName}: ${err.message}`, \"vtu-init\");\n      }\n    }\n    \n    log(`VTU initialization complete: ${created} default plans created`, \"vtu-init\");\n    log(\"Admin can update prices via Admin Panel > VTU Management\", \"vtu-init\");\n  } catch (error: any) {\n    log(`VTU initialization error: ${error.message}`, \"vtu-init\");\n  }\n}\n\nexport default async function runApp(\n  setup: (app: Express, server: Server) => Promise<void>,\n) {\n  // Initialize database sequences on startup\n  await initializeDatabaseSequences();\n  \n  const server = await registerRoutes(app);\n\n  // Centralized error handling middleware\n  app.use((err: any, req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const isProduction = process.env.NODE_ENV === 'production';\n    \n    // Log full error details server-side\n    const errorDetails = {\n      message: err.message,\n      stack: err.stack,\n      path: req.path,\n      method: req.method,\n      userId: (req as any).user?.id,\n      timestamp: new Date().toISOString(),\n    };\n    console.error(\"[Error Handler]\", JSON.stringify(errorDetails, null, 2));\n    \n    // Determine user-friendly message\n    let userMessage = \"An unexpected error occurred. Please try again later.\";\n    \n    if (err.userMessage) {\n      userMessage = err.userMessage;\n    } else if (status === 400) {\n      userMessage = err.message || \"Invalid request. Please check your input.\";\n    } else if (status === 401) {\n      userMessage = \"Please log in to continue.\";\n    } else if (status === 403) {\n      userMessage = \"You don't have permission to perform this action.\";\n    } else if (status === 404) {\n      userMessage = \"The requested resource was not found.\";\n    } else if (status === 429) {\n      userMessage = \"Too many requests. Please wait a moment and try again.\";\n    } else if (status >= 500 && !isProduction) {\n      // In development, show actual error message\n      userMessage = err.message || \"Internal server error.\";\n    }\n    \n    // Send error report to admin for 500 errors\n    if (status >= 500) {\n      sendErrorReportToAdmin(\n        `Server Error [${status}]`,\n        err.message || \"Unknown error\",\n        {\n          path: req.path,\n          method: req.method,\n          stack: err.stack,\n          userId: (req as any).user?.id,\n        }\n      ).catch(console.error);\n    }\n\n    res.status(status).json({ \n      message: userMessage,\n      code: err.code || (status >= 500 ? \"INTERNAL_ERROR\" : \"ERROR\"),\n      ...(err.isRetryable !== undefined && { isRetryable: err.isRetryable }),\n    });\n  });\n\n  // importantly run the final setup after setting up all the other routes so\n  // the catch-all route doesn't interfere with the other routes\n  await setup(app, server);\n\n  // Initialize default VTU plans if none exist\n  initializeDefaultVtuPlans();\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n}\n","path":null,"size_bytes":12574,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"server/index-dev.ts":{"content":"import fs from \"node:fs\";\nimport path from \"node:path\";\nimport { type Server } from \"node:http\";\n\nimport { nanoid } from \"nanoid\";\nimport { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\n\nimport viteConfig from \"../vite.config\";\nimport runApp from \"./app\";\n\nexport async function setupVite(app: Express, server: Server) {\n  const viteLogger = createLogger();\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\n(async () => {\n  await runApp(setupVite);\n})();\n","path":null,"size_bytes":1609,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/CartDrawer.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useCart, CartItemWithProduct } from \"@/hooks/use-cart\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetHeader,\n  SheetTitle,\n  SheetDescription,\n  SheetFooter,\n  SheetTrigger,\n} from \"@/components/ui/sheet\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { ShoppingCart, Plus, Minus, Trash2, X, Loader2 } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface CartItemRowProps {\n  item: CartItemWithProduct;\n  onUpdateQuantity: (id: string, quantity: number) => Promise<void>;\n  onRemove: (id: string) => Promise<void>;\n  isUpdating: boolean;\n}\n\nfunction CartItemRow({ item, onUpdateQuantity, onRemove, isUpdating }: CartItemRowProps) {\n  const [localQuantity, setLocalQuantity] = useState(item.quantity);\n  const [isRemoving, setIsRemoving] = useState(false);\n\n  const images = item.product.images || [];\n  const imageUrl = images[0] || \"/placeholder-product.png\";\n  const priceValue = item.product.price;\n  const price = typeof priceValue === 'number' ? priceValue : parseFloat(priceValue as string) || 0;\n\n  const handleIncrement = async () => {\n    const newQuantity = localQuantity + 1;\n    setLocalQuantity(newQuantity);\n    await onUpdateQuantity(item.id, newQuantity);\n  };\n\n  const handleDecrement = async () => {\n    if (localQuantity > 1) {\n      const newQuantity = localQuantity - 1;\n      setLocalQuantity(newQuantity);\n      await onUpdateQuantity(item.id, newQuantity);\n    }\n  };\n\n  const handleRemove = async () => {\n    setIsRemoving(true);\n    try {\n      await onRemove(item.id);\n    } finally {\n      setIsRemoving(false);\n    }\n  };\n\n  return (\n    <div className=\"flex gap-3 py-4\" data-testid={`cart-item-${item.id}`}>\n      <div className=\"h-20 w-20 flex-shrink-0 overflow-hidden rounded-md border\">\n        <img\n          src={imageUrl}\n          alt={item.product.title}\n          className=\"h-full w-full object-cover\"\n          loading=\"lazy\"\n        />\n      </div>\n      <div className=\"flex flex-1 flex-col\">\n        <div className=\"flex justify-between\">\n          <h4 className=\"text-sm font-medium line-clamp-2\" data-testid={`cart-item-title-${item.id}`}>\n            {item.product.title}\n          </h4>\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"h-6 w-6 -mr-2 -mt-1\"\n            onClick={handleRemove}\n            disabled={isRemoving}\n            data-testid={`button-remove-cart-item-${item.id}`}\n          >\n            {isRemoving ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : (\n              <X className=\"h-4 w-4\" />\n            )}\n          </Button>\n        </div>\n        <p className=\"text-sm font-semibold text-primary\" data-testid={`cart-item-price-${item.id}`}>\n          ₦{price.toLocaleString()}\n        </p>\n        <div className=\"mt-auto flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              className=\"h-7 w-7\"\n              onClick={handleDecrement}\n              disabled={localQuantity <= 1 || isUpdating}\n              data-testid={`button-decrement-${item.id}`}\n            >\n              <Minus className=\"h-3 w-3\" />\n            </Button>\n            <span className=\"w-8 text-center text-sm\" data-testid={`text-quantity-${item.id}`}>\n              {localQuantity}\n            </span>\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              className=\"h-7 w-7\"\n              onClick={handleIncrement}\n              disabled={isUpdating}\n              data-testid={`button-increment-${item.id}`}\n            >\n              <Plus className=\"h-3 w-3\" />\n            </Button>\n          </div>\n          <p className=\"text-sm font-medium\" data-testid={`cart-item-subtotal-${item.id}`}>\n            ₦{(price * localQuantity).toLocaleString()}\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n\ninterface CartDrawerProps {\n  children?: React.ReactNode;\n}\n\nexport function CartDrawer({ children }: CartDrawerProps) {\n  const { isAuthenticated } = useAuth();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [isOpen, setIsOpen] = useState(false);\n  const {\n    cartItems,\n    itemCount,\n    subtotal,\n    isLoading,\n    updateQuantity,\n    isUpdatingQuantity,\n    removeFromCart,\n    clearCart,\n    isClearingCart,\n  } = useCart();\n\n  const handleUpdateQuantity = async (cartItemId: string, quantity: number) => {\n    try {\n      await updateQuantity({ cartItemId, quantity });\n    } catch (error) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Failed to update quantity\",\n      });\n    }\n  };\n\n  const handleRemoveFromCart = async (cartItemId: string) => {\n    try {\n      await removeFromCart(cartItemId);\n      toast({\n        title: \"Removed\",\n        description: \"Item removed from cart\",\n      });\n    } catch (error) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Failed to remove item\",\n      });\n    }\n  };\n\n  const handleClearCart = async () => {\n    try {\n      await clearCart();\n      toast({\n        title: \"Cart Cleared\",\n        description: \"All items have been removed from your cart\",\n      });\n    } catch (error) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Failed to clear cart\",\n      });\n    }\n  };\n\n  const handleContinueShopping = () => {\n    setIsOpen(false);\n  };\n\n  const handleCheckout = () => {\n    setIsOpen(false);\n    setLocation(\"/checkout\");\n  };\n\n  if (!isAuthenticated) {\n    return (\n      <Button variant=\"ghost\" size=\"icon\" disabled data-testid=\"button-cart-disabled\">\n        <ShoppingCart className=\"h-5 w-5\" />\n      </Button>\n    );\n  }\n\n  return (\n    <Sheet open={isOpen} onOpenChange={setIsOpen}>\n      <SheetTrigger asChild>\n        {children || (\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"relative\"\n            data-testid=\"button-cart\"\n          >\n            <ShoppingCart className=\"h-5 w-5\" />\n            {itemCount > 0 && (\n              <Badge\n                variant=\"destructive\"\n                className=\"absolute -top-1 -right-1 h-5 w-5 rounded-full p-0 flex items-center justify-center text-xs\"\n                data-testid=\"badge-cart-count\"\n              >\n                {itemCount > 99 ? \"99+\" : itemCount}\n              </Badge>\n            )}\n          </Button>\n        )}\n      </SheetTrigger>\n      <SheetContent className=\"flex flex-col w-full sm:max-w-lg\">\n        <SheetHeader>\n          <SheetTitle data-testid=\"text-cart-title\">Shopping Cart</SheetTitle>\n          <SheetDescription data-testid=\"text-cart-description\">\n            {itemCount === 0\n              ? \"Your cart is empty\"\n              : `You have ${itemCount} item${itemCount === 1 ? \"\" : \"s\"} in your cart`}\n          </SheetDescription>\n        </SheetHeader>\n\n        {isLoading ? (\n          <div className=\"flex-1 flex items-center justify-center\">\n            <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n          </div>\n        ) : cartItems.length === 0 ? (\n          <div className=\"flex-1 flex flex-col items-center justify-center gap-4\">\n            <ShoppingCart className=\"h-16 w-16 text-muted-foreground\" />\n            <p className=\"text-muted-foreground\">Your cart is empty</p>\n            <Button onClick={handleContinueShopping} data-testid=\"button-start-shopping\">\n              Start Shopping\n            </Button>\n          </div>\n        ) : (\n          <>\n            <ScrollArea className=\"flex-1 -mx-6 px-6\">\n              <div className=\"divide-y\">\n                {cartItems.map((item) => (\n                  <CartItemRow\n                    key={item.id}\n                    item={item}\n                    onUpdateQuantity={handleUpdateQuantity}\n                    onRemove={handleRemoveFromCart}\n                    isUpdating={isUpdatingQuantity}\n                  />\n                ))}\n              </div>\n            </ScrollArea>\n\n            <div className=\"space-y-4 pt-4\">\n              <Separator />\n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-muted-foreground\">Subtotal</span>\n                <span className=\"font-semibold\" data-testid=\"text-cart-subtotal\">\n                  ₦{subtotal.toLocaleString()}\n                </span>\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <span className=\"font-semibold\">Total</span>\n                <span className=\"text-xl font-bold\" data-testid=\"text-cart-total\">\n                  ₦{subtotal.toLocaleString()}\n                </span>\n              </div>\n              <Separator />\n\n              <SheetFooter className=\"flex-col gap-2 sm:flex-col\">\n                <Button\n                  className=\"w-full\"\n                  onClick={handleCheckout}\n                  data-testid=\"button-checkout\"\n                >\n                  Proceed to Checkout\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  className=\"w-full\"\n                  onClick={handleContinueShopping}\n                  data-testid=\"button-continue-shopping\"\n                >\n                  Continue Shopping\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  className=\"w-full text-destructive\"\n                  onClick={handleClearCart}\n                  disabled={isClearingCart}\n                  data-testid=\"button-clear-cart\"\n                >\n                  {isClearingCart ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      Clearing...\n                    </>\n                  ) : (\n                    <>\n                      <Trash2 className=\"mr-2 h-4 w-4\" />\n                      Clear Cart\n                    </>\n                  )}\n                </Button>\n              </SheetFooter>\n            </div>\n          </>\n        )}\n      </SheetContent>\n    </Sheet>\n  );\n}\n","path":null,"size_bytes":10476,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from 'drizzle-orm';\nimport { relations } from 'drizzle-orm';\nimport {\n  index,\n  jsonb,\n  pgTable,\n  timestamp,\n  varchar,\n  text,\n  integer,\n  decimal,\n  boolean,\n  pgEnum,\n} from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Session storage table (required for Replit Auth)\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// User roles enum - Users can choose buyer, seller, both, or admin\nexport const userRoleEnum = pgEnum(\"user_role\", [\"buyer\", \"seller\", \"both\", \"admin\"]);\n\n// User storage table (email/password authentication with marketplace features)\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").notNull().unique(),\n  password: varchar(\"password\"), // Hashed password using bcrypt (nullable for migration from OAuth users)\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  username: varchar(\"username\", { length: 30 }).unique(), // @username for mentions and profile URLs\n  profileImageUrl: varchar(\"profile_image_url\"),\n  coverImageUrl: varchar(\"cover_image_url\"), // Profile cover/banner image\n  role: userRoleEnum(\"role\").notNull().default(\"buyer\"),\n  // Referral code - unique 8-character alphanumeric code for sharing\n  referralCode: varchar(\"referral_code\", { length: 8 }).unique(),\n  // Campus-specific fields\n  phoneNumber: varchar(\"phone_number\").unique(), // UNIQUE - one account per phone\n  location: varchar(\"location\"), // Campus area/hostel\n  latitude: decimal(\"latitude\", { precision: 10, scale: 7 }), // GPS coordinates for real-time location\n  longitude: decimal(\"longitude\", { precision: 10, scale: 7 }), // GPS coordinates for real-time location\n  lastLocationUpdate: timestamp(\"last_location_update\"), // When location was last updated\n  bio: text(\"bio\"),\n  gender: varchar(\"gender\", { length: 20 }), // Optional: \"male\", \"female\", \"other\", \"prefer_not_to_say\"\n  // System account flags\n  isSystemAccount: boolean(\"is_system_account\").default(false), // @EKSUPlug official bot\n  systemAccountType: varchar(\"system_account_type\", { length: 20 }), // \"official_bot\", \"support\", etc\n  // Verification fields\n  isVerified: boolean(\"is_verified\").default(false),\n  verificationBadges: text(\"verification_badges\").array().default(sql`ARRAY[]::text[]`), // [\"email\", \"phone\", \"student_id\", \"nin\"]\n  ninVerified: boolean(\"nin_verified\").default(false),\n  ninVerificationDate: timestamp(\"nin_verification_date\"),\n  ninHash: varchar(\"nin_hash\").unique(), // Hashed NIN (NOT the actual NIN - illegal to store)\n  ninVnin: varchar(\"nin_vnin\"), // Virtual NIN token from verification provider (Korapay/Dojah)\n  ninConfidenceScore: decimal(\"nin_confidence_score\", { precision: 5, scale: 2 }), // Selfie match confidence\n  // Social media links\n  instagramHandle: varchar(\"instagram_handle\"),\n  tiktokHandle: varchar(\"tiktok_handle\"),\n  facebookProfile: varchar(\"facebook_profile\"),\n  // Trust score\n  trustScore: decimal(\"trust_score\", { precision: 3, scale: 1 }).default(\"5.0\"),\n  totalRatings: integer(\"total_ratings\").default(0),\n  isTrustedSeller: boolean(\"is_trusted_seller\").default(false), // Manually set by admin\n  trustedSellerSince: timestamp(\"trusted_seller_since\"),\n  // Seller-specific\n  totalSales: integer(\"total_sales\").default(0),\n  responseTime: integer(\"response_time\"), // Average response time in minutes\n  // Seller verification documents (manual admin process)\n  studentIdImage: text(\"student_id_image\"), // URL to uploaded student ID photo\n  selfieImage: text(\"selfie_image\"), // URL to uploaded selfie for verification\n  verificationRequestedAt: timestamp(\"verification_requested_at\"),\n  verificationReviewedAt: timestamp(\"verification_reviewed_at\"),\n  verificationReviewedBy: varchar(\"verification_reviewed_by\"), // Admin user ID who reviewed\n  verificationNotes: text(\"verification_notes\"), // Admin notes on verification\n  // Account status\n  isActive: boolean(\"is_active\").default(true),\n  isBanned: boolean(\"is_banned\").default(false),\n  emailVerified: boolean(\"email_verified\").default(false),\n  banReason: text(\"ban_reason\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// User photos gallery table\nexport const userPhotos = pgTable(\"user_photos\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  imageUrl: varchar(\"image_url\", { length: 500 }).notNull(),\n  isProfilePhoto: boolean(\"is_profile_photo\").default(false),\n  sortOrder: integer(\"sort_order\").default(0),\n  caption: varchar(\"caption\", { length: 200 }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"user_photos_user_idx\").on(table.userId),\n  index(\"user_photos_sort_idx\").on(table.userId, table.sortOrder),\n]);\n\nexport const insertUserPhotoSchema = createInsertSchema(userPhotos).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const addUserPhotoSchema = z.object({\n  caption: z.string().max(200).optional(),\n});\n\nexport const reorderPhotosSchema = z.object({\n  photoIds: z.array(z.string()).min(1).max(6),\n});\n\nexport type UserPhoto = typeof userPhotos.$inferSelect;\nexport type InsertUserPhoto = z.infer<typeof insertUserPhotoSchema>;\n\n// Product categories\nexport const categories = pgTable(\"categories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\", { length: 100 }).notNull().unique(),\n  slug: varchar(\"slug\", { length: 100 }).notNull().unique(),\n  icon: varchar(\"icon\"), // Lucide icon name\n  description: text(\"description\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Product condition enum\nexport const productConditionEnum = pgEnum(\"product_condition\", [\"new\", \"like_new\", \"good\", \"fair\"]);\n\n// Products/Listings\nexport const products = pgTable(\"products\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sellerId: varchar(\"seller_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  categoryId: varchar(\"category_id\").notNull().references(() => categories.id),\n  title: varchar(\"title\", { length: 200 }).notNull(),\n  description: text(\"description\").notNull(),\n  price: decimal(\"price\", { precision: 10, scale: 2 }).notNull(),\n  originalPrice: decimal(\"original_price\", { precision: 10, scale: 2 }), // Original price before discount\n  isOnSale: boolean(\"is_on_sale\").default(false), // Whether the product is on sale\n  images: text(\"images\").array().notNull().default(sql`ARRAY[]::text[]`), // Array of image URLs\n  condition: productConditionEnum(\"condition\").notNull().default(\"good\"),\n  location: varchar(\"location\"), // Campus area\n  // Status\n  isAvailable: boolean(\"is_available\").default(true),\n  isSold: boolean(\"is_sold\").default(false),\n  isFeatured: boolean(\"is_featured\").default(false),\n  isBoosted: boolean(\"is_boosted\").default(false),\n  boostedUntil: timestamp(\"boosted_until\"),\n  // Moderation\n  isApproved: boolean(\"is_approved\").default(true),\n  isFlagged: boolean(\"is_flagged\").default(false),\n  flagReason: text(\"flag_reason\"),\n  // Analytics\n  views: integer(\"views\").default(0),\n  watchers: integer(\"watchers\").default(0),\n  inquiries: integer(\"inquiries\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Product views tracking for unique view counts\nexport const productViews = pgTable(\"product_views\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  productId: varchar(\"product_id\").notNull().references(() => products.id, { onDelete: \"cascade\" }),\n  viewerId: varchar(\"viewer_id\").notNull(), // User ID for logged-in users, or hashed IP+session for guests\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"product_views_product_viewer_idx\").on(table.productId, table.viewerId),\n  index(\"product_views_product_idx\").on(table.productId),\n]);\n\n// Cart items table\nexport const cartItems = pgTable(\"cart_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  productId: varchar(\"product_id\").notNull().references(() => products.id, { onDelete: \"cascade\" }),\n  quantity: integer(\"quantity\").notNull().default(1),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"cart_user_product_idx\").on(table.userId, table.productId),\n]);\n\n// Messages for real-time chat\nexport const messages = pgTable(\"messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  senderId: varchar(\"sender_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  receiverId: varchar(\"receiver_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  productId: varchar(\"product_id\").references(() => products.id, { onDelete: \"set null\" }), // Optional context\n  content: text(\"content\").notNull(),\n  imageUrl: varchar(\"image_url\", { length: 500 }), // Optional attachment image URL\n  isRead: boolean(\"is_read\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Reviews and ratings\nexport const reviews = pgTable(\"reviews\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  reviewerId: varchar(\"reviewer_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  reviewedUserId: varchar(\"reviewed_user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  productId: varchar(\"product_id\").references(() => products.id, { onDelete: \"set null\" }),\n  rating: integer(\"rating\").notNull(), // 1-5\n  comment: text(\"comment\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Reports for flagging scams/inappropriate content\nexport const reports = pgTable(\"reports\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  reporterId: varchar(\"reporter_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  reportedUserId: varchar(\"reported_user_id\").references(() => users.id, { onDelete: \"cascade\" }),\n  reportedProductId: varchar(\"reported_product_id\").references(() => products.id, { onDelete: \"cascade\" }),\n  reason: varchar(\"reason\", { length: 100 }).notNull(),\n  description: text(\"description\"),\n  status: varchar(\"status\", { length: 20 }).default(\"pending\"), // pending, reviewed, resolved\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Watchlist/Favorites\nexport const watchlist = pgTable(\"watchlist\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  productId: varchar(\"product_id\").notNull().references(() => products.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Wallet system for virtual currency\nexport const wallets = pgTable(\"wallets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().unique().references(() => users.id, { onDelete: \"cascade\" }),\n  balance: decimal(\"balance\", { precision: 10, scale: 2 }).default(\"0.00\").notNull(),\n  escrowBalance: decimal(\"escrow_balance\", { precision: 10, scale: 2 }).default(\"0.00\").notNull(),\n  securityDepositLocked: decimal(\"security_deposit_locked\", { precision: 10, scale: 2 }).default(\"0.00\").notNull(), // Locked seller deposit\n  totalEarned: decimal(\"total_earned\", { precision: 10, scale: 2 }).default(\"0.00\").notNull(),\n  totalSpent: decimal(\"total_spent\", { precision: 10, scale: 2 }).default(\"0.00\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Transaction types\nexport const transactionTypeEnum = pgEnum(\"transaction_type\", [\n  \"welcome_bonus\", \"referral_bonus\", \"login_reward\", \"deposit\", \"sale\", \"purchase\", \n  \"boost_payment\", \"featured_payment\", \"escrow_hold\", \"escrow_release\", \"escrow_fee\",\n  \"refund\", \"withdrawal\", \"agent_commission\", \"platform_fee\", \"security_deposit_lock\",\n  \"security_deposit_unlock\", \"negotiation_accepted\", \"payment_fee\"\n]);\n\n// Wallet transactions\nexport const transactions = pgTable(\"transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  walletId: varchar(\"wallet_id\").notNull().references(() => wallets.id, { onDelete: \"cascade\" }),\n  type: transactionTypeEnum(\"type\").notNull(),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  description: text(\"description\"),\n  relatedProductId: varchar(\"related_product_id\").references(() => products.id, { onDelete: \"set null\" }),\n  relatedUserId: varchar(\"related_user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  status: varchar(\"status\", { length: 20 }).default(\"completed\"), // pending, completed, failed, refunded\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Referral system\nexport const referrals = pgTable(\"referrals\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  referrerId: varchar(\"referrer_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  referredUserId: varchar(\"referred_user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  bonusAmount: decimal(\"bonus_amount\", { precision: 10, scale: 2 }), // Will be randomized ₦2-50 when paid\n  bonusPaid: boolean(\"bonus_paid\").default(false),\n  referredUserMadePurchase: boolean(\"referred_user_made_purchase\").default(false), // Track if they bought anything\n  firstPurchaseId: varchar(\"first_purchase_id\"), // ID of their first purchase\n  bonusPaidAt: timestamp(\"bonus_paid_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Welcome bonuses tracking\nexport const welcomeBonuses = pgTable(\"welcome_bonuses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().unique().references(() => users.id, { onDelete: \"cascade\" }),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  claimed: boolean(\"claimed\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Search history for users\nexport const searchHistory = pgTable(\"search_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }),\n  query: varchar(\"query\", { length: 200 }).notNull(),\n  filters: jsonb(\"filters\"), // Store filter state\n  resultCount: integer(\"result_count\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Saved searches with price alerts\nexport const savedSearches = pgTable(\"saved_searches\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  query: varchar(\"query\", { length: 200 }).notNull(),\n  filters: jsonb(\"filters\"),\n  maxPrice: decimal(\"max_price\", { precision: 10, scale: 2 }),\n  alertEnabled: boolean(\"alert_enabled\").default(true),\n  lastAlertSent: timestamp(\"last_alert_sent\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Draft listings\nexport const draftProducts = pgTable(\"draft_products\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sellerId: varchar(\"seller_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  data: jsonb(\"data\").notNull(), // Store full product data as JSON\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Scheduled posts\nexport const scheduledPosts = pgTable(\"scheduled_posts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sellerId: varchar(\"seller_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  productData: jsonb(\"product_data\").notNull(),\n  scheduledFor: timestamp(\"scheduled_for\").notNull(),\n  published: boolean(\"published\").default(false),\n  publishedProductId: varchar(\"published_product_id\").references(() => products.id, { onDelete: \"set null\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Voice posts for Nigerian language support\nexport const voicePosts = pgTable(\"voice_posts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  audioUrl: text(\"audio_url\"), // Path to audio file\n  transcription: text(\"transcription\"), // AI-generated text\n  language: varchar(\"language\", { length: 50 }), // pidgin, yoruba, igbo, hausa, english\n  productId: varchar(\"product_id\").references(() => products.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Boost/Featured listing requests\nexport const boostRequests = pgTable(\"boost_requests\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  productId: varchar(\"product_id\").notNull().references(() => products.id, { onDelete: \"cascade\" }),\n  sellerId: varchar(\"seller_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  type: varchar(\"type\", { length: 20 }).notNull(), // boost, featured\n  duration: integer(\"duration\").notNull(), // hours\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  status: varchar(\"status\", { length: 20 }).default(\"pending\"), // pending, active, expired, cancelled\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Disputes and resolution center\nexport const disputes = pgTable(\"disputes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  productId: varchar(\"product_id\").references(() => products.id, { onDelete: \"set null\" }),\n  buyerId: varchar(\"buyer_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  sellerId: varchar(\"seller_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  reason: text(\"reason\").notNull(),\n  description: text(\"description\").notNull(),\n  evidence: text(\"evidence\").array().default(sql`ARRAY[]::text[]`), // Photo URLs\n  status: varchar(\"status\", { length: 20 }).default(\"open\"), // open, under_review, resolved, closed\n  resolution: text(\"resolution\"),\n  resolvedBy: varchar(\"resolved_by\").references(() => users.id, { onDelete: \"set null\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  resolvedAt: timestamp(\"resolved_at\"),\n});\n\n// Support tickets\nexport const supportTickets = pgTable(\"support_tickets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  ticketNumber: varchar(\"ticket_number\", { length: 20 }), // e.g., EKSU-00124\n  subject: varchar(\"subject\", { length: 200 }).notNull(),\n  message: text(\"message\").notNull(),\n  category: varchar(\"category\", { length: 50 }), // account, payment, technical, report, bug, suggestion\n  priority: varchar(\"priority\", { length: 20 }).default(\"medium\"), // low, medium, high, urgent\n  attachments: text(\"attachments\").array().default(sql`ARRAY[]::text[]`), // Array of image URLs\n  status: varchar(\"status\", { length: 20 }).default(\"open\"), // open, pending, in_progress, resolved, closed\n  assignedTo: varchar(\"assigned_to\").references(() => users.id, { onDelete: \"set null\" }),\n  response: text(\"response\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Ticket replies - threaded conversation history\nexport const ticketReplies = pgTable(\"ticket_replies\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  ticketId: varchar(\"ticket_id\").notNull().references(() => supportTickets.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  message: text(\"message\").notNull(),\n  isAdminReply: boolean(\"is_admin_reply\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"ticket_replies_ticket_idx\").on(table.ticketId),\n]);\n\n// Login streak rewards\nexport const loginStreaks = pgTable(\"login_streaks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().unique().references(() => users.id, { onDelete: \"cascade\" }),\n  currentStreak: integer(\"current_streak\").default(0),\n  longestStreak: integer(\"longest_streak\").default(0),\n  lastLoginDate: timestamp(\"last_login_date\"),\n  totalRewards: decimal(\"total_rewards\", { precision: 10, scale: 2 }).default(\"0.00\"),\n  // Security enhancement columns\n  lastIpAddress: varchar(\"last_ip_address\"), // Track IP for suspicious activity detection\n  dailyClaimHash: varchar(\"daily_claim_hash\"), // Hash for replay attack prevention\n  claimCount: integer(\"claim_count\").default(0), // Total claims for abuse detection\n  lastClaimAttempt: timestamp(\"last_claim_attempt\"), // For rate limiting tracking\n  suspiciousActivityCount: integer(\"suspicious_activity_count\").default(0), // Track potential abuse\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Seller analytics\nexport const sellerAnalytics = pgTable(\"seller_analytics\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sellerId: varchar(\"seller_id\").notNull().unique().references(() => users.id, { onDelete: \"cascade\" }),\n  totalViews: integer(\"total_views\").default(0),\n  totalMessages: integer(\"total_messages\").default(0),\n  conversionRate: decimal(\"conversion_rate\", { precision: 5, scale: 2 }).default(\"0.00\"),\n  bestPostingHour: integer(\"best_posting_hour\"), // 0-23\n  bestPostingDay: integer(\"best_posting_day\"), // 0-6 (Sunday-Saturday)\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Follows - user following system\nexport const follows = pgTable(\"follows\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  followerId: varchar(\"follower_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  followingId: varchar(\"following_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_follower\").on(table.followerId),\n  index(\"idx_following\").on(table.followingId),\n]);\n\n// Hostel listings (separate from products)\nexport const hostels = pgTable(\"hostels\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  agentId: varchar(\"agent_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  title: varchar(\"title\", { length: 200 }).notNull(),\n  description: text(\"description\").notNull(),\n  location: varchar(\"location\").notNull(), // Campus area\n  address: text(\"address\"),\n  price: decimal(\"price\", { precision: 10, scale: 2 }).notNull(), // Per year\n  images: text(\"images\").array().default(sql`ARRAY[]::text[]`),\n  bedrooms: integer(\"bedrooms\"),\n  bathrooms: integer(\"bathrooms\"),\n  amenities: text(\"amenities\").array().default(sql`ARRAY[]::text[]`), // [\"wifi\", \"water\", \"security\", etc]\n  distanceFromCampus: decimal(\"distance_from_campus\", { precision: 5, scale: 2 }), // In KM\n  isAvailable: boolean(\"is_available\").default(true),\n  agentFee: decimal(\"agent_fee\", { precision: 10, scale: 2 }), // Agent commission\n  platformCommission: decimal(\"platform_commission\", { precision: 5, scale: 2 }).default(\"5.00\"), // % we take\n  views: integer(\"views\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Event listings (concerts, parties, campus events)\nexport const events = pgTable(\"events\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizerId: varchar(\"organizer_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  title: varchar(\"title\", { length: 200 }).notNull(),\n  description: text(\"description\").notNull(),\n  eventType: varchar(\"event_type\", { length: 50 }).notNull(), // concert, party, conference, workshop, etc\n  bannerImage: text(\"banner_image\"),\n  venue: varchar(\"venue\").notNull(),\n  eventDate: timestamp(\"event_date\").notNull(),\n  ticketPrice: decimal(\"ticket_price\", { precision: 10, scale: 2 }),\n  isFree: boolean(\"is_free\").default(false),\n  totalTickets: integer(\"total_tickets\"),\n  ticketsSold: integer(\"tickets_sold\").default(0),\n  contactInfo: varchar(\"contact_info\"),\n  isActive: boolean(\"is_active\").default(true),\n  views: integer(\"views\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Escrow status enum\nexport const escrowStatusEnum = pgEnum(\"escrow_status\", [\n  \"pending\", \"held\", \"released\", \"refunded\", \"disputed\"\n]);\n\n// Escrow transactions for buyer/seller safety\nexport const escrowTransactions = pgTable(\"escrow_transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  buyerId: varchar(\"buyer_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  sellerId: varchar(\"seller_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  productId: varchar(\"product_id\").references(() => products.id, { onDelete: \"set null\" }),\n  hostelId: varchar(\"hostel_id\").references(() => hostels.id, { onDelete: \"set null\" }),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  platformFee: decimal(\"platform_fee\", { precision: 10, scale: 2 }).notNull(), // 3-6% of amount\n  status: escrowStatusEnum(\"status\").notNull().default(\"pending\"),\n  holdDuration: integer(\"hold_duration\").default(7), // Days to hold before auto-release\n  releasedAt: timestamp(\"released_at\"),\n  disputeId: varchar(\"dispute_id\").references(() => disputes.id, { onDelete: \"set null\" }),\n  buyerConfirmed: boolean(\"buyer_confirmed\").default(false),\n  sellerConfirmed: boolean(\"seller_confirmed\").default(false),\n  autoReleaseDate: timestamp(\"auto_release_date\"), // Calculated from hold_duration\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Squad payment records (primary payment provider - Habari/GTBank)\nexport const squadPayments = pgTable(\"squad_payments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  transactionReference: varchar(\"transaction_reference\").notNull().unique(),\n  gatewayReference: varchar(\"gateway_reference\"),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  merchantAmount: decimal(\"merchant_amount\", { precision: 10, scale: 2 }),\n  fee: decimal(\"fee\", { precision: 10, scale: 2 }).default(\"0.00\"),\n  currency: varchar(\"currency\", { length: 3 }).default(\"NGN\"),\n  status: varchar(\"status\", { length: 20 }).notNull().default(\"pending\"), // pending, success, failed, abandoned\n  paymentMethod: varchar(\"payment_method\", { length: 30 }), // transfer, card, ussd, bank\n  paymentDescription: text(\"payment_description\"),\n  paidAt: timestamp(\"paid_at\"),\n  metadata: jsonb(\"metadata\"),\n  purpose: varchar(\"purpose\", { length: 50 }), // wallet_deposit, checkout_payment, boost_payment, etc\n  customerEmail: varchar(\"customer_email\"),\n  customerName: varchar(\"customer_name\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Squad transfer records (for payouts to sellers/withdrawals)\nexport const squadTransfers = pgTable(\"squad_transfers\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  transactionReference: varchar(\"transaction_reference\").notNull().unique(),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  fee: decimal(\"fee\", { precision: 10, scale: 2 }).default(\"0.00\"),\n  destinationBankCode: varchar(\"destination_bank_code\").notNull(),\n  destinationAccountNumber: varchar(\"destination_account_number\").notNull(),\n  destinationAccountName: varchar(\"destination_account_name\"),\n  status: varchar(\"status\", { length: 20 }).notNull().default(\"pending\"), // pending, success, failed\n  remark: text(\"remark\"),\n  responseMessage: text(\"response_message\"),\n  responseCode: varchar(\"response_code\", { length: 10 }),\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Negotiation status enum\nexport const negotiationStatusEnum = pgEnum(\"negotiation_status\", [\n  \"pending\", \"accepted\", \"rejected\", \"countered\", \"expired\", \"cancelled\"\n]);\n\n// Price negotiations between buyers and sellers\nexport const negotiations = pgTable(\"negotiations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  productId: varchar(\"product_id\").notNull().references(() => products.id, { onDelete: \"cascade\" }),\n  buyerId: varchar(\"buyer_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  sellerId: varchar(\"seller_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  originalPrice: decimal(\"original_price\", { precision: 10, scale: 2 }).notNull(), // Price at time of offer\n  offerPrice: decimal(\"offer_price\", { precision: 10, scale: 2 }).notNull(), // Buyer's proposed price\n  counterOfferPrice: decimal(\"counter_offer_price\", { precision: 10, scale: 2 }), // Seller's counter (if any)\n  status: negotiationStatusEnum(\"status\").notNull().default(\"pending\"),\n  buyerMessage: text(\"buyer_message\"), // Optional message with offer\n  sellerMessage: text(\"seller_message\"), // Optional response message\n  // Calculated fee breakdown (populated when offer is made/updated)\n  calculatedPlatformFee: decimal(\"calculated_platform_fee\", { precision: 10, scale: 2 }),\n  calculatedPaymentFee: decimal(\"calculated_payment_fee\", { precision: 10, scale: 2 }),\n  calculatedSellerProfit: decimal(\"calculated_seller_profit\", { precision: 10, scale: 2 }),\n  expiresAt: timestamp(\"expires_at\"), // Negotiation expiry (e.g., 24 hours)\n  acceptedAt: timestamp(\"accepted_at\"),\n  rejectedAt: timestamp(\"rejected_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_negotiations_product\").on(table.productId),\n  index(\"idx_negotiations_buyer\").on(table.buyerId),\n  index(\"idx_negotiations_seller\").on(table.sellerId),\n  index(\"idx_negotiations_status\").on(table.status),\n]);\n\n// Withdrawals to bank accounts\nexport const withdrawals = pgTable(\"withdrawals\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  bankCode: varchar(\"bank_code\"),\n  bankName: varchar(\"bank_name\").notNull(),\n  accountNumber: varchar(\"account_number\").notNull(),\n  accountName: varchar(\"account_name\").notNull(),\n  status: varchar(\"status\", { length: 20 }).default(\"pending\"), // pending, processing, completed, failed\n  squadReference: varchar(\"squad_reference\"), // Squad transfer reference\n  squadTransferId: varchar(\"squad_transfer_id\").references(() => squadTransfers.id, { onDelete: \"set null\" }),\n  processedAt: timestamp(\"processed_at\"),\n  failureReason: text(\"failure_reason\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Order status enum\nexport const orderStatusEnum = pgEnum(\"order_status\", [\n  \"pending\",           // Order placed, awaiting payment\n  \"paid\",              // Payment confirmed\n  \"seller_confirmed\",  // Seller acknowledged order\n  \"preparing\",         // Seller preparing item\n  \"ready_for_pickup\",  // Item ready for pickup/delivery\n  \"shipped\",           // Item dispatched\n  \"out_for_delivery\",  // With delivery agent\n  \"delivered\",         // Delivered to buyer\n  \"buyer_confirmed\",   // Buyer confirmed receipt\n  \"completed\",         // Funds released to seller\n  \"cancelled\",         // Order cancelled\n  \"disputed\",          // Under dispute\n  \"refunded\"           // Money refunded\n]);\n\n// Delivery method enum\nexport const deliveryMethodEnum = pgEnum(\"delivery_method\", [\n  \"pickup\",            // Buyer picks up from seller\n  \"seller_delivery\",   // Seller delivers to buyer\n  \"agent_delivery\",    // Third-party delivery agent\n  \"campus_meetup\"      // Meet on campus\n]);\n\n// Orders table with comprehensive delivery tracking\nexport const orders = pgTable(\"orders\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  orderNumber: varchar(\"order_number\", { length: 20 }).notNull().unique(),\n  \n  // Parties involved\n  buyerId: varchar(\"buyer_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  sellerId: varchar(\"seller_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  productId: varchar(\"product_id\").references(() => products.id, { onDelete: \"set null\" }),\n  \n  // Pricing breakdown\n  itemPrice: decimal(\"item_price\", { precision: 10, scale: 2 }).notNull(),\n  platformFee: decimal(\"platform_fee\", { precision: 10, scale: 2 }).notNull().default(\"0.00\"),\n  paymentFee: decimal(\"payment_fee\", { precision: 10, scale: 2 }).notNull().default(\"0.00\"),\n  deliveryFee: decimal(\"delivery_fee\", { precision: 10, scale: 2 }).default(\"0.00\"),\n  totalAmount: decimal(\"total_amount\", { precision: 10, scale: 2 }).notNull(),\n  sellerEarnings: decimal(\"seller_earnings\", { precision: 10, scale: 2 }).notNull(),\n  \n  // Negotiation reference (if negotiated)\n  negotiationId: varchar(\"negotiation_id\").references(() => negotiations.id, { onDelete: \"set null\" }),\n  \n  // Order status\n  status: orderStatusEnum(\"status\").notNull().default(\"pending\"),\n  \n  // Delivery details\n  deliveryMethod: deliveryMethodEnum(\"delivery_method\").default(\"campus_meetup\"),\n  deliveryAddress: text(\"delivery_address\"),\n  deliveryLocation: varchar(\"delivery_location\"),\n  deliveryNotes: text(\"delivery_notes\"),\n  \n  // Timeline tracking\n  paidAt: timestamp(\"paid_at\"),\n  sellerConfirmedAt: timestamp(\"seller_confirmed_at\"),\n  preparingAt: timestamp(\"preparing_at\"),\n  readyAt: timestamp(\"ready_at\"),\n  shippedAt: timestamp(\"shipped_at\"),\n  outForDeliveryAt: timestamp(\"out_for_delivery_at\"),\n  deliveredAt: timestamp(\"delivered_at\"),\n  buyerConfirmedAt: timestamp(\"buyer_confirmed_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  cancelledAt: timestamp(\"cancelled_at\"),\n  \n  // Cancellation/dispute info\n  cancelledBy: varchar(\"cancelled_by\").references(() => users.id, { onDelete: \"set null\" }),\n  cancellationReason: text(\"cancellation_reason\"),\n  \n  // Payment tracking\n  paymentReference: varchar(\"payment_reference\"),\n  escrowTransactionId: varchar(\"escrow_transaction_id\").references(() => escrowTransactions.id, { onDelete: \"set null\" }),\n  \n  // Timestamps\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_orders_buyer\").on(table.buyerId),\n  index(\"idx_orders_seller\").on(table.sellerId),\n  index(\"idx_orders_status\").on(table.status),\n  index(\"idx_orders_created\").on(table.createdAt),\n  index(\"idx_orders_number\").on(table.orderNumber),\n]);\n\n// Order status history for tracking all status changes\nexport const orderStatusHistory = pgTable(\"order_status_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  orderId: varchar(\"order_id\").notNull().references(() => orders.id, { onDelete: \"cascade\" }),\n  fromStatus: orderStatusEnum(\"from_status\"),\n  toStatus: orderStatusEnum(\"to_status\").notNull(),\n  changedBy: varchar(\"changed_by\").references(() => users.id, { onDelete: \"set null\" }),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_order_status_history_order\").on(table.orderId),\n  index(\"idx_order_status_history_created\").on(table.createdAt),\n]);\n\n// Notification types\nexport const notificationTypeEnum = pgEnum(\"notification_type\", [\n  \"message\", \"sale\", \"purchase\", \"review\", \"follow\", \"product_update\", \n  \"announcement\", \"dispute\", \"verification_approved\", \"verification_rejected\",\n  \"escrow_released\", \"wallet_credit\", \"boost_expired\", \"price_alert\",\n  \"negotiation_offer\", \"negotiation_accepted\", \"negotiation_rejected\", \"negotiation_countered\",\n  \"order_placed\", \"order_confirmed\", \"order_shipped\", \"order_delivered\", \"order_completed\", \"order_cancelled\",\n  \"welcome\", \"story_reaction\"\n]);\n\n// Notifications for real time updates\nexport const notifications = pgTable(\"notifications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  type: notificationTypeEnum(\"type\").notNull(),\n  title: varchar(\"title\", { length: 200 }).notNull(),\n  message: text(\"message\").notNull(),\n  link: varchar(\"link\"), // Where to navigate when clicked\n  isRead: boolean(\"is_read\").default(false),\n  relatedUserId: varchar(\"related_user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  relatedProductId: varchar(\"related_product_id\").references(() => products.id, { onDelete: \"set null\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_user_notifications\").on(table.userId, table.isRead),\n]);\n\n// Announcement category enum\nexport const announcementCategoryEnum = pgEnum(\"announcement_category\", [\"update\", \"feature\", \"alert\"]);\n\n// Announcement priority enum\nexport const announcementPriorityEnum = pgEnum(\"announcement_priority\", [\"low\", \"normal\", \"high\"]);\n\n// Marketplace announcements (admin-only for Campus Updates)\nexport const announcements = pgTable(\"announcements\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  authorId: varchar(\"author_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  title: varchar(\"title\", { length: 200 }).notNull(),\n  content: text(\"content\").notNull(),\n  category: announcementCategoryEnum(\"category\").notNull().default(\"update\"),\n  priority: announcementPriorityEnum(\"priority\").notNull().default(\"normal\"),\n  isPinned: boolean(\"is_pinned\").default(false),\n  isPublished: boolean(\"is_published\").default(true),\n  views: integer(\"views\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_announcements_published\").on(table.isPublished, table.createdAt),\n]);\n\n// Track which users have read which announcements\nexport const announcementReads = pgTable(\"announcement_reads\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  announcementId: varchar(\"announcement_id\").notNull().references(() => announcements.id, { onDelete: \"cascade\" }),\n  readAt: timestamp(\"read_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_announcement_reads_user\").on(table.userId, table.announcementId),\n]);\n\n// Relations\nexport const usersRelations = relations(users, ({ one, many }) => ({\n  products: many(products),\n  sentMessages: many(messages, { relationName: \"sentMessages\" }),\n  receivedMessages: many(messages, { relationName: \"receivedMessages\" }),\n  givenReviews: many(reviews, { relationName: \"givenReviews\" }),\n  receivedReviews: many(reviews, { relationName: \"receivedReviews\" }),\n  watchlist: many(watchlist),\n  wallet: one(wallets),\n  welcomeBonus: one(welcomeBonuses),\n  loginStreak: one(loginStreaks),\n  sellerAnalytics: one(sellerAnalytics),\n  referralsMade: many(referrals, { relationName: \"referralsMade\" }),\n  referralsReceived: many(referrals, { relationName: \"referralsReceived\" }),\n  savedSearches: many(savedSearches),\n  draftProducts: many(draftProducts),\n  scheduledPosts: many(scheduledPosts),\n  voicePosts: many(voicePosts),\n  boostRequests: many(boostRequests),\n  disputes: many(disputes),\n  supportTickets: many(supportTickets),\n}));\n\nexport const productsRelations = relations(products, ({ one, many }) => ({\n  seller: one(users, {\n    fields: [products.sellerId],\n    references: [users.id],\n  }),\n  category: one(categories, {\n    fields: [products.categoryId],\n    references: [categories.id],\n  }),\n  messages: many(messages),\n  reviews: many(reviews),\n  watchlist: many(watchlist),\n}));\n\nexport const categoriesRelations = relations(categories, ({ many }) => ({\n  products: many(products),\n}));\n\nexport const messagesRelations = relations(messages, ({ one }) => ({\n  sender: one(users, {\n    fields: [messages.senderId],\n    references: [users.id],\n    relationName: \"sentMessages\",\n  }),\n  receiver: one(users, {\n    fields: [messages.receiverId],\n    references: [users.id],\n    relationName: \"receivedMessages\",\n  }),\n  product: one(products, {\n    fields: [messages.productId],\n    references: [products.id],\n  }),\n}));\n\nexport const reviewsRelations = relations(reviews, ({ one }) => ({\n  reviewer: one(users, {\n    fields: [reviews.reviewerId],\n    references: [users.id],\n    relationName: \"givenReviews\",\n  }),\n  reviewedUser: one(users, {\n    fields: [reviews.reviewedUserId],\n    references: [users.id],\n    relationName: \"receivedReviews\",\n  }),\n  product: one(products, {\n    fields: [reviews.productId],\n    references: [products.id],\n  }),\n}));\n\nexport const watchlistRelations = relations(watchlist, ({ one }) => ({\n  user: one(users, {\n    fields: [watchlist.userId],\n    references: [users.id],\n  }),\n  product: one(products, {\n    fields: [watchlist.productId],\n    references: [products.id],\n  }),\n}));\n\nexport const walletsRelations = relations(wallets, ({ one, many }) => ({\n  user: one(users, {\n    fields: [wallets.userId],\n    references: [users.id],\n  }),\n  transactions: many(transactions),\n}));\n\nexport const transactionsRelations = relations(transactions, ({ one }) => ({\n  wallet: one(wallets, {\n    fields: [transactions.walletId],\n    references: [wallets.id],\n  }),\n  relatedProduct: one(products, {\n    fields: [transactions.relatedProductId],\n    references: [products.id],\n  }),\n  relatedUser: one(users, {\n    fields: [transactions.relatedUserId],\n    references: [users.id],\n  }),\n}));\n\nexport const referralsRelations = relations(referrals, ({ one }) => ({\n  referrer: one(users, {\n    fields: [referrals.referrerId],\n    references: [users.id],\n    relationName: \"referralsMade\",\n  }),\n  referredUser: one(users, {\n    fields: [referrals.referredUserId],\n    references: [users.id],\n    relationName: \"referralsReceived\",\n  }),\n}));\n\nexport const welcomeBonusesRelations = relations(welcomeBonuses, ({ one }) => ({\n  user: one(users, {\n    fields: [welcomeBonuses.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const savedSearchesRelations = relations(savedSearches, ({ one }) => ({\n  user: one(users, {\n    fields: [savedSearches.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const draftProductsRelations = relations(draftProducts, ({ one }) => ({\n  seller: one(users, {\n    fields: [draftProducts.sellerId],\n    references: [users.id],\n  }),\n}));\n\nexport const scheduledPostsRelations = relations(scheduledPosts, ({ one }) => ({\n  seller: one(users, {\n    fields: [scheduledPosts.sellerId],\n    references: [users.id],\n  }),\n  publishedProduct: one(products, {\n    fields: [scheduledPosts.publishedProductId],\n    references: [products.id],\n  }),\n}));\n\nexport const voicePostsRelations = relations(voicePosts, ({ one }) => ({\n  user: one(users, {\n    fields: [voicePosts.userId],\n    references: [users.id],\n  }),\n  product: one(products, {\n    fields: [voicePosts.productId],\n    references: [products.id],\n  }),\n}));\n\nexport const boostRequestsRelations = relations(boostRequests, ({ one }) => ({\n  product: one(products, {\n    fields: [boostRequests.productId],\n    references: [products.id],\n  }),\n  seller: one(users, {\n    fields: [boostRequests.sellerId],\n    references: [users.id],\n  }),\n}));\n\nexport const disputesRelations = relations(disputes, ({ one }) => ({\n  product: one(products, {\n    fields: [disputes.productId],\n    references: [products.id],\n  }),\n  buyer: one(users, {\n    fields: [disputes.buyerId],\n    references: [users.id],\n  }),\n  seller: one(users, {\n    fields: [disputes.sellerId],\n    references: [users.id],\n  }),\n}));\n\nexport const supportTicketsRelations = relations(supportTickets, ({ one }) => ({\n  user: one(users, {\n    fields: [supportTickets.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const loginStreaksRelations = relations(loginStreaks, ({ one }) => ({\n  user: one(users, {\n    fields: [loginStreaks.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const sellerAnalyticsRelations = relations(sellerAnalytics, ({ one }) => ({\n  seller: one(users, {\n    fields: [sellerAnalytics.sellerId],\n    references: [users.id],\n  }),\n}));\n\n// Zod schemas for validation\nexport const upsertUserSchema = createInsertSchema(users).pick({\n  id: true,\n  email: true,\n  firstName: true,\n  lastName: true,\n  profileImageUrl: true,\n});\n\nexport const updateUserProfileSchema = createInsertSchema(users).pick({\n  firstName: true,\n  lastName: true,\n  phoneNumber: true,\n  location: true,\n  bio: true,\n  profileImageUrl: true,\n  gender: true,\n  instagramHandle: true,\n  tiktokHandle: true,\n}).partial();\n\nexport const insertProductSchema = createInsertSchema(products, {\n  title: z.string().min(3, \"Title must be at least 3 characters\").max(200, \"Title must be less than 200 characters\"),\n  description: z.string().min(10, \"Description must be at least 10 characters\"),\n  categoryId: z.string().min(1, \"Please select a category\"),\n  price: z.string().min(1, \"Price is required\").refine(\n    (val) => !isNaN(parseFloat(val)) && parseFloat(val) >= 0,\n    \"Please enter a valid price\"\n  ),\n  originalPrice: z.string().optional().nullable().refine(\n    (val) => !val || (!isNaN(parseFloat(val)) && parseFloat(val) >= 0),\n    \"Please enter a valid original price\"\n  ),\n  isOnSale: z.boolean().optional().default(false),\n  condition: z.enum([\"new\", \"like_new\", \"good\", \"fair\"]).default(\"good\"),\n  location: z.string().optional().nullable(),\n  images: z.array(z.string()).optional().default([]),\n  isAvailable: z.boolean().optional().default(true),\n  isSold: z.boolean().optional().default(false),\n  isFeatured: z.boolean().optional().default(false),\n  isBoosted: z.boolean().optional().default(false),\n  boostedUntil: z.date().optional().nullable(),\n  inquiries: z.number().optional().default(0),\n}).omit({\n  id: true,\n  sellerId: true,\n  createdAt: true,\n  updatedAt: true,\n  views: true,\n  watchers: true,\n  isApproved: true,\n  isFlagged: true,\n  flagReason: true,\n});\n\nexport const updateProductSchema = insertProductSchema.partial();\n\nexport const insertCategorySchema = createInsertSchema(categories).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertMessageSchema = createInsertSchema(messages).omit({\n  id: true,\n  createdAt: true,\n  isRead: true,\n});\n\nexport const insertReviewSchema = createInsertSchema(reviews).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertReportSchema = createInsertSchema(reports).omit({\n  id: true,\n  createdAt: true,\n  status: true,\n});\n\nexport const insertWatchlistSchema = createInsertSchema(watchlist).omit({\n  id: true,\n  createdAt: true,\n});\n\n// Additional Zod schemas for new features\nexport const insertWalletSchema = createInsertSchema(wallets).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertTransactionSchema = createInsertSchema(transactions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertReferralSchema = createInsertSchema(referrals).omit({\n  id: true,\n  createdAt: true,\n  bonusPaid: true,\n});\n\nexport const insertWelcomeBonusSchema = createInsertSchema(welcomeBonuses).omit({\n  id: true,\n  createdAt: true,\n  claimed: true,\n});\n\nexport const insertSavedSearchSchema = createInsertSchema(savedSearches).omit({\n  id: true,\n  createdAt: true,\n  lastAlertSent: true,\n});\n\nexport const insertDraftProductSchema = createInsertSchema(draftProducts).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertScheduledPostSchema = createInsertSchema(scheduledPosts).omit({\n  id: true,\n  createdAt: true,\n  published: true,\n  publishedProductId: true,\n});\n\nexport const insertVoicePostSchema = createInsertSchema(voicePosts).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertBoostRequestSchema = createInsertSchema(boostRequests).omit({\n  id: true,\n  createdAt: true,\n  status: true,\n});\n\nexport const insertDisputeSchema = createInsertSchema(disputes).omit({\n  id: true,\n  createdAt: true,\n  resolvedAt: true,\n  status: true,\n  resolution: true,\n  resolvedBy: true,\n});\n\nexport const insertSupportTicketSchema = createInsertSchema(supportTickets).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  status: true,\n  assignedTo: true,\n  response: true,\n});\n\n// API-specific validation schemas\n// Role update schema - allows switching between buyer or seller only\nexport const roleUpdateSchema = z.object({\n  role: z.enum(['buyer', 'seller']),\n});\n\nexport const createReferralSchema = z.object({\n  referredUserId: z.string().min(1, \"Referred user ID is required\"),\n});\n\nexport const createSavedSearchSchema = insertSavedSearchSchema.extend({\n  query: z.string().min(1, \"Search query is required\"),\n});\n\nexport const saveDraftSchema = z.object({\n  title: z.string().min(1, \"Title is required\"),\n  description: z.string().optional(),\n  price: z.string().optional(),\n  category: z.string().optional(),\n  images: z.array(z.string()).optional(),\n  formData: z.record(z.any()).optional(),\n});\n\nexport const createScheduledPostSchema = insertScheduledPostSchema.extend({\n  productData: z.record(z.any()),\n});\n\nexport const createBoostSchema = z.object({\n  productId: z.string().min(1, \"Product ID is required\"),\n  type: z.enum(['boost', 'featured']),\n  duration: z.coerce.number().min(1).max(168), // Max 1 week\n  amount: z.string().regex(/^\\d+(\\.\\d{1,2})?$/, \"Invalid amount format. Use numbers only (e.g., 500.00)\"),\n});\n\nexport const createDisputeSchema = insertDisputeSchema.extend({\n  reason: z.string().min(10, \"Please provide details (minimum 10 characters)\"),\n});\n\nexport const createSupportTicketSchema = insertSupportTicketSchema.extend({\n  subject: z.string().min(5, \"Subject must be at least 5 characters\"),\n  message: z.string().min(20, \"Please provide more details (minimum 20 characters)\"),\n});\n\n// TypeScript types\nexport type UpsertUser = z.infer<typeof upsertUserSchema>;\nexport type User = typeof users.$inferSelect;\nexport type InsertProduct = z.infer<typeof insertProductSchema>;\nexport type UpdateProduct = z.infer<typeof updateProductSchema>;\nexport type Product = typeof products.$inferSelect;\nexport type ProductView = typeof productViews.$inferSelect;\nexport type Category = typeof categories.$inferSelect;\nexport type InsertCategory = z.infer<typeof insertCategorySchema>;\nexport type Message = typeof messages.$inferSelect;\nexport type InsertMessage = z.infer<typeof insertMessageSchema>;\nexport type Review = typeof reviews.$inferSelect;\nexport type InsertReview = z.infer<typeof insertReviewSchema>;\nexport type Report = typeof reports.$inferSelect;\nexport type InsertReport = z.infer<typeof insertReportSchema>;\nexport type Watchlist = typeof watchlist.$inferSelect;\nexport type InsertWatchlist = z.infer<typeof insertWatchlistSchema>;\n\n// New feature types\nexport type Wallet = typeof wallets.$inferSelect;\nexport type InsertWallet = z.infer<typeof insertWalletSchema>;\nexport type Transaction = typeof transactions.$inferSelect;\nexport type InsertTransaction = z.infer<typeof insertTransactionSchema>;\nexport type Referral = typeof referrals.$inferSelect;\nexport type InsertReferral = z.infer<typeof insertReferralSchema>;\nexport type WelcomeBonus = typeof welcomeBonuses.$inferSelect;\nexport type InsertWelcomeBonus = z.infer<typeof insertWelcomeBonusSchema>;\nexport type SearchHistory = typeof searchHistory.$inferSelect;\nexport type SavedSearch = typeof savedSearches.$inferSelect;\nexport type InsertSavedSearch = z.infer<typeof insertSavedSearchSchema>;\nexport type DraftProduct = typeof draftProducts.$inferSelect;\nexport type InsertDraftProduct = z.infer<typeof insertDraftProductSchema>;\nexport type ScheduledPost = typeof scheduledPosts.$inferSelect;\nexport type InsertScheduledPost = z.infer<typeof insertScheduledPostSchema>;\nexport type VoicePost = typeof voicePosts.$inferSelect;\nexport type InsertVoicePost = z.infer<typeof insertVoicePostSchema>;\nexport type BoostRequest = typeof boostRequests.$inferSelect;\nexport type InsertBoostRequest = z.infer<typeof insertBoostRequestSchema>;\nexport type Dispute = typeof disputes.$inferSelect;\nexport type InsertDispute = z.infer<typeof insertDisputeSchema>;\nexport type SupportTicket = typeof supportTickets.$inferSelect;\nexport type InsertSupportTicket = z.infer<typeof insertSupportTicketSchema>;\nexport type TicketReply = typeof ticketReplies.$inferSelect;\nexport type LoginStreak = typeof loginStreaks.$inferSelect;\nexport type SellerAnalytics = typeof sellerAnalytics.$inferSelect;\nexport type Follow = typeof follows.$inferSelect;\nexport type InsertFollow = z.infer<typeof insertFollowSchema>;\n\n// Zod schemas for follows\nexport const insertFollowSchema = createInsertSchema(follows).omit({\n  id: true,\n  createdAt: true,\n});\n\n// Zod schemas for ticket replies\nexport const insertTicketReplySchema = createInsertSchema(ticketReplies).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const createTicketReplySchema = z.object({\n  ticketId: z.string().min(1, \"Ticket ID is required\"),\n  message: z.string().min(5, \"Reply must be at least 5 characters\"),\n});\n\nexport type InsertTicketReply = z.infer<typeof insertTicketReplySchema>;\nexport type CreateTicketReplyInput = z.infer<typeof createTicketReplySchema>;\n\n// Zod schemas for new tables\nexport const insertHostelSchema = createInsertSchema(hostels).omit({\n  id: true,\n  agentId: true,\n  views: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertEventSchema = createInsertSchema(events).omit({\n  id: true,\n  organizerId: true,\n  views: true,\n  ticketsSold: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertEscrowTransactionSchema = createInsertSchema(escrowTransactions).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  releasedAt: true,\n  status: true,\n});\n\n// Squad insert schemas\nexport const insertSquadPaymentSchema = createInsertSchema(squadPayments).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertSquadTransferSchema = createInsertSchema(squadTransfers).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertNegotiationSchema = createInsertSchema(negotiations).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  acceptedAt: true,\n  rejectedAt: true,\n});\n\nexport const insertWithdrawalSchema = createInsertSchema(withdrawals).omit({\n  id: true,\n  createdAt: true,\n  status: true,\n  processedAt: true,\n});\n\nexport const insertNotificationSchema = createInsertSchema(notifications).omit({\n  id: true,\n  createdAt: true,\n  isRead: true,\n});\n\nexport const insertAnnouncementSchema = createInsertSchema(announcements).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  views: true,\n});\n\nexport const insertAnnouncementReadSchema = createInsertSchema(announcementReads).omit({\n  id: true,\n  readAt: true,\n});\n\nexport const createAnnouncementSchema = z.object({\n  title: z.string().min(3, \"Title must be at least 3 characters\").max(200),\n  content: z.string().min(10, \"Content must be at least 10 characters\"),\n  category: z.enum([\"update\", \"feature\", \"alert\"]),\n  priority: z.enum([\"low\", \"normal\", \"high\"]).optional().default(\"normal\"),\n  isPinned: z.boolean().optional().default(false),\n  isPublished: z.boolean().optional().default(true),\n});\n\nexport const updateAnnouncementSchema = createAnnouncementSchema.partial();\n\n// API-specific schemas for new features\nexport const createHostelSchema = insertHostelSchema.extend({\n  title: z.string().min(5, \"Title must be at least 5 characters\"),\n  price: z.string().regex(/^\\d+(\\.\\d{1,2})?$/, \"Invalid price format\"),\n});\n\nexport const createEventSchema = insertEventSchema.extend({\n  title: z.string().min(5, \"Title must be at least 5 characters\"),\n  eventDate: z.coerce.date(),\n});\n\nexport const createEscrowSchema = z.object({\n  sellerId: z.string(),\n  productId: z.string().optional(),\n  hostelId: z.string().optional(),\n  amount: z.string().regex(/^\\d+(\\.\\d{1,2})?$/, \"Invalid amount\"),\n  platformFeePercentage: z.number().min(3).max(6).default(5),\n});\n\nexport const verifyNINSchema = z.object({\n  nin: z.string().length(11, \"NIN must be exactly 11 digits\"),\n  selfieBase64: z.string().min(1, \"Selfie image is required\"),\n});\n\nexport const updateSocialMediaSchema = z.object({\n  instagramHandle: z.string().optional(),\n  tiktokHandle: z.string().optional(),\n  facebookProfile: z.string().optional(),\n});\n\nexport const initiateWithdrawalSchema = insertWithdrawalSchema.extend({\n  amount: z.string().regex(/^\\d+(\\.\\d{1,2})?$/, \"Invalid amount\"),\n  bankCode: z.string().min(1, \"Bank code is required\").optional(),\n  bankName: z.string().min(1, \"Bank name is required\"),\n  accountNumber: z.string().min(10, \"Invalid account number\"),\n  accountName: z.string().min(1, \"Account name is required\"),\n});\n\n// Negotiation API schemas\nexport const createNegotiationSchema = z.object({\n  productId: z.string().min(1, \"Product ID is required\"),\n  offerPrice: z.string().regex(/^\\d+(\\.\\d{1,2})?$/, \"Invalid offer price\"),\n  message: z.string().max(500).optional(),\n});\n\nexport const respondToNegotiationSchema = z.object({\n  negotiationId: z.string().min(1, \"Negotiation ID is required\"),\n  action: z.enum([\"accept\", \"reject\", \"counter\"]),\n  counterOfferPrice: z.string().regex(/^\\d+(\\.\\d{1,2})?$/, \"Invalid counter offer price\").optional(),\n  message: z.string().max(500).optional(),\n});\n\n// Squad payment initialization schema\nexport const initiateSquadPaymentSchema = z.object({\n  amount: z.string().regex(/^\\d+(\\.\\d{1,2})?$/, \"Invalid amount\"),\n  purpose: z.enum([\"wallet_deposit\", \"boost_payment\", \"featured_payment\", \"escrow_payment\", \"checkout_payment\"]),\n  paymentDescription: z.string().max(200).optional(),\n  paymentChannel: z.enum([\"transfer\", \"card\", \"ussd\"]).optional(),\n});\n\n// Seller verification request schema\nexport const requestVerificationSchema = z.object({\n  studentIdImage: z.string().min(1, \"Student ID image is required\"),\n  selfieImage: z.string().min(1, \"Selfie image is required\"),\n});\n\n// Admin verification review schema\nexport const reviewVerificationSchema = z.object({\n  userId: z.string().min(1, \"User ID is required\"),\n  approved: z.boolean(),\n  notes: z.string().max(500).optional(),\n});\n\n// Squad types\nexport type SquadPayment = typeof squadPayments.$inferSelect;\nexport type InsertSquadPayment = z.infer<typeof insertSquadPaymentSchema>;\nexport type SquadTransfer = typeof squadTransfers.$inferSelect;\nexport type InsertSquadTransfer = z.infer<typeof insertSquadTransferSchema>;\n\n// Negotiation types\nexport type Negotiation = typeof negotiations.$inferSelect;\nexport type InsertNegotiation = z.infer<typeof insertNegotiationSchema>;\n\n// Game type and status enums\nexport const gameTypeEnum = pgEnum(\"game_type\", [\"ludo\", \"word_battle\", \"trivia\", \"whot\", \"quick_draw\", \"speed_typing\", \"campus_bingo\", \"truth_or_dare\", \"guess_the_price\", \"aviator\", \"colour_colour\", \"spin_wheel\", \"draughts\", \"ayo_olopon\", \"dice_duel\"]);\nexport const gameStatusEnum = pgEnum(\"game_status\", [\"waiting\", \"in_progress\", \"completed\", \"cancelled\"]);\nexport const gameModeEnum = pgEnum(\"game_mode\", [\"single_player\", \"multiplayer\"]);\n\n// Game leaderboard/scores table\nexport const gameScores = pgTable(\"game_scores\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  gameType: gameTypeEnum(\"game_type\").notNull(),\n  totalScore: integer(\"total_score\").default(0).notNull(),\n  gamesPlayed: integer(\"games_played\").default(0).notNull(),\n  gamesWon: integer(\"games_won\").default(0).notNull(),\n  highScore: integer(\"high_score\").default(0),\n  totalEarnings: decimal(\"total_earnings\", { precision: 10, scale: 2 }).default(\"0.00\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_game_scores_user\").on(table.userId),\n  index(\"idx_game_scores_type\").on(table.gameType),\n  index(\"idx_game_scores_total\").on(table.totalScore),\n]);\n\n// Trivia questions table\nexport const triviaQuestions = pgTable(\"trivia_questions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  question: text(\"question\").notNull(),\n  options: text(\"options\").array().notNull(),\n  correctAnswer: integer(\"correct_answer\").notNull(),\n  category: varchar(\"category\", { length: 100 }),\n  difficulty: varchar(\"difficulty\", { length: 20 }).default(\"medium\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Word lists for word battle\nexport const wordLists = pgTable(\"word_lists\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  word: varchar(\"word\", { length: 50 }).notNull().unique(),\n  difficulty: varchar(\"difficulty\", { length: 20 }).default(\"medium\"),\n  category: varchar(\"category\", { length: 100 }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Speed typing texts\nexport const typingTexts = pgTable(\"typing_texts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  text: text(\"text\").notNull(),\n  difficulty: varchar(\"difficulty\", { length: 20 }).default(\"medium\"),\n  wordCount: integer(\"word_count\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Price guess products for Guess the Price game\nexport const priceGuessProducts = pgTable(\"price_guess_products\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\", { length: 200 }).notNull(),\n  imageUrl: text(\"image_url\"),\n  actualPrice: decimal(\"actual_price\", { precision: 10, scale: 2 }).notNull(),\n  category: varchar(\"category\", { length: 100 }),\n  difficulty: varchar(\"difficulty\", { length: 20 }).default(\"medium\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Games/Lobbies table\nexport const games = pgTable(\"games\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  gameType: gameTypeEnum(\"game_type\").notNull(),\n  player1Id: varchar(\"player1_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  player2Id: varchar(\"player2_id\").references(() => users.id, { onDelete: \"cascade\" }),\n  stakeAmount: decimal(\"stake_amount\", { precision: 10, scale: 2 }).notNull(),\n  status: gameStatusEnum(\"status\").notNull().default(\"waiting\"),\n  winnerId: varchar(\"winner_id\").references(() => users.id, { onDelete: \"set null\" }),\n  gameData: jsonb(\"game_data\"), // Store game-specific state\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n});\n\n// Game matches for tracking individual rounds/matches within a game\nexport const gameMatches = pgTable(\"game_matches\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  gameId: varchar(\"game_id\").notNull().references(() => games.id, { onDelete: \"cascade\" }),\n  roundNumber: integer(\"round_number\").notNull().default(1),\n  player1Score: integer(\"player1_score\").default(0),\n  player2Score: integer(\"player2_score\").default(0),\n  roundData: jsonb(\"round_data\"), // Store round-specific data\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Insert schemas for games\nexport const insertGameSchema = createInsertSchema(games).omit({\n  id: true,\n  createdAt: true,\n  startedAt: true,\n  completedAt: true,\n});\n\nexport const insertGameMatchSchema = createInsertSchema(gameMatches).omit({\n  id: true,\n  createdAt: true,\n});\n\n// TypeScript types for games\nexport type Game = typeof games.$inferSelect;\nexport type InsertGame = z.infer<typeof insertGameSchema>;\nexport type GameMatch = typeof gameMatches.$inferSelect;\nexport type InsertGameMatch = z.infer<typeof insertGameMatchSchema>;\n\n// Insert schemas for game content tables\nexport const insertGameScoreSchema = createInsertSchema(gameScores).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertTriviaQuestionSchema = createInsertSchema(triviaQuestions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertTypingTextSchema = createInsertSchema(typingTexts).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertPriceGuessProductSchema = createInsertSchema(priceGuessProducts).omit({\n  id: true,\n  createdAt: true,\n});\n\n// TypeScript types for game content tables\nexport type GameScore = typeof gameScores.$inferSelect;\nexport type InsertGameScore = z.infer<typeof insertGameScoreSchema>;\nexport type TriviaQuestion = typeof triviaQuestions.$inferSelect;\nexport type InsertTriviaQuestion = z.infer<typeof insertTriviaQuestionSchema>;\nexport type TypingText = typeof typingTexts.$inferSelect;\nexport type InsertTypingText = z.infer<typeof insertTypingTextSchema>;\nexport type PriceGuessProduct = typeof priceGuessProducts.$inferSelect;\nexport type InsertPriceGuessProduct = z.infer<typeof insertPriceGuessProductSchema>;\n\n// API schemas for games\nexport const createGameSchema = z.object({\n  gameType: z.enum([\"ludo\", \"word_battle\", \"trivia\", \"whot\", \"quick_draw\", \"speed_typing\", \"campus_bingo\", \"truth_or_dare\", \"guess_the_price\", \"aviator\", \"colour_colour\", \"spin_wheel\", \"draughts\", \"ayo_olopon\", \"dice_duel\"]),\n  stakeAmount: z.string().regex(/^\\d+(\\.\\d{1,2})?$/, \"Invalid stake amount\"),\n  mode: z.enum([\"single_player\", \"multiplayer\"]).optional().default(\"multiplayer\"),\n});\n\nexport const joinGameSchema = z.object({\n  gameId: z.string(),\n});\n\nexport const completeGameSchema = z.object({\n  winnerId: z.string(),\n});\n\n// Reply restriction enum - who can reply to posts (Twitter/X style)\nexport const replyRestrictionEnum = pgEnum(\"reply_restriction\", [\"everyone\", \"verified\", \"followers\", \"mentioned\"]);\n\n// Social feed posts (\"The Plug\")\nexport const socialPosts = pgTable(\"social_posts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  authorId: varchar(\"author_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  content: text(\"content\").notNull(),\n  images: text(\"images\").array().default(sql`ARRAY[]::text[]`),\n  videos: text(\"videos\").array().default(sql`ARRAY[]::text[]`),\n  likesCount: integer(\"likes_count\").default(0),\n  commentsCount: integer(\"comments_count\").default(0),\n  repostsCount: integer(\"reposts_count\").default(0),\n  sharesCount: integer(\"shares_count\").default(0), // Share/copy link count\n  viewsCount: integer(\"views_count\").default(0), // Post impressions\n  replyRestriction: replyRestrictionEnum(\"reply_restriction\").default(\"everyone\"), // Who can reply\n  mentionedUserIds: text(\"mentioned_user_ids\").array().default(sql`ARRAY[]::text[]`), // Users mentioned in post\n  hashtags: text(\"hashtags\").array().default(sql`ARRAY[]::text[]`), // Extracted hashtags\n  isPinned: boolean(\"is_pinned\").default(false), // Pinned to profile\n  isFromSystemAccount: boolean(\"is_from_system_account\").default(false), // Posted by @EKSUPlug\n  isVisible: boolean(\"is_visible\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_social_posts_author\").on(table.authorId),\n  index(\"idx_social_posts_created\").on(table.createdAt),\n  index(\"idx_social_posts_system\").on(table.isFromSystemAccount),\n]);\n\n// Social post likes\nexport const socialPostLikes = pgTable(\"social_post_likes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  postId: varchar(\"post_id\").notNull().references(() => socialPosts.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_post_likes_post\").on(table.postId),\n  index(\"idx_post_likes_user\").on(table.userId),\n]);\n\n// Social post comments\nexport const socialPostComments = pgTable(\"social_post_comments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  postId: varchar(\"post_id\").notNull().references(() => socialPosts.id, { onDelete: \"cascade\" }),\n  authorId: varchar(\"author_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  content: text(\"content\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_post_comments_post\").on(table.postId),\n]);\n\n// Social post reposts (Twitter-like repost/retweet functionality)\nexport const socialPostReposts = pgTable(\"social_post_reposts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  originalPostId: varchar(\"original_post_id\").notNull().references(() => socialPosts.id, { onDelete: \"cascade\" }),\n  reposterId: varchar(\"reposter_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  quoteContent: text(\"quote_content\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_reposts_original_post\").on(table.originalPostId),\n  index(\"idx_reposts_reposter\").on(table.reposterId),\n]);\n\n// Social post reports\nexport const socialPostReports = pgTable(\"social_post_reports\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  postId: varchar(\"post_id\").notNull().references(() => socialPosts.id, { onDelete: \"cascade\" }),\n  reporterId: varchar(\"reporter_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  reason: varchar(\"reason\", { length: 100 }).notNull(),\n  description: text(\"description\"),\n  status: varchar(\"status\", { length: 20 }).default(\"pending\"),\n  reviewedBy: varchar(\"reviewed_by\").references(() => users.id),\n  reviewedAt: timestamp(\"reviewed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_post_reports_post\").on(table.postId),\n  index(\"idx_post_reports_reporter\").on(table.reporterId),\n]);\n\nexport type SocialPostReport = typeof socialPostReports.$inferSelect;\nexport type InsertSocialPostReport = typeof socialPostReports.$inferInsert;\n\n// Blocked users table - for user blocking functionality\nexport const blockedUsers = pgTable(\"blocked_users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  blockerId: varchar(\"blocker_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  blockedId: varchar(\"blocked_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  reason: text(\"reason\"), // Optional reason for blocking\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_blocked_blocker\").on(table.blockerId),\n  index(\"idx_blocked_blocked\").on(table.blockedId),\n]);\n\n// Post bookmarks (saved posts)\nexport const postBookmarks = pgTable(\"post_bookmarks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  postId: varchar(\"post_id\").notNull().references(() => socialPosts.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_bookmarks_user\").on(table.userId),\n  index(\"idx_bookmarks_post\").on(table.postId),\n]);\n\n// Feed algorithm engagement scores\nexport const feedEngagementScores = pgTable(\"feed_engagement_scores\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  postId: varchar(\"post_id\").notNull().references(() => socialPosts.id, { onDelete: \"cascade\" }),\n  engagementScore: decimal(\"engagement_score\", { precision: 10, scale: 4 }).default(\"0\"), // Calculated score\n  velocityScore: decimal(\"velocity_score\", { precision: 10, scale: 4 }).default(\"0\"), // Recent engagement rate\n  recencyBonus: decimal(\"recency_bonus\", { precision: 10, scale: 4 }).default(\"0\"), // Time decay factor\n  calculatedAt: timestamp(\"calculated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_engagement_post\").on(table.postId),\n  index(\"idx_engagement_score\").on(table.engagementScore),\n]);\n\n// Social post views tracking for unique view counts (1 view per user per 24 hours)\nexport const socialPostViews = pgTable(\"social_post_views\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  postId: varchar(\"post_id\").notNull().references(() => socialPosts.id, { onDelete: \"cascade\" }),\n  viewerId: varchar(\"viewer_id\").notNull(), // User ID for logged-in users, or hashed IP+session for guests\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"social_post_views_post_viewer_idx\").on(table.postId, table.viewerId),\n  index(\"social_post_views_post_idx\").on(table.postId),\n]);\n\nexport type SocialPostView = typeof socialPostViews.$inferSelect;\n\n// Insert schemas for social posts\nexport const insertSocialPostSchema = createInsertSchema(socialPosts).omit({\n  id: true,\n  likesCount: true,\n  commentsCount: true,\n  repostsCount: true,\n  sharesCount: true,\n  viewsCount: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\n// Insert schemas for blocked users\nexport const insertBlockedUserSchema = createInsertSchema(blockedUsers).omit({\n  id: true,\n  createdAt: true,\n});\n\n// Insert schemas for post bookmarks\nexport const insertPostBookmarkSchema = createInsertSchema(postBookmarks).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertSocialPostCommentSchema = createInsertSchema(socialPostComments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertSocialPostRepostSchema = createInsertSchema(socialPostReposts).omit({\n  id: true,\n  createdAt: true,\n});\n\n// TypeScript types for social posts\nexport type SocialPost = typeof socialPosts.$inferSelect;\nexport type InsertSocialPost = z.infer<typeof insertSocialPostSchema>;\nexport type SocialPostLike = typeof socialPostLikes.$inferSelect;\nexport type SocialPostComment = typeof socialPostComments.$inferSelect;\nexport type InsertSocialPostComment = z.infer<typeof insertSocialPostCommentSchema>;\nexport type SocialPostRepost = typeof socialPostReposts.$inferSelect;\nexport type InsertSocialPostRepost = z.infer<typeof insertSocialPostRepostSchema>;\nexport type BlockedUser = typeof blockedUsers.$inferSelect;\nexport type InsertBlockedUser = z.infer<typeof insertBlockedUserSchema>;\nexport type PostBookmark = typeof postBookmarks.$inferSelect;\nexport type InsertPostBookmark = z.infer<typeof insertPostBookmarkSchema>;\nexport type FeedEngagementScore = typeof feedEngagementScores.$inferSelect;\n\n// Password reset tokens table\nexport const passwordResetTokens = pgTable(\"password_reset_tokens\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  token: varchar(\"token\").notNull().unique(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  used: boolean(\"used\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Insert schema for password reset tokens\nexport const insertPasswordResetTokenSchema = createInsertSchema(passwordResetTokens).omit({\n  id: true,\n  createdAt: true,\n});\n\n// TypeScript types for password reset tokens\nexport type PasswordResetToken = typeof passwordResetTokens.$inferSelect;\nexport type InsertPasswordResetToken = z.infer<typeof insertPasswordResetTokenSchema>;\n\n// Authentication schemas\n// Note: \"both\" role is deprecated - users must choose buyer OR seller only\nexport const registerSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n  firstName: z.string().min(1, \"First name is required\"),\n  lastName: z.string().min(1, \"Last name is required\"),\n  username: z.string()\n    .min(3, \"Username must be at least 3 characters\")\n    .max(30, \"Username must be at most 30 characters\")\n    .regex(/^[a-zA-Z0-9_]+$/, \"Username can only contain letters, numbers, and underscores\")\n    .transform(val => val.toLowerCase()),\n  phoneNumber: z.string().optional(),\n  role: z.enum([\"buyer\", \"seller\", \"both\"]).optional().default(\"buyer\"),\n  referralCode: z.string().optional(),\n});\n\nexport const loginSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(1, \"Password is required\"),\n});\n\nexport const forgotPasswordSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n});\n\nexport const resetPasswordSchema = z.object({\n  token: z.string().min(1, \"Reset token is required\"),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n});\n\n// TypeScript types for auth\nexport type RegisterInput = z.infer<typeof registerSchema>;\nexport type LoginInput = z.infer<typeof loginSchema>;\nexport type ForgotPasswordInput = z.infer<typeof forgotPasswordSchema>;\nexport type ResetPasswordInput = z.infer<typeof resetPasswordSchema>;\nexport type SafeUser = Omit<User, 'password'>; // User without password field\n\n// Cart item schema and types\nexport const insertCartItemSchema = createInsertSchema(cartItems).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type CartItem = typeof cartItems.$inferSelect;\nexport type InsertCartItem = z.infer<typeof insertCartItemSchema>;\n\n// TypeScript types for new tables\nexport type Hostel = typeof hostels.$inferSelect;\nexport type InsertHostel = z.infer<typeof insertHostelSchema>;\nexport type Event = typeof events.$inferSelect;\nexport type InsertEvent = z.infer<typeof insertEventSchema>;\nexport type EscrowTransaction = typeof escrowTransactions.$inferSelect;\nexport type InsertEscrowTransaction = z.infer<typeof insertEscrowTransactionSchema>;\nexport type Withdrawal = typeof withdrawals.$inferSelect;\nexport type InsertWithdrawal = z.infer<typeof insertWithdrawalSchema>;\nexport type Notification = typeof notifications.$inferSelect;\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\nexport type Announcement = typeof announcements.$inferSelect;\nexport type InsertAnnouncement = z.infer<typeof insertAnnouncementSchema>;\nexport type AnnouncementRead = typeof announcementReads.$inferSelect;\nexport type InsertAnnouncementRead = z.infer<typeof insertAnnouncementReadSchema>;\nexport type CreateAnnouncementInput = z.infer<typeof createAnnouncementSchema>;\nexport type UpdateAnnouncementInput = z.infer<typeof updateAnnouncementSchema>;\n\n// Order insert schemas\nexport const insertOrderSchema = createInsertSchema(orders).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  paidAt: true,\n  sellerConfirmedAt: true,\n  preparingAt: true,\n  readyAt: true,\n  shippedAt: true,\n  outForDeliveryAt: true,\n  deliveredAt: true,\n  buyerConfirmedAt: true,\n  completedAt: true,\n  cancelledAt: true,\n});\n\nexport const insertOrderStatusHistorySchema = createInsertSchema(orderStatusHistory).omit({\n  id: true,\n  createdAt: true,\n});\n\n// Order API schemas\nexport const createOrderSchema = z.object({\n  productId: z.string().min(1, \"Product ID is required\"),\n  deliveryMethod: z.enum([\"pickup\", \"seller_delivery\", \"agent_delivery\", \"campus_meetup\"]).optional().default(\"campus_meetup\"),\n  deliveryAddress: z.string().optional(),\n  deliveryLocation: z.string().optional(),\n  deliveryNotes: z.string().optional(),\n  negotiationId: z.string().optional(),\n});\n\nexport const updateOrderStatusSchema = z.object({\n  orderId: z.string().min(1, \"Order ID is required\"),\n  status: z.enum([\n    \"pending\", \"paid\", \"seller_confirmed\", \"preparing\", \"ready_for_pickup\",\n    \"shipped\", \"out_for_delivery\", \"delivered\", \"buyer_confirmed\", \"completed\",\n    \"cancelled\", \"disputed\", \"refunded\"\n  ]),\n  notes: z.string().optional(),\n});\n\n// Order TypeScript types\nexport type Order = typeof orders.$inferSelect;\nexport type InsertOrder = z.infer<typeof insertOrderSchema>;\nexport type OrderStatusHistory = typeof orderStatusHistory.$inferSelect;\nexport type InsertOrderStatusHistory = z.infer<typeof insertOrderStatusHistorySchema>;\nexport type CreateOrderInput = z.infer<typeof createOrderSchema>;\nexport type UpdateOrderStatusInput = z.infer<typeof updateOrderStatusSchema>;\n\n// User blocks - prevents all interaction\nexport const userBlocks = pgTable(\"user_blocks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  blockerId: varchar(\"blocker_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  blockedId: varchar(\"blocked_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [index(\"user_blocks_blocker_idx\").on(table.blockerId)]);\n\n// User mutes - hides content, user can still message\nexport const userMutes = pgTable(\"user_mutes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  muterId: varchar(\"muter_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  mutedId: varchar(\"muted_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [index(\"user_mutes_muter_idx\").on(table.muterId)]);\n\n// User reports - for admin review\nexport const userReports = pgTable(\"user_reports\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  reporterId: varchar(\"reporter_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  reportedId: varchar(\"reported_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  reason: text(\"reason\").notNull(),\n  description: text(\"description\"),\n  status: varchar(\"status\").notNull().default(\"pending\"),\n  reviewedBy: varchar(\"reviewed_by\").references(() => users.id),\n  reviewedAt: timestamp(\"reviewed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Insert schemas for user blocks, mutes, reports\nexport const insertUserBlockSchema = createInsertSchema(userBlocks).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertUserMuteSchema = createInsertSchema(userMutes).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertUserReportSchema = createInsertSchema(userReports).omit({\n  id: true,\n  createdAt: true,\n  status: true,\n  reviewedBy: true,\n  reviewedAt: true,\n});\n\n// API schema for creating user reports\nexport const createUserReportSchema = z.object({\n  reason: z.enum([\"spam\", \"harassment\", \"scam\", \"inappropriate\", \"other\"]),\n  description: z.string().optional(),\n});\n\n// TypeScript types for user blocks, mutes, reports\nexport type UserBlock = typeof userBlocks.$inferSelect;\nexport type InsertUserBlock = z.infer<typeof insertUserBlockSchema>;\nexport type UserMute = typeof userMutes.$inferSelect;\nexport type InsertUserMute = z.infer<typeof insertUserMuteSchema>;\nexport type UserReport = typeof userReports.$inferSelect;\nexport type InsertUserReport = z.infer<typeof insertUserReportSchema>;\nexport type CreateUserReportInput = z.infer<typeof createUserReportSchema>;\n\n// ===========================================\n// VTU (Virtual Top-Up) DATA SALES SYSTEM\n// ===========================================\n\n// VTU Network enum (MTN SME, GLO CG, Airtel CG)\nexport const vtuNetworkEnum = pgEnum(\"vtu_network\", [\"mtn_sme\", \"glo_cg\", \"airtel_cg\", \"9mobile\"]);\n\n// VTU Transaction status\nexport const vtuStatusEnum = pgEnum(\"vtu_status\", [\"pending\", \"processing\", \"success\", \"failed\", \"refunded\"]);\n\n// VTU Service type\nexport const vtuServiceTypeEnum = pgEnum(\"vtu_service_type\", [\"data\", \"airtime\"]);\n\n// VTU Data Plans - stores available data plans from SMEDATA.NG\nexport const vtuPlans = pgTable(\"vtu_plans\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  network: vtuNetworkEnum(\"network\").notNull(),\n  planName: varchar(\"plan_name\", { length: 100 }).notNull(),\n  dataAmount: varchar(\"data_amount\", { length: 50 }).notNull(), // e.g., \"1GB\", \"2GB\", \"5GB\"\n  validity: varchar(\"validity\", { length: 50 }).notNull(), // e.g., \"30 days\", \"7 days\"\n  costPrice: decimal(\"cost_price\", { precision: 10, scale: 2 }).notNull(), // Price from SMEDATA.NG\n  sellingPrice: decimal(\"selling_price\", { precision: 10, scale: 2 }).notNull(), // Price we sell at\n  planCode: varchar(\"plan_code\", { length: 50 }).notNull(), // SMEDATA.NG plan code\n  isActive: boolean(\"is_active\").default(true),\n  sortOrder: integer(\"sort_order\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"vtu_plans_network_idx\").on(table.network),\n  index(\"vtu_plans_active_idx\").on(table.isActive),\n]);\n\n// VTU Transactions - tracks all data purchases\nexport const vtuTransactions = pgTable(\"vtu_transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  planId: varchar(\"plan_id\").notNull().references(() => vtuPlans.id, { onDelete: \"restrict\" }),\n  network: vtuNetworkEnum(\"network\").notNull(),\n  phoneNumber: varchar(\"phone_number\", { length: 20 }).notNull(), // Recipient phone number\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(), // Amount charged to user\n  costPrice: decimal(\"cost_price\", { precision: 10, scale: 2 }).notNull(), // Our cost from SMEDATA.NG\n  profit: decimal(\"profit\", { precision: 10, scale: 2 }).notNull(), // Profit on this transaction\n  status: vtuStatusEnum(\"status\").notNull().default(\"pending\"),\n  smedataReference: varchar(\"smedata_reference\", { length: 100 }), // SMEDATA.NG transaction reference\n  smedataResponse: jsonb(\"smedata_response\"), // Full API response for debugging\n  errorMessage: text(\"error_message\"),\n  walletTransactionId: varchar(\"wallet_transaction_id\").references(() => transactions.id, { onDelete: \"set null\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  completedAt: timestamp(\"completed_at\"),\n}, (table) => [\n  index(\"vtu_transactions_user_idx\").on(table.userId),\n  index(\"vtu_transactions_status_idx\").on(table.status),\n  index(\"vtu_transactions_created_idx\").on(table.createdAt),\n]);\n\n// VTU Insert schemas\nexport const insertVtuPlanSchema = createInsertSchema(vtuPlans).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertVtuTransactionSchema = createInsertSchema(vtuTransactions).omit({\n  id: true,\n  createdAt: true,\n  completedAt: true,\n});\n\n// VTU API schemas\nexport const purchaseVtuSchema = z.object({\n  planId: z.string().min(1, \"Plan ID is required\"),\n  phoneNumber: z.string().min(10, \"Valid phone number is required\").max(15),\n});\n\n// Airtime purchase schema\nexport const purchaseAirtimeSchema = z.object({\n  phoneNumber: z.string().min(10, \"Valid phone number is required\").max(15),\n  amount: z.number().min(50, \"Minimum airtime is 50 Naira\").max(50000, \"Maximum airtime is 50,000 Naira\"),\n  network: z.enum([\"mtn_sme\", \"glo_cg\", \"airtel_cg\", \"9mobile\"]),\n});\n\n// ===========================================\n// VTU BENEFICIARIES - Saved phone numbers\n// ===========================================\n\nexport const vtuBeneficiaries = pgTable(\"vtu_beneficiaries\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  name: varchar(\"name\", { length: 100 }).notNull(),\n  phoneNumber: varchar(\"phone_number\", { length: 15 }).notNull(),\n  network: vtuNetworkEnum(\"network\").notNull(),\n  isDefault: boolean(\"is_default\").default(false),\n  lastUsed: timestamp(\"last_used\"),\n  usageCount: integer(\"usage_count\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"vtu_beneficiaries_user_idx\").on(table.userId),\n]);\n\nexport const insertVtuBeneficiarySchema = createInsertSchema(vtuBeneficiaries).omit({\n  id: true,\n  createdAt: true,\n  lastUsed: true,\n  usageCount: true,\n});\n\nexport const createBeneficiarySchema = z.object({\n  name: z.string().min(1, \"Name is required\").max(100),\n  phoneNumber: z.string().min(10, \"Valid phone number is required\").max(15),\n  network: z.enum([\"mtn_sme\", \"glo_cg\", \"airtel_cg\", \"9mobile\"]),\n  isDefault: z.boolean().optional(),\n});\n\n// VTU TypeScript types\nexport type VtuPlan = typeof vtuPlans.$inferSelect;\nexport type InsertVtuPlan = z.infer<typeof insertVtuPlanSchema>;\nexport type VtuTransaction = typeof vtuTransactions.$inferSelect;\nexport type InsertVtuTransaction = z.infer<typeof insertVtuTransactionSchema>;\nexport type PurchaseVtuInput = z.infer<typeof purchaseVtuSchema>;\nexport type PurchaseAirtimeInput = z.infer<typeof purchaseAirtimeSchema>;\nexport type VtuBeneficiary = typeof vtuBeneficiaries.$inferSelect;\nexport type InsertVtuBeneficiary = z.infer<typeof insertVtuBeneficiarySchema>;\nexport type CreateBeneficiaryInput = z.infer<typeof createBeneficiarySchema>;\n\n// ===========================================\n// SCHEDULED VTU PURCHASES\n// ===========================================\n\nexport const scheduledPurchaseFrequencyEnum = pgEnum(\"scheduled_purchase_frequency\", [\"daily\", \"weekly\", \"monthly\"]);\nexport const scheduledPurchaseStatusEnum = pgEnum(\"scheduled_purchase_status\", [\"active\", \"paused\", \"cancelled\"]);\n\nexport const scheduledVtuPurchases = pgTable(\"scheduled_vtu_purchases\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  serviceType: vtuServiceTypeEnum(\"service_type\").notNull().default(\"data\"),\n  planId: varchar(\"plan_id\").references(() => vtuPlans.id),\n  network: vtuNetworkEnum(\"network\").notNull(),\n  phoneNumber: varchar(\"phone_number\", { length: 15 }).notNull(),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }),\n  frequency: scheduledPurchaseFrequencyEnum(\"frequency\").notNull(),\n  dayOfWeek: integer(\"day_of_week\"),\n  dayOfMonth: integer(\"day_of_month\"),\n  timeOfDay: varchar(\"time_of_day\", { length: 5 }).default(\"09:00\"),\n  nextRunAt: timestamp(\"next_run_at\"),\n  lastRunAt: timestamp(\"last_run_at\"),\n  runCount: integer(\"run_count\").default(0),\n  status: scheduledPurchaseStatusEnum(\"status\").default(\"active\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"scheduled_vtu_user_idx\").on(table.userId),\n  index(\"scheduled_vtu_next_run_idx\").on(table.nextRunAt),\n]);\n\nexport const insertScheduledVtuPurchaseSchema = createInsertSchema(scheduledVtuPurchases).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  runCount: true,\n  lastRunAt: true,\n});\n\nexport const createScheduledPurchaseApiSchema = z.object({\n  serviceType: z.enum([\"data\", \"airtime\"]),\n  planId: z.string().optional(),\n  network: z.enum([\"mtn_sme\", \"glo_cg\", \"airtel_cg\", \"9mobile\"]),\n  phoneNumber: z.string().min(10).max(15),\n  amount: z.number().optional(),\n  frequency: z.enum([\"daily\", \"weekly\", \"monthly\"]),\n  dayOfWeek: z.number().min(0).max(6).optional(),\n  dayOfMonth: z.number().min(1).max(28).optional(),\n  timeOfDay: z.string().regex(/^\\d{2}:\\d{2}$/).optional(),\n});\n\nexport type ScheduledVtuPurchase = typeof scheduledVtuPurchases.$inferSelect;\nexport type InsertScheduledVtuPurchase = z.infer<typeof insertScheduledVtuPurchaseSchema>;\nexport type CreateScheduledPurchaseInput = z.infer<typeof createScheduledPurchaseApiSchema>;\n\n// ===========================================\n// GIFT DATA FEATURE\n// ===========================================\n\nexport const giftDataStatusEnum = pgEnum(\"gift_data_status\", [\"pending\", \"accepted\", \"claimed\", \"expired\", \"cancelled\"]);\n\nexport const giftData = pgTable(\"gift_data\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  senderId: varchar(\"sender_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  recipientPhone: varchar(\"recipient_phone\", { length: 15 }).notNull(),\n  recipientUserId: varchar(\"recipient_user_id\").references(() => users.id),\n  planId: varchar(\"plan_id\").notNull().references(() => vtuPlans.id),\n  network: vtuNetworkEnum(\"network\").notNull(),\n  message: text(\"message\"),\n  giftCode: varchar(\"gift_code\", { length: 10 }).unique(),\n  status: giftDataStatusEnum(\"status\").default(\"pending\"),\n  expiresAt: timestamp(\"expires_at\"),\n  claimedAt: timestamp(\"claimed_at\"),\n  transactionId: varchar(\"transaction_id\").references(() => vtuTransactions.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"gift_data_sender_idx\").on(table.senderId),\n  index(\"gift_data_recipient_idx\").on(table.recipientPhone),\n  index(\"gift_data_code_idx\").on(table.giftCode),\n]);\n\nexport const insertGiftDataSchema = createInsertSchema(giftData).omit({\n  id: true,\n  createdAt: true,\n  claimedAt: true,\n  transactionId: true,\n});\n\nexport const createGiftDataApiSchema = z.object({\n  recipientPhone: z.string().min(10).max(15),\n  planId: z.string().min(1),\n  network: z.enum([\"mtn_sme\", \"glo_cg\", \"airtel_cg\", \"9mobile\"]),\n  message: z.string().max(200).optional(),\n});\n\nexport type GiftData = typeof giftData.$inferSelect;\nexport type InsertGiftData = z.infer<typeof insertGiftDataSchema>;\nexport type CreateGiftDataInput = z.infer<typeof createGiftDataApiSchema>;\n\n// ===========================================\n// USER SETTINGS SYSTEM\n// ===========================================\n\n// User settings for preferences\nexport const userSettings = pgTable(\"user_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().unique().references(() => users.id, { onDelete: \"cascade\" }),\n  // Location settings\n  locationVisible: boolean(\"location_visible\").default(true),\n  showDistanceFromCampus: boolean(\"show_distance_from_campus\").default(true),\n  latitude: decimal(\"latitude\", { precision: 10, scale: 7 }),\n  longitude: decimal(\"longitude\", { precision: 10, scale: 7 }),\n  // Notification settings\n  pushNotifications: boolean(\"push_notifications\").default(true),\n  emailNotifications: boolean(\"email_notifications\").default(true),\n  messageNotifications: boolean(\"message_notifications\").default(true),\n  orderNotifications: boolean(\"order_notifications\").default(true),\n  promotionalNotifications: boolean(\"promotional_notifications\").default(false),\n  // Chat settings\n  showTypingStatus: boolean(\"show_typing_status\").default(true),\n  showReadReceipts: boolean(\"show_read_receipts\").default(true),\n  showOnlineStatus: boolean(\"show_online_status\").default(true),\n  // Account settings\n  deletionRequestedAt: timestamp(\"deletion_requested_at\"),\n  deletionScheduledFor: timestamp(\"deletion_scheduled_for\"), // 30 days after request\n  deletionCancelledAt: timestamp(\"deletion_cancelled_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// User settings insert schema\nexport const insertUserSettingsSchema = createInsertSchema(userSettings).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const updateUserSettingsSchema = z.object({\n  locationVisible: z.boolean().optional(),\n  showDistanceFromCampus: z.boolean().optional(),\n  latitude: z.number().optional(),\n  longitude: z.number().optional(),\n  pushNotifications: z.boolean().optional(),\n  emailNotifications: z.boolean().optional(),\n  messageNotifications: z.boolean().optional(),\n  orderNotifications: z.boolean().optional(),\n  promotionalNotifications: z.boolean().optional(),\n  showTypingStatus: z.boolean().optional(),\n  showReadReceipts: z.boolean().optional(),\n  showOnlineStatus: z.boolean().optional(),\n});\n\nexport const requestAccountDeletionSchema = z.object({\n  usernameConfirmation: z.string().min(1, \"Username confirmation required\"),\n});\n\n// User settings types\nexport type UserSettings = typeof userSettings.$inferSelect;\nexport type InsertUserSettings = z.infer<typeof insertUserSettingsSchema>;\nexport type UpdateUserSettingsInput = z.infer<typeof updateUserSettingsSchema>;\nexport type RequestAccountDeletionInput = z.infer<typeof requestAccountDeletionSchema>;\n\n// ===========================================\n// SPONSORED ADS / MONETIZATION SYSTEM\n// ===========================================\n\n// Sponsored ad types\nexport const sponsoredAdTypeEnum = pgEnum(\"sponsored_ad_type\", [\"marketplace\", \"plug\", \"banner\"]);\nexport const sponsoredAdStatusEnum = pgEnum(\"sponsored_ad_status\", [\"pending\", \"active\", \"paused\", \"completed\", \"rejected\"]);\n\n// Sponsored ads table\nexport const sponsoredAds = pgTable(\"sponsored_ads\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  advertiserId: varchar(\"advertiser_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  type: sponsoredAdTypeEnum(\"type\").notNull().default(\"marketplace\"),\n  title: varchar(\"title\", { length: 200 }).notNull(),\n  description: text(\"description\"),\n  imageUrl: text(\"image_url\"),\n  linkUrl: text(\"link_url\"),\n  productId: varchar(\"product_id\").references(() => products.id, { onDelete: \"set null\" }), // Optional: promote a specific product\n  budget: decimal(\"budget\", { precision: 10, scale: 2 }).notNull(),\n  spent: decimal(\"spent\", { precision: 10, scale: 2 }).default(\"0.00\"),\n  costPerImpression: decimal(\"cost_per_impression\", { precision: 10, scale: 4 }).default(\"0.0050\"), // ~₦5 per 1000 views\n  costPerClick: decimal(\"cost_per_click\", { precision: 10, scale: 2 }).default(\"1.00\"), // ₦1 per click\n  impressions: integer(\"impressions\").default(0),\n  clicks: integer(\"clicks\").default(0),\n  status: sponsoredAdStatusEnum(\"status\").notNull().default(\"pending\"),\n  startDate: timestamp(\"start_date\"),\n  endDate: timestamp(\"end_date\"),\n  targetCategories: text(\"target_categories\").array().default(sql`ARRAY[]::text[]`), // Category targeting\n  targetLocations: text(\"target_locations\").array().default(sql`ARRAY[]::text[]`), // Location targeting\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"sponsored_ads_status_idx\").on(table.status),\n  index(\"sponsored_ads_advertiser_idx\").on(table.advertiserId),\n]);\n\n// Platform settings for admin controls\nexport const platformSettings = pgTable(\"platform_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  key: varchar(\"key\", { length: 100 }).notNull().unique(),\n  value: text(\"value\").notNull(),\n  description: text(\"description\"),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  updatedBy: varchar(\"updated_by\").references(() => users.id, { onDelete: \"set null\" }),\n});\n\n// Sponsored ads insert schema\nexport const insertSponsoredAdSchema = createInsertSchema(sponsoredAds).omit({\n  id: true,\n  impressions: true,\n  clicks: true,\n  spent: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const createSponsoredAdSchema = z.object({\n  type: z.enum([\"marketplace\", \"plug\", \"banner\"]).optional().default(\"marketplace\"),\n  title: z.string().min(1, \"Title is required\").max(200),\n  description: z.string().optional(),\n  imageUrl: z.string().optional(),\n  linkUrl: z.string().optional(),\n  productId: z.string().optional(),\n  budget: z.number().min(500, \"Minimum budget is ₦500\"),\n  startDate: z.string().optional(),\n  endDate: z.string().optional(),\n  targetCategories: z.array(z.string()).optional(),\n  targetLocations: z.array(z.string()).optional(),\n});\n\n// Sponsored ads types\nexport type SponsoredAd = typeof sponsoredAds.$inferSelect;\nexport type InsertSponsoredAd = z.infer<typeof insertSponsoredAdSchema>;\nexport type CreateSponsoredAdInput = z.infer<typeof createSponsoredAdSchema>;\nexport type PlatformSetting = typeof platformSettings.$inferSelect;\n\n// ===========================================\n// KYC VERIFICATION SYSTEM\n// ===========================================\n\n// KYC status enum\nexport const kycStatusEnum = pgEnum(\"kyc_status\", [\"pending_payment\", \"pending_verification\", \"manual_review\", \"approved\", \"rejected\", \"refunded\"]);\n\n// KYC verifications table\nexport const kycVerifications = pgTable(\"kyc_verifications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  status: kycStatusEnum(\"status\").notNull().default(\"pending_payment\"),\n  // Payment info\n  paymentReference: varchar(\"payment_reference\"),\n  paymentAmount: decimal(\"payment_amount\", { precision: 10, scale: 2 }).default(\"200.00\"), // ₦200 fee\n  paymentStatus: varchar(\"payment_status\", { length: 20 }).default(\"pending\"),\n  paidAt: timestamp(\"paid_at\"),\n  // NIN verification data\n  nin: varchar(\"nin\", { length: 11 }), // Stored temporarily, deleted after verification\n  ninFirstName: varchar(\"nin_first_name\"),\n  ninLastName: varchar(\"nin_last_name\"),\n  ninDateOfBirth: varchar(\"nin_date_of_birth\"),\n  ninPhotoUrl: text(\"nin_photo_url\"), // Temporary, deleted after verification\n  // Selfie verification\n  selfieUrl: text(\"selfie_url\"), // Temporary, deleted after verification\n  // Verification results\n  similarityScore: decimal(\"similarity_score\", { precision: 5, scale: 2 }), // 0-100%\n  smedataResponse: jsonb(\"smedata_response\"), // Full API response\n  // Consent\n  consentGiven: boolean(\"consent_given\").default(false),\n  consentTimestamp: timestamp(\"consent_timestamp\"),\n  // Review info\n  reviewedBy: varchar(\"reviewed_by\").references(() => users.id, { onDelete: \"set null\" }),\n  reviewedAt: timestamp(\"reviewed_at\"),\n  reviewNotes: text(\"review_notes\"),\n  rejectionReason: text(\"rejection_reason\"),\n  // Cleanup tracking\n  imagesDeletedAt: timestamp(\"images_deleted_at\"), // When selfie/NIN photo were deleted\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"kyc_verifications_user_idx\").on(table.userId),\n  index(\"kyc_verifications_status_idx\").on(table.status),\n]);\n\n// KYC verification logs for audit trail (1 year retention)\nexport const kycVerificationLogs = pgTable(\"kyc_verification_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  kycId: varchar(\"kyc_id\").notNull().references(() => kycVerifications.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull(),\n  action: varchar(\"action\", { length: 50 }).notNull(), // payment_initiated, verification_started, auto_approved, manual_review, approved, rejected, refunded\n  result: varchar(\"result\", { length: 50 }),\n  similarityScore: decimal(\"similarity_score\", { precision: 5, scale: 2 }),\n  reviewedBy: varchar(\"reviewed_by\"),\n  ipAddress: varchar(\"ip_address\"),\n  userAgent: text(\"user_agent\"),\n  metadata: jsonb(\"metadata\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// KYC insert schemas\nexport const insertKycVerificationSchema = createInsertSchema(kycVerifications).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const initiateKycSchema = z.object({\n  nin: z.string().length(11, \"NIN must be exactly 11 digits\"),\n  firstName: z.string().min(1, \"First name is required\"),\n  lastName: z.string().min(1, \"Last name is required\"),\n  dateOfBirth: z.string().min(1, \"Date of birth is required\"), // YYYY-MM-DD format\n  consent: z.boolean().refine(val => val === true, \"You must agree to the verification terms\"),\n});\n\nexport const uploadKycSelfieSchema = z.object({\n  kycId: z.string().min(1, \"KYC ID is required\"),\n});\n\nexport const reviewKycSchema = z.object({\n  kycId: z.string().min(1, \"KYC ID is required\"),\n  action: z.enum([\"approve\", \"reject\"]),\n  notes: z.string().optional(),\n  rejectionReason: z.string().optional(),\n});\n\n// KYC types\nexport type KycVerification = typeof kycVerifications.$inferSelect;\nexport type InsertKycVerification = z.infer<typeof insertKycVerificationSchema>;\nexport type InitiateKycInput = z.infer<typeof initiateKycSchema>;\nexport type ReviewKycInput = z.infer<typeof reviewKycSchema>;\nexport type KycVerificationLog = typeof kycVerificationLogs.$inferSelect;\n\n// ===========================================\n// BILL PAYMENTS SYSTEM (Cable TV & Electricity)\n// ===========================================\n\n// Bill service type enum - Cable TV and Electricity providers\nexport const billServiceTypeEnum = pgEnum(\"bill_service_type\", [\n  \"dstv\", \"gotv\", \"startimes\", \"showmax\",  // Cable TV\n  \"ekedc\", \"ikedc\", \"aedc\", \"ibedc\", \"phedc\", \"eedc\"  // Electricity\n]);\n\n// Bill payments table\nexport const billPayments = pgTable(\"bill_payments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  serviceType: billServiceTypeEnum(\"service_type\").notNull(),\n  billType: varchar(\"bill_type\", { length: 20 }).notNull(), // 'cable' or 'electricity'\n  customerId: varchar(\"customer_id\", { length: 50 }).notNull(), // Decoder/Meter number\n  customerName: varchar(\"customer_name\", { length: 100 }),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  packageName: varchar(\"package_name\", { length: 100 }),\n  status: vtuStatusEnum(\"status\").notNull().default(\"pending\"),\n  reference: varchar(\"reference\", { length: 100 }),\n  token: varchar(\"token\", { length: 100 }), // For electricity prepaid tokens\n  apiResponse: jsonb(\"api_response\"),\n  errorMessage: text(\"error_message\"),\n  walletTransactionId: varchar(\"wallet_transaction_id\").references(() => transactions.id, { onDelete: \"set null\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"bill_payments_user_idx\").on(table.userId),\n  index(\"bill_payments_status_idx\").on(table.status),\n  index(\"bill_payments_created_idx\").on(table.createdAt),\n]);\n\n// Bill payment insert schema\nexport const insertBillPaymentSchema = createInsertSchema(billPayments).omit({\n  id: true,\n  createdAt: true,\n});\n\n// Bill payment API schemas\nexport const payBillSchema = z.object({\n  serviceType: z.enum([\"dstv\", \"gotv\", \"startimes\", \"showmax\", \"ekedc\", \"ikedc\", \"aedc\", \"ibedc\", \"phedc\", \"eedc\"]),\n  billType: z.enum([\"cable\", \"electricity\"]),\n  customerId: z.string().min(1, \"Customer ID is required\"),\n  amount: z.number().positive(\"Amount must be positive\"),\n  packageCode: z.string().optional(),\n  packageName: z.string().optional(),\n});\n\nexport const validateCustomerSchema = z.object({\n  serviceType: z.enum([\"dstv\", \"gotv\", \"startimes\", \"showmax\", \"ekedc\", \"ikedc\", \"aedc\", \"ibedc\", \"phedc\", \"eedc\"]),\n  customerId: z.string().min(1, \"Customer ID is required\"),\n});\n\n// Bill payment types\nexport type BillPayment = typeof billPayments.$inferSelect;\nexport type InsertBillPayment = z.infer<typeof insertBillPaymentSchema>;\nexport type PayBillInput = z.infer<typeof payBillSchema>;\nexport type ValidateCustomerInput = z.infer<typeof validateCustomerSchema>;\n\n// ===========================================\n// STORIES SYSTEM (Instagram-like, 24h expiry)\n// ===========================================\n\nexport const storyTypeEnum = pgEnum(\"story_type\", [\"image\", \"video\", \"text\"]);\n\nexport const stories = pgTable(\"stories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  authorId: varchar(\"author_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  type: storyTypeEnum(\"type\").notNull().default(\"image\"),\n  mediaUrl: text(\"media_url\"),\n  textContent: text(\"text_content\"),\n  backgroundColor: varchar(\"background_color\", { length: 20 }).default(\"#16a34a\"),\n  fontStyle: varchar(\"font_style\", { length: 50 }).default(\"sans-serif\"),\n  viewsCount: integer(\"views_count\").default(0),\n  likesCount: integer(\"likes_count\").default(0),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  isHighlight: boolean(\"is_highlight\").default(false),\n  highlightName: varchar(\"highlight_name\", { length: 100 }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"stories_author_idx\").on(table.authorId),\n  index(\"stories_expires_idx\").on(table.expiresAt),\n  index(\"stories_highlight_idx\").on(table.isHighlight),\n]);\n\nexport const storyViews = pgTable(\"story_views\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  storyId: varchar(\"story_id\").notNull().references(() => stories.id, { onDelete: \"cascade\" }),\n  viewerId: varchar(\"viewer_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  viewedAt: timestamp(\"viewed_at\").defaultNow(),\n}, (table) => [\n  index(\"story_views_story_idx\").on(table.storyId),\n  index(\"story_views_viewer_idx\").on(table.viewerId),\n]);\n\nexport const storyReactions = pgTable(\"story_reactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  storyId: varchar(\"story_id\").notNull().references(() => stories.id, { onDelete: \"cascade\" }),\n  reactorId: varchar(\"reactor_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  reaction: varchar(\"reaction\", { length: 10 }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"story_reactions_story_idx\").on(table.storyId),\n]);\n\nexport const storyReplies = pgTable(\"story_replies\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  storyId: varchar(\"story_id\").notNull().references(() => stories.id, { onDelete: \"cascade\" }),\n  senderId: varchar(\"sender_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  content: text(\"content\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"story_replies_story_idx\").on(table.storyId),\n]);\n\nexport const insertStorySchema = createInsertSchema(stories).omit({\n  id: true,\n  viewsCount: true,\n  likesCount: true,\n  createdAt: true,\n});\n\nexport const createStorySchema = z.object({\n  type: z.enum([\"image\", \"video\", \"text\"]),\n  mediaUrl: z.string().optional(),\n  textContent: z.string().max(500).optional(),\n  backgroundColor: z.string().optional(),\n  fontStyle: z.string().optional(),\n});\n\nexport type Story = typeof stories.$inferSelect;\nexport type InsertStory = z.infer<typeof insertStorySchema>;\nexport type CreateStoryInput = z.infer<typeof createStorySchema>;\nexport type StoryView = typeof storyViews.$inferSelect;\nexport type StoryReaction = typeof storyReactions.$inferSelect;\nexport type StoryReply = typeof storyReplies.$inferSelect;\n\n// ===========================================\n// CONFESSIONS SYSTEM (Anonymous Board)\n// ===========================================\n\nexport const confessionStatusEnum = pgEnum(\"confession_status\", [\"pending\", \"approved\", \"rejected\", \"flagged\"]);\n\nexport const confessions = pgTable(\"confessions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  authorId: varchar(\"author_id\").references(() => users.id, { onDelete: \"set null\" }),\n  content: text(\"content\").notNull(),\n  category: varchar(\"category\", { length: 50 }).default(\"general\"),\n  isAnonymous: boolean(\"is_anonymous\").default(true),\n  status: confessionStatusEnum(\"status\").default(\"pending\"),\n  likesCount: integer(\"likes_count\").default(0),\n  dislikesCount: integer(\"dislikes_count\").default(0),\n  commentsCount: integer(\"comments_count\").default(0),\n  viewsCount: integer(\"views_count\").default(0),\n  isTrending: boolean(\"is_trending\").default(false),\n  moderatedBy: varchar(\"moderated_by\").references(() => users.id, { onDelete: \"set null\" }),\n  moderatedAt: timestamp(\"moderated_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"confessions_status_idx\").on(table.status),\n  index(\"confessions_trending_idx\").on(table.isTrending),\n  index(\"confessions_created_idx\").on(table.createdAt),\n]);\n\nexport const confessionVotes = pgTable(\"confession_votes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  confessionId: varchar(\"confession_id\").notNull().references(() => confessions.id, { onDelete: \"cascade\" }),\n  voterId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  voteType: varchar(\"vote_type\", { length: 10 }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"confession_votes_confession_idx\").on(table.confessionId),\n  index(\"confession_votes_voter_idx\").on(table.voterId),\n]);\n\nexport const confessionComments = pgTable(\"confession_comments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  confessionId: varchar(\"confession_id\").notNull().references(() => confessions.id, { onDelete: \"cascade\" }),\n  authorId: varchar(\"author_id\").references(() => users.id, { onDelete: \"set null\" }),\n  content: text(\"content\").notNull(),\n  isAnonymous: boolean(\"is_anonymous\").default(false),\n  parentId: varchar(\"parent_id\"),\n  likesCount: integer(\"likes_count\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"confession_comments_confession_idx\").on(table.confessionId),\n]);\n\nexport const confessionReports = pgTable(\"confession_reports\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  confessionId: varchar(\"confession_id\").notNull().references(() => confessions.id, { onDelete: \"cascade\" }),\n  reporterId: varchar(\"reporter_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  reason: varchar(\"reason\", { length: 100 }).notNull(),\n  description: text(\"description\"),\n  status: varchar(\"status\", { length: 20 }).default(\"pending\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Confession views tracking for unique view counts (1 view per user per 24 hours)\nexport const confessionViews = pgTable(\"confession_views\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  confessionId: varchar(\"confession_id\").notNull().references(() => confessions.id, { onDelete: \"cascade\" }),\n  viewerId: varchar(\"viewer_id\").notNull(), // User ID for logged-in users, or hashed IP+session for guests\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"confession_views_confession_viewer_idx\").on(table.confessionId, table.viewerId),\n  index(\"confession_views_confession_idx\").on(table.confessionId),\n]);\n\nexport type ConfessionView = typeof confessionViews.$inferSelect;\n\nexport const insertConfessionSchema = createInsertSchema(confessions).omit({\n  id: true,\n  likesCount: true,\n  dislikesCount: true,\n  commentsCount: true,\n  viewsCount: true,\n  isTrending: true,\n  moderatedBy: true,\n  moderatedAt: true,\n  createdAt: true,\n});\n\nexport const createConfessionSchema = z.object({\n  content: z.string().min(10, \"Confession must be at least 10 characters\").max(2000),\n  category: z.enum([\"general\", \"love\", \"academics\", \"drama\", \"advice\", \"funny\", \"secrets\"]).optional(),\n  isAnonymous: z.boolean().optional().default(true),\n});\n\nexport type Confession = typeof confessions.$inferSelect;\nexport type InsertConfession = z.infer<typeof insertConfessionSchema>;\nexport type CreateConfessionInput = z.infer<typeof createConfessionSchema>;\nexport type ConfessionVote = typeof confessionVotes.$inferSelect;\nexport type ConfessionComment = typeof confessionComments.$inferSelect;\n\n// ===========================================\n// COMMUNITY SYSTEM (Groups & Discussions)\n// ===========================================\n\nexport const communityTypeEnum = pgEnum(\"community_type\", [\"public\", \"private\", \"invite_only\"]);\nexport const communityMemberRoleEnum = pgEnum(\"community_member_role\", [\"member\", \"moderator\", \"admin\", \"owner\"]);\n\nexport const communities = pgTable(\"communities\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\", { length: 100 }).notNull(),\n  slug: varchar(\"slug\", { length: 100 }).unique().notNull(),\n  description: text(\"description\"),\n  iconUrl: text(\"icon_url\"),\n  coverUrl: text(\"cover_url\"),\n  type: communityTypeEnum(\"type\").default(\"public\"),\n  ownerId: varchar(\"owner_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  category: varchar(\"category\", { length: 50 }),\n  membersCount: integer(\"members_count\").default(1),\n  postsCount: integer(\"posts_count\").default(0),\n  isVerified: boolean(\"is_verified\").default(false),\n  isActive: boolean(\"is_active\").default(true),\n  rules: text(\"rules\").array().default(sql`ARRAY[]::text[]`),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"communities_slug_idx\").on(table.slug),\n  index(\"communities_owner_idx\").on(table.ownerId),\n  index(\"communities_type_idx\").on(table.type),\n]);\n\nexport const communityMembers = pgTable(\"community_members\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  communityId: varchar(\"community_id\").notNull().references(() => communities.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  role: communityMemberRoleEnum(\"role\").default(\"member\"),\n  isBanned: boolean(\"is_banned\").default(false),\n  bannedUntil: timestamp(\"banned_until\"),\n  banReason: text(\"ban_reason\"),\n  joinedAt: timestamp(\"joined_at\").defaultNow(),\n}, (table) => [\n  index(\"community_members_community_idx\").on(table.communityId),\n  index(\"community_members_user_idx\").on(table.userId),\n]);\n\nexport const communityPosts = pgTable(\"community_posts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  communityId: varchar(\"community_id\").notNull().references(() => communities.id, { onDelete: \"cascade\" }),\n  authorId: varchar(\"author_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  title: varchar(\"title\", { length: 300 }),\n  content: text(\"content\").notNull(),\n  images: text(\"images\").array().default(sql`ARRAY[]::text[]`),\n  isPinned: boolean(\"is_pinned\").default(false),\n  isLocked: boolean(\"is_locked\").default(false),\n  likesCount: integer(\"likes_count\").default(0),\n  commentsCount: integer(\"comments_count\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"community_posts_community_idx\").on(table.communityId),\n  index(\"community_posts_author_idx\").on(table.authorId),\n  index(\"community_posts_pinned_idx\").on(table.isPinned),\n]);\n\nexport const communityPostComments = pgTable(\"community_post_comments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  postId: varchar(\"post_id\").notNull().references(() => communityPosts.id, { onDelete: \"cascade\" }),\n  authorId: varchar(\"author_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  content: text(\"content\").notNull(),\n  parentId: varchar(\"parent_id\"),\n  likesCount: integer(\"likes_count\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"community_post_comments_post_idx\").on(table.postId),\n]);\n\nexport const communityPostLikes = pgTable(\"community_post_likes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  postId: varchar(\"post_id\").notNull().references(() => communityPosts.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"community_post_likes_post_idx\").on(table.postId),\n  index(\"community_post_likes_user_idx\").on(table.userId),\n]);\n\nexport const insertCommunitySchema = createInsertSchema(communities).omit({\n  id: true,\n  membersCount: true,\n  postsCount: true,\n  isVerified: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const createCommunitySchema = z.object({\n  name: z.string().min(3, \"Name must be at least 3 characters\").max(100),\n  slug: z.string().min(3).max(100).regex(/^[a-z0-9-]+$/, \"Slug must be lowercase letters, numbers, and hyphens only\"),\n  description: z.string().max(1000).optional(),\n  type: z.enum([\"public\", \"private\", \"invite_only\"]).optional(),\n  category: z.string().optional(),\n  rules: z.array(z.string()).optional(),\n});\n\nexport const createCommunityPostSchema = z.object({\n  communityId: z.string().min(1),\n  title: z.string().max(300).optional(),\n  content: z.string().min(1, \"Content is required\").max(10000),\n  images: z.array(z.string()).optional(),\n});\n\nexport const createCommunityPostCommentSchema = z.object({\n  postId: z.string().min(1),\n  content: z.string().min(1, \"Comment is required\").max(2000),\n  parentId: z.string().optional(),\n});\n\nexport type Community = typeof communities.$inferSelect;\nexport type InsertCommunity = z.infer<typeof insertCommunitySchema>;\nexport type CreateCommunityInput = z.infer<typeof createCommunitySchema>;\nexport type CommunityMember = typeof communityMembers.$inferSelect;\nexport type CommunityPost = typeof communityPosts.$inferSelect;\nexport type CreateCommunityPostInput = z.infer<typeof createCommunityPostSchema>;\nexport type CommunityPostComment = typeof communityPostComments.$inferSelect;\nexport type CreateCommunityPostCommentInput = z.infer<typeof createCommunityPostCommentSchema>;\nexport type CommunityPostLike = typeof communityPostLikes.$inferSelect;\n\n// ===========================================\n// WEB PUSH NOTIFICATIONS SYSTEM\n// ===========================================\n\nexport const pushSubscriptions = pgTable(\"push_subscriptions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  endpoint: text(\"endpoint\").notNull().unique(),\n  p256dhKey: text(\"p256dh_key\").notNull(),\n  authKey: text(\"auth_key\").notNull(),\n  userAgent: text(\"user_agent\"),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  lastUsed: timestamp(\"last_used\").defaultNow(),\n}, (table) => [\n  index(\"push_subscriptions_user_idx\").on(table.userId),\n  index(\"push_subscriptions_active_idx\").on(table.isActive),\n]);\n\nexport const pushNotificationHistory = pgTable(\"push_notification_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  subscriptionId: varchar(\"subscription_id\").references(() => pushSubscriptions.id, { onDelete: \"set null\" }),\n  title: varchar(\"title\", { length: 200 }).notNull(),\n  body: text(\"body\").notNull(),\n  icon: text(\"icon\"),\n  url: text(\"url\"),\n  data: jsonb(\"data\"),\n  status: varchar(\"status\", { length: 20 }).default(\"sent\"),\n  sentAt: timestamp(\"sent_at\").defaultNow(),\n  clickedAt: timestamp(\"clicked_at\"),\n}, (table) => [\n  index(\"push_history_user_idx\").on(table.userId),\n  index(\"push_history_sent_idx\").on(table.sentAt),\n]);\n\nexport const insertPushSubscriptionSchema = createInsertSchema(pushSubscriptions).omit({\n  id: true,\n  isActive: true,\n  createdAt: true,\n  lastUsed: true,\n});\n\nexport const subscribePushSchema = z.object({\n  endpoint: z.string().url(),\n  keys: z.object({\n    p256dh: z.string(),\n    auth: z.string(),\n  }),\n});\n\nexport type PushSubscription = typeof pushSubscriptions.$inferSelect;\nexport type InsertPushSubscription = z.infer<typeof insertPushSubscriptionSchema>;\nexport type SubscribePushInput = z.infer<typeof subscribePushSchema>;\nexport type PushNotificationHistory = typeof pushNotificationHistory.$inferSelect;\n\n// ===========================================\n// ENHANCED MESSAGING FEATURES\n// ===========================================\n\nexport const messageStatusEnum = pgEnum(\"message_status\", [\"sent\", \"delivered\", \"read\"]);\n\nexport const messageReactions = pgTable(\"message_reactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  messageId: varchar(\"message_id\").notNull().references(() => messages.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  reaction: varchar(\"reaction\", { length: 10 }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"message_reactions_message_idx\").on(table.messageId),\n]);\n\nexport const archivedConversations = pgTable(\"archived_conversations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  otherUserId: varchar(\"other_user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  archivedAt: timestamp(\"archived_at\").defaultNow(),\n}, (table) => [\n  index(\"archived_conversations_user_idx\").on(table.userId),\n]);\n\nexport const disappearingMessageSettings = pgTable(\"disappearing_message_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  otherUserId: varchar(\"other_user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  duration: integer(\"duration\").notNull(),\n  isEnabled: boolean(\"is_enabled\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"disappearing_settings_user_idx\").on(table.userId),\n]);\n\nexport const messageReadReceipts = pgTable(\"message_read_receipts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  messageId: varchar(\"message_id\").notNull().references(() => messages.id, { onDelete: \"cascade\" }),\n  readerId: varchar(\"reader_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  readAt: timestamp(\"read_at\").defaultNow(),\n}, (table) => [\n  index(\"message_read_receipts_message_idx\").on(table.messageId),\n]);\n\nexport type MessageReaction = typeof messageReactions.$inferSelect;\nexport type ArchivedConversation = typeof archivedConversations.$inferSelect;\nexport type DisappearingMessageSetting = typeof disappearingMessageSettings.$inferSelect;\nexport type MessageReadReceipt = typeof messageReadReceipts.$inferSelect;\n\n// ===========================================\n// WEEKLY LOGIN REWARDS (₦20 per week streak)\n// ===========================================\n\nexport const weeklyLoginRewards = pgTable(\"weekly_login_rewards\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  weekNumber: integer(\"week_number\").notNull(),\n  year: integer(\"year\").notNull(),\n  daysLoggedIn: integer(\"days_logged_in\").default(0),\n  rewardAmount: decimal(\"reward_amount\", { precision: 10, scale: 2 }).default(\"0.00\"),\n  rewardClaimed: boolean(\"reward_claimed\").default(false),\n  claimedAt: timestamp(\"claimed_at\"),\n  lastLoginDate: timestamp(\"last_login_date\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"weekly_login_rewards_user_idx\").on(table.userId),\n  index(\"weekly_login_rewards_week_idx\").on(table.weekNumber, table.year),\n]);\n\nexport type WeeklyLoginReward = typeof weeklyLoginRewards.$inferSelect;\n\n// ===========================================\n// MULTIPLAYER GAME ROOMS (Real-time WebSocket)\n// ===========================================\n\nexport const gameRoomStatusEnum = pgEnum(\"game_room_status\", [\"waiting\", \"ready\", \"playing\", \"paused\", \"finished\", \"abandoned\"]);\n\nexport const gameRooms = pgTable(\"game_rooms\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  gameType: gameTypeEnum(\"game_type\").notNull(),\n  roomCode: varchar(\"room_code\", { length: 8 }).unique().notNull(),\n  hostId: varchar(\"host_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  status: gameRoomStatusEnum(\"status\").default(\"waiting\"),\n  maxPlayers: integer(\"max_players\").default(4),\n  currentPlayers: integer(\"current_players\").default(1),\n  stakeAmount: decimal(\"stake_amount\", { precision: 10, scale: 2 }).notNull().default(\"0.00\"),\n  isPrivate: boolean(\"is_private\").default(false),\n  password: varchar(\"password\", { length: 50 }),\n  gameState: jsonb(\"game_state\"),\n  settings: jsonb(\"settings\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  startedAt: timestamp(\"started_at\"),\n  finishedAt: timestamp(\"finished_at\"),\n}, (table) => [\n  index(\"game_rooms_code_idx\").on(table.roomCode),\n  index(\"game_rooms_host_idx\").on(table.hostId),\n  index(\"game_rooms_status_idx\").on(table.status),\n]);\n\nexport const gameRoomPlayers = pgTable(\"game_room_players\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  roomId: varchar(\"room_id\").notNull().references(() => gameRooms.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  playerNumber: integer(\"player_number\").notNull(),\n  isReady: boolean(\"is_ready\").default(false),\n  isConnected: boolean(\"is_connected\").default(true),\n  score: integer(\"score\").default(0),\n  position: integer(\"position\"),\n  playerState: jsonb(\"player_state\"),\n  joinedAt: timestamp(\"joined_at\").defaultNow(),\n  leftAt: timestamp(\"left_at\"),\n}, (table) => [\n  index(\"game_room_players_room_idx\").on(table.roomId),\n  index(\"game_room_players_user_idx\").on(table.userId),\n]);\n\nexport const gameChatMessages = pgTable(\"game_chat_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  roomId: varchar(\"room_id\").notNull().references(() => gameRooms.id, { onDelete: \"cascade\" }),\n  senderId: varchar(\"sender_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  content: text(\"content\").notNull(),\n  type: varchar(\"type\", { length: 20 }).default(\"text\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"game_chat_messages_room_idx\").on(table.roomId),\n]);\n\nexport const insertGameRoomSchema = createInsertSchema(gameRooms).omit({\n  id: true,\n  currentPlayers: true,\n  createdAt: true,\n  startedAt: true,\n  finishedAt: true,\n});\n\nexport const createGameRoomSchema = z.object({\n  gameType: z.enum([\"ludo\", \"word_battle\", \"trivia\", \"whot\", \"quick_draw\", \"speed_typing\", \"campus_bingo\", \"truth_or_dare\", \"guess_the_price\", \"aviator\", \"colour_colour\", \"spin_wheel\", \"draughts\", \"ayo_olopon\", \"dice_duel\"]),\n  stakeAmount: z.number().min(0).default(0),\n  maxPlayers: z.number().min(2).max(10).default(4),\n  isPrivate: z.boolean().optional(),\n  password: z.string().optional(),\n  settings: z.record(z.any()).optional(),\n});\n\nexport const joinGameRoomSchema = z.object({\n  roomCode: z.string().length(8),\n  password: z.string().optional(),\n});\n\nexport type GameRoom = typeof gameRooms.$inferSelect;\nexport type InsertGameRoom = z.infer<typeof insertGameRoomSchema>;\nexport type CreateGameRoomInput = z.infer<typeof createGameRoomSchema>;\nexport type JoinGameRoomInput = z.infer<typeof joinGameRoomSchema>;\nexport type GameRoomPlayer = typeof gameRoomPlayers.$inferSelect;\nexport type GameChatMessage = typeof gameChatMessages.$inferSelect;\n\n// ===========================================\n// PRO CHATBOT CONVERSATIONS\n// ===========================================\n\nexport const chatbotConversations = pgTable(\"chatbot_conversations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  title: varchar(\"title\", { length: 200 }),\n  isActive: boolean(\"is_active\").default(true),\n  messageCount: integer(\"message_count\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"chatbot_conversations_user_idx\").on(table.userId),\n]);\n\nexport const chatbotMessages = pgTable(\"chatbot_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  conversationId: varchar(\"conversation_id\").notNull().references(() => chatbotConversations.id, { onDelete: \"cascade\" }),\n  role: varchar(\"role\", { length: 20 }).notNull(),\n  content: text(\"content\").notNull(),\n  metadata: jsonb(\"metadata\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"chatbot_messages_conversation_idx\").on(table.conversationId),\n]);\n\nexport const createChatbotMessageSchema = z.object({\n  conversationId: z.string().optional(),\n  message: z.string().min(1, \"Message is required\").max(4000),\n});\n\nexport type ChatbotConversation = typeof chatbotConversations.$inferSelect;\nexport type ChatbotMessage = typeof chatbotMessages.$inferSelect;\nexport type CreateChatbotMessageInput = z.infer<typeof createChatbotMessageSchema>;\n\n// ===========================================\n// SECRET MESSAGE LINKS (Anonymous Messages)\n// ===========================================\n\nexport const secretMessageLinks = pgTable(\"secret_message_links\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  linkCode: varchar(\"link_code\", { length: 12 }).unique().notNull(),\n  title: text(\"title\").notNull().default(\"Send me an anonymous message\"),\n  backgroundColor: varchar(\"background_color\", { length: 20 }).default(\"#6b21a8\"),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"secret_message_links_user_idx\").on(table.userId),\n  index(\"secret_message_links_code_idx\").on(table.linkCode),\n]);\n\nexport const secretMessages = pgTable(\"secret_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  linkId: varchar(\"link_id\").notNull().references(() => secretMessageLinks.id, { onDelete: \"cascade\" }),\n  content: text(\"content\").notNull(),\n  isRead: boolean(\"is_read\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"secret_messages_link_idx\").on(table.linkId),\n  index(\"secret_messages_read_idx\").on(table.isRead),\n]);\n\nexport const insertSecretMessageLinkSchema = createInsertSchema(secretMessageLinks).omit({\n  id: true,\n  userId: true,\n  linkCode: true,\n  createdAt: true,\n});\n\nexport const createSecretMessageLinkSchema = z.object({\n  title: z.string().min(3, \"Title must be at least 3 characters\").max(200, \"Title must be at most 200 characters\").optional(),\n  backgroundColor: z.string().regex(/^#[0-9A-Fa-f]{6}$/, \"Invalid color format\").optional(),\n});\n\nexport const insertSecretMessageSchema = createInsertSchema(secretMessages).omit({\n  id: true,\n  isRead: true,\n  createdAt: true,\n});\n\nexport const sendSecretMessageSchema = z.object({\n  content: z.string().min(1, \"Message cannot be empty\").max(2000, \"Message must be at most 2000 characters\"),\n});\n\nexport type SecretMessageLink = typeof secretMessageLinks.$inferSelect;\nexport type InsertSecretMessageLink = z.infer<typeof insertSecretMessageLinkSchema>;\nexport type CreateSecretMessageLinkInput = z.infer<typeof createSecretMessageLinkSchema>;\nexport type SecretMessage = typeof secretMessages.$inferSelect;\nexport type InsertSecretMessage = z.infer<typeof insertSecretMessageSchema>;\nexport type SendSecretMessageInput = z.infer<typeof sendSecretMessageSchema>;\n\n// ===========================================\n// STUDY MATERIALS (Past Questions, Handouts, Notes)\n// ===========================================\n\nexport const materialTypeEnum = pgEnum(\"material_type\", [\n  \"past_question\",\n  \"handout\",\n  \"summary\",\n  \"textbook\",\n  \"lab_report\",\n  \"project\",\n  \"lecture_note\"\n]);\n\nexport const academicLevelEnum = pgEnum(\"academic_level\", [\"100L\", \"200L\", \"300L\", \"400L\", \"500L\", \"postgraduate\"]);\n\nexport const studyMaterials = pgTable(\"study_materials\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  uploaderId: varchar(\"uploader_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  title: varchar(\"title\", { length: 200 }).notNull(),\n  description: text(\"description\"),\n  materialType: materialTypeEnum(\"material_type\").notNull(),\n  courseCode: varchar(\"course_code\", { length: 20 }).notNull(),\n  courseName: varchar(\"course_name\", { length: 200 }),\n  faculty: varchar(\"faculty\", { length: 100 }),\n  department: varchar(\"department\", { length: 100 }),\n  level: academicLevelEnum(\"level\").notNull(),\n  semester: varchar(\"semester\", { length: 20 }),\n  academicYear: varchar(\"academic_year\", { length: 20 }),\n  fileUrl: text(\"file_url\").notNull(),\n  previewUrl: text(\"preview_url\"),\n  thumbnailUrl: text(\"thumbnail_url\"),\n  fileSize: integer(\"file_size\"),\n  pageCount: integer(\"page_count\"),\n  price: decimal(\"price\", { precision: 10, scale: 2 }).notNull().default(\"0.00\"),\n  isFree: boolean(\"is_free\").default(true),\n  downloads: integer(\"downloads\").default(0),\n  views: integer(\"views\").default(0),\n  rating: decimal(\"rating\", { precision: 3, scale: 2 }).default(\"0.00\"),\n  ratingCount: integer(\"rating_count\").default(0),\n  isApproved: boolean(\"is_approved\").default(true),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"study_materials_uploader_idx\").on(table.uploaderId),\n  index(\"study_materials_course_idx\").on(table.courseCode),\n  index(\"study_materials_level_idx\").on(table.level),\n  index(\"study_materials_type_idx\").on(table.materialType),\n  index(\"study_materials_faculty_idx\").on(table.faculty),\n]);\n\nexport const studyMaterialPurchases = pgTable(\"study_material_purchases\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  materialId: varchar(\"material_id\").notNull().references(() => studyMaterials.id, { onDelete: \"cascade\" }),\n  buyerId: varchar(\"buyer_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"study_material_purchases_material_idx\").on(table.materialId),\n  index(\"study_material_purchases_buyer_idx\").on(table.buyerId),\n]);\n\nexport const studyMaterialRatings = pgTable(\"study_material_ratings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  materialId: varchar(\"material_id\").notNull().references(() => studyMaterials.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  rating: integer(\"rating\").notNull(),\n  review: text(\"review\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"study_material_ratings_material_idx\").on(table.materialId),\n  index(\"study_material_ratings_user_idx\").on(table.userId),\n]);\n\nexport const insertStudyMaterialSchema = createInsertSchema(studyMaterials).omit({\n  id: true,\n  downloads: true,\n  views: true,\n  rating: true,\n  ratingCount: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const createStudyMaterialSchema = z.object({\n  title: z.string().min(3, \"Title must be at least 3 characters\").max(200),\n  description: z.string().max(2000).optional(),\n  materialType: z.enum([\"past_question\", \"handout\", \"summary\", \"textbook\", \"lab_report\", \"project\", \"lecture_note\"]),\n  courseCode: z.string().min(2).max(20),\n  courseName: z.string().max(200).optional(),\n  faculty: z.string().max(100).optional(),\n  department: z.string().max(100).optional(),\n  level: z.enum([\"100L\", \"200L\", \"300L\", \"400L\", \"500L\", \"postgraduate\"]),\n  semester: z.string().max(20).optional(),\n  academicYear: z.string().max(20).optional(),\n  price: z.number().min(0).default(0),\n  isFree: z.boolean().default(true),\n});\n\nexport type StudyMaterial = typeof studyMaterials.$inferSelect;\nexport type InsertStudyMaterial = z.infer<typeof insertStudyMaterialSchema>;\nexport type CreateStudyMaterialInput = z.infer<typeof createStudyMaterialSchema>;\nexport type StudyMaterialPurchase = typeof studyMaterialPurchases.$inferSelect;\nexport type StudyMaterialRating = typeof studyMaterialRatings.$inferSelect;\n\n// ===========================================\n// EMAIL VERIFICATION TOKENS\n// ===========================================\n\nexport const emailVerificationTokens = pgTable(\"email_verification_tokens\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  token: varchar(\"token\", { length: 64 }).notNull(),\n  code: varchar(\"code\", { length: 6 }).notNull(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  isUsed: boolean(\"is_used\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"email_verification_user_idx\").on(table.userId),\n  index(\"email_verification_token_idx\").on(table.token),\n]);\n\nexport type EmailVerificationToken = typeof emailVerificationTokens.$inferSelect;\n","path":null,"size_bytes":139654,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000\nconst TOAST_DURATION = 3000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3920,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/pages/admin.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Users, ShoppingBag, TrendingUp, AlertCircle, Shield, Ban, Database, Activity, HardDrive, Megaphone, Pin, Trash2, Edit, Plus, Sparkles, AlertTriangle, ScanFace, Check, X, Eye, Settings } from \"lucide-react\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport type { User, Product, Announcement, KycVerification, PlatformSetting } from \"@shared/schema\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from \"recharts\";\n\nexport default function AdminPanel() {\n  const { user, isLoading: authLoading, isAdmin } = useAuth();\n  const { toast } = useToast();\n\n  // Redirect if not admin\n  useEffect(() => {\n    if (!authLoading && !isAdmin) {\n      toast({\n        title: \"Access Denied\",\n        description: \"You need to be an admin to access this page\",\n        variant: \"destructive\",\n      });\n      window.location.href = \"/\";\n    }\n  }, [authLoading, isAdmin, toast]);\n\n  const { data: users, isLoading: usersLoading } = useQuery<User[]>({\n    queryKey: [\"/api/admin/users\"],\n  });\n\n  const { data: products, isLoading: productsLoading } = useQuery<Product[]>({\n    queryKey: [\"/api/admin/products\"],\n  });\n\n  const { data: announcements, isLoading: announcementsLoading } = useQuery<Announcement[]>({\n    queryKey: [\"/api/admin/announcements\"],\n  });\n\n  // KYC Review types - extend KycVerification with user info\n  interface KycVerificationWithUser extends KycVerification {\n    user?: {\n      id: string;\n      email: string;\n      firstName: string | null;\n      lastName: string | null;\n      phoneNumber: string | null;\n    };\n  }\n\n  const { data: pendingKyc, isLoading: kycLoading } = useQuery<KycVerificationWithUser[]>({\n    queryKey: [\"/api/kyc/admin/pending\"],\n  });\n\n  const { data: platformSettings, isLoading: settingsLoading } = useQuery<PlatformSetting[]>({\n    queryKey: [\"/api/admin/platform-settings\"],\n  });\n\n  const [announcementDialogOpen, setAnnouncementDialogOpen] = useState(false);\n  const [editingAnnouncement, setEditingAnnouncement] = useState<Announcement | null>(null);\n  const [newAnnouncement, setNewAnnouncement] = useState<{\n    title: string;\n    content: string;\n    category: \"update\" | \"feature\" | \"alert\";\n    priority: \"low\" | \"normal\" | \"high\";\n    isPinned: boolean;\n    isPublished: boolean;\n  }>({\n    title: \"\",\n    content: \"\",\n    category: \"update\",\n    priority: \"normal\",\n    isPinned: false,\n    isPublished: true,\n  });\n\n  // KYC Review state\n  const [kycReviewDialogOpen, setKycReviewDialogOpen] = useState(false);\n  const [selectedKyc, setSelectedKyc] = useState<KycVerificationWithUser | null>(null);\n  const [kycReviewData, setKycReviewData] = useState({\n    action: \"approve\" as \"approve\" | \"reject\",\n    notes: \"\",\n    rejectionReason: \"\",\n  });\n  const [imagePreviewUrl, setImagePreviewUrl] = useState<string | null>(null);\n\n  const verifyUserMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      return await apiRequest(\"PUT\", `/api/admin/users/${userId}/verify`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      toast({\n        title: \"Success\",\n        description: \"User verified successfully\",\n      });\n    },\n  });\n\n  const banUserMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      return await apiRequest(\"PUT\", `/api/admin/users/${userId}/ban`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      toast({\n        title: \"Success\",\n        description: \"User banned successfully\",\n      });\n    },\n  });\n\n  const approveProductMutation = useMutation({\n    mutationFn: async (productId: string) => {\n      return await apiRequest(\"PUT\", `/api/admin/products/${productId}/approve`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/products\"] });\n      toast({\n        title: \"Success\",\n        description: \"Product approved successfully\",\n      });\n    },\n  });\n\n  const createAnnouncementMutation = useMutation({\n    mutationFn: async (data: typeof newAnnouncement) => {\n      return await apiRequest(\"POST\", \"/api/announcements\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/announcements\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/announcements\"] });\n      setAnnouncementDialogOpen(false);\n      setNewAnnouncement({\n        title: \"\",\n        content: \"\",\n        category: \"update\",\n        priority: \"normal\",\n        isPinned: false,\n        isPublished: true,\n      });\n      toast({\n        title: \"Success\",\n        description: \"Announcement created successfully\",\n      });\n    },\n  });\n\n  const updateAnnouncementMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<typeof newAnnouncement> }) => {\n      return await apiRequest(\"PATCH\", `/api/announcements/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/announcements\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/announcements\"] });\n      setAnnouncementDialogOpen(false);\n      setEditingAnnouncement(null);\n      toast({\n        title: \"Success\",\n        description: \"Announcement updated successfully\",\n      });\n    },\n  });\n\n  const deleteAnnouncementMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"DELETE\", `/api/announcements/${id}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/announcements\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/announcements\"] });\n      toast({\n        title: \"Success\",\n        description: \"Announcement deleted successfully\",\n      });\n    },\n  });\n\n  const updatePlatformSettingMutation = useMutation({\n    mutationFn: async ({ key, value }: { key: string; value: string }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/platform-settings/${key}`, { value });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/platform-settings\"] });\n      toast({\n        title: \"Success\",\n        description: \"Setting updated successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update setting\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // KYC Review mutation\n  const reviewKycMutation = useMutation({\n    mutationFn: async (data: { kycId: string; action: \"approve\" | \"reject\"; notes?: string; rejectionReason?: string }) => {\n      return await apiRequest(\"POST\", \"/api/kyc/admin/review\", data);\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/kyc/admin/pending\"] });\n      setKycReviewDialogOpen(false);\n      setSelectedKyc(null);\n      setKycReviewData({ action: \"approve\", notes: \"\", rejectionReason: \"\" });\n      toast({\n        title: \"Success\",\n        description: variables.action === \"approve\" \n          ? \"KYC verification approved successfully\" \n          : \"KYC verification rejected\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to process KYC review\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // KYC Review handlers\n  const handleOpenKycReview = (kyc: KycVerificationWithUser) => {\n    setSelectedKyc(kyc);\n    setKycReviewData({ action: \"approve\", notes: \"\", rejectionReason: \"\" });\n    setKycReviewDialogOpen(true);\n  };\n\n  const handleSubmitKycReview = () => {\n    if (!selectedKyc) return;\n    \n    // Validate rejection reason if rejecting\n    if (kycReviewData.action === \"reject\" && !kycReviewData.rejectionReason.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Rejection reason is required when rejecting a verification\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    reviewKycMutation.mutate({\n      kycId: selectedKyc.id,\n      action: kycReviewData.action,\n      notes: kycReviewData.notes || undefined,\n      rejectionReason: kycReviewData.action === \"reject\" ? kycReviewData.rejectionReason : undefined,\n    });\n  };\n\n  const handleOpenAnnouncementDialog = (announcement?: Announcement) => {\n    if (announcement) {\n      setEditingAnnouncement(announcement);\n      setNewAnnouncement({\n        title: announcement.title,\n        content: announcement.content,\n        category: (announcement.category || \"update\") as \"update\" | \"feature\" | \"alert\",\n        priority: (announcement.priority || \"normal\") as \"low\" | \"normal\" | \"high\",\n        isPinned: announcement.isPinned || false,\n        isPublished: announcement.isPublished || true,\n      });\n    } else {\n      setEditingAnnouncement(null);\n      setNewAnnouncement({\n        title: \"\",\n        content: \"\",\n        category: \"update\",\n        priority: \"normal\",\n        isPinned: false,\n        isPublished: true,\n      });\n    }\n    setAnnouncementDialogOpen(true);\n  };\n\n  const handleSubmitAnnouncement = () => {\n    if (editingAnnouncement) {\n      updateAnnouncementMutation.mutate({ id: editingAnnouncement.id, data: newAnnouncement });\n    } else {\n      createAnnouncementMutation.mutate(newAnnouncement);\n    }\n  };\n\n  if (authLoading || !user) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Skeleton className=\"h-96\" />\n      </div>\n    );\n  }\n\n  const totalUsers = users?.length || 0;\n  const verifiedUsers = users?.filter((u) => u.isVerified).length || 0;\n  const totalProducts = products?.length || 0;\n  const flaggedProducts = products?.filter((p) => p.isFlagged).length || 0;\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <h1 className=\"text-3xl font-bold mb-8\">Admin Panel</h1>\n\n      {/* Stats Cards */}\n      <div className=\"grid gap-6 md:grid-cols-4 mb-8\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Users</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-users\">{totalUsers}</div>\n            <p className=\"text-xs text-muted-foreground\">\n              {verifiedUsers} verified\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Products</CardTitle>\n            <ShoppingBag className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-products\">{totalProducts}</div>\n            <p className=\"text-xs text-muted-foreground\">\n              Active listings\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Flagged Items</CardTitle>\n            <AlertCircle className=\"h-4 w-4 text-destructive\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-destructive\" data-testid=\"text-flagged-products\">\n              {flaggedProducts}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Needs review\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Revenue</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">₦0</div>\n            <p className=\"text-xs text-muted-foreground\">\n              This month\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Tabs for User and Product Management */}\n      <Tabs defaultValue=\"users\" className=\"space-y-6\">\n        <TabsList className=\"flex-wrap\">\n          <TabsTrigger value=\"users\" data-testid=\"tab-users\">Users</TabsTrigger>\n          <TabsTrigger value=\"products\" data-testid=\"tab-products\">Products</TabsTrigger>\n          <TabsTrigger value=\"announcements\" data-testid=\"tab-announcements\">Campus Updates</TabsTrigger>\n          <TabsTrigger value=\"kyc\" data-testid=\"tab-kyc\">KYC Review</TabsTrigger>\n          <TabsTrigger value=\"settings\" data-testid=\"tab-settings\">Settings</TabsTrigger>\n          <TabsTrigger value=\"metrics\" data-testid=\"tab-metrics\">Database Metrics</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"users\">\n          <Card>\n            <CardHeader>\n              <CardTitle>User Management</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {usersLoading ? (\n                <div className=\"space-y-4\">\n                  {[...Array(5)].map((_, i) => (\n                    <Skeleton key={i} className=\"h-16\" />\n                  ))}\n                </div>\n              ) : users && users.length > 0 ? (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>User</TableHead>\n                        <TableHead>Role</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead>Trust Score</TableHead>\n                        <TableHead className=\"text-right\">Actions</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {users.map((u) => (\n                        <TableRow key={u.id}>\n                          <TableCell>\n                            <div>\n                              <p className=\"font-medium\" data-testid={`text-user-name-${u.id}`}>\n                                {u.firstName || u.email}\n                              </p>\n                              <p className=\"text-sm text-muted-foreground\">\n                                {u.email}\n                              </p>\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant=\"secondary\">{u.role}</Badge>\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex gap-1 flex-wrap\">\n                              {u.isVerified && (\n                                <Badge variant=\"default\" className=\"gap-1\">\n                                  <Shield className=\"h-3 w-3\" />\n                                  Verified\n                                </Badge>\n                              )}\n                              {u.isBanned && (\n                                <Badge variant=\"destructive\" className=\"gap-1\">\n                                  <Ban className=\"h-3 w-3\" />\n                                  Banned\n                                </Badge>\n                              )}\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            {u.trustScore || \"5.0\"} ({u.totalRatings || 0})\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            <div className=\"flex justify-end gap-2\">\n                              {!u.isVerified && (\n                                <Button\n                                  size=\"sm\"\n                                  onClick={() => verifyUserMutation.mutate(u.id)}\n                                  data-testid={`button-verify-${u.id}`}\n                                >\n                                  Verify\n                                </Button>\n                              )}\n                              {!u.isBanned && u.id !== user.id && (\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"destructive\"\n                                  onClick={() => banUserMutation.mutate(u.id)}\n                                  data-testid={`button-ban-${u.id}`}\n                                >\n                                  Ban\n                                </Button>\n                              )}\n                            </div>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              ) : (\n                <p className=\"text-center py-8 text-muted-foreground\">No users found</p>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"products\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Product Moderation</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {productsLoading ? (\n                <div className=\"space-y-4\">\n                  {[...Array(5)].map((_, i) => (\n                    <Skeleton key={i} className=\"h-16\" />\n                  ))}\n                </div>\n              ) : products && products.length > 0 ? (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Product</TableHead>\n                        <TableHead>Price</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead>Views</TableHead>\n                        <TableHead className=\"text-right\">Actions</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {products.map((product) => (\n                        <TableRow key={product.id}>\n                          <TableCell>\n                            <div className=\"flex items-center gap-3\">\n                              <img\n                                src={product.images[0] || \"/placeholder-product.png\"}\n                                alt={product.title}\n                                className=\"h-12 w-12 rounded object-cover\"\n                                loading=\"lazy\"\n                              />\n                              <p className=\"font-medium line-clamp-1\" data-testid={`text-product-title-${product.id}`}>\n                                {product.title}\n                              </p>\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"font-medium\">\n                            ₦{parseFloat(product.price as string).toLocaleString()}\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex gap-1 flex-wrap\">\n                              {product.isFlagged && (\n                                <Badge variant=\"destructive\">Flagged</Badge>\n                              )}\n                              {!product.isApproved && (\n                                <Badge variant=\"secondary\">Pending</Badge>\n                              )}\n                              {product.isApproved && !product.isFlagged && (\n                                <Badge variant=\"default\">Approved</Badge>\n                              )}\n                            </div>\n                          </TableCell>\n                          <TableCell>{product.views || 0}</TableCell>\n                          <TableCell className=\"text-right\">\n                            {!product.isApproved && (\n                              <Button\n                                size=\"sm\"\n                                onClick={() => approveProductMutation.mutate(product.id)}\n                                data-testid={`button-approve-${product.id}`}\n                              >\n                                Approve\n                              </Button>\n                            )}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              ) : (\n                <p className=\"text-center py-8 text-muted-foreground\">No products found</p>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"announcements\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-4 flex-wrap\">\n              <div>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Megaphone className=\"h-5 w-5\" />\n                  Campus Updates Management\n                </CardTitle>\n              </div>\n              <Dialog open={announcementDialogOpen} onOpenChange={setAnnouncementDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button onClick={() => handleOpenAnnouncementDialog()} data-testid=\"button-new-announcement\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    New Announcement\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n                  <DialogHeader>\n                    <DialogTitle>{editingAnnouncement ? \"Edit Announcement\" : \"Create New Announcement\"}</DialogTitle>\n                    <DialogDescription>\n                      {editingAnnouncement \n                        ? \"Update the announcement details below.\" \n                        : \"Create a new announcement to share with all users.\"}\n                    </DialogDescription>\n                  </DialogHeader>\n                  <div className=\"space-y-4 py-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"title\">Title</Label>\n                      <Input\n                        id=\"title\"\n                        value={newAnnouncement.title}\n                        onChange={(e) => setNewAnnouncement({ ...newAnnouncement, title: e.target.value })}\n                        placeholder=\"Announcement title\"\n                        data-testid=\"input-announcement-title\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"content\">Content</Label>\n                      <Textarea\n                        id=\"content\"\n                        value={newAnnouncement.content}\n                        onChange={(e) => setNewAnnouncement({ ...newAnnouncement, content: e.target.value })}\n                        placeholder=\"Write the announcement content...\"\n                        className=\"min-h-32\"\n                        data-testid=\"input-announcement-content\"\n                      />\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"category\">Category</Label>\n                        <Select\n                          value={newAnnouncement.category}\n                          onValueChange={(value: \"update\" | \"feature\" | \"alert\") => \n                            setNewAnnouncement({ ...newAnnouncement, category: value })\n                          }\n                        >\n                          <SelectTrigger data-testid=\"select-announcement-category\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"update\">\n                              <span className=\"flex items-center gap-2\">\n                                <Megaphone className=\"h-4 w-4\" />\n                                Update\n                              </span>\n                            </SelectItem>\n                            <SelectItem value=\"feature\">\n                              <span className=\"flex items-center gap-2\">\n                                <Sparkles className=\"h-4 w-4\" />\n                                New Feature\n                              </span>\n                            </SelectItem>\n                            <SelectItem value=\"alert\">\n                              <span className=\"flex items-center gap-2\">\n                                <AlertTriangle className=\"h-4 w-4\" />\n                                Alert\n                              </span>\n                            </SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"priority\">Priority</Label>\n                        <Select\n                          value={newAnnouncement.priority}\n                          onValueChange={(value: \"low\" | \"normal\" | \"high\") => \n                            setNewAnnouncement({ ...newAnnouncement, priority: value })\n                          }\n                        >\n                          <SelectTrigger data-testid=\"select-announcement-priority\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"low\">Low</SelectItem>\n                            <SelectItem value=\"normal\">Normal</SelectItem>\n                            <SelectItem value=\"high\">High</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-4\">\n                        <div className=\"flex items-center gap-2\">\n                          <Switch\n                            id=\"isPinned\"\n                            checked={newAnnouncement.isPinned}\n                            onCheckedChange={(checked) => \n                              setNewAnnouncement({ ...newAnnouncement, isPinned: checked })\n                            }\n                          />\n                          <Label htmlFor=\"isPinned\" className=\"flex items-center gap-1\">\n                            <Pin className=\"h-4 w-4\" />\n                            Pin to top\n                          </Label>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <Switch\n                            id=\"isPublished\"\n                            checked={newAnnouncement.isPublished}\n                            onCheckedChange={(checked) => \n                              setNewAnnouncement({ ...newAnnouncement, isPublished: checked })\n                            }\n                          />\n                          <Label htmlFor=\"isPublished\">Publish immediately</Label>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                  <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setAnnouncementDialogOpen(false)}>\n                      Cancel\n                    </Button>\n                    <Button \n                      onClick={handleSubmitAnnouncement}\n                      disabled={!newAnnouncement.title || !newAnnouncement.content || createAnnouncementMutation.isPending || updateAnnouncementMutation.isPending}\n                      data-testid=\"button-submit-announcement\"\n                    >\n                      {createAnnouncementMutation.isPending || updateAnnouncementMutation.isPending ? \"Saving...\" : editingAnnouncement ? \"Update\" : \"Create\"}\n                    </Button>\n                  </DialogFooter>\n                </DialogContent>\n              </Dialog>\n            </CardHeader>\n            <CardContent>\n              {announcementsLoading ? (\n                <div className=\"space-y-4\">\n                  {[...Array(3)].map((_, i) => (\n                    <Skeleton key={i} className=\"h-24\" />\n                  ))}\n                </div>\n              ) : announcements && announcements.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {announcements.map((announcement) => {\n                    const categoryConfig = {\n                      update: { icon: Megaphone, className: \"bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-500/30\" },\n                      feature: { icon: Sparkles, className: \"bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/30\" },\n                      alert: { icon: AlertTriangle, className: \"bg-red-500/10 text-red-600 dark:text-red-400 border-red-500/30\" },\n                    };\n                    const config = categoryConfig[announcement.category as keyof typeof categoryConfig] || categoryConfig.update;\n                    const CategoryIcon = config.icon;\n                    \n                    return (\n                      <div \n                        key={announcement.id} \n                        className={`border rounded-lg p-4 ${!announcement.isPublished ? 'opacity-60' : ''}`}\n                        data-testid={`card-admin-announcement-${announcement.id}`}\n                      >\n                        <div className=\"flex items-start justify-between gap-4\">\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2 mb-2 flex-wrap\">\n                              <Badge className={config.className} variant=\"outline\">\n                                <CategoryIcon className=\"h-3 w-3 mr-1\" />\n                                {announcement.category}\n                              </Badge>\n                              {announcement.isPinned && (\n                                <Badge variant=\"secondary\" className=\"gap-1\">\n                                  <Pin className=\"h-3 w-3\" />\n                                  Pinned\n                                </Badge>\n                              )}\n                              {!announcement.isPublished && (\n                                <Badge variant=\"outline\">Draft</Badge>\n                              )}\n                              {announcement.priority === \"high\" && (\n                                <Badge variant=\"destructive\" className=\"text-xs\">High Priority</Badge>\n                              )}\n                            </div>\n                            <h3 className=\"font-semibold text-lg mb-1\">{announcement.title}</h3>\n                            <p className=\"text-muted-foreground text-sm line-clamp-2\">{announcement.content}</p>\n                            <p className=\"text-xs text-muted-foreground mt-2\">\n                              {announcement.createdAt && formatDistanceToNow(new Date(announcement.createdAt), { addSuffix: true })}\n                              {announcement.views !== null && ` · ${announcement.views} views`}\n                            </p>\n                          </div>\n                          <div className=\"flex gap-2\">\n                            <Button\n                              size=\"icon\"\n                              variant=\"ghost\"\n                              onClick={() => handleOpenAnnouncementDialog(announcement)}\n                              data-testid={`button-edit-announcement-${announcement.id}`}\n                            >\n                              <Edit className=\"h-4 w-4\" />\n                            </Button>\n                            <Button\n                              size=\"icon\"\n                              variant=\"ghost\"\n                              onClick={() => deleteAnnouncementMutation.mutate(announcement.id)}\n                              disabled={deleteAnnouncementMutation.isPending}\n                              data-testid={`button-delete-announcement-${announcement.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4 text-destructive\" />\n                            </Button>\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              ) : (\n                <div className=\"text-center py-12\">\n                  <Megaphone className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                  <h3 className=\"font-semibold mb-2\">No Announcements Yet</h3>\n                  <p className=\"text-muted-foreground mb-4\">Create your first announcement to inform users about updates.</p>\n                  <Button onClick={() => handleOpenAnnouncementDialog()} data-testid=\"button-create-first-announcement\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Create Announcement\n                  </Button>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"kyc\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <ScanFace className=\"h-5 w-5\" />\n                KYC Verification Review\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {kycLoading ? (\n                <div className=\"space-y-4\">\n                  {[...Array(3)].map((_, i) => (\n                    <Skeleton key={i} className=\"h-24\" />\n                  ))}\n                </div>\n              ) : pendingKyc && pendingKyc.length > 0 ? (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>User</TableHead>\n                        <TableHead>NIN Name</TableHead>\n                        <TableHead>Similarity Score</TableHead>\n                        <TableHead>Images</TableHead>\n                        <TableHead>Submitted</TableHead>\n                        <TableHead className=\"text-right\">Actions</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {pendingKyc.map((kyc) => (\n                        <TableRow key={kyc.id} data-testid={`row-kyc-${kyc.id}`}>\n                          <TableCell>\n                            <div>\n                              <p className=\"font-medium\" data-testid={`text-kyc-user-${kyc.id}`}>\n                                {kyc.user?.firstName || kyc.user?.email || \"Unknown User\"}\n                                {kyc.user?.lastName ? ` ${kyc.user.lastName}` : \"\"}\n                              </p>\n                              <p className=\"text-sm text-muted-foreground\">\n                                {kyc.user?.email}\n                              </p>\n                              {kyc.user?.phoneNumber && (\n                                <p className=\"text-xs text-muted-foreground\">\n                                  {kyc.user.phoneNumber}\n                                </p>\n                              )}\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <div>\n                              <p className=\"font-medium\">\n                                {kyc.ninFirstName} {kyc.ninLastName}\n                              </p>\n                              {kyc.ninDateOfBirth && (\n                                <p className=\"text-xs text-muted-foreground\">\n                                  DOB: {kyc.ninDateOfBirth}\n                                </p>\n                              )}\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            {kyc.similarityScore ? (\n                              <Badge \n                                variant={parseFloat(kyc.similarityScore as string) >= 70 ? \"default\" : \"secondary\"}\n                                className={parseFloat(kyc.similarityScore as string) >= 70 ? \"bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/30\" : \"bg-yellow-500/10 text-yellow-600 dark:text-yellow-400 border-yellow-500/30\"}\n                              >\n                                {parseFloat(kyc.similarityScore as string).toFixed(1)}%\n                              </Badge>\n                            ) : (\n                              <Badge variant=\"secondary\">N/A</Badge>\n                            )}\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex gap-2\">\n                              {kyc.selfieUrl && (\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"outline\"\n                                  onClick={() => setImagePreviewUrl(kyc.selfieUrl)}\n                                  data-testid={`button-view-selfie-${kyc.id}`}\n                                >\n                                  <Eye className=\"h-3 w-3 mr-1\" />\n                                  Selfie\n                                </Button>\n                              )}\n                              {kyc.ninPhotoUrl && (\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"outline\"\n                                  onClick={() => setImagePreviewUrl(kyc.ninPhotoUrl)}\n                                  data-testid={`button-view-nin-${kyc.id}`}\n                                >\n                                  <Eye className=\"h-3 w-3 mr-1\" />\n                                  NIN\n                                </Button>\n                              )}\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            {kyc.createdAt && formatDistanceToNow(new Date(kyc.createdAt), { addSuffix: true })}\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            <Button\n                              size=\"sm\"\n                              onClick={() => handleOpenKycReview(kyc)}\n                              data-testid={`button-review-kyc-${kyc.id}`}\n                            >\n                              Review\n                            </Button>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              ) : (\n                <div className=\"text-center py-12\">\n                  <ScanFace className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                  <h3 className=\"font-semibold mb-2\">No Pending KYC Reviews</h3>\n                  <p className=\"text-muted-foreground\">All KYC verifications have been processed.</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* KYC Review Dialog */}\n          <Dialog open={kycReviewDialogOpen} onOpenChange={setKycReviewDialogOpen}>\n            <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>Review KYC Verification</DialogTitle>\n                <DialogDescription>\n                  Review the submitted verification documents and decide to approve or reject.\n                </DialogDescription>\n              </DialogHeader>\n              {selectedKyc && (\n                <div className=\"space-y-6 py-4\">\n                  {/* User Info Summary */}\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-1\">\n                      <Label className=\"text-muted-foreground text-xs\">Account Name</Label>\n                      <p className=\"font-medium\">\n                        {selectedKyc.user?.firstName} {selectedKyc.user?.lastName}\n                      </p>\n                      <p className=\"text-sm text-muted-foreground\">{selectedKyc.user?.email}</p>\n                    </div>\n                    <div className=\"space-y-1\">\n                      <Label className=\"text-muted-foreground text-xs\">NIN Name</Label>\n                      <p className=\"font-medium\">\n                        {selectedKyc.ninFirstName} {selectedKyc.ninLastName}\n                      </p>\n                      {selectedKyc.ninDateOfBirth && (\n                        <p className=\"text-sm text-muted-foreground\">DOB: {selectedKyc.ninDateOfBirth}</p>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Similarity Score */}\n                  <div className=\"space-y-2\">\n                    <Label className=\"text-muted-foreground text-xs\">Similarity Score</Label>\n                    <div className=\"flex items-center gap-2\">\n                      {selectedKyc.similarityScore ? (\n                        <>\n                          <Badge \n                            className={parseFloat(selectedKyc.similarityScore as string) >= 70 \n                              ? \"bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/30\" \n                              : \"bg-yellow-500/10 text-yellow-600 dark:text-yellow-400 border-yellow-500/30\"}\n                          >\n                            {parseFloat(selectedKyc.similarityScore as string).toFixed(1)}%\n                          </Badge>\n                          <span className=\"text-sm text-muted-foreground\">\n                            {parseFloat(selectedKyc.similarityScore as string) >= 70 \n                              ? \"Good match\" \n                              : \"Low match - requires manual review\"}\n                          </span>\n                        </>\n                      ) : (\n                        <Badge variant=\"secondary\">Not available</Badge>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Images */}\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label className=\"text-muted-foreground text-xs\">Selfie Image</Label>\n                      {selectedKyc.selfieUrl ? (\n                        <div className=\"border rounded-lg overflow-hidden\">\n                          <img \n                            src={selectedKyc.selfieUrl} \n                            alt=\"User Selfie\" \n                            className=\"w-full h-48 object-cover cursor-pointer\"\n                            loading=\"lazy\"\n                            onClick={() => setImagePreviewUrl(selectedKyc.selfieUrl)}\n                          />\n                        </div>\n                      ) : (\n                        <div className=\"border rounded-lg h-48 flex items-center justify-center bg-muted\">\n                          <p className=\"text-muted-foreground text-sm\">No selfie available</p>\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label className=\"text-muted-foreground text-xs\">NIN Photo</Label>\n                      {selectedKyc.ninPhotoUrl ? (\n                        <div className=\"border rounded-lg overflow-hidden\">\n                          <img \n                            src={selectedKyc.ninPhotoUrl} \n                            alt=\"NIN Photo\" \n                            className=\"w-full h-48 object-cover cursor-pointer\"\n                            loading=\"lazy\"\n                            onClick={() => setImagePreviewUrl(selectedKyc.ninPhotoUrl)}\n                          />\n                        </div>\n                      ) : (\n                        <div className=\"border rounded-lg h-48 flex items-center justify-center bg-muted\">\n                          <p className=\"text-muted-foreground text-sm\">No NIN photo available</p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Review Action */}\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"action\">Decision</Label>\n                    <Select\n                      value={kycReviewData.action}\n                      onValueChange={(value: \"approve\" | \"reject\") => \n                        setKycReviewData({ ...kycReviewData, action: value })\n                      }\n                    >\n                      <SelectTrigger data-testid=\"select-kyc-action\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"approve\">\n                          <span className=\"flex items-center gap-2\">\n                            <Check className=\"h-4 w-4 text-green-600\" />\n                            Approve Verification\n                          </span>\n                        </SelectItem>\n                        <SelectItem value=\"reject\">\n                          <span className=\"flex items-center gap-2\">\n                            <X className=\"h-4 w-4 text-red-600\" />\n                            Reject Verification\n                          </span>\n                        </SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  {/* Notes */}\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"notes\">Notes (optional)</Label>\n                    <Textarea\n                      id=\"notes\"\n                      value={kycReviewData.notes}\n                      onChange={(e) => setKycReviewData({ ...kycReviewData, notes: e.target.value })}\n                      placeholder=\"Add any notes about this verification...\"\n                      className=\"min-h-20\"\n                      data-testid=\"input-kyc-notes\"\n                    />\n                  </div>\n\n                  {/* Rejection Reason - only show if rejecting */}\n                  {kycReviewData.action === \"reject\" && (\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"rejectionReason\">Rejection Reason (required)</Label>\n                      <Textarea\n                        id=\"rejectionReason\"\n                        value={kycReviewData.rejectionReason}\n                        onChange={(e) => setKycReviewData({ ...kycReviewData, rejectionReason: e.target.value })}\n                        placeholder=\"Explain why this verification is being rejected...\"\n                        className=\"min-h-20\"\n                        data-testid=\"input-kyc-rejection-reason\"\n                      />\n                    </div>\n                  )}\n                </div>\n              )}\n              <DialogFooter>\n                <Button variant=\"outline\" onClick={() => setKycReviewDialogOpen(false)}>\n                  Cancel\n                </Button>\n                <Button \n                  onClick={handleSubmitKycReview}\n                  disabled={reviewKycMutation.isPending}\n                  variant={kycReviewData.action === \"reject\" ? \"destructive\" : \"default\"}\n                  data-testid=\"button-submit-kyc-review\"\n                >\n                  {reviewKycMutation.isPending \n                    ? \"Processing...\" \n                    : kycReviewData.action === \"approve\" \n                      ? \"Approve\" \n                      : \"Reject\"}\n                </Button>\n              </DialogFooter>\n            </DialogContent>\n          </Dialog>\n\n          {/* Image Preview Dialog */}\n          <Dialog open={!!imagePreviewUrl} onOpenChange={() => setImagePreviewUrl(null)}>\n            <DialogContent className=\"max-w-3xl\">\n              <DialogHeader>\n                <DialogTitle>Image Preview</DialogTitle>\n              </DialogHeader>\n              {imagePreviewUrl && (\n                <div className=\"flex justify-center\">\n                  <img \n                    src={imagePreviewUrl} \n                    alt=\"Preview\" \n                    className=\"max-w-full max-h-[70vh] object-contain rounded-lg\"\n                    loading=\"lazy\"\n                  />\n                </div>\n              )}\n            </DialogContent>\n          </Dialog>\n        </TabsContent>\n\n        <TabsContent value=\"settings\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Settings className=\"h-5 w-5\" />\n                Platform Settings\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {settingsLoading ? (\n                <div className=\"space-y-4\">\n                  {[...Array(3)].map((_, i) => (\n                    <Skeleton key={i} className=\"h-16\" />\n                  ))}\n                </div>\n              ) : (\n                <div className=\"space-y-6\">\n                  <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                        <Megaphone className=\"h-5 w-5 text-primary\" />\n                      </div>\n                      <div>\n                        <h4 className=\"font-medium\">Sponsored Ads System</h4>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Enable or disable sponsored advertisements in the marketplace\n                        </p>\n                      </div>\n                    </div>\n                    <Switch\n                      checked={platformSettings?.find(s => s.key === \"ads_enabled\")?.value !== \"false\"}\n                      onCheckedChange={(checked) => {\n                        updatePlatformSettingMutation.mutate({\n                          key: \"ads_enabled\",\n                          value: checked ? \"true\" : \"false\",\n                        });\n                      }}\n                      disabled={updatePlatformSettingMutation.isPending}\n                      data-testid=\"switch-ads-enabled\"\n                    />\n                  </div>\n\n                  <div className=\"p-4 bg-muted/50 rounded-lg\">\n                    <h4 className=\"font-medium mb-2 flex items-center gap-2\">\n                      <Sparkles className=\"h-4 w-4\" />\n                      About Sponsored Ads\n                    </h4>\n                    <ul className=\"text-sm text-muted-foreground space-y-1\">\n                      <li>Ads appear every 6th position in the marketplace grid</li>\n                      <li>Maximum 3 ads are shown at a time (randomized)</li>\n                      <li>Ads are clearly labeled with a \"Sponsored\" badge</li>\n                      <li>Impressions and clicks are tracked for analytics</li>\n                    </ul>\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"metrics\">\n          <DatabaseMetricsTab />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n\n// Database Metrics Types\ninterface TableMetric {\n  table_name: string;\n  row_estimate: number;\n  total_size_bytes: number;\n  indexes_size_bytes: number;\n  table_size_bytes: number;\n}\n\ninterface TableMetrics {\n  tables: TableMetric[];\n  totalDatabaseSize: number;\n}\n\ninterface ConnectionState {\n  state: string;\n  count: number;\n}\n\ninterface ActivityMetrics {\n  connectionsByState: ConnectionState[];\n  totalConnections: number;\n  maxConnectionAge: number;\n}\n\ninterface PerformanceMetrics {\n  queryStats: any[];\n  databaseStats: {\n    deadlocks: number;\n    temp_files: number;\n    temp_bytes: number;\n  };\n  extensionAvailable: boolean;\n}\n\n// Database Metrics Component\nfunction DatabaseMetricsTab() {\n  // Poll metrics every 30 seconds\n  const { data: tableMetrics, isLoading: tablesLoading } = useQuery<TableMetrics>({\n    queryKey: [\"/api/admin/metrics/tables\"],\n    refetchInterval: 30000,\n  });\n\n  const { data: activityMetrics, isLoading: activityLoading } = useQuery<ActivityMetrics>({\n    queryKey: [\"/api/admin/metrics/activity\"],\n    refetchInterval: 30000,\n  });\n\n  const { data: performanceMetrics, isLoading: performanceLoading } = useQuery<PerformanceMetrics>({\n    queryKey: [\"/api/admin/metrics/performance\"],\n    refetchInterval: 30000,\n  });\n\n  // Format bytes to readable size\n  const formatBytes = (bytes: number | null | undefined) => {\n    if (bytes === null || bytes === undefined || isNaN(bytes)) return '0 Bytes';\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    if (isNaN(i) || i < 0) return '0 Bytes';\n    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[Math.min(i, sizes.length - 1)];\n  };\n\n  // Prepare data for charts\n  const tableChartData = tableMetrics?.tables.slice(0, 10).map((t: any) => ({\n    name: t.table_name.split('.')[1] || t.table_name,\n    size: Math.round(t.total_size_bytes / 1024 / 1024 * 100) / 100, // MB\n    rows: t.row_estimate,\n  })) || [];\n\n  const connectionData = activityMetrics?.connectionsByState.map((c: any) => ({\n    name: c.state || 'unknown',\n    value: c.count,\n  })) || [];\n\n  const COLORS = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];\n\n  if (tablesLoading || activityLoading || performanceLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <Skeleton className=\"h-64\" />\n        <Skeleton className=\"h-64\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Summary Cards */}\n      <div className=\"grid gap-6 md:grid-cols-3\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Database Size</CardTitle>\n            <HardDrive className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-db-size\">\n              {formatBytes(tableMetrics?.totalDatabaseSize || 0)}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              {tableMetrics?.tables.length || 0} tables\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Active Connections</CardTitle>\n            <Activity className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-connections\">\n              {activityMetrics?.totalConnections || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Max age: {Math.round(activityMetrics?.maxConnectionAge || 0)}s\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Query Stats</CardTitle>\n            <Database className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-queries\">\n              {performanceMetrics?.queryStats?.length || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              {performanceMetrics?.extensionAvailable ? 'Extension enabled' : 'Enable pg_stat_statements'}\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Table Storage Chart */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Table Storage (Top 10)</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <ResponsiveContainer width=\"100%\" height={300}>\n            <BarChart data={tableChartData}>\n              <CartesianGrid strokeDasharray=\"3 3\" />\n              <XAxis dataKey=\"name\" angle={-45} textAnchor=\"end\" height={80} />\n              <YAxis label={{ value: 'Size (MB)', angle: -90, position: 'insideLeft' }} />\n              <Tooltip />\n              <Legend />\n              <Bar dataKey=\"size\" fill=\"#3b82f6\" name=\"Size (MB)\" />\n            </BarChart>\n          </ResponsiveContainer>\n        </CardContent>\n      </Card>\n\n      {/* Connection States */}\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Connection States</CardTitle>\n          </CardHeader>\n          <CardContent className=\"flex justify-center\">\n            <ResponsiveContainer width=\"100%\" height={250}>\n              <PieChart>\n                <Pie\n                  data={connectionData}\n                  cx=\"50%\"\n                  cy=\"50%\"\n                  labelLine={false}\n                  label={(entry) => `${entry.name}: ${entry.value}`}\n                  outerRadius={80}\n                  fill=\"#8884d8\"\n                  dataKey=\"value\"\n                >\n                  {connectionData.map((entry: any, index: number) => (\n                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\n                  ))}\n                </Pie>\n                <Tooltip />\n              </PieChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Performance Stats</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-muted-foreground\">Deadlocks</span>\n                <span className=\"font-medium\" data-testid=\"text-deadlocks\">\n                  {performanceMetrics?.databaseStats?.deadlocks || 0}\n                </span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-muted-foreground\">Temp Files</span>\n                <span className=\"font-medium\" data-testid=\"text-temp-files\">\n                  {performanceMetrics?.databaseStats?.temp_files || 0}\n                </span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm text-muted-foreground\">Temp Data</span>\n                <span className=\"font-medium\">\n                  {formatBytes(performanceMetrics?.databaseStats?.temp_bytes || 0)}\n                </span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Detailed Table Info */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Table Details</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"overflow-x-auto\">\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Table Name</TableHead>\n                  <TableHead className=\"text-right\">Rows</TableHead>\n                  <TableHead className=\"text-right\">Table Size</TableHead>\n                  <TableHead className=\"text-right\">Index Size</TableHead>\n                  <TableHead className=\"text-right\">Total Size</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {tableMetrics?.tables.map((table: any) => (\n                  <TableRow key={table.table_name}>\n                    <TableCell className=\"font-medium\">\n                      {table.table_name.split('.')[1] || table.table_name}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      {(table.row_estimate ?? 0).toLocaleString()}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      {formatBytes(table.table_size_bytes)}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      {formatBytes(table.indexes_size_bytes)}\n                    </TableCell>\n                    <TableCell className=\"text-right font-medium\">\n                      {formatBytes(table.total_size_bytes)}\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":61932,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"STATUS.md":{"content":"# EKSU Campus Marketplace - Current Status\n\n**Date:** November 25, 2025  \n**Database:** PostgreSQL 512MB (Neon)  \n**Status:** ✅ Fully functional with test data\n\n---\n\n## ✅ What's Working\n\n### 1. **Authentication System**\n- ✅ Signup with auto-login (no blank page issue!)\n- ✅ Login/logout functionality\n- ✅ Session persistence using PostgreSQL (30-day expiry)\n- ✅ Password hashing with bcrypt\n- ✅ Role-based access (buyer/seller/admin)\n- ✅ Protected API routes\n\n**Test Account:**\n- Email: `test@eksu.edu.ng`\n- Password: `Pass123!`\n- Role: Seller (can create listings)\n- Wallet: ₦11.93 (welcome bonus auto-credited)\n\n### 2. **Database & Schema**\n- ✅ 30+ tables initialized successfully\n- ✅ All relationships and foreign keys working\n- ✅ Session storage connected (no more blank pages!)\n- ✅ Database size: **512MB is more than sufficient**\n  - Expected usage: ~50-100MB for 10,000 users\n  - Current usage: <1MB with test data\n\n**Tables Include:**\n- Users, Products, Categories\n- Messages, Conversations (real-time chat)\n- Wallets, Transactions, Escrow\n- Reviews, Reports, Notifications\n- Sessions (fixes the blank page issue!)\n- Trust scores, Verification badges\n- Product views, Watchlists\n\n### 3. **Product Listings**\n- ✅ Categories: Textbooks, Electronics, Fashion, Furniture\n- ✅ Product CRUD operations (create, read, update, delete)\n- ✅ Image upload support (ready for integration)\n- ✅ Condition tracking (new, like_new, good, fair, poor)\n- ✅ Featured/boosted listings\n\n**Test Products Created:**\n1. Engineering Mathematics Textbook - ₦3,500\n2. iPhone 12 Pro 128GB - ₦185,000\n3. Nike Air Force 1 Size 42 - ₦15,000\n\n### 4. **Wallet System**\n- ✅ Auto-creates wallet on signup\n- ✅ Welcome bonus (₦2-₦50 random amount)\n- ✅ Balance tracking\n- ✅ Escrow support (for secure transactions)\n- ✅ Transaction history\n\n### 5. **Frontend Pages**\n- ✅ Landing page (hero, features, categories)\n- ✅ Authentication modals (signup/login)\n- ✅ Dark mode toggle\n- ✅ Responsive design (Tailwind CSS)\n- ✅ Product listing grids\n- ✅ Category browsing\n\n### 6. **APIs Working**\n```bash\nGET  /api/auth/user          # Current user\nPOST /api/auth/signup        # Create account (auto-login)\nPOST /api/auth/login         # Login\nPOST /api/auth/logout        # Logout\n\nGET  /api/products           # All products\nPOST /api/products           # Create listing (seller only)\nGET  /api/categories         # All categories\nGET  /api/wallet             # User wallet balance\n```\n\n---\n\n## 🔧 Optional Features (Need API Keys)\n\nThese features are **built into the codebase** but require external service setup:\n\n### 1. **Payment System (Paystack)**\n- Status: Code ready, needs API key\n- What it does: Process payments, fund wallets, withdraw earnings\n- Setup: Get API keys from https://paystack.com\n- Cost: Free tier available (2.5% per transaction)\n\n### 2. **NIN Verification (Korapay/Dojah)**\n- Status: Code ready, needs API key\n- What it does: Verify users with Nigerian National ID\n- Why: Trust badges, verified seller status\n- Setup: Choose Korapay or Dojah for NIN verification\n- Cost: Pay-per-verification (~₦50-100 per check)\n\n### 3. **AI Chatbot (Groq - FREE)**\n- Status: Code ready, using free Groq API\n- What it does: Help users with questions, product recommendations\n- Model: LLaMA 3.1 70B (fast inference)\n- Cost: **FREE** (generous free tier)\n- Setup: Get free API key from https://console.groq.com\n\n---\n\n## 📊 Database Size Analysis\n\n**Your 512MB database is MORE than sufficient!**\n\n### Estimated Usage:\n| Data Type | Size per Record | 10K Records | Notes |\n|-----------|----------------|-------------|-------|\n| Users | ~2KB | 20MB | With profile images |\n| Products | ~5KB | 50MB | Without images stored |\n| Messages | ~1KB | 10MB | 10K messages |\n| Transactions | ~500B | 5MB | Wallet history |\n| Sessions | ~500B | 5MB | Active sessions |\n| **Total** | - | **~90MB** | For 10K users |\n\n### Storage Strategy:\n- ✅ **Product images:** Store URLs only (use external hosting)\n- ✅ **Profile images:** Store URLs (upload to CDN)\n- ✅ **Sessions:** Auto-cleanup old sessions (30-day expiry)\n- ✅ **Messages:** Archive old conversations after 6 months\n\n**Conclusion:** 512MB database can handle **50,000+ users** comfortably!\n\n---\n\n## 🎯 Next Steps (If You Want to Deploy)\n\n### 1. **Test Real-Time Chat**\nThe WebSocket chat system is built but needs testing:\n- Open two browser windows\n- Login as different users\n- Start a conversation\n- Messages should appear instantly\n\n### 2. **Upload Product Images**\nCurrently products use placeholder images. To add real images:\n- Use Cloudinary (free tier: 25GB)\n- Or Uploadcare (free tier: 3GB)\n- Images stored as URLs in database\n\n### 3. **Add Payment Processing**\nTo enable real transactions:\n1. Sign up for Paystack (https://paystack.com)\n2. Get API keys (test + live)\n3. Add keys to `.env` as secrets\n4. Test with Paystack test cards\n\n### 4. **Setup NIN Verification**\nFor verified seller badges:\n1. Choose provider: Korapay or Dojah\n2. Get API credentials\n3. Add to `.env` as secrets\n4. Test with sample NIN\n\n### 5. **Enable AI Chatbot (FREE)**\n1. Sign up at https://console.groq.com\n2. Get free API key\n3. Add to `.env`: `GROQ_API_KEY=your_key`\n4. Test chatbot in app\n\n---\n\n## 🚀 How to Run\n\n**Already running!** The workflow is active:\n```bash\nnpm run dev  # Runs on port 5000\n```\n\n**Access the app:**\n- Landing page: http://localhost:5000\n- Click \"Get Started\" to signup\n- Browse products, test features\n\n---\n\n## 🔒 Security Features Built-In\n\n- ✅ Password hashing (bcrypt)\n- ✅ Session cookies (HTTP-only, secure)\n- ✅ CSRF protection ready\n- ✅ SQL injection prevention (Drizzle ORM)\n- ✅ Input validation (Zod schemas)\n- ✅ Rate limiting ready (for API abuse prevention)\n\n---\n\n## 📝 Summary\n\n**You have a FULLY FUNCTIONAL campus marketplace!**\n\n✅ Signup/login works (no blank pages!)  \n✅ Database connected (512MB is plenty)  \n✅ Products, categories, wallets all working  \n✅ Real-time chat built-in  \n✅ Trust system, verification ready  \n✅ Payment integration ready (just needs API key)\n\n**The blank page issue is FIXED!** Session storage now uses PostgreSQL instead of memory, so users stay logged in even after server restarts.\n\n**Next:** Test the app in your browser, create some products, and optionally add API keys for payments/verification if you want those features.\n","path":null,"size_bytes":6408,"size_tokens":null},"server/object-storage.ts":{"content":"import { v2 as cloudinary, UploadApiResponse } from \"cloudinary\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nlet cloudinaryConfigured = false;\n\nfunction initCloudinary(): boolean {\n  if (cloudinaryConfigured) {\n    return true;\n  }\n  \n  const cloudName = process.env.CLOUDINARY_CLOUD_NAME;\n  const apiKey = process.env.CLOUDINARY_API_KEY;\n  const apiSecret = process.env.CLOUDINARY_API_SECRET;\n  \n  if (cloudName && apiKey && apiSecret) {\n    cloudinary.config({\n      cloud_name: cloudName,\n      api_key: apiKey,\n      api_secret: apiSecret,\n    });\n    cloudinaryConfigured = true;\n    console.log(\"Cloudinary storage initialized successfully\");\n    return true;\n  }\n  \n  console.log(\"Cloudinary not configured, falling back to disk storage\");\n  return false;\n}\n\ninitCloudinary();\n\nconst uploadDir = path.join(process.cwd(), \"uploads\");\nif (!fs.existsSync(uploadDir)) {\n  fs.mkdirSync(uploadDir, { recursive: true });\n}\n\nasync function uploadToDisk(file: Express.Multer.File): Promise<string | null> {\n  try {\n    const timestamp = Date.now();\n    const randomId = Math.random().toString(36).substring(7);\n    const extension = file.originalname.split('.').pop() || 'jpg';\n    const filename = `${timestamp}-${randomId}.${extension}`;\n    const filepath = path.join(uploadDir, filename);\n    \n    fs.writeFileSync(filepath, file.buffer);\n    return `/uploads/${filename}`;\n  } catch (error) {\n    console.error(\"Disk upload failed:\", error);\n    return null;\n  }\n}\n\nasync function uploadToCloudinary(\n  file: Express.Multer.File,\n  folder: string = \"eksu-marketplace\"\n): Promise<string | null> {\n  try {\n    const base64Data = `data:${file.mimetype};base64,${file.buffer.toString('base64')}`;\n    \n    const result: UploadApiResponse = await cloudinary.uploader.upload(base64Data, {\n      folder: folder,\n      resource_type: \"auto\",\n      transformation: [\n        { quality: \"auto:good\" },\n        { fetch_format: \"auto\" }\n      ]\n    });\n    \n    return result.secure_url;\n  } catch (error) {\n    console.error(\"Cloudinary upload failed:\", error);\n    return null;\n  }\n}\n\nexport async function uploadToObjectStorage(\n  file: Express.Multer.File,\n  prefix: string = \"\"\n): Promise<string | null> {\n  const isConfigured = initCloudinary();\n  \n  if (isConfigured) {\n    const folder = prefix ? `eksu-marketplace/${prefix.replace(/\\/$/, '')}` : \"eksu-marketplace\";\n    const url = await uploadToCloudinary(file, folder);\n    if (url) {\n      return url;\n    }\n  }\n  \n  return uploadToDisk(file);\n}\n\nexport async function uploadMultipleToObjectStorage(\n  files: Express.Multer.File[],\n  prefix: string = \"\"\n): Promise<string[]> {\n  const uploadPromises = files.map(file => uploadToObjectStorage(file, prefix));\n  const results = await Promise.all(uploadPromises);\n  return results.filter((url): url is string => url !== null);\n}\n\nexport async function uploadVideoToStorage(\n  file: Express.Multer.File,\n  prefix: string = \"\"\n): Promise<string | null> {\n  const isConfigured = initCloudinary();\n  \n  if (isConfigured) {\n    try {\n      const base64Data = `data:${file.mimetype};base64,${file.buffer.toString('base64')}`;\n      const folder = prefix ? `eksu-marketplace/${prefix.replace(/\\/$/, '')}` : \"eksu-marketplace/videos\";\n      \n      const result: UploadApiResponse = await cloudinary.uploader.upload(base64Data, {\n        folder: folder,\n        resource_type: \"video\",\n        eager: [\n          { quality: \"auto\" }\n        ]\n      });\n      \n      return result.secure_url;\n    } catch (error) {\n      console.error(\"Cloudinary video upload failed:\", error);\n    }\n  }\n  \n  return uploadToDisk(file);\n}\n\nexport async function deleteFromStorage(url: string): Promise<boolean> {\n  if (!url) return false;\n  \n  if (url.includes('cloudinary.com')) {\n    try {\n      const urlParts = url.split('/');\n      const uploadIndex = urlParts.findIndex(part => part === 'upload');\n      if (uploadIndex !== -1) {\n        const publicIdWithExt = urlParts.slice(uploadIndex + 2).join('/');\n        const publicId = publicIdWithExt.replace(/\\.[^/.]+$/, '');\n        \n        await cloudinary.uploader.destroy(publicId);\n        return true;\n      }\n    } catch (error) {\n      console.error(\"Cloudinary delete failed:\", error);\n      return false;\n    }\n  }\n  \n  if (url.startsWith('/uploads/')) {\n    try {\n      const filename = url.replace('/uploads/', '');\n      const filepath = path.join(uploadDir, filename);\n      if (fs.existsSync(filepath)) {\n        fs.unlinkSync(filepath);\n        return true;\n      }\n    } catch (error) {\n      console.error(\"Disk delete failed:\", error);\n    }\n  }\n  \n  return false;\n}\n\nexport async function getObjectUrl(objectName: string): Promise<string | null> {\n  return null;\n}\n\nexport async function deleteFromObjectStorage(objectName: string): Promise<boolean> {\n  return deleteFromStorage(objectName);\n}\n\nexport async function listObjects(prefix: string = \"\"): Promise<string[]> {\n  return [];\n}\n\nexport function getClient(): null {\n  return null;\n}\n\nexport function isCloudinaryConfigured(): boolean {\n  return cloudinaryConfigured;\n}\n\nexport { initCloudinary as initObjectStorage, cloudinaryConfigured as objectStorageAvailable };\n","path":null,"size_bytes":5173,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4050,"size_tokens":null},"client/src/pages/referrals.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { \n  Link2, \n  Users, \n  DollarSign, \n  Copy, \n  Share2, \n  CheckCircle, \n  Clock, \n  XCircle,\n  Trophy,\n  Gift,\n  TrendingUp,\n  ShoppingCart,\n  AlertCircle\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { Referral } from \"@shared/schema\";\n\ninterface ReferralWithUser extends Referral {\n  referredUser?: {\n    firstName: string | null;\n    lastName: string | null;\n    email: string;\n    profileImageUrl: string | null;\n  };\n}\n\ninterface TierInfo {\n  name: string;\n  icon: typeof Trophy;\n  minReferrals: number;\n  maxReferrals: number | null;\n  bonusMultiplier: number;\n  color: string;\n  bgColor: string;\n  borderColor: string;\n}\n\nconst TIERS: TierInfo[] = [\n  { \n    name: \"Bronze\", \n    icon: Trophy, \n    minReferrals: 0, \n    maxReferrals: 4, \n    bonusMultiplier: 1, \n    color: \"text-orange-600 dark:text-orange-400\",\n    bgColor: \"bg-orange-100 dark:bg-orange-900/30\",\n    borderColor: \"border-orange-300 dark:border-orange-700\"\n  },\n  { \n    name: \"Silver\", \n    icon: Trophy, \n    minReferrals: 5, \n    maxReferrals: 14, \n    bonusMultiplier: 1.5, \n    color: \"text-slate-500 dark:text-slate-300\",\n    bgColor: \"bg-slate-100 dark:bg-slate-800/50\",\n    borderColor: \"border-slate-300 dark:border-slate-600\"\n  },\n  { \n    name: \"Gold\", \n    icon: Trophy, \n    minReferrals: 15, \n    maxReferrals: 29, \n    bonusMultiplier: 2, \n    color: \"text-yellow-600 dark:text-yellow-400\",\n    bgColor: \"bg-yellow-100 dark:bg-yellow-900/30\",\n    borderColor: \"border-yellow-400 dark:border-yellow-600\"\n  },\n  { \n    name: \"Platinum\", \n    icon: Trophy, \n    minReferrals: 30, \n    maxReferrals: 49, \n    bonusMultiplier: 2.5, \n    color: \"text-cyan-600 dark:text-cyan-400\",\n    bgColor: \"bg-cyan-100 dark:bg-cyan-900/30\",\n    borderColor: \"border-cyan-400 dark:border-cyan-600\"\n  },\n  { \n    name: \"Diamond\", \n    icon: Trophy, \n    minReferrals: 50, \n    maxReferrals: null, \n    bonusMultiplier: 3, \n    color: \"text-purple-600 dark:text-purple-400\",\n    bgColor: \"bg-purple-100 dark:bg-purple-900/30\",\n    borderColor: \"border-purple-400 dark:border-purple-600\"\n  },\n];\n\nfunction getTier(referralCount: number): TierInfo {\n  for (let i = TIERS.length - 1; i >= 0; i--) {\n    if (referralCount >= TIERS[i].minReferrals) {\n      return TIERS[i];\n    }\n  }\n  return TIERS[0];\n}\n\nfunction getNextTier(referralCount: number): TierInfo | null {\n  const currentTier = getTier(referralCount);\n  const currentIndex = TIERS.findIndex(t => t.name === currentTier.name);\n  if (currentIndex < TIERS.length - 1) {\n    return TIERS[currentIndex + 1];\n  }\n  return null;\n}\n\nfunction getProgressToNextTier(referralCount: number): number {\n  const currentTier = getTier(referralCount);\n  const nextTier = getNextTier(referralCount);\n  \n  if (!nextTier) return 100;\n  \n  const progressInCurrentTier = referralCount - currentTier.minReferrals;\n  const totalInCurrentTier = nextTier.minReferrals - currentTier.minReferrals;\n  \n  return Math.min((progressInCurrentTier / totalInCurrentTier) * 100, 100);\n}\n\nexport default function ReferralsPage() {\n  const { toast } = useToast();\n  const { user, isLoading: authLoading } = useAuth();\n  const [copied, setCopied] = useState(false);\n  const [copiedCode, setCopiedCode] = useState(false);\n\n  const { data: referrals, isLoading, isError, error, refetch } = useQuery<ReferralWithUser[]>({\n    queryKey: [\"/api/referrals\"],\n    enabled: !!user,\n    retry: 2,\n  });\n\n  const referralCode = (user as any)?.referralCode || \"--------\";\n  const referralLink = `${window.location.origin}/auth/signup?ref=${referralCode}`;\n\n  const copyToClipboard = async (text: string, type: \"link\" | \"code\") => {\n    try {\n      await navigator.clipboard.writeText(text);\n      if (type === \"link\") {\n        setCopied(true);\n        setTimeout(() => setCopied(false), 2000);\n      } else {\n        setCopiedCode(true);\n        setTimeout(() => setCopiedCode(false), 2000);\n      }\n      toast({\n        title: \"Copied!\",\n        description: `Referral ${type} copied to clipboard`,\n      });\n    } catch (err) {\n      toast({\n        title: \"Failed to copy\",\n        description: \"Please copy manually\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const shareLink = async () => {\n    if (navigator.share) {\n      try {\n        await navigator.share({\n          title: \"Join EKSU Marketplace\",\n          text: `Sign up on EKSU Campus Marketplace using my referral code: ${referralCode}. Get a welcome bonus when you join!`,\n          url: referralLink,\n        });\n      } catch (err) {\n        if ((err as Error).name !== \"AbortError\") {\n          copyToClipboard(referralLink, \"link\");\n        }\n      }\n    } else {\n      copyToClipboard(referralLink, \"link\");\n    }\n  };\n\n  const pendingReferrals = referrals?.filter(r => !r.bonusPaid) || [];\n  const completedReferrals = referrals?.filter(r => r.bonusPaid) || [];\n  const referralsWithPurchases = referrals?.filter(r => r.referredUserMadePurchase) || [];\n\n  const totalEarned = completedReferrals.reduce((sum, r) => sum + parseFloat(r.bonusAmount || \"0\"), 0);\n  const totalReferrals = referrals?.length || 0;\n  const successfulPurchases = referralsWithPurchases.length;\n\n  const currentTier = getTier(totalReferrals);\n  const nextTier = getNextTier(totalReferrals);\n  const progressToNextTier = getProgressToNextTier(totalReferrals);\n  const referralsNeededForNextTier = nextTier ? nextTier.minReferrals - totalReferrals : 0;\n\n  if (authLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-4xl\">\n        <div className=\"space-y-6\">\n          <Skeleton className=\"h-10 w-64\" />\n          <Skeleton className=\"h-48 w-full\" />\n          <div className=\"grid gap-4 md:grid-cols-4\">\n            {[...Array(4)].map((_, i) => (\n              <Skeleton key={i} className=\"h-24\" />\n            ))}\n          </div>\n          <Skeleton className=\"h-64 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-4xl\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center py-8\">\n              <AlertCircle className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold mb-2\">Authentication Required</h2>\n              <p className=\"text-muted-foreground mb-4\">Please log in to view your referrals.</p>\n              <Button asChild data-testid=\"button-login-referrals\">\n                <a href=\"/api/login\">Log In</a>\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-4xl\">\n        <div className=\"space-y-6\">\n          <Skeleton className=\"h-10 w-64\" />\n          <Skeleton className=\"h-48 w-full\" />\n          <div className=\"grid gap-4 md:grid-cols-4\">\n            {[...Array(4)].map((_, i) => (\n              <Skeleton key={i} className=\"h-24\" />\n            ))}\n          </div>\n          <Skeleton className=\"h-64 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (isError) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-4xl\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center py-8\">\n              <AlertCircle className=\"h-12 w-12 text-destructive mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold mb-2\">Failed to Load Referrals</h2>\n              <p className=\"text-muted-foreground mb-4\">\n                {error instanceof Error ? error.message : \"An unexpected error occurred\"}\n              </p>\n              <Button onClick={() => refetch()} data-testid=\"button-retry-referrals\">\n                Try Again\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 max-w-4xl\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold mb-2\" data-testid=\"text-page-title\">Referral Program</h1>\n        <p className=\"text-muted-foreground\">Invite friends and earn rewards for every successful referral</p>\n      </div>\n\n      <Card className={`mb-8 border-2 ${currentTier.borderColor}`}>\n        <CardHeader className={`${currentTier.bgColor}`}>\n          <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className={`rounded-full p-3 ${currentTier.bgColor}`}>\n                <Trophy className={`h-8 w-8 ${currentTier.color}`} />\n              </div>\n              <div>\n                <CardTitle className=\"flex items-center gap-2 flex-wrap\">\n                  <span data-testid=\"text-current-tier\">{currentTier.name} Tier</span>\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    {currentTier.bonusMultiplier}x Bonus\n                  </Badge>\n                </CardTitle>\n                <CardDescription>\n                  {nextTier \n                    ? `${referralsNeededForNextTier} more referral${referralsNeededForNextTier !== 1 ? 's' : ''} to reach ${nextTier.name}`\n                    : \"You've reached the highest tier!\"\n                  }\n                </CardDescription>\n              </div>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"pt-6\">\n          <div className=\"space-y-4\">\n            <div className=\"flex justify-between text-sm\">\n              <span className=\"text-muted-foreground\">Progress to next tier</span>\n              <span className=\"font-medium\" data-testid=\"text-tier-progress\">\n                {totalReferrals} / {nextTier?.minReferrals || totalReferrals} referrals\n              </span>\n            </div>\n            <Progress value={progressToNextTier} className=\"h-3\" data-testid=\"progress-tier\" />\n            <div className=\"flex flex-wrap justify-between gap-2 pt-2\">\n              {TIERS.map((tier) => (\n                <div \n                  key={tier.name} \n                  className={`flex items-center gap-1 text-xs ${\n                    tier.name === currentTier.name ? tier.color + \" font-semibold\" : \"text-muted-foreground\"\n                  }`}\n                >\n                  <Trophy className=\"h-3 w-3\" />\n                  <span>{tier.name}</span>\n                </div>\n              ))}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <div className=\"grid gap-4 grid-cols-2 lg:grid-cols-4 mb-8\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"rounded-full bg-primary/10 p-2\">\n                <Users className=\"h-5 w-5 text-primary\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-muted-foreground\">Total Referrals</p>\n                <p className=\"text-xl font-bold\" data-testid=\"text-total-referrals\">\n                  {totalReferrals}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"rounded-full bg-green-500/10 p-2\">\n                <DollarSign className=\"h-5 w-5 text-green-500\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-muted-foreground\">Total Earned</p>\n                <p className=\"text-xl font-bold\" data-testid=\"text-total-earned\">\n                  {totalEarned.toLocaleString()}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"rounded-full bg-blue-500/10 p-2\">\n                <ShoppingCart className=\"h-5 w-5 text-blue-500\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-muted-foreground\">Purchases Made</p>\n                <p className=\"text-xl font-bold\" data-testid=\"text-successful-purchases\">\n                  {successfulPurchases}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"rounded-full bg-yellow-500/10 p-2\">\n                <TrendingUp className=\"h-5 w-5 text-yellow-500\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-muted-foreground\">Pending Bonus</p>\n                <p className=\"text-xl font-bold\" data-testid=\"text-pending-count\">\n                  {pendingReferrals.length}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card className=\"mb-8\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Link2 className=\"h-5 w-5\" />\n            Your Referral Code & Link\n          </CardTitle>\n          <CardDescription>Share your code or link with friends to earn rewards</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"space-y-3\">\n            <label className=\"text-sm font-medium\">Referral Code</label>\n            <div className=\"flex gap-2\">\n              <Input\n                value={referralCode}\n                readOnly\n                className=\"font-mono text-lg font-bold tracking-wider text-center\"\n                data-testid=\"input-referral-code\"\n              />\n              <Button\n                variant=\"outline\"\n                onClick={() => copyToClipboard(referralCode, \"code\")}\n                data-testid=\"button-copy-code\"\n              >\n                {copiedCode ? <CheckCircle className=\"h-4 w-4\" /> : <Copy className=\"h-4 w-4\" />}\n              </Button>\n            </div>\n          </div>\n\n          <div className=\"space-y-3\">\n            <label className=\"text-sm font-medium\">Referral Link</label>\n            <div className=\"flex gap-2\">\n              <Input\n                value={referralLink}\n                readOnly\n                className=\"font-mono text-sm\"\n                data-testid=\"input-referral-link\"\n              />\n              <Button\n                variant=\"outline\"\n                onClick={() => copyToClipboard(referralLink, \"link\")}\n                data-testid=\"button-copy-link\"\n              >\n                {copied ? <CheckCircle className=\"h-4 w-4\" /> : <Copy className=\"h-4 w-4\" />}\n              </Button>\n            </div>\n          </div>\n\n          <Button onClick={shareLink} className=\"w-full\" data-testid=\"button-share-link\">\n            <Share2 className=\"h-4 w-4 mr-2\" />\n            Share Invitation Link\n          </Button>\n        </CardContent>\n      </Card>\n\n      <Card className=\"mb-8\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Gift className=\"h-5 w-5\" />\n            How It Works\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-6\">\n            <div className=\"text-center\">\n              <div className=\"rounded-full bg-primary/10 p-4 w-16 h-16 mx-auto mb-3 flex items-center justify-center\">\n                <Share2 className=\"h-6 w-6 text-primary\" />\n              </div>\n              <h3 className=\"font-semibold mb-1\">1. Share</h3>\n              <p className=\"text-sm text-muted-foreground\">Share your referral code or link with friends</p>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"rounded-full bg-primary/10 p-4 w-16 h-16 mx-auto mb-3 flex items-center justify-center\">\n                <Users className=\"h-6 w-6 text-primary\" />\n              </div>\n              <h3 className=\"font-semibold mb-1\">2. Friends Join</h3>\n              <p className=\"text-sm text-muted-foreground\">Friends sign up using your code and fund their wallet</p>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"rounded-full bg-green-500/10 p-4 w-16 h-16 mx-auto mb-3 flex items-center justify-center\">\n                <DollarSign className=\"h-6 w-6 text-green-500\" />\n              </div>\n              <h3 className=\"font-semibold mb-1\">3. Earn Rewards</h3>\n              <p className=\"text-sm text-muted-foreground\">Get bonus for each successful referral (up to 3x at Diamond tier)</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Users className=\"h-5 w-5\" />\n            Referral History\n          </CardTitle>\n          <CardDescription>Track all your referred users and their status</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Tabs defaultValue=\"all\">\n            <TabsList className=\"grid w-full grid-cols-4\">\n              <TabsTrigger value=\"all\" data-testid=\"tab-all\">\n                All ({referrals?.length || 0})\n              </TabsTrigger>\n              <TabsTrigger value=\"pending\" data-testid=\"tab-pending\">\n                Pending ({pendingReferrals.length})\n              </TabsTrigger>\n              <TabsTrigger value=\"completed\" data-testid=\"tab-completed\">\n                Completed ({completedReferrals.length})\n              </TabsTrigger>\n              <TabsTrigger value=\"purchased\" data-testid=\"tab-purchased\">\n                Purchased ({referralsWithPurchases.length})\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"all\" className=\"mt-4\">\n              {referrals && referrals.length > 0 ? (\n                <div className=\"space-y-3\">\n                  {referrals.map((ref) => (\n                    <ReferralItem key={ref.id} referral={ref} />\n                  ))}\n                </div>\n              ) : (\n                <EmptyState \n                  icon={Users} \n                  title=\"No referrals yet\" \n                  description=\"Share your referral link to start earning rewards\"\n                />\n              )}\n            </TabsContent>\n\n            <TabsContent value=\"pending\" className=\"mt-4\">\n              {pendingReferrals.length > 0 ? (\n                <div className=\"space-y-3\">\n                  {pendingReferrals.map((ref) => (\n                    <ReferralItem key={ref.id} referral={ref} />\n                  ))}\n                </div>\n              ) : (\n                <EmptyState \n                  icon={Clock} \n                  title=\"No pending referrals\" \n                  description=\"Pending referrals will appear here\"\n                />\n              )}\n            </TabsContent>\n\n            <TabsContent value=\"completed\" className=\"mt-4\">\n              {completedReferrals.length > 0 ? (\n                <div className=\"space-y-3\">\n                  {completedReferrals.map((ref) => (\n                    <ReferralItem key={ref.id} referral={ref} />\n                  ))}\n                </div>\n              ) : (\n                <EmptyState \n                  icon={CheckCircle} \n                  title=\"No completed referrals\" \n                  description=\"Completed referrals with paid bonuses will appear here\"\n                />\n              )}\n            </TabsContent>\n\n            <TabsContent value=\"purchased\" className=\"mt-4\">\n              {referralsWithPurchases.length > 0 ? (\n                <div className=\"space-y-3\">\n                  {referralsWithPurchases.map((ref) => (\n                    <ReferralItem key={ref.id} referral={ref} />\n                  ))}\n                </div>\n              ) : (\n                <EmptyState \n                  icon={ShoppingCart} \n                  title=\"No purchases yet\" \n                  description=\"Referrals who made purchases will appear here\"\n                />\n              )}\n            </TabsContent>\n          </Tabs>\n        </CardContent>\n      </Card>\n\n      <Card className=\"mt-8\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Trophy className=\"h-5 w-5\" />\n            Tier Benefits\n          </CardTitle>\n          <CardDescription>Unlock higher tiers for better rewards</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3\">\n            {TIERS.map((tier) => (\n              <div \n                key={tier.name}\n                className={`p-4 rounded-lg border-2 ${\n                  tier.name === currentTier.name \n                    ? `${tier.borderColor} ${tier.bgColor}` \n                    : \"border-border\"\n                }`}\n                data-testid={`tier-card-${tier.name.toLowerCase()}`}\n              >\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Trophy className={`h-5 w-5 ${tier.color}`} />\n                  <span className={`font-semibold ${tier.color}`}>{tier.name}</span>\n                  {tier.name === currentTier.name && (\n                    <Badge variant=\"secondary\" className=\"text-xs ml-auto\">Current</Badge>\n                  )}\n                </div>\n                <p className=\"text-sm text-muted-foreground mb-2\">\n                  {tier.minReferrals}+ referrals\n                </p>\n                <p className=\"text-lg font-bold\">{tier.bonusMultiplier}x Bonus</p>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction ReferralItem({ referral }: { referral: ReferralWithUser }) {\n  const statusConfig = {\n    completed: {\n      icon: CheckCircle,\n      color: \"text-green-500\",\n      badge: <Badge variant=\"default\" className=\"bg-green-500 dark:bg-green-600\">Paid</Badge>,\n    },\n    pending: {\n      icon: Clock,\n      color: \"text-yellow-500\",\n      badge: <Badge variant=\"secondary\">Pending</Badge>,\n    },\n  };\n\n  const status = referral.bonusPaid ? \"completed\" : \"pending\";\n  const config = statusConfig[status];\n  \n  const getUserDisplayName = () => {\n    if (referral.referredUser?.firstName && referral.referredUser?.lastName) {\n      return `${referral.referredUser.firstName} ${referral.referredUser.lastName}`;\n    }\n    if (referral.referredUser?.firstName) {\n      return referral.referredUser.firstName;\n    }\n    if (referral.referredUser?.email) {\n      return referral.referredUser.email.split('@')[0];\n    }\n    return \"Unknown User\";\n  };\n\n  const getAvatarInitials = () => {\n    if (referral.referredUser?.firstName && referral.referredUser?.lastName) {\n      return `${referral.referredUser.firstName[0]}${referral.referredUser.lastName[0]}`.toUpperCase();\n    }\n    if (referral.referredUser?.firstName) {\n      return referral.referredUser.firstName.slice(0, 2).toUpperCase();\n    }\n    if (referral.referredUser?.email) {\n      return referral.referredUser.email.slice(0, 2).toUpperCase();\n    }\n    return \"??\";\n  };\n\n  return (\n    <div\n      className=\"flex items-center justify-between gap-4 p-4 border rounded-lg\"\n      data-testid={`referral-item-${referral.id}`}\n    >\n      <div className=\"flex items-center gap-3 min-w-0 flex-1\">\n        <Avatar className=\"h-10 w-10 shrink-0\">\n          <AvatarFallback className=\"text-sm font-medium\">\n            {getAvatarInitials()}\n          </AvatarFallback>\n        </Avatar>\n        <div className=\"min-w-0 flex-1\">\n          <p className=\"font-medium truncate\" data-testid={`text-referral-name-${referral.id}`}>\n            {getUserDisplayName()}\n          </p>\n          <p className=\"text-sm text-muted-foreground\">\n            {referral.createdAt \n              ? format(new Date(referral.createdAt), \"MMM d, yyyy\")\n              : \"Date unknown\"\n            }\n          </p>\n        </div>\n      </div>\n      <div className=\"flex items-center gap-2 shrink-0\">\n        {referral.referredUserMadePurchase && (\n          <Badge variant=\"outline\" className=\"gap-1\">\n            <ShoppingCart className=\"h-3 w-3\" />\n            Purchased\n          </Badge>\n        )}\n        {referral.bonusPaid && referral.bonusAmount && (\n          <span className=\"font-semibold text-green-600 dark:text-green-400 whitespace-nowrap\">\n            +{parseFloat(referral.bonusAmount).toLocaleString()}\n          </span>\n        )}\n        {config.badge}\n      </div>\n    </div>\n  );\n}\n\nfunction EmptyState({ \n  icon: Icon, \n  title, \n  description \n}: { \n  icon: typeof Users; \n  title: string; \n  description: string;\n}) {\n  return (\n    <div className=\"text-center py-12\">\n      <Icon className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n      <h3 className=\"font-medium mb-1\">{title}</h3>\n      <p className=\"text-sm text-muted-foreground\">{description}</p>\n    </div>\n  );\n}\n","path":null,"size_bytes":25540,"size_tokens":null},"client/src/components/AuthModal.tsx":{"content":"import { useState, useEffect, useCallback, useRef, useMemo } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useLocation } from \"wouter\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ShoppingBag, Mail, Lock, User, Phone, ArrowLeft, Store, ShoppingCart, Gift, Check, AtSign, Loader2, X, CheckCircle2, Shield, RefreshCw } from \"lucide-react\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport {\n  InputOTP,\n  InputOTPGroup,\n  InputOTPSlot,\n} from \"@/components/ui/input-otp\";\n\ntype PasswordStrength = \"weak\" | \"medium\" | \"strong\";\n\ninterface PasswordStrengthResult {\n  strength: PasswordStrength;\n  score: number;\n  requirements: {\n    minLength: boolean;\n    hasLowercase: boolean;\n    hasUppercase: boolean;\n    hasNumber: boolean;\n    hasSpecialChar: boolean;\n  };\n}\n\nfunction calculatePasswordStrength(password: string): PasswordStrengthResult {\n  const requirements = {\n    minLength: password.length >= 8,\n    hasLowercase: /[a-z]/.test(password),\n    hasUppercase: /[A-Z]/.test(password),\n    hasNumber: /[0-9]/.test(password),\n    hasSpecialChar: /[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password),\n  };\n\n  let score = 0;\n  if (requirements.minLength) score += 1;\n  if (requirements.hasLowercase) score += 1;\n  if (requirements.hasUppercase) score += 1;\n  if (requirements.hasNumber) score += 1;\n  if (requirements.hasSpecialChar) score += 1;\n\n  if (password.length >= 12) score += 1;\n  if (password.length >= 16) score += 1;\n\n  let strength: PasswordStrength = \"weak\";\n  if (score >= 5) strength = \"strong\";\n  else if (score >= 3) strength = \"medium\";\n\n  return { strength, score, requirements };\n}\n\nfunction PasswordStrengthIndicator({ password }: { password: string }) {\n  const result = useMemo(() => calculatePasswordStrength(password), [password]);\n  \n  if (!password) return null;\n\n  const strengthConfig = {\n    weak: { \n      color: \"bg-red-500 dark:bg-red-400\", \n      width: \"33%\", \n      text: \"Weak\",\n      textColor: \"text-red-600 dark:text-red-400\"\n    },\n    medium: { \n      color: \"bg-yellow-500 dark:bg-yellow-400\", \n      width: \"66%\", \n      text: \"Medium\",\n      textColor: \"text-yellow-600 dark:text-yellow-400\"\n    },\n    strong: { \n      color: \"bg-green-500 dark:bg-green-400\", \n      width: \"100%\", \n      text: \"Strong\",\n      textColor: \"text-green-600 dark:text-green-400\"\n    },\n  };\n\n  const config = strengthConfig[result.strength];\n\n  return (\n    <div className=\"space-y-1 mt-1.5\" data-testid=\"password-strength-indicator\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-1\">\n          <Shield className={`h-3 w-3 ${config.textColor}`} />\n          <span className={`text-xs font-medium ${config.textColor}`} data-testid=\"password-strength-text\">\n            {config.text}\n          </span>\n        </div>\n      </div>\n      <div className=\"h-1 w-full rounded-full bg-muted overflow-hidden\">\n        <div\n          className={`h-full transition-all duration-300 ${config.color}`}\n          style={{ width: config.width }}\n          data-testid=\"password-strength-bar\"\n        />\n      </div>\n      <div className=\"flex flex-wrap gap-1 text-[10px]\">\n        <span className={result.requirements.minLength ? \"text-green-600 dark:text-green-400\" : \"text-muted-foreground\"}>\n          8+ chars\n        </span>\n        <span className=\"text-muted-foreground\">|</span>\n        <span className={result.requirements.hasLowercase ? \"text-green-600 dark:text-green-400\" : \"text-muted-foreground\"}>\n          a-z\n        </span>\n        <span className=\"text-muted-foreground\">|</span>\n        <span className={result.requirements.hasUppercase ? \"text-green-600 dark:text-green-400\" : \"text-muted-foreground\"}>\n          A-Z\n        </span>\n        <span className=\"text-muted-foreground\">|</span>\n        <span className={result.requirements.hasNumber ? \"text-green-600 dark:text-green-400\" : \"text-muted-foreground\"}>\n          0-9\n        </span>\n        <span className=\"text-muted-foreground\">|</span>\n        <span className={result.requirements.hasSpecialChar ? \"text-green-600 dark:text-green-400\" : \"text-muted-foreground\"}>\n          !@#$\n        </span>\n      </div>\n    </div>\n  );\n}\n\nconst signInSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n});\n\nconst signUpSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string()\n    .min(8, \"Password must be at least 8 characters\")\n    .refine((password) => {\n      const result = calculatePasswordStrength(password);\n      return result.strength !== \"weak\";\n    }, \"Password too weak. Add uppercase, numbers, or special characters\"),\n  confirmPassword: z.string(),\n  firstName: z.string().min(1, \"First name is required\"),\n  lastName: z.string().min(1, \"Last name is required\"),\n  username: z.string()\n    .min(3, \"Username must be at least 3 characters\")\n    .max(30, \"Username must be at most 30 characters\")\n    .regex(/^[a-zA-Z0-9_]+$/, \"Only letters, numbers, and underscores allowed\"),\n  phoneNumber: z.string().optional(),\n  role: z.enum([\"buyer\", \"seller\"]).default(\"buyer\"),\n  referralCode: z.string().optional(),\n}).refine((data) => data.password === data.confirmPassword, {\n  message: \"Passwords don't match\",\n  path: [\"confirmPassword\"],\n});\n\nconst verificationCodeSchema = z.object({\n  code: z.string().length(6, \"Enter the 6-digit code\"),\n});\n\nconst forgotPasswordSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n});\n\ntype SignInFormData = z.infer<typeof signInSchema>;\ntype SignUpFormData = z.infer<typeof signUpSchema>;\ntype ForgotPasswordFormData = z.infer<typeof forgotPasswordSchema>;\ntype VerificationCodeFormData = z.infer<typeof verificationCodeSchema>;\n\ninterface AuthModalProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  defaultTab?: \"signin\" | \"signup\";\n  defaultRole?: \"buyer\" | \"seller\";\n  defaultReferralCode?: string;\n}\n\nexport function AuthModal({ open, onOpenChange, defaultTab = \"signin\", defaultRole = \"buyer\", defaultReferralCode = \"\" }: AuthModalProps) {\n  const [activeTab, setActiveTab] = useState<string>(defaultTab);\n  const [showForgotPassword, setShowForgotPassword] = useState(false);\n  const [showVerification, setShowVerification] = useState(false);\n  const [verificationCode, setVerificationCode] = useState(\"\");\n  const [registeredEmail, setRegisteredEmail] = useState(\"\");\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n\n  useEffect(() => {\n    if (open) {\n      setActiveTab(defaultTab);\n      setShowForgotPassword(false);\n      setShowVerification(false);\n      setVerificationCode(\"\");\n      setRegisteredEmail(\"\");\n    }\n  }, [open, defaultTab]);\n\n  const signInForm = useForm<SignInFormData>({\n    resolver: zodResolver(signInSchema),\n    defaultValues: {\n      email: \"\",\n      password: \"\",\n    },\n  });\n\n  const signUpForm = useForm<SignUpFormData>({\n    resolver: zodResolver(signUpSchema),\n    defaultValues: {\n      email: \"\",\n      password: \"\",\n      confirmPassword: \"\",\n      firstName: \"\",\n      lastName: \"\",\n      username: \"\",\n      phoneNumber: \"\",\n      role: defaultRole,\n      referralCode: defaultReferralCode,\n    },\n  });\n\n  // Username availability checking state\n  const [usernameStatus, setUsernameStatus] = useState<\"idle\" | \"checking\" | \"available\" | \"taken\" | \"invalid\">(\"idle\");\n  const [usernameMessage, setUsernameMessage] = useState<string>(\"\");\n  const usernameCheckTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  \n  // Debounced username availability check\n  const checkUsernameAvailability = useCallback(async (username: string) => {\n    // Clear any existing timeout\n    if (usernameCheckTimeoutRef.current) {\n      clearTimeout(usernameCheckTimeoutRef.current);\n    }\n    \n    // Don't check if username is too short\n    if (!username || username.length < 3) {\n      setUsernameStatus(\"idle\");\n      setUsernameMessage(\"\");\n      return;\n    }\n    \n    // Basic validation before API call\n    if (username.length > 30) {\n      setUsernameStatus(\"invalid\");\n      setUsernameMessage(\"Username must be at most 30 characters\");\n      return;\n    }\n    \n    if (!/^[a-zA-Z0-9_]+$/.test(username)) {\n      setUsernameStatus(\"invalid\");\n      setUsernameMessage(\"Only letters, numbers, and underscores allowed\");\n      return;\n    }\n    \n    // Set checking state\n    setUsernameStatus(\"checking\");\n    setUsernameMessage(\"Checking availability...\");\n    \n    // Debounce: wait 500ms before checking\n    usernameCheckTimeoutRef.current = setTimeout(async () => {\n      try {\n        const response = await fetch(`/api/auth/check-username/${encodeURIComponent(username.toLowerCase())}`);\n        const data = await response.json();\n        \n        if (response.ok) {\n          if (data.available) {\n            setUsernameStatus(\"available\");\n            setUsernameMessage(\"Username is available\");\n          } else {\n            setUsernameStatus(\"taken\");\n            setUsernameMessage(data.message || \"Username is already taken\");\n          }\n        } else {\n          setUsernameStatus(\"invalid\");\n          setUsernameMessage(data.message || \"Error checking username\");\n        }\n      } catch (error) {\n        setUsernameStatus(\"idle\");\n        setUsernameMessage(\"\");\n        console.error(\"Error checking username:\", error);\n      }\n    }, 500);\n  }, []);\n  \n  // Cleanup timeout on unmount\n  useEffect(() => {\n    return () => {\n      if (usernameCheckTimeoutRef.current) {\n        clearTimeout(usernameCheckTimeoutRef.current);\n      }\n    };\n  }, []);\n  \n  useEffect(() => {\n    if (open && defaultRole) {\n      signUpForm.setValue(\"role\", defaultRole);\n    }\n  }, [open, defaultRole]);\n\n  useEffect(() => {\n    if (open && defaultReferralCode) {\n      signUpForm.setValue(\"referralCode\", defaultReferralCode);\n    }\n  }, [open, defaultReferralCode]);\n\n  const forgotPasswordForm = useForm<ForgotPasswordFormData>({\n    resolver: zodResolver(forgotPasswordSchema),\n    defaultValues: {\n      email: \"\",\n    },\n  });\n\n  const signInMutation = useMutation({\n    mutationFn: async (data: SignInFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/auth/login\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Welcome back!\",\n        description: \"You've successfully signed in.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      onOpenChange(false);\n      signInForm.reset();\n      setLocation(\"/\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Sign in failed\",\n        description: error.message || \"Invalid email or password\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const signUpMutation = useMutation({\n    mutationFn: async (data: SignUpFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/auth/register\", data);\n      return response.json();\n    },\n    onSuccess: (_, variables) => {\n      toast({\n        title: \"Account created!\",\n        description: \"Check your email for the verification code.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      setRegisteredEmail(variables.email);\n      setShowVerification(true);\n      signUpForm.reset();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Sign up failed\",\n        description: error.message || \"Unable to create account. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const verifyCodeMutation = useMutation({\n    mutationFn: async (code: string) => {\n      const response = await apiRequest(\"POST\", \"/api/auth/verify-email-code\", { code });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Email verified!\",\n        description: \"Your account is now fully set up.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      onOpenChange(false);\n      setLocation(\"/\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Verification failed\",\n        description: error.message || \"Invalid or expired code. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resendVerificationMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/auth/send-verification-email\", {});\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Code resent!\",\n        description: \"Check your email for the new verification code.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to resend\",\n        description: error.message || \"Unable to resend code. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const forgotPasswordMutation = useMutation({\n    mutationFn: async (data: ForgotPasswordFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/auth/forgot-password\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Reset link sent!\",\n        description: \"Check your email for password reset instructions.\",\n      });\n      setShowForgotPassword(false);\n      forgotPasswordForm.reset();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Request failed\",\n        description: error.message || \"Unable to send reset link. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSignIn = (data: SignInFormData) => {\n    signInMutation.mutate(data);\n  };\n\n  const onSignUp = (data: SignUpFormData) => {\n    signUpMutation.mutate(data);\n  };\n\n  const onForgotPassword = (data: ForgotPasswordFormData) => {\n    forgotPasswordMutation.mutate(data);\n  };\n\n  if (showForgotPassword) {\n    return (\n      <Dialog open={open} onOpenChange={onOpenChange}>\n        <DialogContent className=\"sm:max-w-[400px] max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-forgot-password\">\n          <DialogHeader>\n            <div className=\"flex items-center gap-2 mb-1\">\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={() => setShowForgotPassword(false)}\n                data-testid=\"button-back-to-signin\"\n              >\n                <ArrowLeft className=\"h-4 w-4\" />\n              </Button>\n              <div className=\"rounded-full bg-primary/10 p-1.5\">\n                <Lock className=\"h-4 w-4 text-primary\" />\n              </div>\n            </div>\n            <DialogTitle className=\"text-xl\">Reset Password</DialogTitle>\n            <DialogDescription className=\"text-sm\">\n              Enter your email to receive a reset link.\n            </DialogDescription>\n          </DialogHeader>\n\n          <Form {...forgotPasswordForm}>\n            <form onSubmit={forgotPasswordForm.handleSubmit(onForgotPassword)} className=\"space-y-3 mt-2\">\n              <FormField\n                control={forgotPasswordForm.control}\n                name=\"email\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-sm\">Email</FormLabel>\n                    <FormControl>\n                      <div className=\"relative\">\n                        <Mail className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                        <Input\n                          type=\"email\"\n                          placeholder=\"you@eksu.edu.ng\"\n                          className=\"pl-10\"\n                          data-testid=\"input-forgot-password-email\"\n                          {...field}\n                        />\n                      </div>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={forgotPasswordMutation.isPending}\n                data-testid=\"button-send-reset-link\"\n              >\n                {forgotPasswordMutation.isPending ? \"Sending...\" : \"Send Reset Link\"}\n              </Button>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n    );\n  }\n\n  if (showVerification) {\n    return (\n      <Dialog open={open} onOpenChange={(isOpen) => {\n        if (!isOpen) {\n          setShowVerification(false);\n          setVerificationCode(\"\");\n          setLocation(\"/\");\n        }\n        onOpenChange(isOpen);\n      }}>\n        <DialogContent className=\"sm:max-w-[400px] max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-verification\">\n          <DialogHeader className=\"text-center\">\n            <div className=\"mx-auto rounded-full bg-primary/10 p-3 mb-2\">\n              <Mail className=\"h-6 w-6 text-primary\" />\n            </div>\n            <DialogTitle className=\"text-xl\">Verify Your Email</DialogTitle>\n            <DialogDescription className=\"text-sm\">\n              We sent a 6-digit code to <span className=\"font-medium\">{registeredEmail}</span>\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 mt-4\">\n            <div className=\"flex justify-center\">\n              <InputOTP\n                maxLength={6}\n                value={verificationCode}\n                onChange={setVerificationCode}\n                data-testid=\"input-verification-code\"\n              >\n                <InputOTPGroup>\n                  <InputOTPSlot index={0} />\n                  <InputOTPSlot index={1} />\n                  <InputOTPSlot index={2} />\n                  <InputOTPSlot index={3} />\n                  <InputOTPSlot index={4} />\n                  <InputOTPSlot index={5} />\n                </InputOTPGroup>\n              </InputOTP>\n            </div>\n\n            <Button\n              type=\"button\"\n              className=\"w-full\"\n              disabled={verificationCode.length !== 6 || verifyCodeMutation.isPending}\n              onClick={() => verifyCodeMutation.mutate(verificationCode)}\n              data-testid=\"button-verify-code\"\n            >\n              {verifyCodeMutation.isPending ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Verifying...\n                </>\n              ) : (\n                <>\n                  <CheckCircle2 className=\"h-4 w-4 mr-2\" />\n                  Verify Email\n                </>\n              )}\n            </Button>\n\n            <div className=\"flex items-center justify-center gap-2 text-sm text-muted-foreground\">\n              <span>Didn't receive the code?</span>\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                size=\"sm\"\n                disabled={resendVerificationMutation.isPending}\n                onClick={() => resendVerificationMutation.mutate()}\n                data-testid=\"button-resend-verification\"\n              >\n                {resendVerificationMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"h-3 w-3 mr-1 animate-spin\" />\n                    Sending...\n                  </>\n                ) : (\n                  <>\n                    <RefreshCw className=\"h-3 w-3 mr-1\" />\n                    Resend\n                  </>\n                )}\n              </Button>\n            </div>\n\n            <div className=\"text-center pt-2 border-t\">\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => {\n                  setShowVerification(false);\n                  onOpenChange(false);\n                  setLocation(\"/\");\n                }}\n                data-testid=\"button-skip-verification\"\n              >\n                Skip for now\n              </Button>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                You can verify later from your profile settings\n              </p>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    );\n  }\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-[440px] max-h-[90vh] overflow-y-auto p-0 gap-0\" data-testid=\"dialog-auth\">\n        <div className=\"bg-gradient-to-br from-primary/10 to-primary/5 p-4 border-b sticky top-0 z-10\">\n          <div className=\"flex items-center gap-2\">\n            <div className=\"rounded-full bg-primary p-2\">\n              <ShoppingBag className=\"h-5 w-5 text-primary-foreground\" />\n            </div>\n            <div>\n              <DialogTitle className=\"text-lg\">EKSU Marketplace</DialogTitle>\n              <DialogDescription className=\"text-xs\">\n                Join students trading safely on campus\n              </DialogDescription>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"p-4\">\n          <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-2 mb-4\">\n              <TabsTrigger value=\"signin\" data-testid=\"tab-signin\">\n                Sign In\n              </TabsTrigger>\n              <TabsTrigger value=\"signup\" data-testid=\"tab-signup\">\n                Sign Up\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"signin\" className=\"mt-0\">\n              <Form {...signInForm}>\n                <form onSubmit={signInForm.handleSubmit(onSignIn)} className=\"space-y-3\">\n                  <FormField\n                    control={signInForm.control}\n                    name=\"email\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-sm\">Email</FormLabel>\n                        <FormControl>\n                          <div className=\"relative\">\n                            <Mail className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                            <Input\n                              type=\"email\"\n                              placeholder=\"you@eksu.edu.ng\"\n                              className=\"pl-10\"\n                              data-testid=\"input-signin-email\"\n                              {...field}\n                            />\n                          </div>\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={signInForm.control}\n                    name=\"password\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-sm\">Password</FormLabel>\n                        <FormControl>\n                          <div className=\"relative\">\n                            <Lock className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                            <Input\n                              type=\"password\"\n                              placeholder=\"Enter your password\"\n                              className=\"pl-10\"\n                              data-testid=\"input-signin-password\"\n                              {...field}\n                            />\n                          </div>\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"flex justify-end\">\n                    <Button\n                      type=\"button\"\n                      variant=\"ghost\"\n                      className=\"px-0 text-xs h-auto\"\n                      onClick={() => setShowForgotPassword(true)}\n                      data-testid=\"button-forgot-password\"\n                    >\n                      Forgot password?\n                    </Button>\n                  </div>\n\n                  <Button\n                    type=\"submit\"\n                    className=\"w-full\"\n                    disabled={signInMutation.isPending}\n                    data-testid=\"button-signin-submit\"\n                  >\n                    {signInMutation.isPending ? \"Signing in...\" : \"Sign In\"}\n                  </Button>\n                </form>\n              </Form>\n            </TabsContent>\n\n            <TabsContent value=\"signup\" className=\"mt-0\">\n              <Form {...signUpForm}>\n                <form onSubmit={signUpForm.handleSubmit(onSignUp)} className=\"space-y-3\">\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <FormField\n                      control={signUpForm.control}\n                      name=\"firstName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel className=\"text-sm\">First Name</FormLabel>\n                          <FormControl>\n                            <div className=\"relative\">\n                              <User className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                              <Input\n                                placeholder=\"John\"\n                                className=\"pl-10\"\n                                data-testid=\"input-signup-firstname\"\n                                {...field}\n                              />\n                            </div>\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={signUpForm.control}\n                      name=\"lastName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel className=\"text-sm\">Last Name</FormLabel>\n                          <FormControl>\n                            <div className=\"relative\">\n                              <User className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                              <Input\n                                placeholder=\"Doe\"\n                                className=\"pl-10\"\n                                data-testid=\"input-signup-lastname\"\n                                {...field}\n                              />\n                            </div>\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={signUpForm.control}\n                    name=\"email\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-sm\">Email</FormLabel>\n                        <FormControl>\n                          <div className=\"relative\">\n                            <Mail className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                            <Input\n                              type=\"email\"\n                              placeholder=\"you@eksu.edu.ng\"\n                              className=\"pl-10\"\n                              data-testid=\"input-signup-email\"\n                              {...field}\n                            />\n                          </div>\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={signUpForm.control}\n                    name=\"username\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-sm\">Username</FormLabel>\n                        <FormControl>\n                          <div className=\"relative\">\n                            <AtSign className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                            <Input\n                              placeholder=\"johndoe123\"\n                              className={`pl-10 pr-10 ${\n                                usernameStatus === \"available\" \n                                  ? \"border-green-500 focus-visible:ring-green-500\" \n                                  : usernameStatus === \"taken\" || usernameStatus === \"invalid\"\n                                  ? \"border-red-500 focus-visible:ring-red-500\"\n                                  : \"\"\n                              }`}\n                              data-testid=\"input-signup-username\"\n                              {...field}\n                              onChange={(e) => {\n                                field.onChange(e);\n                                checkUsernameAvailability(e.target.value);\n                              }}\n                            />\n                            <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                              {usernameStatus === \"checking\" && (\n                                <Loader2 className=\"h-4 w-4 animate-spin text-muted-foreground\" data-testid=\"icon-username-checking\" />\n                              )}\n                              {usernameStatus === \"available\" && (\n                                <CheckCircle2 className=\"h-4 w-4 text-green-500\" data-testid=\"icon-username-available\" />\n                              )}\n                              {(usernameStatus === \"taken\" || usernameStatus === \"invalid\") && (\n                                <X className=\"h-4 w-4 text-red-500\" data-testid=\"icon-username-taken\" />\n                              )}\n                            </div>\n                          </div>\n                        </FormControl>\n                        {usernameMessage && usernameStatus !== \"idle\" && (\n                          <p className={`text-xs mt-1 ${\n                            usernameStatus === \"available\" \n                              ? \"text-green-600 dark:text-green-400\" \n                              : usernameStatus === \"checking\"\n                              ? \"text-muted-foreground\"\n                              : \"text-red-600 dark:text-red-400\"\n                          }`} data-testid=\"text-username-status\">\n                            {usernameMessage}\n                          </p>\n                        )}\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={signUpForm.control}\n                    name=\"phoneNumber\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-sm\">Phone <span className=\"text-muted-foreground font-normal\">(Optional)</span></FormLabel>\n                        <FormControl>\n                          <div className=\"relative\">\n                            <Phone className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                            <Input\n                              type=\"tel\"\n                              placeholder=\"+234 XXX XXX XXXX\"\n                              className=\"pl-10\"\n                              data-testid=\"input-signup-phone\"\n                              {...field}\n                            />\n                          </div>\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={signUpForm.control}\n                    name=\"role\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-sm font-medium\">Role</FormLabel>\n                        <FormControl>\n                          <RadioGroup\n                            onValueChange={field.onChange}\n                            value={field.value}\n                            className=\"flex flex-wrap gap-2\"\n                          >\n                            <div className=\"flex-1 min-w-[100px]\">\n                              <RadioGroupItem\n                                value=\"buyer\"\n                                id=\"role-buyer\"\n                                className=\"peer sr-only\"\n                                data-testid=\"radio-role-buyer\"\n                              />\n                              <label\n                                htmlFor=\"role-buyer\"\n                                className=\"flex items-center gap-2 rounded-md border-2 border-muted bg-popover px-3 py-2 cursor-pointer transition-all peer-data-[state=checked]:border-primary peer-data-[state=checked]:bg-primary/5 [&:has([data-state=checked])]:border-primary [&:has([data-state=checked])]:bg-primary/5\"\n                              >\n                                <ShoppingCart className=\"h-4 w-4 text-blue-600 dark:text-blue-400 shrink-0\" />\n                                <span className=\"text-sm font-medium\">Buyer</span>\n                                {field.value === \"buyer\" && (\n                                  <Check className=\"h-3 w-3 text-primary ml-auto\" />\n                                )}\n                              </label>\n                            </div>\n                            <div className=\"flex-1 min-w-[100px]\">\n                              <RadioGroupItem\n                                value=\"seller\"\n                                id=\"role-seller\"\n                                className=\"peer sr-only\"\n                                data-testid=\"radio-role-seller\"\n                              />\n                              <label\n                                htmlFor=\"role-seller\"\n                                className=\"flex items-center gap-2 rounded-md border-2 border-muted bg-popover px-3 py-2 cursor-pointer transition-all peer-data-[state=checked]:border-primary peer-data-[state=checked]:bg-primary/5 [&:has([data-state=checked])]:border-primary [&:has([data-state=checked])]:bg-primary/5\"\n                              >\n                                <Store className=\"h-4 w-4 text-green-600 dark:text-green-400 shrink-0\" />\n                                <span className=\"text-sm font-medium\">Seller</span>\n                                {field.value === \"seller\" && (\n                                  <Check className=\"h-3 w-3 text-primary ml-auto\" />\n                                )}\n                              </label>\n                            </div>\n                          </RadioGroup>\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={signUpForm.control}\n                    name=\"password\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-sm\">Password</FormLabel>\n                        <FormControl>\n                          <div className=\"relative\">\n                            <Lock className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                            <Input\n                              type=\"password\"\n                              placeholder=\"Strong password required\"\n                              className=\"pl-10\"\n                              data-testid=\"input-signup-password\"\n                              {...field}\n                            />\n                          </div>\n                        </FormControl>\n                        <PasswordStrengthIndicator password={field.value} />\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={signUpForm.control}\n                    name=\"confirmPassword\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-sm\">Confirm Password</FormLabel>\n                        <FormControl>\n                          <div className=\"relative\">\n                            <Lock className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                            <Input\n                              type=\"password\"\n                              placeholder=\"Re-enter your password\"\n                              className=\"pl-10\"\n                              data-testid=\"input-signup-confirm-password\"\n                              {...field}\n                            />\n                          </div>\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={signUpForm.control}\n                    name=\"referralCode\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-sm\">\n                          Referral Code <span className=\"text-muted-foreground font-normal\">(Optional)</span>\n                        </FormLabel>\n                        <FormControl>\n                          <div className=\"relative\">\n                            <Gift className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                            <Input\n                              placeholder=\"Friend's code for bonus\"\n                              className=\"pl-10\"\n                              data-testid=\"input-signup-referral-code\"\n                              {...field}\n                            />\n                          </div>\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <Button\n                    type=\"submit\"\n                    className=\"w-full\"\n                    disabled={signUpMutation.isPending}\n                    data-testid=\"button-signup-submit\"\n                  >\n                    {signUpMutation.isPending ? \"Creating account...\" : \"Create Account\"}\n                  </Button>\n                </form>\n              </Form>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":39194,"size_tokens":null},"client/src/pages/product-view.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useParams, useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { MessageSquare, MapPin, Heart, Star, Shield, ChevronLeft, ChevronRight, UserPlus, UserCheck, CheckCircle, Clock, ShoppingBag, ShoppingCart, Calendar, CircleDot, Share2, Loader2, Check, ImageOff, Plus, Minus } from \"lucide-react\";\nimport { useCart } from \"@/hooks/use-cart\";\nimport { SafetyShieldModal, hasSafetyBeenAcknowledged } from \"@/components/SafetyShieldModal\";\nimport type { Product, User, Watchlist, UserSettings } from \"@shared/schema\";\nimport { getDistanceDisplay } from \"@/lib/distance\";\n\ninterface SellerSettings {\n  latitude: string | null;\n  longitude: string | null;\n  locationVisible: boolean | null;\n}\n\ntype ProductWithSellerSettings = Product & { \n  seller: User; \n  sellerSettings?: SellerSettings | null;\n};\n\nfunction formatJoinDate(dateStr: string | Date | null | undefined): string {\n  if (!dateStr) return \"Recently\";\n  const date = new Date(dateStr);\n  const now = new Date();\n  const diffMs = now.getTime() - date.getTime();\n  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\n  \n  if (diffDays < 30) return \"This month\";\n  if (diffDays < 60) return \"1 month ago\";\n  if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;\n  \n  const years = Math.floor(diffDays / 365);\n  return years === 1 ? \"1 year ago\" : `${years} years ago`;\n}\n\nfunction formatOnlineStatus(dateStr: string | Date | null | undefined): { text: string; isActive: boolean } {\n  if (!dateStr) return { text: \"Offline\", isActive: false };\n  const date = new Date(dateStr);\n  const now = new Date();\n  const diffMs = now.getTime() - date.getTime();\n  const diffMins = Math.floor(diffMs / (1000 * 60));\n  \n  if (diffMins < 5) return { text: \"Active now\", isActive: true };\n  if (diffMins < 60) return { text: `Active ${diffMins}m ago`, isActive: true };\n  if (diffMins < 1440) return { text: `Last seen ${Math.floor(diffMins / 60)}h ago`, isActive: false };\n  if (diffMins < 10080) return { text: `Last seen ${Math.floor(diffMins / 1440)}d ago`, isActive: false };\n  return { text: \"Last seen a while ago\", isActive: false };\n}\n\nfunction formatResponseTime(minutes: number | null | undefined): string {\n  if (!minutes || minutes === 0) return \"Not available\";\n  if (minutes < 60) return `Usually responds in ${minutes}m`;\n  if (minutes < 1440) return `Usually responds in ${Math.floor(minutes / 60)}h`;\n  return `Usually responds in ${Math.floor(minutes / 1440)}d`;\n}\n\nexport default function ProductView() {\n  const { id } = useParams();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const { user, isAuthenticated } = useAuth();\n  const [currentImageIndex, setCurrentImageIndex] = useState(0);\n  const [showSafetyModal, setShowSafetyModal] = useState(false);\n  const [showCopied, setShowCopied] = useState(false);\n  const [quantity, setQuantity] = useState(1);\n  \n  const { addToCart, isAddingToCart, cartItems } = useCart();\n\n  const { data: product, isLoading } = useQuery<ProductWithSellerSettings>({\n    queryKey: [\"/api/products\", id],\n  });\n\n  const { data: wishlistItems = [] } = useQuery<Watchlist[]>({\n    queryKey: [\"/api/watchlist\"],\n    enabled: isAuthenticated,\n  });\n\n  const { data: userSettings } = useQuery<UserSettings>({\n    queryKey: [\"/api/settings\"],\n    enabled: isAuthenticated,\n  });\n\n  const distanceDisplay = isAuthenticated && \n    userSettings?.locationVisible && \n    product?.sellerSettings?.locationVisible\n      ? getDistanceDisplay(\n          userSettings.latitude,\n          userSettings.longitude,\n          product.sellerSettings.latitude,\n          product.sellerSettings.longitude\n        )\n      : null;\n\n  const isInWishlist = wishlistItems.some(item => item.productId === id);\n  const isInCart = cartItems.some(item => item.productId === id);\n  const cartItem = cartItems.find(item => item.productId === id);\n\n  // Reset safety modal state when product/seller changes\n  useEffect(() => {\n    setShowSafetyModal(false);\n    setCurrentImageIndex(0);\n  }, [id]);\n\n  // Fetch follow status for the seller\n  const { data: followStats } = useQuery<{\n    followerCount: number;\n    followingCount: number;\n    isFollowing: boolean;\n  }>({\n    queryKey: [\"/api/users\", product?.sellerId, \"follow-stats\"],\n    enabled: !!product?.sellerId,\n  });\n\n  const followMutation = useMutation({\n    mutationFn: async () => {\n      if (!isAuthenticated) {\n        window.location.href = \"/api/login\";\n        return;\n      }\n      return await apiRequest(\"POST\", `/api/users/${product?.sellerId}/follow`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", product?.sellerId, \"follow-stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", product?.sellerId, \"followers\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", user?.id, \"following\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\", id] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n      toast({\n        title: \"Followed\",\n        description: \"You are now following this seller\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to follow seller\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const unfollowMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"DELETE\", `/api/users/${product?.sellerId}/follow`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", product?.sellerId, \"follow-stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", product?.sellerId, \"followers\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", user?.id, \"following\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\", id] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n      toast({\n        title: \"Unfollowed\",\n        description: \"You have unfollowed this seller\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to unfollow seller\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const addToWishlistMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/watchlist\", { productId: id });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/watchlist\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wishlist/full\"] });\n      toast({\n        title: \"Added to Wishlist\",\n        description: \"Item has been added to your wishlist\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to add to wishlist\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const removeFromWishlistMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"DELETE\", `/api/watchlist/${id}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/watchlist\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wishlist/full\"] });\n      toast({\n        title: \"Removed from Wishlist\",\n        description: \"Item has been removed from your wishlist\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to remove from wishlist\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleWishlistToggle = () => {\n    if (!isAuthenticated) {\n      toast({\n        title: \"Login Required\",\n        description: \"Please log in to add items to your wishlist\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (isInWishlist) {\n      removeFromWishlistMutation.mutate();\n    } else {\n      addToWishlistMutation.mutate();\n    }\n  };\n\n  const handleShare = async () => {\n    const domain = window.location.origin;\n    const shareUrl = `${domain}/products/${id}`;\n    \n    try {\n      await navigator.clipboard.writeText(shareUrl);\n      setShowCopied(true);\n      toast({\n        title: \"Link Copied\",\n        description: \"Product link has been copied to your clipboard\",\n      });\n      setTimeout(() => setShowCopied(false), 2000);\n    } catch {\n      toast({\n        title: \"Error\",\n        description: \"Failed to copy link\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleAddToCart = async () => {\n    if (!isAuthenticated) {\n      toast({\n        title: \"Login Required\",\n        description: \"Please log in to add items to your cart\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    try {\n      await addToCart({ productId: id!, quantity });\n      toast({\n        title: \"Added to Cart\",\n        description: `${quantity} item${quantity > 1 ? 's' : ''} added to your cart`,\n      });\n      setQuantity(1);\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to add to cart\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const incrementQuantity = () => setQuantity(q => Math.min(q + 1, 10));\n  const decrementQuantity = () => setQuantity(q => Math.max(q - 1, 1));\n\n  const startChat = () => {\n    if (!isAuthenticated) {\n      window.location.href = \"/api/login\";\n      return;\n    }\n    \n    if (product?.sellerId && !hasSafetyBeenAcknowledged(product.sellerId)) {\n      setShowSafetyModal(true);\n      return;\n    }\n    \n    setLocation(`/messages?user=${product?.sellerId}`);\n  };\n\n  const handleSafetyAcknowledge = () => {\n    setLocation(`/messages?user=${product?.sellerId}`);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"grid gap-8 lg:grid-cols-2\">\n          <Skeleton className=\"aspect-square rounded-lg\" />\n          <div className=\"space-y-4\">\n            <Skeleton className=\"h-8 w-3/4\" />\n            <Skeleton className=\"h-12 w-1/3\" />\n            <Skeleton className=\"h-24\" />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!product) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 text-center\">\n        <p className=\"text-lg text-muted-foreground\">Product not found</p>\n      </div>\n    );\n  }\n\n  const price = parseFloat(product.price as string);\n  const originalPriceValue = product.originalPrice;\n  const originalPrice = originalPriceValue ? (typeof originalPriceValue === 'number' ? originalPriceValue : parseFloat(originalPriceValue as string) || 0) : null;\n  const isOnSale = product.isOnSale && originalPrice && originalPrice > price;\n  const discountPercent = isOnSale ? Math.round(((originalPrice - price) / originalPrice) * 100) : 0;\n  const images = product.images.length > 0 ? product.images : [\"/placeholder-product.png\"];\n  const sellerInitials = product.seller?.firstName?.[0] || product.seller?.email?.[0] || \"S\";\n\n  const nextImage = () => {\n    setCurrentImageIndex((prev) => (prev + 1) % images.length);\n  };\n\n  const prevImage = () => {\n    setCurrentImageIndex((prev) => (prev - 1 + images.length) % images.length);\n  };\n\n  const isOwner = user?.id === product.sellerId;\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"grid gap-8 lg:grid-cols-2\">\n          {/* Image Gallery */}\n          <div>\n            <div className=\"relative aspect-square md:aspect-auto md:min-h-[400px] max-h-[70vh] md:max-h-none overflow-hidden rounded-lg bg-muted\">\n              <img\n                src={images[currentImageIndex]}\n                alt={product.title}\n                className=\"h-full w-full object-contain md:object-cover\"\n                loading=\"lazy\"\n                data-testid=\"img-product-main\"\n              />\n              {images.length > 1 && (\n                <>\n                  <Button\n                    variant=\"secondary\"\n                    size=\"icon\"\n                    className=\"absolute left-2 top-1/2 -translate-y-1/2\"\n                    onClick={prevImage}\n                    data-testid=\"button-prev-image\"\n                  >\n                    <ChevronLeft className=\"h-4 w-4\" />\n                  </Button>\n                  <Button\n                    variant=\"secondary\"\n                    size=\"icon\"\n                    className=\"absolute right-2 top-1/2 -translate-y-1/2\"\n                    onClick={nextImage}\n                    data-testid=\"button-next-image\"\n                  >\n                    <ChevronRight className=\"h-4 w-4\" />\n                  </Button>\n                </>\n              )}\n            </div>\n            {images.length > 1 && (\n              <div className=\"mt-4 grid grid-cols-5 gap-2\">\n                {images.map((img, idx) => (\n                  <button\n                    key={idx}\n                    onClick={() => setCurrentImageIndex(idx)}\n                    className={`aspect-square overflow-hidden rounded-md ${\n                      idx === currentImageIndex ? \"ring-2 ring-primary\" : \"\"\n                    }`}\n                  >\n                    <img\n                      src={img}\n                      alt={`${product.title} ${idx + 1}`}\n                      className=\"h-full w-full object-cover\"\n                      loading=\"lazy\"\n                    />\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {/* Product Info */}\n          <div className=\"space-y-6\">\n            <div>\n              <div className=\"flex items-start justify-between mb-2 gap-2\">\n                <h1 className=\"text-3xl font-bold\" data-testid=\"text-product-title\">\n                  {product.title}\n                </h1>\n                <div className=\"flex gap-1 flex-shrink-0\">\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={handleShare}\n                    data-testid=\"button-share\"\n                  >\n                    {showCopied ? (\n                      <Check className=\"h-5 w-5 text-green-500\" />\n                    ) : (\n                      <Share2 className=\"h-5 w-5\" />\n                    )}\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={handleWishlistToggle}\n                    disabled={isOwner || addToWishlistMutation.isPending || removeFromWishlistMutation.isPending}\n                    data-testid=\"button-wishlist\"\n                  >\n                    {addToWishlistMutation.isPending || removeFromWishlistMutation.isPending ? (\n                      <Loader2 className=\"h-5 w-5 animate-spin\" />\n                    ) : (\n                      <Heart \n                        className={`h-5 w-5 transition-colors ${\n                          isInWishlist \n                            ? \"fill-red-500 text-red-500\" \n                            : \"\"\n                        }`} \n                      />\n                    )}\n                  </Button>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2 flex-wrap\">\n                <Badge variant=\"secondary\">{product.condition}</Badge>\n                {product.isBoosted && (\n                  <Badge className=\"bg-yellow-500\">Featured</Badge>\n                )}\n                {isOnSale && (\n                  <Badge className=\"bg-red-500 text-white\" data-testid=\"badge-sale\">\n                    SALE\n                  </Badge>\n                )}\n              </div>\n            </div>\n\n            <div className=\"flex flex-col gap-1\">\n              <div className=\"flex items-baseline gap-3\">\n                <p className={`text-4xl font-bold ${isOnSale ? \"text-red-500 dark:text-red-400\" : \"text-primary\"}`} data-testid=\"text-product-price\">\n                  ₦{price.toLocaleString()}\n                </p>\n                {isOnSale && originalPrice && (\n                  <p className=\"text-xl text-muted-foreground line-through\" data-testid=\"text-product-original-price\">\n                    ₦{originalPrice.toLocaleString()}\n                  </p>\n                )}\n              </div>\n              {isOnSale && discountPercent > 0 && (\n                <p className=\"text-sm font-semibold text-green-600 dark:text-green-500\" data-testid=\"text-discount-percent\">\n                  You save {discountPercent}% off the original price\n                </p>\n              )}\n            </div>\n\n            <div className=\"flex flex-wrap items-center gap-3 text-muted-foreground\">\n              {product.location && (\n                <div className=\"flex items-center gap-2\">\n                  <MapPin className=\"h-4 w-4\" />\n                  <span>{product.location}</span>\n                </div>\n              )}\n              {distanceDisplay && (\n                <Badge variant=\"secondary\" className=\"text-sm py-0.5 px-2\" data-testid=\"badge-seller-distance\">\n                  <MapPin className=\"h-3 w-3 mr-1\" />\n                  {distanceDisplay} away\n                </Badge>\n              )}\n            </div>\n\n            <div>\n              <h2 className=\"font-semibold mb-2\">Description</h2>\n              <p className=\"text-muted-foreground whitespace-pre-wrap\" data-testid=\"text-product-description\">\n                {product.description}\n              </p>\n            </div>\n\n            {/* Enhanced Seller Card */}\n            <Card className=\"border-2\">\n              <CardContent className=\"p-6\">\n                {/* Seller Header */}\n                <div className=\"flex items-start gap-4\">\n                  <button\n                    onClick={() => setLocation(`/profile/${product.sellerId}`)}\n                    className=\"relative group hover-elevate active-elevate-2 rounded-full transition-all\"\n                    data-testid=\"button-seller-avatar\"\n                  >\n                    <Avatar className=\"h-16 w-16 border-2 border-background\">\n                      <AvatarImage src={product.seller?.profileImageUrl || undefined} />\n                      <AvatarFallback className=\"text-lg\">{sellerInitials}</AvatarFallback>\n                    </Avatar>\n                    {(() => {\n                      const onlineStatus = formatOnlineStatus(product.seller?.updatedAt);\n                      return onlineStatus.isActive ? (\n                        <span \n                          className=\"absolute bottom-0 right-0 h-4 w-4 rounded-full bg-green-500 border-2 border-background\" \n                          title={onlineStatus.text}\n                          data-testid=\"indicator-seller-online\"\n                        />\n                      ) : null;\n                    })()}\n                  </button>\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <button \n                        onClick={() => setLocation(`/profile/${product.sellerId}`)}\n                        className=\"font-semibold text-lg truncate hover:underline\"\n                        data-testid=\"text-seller-name\"\n                      >\n                        {product.seller?.firstName \n                          ? `${product.seller.firstName}${product.seller.lastName ? ` ${product.seller.lastName}` : ''}`\n                          : \"Seller\"}\n                      </button>\n                      {product.seller?.isVerified && (\n                        <CheckCircle className=\"h-5 w-5 text-green-500 flex-shrink-0\" data-testid=\"icon-seller-verified\" />\n                      )}\n                      {product.seller?.isTrustedSeller && (\n                        <Badge className=\"bg-blue-500 dark:bg-blue-600 flex-shrink-0\">\n                          <Shield className=\"h-3 w-3 mr-1\" />\n                          Trusted\n                        </Badge>\n                      )}\n                    </div>\n                    {product.seller?.instagramHandle && (\n                      <p className=\"text-sm text-muted-foreground\" data-testid=\"text-seller-username\">\n                        @{product.seller.instagramHandle}\n                      </p>\n                    )}\n                    <div className=\"flex items-center gap-1 mt-1\">\n                      <div className=\"flex items-center\">\n                        {[1, 2, 3, 4, 5].map((star) => {\n                          const trustScore = parseFloat(String(product.seller?.trustScore || \"5.0\"));\n                          const filled = star <= Math.floor(trustScore);\n                          const halfFilled = !filled && star === Math.ceil(trustScore) && trustScore % 1 >= 0.5;\n                          return (\n                            <Star\n                              key={star}\n                              className={`h-4 w-4 ${\n                                filled \n                                  ? \"fill-yellow-400 text-yellow-400\" \n                                  : halfFilled \n                                    ? \"fill-yellow-400/50 text-yellow-400\" \n                                    : \"text-muted-foreground/30\"\n                              }`}\n                            />\n                          );\n                        })}\n                      </div>\n                      <span className=\"text-sm font-medium ml-1\" data-testid=\"text-seller-rating\">\n                        {product.seller?.trustScore || \"5.0\"}\n                      </span>\n                      <span className=\"text-sm text-muted-foreground\" data-testid=\"text-seller-reviews\">\n                        ({product.seller?.totalRatings || 0} reviews)\n                      </span>\n                    </div>\n                  </div>\n                  {!isOwner && isAuthenticated && (\n                    <Button\n                      variant={followStats?.isFollowing ? \"secondary\" : \"default\"}\n                      size=\"sm\"\n                      onClick={() => {\n                        if (followStats?.isFollowing) {\n                          unfollowMutation.mutate();\n                        } else {\n                          followMutation.mutate();\n                        }\n                      }}\n                      disabled={followMutation.isPending || unfollowMutation.isPending}\n                      data-testid=\"button-follow-seller\"\n                      className=\"gap-1 flex-shrink-0\"\n                    >\n                      {followStats?.isFollowing ? (\n                        <>\n                          <UserCheck className=\"h-4 w-4\" />\n                          Following\n                        </>\n                      ) : (\n                        <>\n                          <UserPlus className=\"h-4 w-4\" />\n                          Follow\n                        </>\n                      )}\n                    </Button>\n                  )}\n                </div>\n\n                <Separator className=\"my-4\" />\n\n                {/* Seller Stats Grid */}\n                <div className=\"grid grid-cols-2 gap-4\">\n                  {/* Online Status */}\n                  <div className=\"flex items-center gap-2\">\n                    <CircleDot className={`h-4 w-4 flex-shrink-0 ${\n                      formatOnlineStatus(product.seller?.updatedAt).isActive \n                        ? \"text-green-500\" \n                        : \"text-muted-foreground\"\n                    }`} />\n                    <span className=\"text-sm text-muted-foreground truncate\" data-testid=\"text-seller-online-status\">\n                      {formatOnlineStatus(product.seller?.updatedAt).text}\n                    </span>\n                  </div>\n\n                  {/* Join Date */}\n                  <div className=\"flex items-center gap-2\">\n                    <Calendar className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                    <span className=\"text-sm text-muted-foreground truncate\" data-testid=\"text-seller-joined\">\n                      Joined {formatJoinDate(product.seller?.createdAt)}\n                    </span>\n                  </div>\n\n                  {/* Total Sales */}\n                  <div className=\"flex items-center gap-2\">\n                    <ShoppingBag className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                    <span className=\"text-sm text-muted-foreground\" data-testid=\"text-seller-sales\">\n                      {product.seller?.totalSales || 0} sales\n                    </span>\n                  </div>\n\n                  {/* Response Time */}\n                  <div className=\"flex items-center gap-2\">\n                    <Clock className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                    <span className=\"text-sm text-muted-foreground truncate\" data-testid=\"text-seller-response-time\">\n                      {formatResponseTime(product.seller?.responseTime)}\n                    </span>\n                  </div>\n                </div>\n\n                {/* Followers count */}\n                <div className=\"mt-4 text-center\">\n                  <span className=\"text-sm text-muted-foreground\" data-testid=\"text-seller-follower-count\">\n                    <span className=\"font-semibold text-foreground\">{followStats?.followerCount || 0}</span> followers\n                  </span>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Action Buttons */}\n            <div className=\"sticky bottom-0 bg-background pt-4 border-t space-y-3\">\n              {isOwner ? (\n                <Button\n                  className=\"w-full\"\n                  onClick={() => setLocation(`/products/${id}/edit`)}\n                  data-testid=\"button-edit-product\"\n                >\n                  Edit Listing\n                </Button>\n              ) : (\n                <>\n                  {/* Quantity Selector and Add to Cart */}\n                  {product.isAvailable && !product.isSold && (\n                    <div className=\"flex gap-2\">\n                      <div className=\"flex items-center border rounded-md\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={decrementQuantity}\n                          disabled={quantity <= 1}\n                          data-testid=\"button-decrease-quantity\"\n                        >\n                          <Minus className=\"h-4 w-4\" />\n                        </Button>\n                        <span className=\"px-4 font-medium min-w-[40px] text-center\" data-testid=\"text-quantity\">\n                          {quantity}\n                        </span>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={incrementQuantity}\n                          disabled={quantity >= 10}\n                          data-testid=\"button-increase-quantity\"\n                        >\n                          <Plus className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                      <Button\n                        className=\"flex-1\"\n                        onClick={handleAddToCart}\n                        disabled={isAddingToCart}\n                        data-testid=\"button-add-to-cart\"\n                      >\n                        {isAddingToCart ? (\n                          <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                        ) : (\n                          <ShoppingCart className=\"mr-2 h-4 w-4\" />\n                        )}\n                        {isInCart ? \"Add More\" : \"Add to Cart\"}\n                      </Button>\n                    </div>\n                  )}\n                  \n                  {/* View Cart Button (if items in cart) */}\n                  {isInCart && (\n                    <Button\n                      variant=\"outline\"\n                      className=\"w-full\"\n                      onClick={() => setLocation(\"/checkout\")}\n                      data-testid=\"button-view-cart\"\n                    >\n                      <ShoppingBag className=\"mr-2 h-4 w-4\" />\n                      View Cart ({cartItem?.quantity} item{(cartItem?.quantity || 0) > 1 ? 's' : ''})\n                    </Button>\n                  )}\n                  \n                  {/* Chat with Seller */}\n                  <Button\n                    variant={product.isAvailable && !product.isSold ? \"outline\" : \"default\"}\n                    className=\"w-full\"\n                    onClick={startChat}\n                    data-testid=\"button-chat-seller\"\n                  >\n                    <MessageSquare className=\"mr-2 h-4 w-4\" />\n                    Chat with Seller\n                  </Button>\n                  \n                  {/* Product unavailable notice */}\n                  {(!product.isAvailable || product.isSold) && (\n                    <p className=\"text-sm text-muted-foreground text-center\">\n                      This item is no longer available for purchase\n                    </p>\n                  )}\n                </>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Safety Shield Modal */}\n      {product?.sellerId && (\n        <SafetyShieldModal\n          sellerId={product.sellerId}\n          open={showSafetyModal}\n          onOpenChange={setShowSafetyModal}\n          onAcknowledge={handleSafetyAcknowledge}\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":30147,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"admin.md":{"content":"# Admin Panel Documentation\n\nThis document provides comprehensive instructions for accessing and using the EKSU Campus Marketplace Admin Panel.\n\n## Table of Contents\n\n1. [Accessing the Admin Panel](#accessing-the-admin-panel)\n2. [Creating an Admin Account](#creating-an-admin-account)\n3. [Admin Panel Features Overview](#admin-panel-features-overview)\n4. [User Management](#user-management)\n5. [Product Management](#product-management)\n6. [Announcements Management](#announcements-management)\n7. [Database Metrics & Analytics](#database-metrics--analytics)\n8. [Disputes and Reports](#disputes-and-reports)\n9. [Support Access](#support-access)\n10. [API Reference](#api-reference)\n\n---\n\n## Accessing the Admin Panel\n\n### URL\nNavigate to `/admin` on your application domain:\n- Local development: `http://localhost:5000/admin`\n- Production: `https://your-domain.com/admin`\n\n### Authentication Requirements\nTo access the admin panel, you must be logged in as a user with admin privileges. The system checks for admin access in two ways:\n\n1. **Environment Variable (Recommended)**: Your user ID is listed in the `SUPER_ADMIN_IDS` environment variable\n2. **Database Role**: Your user account has `role: \"admin\"` in the database\n\nIf you don't have admin access, you'll be redirected to the home page with an \"Access Denied\" message.\n\n---\n\n## Creating an Admin Account\n\nThere are two methods to grant admin access:\n\n### Method 1: Environment Variable (Recommended for Super Admins)\n\nAdd user IDs to the `SUPER_ADMIN_IDS` environment variable. Multiple IDs can be comma-separated:\n\n```bash\nSUPER_ADMIN_IDS=user-uuid-1,user-uuid-2,user-uuid-3\n```\n\n**How to find a user's ID:**\n1. The user must first create a regular account via the registration form\n2. Query the database to find their ID:\n```sql\nSELECT id, email, first_name, last_name FROM users WHERE email = 'admin@example.com';\n```\n3. Copy the `id` value and add it to `SUPER_ADMIN_IDS`\n\n### Method 2: Database Role Update\n\nUpdate the user's role directly in the database:\n\n```sql\nUPDATE users \nSET role = 'admin', updated_at = NOW() \nWHERE email = 'admin@example.com';\n```\n\n**Note:** Users cannot set their own role to \"admin\" through the API - this is blocked for security.\n\n### Default Credentials\nThere are no default admin credentials. Admin accounts must be created explicitly using one of the methods above.\n\n---\n\n## Admin Panel Features Overview\n\nThe Admin Panel contains four main tabs:\n\n| Tab | Description |\n|-----|-------------|\n| **Users** | View and manage all registered users |\n| **Products** | Moderate product listings |\n| **Campus Updates** | Create and manage announcements |\n| **Database Metrics** | View database analytics and performance stats |\n\n### Dashboard Statistics\n\nAt the top of the admin panel, you'll see summary cards showing:\n- **Total Users**: Count of all registered users and verified users\n- **Total Products**: Count of active product listings\n- **Flagged Items**: Products that need review\n- **Revenue**: Monthly revenue (currently tracking only)\n\n---\n\n## User Management\n\n### Viewing Users\n\nThe Users tab displays a table with the following information:\n- User name and email\n- Role (buyer, seller, both, admin)\n- Verification status\n- Trust score and total ratings\n\n### Verify a User\n\nVerifying a user marks them as a trusted member of the marketplace.\n\n**Steps:**\n1. Go to the **Users** tab\n2. Find the user you want to verify\n3. Click the **Verify** button in the Actions column\n\n**What happens:**\n- User's `isVerified` flag is set to `true`\n- A green \"Verified\" badge appears on their profile\n- Users can see the verified badge next to their name\n\n### Ban a User\n\nBanning prevents a user from accessing the marketplace.\n\n**Steps:**\n1. Go to the **Users** tab\n2. Find the user you want to ban\n3. Click the **Ban** button (red, in Actions column)\n4. The user is immediately banned\n\n**What happens:**\n- User's `isBanned` flag is set to `true`\n- User's `isActive` flag is set to `false`\n- A ban reason is recorded (default: \"Violation of terms\")\n- The user cannot log in or use the marketplace\n\n**Note:** You cannot ban yourself (the Ban button is hidden for your own account).\n\n### Unban a User\n\nCurrently, unbanning must be done directly via the database:\n\n```sql\nUPDATE users \nSET is_banned = false, is_active = true, ban_reason = NULL, updated_at = NOW() \nWHERE id = 'user-uuid-here';\n```\n\n---\n\n## Product Management\n\n### Viewing Products\n\nThe Products tab displays all marketplace listings with:\n- Product image and title\n- Price\n- Status (Approved, Pending, or Flagged)\n- View count\n\n### Approve a Product\n\nProducts may require manual approval before becoming visible.\n\n**Steps:**\n1. Go to the **Products** tab\n2. Look for products with a \"Pending\" badge\n3. Click the **Approve** button\n\n**What happens:**\n- Product's `isApproved` flag is set to `true`\n- The product becomes visible in marketplace searches\n\n### Flag a Product\n\nFlagging marks a product for review due to policy violations.\n\n**Via API (no UI button currently):**\n```bash\nPUT /api/admin/products/:productId/flag\nContent-Type: application/json\n\n{\n  \"reason\": \"Prohibited item - weapons\"\n}\n```\n\n**What happens:**\n- Product's `isFlagged` flag is set to `true`\n- The flag reason is stored\n- Product may be hidden from searches\n\n### Remove a Product\n\nTo remove a product, use the database directly:\n\n```sql\nDELETE FROM products WHERE id = 'product-uuid-here';\n```\n\nOr mark it as unavailable:\n\n```sql\nUPDATE products \nSET is_available = false, is_sold = true, updated_at = NOW() \nWHERE id = 'product-uuid-here';\n```\n\n---\n\n## Announcements Management\n\nAnnouncements (Campus Updates) allow admins to communicate with all users.\n\n### Creating an Announcement\n\n1. Go to the **Campus Updates** tab\n2. Click **New Announcement**\n3. Fill in the form:\n   - **Title**: Headline for the announcement\n   - **Content**: Full message text\n   - **Category**: Update, New Feature, or Alert\n   - **Priority**: Low, Normal, or High\n   - **Pinned**: Toggle to pin to the top of the feed\n   - **Published**: Toggle to make visible to users\n4. Click **Create** or **Save**\n\n### Editing an Announcement\n\n1. Find the announcement in the list\n2. Click the **Edit** (pencil) icon\n3. Update the fields as needed\n4. Click **Save**\n\n### Deleting an Announcement\n\n1. Find the announcement in the list\n2. Click the **Delete** (trash) icon\n3. Confirm the deletion\n\n### Announcement Categories\n\n| Category | Icon | Use Case |\n|----------|------|----------|\n| Update | Megaphone | General updates and news |\n| Feature | Sparkles | New feature announcements |\n| Alert | Warning | Important alerts and warnings |\n\n### Priority Levels\n\n- **Low**: Normal styling\n- **Normal**: Default priority\n- **High**: Highlighted/emphasized\n\n---\n\n## Database Metrics & Analytics\n\nThe Database Metrics tab provides real-time insights into your application's database.\n\n### Summary Cards\n\n- **Total Database Size**: Combined size of all tables\n- **Active Connections**: Current database connections\n- **Query Stats**: Number of tracked query types\n\n### Table Storage Chart\n\nA bar chart showing the top 10 largest tables by size (in MB).\n\n### Connection States\n\nA pie chart breaking down database connections by state:\n- Active\n- Idle\n- Idle in transaction\n- Other states\n\n### Performance Statistics\n\n- **Deadlocks**: Number of deadlocks detected\n- **Temp Files**: Temporary files created\n- **Temp Data**: Size of temporary data used\n\n### Table Details\n\nA detailed table showing:\n- Table name\n- Row count (estimate)\n- Table size\n- Index size\n- Total size\n\n**Note:** Metrics refresh automatically every 30 seconds.\n\n---\n\n## Disputes and Reports\n\n### User Reports\n\nUsers can report other users or products for violations. Reports are stored with:\n- Reporter ID\n- Reported user/product ID\n- Reason\n- Description\n- Status (pending, reviewed, resolved)\n\n**Viewing Reports (Database):**\n```sql\nSELECT r.*, \n       reporter.email as reporter_email,\n       reported_user.email as reported_user_email,\n       p.title as product_title\nFROM reports r\nLEFT JOIN users reporter ON r.reporter_id = reporter.id\nLEFT JOIN users reported_user ON r.reported_user_id = reported_user.id\nLEFT JOIN products p ON r.reported_product_id = p.id\nWHERE r.status = 'pending'\nORDER BY r.created_at DESC;\n```\n\n**Updating Report Status:**\n```sql\nUPDATE reports \nSET status = 'resolved', updated_at = NOW() \nWHERE id = 'report-uuid-here';\n```\n\n### Transaction Disputes\n\nUsers can open disputes for problematic transactions. Disputes include:\n- Order/transaction reference\n- Buyer ID\n- Reason and description\n- Evidence (optional)\n- Status\n\n**Viewing Disputes (Database):**\n```sql\nSELECT * FROM disputes \nWHERE status = 'open' \nORDER BY created_at DESC;\n```\n\n---\n\n## Support Access\n\nIn addition to admin access, the system supports a separate **Support Representative** role.\n\n### Configuring Support Representatives\n\nAdd user IDs to the `SUPPORT_IDS` environment variable:\n\n```bash\nSUPPORT_IDS=support-user-id-1,support-user-id-2\n```\n\n### Support Permissions\n\n- Support reps have access to customer support features\n- They can view support tickets and respond to users\n- Super admins have full support access plus admin access\n\n---\n\n## API Reference\n\n### User Management APIs\n\n| Method | Endpoint | Description |\n|--------|----------|-------------|\n| GET | `/api/admin/users` | Get all users |\n| PUT | `/api/admin/users/:id/verify` | Verify a user |\n| PUT | `/api/admin/users/:id/ban` | Ban a user |\n\n### Product Management APIs\n\n| Method | Endpoint | Description |\n|--------|----------|-------------|\n| GET | `/api/admin/products` | Get all products |\n| PUT | `/api/admin/products/:id/approve` | Approve a product |\n\n### Announcement APIs\n\n| Method | Endpoint | Description |\n|--------|----------|-------------|\n| GET | `/api/admin/announcements` | Get all announcements (including unpublished) |\n| POST | `/api/announcements` | Create a new announcement |\n| PATCH | `/api/announcements/:id` | Update an announcement |\n| DELETE | `/api/announcements/:id` | Delete an announcement |\n\n### Database Metrics APIs\n\n| Method | Endpoint | Description |\n|--------|----------|-------------|\n| GET | `/api/admin/metrics/tables` | Get table storage metrics |\n| GET | `/api/admin/metrics/activity` | Get connection activity |\n| GET | `/api/admin/metrics/performance` | Get performance statistics |\n\n### Authentication\n\nAll admin API endpoints require:\n1. Valid user session (authenticated)\n2. Admin role (via `SUPER_ADMIN_IDS` env var or database role)\n\nUnauthorized requests return:\n```json\n{ \"message\": \"Unauthorized\" }  // 401 - Not logged in\n{ \"message\": \"Forbidden\" }     // 403 - Not an admin\n```\n\n---\n\n## Security Best Practices\n\n1. **Limit Admin Access**: Only grant admin access to trusted individuals\n2. **Use Environment Variables**: Prefer `SUPER_ADMIN_IDS` over database roles for easier management\n3. **Audit Actions**: Monitor admin actions through database logs\n4. **Regular Review**: Periodically review admin access and remove unnecessary privileges\n5. **Strong Passwords**: Ensure all admin accounts use strong, unique passwords\n\n---\n\n## Troubleshooting\n\n### \"Access Denied\" when accessing /admin\n\n**Cause:** Your user account doesn't have admin privileges.\n\n**Solution:**\n1. Check if your user ID is in `SUPER_ADMIN_IDS`\n2. Check if your database role is set to \"admin\"\n3. Ensure you're logged in\n\n### Admin actions not persisting\n\n**Cause:** Database connection issues or transaction failures.\n\n**Solution:**\n1. Check database connectivity\n2. Review server logs for errors\n3. Verify database permissions\n\n### Metrics not loading\n\n**Cause:** Database statistics functions may not be available.\n\n**Solution:**\n1. Ensure PostgreSQL has `pg_stat_statements` extension enabled\n2. Check database user has permission to access system catalogs\n","path":null,"size_bytes":11815,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"replit.md":{"content":"# EKSU Campus Marketplace\n\n## Overview\n\nThe EKSU Campus Marketplace is a secure and efficient platform designed for students of Ekiti State University (EKSU) to buy and sell items. It aims to be the leading campus marketplace, fostering a safe trading environment and generating revenue through features like featured listings, transaction fees, and premium subscriptions. Key capabilities include real-time communication, a robust trust system, role-based access, and advanced safety features.\n\n## User Preferences\n\nI prefer detailed explanations.\nI want iterative development.\nAsk before making major changes.\nDo not make changes to the folder `Z`.\nDo not make changes to the file `Y`.\n\n## System Architecture\n\nThe marketplace employs a modern full-stack architecture focusing on performance, security, and user experience.\n\n**UI/UX Decisions:**\n- **Design System:** Shadcn UI + Tailwind CSS for a responsive, mobile-first design.\n- **Theming:** Full dark mode support with persistent user preferences.\n- **Real-Time Features:** WhatsApp-inspired chat UI, real-time status updates.\n- **Safety Features:** Safety Shield Modal, enhanced seller cards with trust scores, and an auto-follow system for new users to receive safety tips from the \"Campus Hub\" system account.\n- **Navigation:** Enhanced bottom navigation and header with dedicated links for messages, VTU Data, and settings.\n- **Social Features:** X/Twitter-style \"The Plug\" feed with \"For You/Following\" tabs, bookmarking, and post engagement tracking; user profiles with cover photos, avatars, pinned posts, and content tabs.\n- **Interaction:** Haptic feedback on mobile, pull-to-refresh, and back-to-top functionality.\n\n**Technical Implementations:**\n- **Frontend:** React + TypeScript, Wouter for routing, TanStack Query for data fetching, and WebSockets for real-time communication. Lazy loading, image lazy loading, and skeleton loaders optimize performance.\n- **Backend:** Express.js, PostgreSQL with Drizzle ORM, Passport.js for authentication, and a WebSocket server.\n- **Authentication:** Email/password with role selection (buyer/seller), session management, and protected routes. Admin/Support roles managed via environment variables and database flags.\n- **Products:** Multi-image uploads, search/filter, seller dashboard, and admin moderation.\n- **Chat:** WebSocket-based messaging, message threads, online/offline status, image lightbox, voice input, and message deletion.\n- **User Management:** Editable profiles, verification badges, trust scores, sales history, user blocking/reporting, and a virtual wallet with escrow support.\n- **Admin Panel:** User/product moderation, platform analytics, revenue tracking, and comprehensive support ticket management.\n- **AI Chatbot:** Groq-powered with automatic payment scam detection, safety warnings, quick help buttons, Nigerian language support, and a smart handoff system to human support based on frustration detection and issue classification.\n- **Payment System:** Squad/Habari integration for Card, Bank Transfer, USSD with instant settlements, fee calculation, seller payouts, and bank verification.\n- **Order Management:** 11 delivery statuses with audit trails, role-based permissions, unique order numbers, and escrow integration.\n- **Security:** Role-based access control, user verification, reporting, admin moderation, session management, and HTTPS.\n- **Location Services:** Geolocation with IP fallback, campus detection, distance calculation, and location-aware feed algorithms.\n- **KYC Verification:** Multi-step wizard with ID and liveness detection for user verification.\n- **VTU Data Sales:** Integrated SMEDATA.NG API for data resale with phone number validation and wallet integration.\n- **PWA Support:** Service worker for offline caching, install prompt, and offline indicator.\n- **Support Ticket System:** Threaded conversations, atomic ticket numbering, status tracking, and admin management.\n- **Social Post Reporting:** Users can report posts, which are auto-hidden after a threshold.\n\n**System Design Choices:**\n- **Database Schema:** Structured for Users, Products, Categories, Messages, Reviews, Watchlist, Reports, Support Tickets, KYC, and Sponsored Ads.\n- **File Structure:** `client/` for frontend, `server/` for backend, `shared/` for common utilities.\n- **API Endpoints:** Organized by functionality (Auth, Products, Messages, Users, Admin, Categories, Watchlist, Reviews, Chatbot, Error Reporting, Support, VTU).\n\n## External Dependencies\n\n- **PostgreSQL:** Primary database.\n- **Groq API:** For AI Chatbot (`llama-3.3-70b-versatile`).\n- **Squad/Habari API:** Payment gateway with retry logic (3 attempts, exponential backoff) and user-friendly error messages.\n- **Passport.js:** Authentication middleware.\n- **Drizzle ORM:** Database interaction.\n- **Socket.io-like WebSocket:** Real-time communication.\n- **Multer:** Image uploads.\n- **SMEDATA.NG API:** For Virtual Top-Up (VTU) data sales (graceful fallback to database if API unavailable).\n- **Resend Email API:** Primary email service with Brevo, Gmail, Mailgun fallbacks.\n- **Render:** Recommended deployment platform.\n\n## Recently Completed Features (V2)\n\n### ✅ **Email Verification System**\n- 6-digit code generation with email delivery\n- One-click verification link support\n- Token-based verification with expiry\n- Professional email templates\n- Email verification endpoint: `/api/auth/verify-email`\n- Resend code endpoint: `/api/auth/resend-verification`\n\n### ✅ **Password Strength Validation**\n- Real-time strength indicator (Weak/Medium/Strong)\n- Minimum \"Medium\" strength enforcement\n- Requirements: 8+ chars, uppercase, lowercase, numbers, special chars\n- Visual feedback in signup form\n- Validation before account creation\n\n### ✅ **System Account (@EksuMarketplaceOfficial)**\n- Official account: `@EksuMarketplaceOfficial`\n- Email: `system@eksucampusmarketplace.com`\n- Auto-follows new users on signup\n- Sends welcome DM with campus trading tips\n- System account type flags for special handling\n\n### ✅ **Email Notifications**\n- **New Messages:** `sendMessageNotification()` triggers when user receives message\n- **Order Updates:** Emails sent to buyer/seller on order status changes (confirmation, shipped, delivered, completed)\n- Professional HTML email templates\n- Async sending to prevent request blocking\n\n### ✅ **Enhanced Error Handling**\n- User-facing messages hide developer details\n- Full error details logged to console\n- 500 errors automatically emailed to admin (system@eksucampusmarketplace.com)\n- Sanitized error responses prevent information leakage\n- Error tracking and reporting system\n\n### ✅ **Squad Payment Integration (Production-Ready)**\n- **Official Pricing Implementation:**\n  - Card/USSD: 1.2% capped at ₦1,500\n  - Bank Transfer: 0.25% capped at ₦1,000 (instant T+0 settlement)\n- **API Configuration:**\n  - Production URL: api-d.squadco.com\n  - Sandbox URL: sandbox-api-d.squadco.com\n  - Webhook verification: HMAC SHA-512 with x-squad-encrypted-body header\n- **Features:**\n  - Retry logic with exponential backoff (3 attempts)\n  - Error categorization: payment_error, network_error, validation_error\n  - User-friendly error messages\n  - Automatic transaction status updates\n  - Consistent fee calculations across frontend and backend\n- **Removed:** All Paystack, Flutterwave, Monnify references\n\n### ✅ **VTU Integration (Graceful Fallback)**\n- Primary: SMEDATA.NG API `/plans` endpoint\n- Fallback: Static database plans if API returns 404\n- Phone number validation\n- Wallet integration for data purchase\n- Error handling prevents app crash on API failure\n\n### ✅ **Security Enhancements**\n- Error sanitization prevents dev detail leakage\n- Admin email notifications for system errors\n- Session security with Passport.js\n- Protected routes with authentication middleware\n- Email notifications for sensitive operations\n- **SMEDATA.NG API:** For Virtual Top-Up (VTU) data sales.\n- **Render:** Recommended deployment platform.\n\n## Recent Changes (November 2024)\n\n### Theme System Enhancement\n- Added 8 themes: light, dim, lights-out, sunset, ocean, forest, sepia, high-contrast\n- Full CSS variable support for all themes with proper color schemes\n- Theme selector with visual color previews and proper icon contrast\n\n### User Profile Improvements\n- Added gender field to user schema with dropdown selection in settings\n- Values: Male, Female, Other, Prefer not to say\n\n### The Plug Social Feed\n- Redesigned post composer to full-screen Twitter/X-style interface\n- Added scroll lock handling for mobile composer\n- Follow button hides completely for already-followed users\n\n### Confessions Page\n- Added optimistic updates for voting (like/dislike)\n- Instant UI feedback before server response\n\n### Product View\n- Fixed product image sizing on mobile with max-height constraints (max-h-[60vh])\n\n## Recent Changes (November 28, 2024)\n\n### Mobile UX Enhancements\n- Fixed 100vh viewport bug with 100dvh, -webkit-fill-available fallbacks, and safe-area-inset padding\n- Added keyboard-aware-input class to prevent keyboard from covering inputs in chats/comments\n- Added pb-safe utility class for safe area bottom padding\n\n### Toast Notification System\n- Added 4 color variants: success (green), info (blue), warning (yellow), destructive (red)\n- Consistent styling with proper close button colors per variant\n- ToastViewport includes safe-area-inset-bottom padding\n\n### Verification Badge System\n- New VerificationBadge component at `client/src/components/VerificationBadge.tsx`\n- Badge types: verified (blue check), official (purple crown), seller (gold badge), admin (red shield)\n- Priority order: admin > official > seller > verified\n- Integrated in ProductCard with full seller flag support\n\n### Comment Bottom Sheet\n- Converted comment modal from Dialog to Sheet component in confessions.tsx\n- Slides up from bottom with mobile-friendly styling\n- Includes pb-safe and keyboard-aware-input classes\n\n### Profile Page Updates\n- Gender selector now integrated into Edit Profile form using FormField\n- Proper form validation and submission with other profile fields\n- Values: Male, Female, Other, Prefer not to say\n\n### Category Filter Enhancement\n- Added search Input in FilterPanel for quick category finding\n- Real-time filtering as user types\n- Categories displayed in scrollable list with buttons\n\n### Secret Messages Hub\n- New public route at `/secret` with dark purple gradient theme\n- Ghost icon branding with feature cards explaining anonymous messaging\n- Call-to-action buttons for signing in and getting started\n- Fully accessible without authentication\n\n### Study Materials (Past Questions) Feature\n- Complete schema with studyMaterials, studyMaterialPurchases, studyMaterialRatings tables\n- Material types: past_question, handout, summary, textbook, lab_report, project, lecture_note\n- Academic levels: 100L-500L, postgraduate\n- Wallet-based purchases with 90% seller / 10% platform revenue split\n- File upload to object storage with download tracking\n- Rating and review system\n\n### Hostel & Roommate Finder Feature\n- Hostel listings with multi-image support (up to 10 images)\n- Filter by location (EKSU areas), bedrooms (1-4+), price range\n- Amenities tracking: WiFi, electricity, water, security, parking, etc.\n- Agent contact integration with messaging\n- Distance from campus field\n- Database-level bedroom filtering with >= support for \"4+\" option\n\n### Game Library Feature (November 28, 2024)\n- **15+ multiplayer betting games** integrated into the platform\n- **Game Categories:**\n  - Traditional Nigerian: Ludo, Whot, Ayo Olopon\n  - Reaction Games: Quick Draw, Rock Paper Scissors\n  - Casino-style: Aviator, Colour Colour, Spin Wheel, Dice Duel\n  - Board Games: Draughts (10x10), Chess Blitz (3/5 min)\n  - Skill Games: Trivia Quiz, Typing Race, Price Guess, Memory Match, Number Puzzle\n- **Game Modes:**\n  - Practice: Free play, no stakes\n  - Challenge AI: Play against AI with wallet-based betting\n- **Key Features:**\n  - Wallet integration with 5% platform fee\n  - Secure random number generation (crypto.getRandomValues)\n  - Real-time WebSocket support for multiplayer\n  - Consistent UI with Shadcn components\n- **Game Components:** Located in `client/src/components/games/`\n  - DraughtsGame.tsx: 10x10 board, flying kings, mandatory capture, multi-jump\n  - ChessBlitzGame.tsx: Full chess rules, en passant, castling, timed games\n  - AviatorGame.tsx: Crash-style betting game with multiplier\n  - DiceDuelGame.tsx: Dice rolling with AI opponent\n  - Plus shared infrastructure for all game types\n- **Database Schema:** games, game_matches tables for tracking results\n\n## Known Configuration Issues\n\n### Email Service (Resend)\n- **Status:** API key configured but domain verification required\n- **Issue:** Resend requires DNS records (DKIM, SPF) to be added to your domain\n- **Solution:** \n  1. Log into Resend dashboard (resend.com)\n  2. Add your domain and get DNS records\n  3. Add the records to your domain's DNS settings\n  4. Verify domain in Resend dashboard\n- **Fallback:** Gmail SMTP is available as backup (GMAIL_USER, GMAIL_APP_PASSWORD configured)\n\n### Payment Gateway (Squad/Habari)\n- **Status:** API keys configured but may need verification\n- **Issue:** 403 errors may indicate credentials need revalidation\n- **Solution:**\n  1. Log into Squad dashboard (squadco.com)\n  2. Verify API credentials (Public Key, Secret Key)\n  3. Ensure account is in correct mode (test vs live)\n  4. Check webhook URL configuration points to your app URL\n- **Fallback:** Users can still use wallet balance for internal transactions\n\n### Database Games Tables\n- **Status:** Created via direct SQL (drizzle-kit push has interactive prompts)\n- **Tables Created:** games, game_matches, trivia_questions, typing_texts, price_guess_products\n- **Note:** Schema is synced with database, no migration issues\n","path":null,"size_bytes":13867,"size_tokens":null},"design_guidelines.md":{"content":"# Design Guidelines: EKSU Campus Marketplace Platform\n\n## Design Approach\n\n**Reference-Based Hybrid**: Drawing inspiration from Facebook Marketplace (trust & local focus), OLX Nigeria (mobile-first commerce), and WhatsApp (familiar chat patterns). This creates a platform students immediately understand while feeling purpose-built for campus commerce.\n\n## Core Design Principles\n\n1. **Trust-First Design**: Verification badges, user ratings, and security indicators are visually prominent throughout\n2. **Mobile Dominance**: Every interaction optimized for one-handed mobile use\n3. **Scan-First Hierarchy**: Information density managed for quick browsing of multiple listings\n4. **Cultural Familiarity**: Design patterns that feel natural to Nigerian students\n\n## Typography\n\n- **Primary Font**: Inter (Google Fonts) - clean, legible at small sizes\n- **Display Font**: Inter Bold for headings and price tags\n- **Hierarchy**:\n  - H1: 2xl (32px) - Page titles\n  - H2: xl (24px) - Section headers  \n  - H3: lg (20px) - Card titles, product names\n  - Body: base (16px) - Descriptions, chat messages\n  - Small: sm (14px) - Metadata, timestamps\n  - Price Tags: 2xl Bold - High visual weight\n\n## Layout System\n\n**Spacing Units**: Use Tailwind units of 2, 4, 6, 8, 12, 16 for consistent rhythm\n- Cards: p-4 for mobile, p-6 for desktop\n- Section spacing: py-8 on mobile, py-12 on desktop\n- Grid gaps: gap-4 for listings, gap-2 for form elements\n\n**Grid Structures**:\n- Product listings: 2 columns on mobile (grid-cols-2), 3-4 on tablet/desktop (md:grid-cols-3 lg:grid-cols-4)\n- Chat interface: Single column full-width\n- Dashboard cards: 1 column mobile, 2-3 on desktop\n\n## Component Library\n\n### Navigation\n- **Bottom Tab Bar** (mobile primary): Home, Sell, Messages, Profile - fixed position with active state indicators\n- **Top Header**: Logo, search bar, user avatar with notification badge\n- **Seller/Buyer Mode Toggle**: Prominent switch in profile section\n\n### Product Cards\n- Square aspect ratio product image (essential)\n- Price badge overlaid on image (semi-transparent background with blur)\n- Title (truncate to 2 lines)\n- Location pin icon + campus area\n- Verified seller badge (when applicable)\n- Quick action buttons on hover (desktop) or press (mobile)\n\n### Listings View\n- Masonry grid for featured/homepage\n- Standard grid for category pages\n- List view option showing more detail (title, price, description preview, seller rating)\n\n### Product Detail Page\n- Image carousel with dot indicators\n- Sticky bottom bar: Price + Chat/Buy Now buttons\n- Seller card: Avatar, name, verification badge, rating stars, response time\n- Full description with \"Read more\" expansion\n- Related items horizontal scroll\n- Report listing link (subtle, bottom of page)\n\n### Chat Interface\n- WhatsApp-inspired design (familiar to users)\n- Buyer messages: left-aligned, light treatment\n- Seller messages: right-aligned, accent treatment\n- Product context card at top (image, price, title)\n- Input bar: Text field, image upload, quick replies\n- Online/offline status indicators\n- Typing indicators\n\n### Forms & Inputs\n- Floating labels for text inputs\n- Clear validation states (success green, error red with message)\n- File upload: Drag-drop zone + mobile camera button\n- Category select: Visual icon grid (mobile-friendly)\n- Price input: Naira symbol prefix, number keyboard on mobile\n- Image upload: Multi-image preview with reorder capability\n\n### Trust & Verification Elements\n- Verification badges: Checkmark icon in circle (Student ID, NIN, Phone)\n- Rating stars: Filled gold stars + count \"(124 reviews)\"\n- Trust score: Numerical + progress bar visual\n- Escrow indicator: Shield icon + \"Payment Protected\" badge\n- Report button: Flag icon, red accent on hover\n\n### Admin Panel\n- Data-dense dashboard with metric cards\n- Tables with search, sort, filter capabilities\n- User management: Quick ban/verify actions\n- Moderation queue: Flagged listings with preview + action buttons\n- Charts: Simple bar/line graphs for analytics\n\n### Dark Mode\n- Toggle in user profile settings\n- Persistent preference saved to database\n- Smooth transition between modes\n- Dark mode optimized for AMOLED screens (true blacks)\n\n## Images\n\n### Product Images\n- Required: Minimum 1, maximum 10 per listing\n- Aspect ratio: 1:1 (square) for grid consistency\n- Compression: Optimize for mobile data (Nigerian internet conditions)\n- Placeholder: Gray background with camera icon when no image\n\n### Profile Images\n- Circular avatars throughout\n- Default: Initials on colored background when no photo uploaded\n- Verification overlay icon on verified users\n\n### Hero Section (Homepage)\n- Not applicable - marketplace apps prioritize immediate product browsing\n- Instead: Featured/promoted listings carousel at top (3-5 items, auto-scroll)\n\n### Promotional Banners\n- Full-width banners between listing rows (every 12-15 products)\n- Aspect ratio: 16:9 or 21:9\n- Used for: Campus events, partner promotions, platform features\n\n## Responsive Breakpoints\n\n- Mobile: Base (< 768px) - primary design target\n- Tablet: md (768px+) - 2-3 column layouts\n- Desktop: lg (1024px+) - 4 column grids, side navigation appears\n- Wide: xl (1280px+) - Max container width, more whitespace\n\n## Key Interaction Patterns\n\n- Pull-to-refresh on listing feeds\n- Infinite scroll for product grids\n- Swipe gestures: Delete chat (left swipe), archive listing (right swipe)\n- Haptic feedback on primary actions (mobile)\n- Toast notifications for confirmations\n- Modal overlays for quick actions (boost listing, report user)\n\n## Accessibility\n\n- Minimum touch target: 44x44px for all buttons\n- High contrast ratios in both light/dark modes\n- Clear focus indicators for keyboard navigation\n- Screen reader labels on all icons\n- Form error announcements\n\n## Performance Considerations\n\n- Lazy load images below fold\n- Paginated listings (load 20-30 at a time)\n- Optimistic UI updates for chat messages\n- Skeleton screens during data loading\n- Cached images for offline viewing","path":null,"size_bytes":6004,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/pages/notifications.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Link, useLocation } from \"wouter\";\nimport {\n  Bell,\n  MessageSquare,\n  ShoppingCart,\n  Star,\n  UserPlus,\n  Package,\n  AlertCircle,\n  CheckCircle,\n  XCircle,\n  Wallet,\n  TrendingUp,\n  ArrowLeft,\n  Check,\n  Trash2,\n} from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport type { Notification } from \"@shared/schema\";\n\nexport default function NotificationsPage() {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [activeTab, setActiveTab] = useState(\"all\");\n\n  const { data: notifications, isLoading } = useQuery<Notification[]>({\n    queryKey: [\"/api/notifications\"],\n  });\n\n  const markReadMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"PUT\", `/api/notifications/${id}/read`);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n    },\n  });\n\n  const markAllReadMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"PUT\", \"/api/notifications/read-all\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n      toast({\n        title: \"All notifications marked as read\",\n      });\n    },\n  });\n\n  const deleteNotificationMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"DELETE\", `/api/notifications/${id}`);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n      toast({\n        title: \"Notification deleted\",\n      });\n    },\n  });\n\n  const getNotificationIcon = (type: string) => {\n    switch (type) {\n      case \"message\":\n        return <MessageSquare className=\"h-5 w-5 text-blue-500\" />;\n      case \"sale\":\n      case \"purchase\":\n        return <ShoppingCart className=\"h-5 w-5 text-green-500\" />;\n      case \"review\":\n        return <Star className=\"h-5 w-5 text-yellow-500\" />;\n      case \"follow\":\n        return <UserPlus className=\"h-5 w-5 text-purple-500\" />;\n      case \"product_update\":\n        return <Package className=\"h-5 w-5 text-orange-500\" />;\n      case \"announcement\":\n        return <Bell className=\"h-5 w-5 text-primary\" />;\n      case \"dispute\":\n        return <AlertCircle className=\"h-5 w-5 text-red-500\" />;\n      case \"verification_approved\":\n        return <CheckCircle className=\"h-5 w-5 text-green-500\" />;\n      case \"verification_rejected\":\n        return <XCircle className=\"h-5 w-5 text-red-500\" />;\n      case \"escrow_released\":\n      case \"wallet_credit\":\n        return <Wallet className=\"h-5 w-5 text-green-500\" />;\n      case \"boost_expired\":\n        return <TrendingUp className=\"h-5 w-5 text-orange-500\" />;\n      case \"price_alert\":\n        return <AlertCircle className=\"h-5 w-5 text-blue-500\" />;\n      default:\n        return <Bell className=\"h-5 w-5 text-muted-foreground\" />;\n    }\n  };\n\n  const handleNotificationClick = (notification: Notification) => {\n    if (!notification.isRead) {\n      markReadMutation.mutate(notification.id);\n    }\n    if (notification.link) {\n      setLocation(notification.link);\n    }\n  };\n\n  const unreadCount = notifications?.filter(n => !n.isRead).length || 0;\n  const readCount = notifications?.filter(n => n.isRead).length || 0;\n\n  const filteredNotifications = notifications?.filter(n => {\n    if (activeTab === \"unread\") return !n.isRead;\n    if (activeTab === \"read\") return n.isRead;\n    return true;\n  }) || [];\n\n  const renderNotificationList = (notificationList: Notification[]) => {\n    if (notificationList.length === 0) {\n      const emptyMessage = activeTab === \"unread\" \n        ? \"No unread notifications\"\n        : activeTab === \"read\"\n        ? \"No read notifications\"\n        : \"No notifications yet\";\n      \n      const emptyDescription = activeTab === \"unread\"\n        ? \"You're all caught up!\"\n        : activeTab === \"read\"\n        ? \"Read notifications will appear here.\"\n        : \"You'll see updates about your orders, messages, and more here.\";\n\n      return (\n        <Card data-testid=\"empty-notifications\">\n          <CardContent className=\"py-12 text-center\">\n            <Bell className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n            <h3 className=\"text-lg font-medium mb-2\" data-testid=\"text-empty-title\">{emptyMessage}</h3>\n            <p className=\"text-muted-foreground\" data-testid=\"text-empty-description\">\n              {emptyDescription}\n            </p>\n          </CardContent>\n        </Card>\n      );\n    }\n\n    return (\n      <div className=\"space-y-4\">\n        {notificationList.map((notification) => (\n          <Card\n            key={notification.id}\n            className={`relative cursor-pointer transition-colors hover-elevate ${!notification.isRead ? \"bg-primary/5 border-primary/20\" : \"\"}`}\n            data-testid={`notification-card-${notification.id}`}\n            onClick={() => handleNotificationClick(notification)}\n          >\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-start gap-4\">\n                <div className=\"rounded-full bg-muted p-2 flex-shrink-0\" data-testid={`notification-icon-${notification.id}`}>\n                  {getNotificationIcon(notification.type)}\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-start justify-between gap-2\">\n                    <div>\n                      <p \n                        className={`font-medium ${!notification.isRead ? \"text-foreground\" : \"text-muted-foreground\"}`}\n                        data-testid={`notification-title-${notification.id}`}\n                      >\n                        {notification.title}\n                      </p>\n                      <p \n                        className=\"text-sm text-muted-foreground mt-1\"\n                        data-testid={`notification-message-${notification.id}`}\n                      >\n                        {notification.message}\n                      </p>\n                      <p \n                        className=\"text-xs text-muted-foreground mt-2\"\n                        data-testid={`notification-time-${notification.id}`}\n                      >\n                        {formatDistanceToNow(new Date(notification.createdAt!), { addSuffix: true })}\n                      </p>\n                    </div>\n                    {!notification.isRead && (\n                      <Badge variant=\"default\" className=\"flex-shrink-0\" data-testid={`notification-unread-badge-${notification.id}`}>\n                        New\n                      </Badge>\n                    )}\n                  </div>\n                  <div className=\"flex items-center gap-2 mt-3 flex-wrap\" onClick={(e) => e.stopPropagation()}>\n                    {notification.link && (\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        asChild\n                        onClick={() => {\n                          if (!notification.isRead) {\n                            markReadMutation.mutate(notification.id);\n                          }\n                        }}\n                        data-testid={`button-view-${notification.id}`}\n                      >\n                        <Link href={notification.link}>View</Link>\n                      </Button>\n                    )}\n                    {!notification.isRead && (\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => markReadMutation.mutate(notification.id)}\n                        disabled={markReadMutation.isPending}\n                        data-testid={`button-mark-read-${notification.id}`}\n                      >\n                        <Check className=\"h-4 w-4 mr-1\" />\n                        Mark Read\n                      </Button>\n                    )}\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => deleteNotificationMutation.mutate(notification.id)}\n                      disabled={deleteNotificationMutation.isPending}\n                      className=\"text-destructive\"\n                      data-testid={`button-delete-${notification.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n    );\n  };\n\n  const renderLoadingSkeleton = () => (\n    <div className=\"space-y-4\">\n      {[...Array(5)].map((_, i) => (\n        <Card key={i} data-testid={`skeleton-notification-${i}`}>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-start gap-4\">\n              <Skeleton className=\"h-9 w-9 rounded-full flex-shrink-0\" />\n              <div className=\"flex-1\">\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex-1\">\n                    <Skeleton className=\"h-5 w-3/4 mb-2\" />\n                    <Skeleton className=\"h-4 w-full mb-2\" />\n                    <Skeleton className=\"h-3 w-24\" />\n                  </div>\n                  <Skeleton className=\"h-5 w-12\" />\n                </div>\n                <div className=\"flex items-center gap-2 mt-3\">\n                  <Skeleton className=\"h-8 w-16\" />\n                  <Skeleton className=\"h-8 w-24\" />\n                  <Skeleton className=\"h-8 w-8\" />\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      ))}\n    </div>\n  );\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 max-w-2xl\">\n      <div className=\"flex items-center justify-between gap-4 mb-6 flex-wrap\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"ghost\" size=\"icon\" asChild data-testid=\"button-back\">\n            <Link href=\"/\">\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Link>\n          </Button>\n          <div>\n            <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">Notifications</h1>\n            {!isLoading && notifications && notifications.length > 0 && (\n              <p className=\"text-sm text-muted-foreground\" data-testid=\"text-unread-count\">\n                {unreadCount > 0 ? `${unreadCount} unread` : \"All caught up\"}\n              </p>\n            )}\n          </div>\n        </div>\n        {!isLoading && unreadCount > 0 && (\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => markAllReadMutation.mutate()}\n            disabled={markAllReadMutation.isPending}\n            data-testid=\"button-mark-all-read\"\n          >\n            <Check className=\"h-4 w-4 mr-2\" />\n            Mark All Read\n          </Button>\n        )}\n      </div>\n\n      {isLoading ? (\n        <>\n          <div className=\"mb-6\">\n            <Skeleton className=\"h-10 w-full max-w-md\" />\n          </div>\n          {renderLoadingSkeleton()}\n        </>\n      ) : (\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n          <TabsList className=\"grid w-full max-w-md grid-cols-3 mb-6\" data-testid=\"tabs-filter\">\n            <TabsTrigger value=\"all\" data-testid=\"tab-all\">\n              All\n              {notifications && notifications.length > 0 && (\n                <Badge variant=\"secondary\" className=\"ml-2 no-default-hover-elevate no-default-active-elevate\">\n                  {notifications.length}\n                </Badge>\n              )}\n            </TabsTrigger>\n            <TabsTrigger value=\"unread\" data-testid=\"tab-unread\">\n              Unread\n              {unreadCount > 0 && (\n                <Badge variant=\"default\" className=\"ml-2 no-default-hover-elevate no-default-active-elevate\">\n                  {unreadCount}\n                </Badge>\n              )}\n            </TabsTrigger>\n            <TabsTrigger value=\"read\" data-testid=\"tab-read\">\n              Read\n              {readCount > 0 && (\n                <Badge variant=\"secondary\" className=\"ml-2 no-default-hover-elevate no-default-active-elevate\">\n                  {readCount}\n                </Badge>\n              )}\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"all\" data-testid=\"content-all\">\n            {renderNotificationList(filteredNotifications)}\n          </TabsContent>\n\n          <TabsContent value=\"unread\" data-testid=\"content-unread\">\n            {renderNotificationList(filteredNotifications)}\n          </TabsContent>\n\n          <TabsContent value=\"read\" data-testid=\"content-read\">\n            {renderNotificationList(filteredNotifications)}\n          </TabsContent>\n        </Tabs>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":13410,"size_tokens":null},"client/src/components/ThemeToggle.tsx":{"content":"import { useMemo, useCallback } from \"react\";\nimport { Moon, Sun, Monitor, Sunset, Waves, TreePine, Book, Eye, Check, Palette } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator,\n  DropdownMenuLabel,\n} from \"@/components/ui/dropdown-menu\";\nimport { useTheme, type Theme } from \"@/contexts/ThemeContext\";\n\ninterface ThemeOption {\n  value: Theme;\n  label: string;\n  icon: typeof Sun;\n  description: string;\n  bgClass: string;\n  iconClass: string;\n}\n\nconst themeOptions: ThemeOption[] = [\n  { value: \"light\", label: \"Light\", icon: Sun, description: \"Clean white background\", bgClass: \"bg-amber-400\", iconClass: \"text-amber-900\" },\n  { value: \"dim\", label: \"Dim\", icon: Moon, description: \"Dark blue background\", bgClass: \"bg-blue-600\", iconClass: \"text-white\" },\n  { value: \"lights-out\", label: \"Lights Out\", icon: Monitor, description: \"Pure black (AMOLED)\", bgClass: \"bg-zinc-900\", iconClass: \"text-white\" },\n  { value: \"sunset\", label: \"Sunset\", icon: Sunset, description: \"Warm orange & purple\", bgClass: \"bg-orange-500\", iconClass: \"text-white\" },\n  { value: \"ocean\", label: \"Ocean\", icon: Waves, description: \"Deep blue & teal\", bgClass: \"bg-blue-600\", iconClass: \"text-white\" },\n  { value: \"forest\", label: \"Forest\", icon: TreePine, description: \"Dark green theme\", bgClass: \"bg-green-700\", iconClass: \"text-white\" },\n  { value: \"sepia\", label: \"Sepia\", icon: Book, description: \"Warm reading mode\", bgClass: \"bg-amber-200\", iconClass: \"text-amber-900\" },\n  { value: \"high-contrast\", label: \"High Contrast\", icon: Eye, description: \"Maximum readability\", bgClass: \"bg-yellow-400\", iconClass: \"text-black\" },\n];\n\nexport function ThemeToggle() {\n  const { theme, setTheme } = useTheme();\n\n  const currentTheme = useMemo(() => \n    themeOptions.find((t) => t.value === theme) || themeOptions[0],\n    [theme]\n  );\n  \n  const CurrentIcon = currentTheme.icon;\n\n  const handleThemeChange = useCallback((newTheme: Theme) => {\n    setTheme(newTheme);\n  }, [setTheme]);\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          data-testid=\"button-theme-toggle\"\n        >\n          <CurrentIcon className=\"h-5 w-5\" />\n          <span className=\"sr-only\">Toggle theme</span>\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\" className=\"w-56\">\n        <DropdownMenuLabel className=\"flex items-center gap-2\">\n          <Palette className=\"h-4 w-4\" />\n          Choose Theme\n        </DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        {themeOptions.map((option) => {\n          const Icon = option.icon;\n          const isSelected = theme === option.value;\n          return (\n            <DropdownMenuItem\n              key={option.value}\n              onClick={(e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                handleThemeChange(option.value);\n              }}\n              className={`flex items-center gap-3 cursor-pointer ${isSelected ? \"bg-accent\" : \"\"}`}\n              data-testid={`theme-option-${option.value}`}\n            >\n              <div className={`h-6 w-6 rounded-full flex items-center justify-center ${option.bgClass} border border-border`}>\n                <Icon className={`h-3 w-3 ${option.iconClass}`} />\n              </div>\n              <div className=\"flex flex-col flex-1\">\n                <span className=\"font-medium text-sm\">{option.label}</span>\n                <span className=\"text-xs text-muted-foreground\">{option.description}</span>\n              </div>\n              {isSelected && (\n                <Check className=\"h-4 w-4 text-primary\" />\n              )}\n            </DropdownMenuItem>\n          );\n        })}\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n\nexport function ThemeSelector({ className = \"\" }: { className?: string }) {\n  const { theme, setTheme } = useTheme();\n\n  const handleThemeChange = useCallback((newTheme: Theme) => {\n    setTheme(newTheme);\n  }, [setTheme]);\n\n  return (\n    <div className={`grid grid-cols-2 gap-2 ${className}`}>\n      {themeOptions.map((option) => {\n        const Icon = option.icon;\n        const isSelected = theme === option.value;\n        return (\n          <Button\n            key={option.value}\n            variant={isSelected ? \"default\" : \"outline\"}\n            className={`flex items-center justify-start gap-2 h-auto py-2 px-3 ${isSelected ? \"\" : \"hover-elevate\"}`}\n            onClick={() => handleThemeChange(option.value)}\n            data-testid={`theme-selector-${option.value}`}\n          >\n            <div className={`h-5 w-5 rounded-full flex items-center justify-center ${option.bgClass} border border-border/50`}>\n              <Icon className={`h-2.5 w-2.5 ${option.iconClass}`} />\n            </div>\n            <span className=\"text-sm\">{option.label}</span>\n          </Button>\n        );\n      })}\n    </div>\n  );\n}\n","path":null,"size_bytes":5041,"size_tokens":null},"client/src/components/ErrorBoundary.tsx":{"content":"import { Component, ErrorInfo, ReactNode } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { AlertTriangle, RefreshCw, Copy } from \"lucide-react\";\n\ninterface Props {\n  children: ReactNode;\n  fallback?: ReactNode;\n  onError?: (error: Error, errorInfo: ErrorInfo) => void;\n}\n\ninterface State {\n  hasError: boolean;\n  error: Error | null;\n  errorInfo: string;\n}\n\nexport class ErrorBoundary extends Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n    this.state = { hasError: false, error: null, errorInfo: \"\" };\n  }\n\n  static getDerivedStateFromError(error: Error): State {\n    return { hasError: true, error, errorInfo: error.message };\n  }\n\n  componentDidCatch(error: Error, errorInfo: ErrorInfo) {\n    console.error(\"ErrorBoundary caught an error:\", error, errorInfo);\n    \n    const errorDetails = `${error.message}\\n\\nComponent Stack:${errorInfo.componentStack}`;\n    \n    this.setState({\n      error,\n      errorInfo: errorDetails,\n    });\n\n    // Call custom error handler if provided\n    if (this.props.onError) {\n      this.props.onError(error, errorInfo);\n    }\n\n    // Send error to backend for logging and email notification\n    this.reportError(error, errorInfo);\n  }\n\n  reportError = async (error: Error, errorInfo: ErrorInfo) => {\n    try {\n      await fetch(\"/api/errors/report\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          message: error.message,\n          stack: error.stack,\n          componentStack: errorInfo.componentStack,\n          url: window.location.href,\n          userAgent: navigator.userAgent,\n          timestamp: new Date().toISOString(),\n        }),\n      });\n    } catch (err) {\n      console.error(\"Failed to report error:\", err);\n    }\n  };\n\n  handleReload = () => {\n    window.location.reload();\n  };\n\n  handleGoHome = () => {\n    window.location.href = \"/\";\n  };\n\n  handleReset = () => {\n    this.setState({ hasError: false, error: null, errorInfo: \"\" });\n  };\n\n  copyToClipboard = () => {\n    if (this.state.errorInfo) {\n      navigator.clipboard.writeText(this.state.errorInfo);\n    }\n  };\n\n  render() {\n    if (this.state.hasError) {\n      if (this.props.fallback) {\n        return this.props.fallback;\n      }\n\n      return (\n        <div className=\"min-h-screen flex items-center justify-center p-4 bg-background\">\n          <Card className=\"max-w-2xl w-full\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2 text-destructive\">\n                <AlertTriangle className=\"h-6 w-6\" />\n                Something went wrong\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <p className=\"text-muted-foreground\">\n                The application encountered an error. The error has been logged and reported.\n              </p>\n              \n              <details className=\"text-sm\">\n                <summary className=\"cursor-pointer text-muted-foreground hover:text-foreground font-semibold\">\n                  Technical Details\n                </summary>\n                <div className=\"mt-2 space-y-2\">\n                  <div className=\"flex justify-end\">\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      onClick={this.copyToClipboard}\n                      data-testid=\"button-copy-error\"\n                    >\n                      <Copy className=\"h-3 w-3 mr-2\" />\n                      Copy\n                    </Button>\n                  </div>\n                  <pre className=\"p-3 bg-muted rounded-md overflow-auto text-xs max-h-64\">\n                    {this.state.errorInfo}\n                  </pre>\n                </div>\n              </details>\n\n              <div className=\"flex flex-wrap gap-2\">\n                <Button onClick={this.handleReset} variant=\"outline\" data-testid=\"button-try-again\">\n                  Try Again\n                </Button>\n                <Button onClick={this.handleReload} variant=\"default\" data-testid=\"button-reload-page\">\n                  <RefreshCw className=\"h-4 w-4 mr-2\" />\n                  Reload Page\n                </Button>\n                <Button onClick={this.handleGoHome} variant=\"secondary\" data-testid=\"button-go-home\">\n                  Go Home\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      );\n    }\n\n    return this.props.children;\n  }\n}\n","path":null,"size_bytes":4599,"size_tokens":null},"client/src/pages/wallet.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Plus, ArrowUpRight, ArrowDownLeft, Clock, CheckCircle, XCircle, Wallet as WalletIcon, Loader2, AlertCircle } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { Wallet, Transaction } from \"@shared/schema\";\n\ninterface Bank {\n  name: string;\n  code: string;\n}\n\ninterface VerifiedAccount {\n  accountNumber: string;\n  accountName: string;\n  bankCode: string;\n}\n\nexport default function WalletPage() {\n  const { toast } = useToast();\n  const [depositAmount, setDepositAmount] = useState(\"\");\n  const [withdrawAmount, setWithdrawAmount] = useState(\"\");\n  const [selectedBankCode, setSelectedBankCode] = useState(\"\");\n  const [accountNumber, setAccountNumber] = useState(\"\");\n  const [verifiedAccount, setVerifiedAccount] = useState<VerifiedAccount | null>(null);\n  const [accountConfirmed, setAccountConfirmed] = useState(false);\n  const [verificationError, setVerificationError] = useState<string | null>(null);\n\n  const { data: wallet, isLoading: walletLoading } = useQuery<Wallet>({\n    queryKey: [\"/api/wallet\"],\n  });\n\n  const { data: transactions, isLoading: transactionsLoading } = useQuery<Transaction[]>({\n    queryKey: [\"/api/wallet/transactions\"],\n  });\n\n  const { data: banks, isLoading: banksLoading } = useQuery<Bank[]>({\n    queryKey: [\"/api/squad/banks\"],\n  });\n\n  const verifyAccountMutation = useMutation({\n    mutationFn: async ({ accountNumber, bankCode }: { accountNumber: string; bankCode: string }) => {\n      const response = await fetch(`/api/squad/verify-account?accountNumber=${accountNumber}&bankCode=${bankCode}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to verify account\");\n      }\n      return response.json() as Promise<VerifiedAccount>;\n    },\n    onSuccess: (data) => {\n      setVerifiedAccount(data);\n      setVerificationError(null);\n      setAccountConfirmed(false);\n    },\n    onError: (error: Error) => {\n      setVerifiedAccount(null);\n      setVerificationError(error.message);\n      setAccountConfirmed(false);\n    },\n  });\n\n  useEffect(() => {\n    if (accountNumber.length === 10 && selectedBankCode) {\n      setVerifiedAccount(null);\n      setAccountConfirmed(false);\n      setVerificationError(null);\n      verifyAccountMutation.mutate({ accountNumber, bankCode: selectedBankCode });\n    } else {\n      setVerifiedAccount(null);\n      setAccountConfirmed(false);\n      setVerificationError(null);\n    }\n  }, [accountNumber, selectedBankCode]);\n\n  const selectedBank = banks?.find(b => b.code === selectedBankCode);\n\n  const depositMutation = useMutation({\n    mutationFn: async (amount: string) => {\n      const response = await apiRequest(\"POST\", \"/api/squad/initialize\", { \n        amount,\n        purpose: \"wallet_deposit\",\n        paymentDescription: `Wallet deposit of ₦${parseFloat(amount).toLocaleString()}`,\n      });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      if (data.checkoutUrl) {\n        window.location.href = data.checkoutUrl;\n      } else {\n        toast({\n          title: \"Deposit initiated\",\n          description: \"Redirecting to payment gateway...\",\n        });\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Deposit failed\",\n        description: error.message || \"Unable to process deposit\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const withdrawMutation = useMutation({\n    mutationFn: async (data: { amount: string; bankName: string; accountNumber: string; accountName: string; bankCode: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/squad/withdraw\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Withdrawal requested\",\n        description: \"Your withdrawal is being processed.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wallet/transactions\"] });\n      setWithdrawAmount(\"\");\n      setSelectedBankCode(\"\");\n      setAccountNumber(\"\");\n      setVerifiedAccount(null);\n      setAccountConfirmed(false);\n      setVerificationError(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Withdrawal failed\",\n        description: error.message || \"Unable to process withdrawal\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleDeposit = () => {\n    const amount = parseFloat(depositAmount);\n    if (isNaN(amount) || amount < 100) {\n      toast({\n        title: \"Invalid amount\",\n        description: \"Minimum deposit is 100 NGN\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    depositMutation.mutate(depositAmount);\n  };\n\n  const handleWithdraw = () => {\n    const amount = parseFloat(withdrawAmount);\n    if (isNaN(amount) || amount < 500) {\n      toast({\n        title: \"Invalid amount\",\n        description: \"Minimum withdrawal is 500 NGN\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    if (!selectedBankCode || !selectedBank) {\n      toast({\n        title: \"Missing information\",\n        description: \"Please select a bank\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    if (!verifiedAccount) {\n      toast({\n        title: \"Account not verified\",\n        description: \"Please wait for account verification to complete\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    if (!accountConfirmed) {\n      toast({\n        title: \"Account not confirmed\",\n        description: \"Please confirm the account name before proceeding\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    withdrawMutation.mutate({ \n      amount: withdrawAmount, \n      bankName: selectedBank.name, \n      accountNumber: verifiedAccount.accountNumber, \n      accountName: verifiedAccount.accountName,\n      bankCode: selectedBankCode,\n    });\n  };\n\n  const getTransactionIcon = (type: string) => {\n    switch (type) {\n      case \"deposit\":\n      case \"welcome_bonus\":\n      case \"referral_bonus\":\n      case \"sale\":\n      case \"escrow_release\":\n        return <ArrowDownLeft className=\"h-4 w-4 text-green-500\" />;\n      case \"withdrawal\":\n      case \"purchase\":\n      case \"boost_payment\":\n      case \"escrow_hold\":\n        return <ArrowUpRight className=\"h-4 w-4 text-red-500\" />;\n      default:\n        return <Clock className=\"h-4 w-4 text-muted-foreground\" />;\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"completed\":\n        return <Badge variant=\"default\" className=\"bg-green-500\"><CheckCircle className=\"h-3 w-3 mr-1\" />Completed</Badge>;\n      case \"pending\":\n        return <Badge variant=\"secondary\"><Clock className=\"h-3 w-3 mr-1\" />Pending</Badge>;\n      case \"failed\":\n        return <Badge variant=\"destructive\"><XCircle className=\"h-3 w-3 mr-1\" />Failed</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  const formatAmount = (amount: string, type: string) => {\n    const isCredit = [\"deposit\", \"welcome_bonus\", \"referral_bonus\", \"sale\", \"escrow_release\", \"refund\"].includes(type);\n    return (\n      <span className={isCredit ? \"text-green-600\" : \"text-red-600\"}>\n        {isCredit ? \"+\" : \"-\"}{parseFloat(amount).toLocaleString()}\n      </span>\n    );\n  };\n\n  const handleAccountNumberChange = (value: string) => {\n    const numericValue = value.replace(/\\D/g, '').slice(0, 10);\n    setAccountNumber(numericValue);\n  };\n\n  if (walletLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Skeleton className=\"h-48 w-full mb-6\" />\n        <Skeleton className=\"h-64 w-full\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 max-w-4xl\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold mb-2\">Wallet</h1>\n        <p className=\"text-muted-foreground\">Manage your funds and transactions</p>\n      </div>\n\n      <Card className=\"mb-8 bg-gradient-to-br from-primary/20 to-primary/5\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex flex-col items-center text-center\">\n            <div className=\"rounded-full bg-primary/10 p-4 mb-4\">\n              <WalletIcon className=\"h-8 w-8 text-primary\" />\n            </div>\n            <p className=\"text-sm text-muted-foreground mb-1\">Your Balance</p>\n            <h2 className=\"text-4xl font-bold text-primary\" data-testid=\"text-wallet-balance\">\n              {parseFloat(wallet?.balance || \"0\").toLocaleString()}\n            </h2>\n            {wallet?.escrowBalance && parseFloat(wallet.escrowBalance) > 0 && (\n              <p className=\"text-sm text-muted-foreground mt-2\">\n                + {parseFloat(wallet.escrowBalance).toLocaleString()} in escrow\n              </p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Tabs defaultValue=\"deposit\" className=\"mb-8\">\n        <TabsList className=\"grid w-full grid-cols-3\">\n          <TabsTrigger value=\"deposit\" data-testid=\"tab-deposit\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Deposit\n          </TabsTrigger>\n          <TabsTrigger value=\"withdraw\" data-testid=\"tab-withdraw\">\n            <ArrowUpRight className=\"h-4 w-4 mr-2\" />\n            Withdraw\n          </TabsTrigger>\n          <TabsTrigger value=\"history\" data-testid=\"tab-history\">\n            <Clock className=\"h-4 w-4 mr-2\" />\n            History\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"deposit\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Online Deposit</CardTitle>\n              <CardDescription>\n                Add funds to your wallet using card or bank transfer\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"deposit-amount\">Amount (NGN)</Label>\n                <Input\n                  id=\"deposit-amount\"\n                  type=\"number\"\n                  placeholder=\"Enter amount (min 100)\"\n                  value={depositAmount}\n                  onChange={(e) => setDepositAmount(e.target.value)}\n                  data-testid=\"input-deposit-amount\"\n                />\n              </div>\n              <div className=\"flex gap-2 flex-wrap\">\n                {[500, 1000, 2000, 5000, 10000].map((amount) => (\n                  <Button\n                    key={amount}\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setDepositAmount(amount.toString())}\n                    data-testid={`button-preset-${amount}`}\n                  >\n                    {amount.toLocaleString()}\n                  </Button>\n                ))}\n              </div>\n              <Button\n                onClick={handleDeposit}\n                disabled={depositMutation.isPending}\n                className=\"w-full\"\n                data-testid=\"button-deposit\"\n              >\n                {depositMutation.isPending ? \"Processing...\" : \"Deposit Now\"}\n              </Button>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"withdraw\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Withdraw to Bank</CardTitle>\n              <CardDescription>\n                Transfer funds to your bank account (min 500 NGN)\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"withdraw-amount\">Amount (NGN)</Label>\n                <Input\n                  id=\"withdraw-amount\"\n                  type=\"number\"\n                  placeholder=\"Enter amount (min 500)\"\n                  value={withdrawAmount}\n                  onChange={(e) => setWithdrawAmount(e.target.value)}\n                  data-testid=\"input-withdraw-amount\"\n                />\n              </div>\n              \n              <div>\n                <Label htmlFor=\"bank-select\">Select Bank</Label>\n                {banksLoading ? (\n                  <Skeleton className=\"h-10 w-full\" />\n                ) : (\n                  <Select\n                    value={selectedBankCode}\n                    onValueChange={(value) => {\n                      setSelectedBankCode(value);\n                      setVerifiedAccount(null);\n                      setAccountConfirmed(false);\n                    }}\n                  >\n                    <SelectTrigger id=\"bank-select\" data-testid=\"select-bank\">\n                      <SelectValue placeholder=\"Choose your bank\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {banks?.map((bank) => (\n                        <SelectItem key={bank.code} value={bank.code} data-testid={`bank-option-${bank.code}`}>\n                          {bank.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                )}\n              </div>\n\n              <div>\n                <Label htmlFor=\"account-number\">Account Number</Label>\n                <Input\n                  id=\"account-number\"\n                  placeholder=\"10 digit account number\"\n                  value={accountNumber}\n                  onChange={(e) => handleAccountNumberChange(e.target.value)}\n                  maxLength={10}\n                  data-testid=\"input-account-number\"\n                />\n                {accountNumber.length > 0 && accountNumber.length < 10 && (\n                  <p className=\"text-sm text-muted-foreground mt-1\">\n                    {10 - accountNumber.length} more digit{10 - accountNumber.length !== 1 ? 's' : ''} needed\n                  </p>\n                )}\n              </div>\n\n              {verifyAccountMutation.isPending && (\n                <div className=\"flex items-center gap-2 p-3 bg-muted rounded-lg\" data-testid=\"verification-loading\">\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                  <span className=\"text-sm\">Verifying account...</span>\n                </div>\n              )}\n\n              {verificationError && (\n                <div className=\"flex items-center gap-2 p-3 bg-destructive/10 text-destructive rounded-lg\" data-testid=\"verification-error\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  <span className=\"text-sm\">{verificationError}</span>\n                </div>\n              )}\n\n              {verifiedAccount && (\n                <div className=\"space-y-3\">\n                  <div className=\"p-4 bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800 rounded-lg\" data-testid=\"verified-account\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <CheckCircle className=\"h-5 w-5 text-green-600\" />\n                      <span className=\"font-medium text-green-700 dark:text-green-300\">Account Verified</span>\n                    </div>\n                    <p className=\"text-lg font-semibold\" data-testid=\"text-account-name\">\n                      {verifiedAccount.accountName}\n                    </p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {selectedBank?.name} - {verifiedAccount.accountNumber}\n                    </p>\n                  </div>\n\n                  <div className=\"flex items-center gap-3\">\n                    <Checkbox\n                      id=\"confirm-account\"\n                      checked={accountConfirmed}\n                      onCheckedChange={(checked) => setAccountConfirmed(checked === true)}\n                      data-testid=\"checkbox-confirm-account\"\n                    />\n                    <Label htmlFor=\"confirm-account\" className=\"text-sm cursor-pointer\">\n                      I confirm this is the correct account for withdrawal\n                    </Label>\n                  </div>\n                </div>\n              )}\n\n              <Button\n                onClick={handleWithdraw}\n                disabled={withdrawMutation.isPending || !verifiedAccount || !accountConfirmed}\n                className=\"w-full\"\n                data-testid=\"button-withdraw\"\n              >\n                {withdrawMutation.isPending ? \"Processing...\" : \"Withdraw\"}\n              </Button>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"history\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Transaction History</CardTitle>\n              <CardDescription>\n                Your recent wallet activity\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {transactionsLoading ? (\n                <div className=\"space-y-4\">\n                  {[...Array(5)].map((_, i) => (\n                    <Skeleton key={i} className=\"h-16 w-full\" />\n                  ))}\n                </div>\n              ) : transactions && transactions.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {transactions.map((tx) => (\n                    <div\n                      key={tx.id}\n                      className=\"flex items-center justify-between p-4 border rounded-lg\"\n                      data-testid={`transaction-${tx.id}`}\n                    >\n                      <div className=\"flex items-center gap-4\">\n                        <div className=\"rounded-full bg-muted p-2\">\n                          {getTransactionIcon(tx.type)}\n                        </div>\n                        <div>\n                          <p className=\"font-medium capitalize\">\n                            {tx.type.replace(/_/g, \" \")}\n                          </p>\n                          <p className=\"text-sm text-muted-foreground\">\n                            {tx.description || format(new Date(tx.createdAt!), \"MMM d, yyyy 'at' h:mm a\")}\n                          </p>\n                        </div>\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"font-semibold\">\n                          {formatAmount(tx.amount, tx.type)}\n                        </p>\n                        {getStatusBadge(tx.status || \"completed\")}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8\">\n                  <WalletIcon className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                  <p className=\"text-muted-foreground\">No transactions yet</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":19522,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/pages/payment-callback.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { CheckCircle, XCircle, Loader2, ShoppingBag, Home } from \"lucide-react\";\n\ninterface PaymentVerificationResult {\n  status: string;\n  amountPaid: number;\n  paymentMethod: string;\n  paidOn: string;\n}\n\ninterface PendingCheckout {\n  cartItems: Array<{ productId: string; quantity: number }>;\n  deliveryMethod: string;\n  deliveryAddress?: string;\n  deliveryLocation?: string;\n  deliveryNotes?: string;\n}\n\ninterface OrderResult {\n  id: string;\n  orderNumber: string;\n}\n\nexport default function PaymentCallbackPage() {\n  const [, setLocation] = useLocation();\n  const searchString = useSearch();\n  const { toast } = useToast();\n  \n  const [status, setStatus] = useState<\"verifying\" | \"success\" | \"failed\" | \"creating_orders\">(\"verifying\");\n  const [orderResults, setOrderResults] = useState<OrderResult[]>([]);\n  const [errorMessage, setErrorMessage] = useState<string>(\"\");\n\n  const searchParams = new URLSearchParams(searchString);\n  const paymentReference = searchParams.get(\"paymentReference\") || searchParams.get(\"reference\");\n  const transactionReference = searchParams.get(\"transactionReference\") || searchParams.get(\"transaction_ref\");\n\n  const reference = paymentReference || transactionReference;\n\n  const createOrderMutation = useMutation({\n    mutationFn: async (data: { \n      productId: string; \n      deliveryMethod: string;\n      deliveryAddress?: string;\n      deliveryLocation?: string;\n      deliveryNotes?: string;\n    }) => {\n      const res = await apiRequest(\"POST\", \"/api/orders\", data);\n      return res.json();\n    },\n  });\n\n  const clearCartMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"DELETE\", \"/api/cart\");\n    },\n  });\n\n  useEffect(() => {\n    const verifyPayment = async () => {\n      if (!reference) {\n        setStatus(\"failed\");\n        setErrorMessage(\"No payment reference found in URL\");\n        return;\n      }\n\n      try {\n        const res = await fetch(`/api/squad/verify/${reference}`, {\n          credentials: \"include\",\n        });\n\n        if (!res.ok) {\n          const errorData = await res.json();\n          throw new Error(errorData.message || \"Payment verification failed\");\n        }\n\n        const result: PaymentVerificationResult = await res.json();\n\n        if (result.status === \"success\") {\n          setStatus(\"creating_orders\");\n          \n          const pendingCheckoutStr = localStorage.getItem(\"pendingCheckout\");\n          if (pendingCheckoutStr) {\n            try {\n              const pendingCheckout: PendingCheckout = JSON.parse(pendingCheckoutStr);\n              \n              const orders: OrderResult[] = [];\n              for (const item of pendingCheckout.cartItems) {\n                const order = await createOrderMutation.mutateAsync({\n                  productId: item.productId,\n                  deliveryMethod: pendingCheckout.deliveryMethod,\n                  deliveryAddress: pendingCheckout.deliveryAddress,\n                  deliveryLocation: pendingCheckout.deliveryLocation,\n                  deliveryNotes: pendingCheckout.deliveryNotes,\n                });\n                orders.push(order);\n              }\n\n              setOrderResults(orders);\n\n              await clearCartMutation.mutateAsync();\n\n              localStorage.removeItem(\"pendingCheckout\");\n\n              queryClient.invalidateQueries({ queryKey: [\"/api/cart\"] });\n              queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n              queryClient.invalidateQueries({ queryKey: [\"/api/orders/buyer\"] });\n\n              setStatus(\"success\");\n\n              toast({\n                title: \"Payment Successful\",\n                description: `Your payment of ₦${result.amountPaid.toLocaleString()} has been confirmed`,\n              });\n            } catch (orderError: any) {\n              console.error(\"Error creating orders:\", orderError);\n              setStatus(\"success\");\n              toast({\n                title: \"Payment Successful\",\n                description: \"Payment received but there was an issue creating your orders. Please contact support.\",\n              });\n            }\n          } else {\n            queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n            setStatus(\"success\");\n            toast({\n              title: \"Payment Successful\",\n              description: `Your wallet has been credited with ₦${result.amountPaid.toLocaleString()}`,\n            });\n          }\n        } else if (result.status === \"pending\") {\n          setStatus(\"verifying\");\n          setTimeout(verifyPayment, 3000);\n        } else {\n          setStatus(\"failed\");\n          setErrorMessage(`Payment status: ${result.status}`);\n        }\n      } catch (error: any) {\n        console.error(\"Payment verification error:\", error);\n        setStatus(\"failed\");\n        setErrorMessage(error.message || \"Failed to verify payment\");\n      }\n    };\n\n    verifyPayment();\n  }, [reference]);\n\n  if (status === \"verifying\" || status === \"creating_orders\") {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-md\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex flex-col items-center text-center space-y-4\">\n              <Loader2 className=\"h-12 w-12 animate-spin text-primary\" />\n              <h1 className=\"text-xl font-semibold\">\n                {status === \"verifying\" ? \"Verifying Payment...\" : \"Creating Orders...\"}\n              </h1>\n              <p className=\"text-muted-foreground\">\n                {status === \"verifying\" \n                  ? \"Please wait while we confirm your payment.\"\n                  : \"Please wait while we process your orders.\"\n                }\n              </p>\n              <Skeleton className=\"h-4 w-3/4\" />\n              <Skeleton className=\"h-4 w-1/2\" />\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (status === \"failed\") {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-md\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex flex-col items-center text-center space-y-4\">\n              <div className=\"rounded-full bg-destructive/10 p-4\">\n                <XCircle className=\"h-12 w-12 text-destructive\" />\n              </div>\n              <h1 className=\"text-xl font-semibold\">Payment Failed</h1>\n              <p className=\"text-muted-foreground\">\n                {errorMessage || \"There was an issue processing your payment.\"}\n              </p>\n              <div className=\"flex flex-col sm:flex-row gap-3 w-full sm:w-auto\">\n                <Button\n                  onClick={() => setLocation(\"/checkout\")}\n                  data-testid=\"button-try-again\"\n                >\n                  Try Again\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setLocation(\"/\")}\n                  data-testid=\"button-go-home\"\n                >\n                  <Home className=\"mr-2 h-4 w-4\" />\n                  Go Home\n                </Button>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 max-w-md\">\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"flex flex-col items-center text-center space-y-4\">\n            <div className=\"rounded-full bg-green-100 dark:bg-green-900/30 p-4\">\n              <CheckCircle className=\"h-12 w-12 text-green-600 dark:text-green-400\" />\n            </div>\n            <h1 className=\"text-xl font-semibold\">Payment Successful!</h1>\n            <p className=\"text-muted-foreground\">\n              {orderResults.length > 0\n                ? \"Your payment has been confirmed and your orders have been placed.\"\n                : \"Your payment has been confirmed and your wallet has been credited.\"\n              }\n            </p>\n            \n            {orderResults.length > 0 && (\n              <div className=\"bg-muted rounded-md p-4 w-full space-y-2\">\n                <p className=\"text-sm text-muted-foreground\">Order Number(s)</p>\n                {orderResults.map((order, index) => (\n                  <p \n                    key={order.id}\n                    className=\"text-lg font-mono font-bold\"\n                    data-testid={`text-order-number-${index}`}\n                  >\n                    {order.orderNumber}\n                  </p>\n                ))}\n              </div>\n            )}\n\n            <div className=\"flex flex-col sm:flex-row gap-3 w-full sm:w-auto\">\n              {orderResults.length > 0 ? (\n                <>\n                  <Button\n                    onClick={() => setLocation(\"/orders\")}\n                    data-testid=\"button-view-orders\"\n                  >\n                    <ShoppingBag className=\"mr-2 h-4 w-4\" />\n                    View My Orders\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setLocation(\"/\")}\n                    data-testid=\"button-continue-shopping\"\n                  >\n                    Continue Shopping\n                  </Button>\n                </>\n              ) : (\n                <>\n                  <Button\n                    onClick={() => setLocation(\"/wallet\")}\n                    data-testid=\"button-view-wallet\"\n                  >\n                    View Wallet\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setLocation(\"/\")}\n                    data-testid=\"button-go-home\"\n                  >\n                    <Home className=\"mr-2 h-4 w-4\" />\n                    Go Home\n                  </Button>\n                </>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":10314,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/pages/the-plug.tsx":{"content":"import { useState, useRef, useEffect, useCallback, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { SponsoredAdCard } from \"@/components/SponsoredAdCard\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Input } from \"@/components/ui/input\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Heart, \n  MessageCircle, \n  Send, \n  Image as ImageIcon, \n  X, \n  UserPlus,\n  UserCheck,\n  Users,\n  Compass,\n  Zap,\n  Trash2,\n  Store,\n  Sparkles,\n  Repeat2,\n  Share,\n  MoreHorizontal,\n  Play,\n  Video,\n  BadgeCheck,\n  Plus,\n  Link2,\n  Bookmark,\n  BookmarkCheck\n} from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { Link, useLocation, useSearch } from \"wouter\";\nimport type { User, SocialPost, SponsoredAd } from \"@shared/schema\";\nimport { StoriesBar } from \"./stories\";\n\ntype PostWithAuthor = SocialPost & { \n  author: User; \n  isLiked?: boolean;\n  isFollowingAuthor?: boolean;\n  isReposted?: boolean;\n  isBookmarked?: boolean;\n  engagementScore?: string;\n  viewsCount?: number;\n  sharesCount?: number;\n};\n\ntype Comment = {\n  id: string;\n  content: string;\n  authorId: string;\n  createdAt: string;\n  author: User;\n};\n\nfunction formatEngagement(count: number): string {\n  if (count >= 1000000) {\n    return `${(count / 1000000).toFixed(1).replace(/\\.0$/, '')}M`;\n  }\n  if (count >= 1000) {\n    return `${(count / 1000).toFixed(1).replace(/\\.0$/, '')}K`;\n  }\n  return count.toString();\n}\n\nfunction MediaGrid({ images, videos }: { images?: string[] | null; videos?: string[] | null }) {\n  const allMedia = [\n    ...(images || []).map(url => ({ url, type: 'image' as const })),\n    ...(videos || []).map(url => ({ url, type: 'video' as const }))\n  ];\n\n  if (allMedia.length === 0) return null;\n\n  const getGridClasses = () => {\n    switch (allMedia.length) {\n      case 1:\n        return \"grid-cols-1\";\n      case 2:\n        return \"grid-cols-2\";\n      case 3:\n        return \"grid-cols-2\";\n      case 4:\n        return \"grid-cols-2\";\n      default:\n        return \"grid-cols-2\";\n    }\n  };\n\n  const getItemClasses = (index: number, total: number) => {\n    if (total === 1) return \"aspect-video\";\n    if (total === 2) return \"aspect-square\";\n    if (total === 3) {\n      if (index === 0) return \"row-span-2 aspect-[2/3]\";\n      return \"aspect-square\";\n    }\n    if (total >= 4) return \"aspect-square\";\n    return \"aspect-square\";\n  };\n\n  return (\n    <div className={`grid ${getGridClasses()} gap-0.5 rounded-xl overflow-hidden`}>\n      {allMedia.slice(0, 4).map((media, idx) => {\n        const isMoreThanFour = allMedia.length > 4 && idx === 3;\n        \n        return (\n          <div \n            key={idx} \n            className={`relative ${getItemClasses(idx, allMedia.length)} overflow-hidden bg-muted`}\n          >\n            {media.type === 'video' ? (\n              <div className=\"relative w-full h-full group\">\n                <video\n                  src={media.url}\n                  className=\"w-full h-full object-cover\"\n                  controls\n                  playsInline\n                  preload=\"metadata\"\n                />\n                <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity bg-black/20\">\n                  <div className=\"h-12 w-12 rounded-full bg-white/90 flex items-center justify-center\">\n                    <Play className=\"h-6 w-6 text-black fill-black ml-0.5\" />\n                  </div>\n                </div>\n              </div>\n            ) : (\n              <img\n                src={media.url}\n                alt={`Media ${idx + 1}`}\n                className=\"w-full h-full object-cover hover:scale-[1.02] transition-transform duration-300\"\n                loading=\"lazy\"\n              />\n            )}\n            {isMoreThanFour && (\n              <div className=\"absolute inset-0 bg-black/60 flex items-center justify-center\">\n                <span className=\"text-white text-xl font-semibold\">+{allMedia.length - 4}</span>\n              </div>\n            )}\n          </div>\n        );\n      })}\n    </div>\n  );\n}\n\nfunction VerifiedBadge({ size = \"sm\" }: { size?: \"sm\" | \"md\" }) {\n  const sizeClasses = size === \"sm\" ? \"h-3.5 w-3.5\" : \"h-4 w-4\";\n  return (\n    <div className=\"relative inline-flex\">\n      <BadgeCheck className={`${sizeClasses} text-primary fill-primary/10`} />\n    </div>\n  );\n}\n\nfunction SellerBadge() {\n  return (\n    <Badge \n      variant=\"outline\" \n      className=\"text-[10px] px-1.5 py-0 h-4 border-orange-500/30 bg-orange-500/10 text-orange-600 dark:text-orange-400 font-medium gap-0.5\"\n    >\n      <Store className=\"h-2.5 w-2.5\" />\n      Seller\n    </Badge>\n  );\n}\n\nfunction EKSUPlugBadge({ size = \"sm\" }: { size?: \"sm\" | \"md\" }) {\n  const sizeClasses = size === \"sm\" ? \"h-3.5 w-3.5\" : \"h-4 w-4\";\n  return (\n    <div className=\"relative inline-flex\">\n      <BadgeCheck className={`${sizeClasses} text-amber-500 fill-amber-500/20`} />\n    </div>\n  );\n}\n\nfunction isEKSUPlugAccount(author: User): boolean {\n  return author?.isSystemAccount === true && author?.systemAccountType === 'eksuplug';\n}\n\nexport default function ThePlugPage() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const searchString = useSearch();\n  \n  // Parse URL query parameter for initial tab\n  const initialTab = useMemo(() => {\n    const params = new URLSearchParams(searchString);\n    const tab = params.get(\"tab\");\n    if (tab === \"bookmarks\") return \"bookmarks\";\n    if (tab === \"following\") return \"following\";\n    return \"for_you\";\n  }, [searchString]);\n  \n  const [activeTab, setActiveTab] = useState(initialTab);\n  const [newPostContent, setNewPostContent] = useState(\"\");\n  const [selectedMedia, setSelectedMedia] = useState<File[]>([]);\n  const [mediaPreviews, setMediaPreviews] = useState<{ url: string; type: 'image' | 'video' }[]>([]);\n  const [commentText, setCommentText] = useState<Record<string, string>>({});\n  const [expandedComments, setExpandedComments] = useState<string | null>(null);\n  const [likedPosts, setLikedPosts] = useState<Set<string>>(new Set());\n  const [repostedPosts, setRepostedPosts] = useState<Set<string>>(new Set());\n  const [bookmarkedPosts, setBookmarkedPosts] = useState<Set<string>>(new Set());\n  const [optimisticFollows, setOptimisticFollows] = useState<Map<string, boolean>>(new Map());\n  const [showMobileComposer, setShowMobileComposer] = useState(false);\n  const [shareDialogOpen, setShareDialogOpen] = useState(false);\n  const [sharePost, setSharePost] = useState<PostWithAuthor | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const viewedPostsRef = useRef<Set<string>>(new Set());\n\n  // Update activeTab when URL changes\n  useEffect(() => {\n    setActiveTab(initialTab);\n  }, [initialTab]);\n\n  // Handle scroll lock for mobile composer\n  useEffect(() => {\n    if (showMobileComposer) {\n      document.body.style.overflow = 'hidden';\n      document.body.style.position = 'fixed';\n      document.body.style.width = '100%';\n      document.body.style.top = `-${window.scrollY}px`;\n    } else {\n      const scrollY = document.body.style.top;\n      document.body.style.overflow = '';\n      document.body.style.position = '';\n      document.body.style.width = '';\n      document.body.style.top = '';\n      if (scrollY) {\n        window.scrollTo(0, parseInt(scrollY || '0') * -1);\n      }\n    }\n    \n    return () => {\n      document.body.style.overflow = '';\n      document.body.style.position = '';\n      document.body.style.width = '';\n      document.body.style.top = '';\n    };\n  }, [showMobileComposer]);\n\n  // Handle tab change and update URL\n  const handleTabChange = (newTab: string) => {\n    setActiveTab(newTab);\n    if (newTab === \"for_you\") {\n      setLocation(\"/the-plug\");\n    } else {\n      setLocation(`/the-plug?tab=${newTab}`);\n    }\n  };\n\n  const { data: posts, isLoading } = useQuery<PostWithAuthor[]>({\n    queryKey: [\"/api/feed\", { type: activeTab }],\n  });\n\n  const { data: sponsoredAds = [] } = useQuery<SponsoredAd[]>({\n    queryKey: [\"/api/ads/active\", { type: \"plug\" }],\n  });\n\n  const { data: comments } = useQuery<Comment[]>({\n    queryKey: [\"/api/social-posts\", expandedComments, \"comments\"],\n    enabled: !!expandedComments,\n  });\n\n  const createPostMutation = useMutation({\n    mutationFn: async (data: { content: string; media: File[] }) => {\n      const formData = new FormData();\n      formData.append(\"content\", data.content);\n      data.media.forEach((file) => {\n        formData.append(\"media\", file);\n      });\n      const response = await fetch(\"/api/social-posts\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to create post\");\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Post created!\" });\n      setNewPostContent(\"\");\n      setSelectedMedia([]);\n      setMediaPreviews([]);\n      setShowMobileComposer(false);\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n    },\n    onError: () => {\n      toast({ title: \"Failed to create post\", variant: \"destructive\" });\n    },\n  });\n\n  const likeMutation = useMutation({\n    mutationFn: async (postId: string) => {\n      const response = await apiRequest(\"POST\", `/api/social-posts/${postId}/like`);\n      return response.json();\n    },\n    onMutate: (postId) => {\n      setLikedPosts(prev => {\n        const newSet = new Set(prev);\n        if (newSet.has(postId)) {\n          newSet.delete(postId);\n        } else {\n          newSet.add(postId);\n        }\n        return newSet;\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n    },\n  });\n\n  const repostMutation = useMutation({\n    mutationFn: async (postId: string) => {\n      const response = await apiRequest(\"POST\", `/api/social-posts/${postId}/repost`);\n      return response.json();\n    },\n    onMutate: (postId) => {\n      setRepostedPosts(prev => {\n        const newSet = new Set(prev);\n        if (newSet.has(postId)) {\n          newSet.delete(postId);\n        } else {\n          newSet.add(postId);\n        }\n        return newSet;\n      });\n    },\n    onSuccess: (data) => {\n      if (data.action === \"reposted\") {\n        toast({ title: \"Reposted!\" });\n      } else {\n        toast({ title: \"Removed repost\" });\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n    },\n  });\n\n  const commentMutation = useMutation({\n    mutationFn: async ({ postId, content }: { postId: string; content: string }) => {\n      const response = await apiRequest(\"POST\", `/api/social-posts/${postId}/comments`, { content });\n      return response.json();\n    },\n    onSuccess: (_, variables) => {\n      setCommentText((prev) => ({ ...prev, [variables.postId]: \"\" }));\n      queryClient.invalidateQueries({ queryKey: [\"/api/social-posts\", variables.postId, \"comments\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n    },\n  });\n\n  const deletePostMutation = useMutation({\n    mutationFn: async (postId: string) => {\n      const response = await apiRequest(\"DELETE\", `/api/social-posts/${postId}`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Post deleted\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n    },\n  });\n\n  const followMutation = useMutation({\n    mutationFn: async ({ userId, isCurrentlyFollowing }: { userId: string; isCurrentlyFollowing: boolean }) => {\n      if (isCurrentlyFollowing) {\n        await apiRequest(\"DELETE\", `/api/users/${userId}/follow`);\n        return { action: \"unfollowed\", userId };\n      } else {\n        await apiRequest(\"POST\", `/api/users/${userId}/follow`);\n        return { action: \"followed\", userId };\n      }\n    },\n    onMutate: ({ userId, isCurrentlyFollowing }) => {\n      setOptimisticFollows(prev => {\n        const newMap = new Map(prev);\n        newMap.set(userId, !isCurrentlyFollowing);\n        return newMap;\n      });\n    },\n    onSuccess: (data) => {\n      if (data.action === \"followed\") {\n        toast({ title: \"Following!\" });\n      } else {\n        toast({ title: \"Unfollowed\" });\n      }\n      setOptimisticFollows(new Map());\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", data.userId, \"follow-stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", data.userId, \"followers\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", user?.id, \"following\"] });\n    },\n    onError: (error: any, { userId }) => {\n      setOptimisticFollows(prev => {\n        const newMap = new Map(prev);\n        newMap.delete(userId);\n        return newMap;\n      });\n      toast({ title: error.message || \"Failed to update follow status\", variant: \"destructive\" });\n    },\n  });\n\n  const bookmarkMutation = useMutation({\n    mutationFn: async (postId: string) => {\n      const response = await apiRequest(\"POST\", `/api/social-posts/${postId}/bookmark`);\n      return response.json();\n    },\n    onMutate: (postId) => {\n      setBookmarkedPosts(prev => {\n        const newSet = new Set(prev);\n        if (newSet.has(postId)) {\n          newSet.delete(postId);\n        } else {\n          newSet.add(postId);\n        }\n        return newSet;\n      });\n    },\n    onSuccess: (data) => {\n      if (data.action === \"bookmarked\") {\n        toast({ title: \"Added to bookmarks\" });\n      } else {\n        toast({ title: \"Removed from bookmarks\" });\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n    },\n  });\n\n  const trackViewMutation = useMutation({\n    mutationFn: async (postId: string) => {\n      await apiRequest(\"POST\", `/api/social-posts/${postId}/view`);\n    },\n  });\n\n  const trackShareMutation = useMutation({\n    mutationFn: async (postId: string) => {\n      await apiRequest(\"POST\", `/api/social-posts/${postId}/share`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n    },\n  });\n\n  const handleMediaUpload = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = Array.from(e.target.files || []);\n    if (files.length + selectedMedia.length > 10) {\n      toast({ title: \"Maximum 10 media files allowed\", variant: \"destructive\" });\n      return;\n    }\n    setSelectedMedia((prev) => [...prev, ...files]);\n    files.forEach((file) => {\n      const isVideo = file.type.startsWith('video/');\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setMediaPreviews((prev) => [...prev, { \n          url: reader.result as string, \n          type: isVideo ? 'video' : 'image' \n        }]);\n      };\n      reader.readAsDataURL(file);\n    });\n  };\n\n  const removeMedia = (index: number) => {\n    setSelectedMedia((prev) => prev.filter((_, i) => i !== index));\n    setMediaPreviews((prev) => prev.filter((_, i) => i !== index));\n  };\n\n  const handleCreatePost = () => {\n    if (!newPostContent.trim() && selectedMedia.length === 0) {\n      toast({ title: \"Please add some content\", variant: \"destructive\" });\n      return;\n    }\n    createPostMutation.mutate({ content: newPostContent, media: selectedMedia });\n  };\n\n  const handleShare = (post: PostWithAuthor) => {\n    trackShareMutation.mutate(post.id);\n    setSharePost(post);\n    setShareDialogOpen(true);\n  };\n\n  const copyPostLink = () => {\n    if (sharePost) {\n      navigator.clipboard.writeText(`${window.location.origin}/the-plug?post=${sharePost.id}`);\n      toast({ title: \"Link copied to clipboard\" });\n      setShareDialogOpen(false);\n    }\n  };\n\n  const getInitials = (firstName?: string | null, lastName?: string | null) => {\n    return `${firstName?.[0] || \"\"}${lastName?.[0] || \"\"}`.toUpperCase() || \"U\";\n  };\n\n  const isPostLiked = (post: PostWithAuthor) => {\n    return likedPosts.has(post.id) || post.isLiked;\n  };\n\n  const isPostReposted = (post: PostWithAuthor) => {\n    return repostedPosts.has(post.id) || post.isReposted;\n  };\n\n  const isPostBookmarked = (post: PostWithAuthor) => {\n    return bookmarkedPosts.has(post.id) || post.isBookmarked;\n  };\n\n  const trackPostView = useCallback((postId: string) => {\n    if (!viewedPostsRef.current.has(postId)) {\n      viewedPostsRef.current.add(postId);\n      trackViewMutation.mutate(postId);\n    }\n  }, [trackViewMutation]);\n\n  const isUserFollowed = (authorId: string, post: PostWithAuthor) => {\n    if (optimisticFollows.has(authorId)) {\n      return optimisticFollows.get(authorId);\n    }\n    return post.isFollowingAuthor || false;\n  };\n\n  const PostComposer = ({ isMobile = false }: { isMobile?: boolean }) => (\n    <div className=\"flex gap-3\">\n      <Avatar className=\"h-10 w-10 ring-2 ring-background shadow-sm flex-shrink-0\">\n        <AvatarImage src={user?.profileImageUrl || undefined} />\n        <AvatarFallback className=\"bg-primary/10 text-primary font-medium\">\n          {getInitials(user?.firstName, user?.lastName)}\n        </AvatarFallback>\n      </Avatar>\n      <div className=\"flex-1 space-y-3\">\n        <Textarea\n          placeholder=\"What's happening on campus?\"\n          value={newPostContent}\n          onChange={(e) => setNewPostContent(e.target.value)}\n          className=\"resize-none border-0 bg-transparent focus-visible:ring-0 text-base min-h-[80px] placeholder:text-muted-foreground/60\"\n          rows={3}\n          data-testid=\"input-new-post\"\n        />\n        \n        <AnimatePresence>\n          {mediaPreviews.length > 0 && (\n            <motion.div \n              initial={{ opacity: 0, height: 0 }}\n              animate={{ opacity: 1, height: \"auto\" }}\n              exit={{ opacity: 0, height: 0 }}\n              className=\"flex gap-2 flex-wrap\"\n            >\n              {mediaPreviews.map((preview, index) => (\n                <motion.div \n                  key={index} \n                  className=\"relative group\"\n                  initial={{ opacity: 0, scale: 0.8 }}\n                  animate={{ opacity: 1, scale: 1 }}\n                  exit={{ opacity: 0, scale: 0.8 }}\n                >\n                  <div className=\"h-20 w-20 rounded-lg overflow-hidden ring-1 ring-border\">\n                    {preview.type === 'video' ? (\n                      <div className=\"h-full w-full bg-muted flex items-center justify-center relative\">\n                        <video src={preview.url} className=\"h-full w-full object-cover\" />\n                        <div className=\"absolute inset-0 flex items-center justify-center bg-black/30\">\n                          <Play className=\"h-6 w-6 text-white fill-white\" />\n                        </div>\n                      </div>\n                    ) : (\n                      <img\n                        src={preview.url}\n                        alt={`Preview ${index + 1}`}\n                        className=\"h-full w-full object-cover\"\n                        loading=\"lazy\"\n                      />\n                    )}\n                  </div>\n                  <Button\n                    type=\"button\"\n                    variant=\"destructive\"\n                    size=\"icon\"\n                    className=\"absolute -top-1.5 -right-1.5 h-5 w-5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity\"\n                    onClick={() => removeMedia(index)}\n                  >\n                    <X className=\"h-3 w-3\" />\n                  </Button>\n                </motion.div>\n              ))}\n            </motion.div>\n          )}\n        </AnimatePresence>\n\n        <Separator className=\"my-2\" />\n\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-1\">\n            <input\n              ref={fileInputRef}\n              type=\"file\"\n              accept=\"image/*,video/*\"\n              multiple\n              className=\"hidden\"\n              onChange={handleMediaUpload}\n              data-testid=\"input-post-media\"\n              aria-label=\"Upload photos or videos\"\n            />\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"rounded-full text-primary gap-1.5\"\n              onClick={() => fileInputRef.current?.click()}\n              aria-label=\"Add photos or videos\"\n              data-testid=\"button-add-media\"\n            >\n              <ImageIcon className=\"h-5 w-5\" />\n              <span className=\"text-xs font-medium\">Media</span>\n            </Button>\n          </div>\n          <Button\n            onClick={handleCreatePost}\n            disabled={createPostMutation.isPending || (!newPostContent.trim() && selectedMedia.length === 0)}\n            className=\"rounded-full px-5 font-semibold\"\n            data-testid=\"button-create-post\"\n          >\n            {createPostMutation.isPending ? (\n              <motion.div\n                animate={{ rotate: 360 }}\n                transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\n              >\n                <Send className=\"h-4 w-4\" />\n              </motion.div>\n            ) : (\n              \"Post\"\n            )}\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"container mx-auto px-4 py-6 max-w-xl\">\n        <motion.div \n          initial={{ opacity: 0, y: -10 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"flex items-center justify-between mb-6\"\n        >\n          <div className=\"flex items-center gap-3\">\n            <div className=\"relative\">\n              <div className=\"h-10 w-10 rounded-xl bg-primary/10 flex items-center justify-center\">\n                <Zap className=\"h-5 w-5 text-primary\" />\n              </div>\n              <Sparkles className=\"h-3 w-3 text-primary absolute -top-1 -right-1\" />\n            </div>\n            <div>\n              <h1 className=\"text-xl font-bold tracking-tight\">The Plug</h1>\n              <p className=\"text-xs text-muted-foreground\">Campus Social Feed</p>\n            </div>\n          </div>\n        </motion.div>\n\n        <motion.div\n          initial={{ opacity: 0, y: 5 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.05 }}\n          className=\"mb-4 -mx-4 border-b\"\n        >\n          <StoriesBar />\n        </motion.div>\n\n        <motion.div\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.1 }}\n          className=\"hidden md:block\"\n        >\n          <Card className=\"mb-6 overflow-hidden border-b\">\n            <CardContent className=\"p-4\">\n              <PostComposer />\n            </CardContent>\n          </Card>\n        </motion.div>\n\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          transition={{ delay: 0.2 }}\n        >\n          <Tabs value={activeTab} onValueChange={handleTabChange} className=\"mb-6\">\n            <TabsList className=\"w-full h-12 p-0 bg-transparent border-b rounded-none\">\n              <TabsTrigger \n                value=\"for_you\" \n                className=\"flex-1 h-full rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent transition-all\"\n                data-testid=\"tab-for-you\"\n              >\n                <Compass className=\"h-4 w-4 mr-2\" />\n                <span className=\"font-semibold\">For You</span>\n              </TabsTrigger>\n              <TabsTrigger \n                value=\"following\" \n                className=\"flex-1 h-full rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent transition-all\"\n                data-testid=\"tab-following\"\n              >\n                <Users className=\"h-4 w-4 mr-2\" />\n                <span className=\"font-semibold\">Following</span>\n              </TabsTrigger>\n              <TabsTrigger \n                value=\"bookmarks\" \n                className=\"flex-1 h-full rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent transition-all\"\n                data-testid=\"tab-bookmarks\"\n              >\n                <BookmarkCheck className=\"h-4 w-4 mr-2\" />\n                <span className=\"font-semibold\">Saved</span>\n              </TabsTrigger>\n            </TabsList>\n          </Tabs>\n        </motion.div>\n\n        {isLoading ? (\n          <div className=\"space-y-0 divide-y\">\n            {[...Array(3)].map((_, i) => (\n              <div key={i} className=\"py-4\">\n                <div className=\"flex items-start gap-3\">\n                  <Skeleton className=\"h-10 w-10 rounded-full flex-shrink-0\" />\n                  <div className=\"flex-1 space-y-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <Skeleton className=\"h-4 w-24\" />\n                      <Skeleton className=\"h-3 w-16\" />\n                    </div>\n                    <Skeleton className=\"h-16 w-full\" />\n                    <div className=\"flex gap-6\">\n                      <Skeleton className=\"h-8 w-14\" />\n                      <Skeleton className=\"h-8 w-14\" />\n                      <Skeleton className=\"h-8 w-14\" />\n                    </div>\n                  </div>\n                </div>\n              </div>\n            ))}\n          </div>\n        ) : posts && posts.length > 0 ? (\n          <motion.div \n            className=\"divide-y\"\n            initial=\"hidden\"\n            animate=\"visible\"\n            variants={{\n              visible: {\n                transition: {\n                  staggerChildren: 0.05\n                }\n              }\n            }}\n          >\n            {posts.map((post, index) => {\n              const adIndex = Math.floor(index / 5);\n              const showAd = index > 0 && index % 5 === 0 && sponsoredAds[adIndex - 1];\n              \n              return (\n                <>\n                  {showAd && (\n                    <SponsoredAdCard \n                      key={`ad-${sponsoredAds[adIndex - 1].id}`} \n                      ad={sponsoredAds[adIndex - 1]} \n                      variant=\"plug\"\n                    />\n                  )}\n                  <motion.article\n                key={post.id}\n                ref={(el) => {\n                  if (el && !viewedPostsRef.current.has(post.id)) {\n                    const observer = new IntersectionObserver(\n                      (entries) => {\n                        entries.forEach((entry) => {\n                          if (entry.isIntersecting) {\n                            trackPostView(post.id);\n                            observer.disconnect();\n                          }\n                        });\n                      },\n                      { threshold: 0.5 }\n                    );\n                    observer.observe(el);\n                  }\n                }}\n                variants={{\n                  hidden: { opacity: 0 },\n                  visible: { opacity: 1 }\n                }}\n                transition={{ duration: 0.2 }}\n                className=\"py-4\"\n                data-testid={`post-card-${post.id}`}\n              >\n                <div className=\"flex gap-3\">\n                  <Link href={`/profile/${post.authorId}`}>\n                    <Avatar className=\"h-10 w-10 flex-shrink-0 cursor-pointer hover:opacity-90 transition-opacity\">\n                      <AvatarImage src={post.author?.profileImageUrl || undefined} />\n                      <AvatarFallback className=\"bg-primary/10 text-primary font-medium text-sm\">\n                        {getInitials(post.author?.firstName, post.author?.lastName)}\n                      </AvatarFallback>\n                    </Avatar>\n                  </Link>\n                  \n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"flex items-center gap-1 flex-wrap min-w-0\">\n                        <Link href={`/profile/${post.authorId}`}>\n                          <span className={`font-bold text-sm hover:underline cursor-pointer truncate ${isEKSUPlugAccount(post.author) ? 'text-amber-600 dark:text-amber-400' : ''}`}>\n                            {post.author?.firstName} {post.author?.lastName}\n                          </span>\n                        </Link>\n                        {isEKSUPlugAccount(post.author) ? (\n                          <EKSUPlugBadge />\n                        ) : post.author?.isVerified ? (\n                          <VerifiedBadge />\n                        ) : null}\n                        {post.author?.role === \"seller\" && !isEKSUPlugAccount(post.author) && (\n                          <SellerBadge />\n                        )}\n                        <span className=\"text-muted-foreground text-sm\">·</span>\n                        <span className=\"text-muted-foreground text-sm\">\n                          {formatDistanceToNow(new Date(post.createdAt!), { addSuffix: false })}\n                        </span>\n                        {(post.viewsCount ?? 0) > 0 && (\n                          <>\n                            <span className=\"text-muted-foreground text-sm\">·</span>\n                            <span className=\"text-muted-foreground text-sm\">\n                              {formatEngagement(post.viewsCount || 0)} views\n                            </span>\n                          </>\n                        )}\n                      </div>\n                      \n                      <div className=\"flex items-center gap-1 flex-shrink-0\">\n                        {post.authorId !== user?.id && !isUserFollowed(post.authorId, post) && (\n                          <Button\n                            variant=\"default\"\n                            size=\"sm\"\n                            onClick={() => {\n                              followMutation.mutate({ userId: post.authorId, isCurrentlyFollowing: false });\n                            }}\n                            disabled={followMutation.isPending}\n                            className=\"h-7 rounded-full text-xs font-semibold px-3\"\n                            data-testid={`button-follow-${post.authorId}`}\n                          >\n                            Follow\n                          </Button>\n                        )}\n                        {post.authorId === user?.id && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => deletePostMutation.mutate(post.id)}\n                            className=\"h-8 w-8 text-muted-foreground hover:text-destructive rounded-full\"\n                            data-testid={`button-delete-${post.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        )}\n                      </div>\n                    </div>\n\n                    {post.content && (\n                      <p className=\"text-[15px] leading-relaxed text-foreground whitespace-pre-wrap mt-1 mb-3\">\n                        {post.content}\n                      </p>\n                    )}\n\n                    {((post.images && post.images.length > 0) || (post.videos && post.videos.length > 0)) && (\n                      <div className=\"mt-3 mb-3\">\n                        <MediaGrid images={post.images} videos={post.videos} />\n                      </div>\n                    )}\n\n                    <div className=\"flex items-center justify-between mt-3 -ml-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => setExpandedComments(expandedComments === post.id ? null : post.id)}\n                        className=\"h-8 px-2 gap-1 rounded-full text-muted-foreground hover:text-primary hover:bg-primary/10 group\"\n                        data-testid={`button-comments-${post.id}`}\n                      >\n                        <MessageCircle className=\"h-[18px] w-[18px] group-hover:text-primary\" />\n                        <span className=\"text-sm tabular-nums\">{formatEngagement(post.commentsCount || 0)}</span>\n                      </Button>\n\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => repostMutation.mutate(post.id)}\n                        disabled={repostMutation.isPending}\n                        className={`h-8 px-2 gap-1 rounded-full group ${\n                          isPostReposted(post)\n                            ? \"text-green-500\"\n                            : \"text-muted-foreground hover:text-green-500 hover:bg-green-500/10\"\n                        }`}\n                        data-testid={`button-repost-${post.id}`}\n                      >\n                        <Repeat2 className={`h-[18px] w-[18px] ${isPostReposted(post) ? \"text-green-500\" : \"group-hover:text-green-500\"}`} />\n                        <span className=\"text-sm tabular-nums\">{formatEngagement(post.repostsCount || 0)}</span>\n                      </Button>\n\n                      <motion.div whileTap={{ scale: 0.9 }}>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => likeMutation.mutate(post.id)}\n                          className={`h-8 px-2 gap-1 rounded-full group ${\n                            isPostLiked(post) \n                              ? \"text-red-500\" \n                              : \"text-muted-foreground hover:text-red-500 hover:bg-red-500/10\"\n                          }`}\n                          data-testid={`button-like-${post.id}`}\n                        >\n                          <motion.div\n                            animate={isPostLiked(post) ? { scale: [1, 1.2, 1] } : {}}\n                            transition={{ duration: 0.2 }}\n                          >\n                            <Heart className={`h-[18px] w-[18px] ${isPostLiked(post) ? \"fill-current\" : \"group-hover:text-red-500\"}`} />\n                          </motion.div>\n                          <span className=\"text-sm tabular-nums\">{formatEngagement(post.likesCount || 0)}</span>\n                        </Button>\n                      </motion.div>\n\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => bookmarkMutation.mutate(post.id)}\n                        disabled={bookmarkMutation.isPending}\n                        className={`h-8 px-2 gap-1 rounded-full group ${\n                          isPostBookmarked(post)\n                            ? \"text-primary\"\n                            : \"text-muted-foreground hover:text-primary hover:bg-primary/10\"\n                        }`}\n                        data-testid={`button-bookmark-${post.id}`}\n                      >\n                        <Bookmark className={`h-[18px] w-[18px] ${isPostBookmarked(post) ? \"fill-current\" : \"group-hover:text-primary\"}`} />\n                      </Button>\n\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleShare(post)}\n                        className=\"h-8 px-2 gap-1 rounded-full text-muted-foreground hover:text-primary hover:bg-primary/10 group\"\n                        data-testid={`button-share-${post.id}`}\n                      >\n                        <Share className=\"h-[18px] w-[18px] group-hover:text-primary\" />\n                      </Button>\n                    </div>\n\n                    <AnimatePresence>\n                      {expandedComments === post.id && (\n                        <motion.div\n                          initial={{ opacity: 0, height: 0 }}\n                          animate={{ opacity: 1, height: \"auto\" }}\n                          exit={{ opacity: 0, height: 0 }}\n                          transition={{ duration: 0.2 }}\n                          className=\"overflow-hidden\"\n                        >\n                          <Separator className=\"my-3\" />\n                          <div className=\"space-y-3\">\n                            {comments?.map((comment) => (\n                              <motion.div \n                                key={comment.id} \n                                className=\"flex gap-2\"\n                                initial={{ opacity: 0, x: -10 }}\n                                animate={{ opacity: 1, x: 0 }}\n                              >\n                                <Avatar className=\"h-8 w-8 flex-shrink-0\">\n                                  <AvatarImage src={comment.author?.profileImageUrl || undefined} />\n                                  <AvatarFallback className=\"text-[10px] bg-muted\">\n                                    {getInitials(comment.author?.firstName, comment.author?.lastName)}\n                                  </AvatarFallback>\n                                </Avatar>\n                                <div className=\"flex-1\">\n                                  <div className=\"bg-muted/50 rounded-2xl rounded-tl-md px-3 py-2\">\n                                    <div className=\"flex items-center gap-1\">\n                                      <span className=\"font-semibold text-xs\">\n                                        {comment.author?.firstName} {comment.author?.lastName}\n                                      </span>\n                                      {comment.author?.isVerified && <VerifiedBadge size=\"sm\" />}\n                                      <span className=\"text-muted-foreground text-xs\">·</span>\n                                      <span className=\"text-muted-foreground text-xs\">\n                                        {formatDistanceToNow(new Date(comment.createdAt), { addSuffix: false })}\n                                      </span>\n                                    </div>\n                                    <p className=\"text-sm text-foreground/90 mt-0.5\">{comment.content}</p>\n                                  </div>\n                                </div>\n                              </motion.div>\n                            ))}\n                            \n                            <div className=\"flex gap-2 items-center pt-1\">\n                              <Avatar className=\"h-8 w-8 flex-shrink-0\">\n                                <AvatarImage src={user?.profileImageUrl || undefined} />\n                                <AvatarFallback className=\"text-[10px] bg-primary/10 text-primary\">\n                                  {getInitials(user?.firstName, user?.lastName)}\n                                </AvatarFallback>\n                              </Avatar>\n                              <div className=\"flex-1 flex gap-2\">\n                                <Input\n                                  placeholder=\"Post your reply\"\n                                  value={commentText[post.id] || \"\"}\n                                  onChange={(e) => setCommentText((prev) => ({ ...prev, [post.id]: e.target.value }))}\n                                  onKeyDown={(e) => {\n                                    if (e.key === \"Enter\" && commentText[post.id]?.trim()) {\n                                      commentMutation.mutate({ postId: post.id, content: commentText[post.id] });\n                                    }\n                                  }}\n                                  className=\"h-9 text-sm rounded-full bg-muted/50 border-0 focus-visible:ring-1 focus-visible:ring-primary/30\"\n                                  data-testid={`input-comment-${post.id}`}\n                                />\n                                <Button\n                                  size=\"icon\"\n                                  onClick={() => {\n                                    if (commentText[post.id]?.trim()) {\n                                      commentMutation.mutate({ postId: post.id, content: commentText[post.id] });\n                                    }\n                                  }}\n                                  disabled={!commentText[post.id]?.trim() || commentMutation.isPending}\n                                  className=\"h-9 w-9 rounded-full flex-shrink-0\"\n                                  data-testid={`button-send-comment-${post.id}`}\n                                >\n                                  <Send className=\"h-4 w-4\" />\n                                </Button>\n                              </div>\n                            </div>\n                          </div>\n                        </motion.div>\n                      )}\n                    </AnimatePresence>\n                  </div>\n                </div>\n              </motion.article>\n                </>\n              );\n            })}\n          </motion.div>\n        ) : (\n          <motion.div\n            initial={{ opacity: 0, scale: 0.95 }}\n            animate={{ opacity: 1, scale: 1 }}\n            transition={{ duration: 0.3 }}\n            className=\"py-16 text-center\"\n          >\n            <motion.div\n              initial={{ scale: 0 }}\n              animate={{ scale: 1 }}\n              transition={{ delay: 0.2, type: \"spring\", stiffness: 200 }}\n              className=\"h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4\"\n            >\n              {activeTab === \"bookmarks\" ? (\n                <BookmarkCheck className=\"h-8 w-8 text-primary\" />\n              ) : (\n                <Zap className=\"h-8 w-8 text-primary\" />\n              )}\n            </motion.div>\n            <h3 className=\"text-lg font-semibold mb-2\">\n              {activeTab === \"bookmarks\" \n                ? \"No saved posts yet\" \n                : activeTab === \"following\" \n                  ? \"No posts from people you follow\" \n                  : \"No posts yet\"}\n            </h3>\n            <p className=\"text-sm text-muted-foreground max-w-xs mx-auto\">\n              {activeTab === \"bookmarks\"\n                ? \"Save posts by tapping the bookmark icon to view them here later\"\n                : activeTab === \"following\"\n                  ? \"Follow more people to see their posts here\"\n                  : \"Be the first to share what's happening on campus!\"}\n            </p>\n          </motion.div>\n        )}\n\n        <div className=\"h-24 md:h-8\" />\n      </div>\n\n      <motion.button\n        initial={{ scale: 0 }}\n        animate={{ scale: 1 }}\n        transition={{ delay: 0.5, type: \"spring\", stiffness: 200 }}\n        onClick={() => setShowMobileComposer(true)}\n        className=\"fixed bottom-24 right-4 md:hidden h-14 w-14 rounded-full bg-primary text-primary-foreground shadow-lg flex items-center justify-center z-50\"\n        data-testid=\"button-mobile-compose\"\n      >\n        <Plus className=\"h-6 w-6\" />\n      </motion.button>\n\n      <AnimatePresence>\n        {showMobileComposer && (\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            className=\"fixed inset-0 z-50 bg-background md:bg-black/50 md:flex md:items-start md:justify-center md:pt-12\"\n          >\n            <motion.div\n              initial={{ y: \"100%\", opacity: 0 }}\n              animate={{ y: 0, opacity: 1 }}\n              exit={{ y: \"100%\", opacity: 0 }}\n              transition={{ type: \"spring\", damping: 25, stiffness: 300 }}\n              className=\"h-full w-full md:h-auto md:max-h-[90vh] md:w-[600px] md:rounded-xl bg-background flex flex-col overflow-hidden\"\n            >\n              <div className=\"flex items-center justify-between px-4 py-3 border-b sticky top-0 bg-background z-10\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => setShowMobileComposer(false)}\n                  data-testid=\"button-close-composer\"\n                >\n                  <X className=\"h-5 w-5\" />\n                </Button>\n                <Button\n                  onClick={() => {\n                    handleCreatePost();\n                    setShowMobileComposer(false);\n                  }}\n                  disabled={createPostMutation.isPending || (!newPostContent.trim() && selectedMedia.length === 0)}\n                  className=\"rounded-full px-5 font-semibold\"\n                  data-testid=\"button-mobile-post\"\n                >\n                  {createPostMutation.isPending ? (\n                    <motion.div\n                      animate={{ rotate: 360 }}\n                      transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\n                    >\n                      <Send className=\"h-4 w-4\" />\n                    </motion.div>\n                  ) : (\n                    \"Post\"\n                  )}\n                </Button>\n              </div>\n              \n              <div className=\"flex-1 overflow-y-auto p-4\">\n                <div className=\"flex gap-3\">\n                  <Avatar className=\"h-10 w-10 ring-2 ring-background shadow-sm flex-shrink-0\">\n                    <AvatarImage src={user?.profileImageUrl || undefined} />\n                    <AvatarFallback className=\"bg-primary/10 text-primary font-medium\">\n                      {getInitials(user?.firstName, user?.lastName)}\n                    </AvatarFallback>\n                  </Avatar>\n                  <div className=\"flex-1\">\n                    <Textarea\n                      placeholder=\"What's happening on campus?\"\n                      value={newPostContent}\n                      onChange={(e) => setNewPostContent(e.target.value)}\n                      className=\"resize-none border-0 bg-transparent focus-visible:ring-0 text-lg min-h-[150px] placeholder:text-muted-foreground/60\"\n                      autoFocus\n                      data-testid=\"input-mobile-post\"\n                    />\n                    \n                    <AnimatePresence>\n                      {mediaPreviews.length > 0 && (\n                        <motion.div \n                          initial={{ opacity: 0, height: 0 }}\n                          animate={{ opacity: 1, height: \"auto\" }}\n                          exit={{ opacity: 0, height: 0 }}\n                          className=\"grid grid-cols-2 gap-2 mt-4\"\n                        >\n                          {mediaPreviews.map((preview, index) => (\n                            <motion.div \n                              key={index} \n                              className=\"relative group aspect-square\"\n                              initial={{ opacity: 0, scale: 0.8 }}\n                              animate={{ opacity: 1, scale: 1 }}\n                              exit={{ opacity: 0, scale: 0.8 }}\n                            >\n                              <div className=\"h-full w-full rounded-xl overflow-hidden ring-1 ring-border\">\n                                {preview.type === 'video' ? (\n                                  <div className=\"h-full w-full bg-muted flex items-center justify-center relative\">\n                                    <video src={preview.url} className=\"h-full w-full object-cover\" />\n                                    <div className=\"absolute inset-0 flex items-center justify-center bg-black/30\">\n                                      <Play className=\"h-8 w-8 text-white fill-white\" />\n                                    </div>\n                                  </div>\n                                ) : (\n                                  <img\n                                    src={preview.url}\n                                    alt={`Preview ${index + 1}`}\n                                    className=\"h-full w-full object-cover\"\n                                    loading=\"lazy\"\n                                  />\n                                )}\n                              </div>\n                              <Button\n                                type=\"button\"\n                                variant=\"destructive\"\n                                size=\"icon\"\n                                className=\"absolute -top-2 -right-2 h-6 w-6 rounded-full\"\n                                onClick={() => removeMedia(index)}\n                              >\n                                <X className=\"h-3.5 w-3.5\" />\n                              </Button>\n                            </motion.div>\n                          ))}\n                        </motion.div>\n                      )}\n                    </AnimatePresence>\n                  </div>\n                </div>\n              </div>\n              \n              <div className=\"border-t px-4 py-3 sticky bottom-0 bg-background\">\n                <div className=\"flex items-center gap-2\">\n                  <input\n                    type=\"file\"\n                    accept=\"image/*,video/*\"\n                    multiple\n                    className=\"hidden\"\n                    id=\"mobile-media-upload\"\n                    onChange={handleMediaUpload}\n                    data-testid=\"input-mobile-media\"\n                  />\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    className=\"rounded-full text-primary gap-2\"\n                    onClick={() => document.getElementById('mobile-media-upload')?.click()}\n                    data-testid=\"button-mobile-add-media\"\n                  >\n                    <ImageIcon className=\"h-5 w-5\" />\n                    <span className=\"text-sm font-medium\">Photo/Video</span>\n                  </Button>\n                  <span className=\"text-xs text-muted-foreground ml-auto\">\n                    {newPostContent.length > 0 && `${newPostContent.length} characters`}\n                  </span>\n                </div>\n              </div>\n            </motion.div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n\n      <Dialog open={shareDialogOpen} onOpenChange={setShareDialogOpen}>\n        <DialogContent className=\"sm:max-w-[400px]\">\n          <DialogHeader>\n            <DialogTitle>Share Post</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 pt-4\">\n            <Button\n              variant=\"outline\"\n              className=\"w-full justify-start gap-3 h-12\"\n              onClick={copyPostLink}\n            >\n              <div className=\"h-9 w-9 rounded-full bg-muted flex items-center justify-center\">\n                <Link2 className=\"h-5 w-5\" />\n              </div>\n              <div className=\"text-left\">\n                <div className=\"font-medium\">Copy link</div>\n                <div className=\"text-xs text-muted-foreground\">Copy post link to clipboard</div>\n              </div>\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":51580,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/pages/games.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { ScrollArea, ScrollBar } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { \n  Gamepad2, \n  Trophy, \n  Users, \n  Coins, \n  Dice1, \n  BookOpen, \n  HelpCircle, \n  Play, \n  X, \n  Clock, \n  Loader2,\n  Spade,\n  Pencil,\n  Keyboard,\n  Grid3X3,\n  Heart,\n  Tag,\n  User,\n  Bot,\n  Sparkles,\n  Medal,\n  Crown,\n  Target,\n  ArrowLeft,\n  Circle,\n  Plane,\n  Palette,\n  RotateCcw,\n  Dices,\n  Zap,\n  Grid2X2\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { Game, User as UserType, Wallet } from \"@shared/schema\";\nimport LudoGame from \"@/components/games/LudoGame\";\nimport WordBattleGame from \"@/components/games/WordBattleGame\";\nimport TriviaGame from \"@/components/games/TriviaGame\";\nimport SpeedTypingGame from \"@/components/games/SpeedTypingGame\";\nimport WhotGame from \"@/components/games/WhotGame\";\nimport TruthOrDareGame from \"@/components/games/TruthOrDareGame\";\nimport GuessThePriceGame from \"@/components/games/GuessThePriceGame\";\nimport CampusBingoGame from \"@/components/games/CampusBingoGame\";\nimport AyoOloponGame from \"@/components/games/AyoOloponGame\";\nimport AviatorGame from \"@/components/games/AviatorGame\";\nimport ColourColourGame from \"@/components/games/ColourColourGame\";\nimport SpinWheelGame from \"@/components/games/SpinWheelGame\";\nimport QuickDrawGame from \"@/components/games/QuickDrawGame\";\nimport DiceDuelGame from \"@/components/games/DiceDuelGame\";\nimport DraughtsGame from \"@/components/games/DraughtsGame\";\nimport ChessBlitzGame from \"@/components/games/ChessBlitzGame\";\n\ntype GameWithPlayer = Game & { player1: UserType };\n\ntype GameType = \"ludo\" | \"word_battle\" | \"trivia\" | \"whot\" | \"quick_draw\" | \"speed_typing\" | \"campus_bingo\" | \"truth_or_dare\" | \"guess_the_price\" | \"ayo_olopon\" | \"aviator\" | \"colour_colour\" | \"spin_wheel\" | \"dice_duel\" | \"draughts\" | \"chess_blitz\";\n\ntype GameMode = \"single_player\" | \"multiplayer\";\n\ntype SinglePlayerMode = \"practice\" | \"challenge\";\n\ninterface GameInfoType {\n  name: string;\n  description: string;\n  icon: React.ComponentType<{ className?: string }>;\n  color: string;\n  stakeAmounts: string[];\n  platformFee: number;\n  playerType: string;\n  supportsSinglePlayer: boolean;\n  supportsMultiplayer: boolean;\n}\n\nconst EXPANDED_STAKES = [\"100\", \"200\", \"500\", \"1000\", \"2000\", \"5000\", \"10000\", \"20000\", \"50000\", \"100000\"];\n\nconst GAME_INFO: Record<GameType, GameInfoType> = {\n  ludo: {\n    name: \"Ludo\",\n    description: \"Classic board game. First to get all tokens home wins!\",\n    icon: Dice1,\n    color: \"bg-red-500/10 text-red-600 dark:text-red-400\",\n    stakeAmounts: EXPANDED_STAKES,\n    platformFee: 5,\n    playerType: \"2-4 Players\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: true,\n  },\n  word_battle: {\n    name: \"Word Battle\",\n    description: \"Form words from letters. Highest score wins!\",\n    icon: BookOpen,\n    color: \"bg-blue-500/10 text-blue-600 dark:text-blue-400\",\n    stakeAmounts: EXPANDED_STAKES,\n    platformFee: 5,\n    playerType: \"2 Players\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: true,\n  },\n  trivia: {\n    name: \"Trivia\",\n    description: \"Answer questions correctly. Most correct answers wins!\",\n    icon: HelpCircle,\n    color: \"bg-purple-500/10 text-purple-600 dark:text-purple-400\",\n    stakeAmounts: EXPANDED_STAKES,\n    platformFee: 5,\n    playerType: \"2+ Players\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: true,\n  },\n  whot: {\n    name: \"Whot\",\n    description: \"Nigerian card game classic. Be the first to empty your hand!\",\n    icon: Spade,\n    color: \"bg-orange-500/10 text-orange-600 dark:text-orange-400\",\n    stakeAmounts: [\"100\", \"200\", \"500\", \"1000\", \"2000\", \"5000\"],\n    platformFee: 15,\n    playerType: \"2 Players\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: true,\n  },\n  quick_draw: {\n    name: \"Quick Draw\",\n    description: \"Test your reflexes! First to tap when DRAW appears wins.\",\n    icon: Zap,\n    color: \"bg-pink-500/10 text-pink-600 dark:text-pink-400\",\n    stakeAmounts: [\"100\", \"200\", \"500\", \"1000\", \"2000\", \"5000\", \"10000\"],\n    platformFee: 15,\n    playerType: \"vs AI\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: true,\n  },\n  speed_typing: {\n    name: \"Speed Typing\",\n    description: \"Type the fastest! Compete on the leaderboard for glory.\",\n    icon: Keyboard,\n    color: \"bg-cyan-500/10 text-cyan-600 dark:text-cyan-400\",\n    stakeAmounts: [\"100\", \"200\", \"500\", \"1000\"],\n    platformFee: 10,\n    playerType: \"Leaderboard\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: false,\n  },\n  campus_bingo: {\n    name: \"Campus Bingo\",\n    description: \"Nigerian campus life bingo! Mark phrases as they're called and shout BINGO!\",\n    icon: Grid3X3,\n    color: \"bg-green-500/10 text-green-600 dark:text-green-400\",\n    stakeAmounts: [\"100\", \"200\", \"500\", \"1000\", \"2000\", \"5000\"],\n    platformFee: 15,\n    playerType: \"vs AI\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: true,\n  },\n  truth_or_dare: {\n    name: \"Truth or Dare\",\n    description: \"The classic party game! Reveal truths or complete dares.\",\n    icon: Heart,\n    color: \"bg-rose-500/10 text-rose-600 dark:text-rose-400\",\n    stakeAmounts: [\"100\", \"200\", \"500\", \"1000\", \"2000\"],\n    platformFee: 10,\n    playerType: \"vs AI\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: true,\n  },\n  guess_the_price: {\n    name: \"Guess the Price\",\n    description: \"How well do you know prices? Closest guess wins!\",\n    icon: Tag,\n    color: \"bg-amber-500/10 text-amber-600 dark:text-amber-400\",\n    stakeAmounts: [\"100\", \"200\", \"500\", \"1000\", \"2000\", \"5000\", \"10000\"],\n    platformFee: 15,\n    playerType: \"Multiplayer Quiz\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: true,\n  },\n  ayo_olopon: {\n    name: \"Ayo Olopon\",\n    description: \"Classic Yoruba Mancala game. Capture the most seeds to win!\",\n    icon: Circle,\n    color: \"bg-amber-500/10 text-amber-600 dark:text-amber-400\",\n    stakeAmounts: [\"100\", \"200\", \"500\", \"1000\", \"2000\", \"5000\"],\n    platformFee: 10,\n    playerType: \"vs AI\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: false,\n  },\n  aviator: {\n    name: \"Aviator\",\n    description: \"Watch the plane fly! Cash out before it crashes to win big.\",\n    icon: Plane,\n    color: \"bg-sky-500/10 text-sky-600 dark:text-sky-400\",\n    stakeAmounts: EXPANDED_STAKES,\n    platformFee: 3,\n    playerType: \"Solo Betting\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: false,\n  },\n  colour_colour: {\n    name: \"Colour Colour\",\n    description: \"Bet on colours or numbers. Watch the wheel spin!\",\n    icon: Palette,\n    color: \"bg-violet-500/10 text-violet-600 dark:text-violet-400\",\n    stakeAmounts: EXPANDED_STAKES,\n    platformFee: 5,\n    playerType: \"Solo Betting\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: false,\n  },\n  spin_wheel: {\n    name: \"Spin The Wheel\",\n    description: \"Spin to win! Land on multipliers from 1x to 100x jackpot.\",\n    icon: RotateCcw,\n    color: \"bg-fuchsia-500/10 text-fuchsia-600 dark:text-fuchsia-400\",\n    stakeAmounts: EXPANDED_STAKES,\n    platformFee: 4,\n    playerType: \"Solo Betting\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: false,\n  },\n  dice_duel: {\n    name: \"Dice Duel\",\n    description: \"Roll 5 dice and form poker hands. Best hand wins!\",\n    icon: Dices,\n    color: \"bg-indigo-500/10 text-indigo-600 dark:text-indigo-400\",\n    stakeAmounts: [\"100\", \"200\", \"500\", \"1000\", \"2000\", \"5000\", \"10000\"],\n    platformFee: 10,\n    playerType: \"vs AI\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: true,\n  },\n  draughts: {\n    name: \"Draughts\",\n    description: \"Classic checkers! Capture all opponent pieces to win.\",\n    icon: Grid2X2,\n    color: \"bg-stone-500/10 text-stone-600 dark:text-stone-400\",\n    stakeAmounts: [\"100\", \"200\", \"500\", \"1000\", \"2000\", \"5000\"],\n    platformFee: 5,\n    playerType: \"vs AI\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: true,\n  },\n  chess_blitz: {\n    name: \"Chess Blitz\",\n    description: \"3-minute rapid chess against AI. Checkmate to win!\",\n    icon: Crown,\n    color: \"bg-emerald-500/10 text-emerald-600 dark:text-emerald-400\",\n    stakeAmounts: [\"200\", \"500\", \"1000\", \"2000\", \"5000\", \"10000\"],\n    platformFee: 5,\n    playerType: \"vs AI\",\n    supportsSinglePlayer: true,\n    supportsMultiplayer: true,\n  },\n};\n\nconst ALL_GAME_TYPES: GameType[] = [\"ludo\", \"word_battle\", \"trivia\", \"whot\", \"quick_draw\", \"speed_typing\", \"campus_bingo\", \"truth_or_dare\", \"guess_the_price\", \"ayo_olopon\", \"aviator\", \"colour_colour\", \"spin_wheel\", \"dice_duel\", \"draughts\", \"chess_blitz\"];\n\ninterface LeaderboardEntry {\n  rank: number;\n  username: string;\n  score: number;\n  gamesPlayed: number;\n  winRate: number;\n}\n\nconst MOCK_LEADERBOARD: LeaderboardEntry[] = [\n  { rank: 1, username: \"ChampionPlayer\", score: 15420, gamesPlayed: 89, winRate: 78 },\n  { rank: 2, username: \"GameMaster99\", score: 12850, gamesPlayed: 76, winRate: 72 },\n  { rank: 3, username: \"ProGamer_NG\", score: 11200, gamesPlayed: 65, winRate: 68 },\n  { rank: 4, username: \"CampusKing\", score: 9800, gamesPlayed: 54, winRate: 64 },\n  { rank: 5, username: \"QuickFingers\", score: 8540, gamesPlayed: 48, winRate: 61 },\n  { rank: 6, username: \"NaijaChamp\", score: 7200, gamesPlayed: 42, winRate: 58 },\n  { rank: 7, username: \"GameWizard\", score: 6150, gamesPlayed: 38, winRate: 55 },\n  { rank: 8, username: \"SkillMaster\", score: 5400, gamesPlayed: 35, winRate: 52 },\n  { rank: 9, username: \"LuckyPlayer\", score: 4800, gamesPlayed: 31, winRate: 49 },\n  { rank: 10, username: \"RisingStar\", score: 4200, gamesPlayed: 28, winRate: 46 },\n];\n\nexport default function GamesPage() {\n  const { toast } = useToast();\n  const [gameMode, setGameMode] = useState<GameMode>(\"multiplayer\");\n  const [singlePlayerMode, setSinglePlayerMode] = useState<SinglePlayerMode>(\"practice\");\n  const [selectedGameType, setSelectedGameType] = useState<GameType>(\"ludo\");\n  const currentGameInfo = GAME_INFO[selectedGameType];\n  const [selectedStake, setSelectedStake] = useState(currentGameInfo.stakeAmounts[0]);\n  const [createDialogOpen, setCreateDialogOpen] = useState(false);\n  const [practiceDialogOpen, setPracticeDialogOpen] = useState(false);\n  const [challengeDialogOpen, setChallengeDialogOpen] = useState(false);\n  const [currentPlayingGame, setCurrentPlayingGame] = useState<GameWithPlayer | null>(null);\n  const [gameInProgress, setGameInProgress] = useState(false);\n  const [singlePlayerGameInProgress, setSinglePlayerGameInProgress] = useState(false);\n  const [activeGame, setActiveGame] = useState<{ type: GameType; stake: number; isPractice: boolean } | null>(null);\n\n  const { data: wallet, isLoading: walletLoading } = useQuery<Wallet>({\n    queryKey: [\"/api/wallet\"],\n  });\n\n  const { data: availableGames, isLoading: gamesLoading } = useQuery<GameWithPlayer[]>({\n    queryKey: [\"/api/games\", selectedGameType],\n    refetchInterval: 5000,\n  });\n\n  const { data: gameHistory, isLoading: historyLoading } = useQuery<Game[]>({\n    queryKey: [\"/api/games/history\"],\n  });\n\n  const { data: user } = useQuery<UserType>({\n    queryKey: [\"/api/user\"],\n  });\n\n  const createGameMutation = useMutation({\n    mutationFn: async (data: { gameType: string; stakeAmount: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/games/create\", data);\n      return response.json();\n    },\n    onSuccess: (game) => {\n      toast({\n        title: \"Game Created\",\n        description: `Waiting for opponent to join. Stake: ${game.stakeAmount} NGN`,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/games\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n      setCreateDialogOpen(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to create game\",\n        description: error.message || \"Unable to create game lobby\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const joinGameMutation = useMutation({\n    mutationFn: async (gameId: string) => {\n      const response = await apiRequest(\"POST\", `/api/games/join/${gameId}`);\n      return response.json();\n    },\n    onSuccess: (game) => {\n      toast({\n        title: \"Joined Game\",\n        description: \"Game starting now!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/games\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n      setCurrentPlayingGame(game);\n      setGameInProgress(true);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to join game\",\n        description: error.message || \"Unable to join game\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const cancelGameMutation = useMutation({\n    mutationFn: async (gameId: string) => {\n      const response = await apiRequest(\"POST\", `/api/games/${gameId}/cancel`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Game Cancelled\",\n        description: \"Your stake has been refunded\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/games\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to cancel game\",\n        description: error.message || \"Unable to cancel game\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const completeGameMutation = useMutation({\n    mutationFn: async ({ gameId, winnerId }: { gameId: string; winnerId: string }) => {\n      const response = await apiRequest(\"POST\", `/api/games/${gameId}/complete`, { winnerId });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      if (data.game.winnerId === user?.id) {\n        toast({\n          title: \"You Won!\",\n          description: `You earned ${data.winnings.toFixed(2)} NGN`,\n        });\n      } else {\n        toast({\n          title: \"Game Over\",\n          description: \"Better luck next time!\",\n        });\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/games\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/games/history\"] });\n      setGameInProgress(false);\n      setCurrentPlayingGame(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to complete game\",\n        description: error.message || \"Unable to complete game\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleCreateGame = () => {\n    const stakeNum = parseFloat(selectedStake);\n    const walletBalance = parseFloat(wallet?.balance || \"0\");\n\n    if (walletBalance < stakeNum) {\n      toast({\n        title: \"Insufficient Balance\",\n        description: `You need ${selectedStake} NGN but have ${wallet?.balance || 0} NGN`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    createGameMutation.mutate({\n      gameType: selectedGameType,\n      stakeAmount: selectedStake,\n    });\n  };\n\n  const handleGameTypeChange = (gameType: GameType) => {\n    setSelectedGameType(gameType);\n    setSelectedStake(GAME_INFO[gameType].stakeAmounts[0]);\n  };\n\n  const handleJoinGame = (game: GameWithPlayer) => {\n    const stakeNum = parseFloat(game.stakeAmount);\n    const walletBalance = parseFloat(wallet?.balance || \"0\");\n\n    if (walletBalance < stakeNum) {\n      toast({\n        title: \"Insufficient Balance\",\n        description: `You need ${game.stakeAmount} NGN but have ${wallet?.balance || 0} NGN`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    joinGameMutation.mutate(game.id);\n  };\n\n  const handleStartPractice = () => {\n    setPracticeDialogOpen(false);\n    setActiveGame({\n      type: selectedGameType,\n      stake: 0,\n      isPractice: true,\n    });\n  };\n\n  const handleStartChallenge = () => {\n    const stakeNum = parseFloat(selectedStake);\n    const walletBalance = parseFloat(wallet?.balance || \"0\");\n\n    if (walletBalance < stakeNum) {\n      toast({\n        title: \"Insufficient Balance\",\n        description: `You need ${selectedStake} NGN but have ${wallet?.balance || 0} NGN`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setChallengeDialogOpen(false);\n    setActiveGame({\n      type: selectedGameType,\n      stake: stakeNum,\n      isPractice: false,\n    });\n  };\n\n  const handleGameEnd = (won: boolean, score?: number) => {\n    const stakeNum = activeGame?.stake || 0;\n    const isPractice = activeGame?.isPractice || true;\n    const gameInfo = activeGame ? GAME_INFO[activeGame.type] : currentGameInfo;\n    const winMultiplier = (100 - gameInfo.platformFee) / 100;\n    \n    setActiveGame(null);\n    \n    if (isPractice) {\n      toast({\n        title: won ? \"Practice Complete - You Won!\" : \"Practice Complete\",\n        description: won \n          ? `Great job! You beat the AI${score ? ` with a score of ${score}` : \"\"}. No stakes in practice mode.`\n          : \"Keep practicing! The AI won this round.\",\n      });\n    } else {\n      if (won) {\n        const winnings = stakeNum * 2 * winMultiplier;\n        toast({\n          title: \"Challenge Won!\",\n          description: `You beat the AI and earned ${winnings.toLocaleString()} NGN!`,\n        });\n      } else {\n        toast({\n          title: \"Challenge Lost\",\n          description: `The AI won this round. You lost ${stakeNum.toLocaleString()} NGN.`,\n          variant: \"destructive\",\n        });\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/games/history\"] });\n    }\n  };\n\n  const renderActiveGame = () => {\n    if (!activeGame) return null;\n    \n    const commonProps = {\n      stake: activeGame.stake,\n      onGameEnd: handleGameEnd,\n      isPractice: activeGame.isPractice,\n    };\n    \n    switch (activeGame.type) {\n      case \"ludo\":\n        return <LudoGame {...commonProps} />;\n      case \"word_battle\":\n        return <WordBattleGame {...commonProps} />;\n      case \"trivia\":\n        return <TriviaGame {...commonProps} />;\n      case \"speed_typing\":\n        return <SpeedTypingGame {...commonProps} />;\n      case \"whot\":\n        return <WhotGame {...commonProps} />;\n      case \"truth_or_dare\":\n        return <TruthOrDareGame {...commonProps} />;\n      case \"guess_the_price\":\n        return <GuessThePriceGame {...commonProps} />;\n      case \"campus_bingo\":\n        return <CampusBingoGame {...commonProps} />;\n      case \"ayo_olopon\":\n        return <AyoOloponGame {...commonProps} />;\n      case \"aviator\":\n        return <AviatorGame {...commonProps} />;\n      case \"colour_colour\":\n        return <ColourColourGame {...commonProps} />;\n      case \"spin_wheel\":\n        return <SpinWheelGame {...commonProps} />;\n      case \"quick_draw\":\n        return <QuickDrawGame {...commonProps} />;\n      case \"dice_duel\":\n        return <DiceDuelGame {...commonProps} />;\n      case \"draughts\":\n        return <DraughtsGame {...commonProps} />;\n      case \"chess_blitz\":\n        return <ChessBlitzGame {...commonProps} />;\n      default:\n        return (\n          <Card className=\"p-8 text-center\">\n            <CardContent>\n              <p className=\"text-muted-foreground mb-4\">\n                {GAME_INFO[activeGame.type].name} is coming soon!\n              </p>\n              <Button onClick={() => setActiveGame(null)}>\n                <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                Back to Games\n              </Button>\n            </CardContent>\n          </Card>\n        );\n    }\n  };\n\n  const handleModeChange = (mode: GameMode) => {\n    setGameMode(mode);\n    const currentGame = GAME_INFO[selectedGameType];\n    if (mode === \"single_player\" && !currentGame.supportsSinglePlayer) {\n      const singlePlayerGame = ALL_GAME_TYPES.find(g => GAME_INFO[g].supportsSinglePlayer);\n      if (singlePlayerGame) {\n        setSelectedGameType(singlePlayerGame);\n        setSelectedStake(GAME_INFO[singlePlayerGame].stakeAmounts[0]);\n      }\n    } else if (mode === \"multiplayer\" && !currentGame.supportsMultiplayer) {\n      const multiplayerGame = ALL_GAME_TYPES.find(g => GAME_INFO[g].supportsMultiplayer);\n      if (multiplayerGame) {\n        setSelectedGameType(multiplayerGame);\n        setSelectedStake(GAME_INFO[multiplayerGame].stakeAmounts[0]);\n      }\n    }\n  };\n\n  const filteredGameTypes = ALL_GAME_TYPES.filter(gameType => {\n    const info = GAME_INFO[gameType];\n    return gameMode === \"single_player\" ? info.supportsSinglePlayer : info.supportsMultiplayer;\n  });\n\n  const filteredGames = availableGames?.filter(g => g.gameType === selectedGameType) || [];\n  const userWaitingGames = filteredGames.filter(g => g.player1Id === user?.id);\n  const otherGames = filteredGames.filter(g => g.player1Id !== user?.id);\n\n  const GameIcon = currentGameInfo.icon;\n  const winMultiplier = (100 - currentGameInfo.platformFee) / 100;\n\n  const getRankIcon = (rank: number) => {\n    switch (rank) {\n      case 1:\n        return <Crown className=\"h-4 w-4 text-yellow-500\" />;\n      case 2:\n        return <Medal className=\"h-4 w-4 text-gray-400\" />;\n      case 3:\n        return <Medal className=\"h-4 w-4 text-amber-600\" />;\n      default:\n        return <span className=\"text-xs font-medium text-muted-foreground\">#{rank}</span>;\n    }\n  };\n\n  if (activeGame) {\n    return (\n      <div className=\"container max-w-4xl mx-auto p-4 pb-20\">\n        <div className=\"mb-4 flex items-center justify-between gap-4\">\n          <Button variant=\"ghost\" onClick={() => setActiveGame(null)} data-testid=\"button-back-to-games\">\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Back to Games\n          </Button>\n          <div className=\"flex items-center gap-2\">\n            {!activeGame.isPractice && (\n              <Badge variant=\"secondary\" className=\"text-sm\">\n                <Coins className=\"h-3 w-3 mr-1\" />\n                Stake: {activeGame.stake.toLocaleString()} NGN\n              </Badge>\n            )}\n            <Badge variant={activeGame.isPractice ? \"outline\" : \"default\"} className=\"text-sm\">\n              {activeGame.isPractice ? \"Practice Mode\" : \"Challenge Mode\"}\n            </Badge>\n          </div>\n        </div>\n        {renderActiveGame()}\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container max-w-4xl mx-auto p-4 pb-20 space-y-6\">\n      <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"p-3 rounded-md bg-primary/10\">\n            <Gamepad2 className=\"h-6 w-6 text-primary\" />\n          </div>\n          <div>\n            <h1 className=\"text-2xl font-bold\">Games</h1>\n            <p className=\"text-muted-foreground text-sm\">Play and win with other students</p>\n          </div>\n        </div>\n\n        <Card className=\"w-full sm:w-auto\">\n          <CardContent className=\"p-3 flex items-center gap-3\">\n            <Coins className=\"h-5 w-5 text-yellow-500\" />\n            <div>\n              <p className=\"text-xs text-muted-foreground\">Balance</p>\n              {walletLoading ? (\n                <Skeleton className=\"h-5 w-16\" />\n              ) : (\n                <p className=\"font-bold\" data-testid=\"text-wallet-balance\">{parseFloat(wallet?.balance || \"0\").toLocaleString()} NGN</p>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs value={gameMode} onValueChange={(v) => handleModeChange(v as GameMode)} className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-2\">\n          <TabsTrigger value=\"single_player\" className=\"flex items-center gap-2\" data-testid=\"tab-single-player\">\n            <User className=\"h-4 w-4\" />\n            Single Player\n          </TabsTrigger>\n          <TabsTrigger value=\"multiplayer\" className=\"flex items-center gap-2\" data-testid=\"tab-multiplayer\">\n            <Users className=\"h-4 w-4\" />\n            Multiplayer\n          </TabsTrigger>\n        </TabsList>\n      </Tabs>\n\n      {gameMode === \"single_player\" && (\n        <div className=\"flex gap-2\">\n          <Button\n            variant={singlePlayerMode === \"practice\" ? \"default\" : \"outline\"}\n            onClick={() => setSinglePlayerMode(\"practice\")}\n            className=\"flex-1\"\n            data-testid=\"button-practice-mode\"\n          >\n            <Sparkles className=\"h-4 w-4 mr-2\" />\n            Practice Mode\n            <Badge variant=\"secondary\" className=\"ml-2 text-[10px]\">Free</Badge>\n          </Button>\n          <Button\n            variant={singlePlayerMode === \"challenge\" ? \"default\" : \"outline\"}\n            onClick={() => setSinglePlayerMode(\"challenge\")}\n            className=\"flex-1\"\n            data-testid=\"button-challenge-mode\"\n          >\n            <Target className=\"h-4 w-4 mr-2\" />\n            Challenge AI\n            <Badge variant=\"secondary\" className=\"ml-2 text-[10px]\">Stakes</Badge>\n          </Button>\n        </div>\n      )}\n\n      <div className=\"space-y-4\">\n        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n          <h3 className=\"text-sm font-medium text-muted-foreground\">Select Game</h3>\n          <div className=\"flex items-center gap-2 flex-wrap\">\n            {gameMode === \"single_player\" && (\n              <Badge variant=\"outline\" className=\"text-xs\">\n                <Bot className=\"h-3 w-3 mr-1\" />\n                vs AI\n              </Badge>\n            )}\n            {gameMode === \"multiplayer\" && (\n              <Badge variant=\"outline\" className=\"text-xs\">\n                <Users className=\"h-3 w-3 mr-1\" />\n                vs Players\n              </Badge>\n            )}\n          </div>\n        </div>\n        <ScrollArea className=\"w-full whitespace-nowrap\">\n          <div className=\"flex gap-3 pb-4\">\n            {filteredGameTypes.map((gameType) => {\n              const info = GAME_INFO[gameType];\n              const Icon = info.icon;\n              const isSelected = selectedGameType === gameType;\n              return (\n                <button\n                  key={gameType}\n                  onClick={() => handleGameTypeChange(gameType)}\n                  className={`flex flex-col items-center gap-2 p-4 rounded-md min-w-[100px] transition-all ${\n                    isSelected \n                      ? `${info.color} ring-2 ring-offset-2 ring-offset-background ring-current` \n                      : 'bg-muted/50 hover-elevate'\n                  }`}\n                  data-testid={`tab-${gameType}`}\n                >\n                  <div className={`p-2 rounded-md ${info.color}`}>\n                    <Icon className=\"h-5 w-5\" />\n                  </div>\n                  <span className=\"text-xs font-medium text-center whitespace-normal leading-tight\">\n                    {info.name}\n                  </span>\n                  <div className=\"flex gap-1 flex-wrap justify-center\">\n                    {info.supportsSinglePlayer && info.supportsMultiplayer ? (\n                      <Badge variant=\"secondary\" className=\"text-[10px]\">Both</Badge>\n                    ) : info.supportsSinglePlayer ? (\n                      <Badge variant=\"secondary\" className=\"text-[10px]\">Single</Badge>\n                    ) : (\n                      <Badge variant=\"secondary\" className=\"text-[10px]\">Multi</Badge>\n                    )}\n                  </div>\n                </button>\n              );\n            })}\n          </div>\n          <ScrollBar orientation=\"horizontal\" />\n        </ScrollArea>\n      </div>\n\n      <div className=\"space-y-6\">\n        <Card className={`${currentGameInfo.color} ${gameMode === \"single_player\" ? \"border-2 border-dashed\" : \"\"}`}>\n          <CardHeader className=\"pb-2\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <CardTitle className=\"flex items-center gap-2\">\n                <GameIcon className=\"h-5 w-5\" />\n                {currentGameInfo.name}\n              </CardTitle>\n              <div className=\"flex items-center gap-2 flex-wrap\">\n                {gameMode === \"single_player\" ? (\n                  <>\n                    <Badge variant=\"outline\" className=\"text-xs\">\n                      <Bot className=\"h-3 w-3 mr-1\" />\n                      AI Opponent\n                    </Badge>\n                    {singlePlayerMode === \"practice\" ? (\n                      <Badge className=\"text-xs bg-green-500/20 text-green-600 dark:text-green-400\">\n                        <Sparkles className=\"h-3 w-3 mr-1\" />\n                        Practice\n                      </Badge>\n                    ) : (\n                      <Badge className=\"text-xs bg-orange-500/20 text-orange-600 dark:text-orange-400\">\n                        <Target className=\"h-3 w-3 mr-1\" />\n                        Challenge\n                      </Badge>\n                    )}\n                  </>\n                ) : (\n                  <>\n                    <Badge variant=\"outline\" className=\"text-xs\">\n                      <Users className=\"h-3 w-3 mr-1\" />\n                      {currentGameInfo.playerType}\n                    </Badge>\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      {currentGameInfo.platformFee}% Fee\n                    </Badge>\n                  </>\n                )}\n              </div>\n            </div>\n            <CardDescription className=\"text-inherit opacity-80\">\n              {currentGameInfo.description}\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"flex items-center gap-3 flex-wrap\">\n            {gameMode === \"single_player\" ? (\n              singlePlayerMode === \"practice\" ? (\n                <Dialog open={practiceDialogOpen} onOpenChange={setPracticeDialogOpen}>\n                  <DialogTrigger asChild>\n                    <Button data-testid=\"button-start-practice\">\n                      <Sparkles className=\"h-4 w-4 mr-2\" />\n                      Start Practice\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent>\n                    <DialogHeader>\n                      <DialogTitle className=\"flex items-center gap-2\">\n                        <Sparkles className=\"h-5 w-5 text-green-500\" />\n                        Practice Mode - {currentGameInfo.name}\n                      </DialogTitle>\n                      <DialogDescription>\n                        Play against AI for free. No stakes, no pressure - just practice and improve your skills!\n                      </DialogDescription>\n                    </DialogHeader>\n                    <div className=\"py-4 space-y-4\">\n                      <div className=\"flex items-center gap-3 p-3 rounded-md bg-green-500/10\">\n                        <Bot className=\"h-8 w-8 text-green-500\" />\n                        <div>\n                          <p className=\"font-medium\">AI Opponent</p>\n                          <p className=\"text-sm text-muted-foreground\">Adaptive difficulty based on your skill</p>\n                        </div>\n                      </div>\n                      <div className=\"text-sm text-muted-foreground\">\n                        <p>Practice mode benefits:</p>\n                        <ul className=\"list-disc list-inside mt-2 space-y-1\">\n                          <li>No stake required</li>\n                          <li>Learn game mechanics</li>\n                          <li>Build your strategy</li>\n                          <li>Track your progress</li>\n                        </ul>\n                      </div>\n                    </div>\n                    <DialogFooter>\n                      <Button onClick={handleStartPractice} data-testid=\"button-confirm-practice\">\n                        <Play className=\"h-4 w-4 mr-2\" />\n                        Start Practice Game\n                      </Button>\n                    </DialogFooter>\n                  </DialogContent>\n                </Dialog>\n              ) : (\n                <Dialog open={challengeDialogOpen} onOpenChange={setChallengeDialogOpen}>\n                  <DialogTrigger asChild>\n                    <Button data-testid=\"button-start-challenge\">\n                      <Target className=\"h-4 w-4 mr-2\" />\n                      Challenge AI\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent>\n                    <DialogHeader>\n                      <DialogTitle className=\"flex items-center gap-2\">\n                        <Target className=\"h-5 w-5 text-orange-500\" />\n                        Challenge Mode - {currentGameInfo.name}\n                      </DialogTitle>\n                      <DialogDescription>\n                        Play against AI for real stakes. Win and earn {100 - currentGameInfo.platformFee}% of the pot!\n                      </DialogDescription>\n                    </DialogHeader>\n                    <div className=\"space-y-4 py-4\">\n                      <div className=\"flex items-center gap-3 p-3 rounded-md bg-orange-500/10\">\n                        <Bot className=\"h-8 w-8 text-orange-500\" />\n                        <div>\n                          <p className=\"font-medium\">AI Challenger</p>\n                          <p className=\"text-sm text-muted-foreground\">Compete for real stakes</p>\n                        </div>\n                      </div>\n                      <div className=\"space-y-2\">\n                        <label className=\"text-sm font-medium\">Stake Amount (NGN)</label>\n                        <Select value={selectedStake} onValueChange={setSelectedStake}>\n                          <SelectTrigger data-testid=\"select-challenge-stake\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {currentGameInfo.stakeAmounts.map((amount) => (\n                              <SelectItem key={amount} value={amount}>\n                                {parseInt(amount).toLocaleString()} NGN\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"flex justify-between gap-4 text-sm\">\n                        <span className=\"text-muted-foreground\">Potential Win:</span>\n                        <span className=\"font-bold text-green-600\">\n                          {(parseFloat(selectedStake) * 2 * winMultiplier).toLocaleString()} NGN\n                        </span>\n                      </div>\n                      <div className=\"flex justify-between gap-4 text-sm\">\n                        <span className=\"text-muted-foreground\">Platform Fee:</span>\n                        <span>{currentGameInfo.platformFee}%</span>\n                      </div>\n                    </div>\n                    <DialogFooter>\n                      <Button \n                        onClick={handleStartChallenge}\n                        data-testid=\"button-confirm-challenge\"\n                      >\n                        <Coins className=\"h-4 w-4 mr-2\" />\n                        Stake {parseInt(selectedStake).toLocaleString()} NGN\n                      </Button>\n                    </DialogFooter>\n                  </DialogContent>\n                </Dialog>\n              )\n            ) : (\n              <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-create-game\">\n                    <Play className=\"h-4 w-4 mr-2\" />\n                    Create Game\n                  </Button>\n                </DialogTrigger>\n                <DialogContent>\n                  <DialogHeader>\n                    <DialogTitle>Create {currentGameInfo.name} Game</DialogTitle>\n                    <DialogDescription>\n                      Select your stake amount. Winner takes {100 - currentGameInfo.platformFee}% of the total pot.\n                    </DialogDescription>\n                  </DialogHeader>\n                  <div className=\"space-y-4 py-4\">\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Stake Amount (NGN)</label>\n                      <Select value={selectedStake} onValueChange={setSelectedStake}>\n                        <SelectTrigger data-testid=\"select-stake\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {currentGameInfo.stakeAmounts.map((amount) => (\n                            <SelectItem key={amount} value={amount}>\n                              {parseInt(amount).toLocaleString()} NGN\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"flex justify-between gap-4 text-sm\">\n                      <span className=\"text-muted-foreground\">Potential Win:</span>\n                      <span className=\"font-bold text-green-600\">\n                        {(parseFloat(selectedStake) * 2 * winMultiplier).toLocaleString()} NGN\n                      </span>\n                    </div>\n                    <div className=\"flex justify-between gap-4 text-sm\">\n                      <span className=\"text-muted-foreground\">Platform Fee:</span>\n                      <span>{currentGameInfo.platformFee}%</span>\n                    </div>\n                  </div>\n                  <DialogFooter>\n                    <Button \n                      onClick={handleCreateGame} \n                      disabled={createGameMutation.isPending}\n                      data-testid=\"button-confirm-create\"\n                    >\n                      {createGameMutation.isPending ? (\n                        <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      ) : (\n                        <Coins className=\"h-4 w-4 mr-2\" />\n                      )}\n                      Stake {parseInt(selectedStake).toLocaleString()} NGN\n                    </Button>\n                  </DialogFooter>\n                </DialogContent>\n              </Dialog>\n            )}\n            <span className=\"text-sm text-muted-foreground\">\n              {gameMode === \"single_player\" && singlePlayerMode === \"practice\" \n                ? \"Free to play - no stakes\" \n                : `Stakes: ${currentGameInfo.stakeAmounts.slice(0, 5).map(s => `${parseInt(s).toLocaleString()}`).join(', ')}${currentGameInfo.stakeAmounts.length > 5 ? '...' : ''} NGN`\n              }\n            </span>\n          </CardContent>\n        </Card>\n\n        {gameMode === \"single_player\" && (\n          <div className=\"space-y-3\">\n            <h3 className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n              <Trophy className=\"h-4 w-4\" />\n              {currentGameInfo.name} Leaderboard\n            </h3>\n            <Card>\n              <CardContent className=\"p-0\">\n                <div className=\"divide-y\">\n                  {MOCK_LEADERBOARD.slice(0, 5).map((entry) => (\n                    <div \n                      key={entry.rank} \n                      className={`flex items-center justify-between gap-4 p-3 ${\n                        entry.rank <= 3 ? 'bg-yellow-500/5' : ''\n                      }`}\n                      data-testid={`leaderboard-entry-${entry.rank}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-8 h-8 flex items-center justify-center\">\n                          {getRankIcon(entry.rank)}\n                        </div>\n                        <div>\n                          <p className=\"font-medium text-sm\">{entry.username}</p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {entry.gamesPlayed} games | {entry.winRate}% win rate\n                          </p>\n                        </div>\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"font-bold text-sm\">{entry.score.toLocaleString()}</p>\n                        <p className=\"text-xs text-muted-foreground\">points</p>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n            <Button variant=\"outline\" size=\"sm\" className=\"w-full\" data-testid=\"button-view-full-leaderboard\">\n              View Full Leaderboard\n            </Button>\n          </div>\n        )}\n\n        {gameMode === \"multiplayer\" && userWaitingGames.length > 0 && (\n          <div className=\"space-y-3\">\n            <h3 className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n              <Clock className=\"h-4 w-4\" />\n              Your Waiting Games\n            </h3>\n            {userWaitingGames.map((game) => (\n              <Card key={game.id} className=\"border-dashed\">\n                <CardContent className=\"p-4 flex items-center justify-between gap-4\">\n                  <div className=\"flex items-center gap-3\">\n                    <Avatar className=\"h-10 w-10\">\n                      <AvatarImage src={game.player1.profileImageUrl || undefined} />\n                      <AvatarFallback>\n                        {game.player1.firstName?.[0] || \"?\"}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div>\n                      <p className=\"font-medium\">Waiting for opponent...</p>\n                      <div className=\"flex items-center gap-2\">\n                        <Badge variant=\"secondary\" className=\"text-xs\">\n                          {parseInt(game.stakeAmount).toLocaleString()} NGN\n                        </Badge>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          <Users className=\"h-3 w-3 mr-1\" />\n                          Multi\n                        </Badge>\n                        <span className=\"text-xs text-muted-foreground\">\n                          {format(new Date(game.createdAt || new Date()), \"MMM d, h:mm a\")}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                  <AlertDialog>\n                    <AlertDialogTrigger asChild>\n                      <Button variant=\"ghost\" size=\"icon\" data-testid={`button-cancel-game-${game.id}`}>\n                        <X className=\"h-4 w-4\" />\n                      </Button>\n                    </AlertDialogTrigger>\n                    <AlertDialogContent>\n                      <AlertDialogHeader>\n                        <AlertDialogTitle>Cancel Game?</AlertDialogTitle>\n                        <AlertDialogDescription>\n                          Your stake of {parseInt(game.stakeAmount).toLocaleString()} NGN will be refunded to your wallet.\n                        </AlertDialogDescription>\n                      </AlertDialogHeader>\n                      <AlertDialogFooter>\n                        <AlertDialogCancel>Keep Waiting</AlertDialogCancel>\n                        <AlertDialogAction\n                          onClick={() => cancelGameMutation.mutate(game.id)}\n                          disabled={cancelGameMutation.isPending}\n                        >\n                          Cancel Game\n                        </AlertDialogAction>\n                      </AlertDialogFooter>\n                    </AlertDialogContent>\n                  </AlertDialog>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n\n        {gameMode === \"multiplayer\" && (\n          <div className=\"space-y-3\">\n            <h3 className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n              <Users className=\"h-4 w-4\" />\n              Available Lobbies\n            </h3>\n            \n            {gamesLoading ? (\n              <div className=\"space-y-3\">\n                {[1, 2, 3].map((i) => (\n                  <Card key={i}>\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <Skeleton className=\"h-10 w-10 rounded-full\" />\n                        <div className=\"space-y-2 flex-1\">\n                          <Skeleton className=\"h-4 w-32\" />\n                          <Skeleton className=\"h-3 w-24\" />\n                        </div>\n                        <Skeleton className=\"h-9 w-20\" />\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            ) : otherGames.length === 0 ? (\n              <Card>\n                <CardContent className=\"p-8 text-center\">\n                  <GameIcon className=\"h-12 w-12 mx-auto text-muted-foreground/50 mb-3\" />\n                  <p className=\"text-muted-foreground\">No games available</p>\n                  <p className=\"text-sm text-muted-foreground mt-1\">\n                    Be the first to create a {currentGameInfo.name} game!\n                  </p>\n                </CardContent>\n              </Card>\n            ) : (\n              <div className=\"space-y-3\">\n                {otherGames.map((game) => (\n                  <Card key={game.id} data-testid={`card-game-${game.id}`}>\n                    <CardContent className=\"p-4 flex items-center justify-between gap-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <Avatar className=\"h-10 w-10\">\n                          <AvatarImage src={game.player1.profileImageUrl || undefined} />\n                          <AvatarFallback>\n                            {game.player1.firstName?.[0] || \"?\"}\n                          </AvatarFallback>\n                        </Avatar>\n                        <div>\n                          <p className=\"font-medium\">\n                            {game.player1.firstName} {game.player1.lastName?.[0]}.\n                          </p>\n                          <div className=\"flex items-center gap-2 flex-wrap\">\n                            <Badge variant=\"secondary\" className=\"text-xs\">\n                              <Coins className=\"h-3 w-3 mr-1\" />\n                              {parseInt(game.stakeAmount).toLocaleString()} NGN\n                            </Badge>\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              <Users className=\"h-3 w-3 mr-1\" />\n                              Multi\n                            </Badge>\n                            <span className=\"text-xs text-green-600 font-medium\">\n                              Win: {(parseFloat(game.stakeAmount) * 2 * winMultiplier).toLocaleString()} NGN\n                            </span>\n                          </div>\n                        </div>\n                      </div>\n                      <Button\n                        onClick={() => handleJoinGame(game)}\n                        disabled={joinGameMutation.isPending}\n                        data-testid={`button-join-game-${game.id}`}\n                      >\n                        {joinGameMutation.isPending ? (\n                          <Loader2 className=\"h-4 w-4 animate-spin\" />\n                        ) : (\n                          \"Join\"\n                        )}\n                      </Button>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            )}\n          </div>\n        )}\n\n        <div className=\"space-y-3\">\n          <h3 className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n            <Trophy className=\"h-4 w-4\" />\n            Recent Games\n          </h3>\n          \n          {historyLoading ? (\n            <div className=\"space-y-2\">\n              {[1, 2].map((i) => (\n                <Skeleton key={i} className=\"h-16 w-full\" />\n              ))}\n            </div>\n          ) : !gameHistory?.length ? (\n            <Card>\n              <CardContent className=\"p-4 text-center text-muted-foreground\">\n                No games played yet\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"space-y-2\">\n              {gameHistory.slice(0, 5).map((game) => (\n                <Card key={game.id} data-testid={`card-history-${game.id}`}>\n                  <CardContent className=\"p-3 flex items-center justify-between gap-4\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className={`p-2 rounded-md ${GAME_INFO[game.gameType as keyof typeof GAME_INFO]?.color || \"bg-muted\"}`}>\n                        {(() => {\n                          const Icon = GAME_INFO[game.gameType as keyof typeof GAME_INFO]?.icon || Gamepad2;\n                          return <Icon className=\"h-4 w-4\" />;\n                        })()}\n                      </div>\n                      <div>\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          <span className=\"font-medium capitalize\">\n                            {game.gameType.replace(/_/g, \" \")}\n                          </span>\n                          <Badge \n                            variant={game.status === \"completed\" ? \"secondary\" : \"outline\"}\n                            className=\"text-xs\"\n                          >\n                            {game.status}\n                          </Badge>\n                        </div>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {game.createdAt && format(new Date(game.createdAt), \"MMM d, h:mm a\")}\n                        </p>\n                      </div>\n                    </div>\n                    <div className=\"text-right\">\n                      {game.status === \"completed\" && (\n                        <Badge \n                          variant={game.winnerId === user?.id ? \"default\" : \"outline\"}\n                          className={game.winnerId === user?.id ? \"bg-green-500\" : \"\"}\n                        >\n                          {game.winnerId === user?.id ? (\n                            <>\n                              <Trophy className=\"h-3 w-3 mr-1\" />\n                              Won\n                            </>\n                          ) : (\n                            \"Lost\"\n                          )}\n                        </Badge>\n                      )}\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        {parseInt(game.stakeAmount).toLocaleString()} NGN\n                      </p>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </div>\n      </div>\n\n      <Dialog open={gameInProgress} onOpenChange={setGameInProgress}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <GameIcon className=\"h-5 w-5\" />\n              {currentGameInfo.name} in Progress\n            </DialogTitle>\n            <DialogDescription>\n              Game simulation running...\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-8 flex flex-col items-center gap-4\">\n            <div className=\"relative\">\n              <div className=\"h-24 w-24 rounded-full border-4 border-primary/20 flex items-center justify-center\">\n                <Loader2 className=\"h-12 w-12 text-primary animate-spin\" />\n              </div>\n            </div>\n            <p className=\"text-center text-muted-foreground\">\n              Playing against opponent...<br />\n              <span className=\"text-sm\">Winner will be determined shortly</span>\n            </p>\n            {currentPlayingGame && (\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  const winnerId = Math.random() > 0.5 ? user?.id : currentPlayingGame.player1.id;\n                  if (winnerId) {\n                    completeGameMutation.mutate({ gameId: currentPlayingGame.id, winnerId });\n                  }\n                }}\n                disabled={completeGameMutation.isPending}\n              >\n                {completeGameMutation.isPending ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : null}\n                Simulate Result\n              </Button>\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={singlePlayerGameInProgress} onOpenChange={setSinglePlayerGameInProgress}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Bot className=\"h-5 w-5\" />\n              {singlePlayerMode === \"practice\" ? \"Practice\" : \"Challenge\"} - {currentGameInfo.name}\n            </DialogTitle>\n            <DialogDescription>\n              {singlePlayerMode === \"practice\" \n                ? \"Practice game in progress...\" \n                : \"Challenge game in progress...\"\n              }\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-8 flex flex-col items-center gap-4\">\n            <div className=\"relative\">\n              <div className=\"h-24 w-24 rounded-full border-4 border-primary/20 flex items-center justify-center\">\n                <Loader2 className=\"h-12 w-12 text-primary animate-spin\" />\n              </div>\n            </div>\n            <p className=\"text-center text-muted-foreground\">\n              Playing against AI...<br />\n              <span className=\"text-sm\">\n                {singlePlayerMode === \"practice\" \n                  ? \"This is just practice - no stakes!\" \n                  : `Stakes: ${parseInt(selectedStake).toLocaleString()} NGN`\n                }\n              </span>\n            </p>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":54980,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport express from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { WebSocketServer, WebSocket } from \"ws\";\nimport { storage } from \"./storage\";\nimport { setupAuth as setupPassportAuth, isAuthenticated } from \"./auth\";\nimport passport from \"passport\";\nimport bcrypt from \"bcryptjs\";\nimport jwt from \"jsonwebtoken\";\nimport multer from \"multer\";\nimport path from \"path\";\nimport fs from \"fs\";\nimport crypto from \"crypto\";\nimport { uploadToObjectStorage, uploadMultipleToObjectStorage, uploadVideoToStorage, isCloudinaryConfigured } from \"./object-storage\";\nimport { z } from \"zod\";\nimport Groq from \"groq-sdk\";\nimport { \n  insertProductSchema, \n  insertMessageSchema, \n  insertReviewSchema, \n  insertReportSchema, \n  insertWatchlistSchema,\n  roleUpdateSchema,\n  createReferralSchema,\n  createSavedSearchSchema,\n  saveDraftSchema,\n  createScheduledPostSchema,\n  createBoostSchema,\n  createDisputeSchema,\n  createSupportTicketSchema,\n  createGameSchema,\n  completeGameSchema,\n  registerSchema,\n  loginSchema,\n  forgotPasswordSchema,\n  resetPasswordSchema,\n  createAnnouncementSchema,\n  updateAnnouncementSchema,\n  initiateSquadPaymentSchema,\n  insertNegotiationSchema,\n  createOrderSchema,\n  updateOrderStatusSchema,\n  purchaseVtuSchema,\n  purchaseAirtimeSchema,\n  createBeneficiarySchema,\n  updateUserSettingsSchema,\n  requestAccountDeletionSchema,\n  initiateKycSchema,\n  reviewKycSchema,\n  createScheduledPurchaseApiSchema,\n  createGiftDataApiSchema,\n  payBillSchema,\n  validateCustomerSchema,\n  createStorySchema,\n  createSecretMessageLinkSchema,\n  sendSecretMessageSchema,\n} from \"@shared/schema\";\nimport { getChatbotResponse, getChatbotResponseWithHandoff, checkForPaymentScam, detectHandoffNeed, type ChatMessage, type ChatbotResponse } from \"./chatbot\";\nimport { squad, generatePaymentReference, generateTransferReference, isSquadConfigured, getSquadConfigStatus, SquadApiError, SquadErrorType } from \"./squad\";\nimport { calculatePricingFromSellerPrice, calculateSquadFee, getCommissionRate, getSecurityDepositAmount, isWithdrawalAllowed } from \"./pricing\";\nimport { purchaseData, purchaseAirtime, isSMEDataConfigured, isValidNigerianPhone, verifyNIN, validateBillCustomer, getCablePackages, payBill, getBillServiceInfo, requeryOrder } from \"./smedata\";\nimport { \n  sendEmailVerificationCode, \n  sendErrorReportToAdmin, \n  sendMessageNotification, \n  sendOrderEmail,\n  sendWelcomeEmail,\n  sendNewFollowerEmail,\n  sendNewPostFromFollowingEmail,\n  sendNewProductFromFollowingEmail,\n  sendTestEmail\n} from \"./email-service\";\n\n// Module-level WebSocket connections map for broadcasting notifications\n// Changed from Map<string, WebSocket> to Map<string, Set<WebSocket>> to support multiple connections per user\n// This fixes the issue where NotificationBell and Messages page connections were overwriting each other\nconst wsConnections = new Map<string, Set<WebSocket>>();\n\n// Helper function to add a WebSocket connection for a user\nfunction addWsConnection(userId: string, ws: WebSocket) {\n  if (!wsConnections.has(userId)) {\n    wsConnections.set(userId, new Set());\n  }\n  wsConnections.get(userId)!.add(ws);\n}\n\n// Helper function to remove a WebSocket connection for a user\nfunction removeWsConnection(userId: string, ws: WebSocket) {\n  const connections = wsConnections.get(userId);\n  if (connections) {\n    connections.delete(ws);\n    if (connections.size === 0) {\n      wsConnections.delete(userId);\n    }\n  }\n}\n\n// Helper function to broadcast a notification to all of a user's WebSocket connections\nasync function broadcastNotification(userId: string, notification: any) {\n  const connections = wsConnections.get(userId);\n  if (connections) {\n    const message = JSON.stringify({\n      type: \"new_notification\",\n      notification,\n    });\n    connections.forEach(ws => {\n      if (ws.readyState === WebSocket.OPEN) {\n        ws.send(message);\n      }\n    });\n  }\n}\n\n// Helper function to broadcast any message to all of a user's WebSocket connections\nfunction broadcastToUser(userId: string, data: any) {\n  const connections = wsConnections.get(userId);\n  if (connections) {\n    const message = JSON.stringify(data);\n    connections.forEach(ws => {\n      if (ws.readyState === WebSocket.OPEN) {\n        ws.send(message);\n      }\n    });\n  }\n}\n\n// Helper function to get all online user IDs\nfunction getOnlineUserIds(): string[] {\n  return Array.from(wsConnections.keys());\n}\n\n// Helper function to check if a specific user is online\nfunction isUserOnline(userId: string): boolean {\n  return wsConnections.has(userId);\n}\n\n// Game room WebSocket connections map: roomCode -> Set of user WebSocket connections\nconst gameRoomConnections = new Map<string, Map<string, WebSocket>>();\n\n// Add a WebSocket connection to a game room\nfunction addGameRoomConnection(roomCode: string, userId: string, ws: WebSocket) {\n  if (!gameRoomConnections.has(roomCode)) {\n    gameRoomConnections.set(roomCode, new Map());\n  }\n  gameRoomConnections.get(roomCode)!.set(userId, ws);\n}\n\n// Remove a WebSocket connection from a game room\nfunction removeGameRoomConnection(roomCode: string, userId: string) {\n  const room = gameRoomConnections.get(roomCode);\n  if (room) {\n    room.delete(userId);\n    if (room.size === 0) {\n      gameRoomConnections.delete(roomCode);\n    }\n  }\n}\n\n// Broadcast message to all players in a game room\nfunction broadcastToGameRoom(roomCode: string, data: any, excludeUserId?: string) {\n  const room = gameRoomConnections.get(roomCode);\n  if (room) {\n    const message = JSON.stringify(data);\n    room.forEach((ws, odID) => {\n      if (odID !== excludeUserId && ws.readyState === WebSocket.OPEN) {\n        ws.send(message);\n      }\n    });\n  }\n}\n\n// Get count of connected players in a game room\nfunction getGameRoomPlayerCount(roomCode: string): number {\n  const room = gameRoomConnections.get(roomCode);\n  return room ? room.size : 0;\n}\n\n// Helper function to broadcast user online/offline status to all connected users\nfunction broadcastUserStatusChange(userId: string, isOnline: boolean) {\n  const statusMessage = JSON.stringify({\n    type: \"user_status_change\",\n    userId,\n    isOnline,\n  });\n  \n  // Broadcast to all connected users\n  wsConnections.forEach((connections, connectedUserId) => {\n    connections.forEach(ws => {\n      if (ws.readyState === WebSocket.OPEN) {\n        ws.send(statusMessage);\n      }\n    });\n  });\n}\n\n// Helper function to create and broadcast a notification\nasync function createAndBroadcastNotification(data: {\n  userId: string;\n  type: string;\n  title: string;\n  message: string;\n  link?: string;\n  relatedUserId?: string;\n  relatedProductId?: string;\n}) {\n  try {\n    const notification = await storage.createNotification(data);\n    await broadcastNotification(data.userId, notification);\n    return notification;\n  } catch (error) {\n    console.error(\"Error creating/broadcasting notification:\", error);\n    return null;\n  }\n}\n\n// Setup multer for image uploads - use memory storage for object storage\nconst uploadDir = path.join(process.cwd(), \"uploads\");\nif (!fs.existsSync(uploadDir)) {\n  fs.mkdirSync(uploadDir, { recursive: true });\n}\n\n// Memory storage for object storage uploads (images only)\nconst upload = multer({\n  storage: multer.memoryStorage(),\n  limits: { fileSize: 5 * 1024 * 1024 }, // 5MB limit\n  fileFilter: (req, file, cb) => {\n    if (file.mimetype.startsWith(\"image/\")) {\n      cb(null, true);\n    } else {\n      cb(new Error(\"Only images are allowed\"));\n    }\n  },\n});\n\n// Memory storage for media uploads (images and videos)\nconst uploadMedia = multer({\n  storage: multer.memoryStorage(),\n  limits: { fileSize: 50 * 1024 * 1024 }, // 50MB limit for videos\n  fileFilter: (req, file, cb) => {\n    if (file.mimetype.startsWith(\"image/\") || file.mimetype.startsWith(\"video/\")) {\n      cb(null, true);\n    } else {\n      cb(new Error(\"Only images and videos are allowed\"));\n    }\n  },\n});\n\n// Disk storage fallback for local development\nconst uploadDisk = multer({\n  storage: multer.diskStorage({\n    destination: uploadDir,\n    filename: (req, file, cb) => {\n      const uniqueSuffix = Date.now() + \"-\" + Math.round(Math.random() * 1e9);\n      cb(null, uniqueSuffix + path.extname(file.originalname));\n    },\n  }),\n  limits: { fileSize: 5 * 1024 * 1024 },\n  fileFilter: (req, file, cb) => {\n    if (file.mimetype.startsWith(\"image/\")) {\n      cb(null, true);\n    } else {\n      cb(new Error(\"Only images are allowed\"));\n    }\n  },\n});\n\n// Helper to get user ID from session (Passport.js)\nfunction getUserId(req: any): string | null {\n  return req.user?.id || null;\n}\n\n// Helper functions for Admin/Support role checks via environment variables\nfunction isSuperAdmin(userId: string | null): boolean {\n  if (!userId) return false;\n  const adminIds = process.env.SUPER_ADMIN_IDS?.split(',').map(id => id.trim()) || [];\n  return adminIds.includes(userId);\n}\n\nfunction isSupportRep(userId: string | null): boolean {\n  if (!userId) return false;\n  const supportIds = process.env.SUPPORT_IDS?.split(',').map(id => id.trim()) || [];\n  return supportIds.includes(userId);\n}\n\nfunction hasAdminAccess(userId: string | null): boolean {\n  return isSuperAdmin(userId);\n}\n\nfunction hasSupportAccess(userId: string | null): boolean {\n  return isSuperAdmin(userId) || isSupportRep(userId);\n}\n\n// Combined admin check - checks both database role AND environment variable\nasync function isAdminUser(userId: string | null): Promise<boolean> {\n  if (!userId) return false;\n  \n  // Check environment variable first (faster)\n  if (isSuperAdmin(userId)) return true;\n  \n  // Fall back to database role check\n  const user = await storage.getUser(userId);\n  return user?.role === \"admin\";\n}\n\n// Email verification enforcement configuration\nconst MAX_LISTINGS_UNVERIFIED = 3; // Unverified users can only create 3 listings\n\n// Middleware to check if user has verified their email\n// Returns null if verified, error message if not\nasync function checkEmailVerified(userId: string): Promise<{ verified: boolean; message?: string }> {\n  const user = await storage.getUser(userId);\n  if (!user) {\n    return { verified: false, message: \"User not found\" };\n  }\n  \n  // System accounts are always considered verified\n  const systemUserId = process.env.SYSTEM_USER_ID || process.env.SYSTEM_WELCOME_USER_ID;\n  if (userId === systemUserId) {\n    return { verified: true };\n  }\n  \n  // Admins are always considered verified\n  if (user.role === \"admin\" || isSuperAdmin(userId)) {\n    return { verified: true };\n  }\n  \n  if (!user.emailVerified) {\n    return { \n      verified: false, \n      message: \"Please verify your email to use this feature. Check your inbox for the verification link.\"\n    };\n  }\n  \n  return { verified: true };\n}\n\n// Middleware to enforce email verification for critical actions\n// SECURITY: Fail-closed - blocks on any error (never allows unverified access)\nfunction requireEmailVerified(req: any, res: any, next: any) {\n  const userId = getUserId(req);\n  if (!userId) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n  \n  checkEmailVerified(userId).then(result => {\n    if (!result.verified) {\n      return res.status(403).json({ \n        message: result.message,\n        code: \"EMAIL_NOT_VERIFIED\",\n        action: \"verify_email\"\n      });\n    }\n    next();\n  }).catch(err => {\n    console.error(\"Email verification check error:\", err);\n    // SECURITY: Fail closed - block access on any error\n    return res.status(500).json({ \n      message: \"Unable to verify email status. Please try again.\",\n      code: \"VERIFICATION_ERROR\"\n    });\n  });\n}\n\n// Synchronous admin check middleware (uses cached check, then DB fallback)\nfunction requireAdmin(req: any, res: any, next: any) {\n  const userId = getUserId(req);\n  if (!userId) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n  \n  // First check super admin (fast, synchronous)\n  if (isSuperAdmin(userId)) {\n    return next();\n  }\n  \n  // Fall back to database check\n  isAdminUser(userId).then(isAdmin => {\n    if (!isAdmin) {\n      return res.status(403).json({ message: \"Admin access required\" });\n    }\n    next();\n  }).catch(err => {\n    console.error(\"Admin check error:\", err);\n    return res.status(500).json({ message: \"Unable to verify admin status\" });\n  });\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Setup Passport.js authentication (email/password) for Render deployment\n  await setupPassportAuth(app);\n\n  // Serve uploaded images from disk (legacy)\n  app.use(\"/uploads\", (req, res, next) => {\n    res.setHeader(\"Cross-Origin-Resource-Policy\", \"cross-origin\");\n    next();\n  });\n  app.use(\"/uploads\", express.static(uploadDir));\n\n  // Legacy storage route - redirect to proper URLs\n  // With Cloudinary, images are served directly from Cloudinary URLs\n  // This route handles any legacy /storage/ URLs by returning 404\n  app.get(\"/storage/:objectName(*)\", async (req, res) => {\n    res.status(404).json({ \n      message: \"Legacy storage URL - image may have been uploaded before Cloudinary migration\" \n    });\n  });\n  \n  // API route to check storage configuration status\n  app.get(\"/api/storage/status\", (req, res) => {\n    res.json({ \n      cloudinaryConfigured: isCloudinaryConfigured(),\n      message: isCloudinaryConfigured() \n        ? \"Cloudinary is configured for persistent image storage\" \n        : \"Using disk storage (images may not persist after restart)\"\n    });\n  });\n\n  // ==================== NEW AUTH ROUTES (Passport.js Local) ====================\n  \n  // Simple in-memory rate limiting for username checks\n  const usernameCheckRateLimits = new Map<string, { count: number; resetTime: number }>();\n  const RATE_LIMIT_WINDOW = 60000; // 1 minute\n  const RATE_LIMIT_MAX_REQUESTS = 30; // 30 requests per minute\n  \n  // Check username availability endpoint with rate limiting\n  app.get(\"/api/auth/check-username/:username\", async (req, res) => {\n    try {\n      const clientIp = req.ip || req.socket.remoteAddress || \"unknown\";\n      const now = Date.now();\n      \n      // Rate limiting check\n      const rateLimit = usernameCheckRateLimits.get(clientIp);\n      if (rateLimit) {\n        if (now < rateLimit.resetTime) {\n          if (rateLimit.count >= RATE_LIMIT_MAX_REQUESTS) {\n            return res.status(429).json({ \n              message: \"Too many requests. Please try again later.\",\n              available: false\n            });\n          }\n          rateLimit.count++;\n        } else {\n          usernameCheckRateLimits.set(clientIp, { count: 1, resetTime: now + RATE_LIMIT_WINDOW });\n        }\n      } else {\n        usernameCheckRateLimits.set(clientIp, { count: 1, resetTime: now + RATE_LIMIT_WINDOW });\n      }\n      \n      const { username } = req.params;\n      \n      // Validate username format\n      if (!username || username.length < 3) {\n        return res.status(400).json({ \n          available: false, \n          message: \"Username must be at least 3 characters\" \n        });\n      }\n      \n      if (username.length > 30) {\n        return res.status(400).json({ \n          available: false, \n          message: \"Username must be at most 30 characters\" \n        });\n      }\n      \n      // Only allow alphanumeric and underscore\n      if (!/^[a-zA-Z0-9_]+$/.test(username)) {\n        return res.status(400).json({ \n          available: false, \n          message: \"Username can only contain letters, numbers, and underscores\" \n        });\n      }\n      \n      // Check if username is taken (case-insensitive)\n      const existingUser = await storage.getUserByUsername(username.toLowerCase());\n      \n      if (existingUser) {\n        return res.json({ \n          available: false, \n          message: \"Username is already taken\" \n        });\n      }\n      \n      return res.json({ \n        available: true, \n        message: \"Username is available\" \n      });\n    } catch (error: any) {\n      console.error(\"Error checking username:\", error);\n      return res.status(500).json({ \n        available: false, \n        message: \"Error checking username availability\" \n      });\n    }\n  });\n  \n  // Registration route\n  app.post(\"/api/auth/register\", async (req, res) => {\n    try {\n      // Validate request body with Zod schema\n      const validationResult = registerSchema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        const errors = validationResult.error.flatten();\n        console.log(\"Registration validation failed:\", errors);\n        return res.status(400).json({ \n          message: \"Validation failed\",\n          errors: errors.fieldErrors\n        });\n      }\n\n      const { email, password, firstName, lastName, username, phoneNumber, role, referralCode } = validationResult.data;\n\n      // Check if user already exists by email\n      const existingUser = await storage.getUserByEmail(email.toLowerCase().trim());\n      if (existingUser) {\n        return res.status(400).json({ message: \"Email already registered\" });\n      }\n\n      // Check if username is already taken\n      const existingUsername = await storage.getUserByUsername(username);\n      if (existingUsername) {\n        return res.status(400).json({ message: \"Username is already taken\" });\n      }\n\n      // Hash password\n      const hashedPassword = await bcrypt.hash(password, 12);\n\n      // Create user - only pass phoneNumber if it's not empty\n      const userData: { \n        email: string; \n        password: string; \n        firstName: string; \n        lastName: string;\n        username: string; \n        phoneNumber?: string; \n        role: \"buyer\" | \"seller\" | \"both\" \n      } = {\n        email: email.toLowerCase().trim(),\n        password: hashedPassword,\n        firstName: firstName.trim(),\n        lastName: lastName.trim(),\n        username: username, // Already lowercase from schema transform\n        role: role || \"buyer\",\n      };\n      \n      // Only include phoneNumber if it's a non-empty string\n      if (phoneNumber && phoneNumber.trim().length > 0) {\n        userData.phoneNumber = phoneNumber.trim();\n      }\n\n      console.log(\"Creating user with data:\", { ...userData, password: \"[HIDDEN]\" });\n\n      const user = await storage.createUser(userData);\n\n      // Handle referral code if provided\n      if (referralCode && referralCode.trim().length > 0) {\n        try {\n          const trimmedCode = referralCode.trim().toUpperCase();\n          // Look up the referrer by their unique referral code\n          const referrer = await storage.getUserByReferralCode(trimmedCode);\n          \n          if (referrer && referrer.id !== user.id) {\n            // Create the referral record\n            await storage.createReferral(referrer.id, user.id);\n            console.log(`Referral created: ${referrer.email} referred ${user.email}`);\n          } else if (!referrer) {\n            console.log(`Invalid referral code: ${trimmedCode} (user not found)`);\n          }\n        } catch (referralError: any) {\n          // Log but don't fail registration if referral creation fails\n          console.error(\"Error processing referral code:\", referralError.message);\n        }\n      }\n\n      // Auto-follow system user and send welcome DM\n      const systemUserId = process.env.SYSTEM_USER_ID;\n      if (systemUserId) {\n        try {\n          // Check if system user exists\n          const systemUser = await storage.getUser(systemUserId);\n          if (systemUser) {\n            // Create follow relationship (new user follows system user)\n            await storage.followUser(user.id, systemUserId);\n            console.log(`New user ${user.email} now follows system user @${systemUser.firstName || 'EKSUMarketplace'}`);\n            \n            // Send welcome DM from system user\n            const welcomeMessage = `Welcome to EKSU Marketplace! We're excited to have you join our campus trading community.\n\nHere are some quick tips to get started:\n1. Complete your profile to build trust with other users\n2. Always use our in-app payment system for safe transactions\n3. Meet in public places on campus for item exchanges\n4. Report any suspicious activity to keep our community safe\n\nNeed help? Just reply to this message or use the Help button in the app.\n\nHappy trading!`;\n\n            await storage.createMessage({\n              senderId: systemUserId,\n              receiverId: user.id,\n              content: welcomeMessage,\n            });\n            console.log(`Welcome DM sent to ${user.email} from system user`);\n            \n            // Also create a welcome notification\n            await createAndBroadcastNotification({\n              userId: user.id,\n              type: \"welcome\",\n              title: \"Welcome to EKSU Marketplace!\",\n              message: `Hey ${user.firstName || 'there'}! Your account is ready. Start exploring deals on campus or list your own items to sell.`,\n              link: \"/\",\n              relatedUserId: systemUserId,\n            });\n            console.log(`Welcome notification sent to ${user.email}`);\n          } else {\n            console.log(`System user with ID ${systemUserId} not found`);\n          }\n        } catch (autoFollowError: any) {\n          // Log but don't fail registration if auto-follow fails\n          console.error(\"Error processing auto-follow/welcome DM:\", autoFollowError.message);\n        }\n      }\n\n      // Send email verification (don't block registration if this fails)\n      try {\n        const { token, code } = await storage.createEmailVerificationToken(user.id);\n        const appUrl = process.env.APP_URL || 'https://eksuplug.com.ng';\n        const verificationLink = `${appUrl}/verify-email?token=${token}`;\n        await sendEmailVerificationCode(user.email, user.firstName || 'User', code, verificationLink);\n        console.log(`Verification email sent to ${user.email}`);\n      } catch (emailError: any) {\n        console.error(\"Error sending verification email:\", emailError.message);\n        // Don't fail registration if email fails - user can request resend later\n      }\n\n      // Send welcome email (don't block registration if this fails)\n      try {\n        await sendWelcomeEmail(user.email, user.firstName || 'User');\n        console.log(`Welcome email sent to ${user.email}`);\n      } catch (welcomeEmailError: any) {\n        console.error(\"Error sending welcome email:\", welcomeEmailError.message);\n      }\n\n      // Remove password from user object before storing in session/sending to client\n      const { password: _, ...safeUser } = user;\n\n      // Log the user in\n      req.login(safeUser, (err) => {\n        if (err) {\n          console.error(\"Error logging in after registration:\", err);\n          return res.status(500).json({ message: \"Registration successful but login failed\" });\n        }\n        console.log(\"User registered and logged in successfully:\", safeUser.email);\n        res.json(safeUser);\n      });\n    } catch (error: any) {\n      console.error(\"Error registering user:\", error);\n      \n      // Handle specific database errors\n      if (error.message?.includes(\"duplicate key\") || error.code === \"23505\") {\n        return res.status(400).json({ message: \"Email already registered\" });\n      }\n      \n      // Hide developer details from user\n      const userMessage = \"Failed to create account. Please try again or contact support.\";\n      \n      // Send error to admin\n      sendErrorReportToAdmin(\"Registration Error\", error.message, { \n        email: req.body.email,\n        stack: error.stack \n      }).catch(err => {\n        console.error(\"Failed to send registration error email:\", err);\n      });\n\n      res.status(500).json({ message: userMessage });\n    }\n  });\n\n  // ==================== EMAIL VERIFICATION ROUTES ====================\n\n  // Send/resend verification email\n  app.post(\"/api/auth/send-verification-email\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Authentication required\" });\n      }\n\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      if (user.emailVerified) {\n        return res.status(400).json({ message: \"Email is already verified\" });\n      }\n\n      // Generate verification token and code\n      const { token, code } = await storage.createEmailVerificationToken(userId);\n      \n      // Build verification link\n      const appUrl = process.env.APP_URL || 'https://eksu-marketplace.com';\n      const verificationLink = `${appUrl}/verify-email?token=${token}`;\n\n      // Send verification email\n      await sendEmailVerificationCode(user.email, user.firstName || 'User', code, verificationLink);\n\n      console.log(`Verification email sent to ${user.email}`);\n      res.json({ \n        message: \"Verification email sent successfully\",\n        success: true \n      });\n    } catch (error: any) {\n      console.error(\"Error sending verification email:\", error);\n      res.status(500).json({ message: \"Failed to send verification email\" });\n    }\n  });\n\n  // Verify email via link token\n  app.get(\"/api/auth/verify-email/:token\", async (req, res) => {\n    try {\n      const { token } = req.params;\n      \n      if (!token) {\n        return res.status(400).json({ message: \"Verification token is required\" });\n      }\n\n      const verified = await storage.verifyEmailToken(token);\n      \n      if (!verified) {\n        return res.status(400).json({ \n          message: \"Invalid or expired verification link. Please request a new one.\",\n          success: false \n        });\n      }\n\n      console.log(`Email verified via link token`);\n      res.json({ \n        message: \"Email verified successfully!\",\n        success: true \n      });\n    } catch (error: any) {\n      console.error(\"Error verifying email token:\", error);\n      res.status(500).json({ message: \"Failed to verify email\" });\n    }\n  });\n\n  // Verify email via 6-digit code\n  app.post(\"/api/auth/verify-email-code\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Authentication required\" });\n      }\n\n      const { code } = req.body;\n      \n      if (!code || typeof code !== 'string' || code.length !== 6) {\n        return res.status(400).json({ message: \"Valid 6-digit verification code is required\" });\n      }\n\n      const verified = await storage.verifyEmailCode(userId, code);\n      \n      if (!verified) {\n        return res.status(400).json({ \n          message: \"Invalid or expired verification code. Please request a new one.\",\n          success: false \n        });\n      }\n\n      console.log(`Email verified via code for user ${userId}`);\n      res.json({ \n        message: \"Email verified successfully!\",\n        success: true \n      });\n    } catch (error: any) {\n      console.error(\"Error verifying email code:\", error);\n      res.status(500).json({ message: \"Failed to verify email\" });\n    }\n  });\n\n  // Check email verification status\n  app.get(\"/api/auth/email-verification-status\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Authentication required\" });\n      }\n\n      const isVerified = await storage.isUserEmailVerified(userId);\n      res.json({ emailVerified: isVerified });\n    } catch (error: any) {\n      console.error(\"Error checking email verification status:\", error);\n      res.status(500).json({ message: \"Failed to check email verification status\" });\n    }\n  });\n\n  // Login route\n  app.post(\"/api/auth/login\", (req, res, next) => {\n    passport.authenticate(\"local\", (err: any, user: any, info: any) => {\n      if (err) {\n        console.error(\"Error during login:\", err);\n        return res.status(500).json({ message: \"Login failed\" });\n      }\n      if (!user) {\n        return res.status(401).json({ message: info?.message || \"Invalid credentials\" });\n      }\n      // Remove password from user object before storing in session/sending to client\n      const { password: _, ...safeUser } = user;\n      \n      req.login(safeUser, (err) => {\n        if (err) {\n          console.error(\"Error establishing session:\", err);\n          return res.status(500).json({ message: \"Failed to establish session\" });\n        }\n        res.json(safeUser);\n      });\n    })(req, res, next);\n  });\n\n  // Logout route\n  app.post(\"/api/auth/logout\", (req, res) => {\n    const sessionId = req.sessionID;\n    \n    req.logout((err) => {\n      if (err) {\n        console.error(\"Error logging out:\", err);\n        return res.status(500).json({ message: \"Failed to logout\" });\n      }\n      \n      // Destroy the session completely\n      req.session.destroy((sessionErr) => {\n        if (sessionErr) {\n          console.error(\"Error destroying session:\", sessionErr);\n        }\n        \n        // Clear the session cookie\n        res.clearCookie(\"connect.sid\", {\n          path: \"/\",\n          httpOnly: true,\n          secure: process.env.NODE_ENV === \"production\",\n          sameSite: \"lax\"\n        });\n        \n        console.log(\"User logged out, session destroyed:\", sessionId);\n        res.json({ message: \"Logged out successfully\" });\n      });\n    });\n  });\n\n  // Forgot password route - generates reset token\n  app.post(\"/api/auth/forgot-password\", async (req, res) => {\n    try {\n      const validationResult = forgotPasswordSchema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ message: \"Valid email is required\" });\n      }\n\n      const { email } = validationResult.data;\n      \n      // Check if user exists\n      const user = await storage.getUserByEmail(email.toLowerCase().trim());\n      \n      // For security, always return success even if user doesn't exist\n      // This prevents email enumeration attacks\n      if (!user) {\n        console.log(`Password reset requested for non-existent email: ${email}`);\n        return res.json({ \n          message: \"If an account exists with this email, a password reset link will be sent.\",\n          success: true\n        });\n      }\n\n      // Generate a secure random token\n      const resetToken = crypto.randomBytes(32).toString(\"hex\");\n      \n      // Token expires in 1 hour\n      const expiresAt = new Date(Date.now() + 60 * 60 * 1000);\n      \n      // Store the token in database\n      await storage.createPasswordResetToken(user.id, resetToken, expiresAt);\n      \n      console.log(`Password reset token generated for user: ${email}`);\n      console.log(`Reset token (for development): ${resetToken}`);\n      \n      // In production, send email with reset link\n      // For now, include the token in the response for development/testing\n      // The frontend can use this to navigate to /reset-password?token=xxx\n      \n      res.json({ \n        message: \"If an account exists with this email, a password reset link will be sent.\",\n        success: true,\n        // Include token in development mode for testing\n        ...(process.env.NODE_ENV === \"development\" && { resetToken })\n      });\n    } catch (error) {\n      console.error(\"Error in forgot password:\", error);\n      res.status(500).json({ message: \"Failed to process request\" });\n    }\n  });\n\n  // Reset password route - validates token and updates password\n  app.post(\"/api/auth/reset-password\", async (req, res) => {\n    try {\n      const validationResult = resetPasswordSchema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        const errors = validationResult.error.flatten();\n        return res.status(400).json({ \n          message: \"Validation failed\",\n          errors: errors.fieldErrors\n        });\n      }\n\n      const { token, password } = validationResult.data;\n      \n      // Find the reset token\n      const resetToken = await storage.getPasswordResetToken(token);\n      \n      if (!resetToken) {\n        return res.status(400).json({ \n          message: \"Invalid or expired reset token. Please request a new password reset.\" \n        });\n      }\n      \n      // Hash the new password\n      const hashedPassword = await bcrypt.hash(password, 12);\n      \n      // Update the user's password\n      await storage.updateUserPassword(resetToken.userId, hashedPassword);\n      \n      // Mark the token as used\n      await storage.markPasswordResetTokenUsed(token);\n      \n      console.log(`Password reset successful for user: ${resetToken.userId}`);\n      \n      res.json({ \n        message: \"Password has been reset successfully. You can now log in with your new password.\",\n        success: true\n      });\n    } catch (error) {\n      console.error(\"Error resetting password:\", error);\n      res.status(500).json({ message: \"Failed to reset password\" });\n    }\n  });\n\n  // Validate reset token route - checks if token is valid before showing reset form\n  app.get(\"/api/auth/validate-reset-token\", async (req, res) => {\n    try {\n      const { token } = req.query;\n      \n      if (!token || typeof token !== \"string\") {\n        return res.status(400).json({ valid: false, message: \"Token is required\" });\n      }\n      \n      const resetToken = await storage.getPasswordResetToken(token);\n      \n      if (!resetToken) {\n        return res.json({ \n          valid: false, \n          message: \"Invalid or expired reset token\" \n        });\n      }\n      \n      res.json({ valid: true });\n    } catch (error) {\n      console.error(\"Error validating reset token:\", error);\n      res.status(500).json({ valid: false, message: \"Failed to validate token\" });\n    }\n  });\n\n  // ==================== EXISTING AUTH ROUTES ====================\n  \n  // Auth routes\n  app.get(\"/api/auth/user\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      // Remove password from user object before sending to client\n      const { password: _, ...safeUser } = user;\n      \n      // Add admin/support access flags based on both database role and environment variables\n      const isAdmin = user.role === \"admin\" || isSuperAdmin(userId);\n      const isSupport = hasSupportAccess(userId);\n      \n      res.json({\n        ...safeUser,\n        isAdmin,\n        isSupport,\n      });\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n\n  // ==================== ERROR REPORTING API ROUTES ====================\n\n  // Error reporting endpoint for ErrorBoundary\n  app.post(\"/api/errors/report\", async (req, res) => {\n    try {\n      const { message, stack, componentStack, url, userAgent, timestamp } = req.body;\n\n      // Log error to console\n      console.error(\"Frontend Error Report:\", {\n        message,\n        stack,\n        componentStack,\n        url,\n        userAgent,\n        timestamp,\n      });\n\n      // Send error report to admin email\n      sendErrorReportToAdmin(\"Frontend Error Report\", `URL: ${url}\\n\\nError: ${message}\\n\\nStack: ${stack}`, {\n        componentStack,\n        userAgent,\n        timestamp,\n      }).catch(err => {\n        console.error(\"Failed to send error report email:\", err);\n      });\n\n      // For now, just acknowledge receipt\n      res.json({ success: true, message: \"Error report received\" });\n    } catch (error) {\n      console.error(\"Error processing error report:\", error);\n      res.status(500).json({ message: \"Failed to process error report\" });\n    }\n  });\n\n  // ==================== NEW FEATURES API ROUTES ====================\n\n  // Wallet routes\n  app.get('/api/wallet', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const wallet = await storage.getOrCreateWallet(userId);\n      res.json(wallet);\n    } catch (error) {\n      console.error(\"Error fetching wallet:\", error);\n      res.status(500).json({ message: \"Failed to fetch wallet\" });\n    }\n  });\n\n  app.get('/api/wallet/transactions', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const wallet = await storage.getOrCreateWallet(userId);\n      const transactions = await storage.getUserTransactions(wallet.id);\n      res.json(transactions);\n    } catch (error) {\n      console.error(\"Error fetching transactions:\", error);\n      res.status(500).json({ message: \"Failed to fetch transactions\" });\n    }\n  });\n\n  app.post('/api/wallet/deposit', isAuthenticated, requireEmailVerified, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { amount } = req.body;\n\n      if (!amount || parseFloat(amount) < 100) {\n        return res.status(400).json({ message: \"Minimum deposit is 100 NGN\" });\n      }\n\n      const wallet = await storage.getOrCreateWallet(userId);\n      \n      await storage.createTransaction({\n        walletId: wallet.id,\n        type: 'deposit',\n        amount: amount.toString(),\n        description: 'Wallet deposit',\n        status: 'pending',\n      });\n\n      res.json({ \n        message: \"Deposit initiated. Please complete payment.\",\n        amount: amount\n      });\n    } catch (error) {\n      console.error(\"Error initiating deposit:\", error);\n      res.status(500).json({ message: \"Failed to initiate deposit\" });\n    }\n  });\n\n  app.post('/api/wallet/withdraw', isAuthenticated, requireEmailVerified, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { amount, bankName, accountNumber, accountName } = req.body;\n\n      if (!amount || parseFloat(amount) < 500) {\n        return res.status(400).json({ message: \"Minimum withdrawal is 500 NGN\" });\n      }\n\n      if (!bankName || !accountNumber || !accountName) {\n        return res.status(400).json({ message: \"Bank details are required\" });\n      }\n\n      const wallet = await storage.getOrCreateWallet(userId);\n      \n      if (parseFloat(wallet.balance) < parseFloat(amount)) {\n        return res.status(400).json({ message: \"Insufficient balance\" });\n      }\n\n      await storage.updateWalletBalance(userId, amount.toString(), 'subtract');\n      \n      await storage.createTransaction({\n        walletId: wallet.id,\n        type: 'withdrawal',\n        amount: amount.toString(),\n        description: `Withdrawal to ${bankName} - ${accountNumber}`,\n        status: 'pending',\n      });\n\n      res.json({ message: \"Withdrawal request submitted successfully\" });\n    } catch (error) {\n      console.error(\"Error processing withdrawal:\", error);\n      res.status(500).json({ message: \"Failed to process withdrawal\" });\n    }\n  });\n\n  // ==================== SQUAD PAYMENT ROUTES ====================\n\n  // Check if Squad is configured\n  app.get('/api/squad/status', (req, res) => {\n    res.json({ configured: isSquadConfigured() });\n  });\n\n  // Admin: Get detailed Squad payment configuration status\n  // SECURITY: Protected by requireAdmin middleware - only admins can view payment configuration\n  app.get('/api/admin/payment/config', isAuthenticated, requireAdmin, async (req: any, res) => {\n    try {\n      const squadStatus = getSquadConfigStatus();\n      const smedataConfigured = isSMEDataConfigured();\n\n      res.json({\n        squad: squadStatus,\n        vtu: {\n          configured: smedataConfigured,\n          provider: \"SMEDATA.NG\",\n        },\n        message: squadStatus.configured \n          ? `Squad is configured in ${squadStatus.mode} mode`\n          : \"Squad is not configured. Please set SQUAD_SECRET_KEY and SQUAD_PUBLIC_KEY environment variables.\",\n      });\n    } catch (error) {\n      console.error(\"Error fetching payment config:\", error);\n      res.status(500).json({ message: \"Failed to fetch payment configuration\" });\n    }\n  });\n\n  // Initialize a Squad payment\n  app.post('/api/squad/initialize', isAuthenticated, async (req: any, res) => {\n    const requestId = crypto.randomBytes(4).toString('hex');\n    \n    try {\n      if (!isSquadConfigured()) {\n        return res.status(503).json({ \n          message: \"Payment service is not configured. Please contact support.\",\n          code: \"SERVICE_UNAVAILABLE\"\n        });\n      }\n\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const validated = initiateSquadPaymentSchema.parse(req.body);\n      const amount = parseFloat(validated.amount);\n\n      if (amount < 100) {\n        return res.status(400).json({ message: \"Minimum payment amount is ₦100\" });\n      }\n\n      const paymentReference = generatePaymentReference();\n      const redirectUrl = `${process.env.APP_URL || 'https://eksu-marketplace.replit.app'}/payment/callback`;\n\n      // Determine payment channels based on request\n      const paymentChannels: ('card' | 'bank' | 'ussd' | 'transfer')[] = validated.paymentChannel \n        ? [validated.paymentChannel] \n        : ['transfer', 'card', 'ussd'];\n\n      console.log(`[Payment ${requestId}] Initializing Squad payment for user ${userId}, amount: ₦${amount}`);\n\n      const paymentResult = await squad.initializePayment({\n        amount,\n        email: user.email,\n        customerName: `${user.firstName} ${user.lastName}`,\n        transactionRef: paymentReference,\n        callbackUrl: redirectUrl,\n        paymentChannels,\n        metadata: {\n          userId,\n          purpose: validated.purpose,\n          paymentDescription: validated.paymentDescription || `${validated.purpose} - EKSU Marketplace`,\n        },\n      });\n\n      // Store payment record in database\n      await storage.createSquadPayment({\n        userId,\n        transactionReference: paymentResult.transactionRef,\n        amount: amount.toString(),\n        purpose: validated.purpose,\n        status: 'pending',\n        paymentDescription: validated.paymentDescription || null,\n      });\n\n      console.log(`[Payment ${requestId}] Squad payment initialized successfully: ${paymentResult.transactionRef}`);\n\n      res.json({\n        checkoutUrl: paymentResult.checkoutUrl,\n        transactionReference: paymentResult.transactionRef,\n        paymentReference,\n      });\n    } catch (error) {\n      // Handle Zod validation errors\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ \n          message: \"Invalid payment details. Please check your input and try again.\",\n          code: \"VALIDATION_ERROR\",\n          errors: error.errors \n        });\n      }\n\n      // Handle Squad API errors with user-friendly messages\n      if (error instanceof SquadApiError) {\n        console.error(`[Payment ${requestId}] Squad API Error:`, {\n          type: error.type,\n          message: error.message,\n          statusCode: error.statusCode,\n          userMessage: error.userMessage,\n        });\n\n        // Send error report to admin for non-retryable errors\n        if (!error.isRetryable) {\n          sendErrorReportToAdmin(\n            `Squad Payment Error [${requestId}]`,\n            error.message,\n            {\n              type: error.type,\n              statusCode: error.statusCode,\n              rawError: error.rawError,\n              userId: req.user?.id,\n            }\n          ).catch(console.error);\n        }\n\n        return res.status(getHttpStatusForSquadError(error.type)).json({\n          message: error.userMessage,\n          code: error.type,\n          isRetryable: error.isRetryable,\n        });\n      }\n\n      // Handle generic errors\n      console.error(`[Payment ${requestId}] Unexpected error initializing Squad payment:`, error);\n      \n      // Send error report to admin\n      sendErrorReportToAdmin(\n        `Unexpected Payment Error [${requestId}]`,\n        error instanceof Error ? error.message : 'Unknown error',\n        { stack: error instanceof Error ? error.stack : undefined, userId: req.user?.id }\n      ).catch(console.error);\n\n      res.status(500).json({ \n        message: \"Unable to process your payment at this time. Please try again later or contact support.\",\n        code: \"INTERNAL_ERROR\"\n      });\n    }\n  });\n\n  // Helper function to map Squad error types to HTTP status codes\n  function getHttpStatusForSquadError(errorType: SquadErrorType): number {\n    switch (errorType) {\n      case SquadErrorType.INVALID_REQUEST:\n        return 400;\n      case SquadErrorType.INVALID_CREDENTIALS:\n        return 503;\n      case SquadErrorType.INSUFFICIENT_FUNDS:\n        return 402;\n      case SquadErrorType.RATE_LIMITED:\n        return 429;\n      case SquadErrorType.TIMEOUT:\n      case SquadErrorType.NETWORK_ERROR:\n      case SquadErrorType.SERVER_ERROR:\n        return 503;\n      default:\n        return 500;\n    }\n  }\n\n  // Verify a Squad payment by reference\n  app.get('/api/squad/verify/:reference', isAuthenticated, async (req: any, res) => {\n    try {\n      if (!isSquadConfigured()) {\n        return res.status(503).json({ message: \"Payment service is not configured\" });\n      }\n\n      const { reference } = req.params;\n      const userId = req.user.id;\n\n      // Get payment from database\n      const payment = await storage.getSquadPaymentByReference(reference);\n      if (!payment) {\n        return res.status(404).json({ message: \"Payment not found\" });\n      }\n\n      if (payment.userId !== userId) {\n        return res.status(403).json({ message: \"Not authorized to verify this payment\" });\n      }\n\n      // Verify with Squad\n      const transactionStatus = await squad.verifyTransaction(reference);\n\n      // Update payment status in database\n      const paidAt = transactionStatus.transactionStatus === 'success' && transactionStatus.createdAt\n        ? new Date(transactionStatus.createdAt)\n        : undefined;\n      \n      await storage.updateSquadPaymentStatus(reference, transactionStatus.transactionStatus, paidAt);\n\n      // If payment is successful, credit wallet\n      if (transactionStatus.transactionStatus === 'success' && payment.status !== 'success') {\n        const wallet = await storage.getOrCreateWallet(userId);\n        await storage.updateWalletBalance(userId, payment.amount, 'add');\n        \n        await storage.createTransaction({\n          walletId: wallet.id,\n          type: 'deposit',\n          amount: payment.amount,\n          description: `Squad deposit - ${payment.purpose}`,\n          status: 'completed',\n        });\n      }\n\n      res.json({\n        status: transactionStatus.transactionStatus,\n        amountPaid: transactionStatus.transactionAmount,\n        paymentMethod: transactionStatus.transactionType || 'unknown',\n        paidOn: transactionStatus.createdAt,\n      });\n    } catch (error) {\n      console.error(\"Error verifying Squad payment:\", error);\n      res.status(500).json({ message: error instanceof Error ? error.message : \"Failed to verify payment\" });\n    }\n  });\n\n  // Get user's Squad payments\n  app.get('/api/squad/payments', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const payments = await storage.getUserSquadPayments(userId);\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error fetching Squad payments:\", error);\n      res.status(500).json({ message: \"Failed to fetch payments\" });\n    }\n  });\n\n  // Squad webhook handler (no auth - verified by signature)\n  app.post('/api/squad/webhook', express.raw({ type: 'application/json' }), async (req, res) => {\n    try {\n      const signature = req.headers['squad-signature'] as string;\n      const payload = req.body.toString();\n\n      if (!signature || !squad.verifyWebhookSignature(payload, signature)) {\n        console.error(\"Invalid Squad webhook signature\");\n        return res.status(401).json({ message: \"Invalid signature\" });\n      }\n\n      const webhookData = JSON.parse(payload);\n      const { transactionReference, paymentStatus, amountPaid, paidOn } = webhookData;\n\n      // Find payment in database\n      const payment = await storage.getSquadPaymentByReference(transactionReference);\n      if (!payment) {\n        console.error(`Squad webhook: Payment not found for reference ${transactionReference}`);\n        return res.status(404).json({ message: \"Payment not found\" });\n      }\n\n      // Update payment status\n      const paidAtDate = paymentStatus === 'success' && paidOn ? new Date(paidOn) : undefined;\n      await storage.updateSquadPaymentStatus(transactionReference, paymentStatus, paidAtDate);\n\n      // Credit wallet if payment is successful\n      if (paymentStatus === 'success' && payment.status !== 'success') {\n        const wallet = await storage.getOrCreateWallet(payment.userId);\n        await storage.updateWalletBalance(payment.userId, amountPaid.toString(), 'add');\n        \n        await storage.createTransaction({\n          walletId: wallet.id,\n          type: 'deposit',\n          amount: amountPaid.toString(),\n          description: `Squad deposit - ${payment.purpose}`,\n          status: 'completed',\n        });\n\n        console.log(`Squad webhook: Credited ₦${amountPaid} to user ${payment.userId}`);\n      }\n\n      res.json({ message: \"Webhook processed successfully\" });\n    } catch (error) {\n      console.error(\"Error processing Squad webhook:\", error);\n      res.status(500).json({ message: \"Failed to process webhook\" });\n    }\n  });\n\n  // Get list of banks\n  app.get('/api/squad/banks', async (req, res) => {\n    try {\n      if (!isSquadConfigured()) {\n        return res.status(503).json({ message: \"Payment service is not configured\" });\n      }\n\n      const banks = await squad.getBankList();\n      res.json(banks);\n    } catch (error) {\n      console.error(\"Error fetching bank list:\", error);\n      res.status(500).json({ message: error instanceof Error ? error.message : \"Failed to fetch bank list\" });\n    }\n  });\n\n  // Verify bank account (POST - legacy)\n  app.post('/api/squad/verify-bank', isAuthenticated, async (req: any, res) => {\n    try {\n      if (!isSquadConfigured()) {\n        return res.status(503).json({ message: \"Payment service is not configured\" });\n      }\n\n      const { accountNumber, bankCode } = req.body;\n\n      if (!accountNumber || !bankCode) {\n        return res.status(400).json({ message: \"Account number and bank code are required\" });\n      }\n\n      const accountDetails = await squad.verifyBankAccount(accountNumber, bankCode);\n      res.json(accountDetails);\n    } catch (error) {\n      console.error(\"Error verifying bank account:\", error);\n      res.status(500).json({ message: error instanceof Error ? error.message : \"Failed to verify bank account\" });\n    }\n  });\n\n  // Verify bank account (GET with query params)\n  app.get('/api/squad/verify-account', isAuthenticated, async (req: any, res) => {\n    try {\n      if (!isSquadConfigured()) {\n        return res.status(503).json({ message: \"Payment service is not configured\" });\n      }\n\n      const { accountNumber, bankCode } = req.query;\n\n      if (!accountNumber || !bankCode) {\n        return res.status(400).json({ message: \"Account number and bank code are required\" });\n      }\n\n      if (typeof accountNumber !== 'string' || accountNumber.length !== 10) {\n        return res.status(400).json({ message: \"Account number must be 10 digits\" });\n      }\n\n      if (typeof bankCode !== 'string') {\n        return res.status(400).json({ message: \"Bank code is required\" });\n      }\n\n      const accountDetails = await squad.verifyBankAccount(accountNumber, bankCode);\n      res.json(accountDetails);\n    } catch (error) {\n      console.error(\"Error verifying bank account:\", error);\n      res.status(500).json({ message: error instanceof Error ? error.message : \"Failed to verify bank account\" });\n    }\n  });\n\n  // Initiate withdrawal via Squad transfer\n  app.post('/api/squad/withdraw', isAuthenticated, async (req: any, res) => {\n    try {\n      if (!isSquadConfigured()) {\n        return res.status(503).json({ message: \"Payment service is not configured\" });\n      }\n\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const { amount, bankCode, bankName, accountNumber, accountName } = req.body;\n      const withdrawAmount = parseFloat(amount);\n\n      if (!withdrawAmount || withdrawAmount < 500) {\n        return res.status(400).json({ message: \"Minimum withdrawal is ₦500\" });\n      }\n\n      if (!bankCode || !bankName || !accountNumber || !accountName) {\n        return res.status(400).json({ message: \"Bank details are required\" });\n      }\n\n      const wallet = await storage.getOrCreateWallet(userId);\n      const balance = parseFloat(wallet.balance);\n\n      // Check if withdrawal is allowed\n      const withdrawalCheck = isWithdrawalAllowed(\n        withdrawAmount,\n        user.isVerified || false,\n        balance,\n        0\n      );\n\n      if (!withdrawalCheck.allowed) {\n        return res.status(400).json({ message: withdrawalCheck.reason });\n      }\n\n      // Generate transfer reference\n      const reference = generateTransferReference();\n\n      // Create transfer record\n      await storage.createSquadTransfer({\n        userId,\n        transactionReference: reference,\n        amount: withdrawAmount.toString(),\n        destinationBankCode: bankCode,\n        destinationAccountNumber: accountNumber,\n        destinationAccountName: accountName,\n        status: 'pending',\n      });\n\n      // Deduct from wallet first\n      await storage.updateWalletBalance(userId, withdrawAmount.toString(), 'subtract');\n\n      // Create pending transaction\n      await storage.createTransaction({\n        walletId: wallet.id,\n        type: 'withdrawal',\n        amount: withdrawAmount.toString(),\n        description: `Withdrawal to ${bankName} - ${accountNumber}`,\n        status: 'pending',\n      });\n\n      // Initiate transfer with Squad\n      try {\n        const transferResult = await squad.initiateTransfer({\n          amount: withdrawAmount,\n          transactionReference: reference,\n          remark: `EKSU Marketplace withdrawal - ${user.firstName} ${user.lastName}`,\n          bankCode,\n          accountNumber,\n          accountName,\n        });\n\n        // Update transfer status\n        await storage.updateSquadTransferStatus(\n          reference,\n          transferResult.transactionStatus,\n          undefined,\n          transferResult.transactionStatus === 'success' ? new Date() : undefined\n        );\n\n        res.json({\n          message: \"Withdrawal initiated successfully\",\n          reference,\n          status: transferResult.transactionStatus,\n        });\n      } catch (transferError) {\n        // Refund wallet if transfer fails\n        await storage.updateWalletBalance(userId, withdrawAmount.toString(), 'add');\n        await storage.updateSquadTransferStatus(reference, 'failed', String(transferError));\n        \n        throw transferError;\n      }\n    } catch (error) {\n      console.error(\"Error processing Squad withdrawal:\", error);\n      res.status(500).json({ message: error instanceof Error ? error.message : \"Failed to process withdrawal\" });\n    }\n  });\n\n  // ==================== NEGOTIATION ROUTES ====================\n\n  // Submit a price offer on a product\n  app.post('/api/negotiations', isAuthenticated, requireEmailVerified, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n\n      const { productId, offerPrice, message } = req.body;\n\n      // Validate required fields\n      if (!productId) {\n        return res.status(400).json({ message: \"Product ID is required\" });\n      }\n      if (!offerPrice || isNaN(parseFloat(offerPrice))) {\n        return res.status(400).json({ message: \"Valid offer price is required\" });\n      }\n\n      const offerPriceNum = parseFloat(offerPrice);\n\n      // Validate offer price is positive\n      if (offerPriceNum <= 0) {\n        return res.status(400).json({ message: \"Offer price must be greater than 0\" });\n      }\n\n      // Get the product and validate it exists\n      const product = await storage.getProduct(productId);\n      if (!product) {\n        return res.status(404).json({ message: \"Product not found\" });\n      }\n\n      // Check product is available\n      if (!product.isAvailable || product.isSold) {\n        return res.status(400).json({ message: \"Product is not available for negotiation\" });\n      }\n\n      // Validate buyer is not the seller\n      if (product.sellerId === userId) {\n        return res.status(400).json({ message: \"You cannot make an offer on your own product\" });\n      }\n\n      // Validate offer is not above original price\n      const originalPrice = parseFloat(product.price);\n      if (offerPriceNum > originalPrice) {\n        return res.status(400).json({ message: \"Offer price cannot be higher than the original price\" });\n      }\n\n      // Create the negotiation record\n      const negotiation = await storage.createNegotiation({\n        productId,\n        buyerId: userId,\n        sellerId: product.sellerId,\n        originalPrice: product.price,\n        offerPrice: offerPriceNum.toFixed(2),\n        buyerMessage: message || null,\n        status: 'pending',\n      });\n\n      // Return with product details\n      res.status(201).json({\n        ...negotiation,\n        product: {\n          id: product.id,\n          title: product.title,\n          price: product.price,\n          images: product.images,\n        },\n      });\n    } catch (error) {\n      console.error(\"Error creating negotiation:\", error);\n      res.status(500).json({ message: \"Failed to create negotiation\" });\n    }\n  });\n\n  // Get offers received on seller's products\n  app.get('/api/negotiations/received', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const statusFilter = req.query.status as string | undefined;\n\n      // Get all negotiations where user is the seller\n      const negotiations = await storage.getUserNegotiations(userId);\n      \n      // Filter to only received negotiations (where user is seller)\n      let receivedNegotiations = negotiations.filter(n => n.sellerId === userId);\n\n      // Apply status filter if provided\n      if (statusFilter) {\n        receivedNegotiations = receivedNegotiations.filter(n => n.status === statusFilter);\n      }\n\n      // Enrich with product and buyer details\n      const enrichedNegotiations = await Promise.all(\n        receivedNegotiations.map(async (negotiation) => {\n          const product = await storage.getProduct(negotiation.productId);\n          const buyer = await storage.getUser(negotiation.buyerId);\n          return {\n            ...negotiation,\n            product: product ? {\n              id: product.id,\n              title: product.title,\n              price: product.price,\n              images: product.images,\n            } : null,\n            buyer: buyer ? {\n              id: buyer.id,\n              firstName: buyer.firstName,\n              lastName: buyer.lastName,\n              profileImageUrl: buyer.profileImageUrl,\n            } : null,\n          };\n        })\n      );\n\n      res.json(enrichedNegotiations);\n    } catch (error) {\n      console.error(\"Error fetching received negotiations:\", error);\n      res.status(500).json({ message: \"Failed to fetch received negotiations\" });\n    }\n  });\n\n  // Get offers sent by buyer\n  app.get('/api/negotiations/sent', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n\n      // Get all negotiations where user is the buyer\n      const negotiations = await storage.getUserNegotiations(userId);\n      \n      // Filter to only sent negotiations (where user is buyer)\n      const sentNegotiations = negotiations.filter(n => n.buyerId === userId);\n\n      // Enrich with product and seller details\n      const enrichedNegotiations = await Promise.all(\n        sentNegotiations.map(async (negotiation) => {\n          const product = await storage.getProduct(negotiation.productId);\n          const seller = await storage.getUser(negotiation.sellerId);\n          return {\n            ...negotiation,\n            product: product ? {\n              id: product.id,\n              title: product.title,\n              price: product.price,\n              images: product.images,\n            } : null,\n            seller: seller ? {\n              id: seller.id,\n              firstName: seller.firstName,\n              lastName: seller.lastName,\n              profileImageUrl: seller.profileImageUrl,\n            } : null,\n          };\n        })\n      );\n\n      res.json(enrichedNegotiations);\n    } catch (error) {\n      console.error(\"Error fetching sent negotiations:\", error);\n      res.status(500).json({ message: \"Failed to fetch sent negotiations\" });\n    }\n  });\n\n  // Get single negotiation\n  app.get('/api/negotiations/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { id } = req.params;\n\n      const negotiation = await storage.getNegotiation(id);\n      if (!negotiation) {\n        return res.status(404).json({ message: \"Negotiation not found\" });\n      }\n\n      // Validate user is buyer or seller\n      if (negotiation.buyerId !== userId && negotiation.sellerId !== userId) {\n        return res.status(403).json({ message: \"You do not have access to this negotiation\" });\n      }\n\n      // Get product and user details\n      const product = await storage.getProduct(negotiation.productId);\n      const buyer = await storage.getUser(negotiation.buyerId);\n      const seller = await storage.getUser(negotiation.sellerId);\n\n      res.json({\n        ...negotiation,\n        product: product ? {\n          id: product.id,\n          title: product.title,\n          price: product.price,\n          images: product.images,\n          description: product.description,\n        } : null,\n        buyer: buyer ? {\n          id: buyer.id,\n          firstName: buyer.firstName,\n          lastName: buyer.lastName,\n          profileImageUrl: buyer.profileImageUrl,\n        } : null,\n        seller: seller ? {\n          id: seller.id,\n          firstName: seller.firstName,\n          lastName: seller.lastName,\n          profileImageUrl: seller.profileImageUrl,\n        } : null,\n      });\n    } catch (error) {\n      console.error(\"Error fetching negotiation:\", error);\n      res.status(500).json({ message: \"Failed to fetch negotiation\" });\n    }\n  });\n\n  // Accept an offer\n  app.post('/api/negotiations/:id/accept', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { id } = req.params;\n\n      const negotiation = await storage.getNegotiation(id);\n      if (!negotiation) {\n        return res.status(404).json({ message: \"Negotiation not found\" });\n      }\n\n      // Validate user is the seller\n      if (negotiation.sellerId !== userId) {\n        return res.status(403).json({ message: \"Only the seller can accept an offer\" });\n      }\n\n      // Validate negotiation is pending\n      if (negotiation.status !== 'pending') {\n        return res.status(400).json({ message: `Cannot accept a negotiation with status '${negotiation.status}'` });\n      }\n\n      // Update status to accepted\n      const updated = await storage.updateNegotiationStatus(id, 'accepted', {\n        acceptedAt: new Date(),\n      });\n\n      if (!updated) {\n        return res.status(500).json({ message: \"Failed to update negotiation\" });\n      }\n\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error accepting negotiation:\", error);\n      res.status(500).json({ message: \"Failed to accept negotiation\" });\n    }\n  });\n\n  // Reject an offer\n  app.post('/api/negotiations/:id/reject', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { id } = req.params;\n\n      const negotiation = await storage.getNegotiation(id);\n      if (!negotiation) {\n        return res.status(404).json({ message: \"Negotiation not found\" });\n      }\n\n      // Validate user is the seller\n      if (negotiation.sellerId !== userId) {\n        return res.status(403).json({ message: \"Only the seller can reject an offer\" });\n      }\n\n      // Validate negotiation is pending\n      if (negotiation.status !== 'pending') {\n        return res.status(400).json({ message: `Cannot reject a negotiation with status '${negotiation.status}'` });\n      }\n\n      // Update status to rejected\n      const updated = await storage.updateNegotiationStatus(id, 'rejected', {\n        rejectedAt: new Date(),\n      });\n\n      if (!updated) {\n        return res.status(500).json({ message: \"Failed to update negotiation\" });\n      }\n\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error rejecting negotiation:\", error);\n      res.status(500).json({ message: \"Failed to reject negotiation\" });\n    }\n  });\n\n  // Counter offer\n  app.post('/api/negotiations/:id/counter', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { id } = req.params;\n      const { counterPrice, counterMessage } = req.body;\n\n      // Validate counter price\n      if (!counterPrice || isNaN(parseFloat(counterPrice))) {\n        return res.status(400).json({ message: \"Valid counter price is required\" });\n      }\n\n      const counterPriceNum = parseFloat(counterPrice);\n      if (counterPriceNum <= 0) {\n        return res.status(400).json({ message: \"Counter price must be greater than 0\" });\n      }\n\n      const negotiation = await storage.getNegotiation(id);\n      if (!negotiation) {\n        return res.status(404).json({ message: \"Negotiation not found\" });\n      }\n\n      // Validate user is the seller\n      if (negotiation.sellerId !== userId) {\n        return res.status(403).json({ message: \"Only the seller can make a counter offer\" });\n      }\n\n      // Validate negotiation is pending\n      if (negotiation.status !== 'pending') {\n        return res.status(400).json({ message: `Cannot counter a negotiation with status '${negotiation.status}'` });\n      }\n\n      // Validate counter price is reasonable (should be between offer and original price)\n      const offerPriceNum = parseFloat(negotiation.offerPrice);\n      const originalPriceNum = parseFloat(negotiation.originalPrice);\n      \n      if (counterPriceNum < offerPriceNum) {\n        return res.status(400).json({ message: \"Counter price cannot be lower than the buyer's offer\" });\n      }\n      if (counterPriceNum > originalPriceNum) {\n        return res.status(400).json({ message: \"Counter price cannot be higher than the original price\" });\n      }\n\n      // Update status to countered\n      const updated = await storage.updateNegotiationStatus(id, 'countered', {\n        counterOfferPrice: counterPriceNum.toFixed(2),\n        sellerMessage: counterMessage || null,\n        rejectedAt: new Date(), // Using rejectedAt as respondedAt for counter offers\n      });\n\n      if (!updated) {\n        return res.status(500).json({ message: \"Failed to update negotiation\" });\n      }\n\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error creating counter offer:\", error);\n      res.status(500).json({ message: \"Failed to create counter offer\" });\n    }\n  });\n\n  // Cancel an offer (buyer only)\n  app.post('/api/negotiations/:id/cancel', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { id } = req.params;\n\n      const negotiation = await storage.getNegotiation(id);\n      if (!negotiation) {\n        return res.status(404).json({ message: \"Negotiation not found\" });\n      }\n\n      // Validate user is the buyer\n      if (negotiation.buyerId !== userId) {\n        return res.status(403).json({ message: \"Only the buyer can cancel an offer\" });\n      }\n\n      // Validate negotiation is pending\n      if (negotiation.status !== 'pending') {\n        return res.status(400).json({ message: `Cannot cancel a negotiation with status '${negotiation.status}'` });\n      }\n\n      // Update status to cancelled\n      const updated = await storage.updateNegotiationStatus(id, 'cancelled', {});\n\n      if (!updated) {\n        return res.status(500).json({ message: \"Failed to update negotiation\" });\n      }\n\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error cancelling negotiation:\", error);\n      res.status(500).json({ message: \"Failed to cancel negotiation\" });\n    }\n  });\n\n  // ==================== PRICING API ROUTES ====================\n\n  // Calculate pricing from seller price\n  app.post('/api/pricing/calculate', (req, res) => {\n    try {\n      const { sellerPrice, paymentMethod } = req.body;\n      \n      if (!sellerPrice || isNaN(parseFloat(sellerPrice))) {\n        return res.status(400).json({ message: \"Valid seller price is required\" });\n      }\n\n      const pricing = calculatePricingFromSellerPrice(\n        parseFloat(sellerPrice),\n        paymentMethod || 'CARD'\n      );\n\n      res.json(pricing);\n    } catch (error) {\n      console.error(\"Error calculating pricing:\", error);\n      res.status(500).json({ message: \"Failed to calculate pricing\" });\n    }\n  });\n\n  // Get current commission rate and config\n  app.get('/api/pricing/config', (req, res) => {\n    res.json({\n      commissionRate: getCommissionRate(),\n      securityDepositAmount: getSecurityDepositAmount(),\n    });\n  });\n\n  // Role switcher\n  app.put('/api/users/role', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const validated = roleUpdateSchema.parse(req.body);\n\n      const user = await storage.updateUserProfile(userId, { role: validated.role });\n      \n      // Create seller analytics if switching to seller\n      if (validated.role === 'seller') {\n        await storage.getOrCreateSellerAnalytics(userId);\n      }\n\n      res.json(user);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid input\", errors: error.errors });\n      }\n      console.error(\"Error updating role:\", error);\n      res.status(500).json({ message: \"Failed to update role\" });\n    }\n  });\n\n  // Referral routes\n  app.get('/api/referrals', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const referrals = await storage.getUserReferrals(userId);\n      res.json(referrals);\n    } catch (error) {\n      console.error(\"Error fetching referrals:\", error);\n      res.status(500).json({ message: \"Failed to fetch referrals\" });\n    }\n  });\n\n  app.post('/api/referrals', isAuthenticated, async (req: any, res) => {\n    try {\n      const referrerId = req.user.id;\n      const validated = createReferralSchema.parse(req.body);\n      \n      // Create referral first - this validates no duplicates/self-referral\n      const referral = await storage.createReferral(referrerId, validated.referredUserId);\n      \n      // Only proceed with payment if referral creation succeeded\n      const wallet = await storage.getOrCreateWallet(referrerId);\n      const updatedWallet = await storage.updateWalletBalance(referrerId, '500', 'add');\n      \n      await storage.createTransaction({\n        walletId: wallet.id,\n        type: 'referral_bonus',\n        amount: '500',\n        description: 'Referral bonus',\n        relatedUserId: validated.referredUserId,\n        status: 'completed',\n      });\n      \n      await storage.markReferralPaid(referral.id);\n\n      res.json({ ...referral, newBalance: updatedWallet.balance });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid input\", errors: error.errors });\n      }\n      console.error(\"Error creating referral:\", error);\n      res.status(500).json({ message: error instanceof Error ? error.message : \"Failed to create referral\" });\n    }\n  });\n\n  // Login streak rate limiting store (in-memory, per-user tracking)\n  const loginStreakRateLimits: Map<string, { count: number; windowStart: number }> = new Map();\n  const STREAK_RATE_LIMIT_WINDOW_MS = 60 * 1000; // 1 minute window\n  const STREAK_RATE_LIMIT_MAX_REQUESTS = 5; // Max 5 requests per minute per user\n\n  // Helper function to get client IP address\n  function getClientIp(req: any): string {\n    // Check for forwarded headers (common in reverse proxy setups)\n    const forwarded = req.headers['x-forwarded-for'];\n    if (forwarded) {\n      // x-forwarded-for can contain multiple IPs, take the first one\n      const ips = forwarded.split(',').map((ip: string) => ip.trim());\n      return ips[0];\n    }\n    // Fallback to direct connection IP\n    return req.ip || req.connection?.remoteAddress || 'unknown';\n  }\n\n  // Helper function to check rate limit\n  function checkStreakRateLimit(userId: string): { allowed: boolean; remaining: number; resetIn: number } {\n    const now = Date.now();\n    const userLimit = loginStreakRateLimits.get(userId);\n    \n    if (!userLimit || (now - userLimit.windowStart) > STREAK_RATE_LIMIT_WINDOW_MS) {\n      // New window or expired window\n      loginStreakRateLimits.set(userId, { count: 1, windowStart: now });\n      return { allowed: true, remaining: STREAK_RATE_LIMIT_MAX_REQUESTS - 1, resetIn: STREAK_RATE_LIMIT_WINDOW_MS };\n    }\n    \n    if (userLimit.count >= STREAK_RATE_LIMIT_MAX_REQUESTS) {\n      const resetIn = STREAK_RATE_LIMIT_WINDOW_MS - (now - userLimit.windowStart);\n      return { allowed: false, remaining: 0, resetIn };\n    }\n    \n    userLimit.count++;\n    loginStreakRateLimits.set(userId, userLimit);\n    return { allowed: true, remaining: STREAK_RATE_LIMIT_MAX_REQUESTS - userLimit.count, resetIn: STREAK_RATE_LIMIT_WINDOW_MS - (now - userLimit.windowStart) };\n  }\n\n  // Login streak routes\n  app.post('/api/login-streak', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      \n      // Check rate limit\n      const rateCheck = checkStreakRateLimit(userId);\n      if (!rateCheck.allowed) {\n        console.log(`Rate limit exceeded for user ${userId}. Reset in ${rateCheck.resetIn}ms`);\n        return res.status(429).json({ \n          message: \"Too many requests. Please try again later.\",\n          retryAfter: Math.ceil(rateCheck.resetIn / 1000),\n          remaining: 0\n        });\n      }\n      \n      // Get client IP address for security tracking\n      const ipAddress = getClientIp(req);\n      \n      // Update login streak with IP tracking\n      const result = await storage.updateLoginStreak(userId, ipAddress);\n      \n      // Include rate limit info in response\n      res.json({\n        ...result,\n        rateLimit: {\n          remaining: rateCheck.remaining,\n          resetIn: rateCheck.resetIn\n        }\n      });\n    } catch (error) {\n      console.error(\"Error updating login streak:\", error);\n      res.status(500).json({ message: \"Failed to update login streak\" });\n    }\n  });\n\n  app.get('/api/login-streak', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const streak = await storage.getOrCreateLoginStreak(userId);\n      res.json(streak);\n    } catch (error) {\n      console.error(\"Error fetching login streak:\", error);\n      res.status(500).json({ message: \"Failed to fetch login streak\" });\n    }\n  });\n\n  // Saved searches\n  app.get('/api/saved-searches', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const searches = await storage.getUserSavedSearches(userId);\n      res.json(searches);\n    } catch (error) {\n      console.error(\"Error fetching saved searches:\", error);\n      res.status(500).json({ message: \"Failed to fetch saved searches\" });\n    }\n  });\n\n  app.post('/api/saved-searches', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const validated = createSavedSearchSchema.parse({ ...req.body, userId });\n      const search = await storage.createSavedSearch(validated);\n      res.json(search);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid input\", errors: error.errors });\n      }\n      console.error(\"Error saving search:\", error);\n      res.status(500).json({ message: \"Failed to save search\" });\n    }\n  });\n\n  app.delete('/api/saved-searches/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      await storage.deleteSavedSearch(req.params.id);\n      res.json({ message: \"Search deleted\" });\n    } catch (error) {\n      console.error(\"Error deleting search:\", error);\n      res.status(500).json({ message: \"Failed to delete search\" });\n    }\n  });\n\n  // Draft products\n  app.get('/api/drafts', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const drafts = await storage.getUserDrafts(userId);\n      res.json(drafts);\n    } catch (error) {\n      console.error(\"Error fetching drafts:\", error);\n      res.status(500).json({ message: \"Failed to fetch drafts\" });\n    }\n  });\n\n  app.post('/api/drafts', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const validated = saveDraftSchema.parse(req.body);\n      const draft = await storage.saveDraft(userId, validated);\n      res.json(draft);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid input\", errors: error.errors });\n      }\n      console.error(\"Error saving draft:\", error);\n      res.status(500).json({ message: \"Failed to save draft\" });\n    }\n  });\n\n  app.delete('/api/drafts/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      await storage.deleteDraft(req.params.id);\n      res.json({ message: \"Draft deleted\" });\n    } catch (error) {\n      console.error(\"Error deleting draft:\", error);\n      res.status(500).json({ message: \"Failed to delete draft\" });\n    }\n  });\n\n  // Scheduled posts\n  app.get('/api/scheduled-posts', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const posts = await storage.getUserScheduledPosts(userId);\n      res.json(posts);\n    } catch (error) {\n      console.error(\"Error fetching scheduled posts:\", error);\n      res.status(500).json({ message: \"Failed to fetch scheduled posts\" });\n    }\n  });\n\n  app.post('/api/scheduled-posts', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const validated = createScheduledPostSchema.parse({ ...req.body, sellerId: userId });\n      const post = await storage.createScheduledPost(validated);\n      res.json(post);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid input\", errors: error.errors });\n      }\n      console.error(\"Error creating scheduled post:\", error);\n      res.status(500).json({ message: \"Failed to create scheduled post\" });\n    }\n  });\n\n  // Boost requests\n  app.get('/api/boosts', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const boosts = await storage.getUserBoostRequests(userId);\n      res.json(boosts);\n    } catch (error) {\n      console.error(\"Error fetching boosts:\", error);\n      res.status(500).json({ message: \"Failed to fetch boosts\" });\n    }\n  });\n\n  app.post('/api/boosts', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      \n      // Check KYC verification - sellers must be verified before boosting products\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(401).json({ message: \"User not found\" });\n      }\n      \n      if (!user.isVerified && !user.ninVerified) {\n        return res.status(403).json({ \n          message: \"Please complete identity verification before boosting products. Go to Settings > KYC Verification to get started.\" \n        });\n      }\n      \n      const validated = createBoostSchema.parse(req.body);\n      \n      // Verify sufficient balance before deducting\n      const wallet = await storage.getOrCreateWallet(userId);\n      const currentBalance = parseFloat(wallet.balance);\n      const boostCost = parseFloat(validated.amount);\n      \n      if (currentBalance < boostCost) {\n        return res.status(400).json({ \n          message: `Insufficient balance. Available: ₦${currentBalance}, Required: ₦${boostCost}` \n        });\n      }\n      \n      // Calculate expiry\n      const expiresAt = new Date();\n      expiresAt.setHours(expiresAt.getHours() + validated.duration);\n\n      // Deduct from wallet first\n      const updatedWallet = await storage.updateWalletBalance(userId, validated.amount, 'subtract');\n      \n      // Then create boost request\n      const boost = await storage.createBoostRequest({\n        productId: validated.productId,\n        sellerId: userId,\n        type: validated.type,\n        duration: validated.duration,\n        amount: validated.amount,\n        expiresAt,\n      });\n\n      // Log transaction\n      await storage.createTransaction({\n        walletId: wallet.id,\n        type: 'boost_payment',\n        amount: validated.amount,\n        description: `${validated.type} listing for ${validated.duration} hours`,\n        relatedProductId: validated.productId,\n        status: 'completed',\n      });\n\n      res.json({ ...boost, newBalance: updatedWallet.balance });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid input\", errors: error.errors });\n      }\n      console.error(\"Error creating boost:\", error);\n      res.status(500).json({ message: error instanceof Error ? error.message : \"Failed to create boost\" });\n    }\n  });\n\n  // Disputes\n  app.get('/api/disputes', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const disputes = await storage.getUserDisputes(userId);\n      res.json(disputes);\n    } catch (error) {\n      console.error(\"Error fetching disputes:\", error);\n      res.status(500).json({ message: \"Failed to fetch disputes\" });\n    }\n  });\n\n  app.post('/api/disputes', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const validated = createDisputeSchema.parse({ ...req.body, buyerId: userId });\n      const dispute = await storage.createDispute(validated);\n      res.json(dispute);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid input\", errors: error.errors });\n      }\n      console.error(\"Error creating dispute:\", error);\n      res.status(500).json({ message: \"Failed to create dispute\" });\n    }\n  });\n\n  // Support tickets\n  app.get('/api/support', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const tickets = await storage.getUserSupportTickets(userId);\n      res.json(tickets);\n    } catch (error) {\n      console.error(\"Error fetching tickets:\", error);\n      res.status(500).json({ message: \"Failed to fetch tickets\" });\n    }\n  });\n\n  app.post('/api/support', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const validated = createSupportTicketSchema.parse({ ...req.body, userId });\n      const ticket = await storage.createSupportTicketWithNumber(validated);\n      res.json(ticket);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid input\", errors: error.errors });\n      }\n      console.error(\"Error creating ticket:\", error);\n      res.status(500).json({ message: \"Failed to create ticket\" });\n    }\n  });\n\n  // Get single ticket with replies\n  app.get('/api/support/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { id } = req.params;\n      const ticket = await storage.getSupportTicketById(id);\n      \n      if (!ticket) {\n        return res.status(404).json({ message: \"Ticket not found\" });\n      }\n      \n      // Check if user exists\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(401).json({ message: \"User not found\" });\n      }\n      \n      // Check if user owns the ticket or is admin\n      if (ticket.userId !== userId && user.role !== 'admin') {\n        return res.status(403).json({ message: \"Not authorized to view this ticket\" });\n      }\n      \n      const replies = await storage.getTicketReplies(id);\n      res.json({ ...ticket, replies });\n    } catch (error) {\n      console.error(\"Error fetching ticket:\", error);\n      res.status(500).json({ message: \"Failed to fetch ticket\" });\n    }\n  });\n\n  // Add reply to ticket\n  app.post('/api/support/:id/reply', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { id: ticketId } = req.params;\n      const { message } = req.body;\n      \n      if (!message || message.trim().length < 5) {\n        return res.status(400).json({ message: \"Reply must be at least 5 characters\" });\n      }\n      \n      const ticket = await storage.getSupportTicketById(ticketId);\n      if (!ticket) {\n        return res.status(404).json({ message: \"Ticket not found\" });\n      }\n      \n      // Check if user exists and get their role\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(401).json({ message: \"User not found\" });\n      }\n      \n      const isAdmin = user.role === 'admin';\n      \n      // Check if user owns the ticket or is admin\n      if (ticket.userId !== userId && !isAdmin) {\n        return res.status(403).json({ message: \"Not authorized to reply to this ticket\" });\n      }\n      \n      const reply = await storage.createTicketReply({\n        ticketId,\n        userId,\n        message: message.trim(),\n        isAdminReply: isAdmin,\n      });\n      \n      // If admin replied, update ticket status to in_progress\n      if (isAdmin) {\n        await storage.updateSupportTicket(ticketId, { status: 'in_progress' });\n      }\n      \n      // Return reply with user info\n      res.json({\n        ...reply,\n        user: {\n          id: user.id,\n          username: user.username,\n          profileImageUrl: user.profileImageUrl,\n        }\n      });\n    } catch (error) {\n      console.error(\"Error adding reply:\", error);\n      res.status(500).json({ message: \"Failed to add reply\" });\n    }\n  });\n\n  // Create ticket from chatbot handoff\n  app.post('/api/tickets/create', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { subject, message, category, chatHistory } = req.body;\n      \n      if (!message || message.trim().length < 10) {\n        return res.status(400).json({ message: \"Message must be at least 10 characters\" });\n      }\n      \n      // Create ticket with chat history context\n      const fullMessage = chatHistory \n        ? `${message}\\n\\n--- Previous Chat Context ---\\n${chatHistory}`\n        : message;\n      \n      const ticket = await storage.createSupportTicketWithNumber({\n        userId,\n        subject: subject || \"Issue from Chatbot\",\n        message: fullMessage,\n        category: category || \"technical\",\n        priority: \"medium\",\n      });\n      \n      res.json({\n        success: true,\n        ticketId: ticket.id,\n        ticketNumber: ticket.ticketNumber,\n        message: `Ticket ${ticket.ticketNumber} created successfully. You can track it in My Tickets.`,\n      });\n    } catch (error) {\n      console.error(\"Error creating ticket from chatbot:\", error);\n      res.status(500).json({ message: \"Failed to create ticket\" });\n    }\n  });\n\n  // Check if user has open tickets (for chatbot)\n  app.get('/api/tickets/status', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const openCount = await storage.getUserOpenTicketCount(userId);\n      const tickets = await storage.getUserSupportTickets(userId);\n      \n      res.json({\n        hasOpenTickets: openCount > 0,\n        openTicketCount: openCount,\n        recentTickets: tickets.slice(0, 5),\n      });\n    } catch (error) {\n      console.error(\"Error checking ticket status:\", error);\n      res.status(500).json({ message: \"Failed to check ticket status\" });\n    }\n  });\n\n  // Admin: Get all support tickets\n  app.get('/api/admin/tickets', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== 'admin') {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n      \n      const { status, priority, category, page = 1, limit = 20 } = req.query;\n      const allTickets = await storage.getAllSupportTickets();\n      \n      // Filter tickets based on query params\n      let filteredTickets = allTickets;\n      if (status) {\n        filteredTickets = filteredTickets.filter(t => t.status === status);\n      }\n      if (priority) {\n        filteredTickets = filteredTickets.filter(t => t.priority === priority);\n      }\n      if (category) {\n        filteredTickets = filteredTickets.filter(t => t.category === category);\n      }\n      \n      // Pagination\n      const pageNum = parseInt(page as string) || 1;\n      const limitNum = parseInt(limit as string) || 20;\n      const offset = (pageNum - 1) * limitNum;\n      const paginatedTickets = filteredTickets.slice(offset, offset + limitNum);\n      \n      // Get user info for each ticket\n      const ticketsWithUsers = await Promise.all(\n        paginatedTickets.map(async (ticket) => {\n          const ticketUser = await storage.getUser(ticket.userId);\n          return {\n            ...ticket,\n            user: ticketUser ? { \n              id: ticketUser.id, \n              username: ticketUser.username, \n              email: ticketUser.email,\n              profileImageUrl: ticketUser.profileImageUrl \n            } : null,\n          };\n        })\n      );\n      \n      res.json({\n        tickets: ticketsWithUsers,\n        total: filteredTickets.length,\n        page: pageNum,\n        totalPages: Math.ceil(filteredTickets.length / limitNum),\n      });\n    } catch (error) {\n      console.error(\"Error fetching admin tickets:\", error);\n      res.status(500).json({ message: \"Failed to fetch tickets\" });\n    }\n  });\n\n  // Admin: Update ticket status/priority\n  app.patch('/api/admin/tickets/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== 'admin') {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n      \n      const { id } = req.params;\n      const { status, priority, assignedTo } = req.body;\n      \n      const updateData: any = {};\n      if (status) updateData.status = status;\n      if (priority) updateData.priority = priority;\n      if (assignedTo !== undefined) updateData.assignedTo = assignedTo;\n      \n      const ticket = await storage.updateSupportTicket(id, updateData);\n      res.json(ticket);\n    } catch (error) {\n      console.error(\"Error updating ticket:\", error);\n      res.status(500).json({ message: \"Failed to update ticket\" });\n    }\n  });\n\n  // Admin: Get ticket stats\n  app.get('/api/admin/tickets/stats', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== 'admin') {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n      \n      const allTickets = await storage.getAllSupportTickets();\n      \n      const stats = {\n        total: allTickets.length,\n        open: allTickets.filter(t => t.status === 'open').length,\n        pending: allTickets.filter(t => t.status === 'pending').length,\n        inProgress: allTickets.filter(t => t.status === 'in_progress').length,\n        resolved: allTickets.filter(t => t.status === 'resolved').length,\n        closed: allTickets.filter(t => t.status === 'closed').length,\n        byPriority: {\n          low: allTickets.filter(t => t.priority === 'low').length,\n          medium: allTickets.filter(t => t.priority === 'medium').length,\n          high: allTickets.filter(t => t.priority === 'high').length,\n          urgent: allTickets.filter(t => t.priority === 'urgent').length,\n        },\n        byCategory: {\n          technical: allTickets.filter(t => t.category === 'technical').length,\n          payment: allTickets.filter(t => t.category === 'payment').length,\n          account: allTickets.filter(t => t.category === 'account').length,\n          scam_report: allTickets.filter(t => t.category === 'scam_report').length,\n          general: allTickets.filter(t => t.category === 'general').length,\n        },\n      };\n      \n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching ticket stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch stats\" });\n    }\n  });\n\n  // Seller analytics\n  app.get('/api/seller/analytics', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const analytics = await storage.getOrCreateSellerAnalytics(userId);\n      res.json(analytics);\n    } catch (error) {\n      console.error(\"Error fetching analytics:\", error);\n      res.status(500).json({ message: \"Failed to fetch analytics\" });\n    }\n  });\n\n  // WebSocket token endpoint - generates a signed token for WebSocket authentication\n  app.get(\"/api/auth/ws-token\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      // Generate a short-lived JWT token (15 minutes)\n      const token = jwt.sign(\n        { userId, purpose: \"websocket\" },\n        process.env.SESSION_SECRET!,\n        { expiresIn: \"15m\" }\n      );\n\n      res.json({ token });\n    } catch (error) {\n      console.error(\"Error generating WebSocket token:\", error);\n      res.status(500).json({ message: \"Failed to generate token\" });\n    }\n  });\n\n  // Category routes\n  app.get(\"/api/categories\", async (req, res) => {\n    try {\n      const categories = await storage.getCategories();\n      res.json(categories);\n    } catch (error) {\n      console.error(\"Error fetching categories:\", error);\n      res.status(500).json({ message: \"Failed to fetch categories\" });\n    }\n  });\n\n  // Product routes\n  app.get(\"/api/products\", async (req, res) => {\n    try {\n      const { search, category, condition, location, sellerId } = req.query;\n      const products = await storage.getProducts({\n        search: search as string,\n        categoryId: category as string,\n        condition: condition as string,\n        location: location as string,\n        sellerId: sellerId as string,\n      });\n      \n      // Include seller's location settings for distance calculation\n      const productsWithSellerSettings = await Promise.all(\n        products.map(async (product) => {\n          try {\n            const sellerSettings = await storage.getOrCreateUserSettings(product.sellerId);\n            return {\n              ...product,\n              sellerSettings: sellerSettings.locationVisible ? {\n                latitude: sellerSettings.latitude,\n                longitude: sellerSettings.longitude,\n                locationVisible: sellerSettings.locationVisible,\n              } : null,\n            };\n          } catch (err) {\n            return { ...product, sellerSettings: null };\n          }\n        })\n      );\n      \n      res.json(productsWithSellerSettings);\n    } catch (error) {\n      console.error(\"Error fetching products:\", error);\n      res.status(500).json({ message: \"Failed to fetch products\" });\n    }\n  });\n\n  app.get(\"/api/products/my-listings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      const products = await storage.getSellerProducts(userId);\n      res.json(products);\n    } catch (error) {\n      console.error(\"Error fetching seller products:\", error);\n      res.status(500).json({ message: \"Failed to fetch products\" });\n    }\n  });\n\n  app.get(\"/api/products/seller\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      const products = await storage.getSellerProducts(userId);\n      res.json(products);\n    } catch (error) {\n      console.error(\"Error fetching seller products:\", error);\n      res.status(500).json({ message: \"Failed to fetch products\" });\n    }\n  });\n\n  app.get(\"/api/products/:id\", async (req: any, res) => {\n    try {\n      const product = await storage.getProduct(req.params.id);\n      if (!product) {\n        return res.status(404).json({ message: \"Product not found\" });\n      }\n      \n      // Generate viewer ID for unique view tracking\n      const userId = getUserId(req);\n      let viewerId: string;\n      \n      if (userId) {\n        // Use user ID for logged-in users\n        viewerId = `user_${userId}`;\n      } else {\n        // For guests, create a hash from IP address and session ID\n        const ip = req.ip || req.headers['x-forwarded-for'] || 'unknown';\n        const sessionId = req.sessionID || req.headers['user-agent'] || 'unknown';\n        const combined = `${ip}_${sessionId}`;\n        viewerId = `guest_${crypto.createHash('sha256').update(combined).digest('hex').substring(0, 32)}`;\n      }\n      \n      // Record unique view (only increments if this viewer hasn't seen this product before)\n      try {\n        await storage.recordUniqueProductView(req.params.id, viewerId);\n      } catch (viewError) {\n        // Log but don't fail the request if view tracking fails\n        console.error(\"Error recording product view:\", viewError);\n      }\n      \n      // Include seller's location settings for distance calculation\n      let sellerSettings = null;\n      try {\n        const settings = await storage.getOrCreateUserSettings(product.sellerId);\n        if (settings.locationVisible) {\n          sellerSettings = {\n            latitude: settings.latitude,\n            longitude: settings.longitude,\n            locationVisible: settings.locationVisible,\n          };\n        }\n      } catch (err) {\n        console.error(\"Error fetching seller settings:\", err);\n      }\n      \n      res.json({ ...product, sellerSettings });\n    } catch (error) {\n      console.error(\"Error fetching product:\", error);\n      res.status(500).json({ message: \"Failed to fetch product\" });\n    }\n  });\n\n  app.post(\"/api/products\", isAuthenticated, upload.array(\"images\", 10), async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(401).json({ message: \"User not found\" });\n      }\n      \n      if (user.role !== \"seller\" && user.role !== \"admin\") {\n        return res.status(403).json({ \n          message: \"Only sellers can create listings. Please update your role to 'Seller' in your profile settings.\" \n        });\n      }\n\n      // Check KYC verification - sellers must be verified before listing products\n      if (!user.isVerified && !user.ninVerified) {\n        return res.status(403).json({ \n          message: \"Please complete identity verification before listing products. Go to Settings > KYC Verification to get started.\" \n        });\n      }\n\n      // Enforce email verification - unverified users can only create limited listings\n      if (!user.emailVerified && user.role !== \"admin\" && !isSuperAdmin(userId)) {\n        // Count user's existing products\n        const existingProducts = await storage.getSellerProducts(userId);\n        if (existingProducts.length >= MAX_LISTINGS_UNVERIFIED) {\n          return res.status(403).json({ \n            message: `Please verify your email to create more listings. Unverified accounts are limited to ${MAX_LISTINGS_UNVERIFIED} listings.`,\n            code: \"EMAIL_NOT_VERIFIED\",\n            action: \"verify_email\"\n          });\n        }\n      }\n\n      // Parse the product data from FormData\n      let productData;\n      try {\n        productData = JSON.parse(req.body.data || \"{}\");\n      } catch (parseError) {\n        return res.status(400).json({ message: \"Invalid product data format\" });\n      }\n\n      // Validate with Zod schema\n      const validationResult = insertProductSchema.safeParse(productData);\n      if (!validationResult.success) {\n        const errors = validationResult.error.flatten();\n        const errorMessages = Object.entries(errors.fieldErrors)\n          .map(([field, msgs]) => `${field}: ${(msgs as string[]).join(\", \")}`)\n          .join(\"; \");\n        console.log(\"Product validation failed:\", errors);\n        return res.status(400).json({ \n          message: errorMessages || \"Validation failed\",\n          errors: errors.fieldErrors\n        });\n      }\n\n      const validated = validationResult.data;\n\n      // Upload images to object storage\n      const files = req.files as Express.Multer.File[];\n      if (!files || files.length === 0) {\n        return res.status(400).json({ message: \"At least one product image is required\" });\n      }\n\n      const prefix = `products/${userId}/`;\n      const images = await uploadMultipleToObjectStorage(files, prefix);\n      \n      if (images.length === 0) {\n        return res.status(500).json({ message: \"Failed to upload product images\" });\n      }\n\n      const product = await storage.createProduct({\n        ...validated,\n        sellerId: userId,\n        images,\n      });\n\n      res.json(product);\n    } catch (error: any) {\n      console.error(\"Error creating product:\", error);\n      res.status(500).json({ message: error.message || \"Failed to create product\" });\n    }\n  });\n\n  app.put(\"/api/products/:id\", isAuthenticated, upload.array(\"images\", 10), async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      // Check ownership\n      const existing = await storage.getProduct(req.params.id);\n      if (!existing || existing.sellerId !== userId) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const productData = JSON.parse(req.body.data || \"{}\");\n      \n      // Upload new images to object storage if any\n      const files = req.files as Express.Multer.File[];\n      let newImages: string[] = [];\n      \n      if (files && files.length > 0) {\n        const prefix = `products/${userId}/`;\n        newImages = await uploadMultipleToObjectStorage(files, prefix);\n      }\n\n      // Handle images: use client-provided images (with removed ones excluded) + new uploads\n      const clientImages = productData.images || existing.images || [];\n      const finalImages = [...clientImages, ...newImages];\n\n      const updateData = {\n        ...productData,\n        images: finalImages.length > 0 ? finalImages : existing.images,\n      };\n\n      const updated = await storage.updateProduct(req.params.id, updateData);\n      res.json(updated);\n    } catch (error: any) {\n      console.error(\"Error updating product:\", error);\n      res.status(400).json({ message: error.message || \"Failed to update product\" });\n    }\n  });\n\n  app.delete(\"/api/products/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const product = await storage.getProduct(req.params.id);\n      if (!product || product.sellerId !== userId) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      await storage.deleteProduct(req.params.id);\n      res.json({ message: \"Product deleted\" });\n    } catch (error) {\n      console.error(\"Error deleting product:\", error);\n      res.status(500).json({ message: \"Failed to delete product\" });\n    }\n  });\n\n  // Mark product as sold\n  app.post(\"/api/products/:id/sold\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const product = await storage.getProduct(req.params.id);\n      if (!product || product.sellerId !== userId) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const updated = await storage.updateProduct(req.params.id, {\n        isSold: true,\n        isAvailable: false,\n      });\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error marking product as sold:\", error);\n      res.status(500).json({ message: \"Failed to mark product as sold\" });\n    }\n  });\n\n  // Toggle product availability (pause/unpause)\n  app.post(\"/api/products/:id/toggle-visibility\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const product = await storage.getProduct(req.params.id);\n      if (!product || product.sellerId !== userId) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const updated = await storage.updateProduct(req.params.id, {\n        isAvailable: !product.isAvailable,\n      });\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error toggling product visibility:\", error);\n      res.status(500).json({ message: \"Failed to toggle product visibility\" });\n    }\n  });\n\n  // Get seller products with analytics (inquiries count)\n  app.get(\"/api/seller/products\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const products = await storage.getSellerProductsWithAnalytics(userId);\n      res.json(products);\n    } catch (error) {\n      console.error(\"Error fetching seller products:\", error);\n      res.status(500).json({ message: \"Failed to fetch products\" });\n    }\n  });\n\n  // Online status endpoint - returns which users are currently online\n  app.get(\"/api/users/online-status\", async (req, res) => {\n    try {\n      const onlineUserIds = getOnlineUserIds();\n      res.json({ onlineUserIds });\n    } catch (error) {\n      console.error(\"Error fetching online status:\", error);\n      res.status(500).json({ message: \"Failed to fetch online status\" });\n    }\n  });\n\n  // User profile routes\n  app.get(\"/api/users/:id\", async (req: any, res) => {\n    try {\n      const targetUserId = req.params.id;\n      const user = await storage.getUser(targetUserId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      // Check if the viewer is authenticated and if they're blocked by the target user\n      const viewerId = getUserId(req);\n      if (viewerId && viewerId !== targetUserId) {\n        // Check if the target user has blocked the viewer\n        const isBlockedByTarget = await storage.isUserBlocked(targetUserId, viewerId);\n        \n        if (isBlockedByTarget) {\n          // Return limited info when blocked\n          return res.json({\n            id: user.id,\n            firstName: \"Blocked User\",\n            lastName: \"\",\n            profileImageUrl: null,\n            isBlocked: true,\n            blockedByUser: true,\n          });\n        }\n      }\n      \n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n\n  app.put(\"/api/users/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId || userId !== req.params.id) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const updated = await storage.updateUserProfile(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating user:\", error);\n      res.status(500).json({ message: \"Failed to update user\" });\n    }\n  });\n\n  // Image upload endpoint - now uses object storage for persistence\n  app.post(\"/api/upload\", isAuthenticated, upload.single(\"image\"), async (req: any, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No image file provided\" });\n      }\n\n      const userId = getUserId(req);\n      const prefix = userId ? `profiles/${userId}/` : \"uploads/\";\n      \n      // Upload to object storage - returns Cloudinary URL or local path\n      const imageUrl = await uploadToObjectStorage(req.file, prefix);\n      \n      if (!imageUrl) {\n        return res.status(500).json({ message: \"Failed to upload image to storage\" });\n      }\n\n      res.json({ url: imageUrl });\n    } catch (error) {\n      console.error(\"Error uploading image:\", error);\n      res.status(500).json({ message: \"Failed to upload image\" });\n    }\n  });\n\n  // Update profile image\n  app.put(\"/api/users/:id/profile-image\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId || userId !== req.params.id) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const { profileImageUrl } = req.body;\n      if (!profileImageUrl) {\n        return res.status(400).json({ message: \"Profile image URL is required\" });\n      }\n\n      const updated = await storage.updateUserProfile(req.params.id, { profileImageUrl });\n      const { password: _, ...safeUser } = updated;\n      res.json(safeUser);\n    } catch (error) {\n      console.error(\"Error updating profile image:\", error);\n      res.status(500).json({ message: \"Failed to update profile image\" });\n    }\n  });\n\n  // Update cover image\n  app.put(\"/api/users/:id/cover-image\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId || userId !== req.params.id) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const { coverImageUrl } = req.body;\n      if (!coverImageUrl) {\n        return res.status(400).json({ message: \"Cover image URL is required\" });\n      }\n\n      const updated = await storage.updateUserProfile(req.params.id, { coverImageUrl });\n      const { password: _, ...safeUser } = updated;\n      res.json(safeUser);\n    } catch (error) {\n      console.error(\"Error updating cover image:\", error);\n      res.status(500).json({ message: \"Failed to update cover image\" });\n    }\n  });\n\n  // Update user role\n  app.put(\"/api/users/:id/role\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId || userId !== req.params.id) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const validationResult = roleUpdateSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Invalid role\",\n          errors: validationResult.error.flatten().fieldErrors\n        });\n      }\n\n      const { role } = validationResult.data;\n\n      const updated = await storage.updateUserProfile(req.params.id, { role });\n      const { password: _, ...safeUser } = updated;\n      res.json(safeUser);\n    } catch (error) {\n      console.error(\"Error updating user role:\", error);\n      res.status(500).json({ message: \"Failed to update role\" });\n    }\n  });\n\n  // User self-verification route\n  app.post(\"/api/users/verify-account\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { phoneNumber, location, ninNumber } = req.body;\n\n      // Validate that at least one verification method is provided\n      if (!phoneNumber && !location && !ninNumber) {\n        return res.status(400).json({ \n          message: \"Please provide at least one verification field (phone number, location, or NIN)\" \n        });\n      }\n\n      // Build update data\n      const updateData: Record<string, any> = {\n        isVerified: true,\n      };\n\n      // Build verification badges array\n      const existingUser = await storage.getUser(userId);\n      const existingBadges = existingUser?.verificationBadges || [];\n      const newBadges = [...existingBadges];\n\n      if (phoneNumber && phoneNumber.trim()) {\n        updateData.phoneNumber = phoneNumber.trim();\n        if (!newBadges.includes(\"phone\")) {\n          newBadges.push(\"phone\");\n        }\n      }\n\n      if (location && location.trim()) {\n        updateData.location = location.trim();\n        if (!newBadges.includes(\"location\")) {\n          newBadges.push(\"location\");\n        }\n      }\n\n      if (ninNumber && ninNumber.trim()) {\n        // Store NIN hash for security (don't store actual NIN)\n        const crypto = await import(\"crypto\");\n        const ninHash = crypto.createHash(\"sha256\").update(ninNumber.trim()).digest(\"hex\");\n        updateData.ninHash = ninHash;\n        updateData.ninVerified = true;\n        updateData.ninVerificationDate = new Date();\n        if (!newBadges.includes(\"nin\")) {\n          newBadges.push(\"nin\");\n        }\n      }\n\n      updateData.verificationBadges = newBadges;\n\n      const updated = await storage.updateUserProfile(userId, updateData);\n      const { password: _, ...safeUser } = updated;\n      \n      console.log(`User ${userId} verified with badges: ${newBadges.join(\", \")}`);\n      res.json(safeUser);\n    } catch (error: any) {\n      console.error(\"Error verifying user account:\", error);\n      res.status(500).json({ message: error.message || \"Failed to verify account\" });\n    }\n  });\n\n  // Helper to check if a user is the system account\n  function isSystemAccount(userId: string): boolean {\n    const systemUserId = process.env.SYSTEM_USER_ID;\n    return systemUserId ? userId === systemUserId : false;\n  }\n\n  // Follow routes\n  app.post(\"/api/users/:id/follow\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const targetUserId = req.params.id;\n      \n      // Prevent regular users from following the system account\n      // (System account should only be auto-followed during registration)\n      if (isSystemAccount(targetUserId) && !isSystemAccount(userId)) {\n        return res.status(403).json({ \n          message: \"You cannot follow the official Campus Hub account. You are already following it!\" \n        });\n      }\n      \n      const follow = await storage.followUser(userId, targetUserId);\n      \n      // Create notification for the followed user\n      const follower = await storage.getUser(userId);\n      const followedUser = await storage.getUser(targetUserId);\n      \n      if (follower && followedUser && targetUserId !== userId) {\n        const followerName = follower.firstName && follower.lastName \n          ? `${follower.firstName} ${follower.lastName}` \n          : follower.email;\n        \n        await createAndBroadcastNotification({\n          userId: targetUserId,\n          type: \"follow\",\n          title: \"New Follower\",\n          message: `${followerName} started following you`,\n          link: `/profile/${userId}`,\n          relatedUserId: userId,\n        });\n        \n        // Send email notification to the followed user\n        try {\n          await sendNewFollowerEmail(\n            followedUser.email,\n            followerName,\n            follower.username || follower.email.split('@')[0]\n          );\n          console.log(`New follower email sent to ${followedUser.email}`);\n        } catch (emailError: any) {\n          console.error(\"Error sending new follower email:\", emailError.message);\n        }\n      }\n      \n      res.json(follow);\n    } catch (error: any) {\n      console.error(\"Error following user:\", error);\n      res.status(400).json({ message: error.message || \"Failed to follow user\" });\n    }\n  });\n\n  app.delete(\"/api/users/:id/follow\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      await storage.unfollowUser(userId, req.params.id);\n      res.json({ message: \"Unfollowed successfully\" });\n    } catch (error) {\n      console.error(\"Error unfollowing user:\", error);\n      res.status(500).json({ message: \"Failed to unfollow user\" });\n    }\n  });\n\n  app.get(\"/api/users/:id/followers\", async (req, res) => {\n    try {\n      const followers = await storage.getFollowers(req.params.id);\n      res.json(followers);\n    } catch (error) {\n      console.error(\"Error fetching followers:\", error);\n      res.status(500).json({ message: \"Failed to fetch followers\" });\n    }\n  });\n\n  app.get(\"/api/users/:id/following\", async (req, res) => {\n    try {\n      const following = await storage.getFollowing(req.params.id);\n      res.json(following);\n    } catch (error) {\n      console.error(\"Error fetching following:\", error);\n      res.status(500).json({ message: \"Failed to fetch following\" });\n    }\n  });\n\n  app.get(\"/api/users/:id/follow-stats\", async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      const [followerCount, followingCount, isFollowing] = await Promise.all([\n        storage.getFollowerCount(req.params.id),\n        storage.getFollowingCount(req.params.id),\n        userId ? storage.isFollowing(userId, req.params.id) : Promise.resolve(false),\n      ]);\n\n      res.json({\n        followerCount,\n        followingCount,\n        isFollowing,\n      });\n    } catch (error) {\n      console.error(\"Error fetching follow stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch follow stats\" });\n    }\n  });\n\n  // Block user route\n  app.post(\"/api/users/:id/block\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const targetUserId = req.params.id;\n      \n      if (userId === targetUserId) {\n        return res.status(400).json({ message: \"You cannot block yourself\" });\n      }\n\n      // Create block relationship\n      await storage.blockUser(userId, targetUserId);\n      \n      // Also unfollow in both directions\n      try {\n        await storage.unfollowUser(userId, targetUserId);\n        await storage.unfollowUser(targetUserId, userId);\n      } catch (e) {\n        // Ignore errors if not following\n      }\n\n      res.json({ message: \"User blocked successfully\" });\n    } catch (error: any) {\n      console.error(\"Error blocking user:\", error);\n      res.status(400).json({ message: error.message || \"Failed to block user\" });\n    }\n  });\n\n  // Unblock user route\n  app.delete(\"/api/users/:id/block\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      await storage.unblockUser(userId, req.params.id);\n      res.json({ message: \"User unblocked successfully\" });\n    } catch (error: any) {\n      console.error(\"Error unblocking user:\", error);\n      res.status(400).json({ message: error.message || \"Failed to unblock user\" });\n    }\n  });\n\n  // Report user route\n  app.post(\"/api/users/:id/report\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const targetUserId = req.params.id;\n      const { reason, description } = req.body;\n\n      if (userId === targetUserId) {\n        return res.status(400).json({ message: \"You cannot report yourself\" });\n      }\n\n      if (!reason) {\n        return res.status(400).json({ message: \"Report reason is required\" });\n      }\n\n      await storage.reportUser(userId, targetUserId, reason, description || \"\");\n      res.json({ message: \"Report submitted successfully\" });\n    } catch (error: any) {\n      console.error(\"Error reporting user:\", error);\n      res.status(400).json({ message: error.message || \"Failed to submit report\" });\n    }\n  });\n\n  // Get blocked users route\n  app.get(\"/api/blocked-users\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const blockedUsersWithRelation = await storage.getBlockedUsers(userId);\n      \n      // Return just the blocked user info that the frontend expects\n      const blockedUsers = blockedUsersWithRelation.map(block => ({\n        id: block.blockedUser.id,\n        firstName: block.blockedUser.firstName,\n        lastName: block.blockedUser.lastName,\n        profileImageUrl: block.blockedUser.profileImageUrl,\n        email: block.blockedUser.email,\n      }));\n      \n      res.json(blockedUsers);\n    } catch (error: any) {\n      console.error(\"Error getting blocked users:\", error);\n      res.status(500).json({ message: \"Failed to get blocked users\" });\n    }\n  });\n\n  // Message routes\n  app.get(\"/api/messages/threads\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const threads = await storage.getMessageThreads(userId);\n      \n      // Filter out threads where either user has blocked the other\n      const filteredThreads = [];\n      for (const thread of threads) {\n        // Storage returns 'user' property, not 'otherUser'\n        const otherUserId = thread.user?.id;\n        if (!otherUserId) continue;\n        \n        // Skip block checks for system account threads\n        if (isSystemAccount(otherUserId)) {\n          filteredThreads.push(thread);\n          continue;\n        }\n        \n        const [userBlockedOther, otherBlockedUser] = await Promise.all([\n          storage.isUserBlocked(userId, otherUserId),\n          storage.isUserBlocked(otherUserId, userId),\n        ]);\n        \n        // Only include threads where neither user has blocked the other\n        if (!userBlockedOther && !otherBlockedUser) {\n          filteredThreads.push(thread);\n        }\n      }\n      \n      res.json(filteredThreads);\n    } catch (error) {\n      console.error(\"Error fetching threads:\", error);\n      res.status(500).json({ message: \"Failed to fetch threads\" });\n    }\n  });\n\n  app.get(\"/api/messages/:otherUserId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const messages = await storage.getMessageThread(userId, req.params.otherUserId);\n      \n      // Mark messages as read\n      await storage.markMessagesAsRead(userId, req.params.otherUserId);\n      \n      res.json(messages);\n    } catch (error) {\n      console.error(\"Error fetching messages:\", error);\n      res.status(500).json({ message: \"Failed to fetch messages\" });\n    }\n  });\n\n  // Helper: Check if message contains support keywords\n  function containsSupportKeywords(content: string): boolean {\n    const supportKeywords = ['help', 'support', 'agent', 'human', 'assistance', 'problem', 'issue', 'complaint', 'refund', 'dispute'];\n    const lowerContent = content.toLowerCase();\n    return supportKeywords.some(keyword => lowerContent.includes(keyword));\n  }\n\n  // Track recent support tickets per user to prevent spam (userId -> lastTicketTime)\n  const recentSupportTickets = new Map<string, number>();\n  const SUPPORT_TICKET_COOLDOWN_MS = 5 * 60 * 1000; // 5 minute cooldown between auto-tickets\n\n  // Helper: Generate AI response for system account using Groq (async, non-blocking)\n  async function processSystemAccountMessage(userMessage: string, userId: string, productId?: string | null): Promise<void> {\n    const systemUserId = process.env.SYSTEM_USER_ID;\n    if (!systemUserId) return;\n\n    try {\n      // Get user info for context\n      const user = await storage.getUser(userId);\n      const userName = user?.firstName || 'there';\n\n      // Use the existing chatbot function\n      const response = await getChatbotResponseWithHandoff(\n        [{ role: 'user', content: userMessage }],\n        { \n          userId, \n          role: user?.role || 'buyer',\n          currentPage: 'messages' \n        }\n      );\n\n      // Build AI response message\n      let aiResponse: string;\n      if (response.shouldHandoff) {\n        aiResponse = `Hey ${userName}! I noticed you might need some extra help with this. ${response.message}\\n\\nIf you need to speak with a human agent, please create a support ticket from the Help section. Our team will get back to you within 24 hours!`;\n      } else {\n        aiResponse = response.message;\n      }\n\n      // Create the AI response message from system account\n      const aiMessage = await storage.createMessage({\n        senderId: systemUserId,\n        receiverId: userId,\n        content: aiResponse,\n        productId: productId || undefined,\n      });\n\n      // Broadcast via websocket so user sees the response immediately\n      const userConnections = wsConnections.get(userId);\n      if (userConnections) {\n        const wsMessage = JSON.stringify({\n          type: \"new_message\",\n          message: aiMessage,\n        });\n        userConnections.forEach(ws => {\n          if (ws.readyState === WebSocket.OPEN) {\n            ws.send(wsMessage);\n          }\n        });\n      }\n\n      // Create notification for the AI response\n      const systemAccount = await storage.getUser(systemUserId);\n      if (systemAccount) {\n        await createAndBroadcastNotification({\n          userId,\n          type: \"message\",\n          title: \"New Message from Campus Hub\",\n          message: aiResponse.substring(0, 80) + (aiResponse.length > 80 ? \"...\" : \"\"),\n          link: `/messages?user=${systemUserId}`,\n          relatedUserId: systemUserId,\n        });\n      }\n\n    } catch (error) {\n      console.error(\"AI response generation error:\", error);\n      // On failure, send a fallback message\n      try {\n        const fallbackMessage = await storage.createMessage({\n          senderId: systemUserId,\n          receiverId: userId,\n          content: \"Hey! Thanks for reaching out to Campus Hub. I'm having a small technical glitch right now. Please try again in a moment, or create a support ticket from the Help section if you need immediate assistance.\",\n          productId: productId || undefined,\n        });\n        \n        // Broadcast fallback via websocket\n        const userConnections = wsConnections.get(userId);\n        if (userConnections) {\n          const wsMessage = JSON.stringify({\n            type: \"new_message\",\n            message: fallbackMessage,\n          });\n          userConnections.forEach(ws => {\n            if (ws.readyState === WebSocket.OPEN) {\n              ws.send(wsMessage);\n            }\n          });\n        }\n      } catch (fallbackError) {\n        console.error(\"Failed to send fallback AI message:\", fallbackError);\n      }\n    }\n  }\n\n  // Helper: Create support ticket with cooldown check\n  async function maybeCreateSupportTicket(userId: string, content: string): Promise<void> {\n    // Check cooldown\n    const lastTicketTime = recentSupportTickets.get(userId);\n    const now = Date.now();\n    \n    if (lastTicketTime && (now - lastTicketTime) < SUPPORT_TICKET_COOLDOWN_MS) {\n      console.log(`Skipping auto-ticket for user ${userId} - cooldown active`);\n      return;\n    }\n\n    try {\n      await storage.createSupportTicket({\n        userId,\n        subject: `Auto-generated from DM: ${content.substring(0, 50)}...`,\n        message: content,\n        category: 'general',\n        priority: 'medium',\n      });\n      recentSupportTickets.set(userId, now);\n      console.log(`Auto-created support ticket for user ${userId}`);\n    } catch (ticketError) {\n      console.error(\"Failed to auto-create support ticket:\", ticketError);\n    }\n  }\n\n  app.post(\"/api/messages\", isAuthenticated, requireEmailVerified, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const validated = insertMessageSchema.parse({\n        senderId: userId,\n        ...req.body,\n      });\n\n      // Check if either user has blocked the other (skip for system account messages)\n      if (!isSystemAccount(validated.receiverId) && !isSystemAccount(userId)) {\n        const [senderBlockedReceiver, receiverBlockedSender] = await Promise.all([\n          storage.isUserBlocked(userId, validated.receiverId),\n          storage.isUserBlocked(validated.receiverId, userId),\n        ]);\n        \n        if (senderBlockedReceiver || receiverBlockedSender) {\n          return res.status(403).json({ message: \"You cannot message this user\" });\n        }\n      }\n\n      // Save the user's message\n      const message = await storage.createMessage(validated);\n      \n      // Check if messaging the system account - trigger async AI response (non-blocking)\n      if (isSystemAccount(validated.receiverId) && !isSystemAccount(userId)) {\n        // Fire-and-forget: Process AI response and support tickets asynchronously\n        setImmediate(() => {\n          // Check for support keywords to auto-create support ticket (with cooldown)\n          if (containsSupportKeywords(validated.content)) {\n            maybeCreateSupportTicket(userId, validated.content).catch(err => {\n              console.error(\"Support ticket creation failed:\", err);\n            });\n          }\n\n          // Generate and send AI response from system account\n          processSystemAccountMessage(validated.content, userId, validated.productId).catch(err => {\n            console.error(\"System account AI response failed:\", err);\n          });\n        });\n      } else {\n        // Regular message - Create notification for the message receiver\n        if (validated.receiverId && validated.receiverId !== userId) {\n          const sender = await storage.getUser(userId);\n          const receiver = await storage.getUser(validated.receiverId);\n          if (sender && receiver) {\n            const senderName = sender.firstName && sender.lastName \n              ? `${sender.firstName} ${sender.lastName}` \n              : sender.email;\n            \n            // Truncate message content for notification\n            const messagePreview = validated.content.length > 50 \n              ? validated.content.substring(0, 50) + \"...\" \n              : validated.content;\n            \n            await createAndBroadcastNotification({\n              userId: validated.receiverId,\n              type: \"message\",\n              title: \"New Message\",\n              message: `${senderName}: ${messagePreview}`,\n              link: `/messages?user=${userId}`,\n              relatedUserId: userId,\n              relatedProductId: validated.productId || undefined,\n            });\n\n            // Send email notification for new message\n            sendMessageNotification(receiver.email, senderName).catch(err => {\n              console.error(\"Failed to send message email notification:\", err);\n            });\n          }\n        }\n      }\n      \n      res.json(message);\n    } catch (error: any) {\n      console.error(\"Error creating message:\", error);\n      res.status(400).json({ message: error.message || \"Failed to send message\" });\n    }\n  });\n\n  // Message with image attachment route\n  app.post(\"/api/messages/with-attachment\", isAuthenticated, requireEmailVerified, upload.single(\"attachment\"), async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      let imageUrl: string | null = null;\n\n      // Upload image if provided\n      if (req.file) {\n        imageUrl = await uploadToObjectStorage(req.file, \"message-attachments/\");\n        if (!imageUrl) {\n          return res.status(500).json({ message: \"Failed to upload attachment\" });\n        }\n      }\n\n      // Parse the message data from form body\n      const { receiverId, content, productId } = req.body;\n\n      if (!receiverId) {\n        return res.status(400).json({ message: \"Receiver ID is required\" });\n      }\n\n      // Check if either user has blocked the other (skip for system account messages)\n      if (!isSystemAccount(receiverId) && !isSystemAccount(userId)) {\n        const [senderBlockedReceiver, receiverBlockedSender] = await Promise.all([\n          storage.isUserBlocked(userId, receiverId),\n          storage.isUserBlocked(receiverId, userId),\n        ]);\n        \n        if (senderBlockedReceiver || receiverBlockedSender) {\n          return res.status(403).json({ message: \"You cannot message this user\" });\n        }\n      }\n\n      // Content is optional if there's an image\n      const messageContent = content || (imageUrl ? \"[Image]\" : \"\");\n      if (!messageContent && !imageUrl) {\n        return res.status(400).json({ message: \"Message content or attachment is required\" });\n      }\n\n      const validated = insertMessageSchema.parse({\n        senderId: userId,\n        receiverId,\n        content: messageContent,\n        imageUrl,\n        productId: productId || null,\n      });\n\n      const message = await storage.createMessage(validated);\n      \n      // Check if messaging the system account - trigger async AI response (non-blocking)\n      if (isSystemAccount(validated.receiverId) && !isSystemAccount(userId)) {\n        // Fire-and-forget: Process AI response and support tickets asynchronously\n        setImmediate(() => {\n          if (containsSupportKeywords(validated.content)) {\n            maybeCreateSupportTicket(userId, validated.content).catch(err => {\n              console.error(\"Support ticket creation failed:\", err);\n            });\n          }\n\n          processSystemAccountMessage(validated.content, userId, validated.productId).catch(err => {\n            console.error(\"System account AI response failed:\", err);\n          });\n        });\n      }\n      \n      // Create notification for the message receiver (except for system account)\n      if (validated.receiverId && validated.receiverId !== userId && !isSystemAccount(validated.receiverId)) {\n        const sender = await storage.getUser(userId);\n        if (sender) {\n          const senderName = sender.firstName && sender.lastName \n            ? `${sender.firstName} ${sender.lastName}` \n            : sender.email;\n          \n          // Notification message preview\n          const messagePreview = imageUrl \n            ? \"Sent you an image\" \n            : (validated.content.length > 50 \n              ? validated.content.substring(0, 50) + \"...\" \n              : validated.content);\n          \n          await createAndBroadcastNotification({\n            userId: validated.receiverId,\n            type: \"message\",\n            title: \"New Message\",\n            message: `${senderName}: ${messagePreview}`,\n            link: `/messages?user=${userId}`,\n            relatedUserId: userId,\n            relatedProductId: validated.productId || undefined,\n          });\n        }\n      }\n      \n      res.json(message);\n    } catch (error: any) {\n      console.error(\"Error creating message with attachment:\", error);\n      res.status(400).json({ message: error.message || \"Failed to send message\" });\n    }\n  });\n\n  // Message reactions routes\n  app.post(\"/api/messages/:id/reactions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { reaction } = req.body;\n      const validReactions = ['heart', 'thumbs_up', 'laugh', 'surprised', 'sad', 'angry'];\n      \n      if (!reaction || !validReactions.includes(reaction)) {\n        return res.status(400).json({ message: \"Invalid reaction. Valid reactions are: \" + validReactions.join(\", \") });\n      }\n\n      const messageReaction = await storage.addMessageReaction(req.params.id, userId, reaction);\n      res.json(messageReaction);\n    } catch (error: any) {\n      console.error(\"Error adding reaction:\", error);\n      res.status(400).json({ message: error.message || \"Failed to add reaction\" });\n    }\n  });\n\n  app.delete(\"/api/messages/:id/reactions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      await storage.removeMessageReaction(req.params.id, userId);\n      res.json({ message: \"Reaction removed successfully\" });\n    } catch (error: any) {\n      console.error(\"Error removing reaction:\", error);\n      res.status(400).json({ message: error.message || \"Failed to remove reaction\" });\n    }\n  });\n\n  app.get(\"/api/messages/:id/reactions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const reactions = await storage.getMessageReactions(req.params.id);\n      res.json(reactions);\n    } catch (error: any) {\n      console.error(\"Error getting reactions:\", error);\n      res.status(500).json({ message: \"Failed to get reactions\" });\n    }\n  });\n\n  // Read receipts route\n  app.get(\"/api/messages/read-receipts/:messageId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const receipts = await storage.getReadReceipts(req.params.messageId);\n      res.json(receipts);\n    } catch (error: any) {\n      console.error(\"Error getting read receipts:\", error);\n      res.status(500).json({ message: \"Failed to get read receipts\" });\n    }\n  });\n\n  // Conversation archive routes\n  app.get(\"/api/conversations/archived\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const archived = await storage.getArchivedConversations(userId);\n      res.json(archived);\n    } catch (error: any) {\n      console.error(\"Error getting archived conversations:\", error);\n      res.status(500).json({ message: \"Failed to get archived conversations\" });\n    }\n  });\n\n  app.post(\"/api/conversations/:userId/archive\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const archived = await storage.archiveConversation(userId, req.params.userId);\n      res.json(archived);\n    } catch (error: any) {\n      console.error(\"Error archiving conversation:\", error);\n      res.status(400).json({ message: error.message || \"Failed to archive conversation\" });\n    }\n  });\n\n  app.delete(\"/api/conversations/:userId/archive\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      await storage.unarchiveConversation(userId, req.params.userId);\n      res.json({ message: \"Conversation unarchived successfully\" });\n    } catch (error: any) {\n      console.error(\"Error unarchiving conversation:\", error);\n      res.status(400).json({ message: error.message || \"Failed to unarchive conversation\" });\n    }\n  });\n\n  // Mark messages as read route\n  app.post(\"/api/conversations/:userId/read\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      await storage.markMessagesAsRead(userId, req.params.userId);\n      res.json({ message: \"Messages marked as read\" });\n    } catch (error: any) {\n      console.error(\"Error marking messages as read:\", error);\n      res.status(400).json({ message: error.message || \"Failed to mark messages as read\" });\n    }\n  });\n\n  // Disappearing messages routes\n  app.post(\"/api/conversations/:userId/disappearing\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { duration } = req.body;\n      const validDurations = [0, 86400, 604800, 7776000]; // off, 24h, 7d, 90d in seconds\n      \n      if (duration === undefined || !validDurations.includes(Number(duration))) {\n        return res.status(400).json({ message: \"Invalid duration. Valid durations are: 0 (off), 86400 (24h), 604800 (7d), 7776000 (90d)\" });\n      }\n\n      const setting = await storage.setDisappearingMessages(userId, req.params.userId, Number(duration));\n      res.json(setting);\n    } catch (error: any) {\n      console.error(\"Error setting disappearing messages:\", error);\n      res.status(400).json({ message: error.message || \"Failed to set disappearing messages\" });\n    }\n  });\n\n  app.get(\"/api/conversations/:userId/disappearing\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const setting = await storage.getDisappearingMessageSettings(userId, req.params.userId);\n      res.json(setting || { isEnabled: false, duration: 0 });\n    } catch (error: any) {\n      console.error(\"Error getting disappearing message settings:\", error);\n      res.status(500).json({ message: \"Failed to get disappearing message settings\" });\n    }\n  });\n\n  // Review routes\n  app.get(\"/api/reviews/:userId\", async (req, res) => {\n    try {\n      const reviews = await storage.getUserReviews(req.params.userId);\n      res.json(reviews);\n    } catch (error) {\n      console.error(\"Error fetching reviews:\", error);\n      res.status(500).json({ message: \"Failed to fetch reviews\" });\n    }\n  });\n\n  app.post(\"/api/reviews\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const validated = insertReviewSchema.parse({\n        reviewerId: userId,\n        ...req.body,\n      });\n\n      const review = await storage.createReview(validated);\n      res.json(review);\n    } catch (error: any) {\n      console.error(\"Error creating review:\", error);\n      res.status(400).json({ message: error.message || \"Failed to create review\" });\n    }\n  });\n\n  // Watchlist routes\n  app.post(\"/api/watchlist\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const validated = insertWatchlistSchema.parse({\n        userId,\n        productId: req.body.productId,\n      });\n\n      const watchlistItem = await storage.addToWatchlist(validated.userId, validated.productId);\n      res.json(watchlistItem);\n    } catch (error: any) {\n      console.error(\"Error adding to watchlist:\", error);\n      res.status(400).json({ message: error.message || \"Failed to add to watchlist\" });\n    }\n  });\n\n  app.get(\"/api/watchlist\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const watchlist = await storage.getUserWatchlist(userId);\n      res.json(watchlist);\n    } catch (error) {\n      console.error(\"Error fetching watchlist:\", error);\n      res.status(500).json({ message: \"Failed to fetch watchlist\" });\n    }\n  });\n\n  app.delete(\"/api/watchlist/:productId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      await storage.removeFromWatchlist(userId, req.params.productId);\n      res.json({ message: \"Removed from watchlist\" });\n    } catch (error: any) {\n      console.error(\"Error removing from watchlist:\", error);\n      if (error.message === \"Watchlist item not found\") {\n        return res.status(404).json({ message: \"Watchlist item not found\" });\n      }\n      res.status(500).json({ message: \"Failed to remove from watchlist\" });\n    }\n  });\n\n  // Get wishlist with full product and seller details\n  app.get(\"/api/wishlist/full\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const wishlistWithProducts = await storage.getWishlistWithProducts(userId);\n      res.json(wishlistWithProducts);\n    } catch (error) {\n      console.error(\"Error fetching wishlist with products:\", error);\n      res.status(500).json({ message: \"Failed to fetch wishlist\" });\n    }\n  });\n\n  // Report routes\n  app.post(\"/api/reports\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const validated = insertReportSchema.parse({\n        reporterId: userId,\n        ...req.body,\n      });\n\n      const report = await storage.createReport(validated);\n      res.json(report);\n    } catch (error: any) {\n      console.error(\"Error creating report:\", error);\n      res.status(400).json({ message: error.message || \"Failed to create report\" });\n    }\n  });\n\n  // ==================== AI CHATBOT ROUTES ====================\n  \n  // Zod schema for chatbot request validation\n  const chatbotRequestSchema = z.object({\n    message: z.string().min(1).max(2000),\n    currentPage: z.string().optional(),\n    conversationHistory: z.array(z.object({\n      role: z.enum([\"user\", \"assistant\"]),\n      content: z.string()\n    })).optional(),\n  });\n  \n  app.post(\"/api/chatbot\", async (req: any, res) => {\n    try {\n      // Validate request\n      const validated = chatbotRequestSchema.parse(req.body);\n      \n      const userMessage = validated.message;\n      const currentPage = validated.currentPage;\n      const history = validated.conversationHistory || [];\n\n      // Get user context if authenticated\n      let userContext;\n      const userId = getUserId(req);\n      if (userId) {\n        const user = await storage.getUser(userId);\n        if (user) {\n          userContext = {\n            role: user.role,\n            isVerified: user.isVerified ?? undefined,\n            trustScore: user.trustScore ?? undefined,\n            currentPage: currentPage,\n            userId: userId,\n          };\n        }\n      } else if (currentPage) {\n        userContext = { currentPage };\n      }\n\n      // Check for payment scam patterns in the user message\n      const hasPaymentWarning = checkForPaymentScam(userMessage);\n\n      // Build conversation with history for handoff detection\n      const trustedMessages: ChatMessage[] = [\n        ...history.slice(-6).map(h => ({ role: h.role as \"user\" | \"assistant\", content: h.content })),\n        { role: \"user\" as const, content: userMessage }\n      ];\n\n      // Use the handoff-aware response function\n      const response = await getChatbotResponseWithHandoff(trustedMessages, userContext);\n\n      res.json({\n        message: response.message,\n        hasPaymentWarning,\n        shouldHandoff: response.shouldHandoff,\n        handoffReason: response.handoffReason,\n        suggestedCategory: response.suggestedCategory,\n        frustrationLevel: response.frustrationLevel,\n      });\n    } catch (error: any) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ \n          message: \"Invalid input - message required and must be under 2000 characters\" \n        });\n      }\n      console.error(\"Chatbot error:\", error);\n      res.status(500).json({ \n        message: \"Omo, something don wrong. The AI bot no dey available now. Try again later or contact support!\",\n        error: error.message \n      });\n    }\n  });\n\n  // Quick help endpoint for common questions\n  app.get(\"/api/chatbot/quick-help\", async (req: any, res) => {\n    try {\n      const topic = req.query.topic as string;\n      \n      const quickResponses: Record<string, string> = {\n        \"how-to-sell\": \"To sell something: 1) Go to 'Sell' page 2) Upload clear photos 3) Add title, description, price 4) Choose category and condition 5) Post! Your item will be live immediately. Want to boost it for more visibility? That's ₦500-₦2000.\",\n        \"safety\": \"🚨 SAFETY RULES:\\n✅ ALWAYS use escrow for payments\\n✅ Check seller's trust score and badges\\n✅ Report suspicious users\\n🚫 NEVER pay outside the app\\n🚫 Don't share bank details in chat\\n\\nIf someone asks you to pay outside the app = SCAM! Report them immediately.\",\n        \"escrow\": \"Escrow keeps your money SAFE! When you buy: 1) Your money is held by the app 2) Seller ships item 3) You confirm you got it 4) Money releases to seller. We charge 3-6% for this protection. Worth it to avoid scams!\",\n        \"verification\": \"Get verified to build trust! Available badges:\\n✅ Verified Student - Upload student ID\\n✅ NIN Verified - Verify government ID\\n⭐ Trusted Seller - Earn through good sales\\n\\nGo to Profile > Verification to start!\",\n      };\n\n      const response = quickResponses[topic] || \"No quick help available for this topic. Use the chat for detailed help!\";\n      res.json({ message: response });\n    } catch (error) {\n      console.error(\"Quick help error:\", error);\n      res.status(500).json({ message: \"Failed to get quick help\" });\n    }\n  });\n\n  // Notifications API routes\n  app.get(\"/api/notifications\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const notifications = await storage.getUserNotifications(userId);\n      res.json(notifications);\n    } catch (error) {\n      console.error(\"Error fetching notifications:\", error);\n      res.status(500).json({ message: \"Failed to fetch notifications\" });\n    }\n  });\n\n  app.patch(\"/api/notifications/:id/read\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      await storage.markNotificationAsRead(req.params.id, userId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error marking notification as read:\", error);\n      res.status(500).json({ message: \"Failed to mark notification as read\" });\n    }\n  });\n\n  app.put(\"/api/notifications/:id/read\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      await storage.markNotificationAsRead(req.params.id, userId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error marking notification as read:\", error);\n      res.status(500).json({ message: \"Failed to mark notification as read\" });\n    }\n  });\n\n  app.put(\"/api/notifications/read-all\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      await storage.markAllNotificationsAsRead(userId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error marking all notifications as read:\", error);\n      res.status(500).json({ message: \"Failed to mark all notifications as read\" });\n    }\n  });\n\n  app.delete(\"/api/notifications/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      await storage.deleteNotification(req.params.id, userId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting notification:\", error);\n      res.status(500).json({ message: \"Failed to delete notification\" });\n    }\n  });\n\n  app.post(\"/api/notifications/mark-all-read\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      await storage.markAllNotificationsAsRead(userId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error marking all notifications as read:\", error);\n      res.status(500).json({ message: \"Failed to mark all notifications as read\" });\n    }\n  });\n\n  // Admin routes\n  app.get(\"/api/admin/users\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const users = await storage.getAllUsers();\n      res.json(users);\n    } catch (error) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ message: \"Failed to fetch users\" });\n    }\n  });\n\n  app.put(\"/api/admin/users/:id/verify\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const updated = await storage.verifyUser(req.params.id);\n      res.json(updated);\n    } catch (error: any) {\n      console.error(\"Error verifying user:\", error);\n      if (error.message?.includes(\"not found\")) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      res.status(500).json({ message: \"Failed to verify user\" });\n    }\n  });\n\n  app.put(\"/api/admin/users/:id/ban\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const updated = await storage.banUser(req.params.id, req.body.reason || \"Violation of terms\");\n      res.json(updated);\n    } catch (error: any) {\n      console.error(\"Error banning user:\", error);\n      if (error.message?.includes(\"not found\")) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      res.status(500).json({ message: \"Failed to ban user\" });\n    }\n  });\n\n  app.get(\"/api/admin/products\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const products = await storage.getProducts({});\n      res.json(products);\n    } catch (error) {\n      console.error(\"Error fetching products:\", error);\n      res.status(500).json({ message: \"Failed to fetch products\" });\n    }\n  });\n\n  app.put(\"/api/admin/products/:id/approve\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const updated = await storage.approveProduct(req.params.id);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error approving product:\", error);\n      res.status(500).json({ message: \"Failed to approve product\" });\n    }\n  });\n\n  // ==================== CAMPUS UPDATES / ANNOUNCEMENTS ROUTES ====================\n  \n  // Get all published announcements (public route with optional auth for read status)\n  app.get(\"/api/announcements\", async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const announcements = await storage.getAnnouncements(false);\n      \n      // If user is authenticated, include their read status\n      if (userId) {\n        const reads = await storage.getUserAnnouncementReads(userId);\n        const readIds = new Set(reads.map(r => r.announcementId));\n        \n        const announcementsWithReadStatus = announcements.map(a => ({\n          ...a,\n          isRead: readIds.has(a.id),\n        }));\n        \n        return res.json(announcementsWithReadStatus);\n      }\n      \n      res.json(announcements.map(a => ({ ...a, isRead: false })));\n    } catch (error) {\n      console.error(\"Error fetching announcements:\", error);\n      res.status(500).json({ message: \"Failed to fetch announcements\" });\n    }\n  });\n\n  // Get a specific announcement\n  app.get(\"/api/announcements/:id\", async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const announcement = await storage.getAnnouncement(req.params.id);\n      \n      if (!announcement) {\n        return res.status(404).json({ message: \"Announcement not found\" });\n      }\n      \n      // Only show unpublished announcements to admins\n      if (!announcement.isPublished) {\n        if (!userId) {\n          return res.status(404).json({ message: \"Announcement not found\" });\n        }\n        if (!(await isAdminUser(userId))) {\n          return res.status(404).json({ message: \"Announcement not found\" });\n        }\n      }\n      \n      // Increment views\n      await storage.incrementAnnouncementViews(req.params.id);\n      \n      // Include read status if authenticated\n      let isRead = false;\n      if (userId) {\n        isRead = await storage.isAnnouncementRead(userId, req.params.id);\n      }\n      \n      res.json({ ...announcement, isRead });\n    } catch (error) {\n      console.error(\"Error fetching announcement:\", error);\n      res.status(500).json({ message: \"Failed to fetch announcement\" });\n    }\n  });\n\n  // Create announcement (admin only)\n  app.post(\"/api/announcements\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Only admins can create announcements\" });\n      }\n\n      const validationResult = createAnnouncementSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Validation failed\",\n          errors: validationResult.error.flatten().fieldErrors\n        });\n      }\n\n      const announcement = await storage.createAnnouncement({\n        ...validationResult.data,\n        authorId: userId,\n      });\n\n      res.status(201).json(announcement);\n    } catch (error) {\n      console.error(\"Error creating announcement:\", error);\n      res.status(500).json({ message: \"Failed to create announcement\" });\n    }\n  });\n\n  // Update announcement (admin only)\n  app.patch(\"/api/announcements/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Only admins can update announcements\" });\n      }\n\n      const validationResult = updateAnnouncementSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Validation failed\",\n          errors: validationResult.error.flatten().fieldErrors\n        });\n      }\n\n      const announcement = await storage.updateAnnouncement(req.params.id, validationResult.data);\n      res.json(announcement);\n    } catch (error: any) {\n      console.error(\"Error updating announcement:\", error);\n      if (error.message?.includes(\"not found\")) {\n        return res.status(404).json({ message: \"Announcement not found\" });\n      }\n      res.status(500).json({ message: \"Failed to update announcement\" });\n    }\n  });\n\n  // Delete announcement (admin only)\n  app.delete(\"/api/announcements/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Only admins can delete announcements\" });\n      }\n\n      await storage.deleteAnnouncement(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting announcement:\", error);\n      res.status(500).json({ message: \"Failed to delete announcement\" });\n    }\n  });\n\n  // Mark announcement as read (authenticated users)\n  app.post(\"/api/announcements/:id/read\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const read = await storage.markAnnouncementAsRead(userId, req.params.id);\n      res.json(read);\n    } catch (error) {\n      console.error(\"Error marking announcement as read:\", error);\n      res.status(500).json({ message: \"Failed to mark announcement as read\" });\n    }\n  });\n\n  // Get all announcements for admin (including unpublished)\n  app.get(\"/api/admin/announcements\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const announcements = await storage.getAnnouncements(true);\n      res.json(announcements);\n    } catch (error) {\n      console.error(\"Error fetching announcements for admin:\", error);\n      res.status(500).json({ message: \"Failed to fetch announcements\" });\n    }\n  });\n\n  // ==================== SOCIAL POSTS ROUTES (\"The Plug\") ====================\n\n  // Get all social posts (with optional following filter)\n  app.get(\"/api/social-posts\", async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const followingOnly = req.query.following === \"true\";\n      const authorId = req.query.authorId as string | undefined;\n\n      const posts = await storage.getSocialPosts({\n        authorId,\n        followingOnly,\n        userId: userId || undefined,\n      });\n\n      res.json(posts);\n    } catch (error) {\n      console.error(\"Error fetching social posts:\", error);\n      res.status(500).json({ message: \"Failed to fetch social posts\" });\n    }\n  });\n\n  // Create a new social post (supports images and videos)\n  app.post(\"/api/social-posts\", isAuthenticated, requireEmailVerified, uploadMedia.array(\"media\", 10), async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { content } = req.body;\n      const hasMedia = req.files && Array.isArray(req.files) && req.files.length > 0;\n      const hasContent = content && content.trim().length > 0;\n      \n      // Require either content or media (or both)\n      if (!hasContent && !hasMedia) {\n        return res.status(400).json({ message: \"Please add some text or media to your post\" });\n      }\n\n      // Upload media to object storage and separate images from videos\n      const images: string[] = [];\n      const videos: string[] = [];\n      \n      if (req.files && Array.isArray(req.files)) {\n        const prefix = `posts/${userId}/`;\n        \n        for (const file of req.files as Express.Multer.File[]) {\n          let mediaUrl: string | null = null;\n          \n          // Use video upload for videos, regular upload for images\n          if (file.mimetype.startsWith('video/')) {\n            mediaUrl = await uploadVideoToStorage(file, prefix);\n            if (mediaUrl) {\n              videos.push(mediaUrl);\n            }\n          } else {\n            mediaUrl = await uploadToObjectStorage(file, prefix);\n            if (mediaUrl) {\n              images.push(mediaUrl);\n            }\n          }\n          \n          if (!mediaUrl) {\n            console.error(\"Failed to upload media file:\", file.originalname);\n          }\n        }\n      }\n\n      const post = await storage.createSocialPost({\n        authorId: userId,\n        content: hasContent ? content.trim() : \"\",\n        images,\n        videos,\n      });\n\n      // Fetch the full post with author info\n      const fullPost = await storage.getSocialPost(post.id);\n      \n      // Notify followers about the new post (run asynchronously, don't block response)\n      (async () => {\n        try {\n          const author = await storage.getUser(userId);\n          if (!author) return;\n          \n          const authorName = author.firstName && author.lastName \n            ? `${author.firstName} ${author.lastName}` \n            : author.username || author.email.split('@')[0];\n          \n          const authorUsername = author.username || author.email.split('@')[0];\n          const postPreview = hasContent ? content.trim() : \"[Media post]\";\n          \n          // Get followers and notify them\n          const followers = await storage.getFollowers(userId);\n          \n          // Limit to first 50 followers for email to avoid overwhelming the service\n          const followersToEmail = followers.slice(0, 50);\n          \n          for (const follow of followers) {\n            // Send in-app notification to all followers\n            await createAndBroadcastNotification({\n              userId: follow.follower.id,\n              type: \"new_post\",\n              title: \"New Post\",\n              message: `${authorName} shared a new post`,\n              link: `/the-plug?post=${post.id}`,\n              relatedUserId: userId,\n            });\n          }\n          \n          // Send email notifications to a limited number of followers\n          for (const follow of followersToEmail) {\n            try {\n              await sendNewPostFromFollowingEmail(\n                follow.follower.email,\n                authorName,\n                authorUsername,\n                postPreview,\n                post.id\n              );\n            } catch (emailError: any) {\n              console.error(`Error sending new post email to ${follow.follower.email}:`, emailError.message);\n            }\n          }\n          \n          console.log(`Notified ${followers.length} followers about new post from ${author.email}`);\n        } catch (notifyError: any) {\n          console.error(\"Error notifying followers about new post:\", notifyError.message);\n        }\n      })();\n      \n      res.status(201).json(fullPost);\n    } catch (error) {\n      console.error(\"Error creating social post:\", error);\n      res.status(500).json({ message: \"Failed to create social post\" });\n    }\n  });\n\n  // Toggle like on a post\n  app.post(\"/api/social-posts/:id/like\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const postId = req.params.id;\n\n      // Check if already liked\n      const isLiked = await storage.isPostLiked(postId, userId);\n\n      if (isLiked) {\n        // Unlike\n        await storage.unlikeSocialPost(postId, userId);\n        res.json({ liked: false });\n      } else {\n        // Like\n        await storage.likeSocialPost(postId, userId);\n        res.json({ liked: true });\n      }\n    } catch (error) {\n      console.error(\"Error toggling like:\", error);\n      res.status(500).json({ message: \"Failed to toggle like\" });\n    }\n  });\n\n  // Get comments for a post\n  app.get(\"/api/social-posts/:id/comments\", async (req, res) => {\n    try {\n      const postId = req.params.id;\n      const comments = await storage.getPostComments(postId);\n      res.json(comments);\n    } catch (error) {\n      console.error(\"Error fetching comments:\", error);\n      res.status(500).json({ message: \"Failed to fetch comments\" });\n    }\n  });\n\n  // Add a comment to a post\n  app.post(\"/api/social-posts/:id/comments\", isAuthenticated, requireEmailVerified, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const postId = req.params.id;\n      const { content } = req.body;\n\n      if (!content || content.trim().length === 0) {\n        return res.status(400).json({ message: \"Comment content is required\" });\n      }\n\n      const comment = await storage.createPostComment({\n        postId,\n        authorId: userId,\n        content: content.trim(),\n      });\n\n      // Fetch comment with author info\n      const comments = await storage.getPostComments(postId);\n      const fullComment = comments.find(c => c.id === comment.id);\n      \n      res.status(201).json(fullComment || comment);\n    } catch (error) {\n      console.error(\"Error creating comment:\", error);\n      res.status(500).json({ message: \"Failed to create comment\" });\n    }\n  });\n\n  // Delete a social post (owner only)\n  app.delete(\"/api/social-posts/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const postId = req.params.id;\n      const post = await storage.getSocialPost(postId);\n\n      if (!post) {\n        return res.status(404).json({ message: \"Post not found\" });\n      }\n\n      // Check ownership (or admin)\n      if (post.authorId !== userId && !(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"You can only delete your own posts\" });\n      }\n\n      await storage.deleteSocialPost(postId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting post:\", error);\n      res.status(500).json({ message: \"Failed to delete post\" });\n    }\n  });\n\n  // Repost a social post (toggle)\n  app.post(\"/api/social-posts/:id/repost\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const postId = req.params.id;\n      const { quoteContent } = req.body;\n\n      // Check if already reposted\n      const isReposted = await storage.isPostReposted(postId, userId);\n      \n      if (isReposted) {\n        // Unrepost\n        await storage.unrepostSocialPost(postId, userId);\n        res.json({ success: true, action: \"unreposted\" });\n      } else {\n        // Repost\n        const repost = await storage.repostSocialPost(postId, userId, quoteContent);\n        res.json({ success: true, action: \"reposted\", repost });\n      }\n    } catch (error) {\n      console.error(\"Error toggling repost:\", error);\n      res.status(500).json({ message: \"Failed to toggle repost\" });\n    }\n  });\n\n  // Get reposts for a post\n  app.get(\"/api/social-posts/:id/reposts\", async (req, res) => {\n    try {\n      const postId = req.params.id;\n      const reposts = await storage.getPostReposts(postId);\n      res.json(reposts);\n    } catch (error) {\n      console.error(\"Error fetching reposts:\", error);\n      res.status(500).json({ message: \"Failed to fetch reposts\" });\n    }\n  });\n\n  // Report a social post\n  app.post(\"/api/social-posts/:id/report\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const postId = req.params.id;\n      const { reason, description } = req.body;\n\n      if (!reason) {\n        return res.status(400).json({ message: \"Report reason is required\" });\n      }\n\n      const validReasons = [\"spam\", \"harassment\", \"hate_speech\", \"violence\", \"inappropriate\", \"misinformation\", \"other\"];\n      if (!validReasons.includes(reason)) {\n        return res.status(400).json({ message: \"Invalid report reason\" });\n      }\n\n      const post = await storage.getSocialPost(postId);\n      if (!post) {\n        return res.status(404).json({ message: \"Post not found\" });\n      }\n\n      if (post.authorId === userId) {\n        return res.status(400).json({ message: \"You cannot report your own post\" });\n      }\n\n      const hasReported = await storage.hasUserReportedPost(postId, userId);\n      if (hasReported) {\n        return res.status(400).json({ message: \"You have already reported this post\" });\n      }\n\n      await storage.createSocialPostReport(postId, userId, reason, description);\n      res.json({ message: \"Report submitted successfully\" });\n    } catch (error) {\n      console.error(\"Error reporting post:\", error);\n      res.status(500).json({ message: \"Failed to submit report\" });\n    }\n  });\n\n  // ========== BOOKMARK ENDPOINTS ==========\n  \n  // Bookmark a post\n  app.post(\"/api/social-posts/:id/bookmark\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const postId = req.params.id;\n      const isBookmarked = await storage.isPostBookmarked(userId, postId);\n      \n      if (isBookmarked) {\n        await storage.unbookmarkPost(userId, postId);\n        res.json({ success: true, action: \"unbookmarked\" });\n      } else {\n        await storage.bookmarkPost(userId, postId);\n        res.json({ success: true, action: \"bookmarked\" });\n      }\n    } catch (error) {\n      console.error(\"Error toggling bookmark:\", error);\n      res.status(500).json({ message: \"Failed to toggle bookmark\" });\n    }\n  });\n  \n  // Get user's bookmarks\n  app.get(\"/api/users/me/bookmarks\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const bookmarks = await storage.getUserBookmarks(userId);\n      res.json(bookmarks);\n    } catch (error) {\n      console.error(\"Error fetching bookmarks:\", error);\n      res.status(500).json({ message: \"Failed to fetch bookmarks\" });\n    }\n  });\n\n  // ========== SMART FEED ALGORITHM ENDPOINTS ==========\n  \n  // Get enhanced feed with algorithm\n  app.get(\"/api/feed\", async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const feedTypeParam = req.query.type as string;\n      const userLat = req.query.lat ? parseFloat(req.query.lat as string) : undefined;\n      const userLng = req.query.lng ? parseFloat(req.query.lng as string) : undefined;\n      \n      // Handle bookmarks feed - requires authentication\n      if (feedTypeParam === 'bookmarks') {\n        if (!userId) {\n          return res.status(401).json({ message: \"Login to view saved posts\" });\n        }\n        const bookmarkedPostData = await storage.getUserBookmarks(userId);\n        \n        // Get user's following list\n        const followingList = await storage.getFollowing(userId);\n        const followingIds = new Set(followingList.map((f: any) => f.followingId || f.following?.id));\n        \n        // Check like and repost status for each bookmarked post\n        const postsWithBookmarks = await Promise.all(bookmarkedPostData.map(async (item) => {\n          const [isLiked, isReposted] = await Promise.all([\n            storage.isPostLiked(item.post.id, userId),\n            storage.isPostReposted(item.post.id, userId)\n          ]);\n          \n          return {\n            ...item.post,\n            author: item.author,\n            isBookmarked: true,\n            isLiked,\n            isFollowingAuthor: followingIds.has(item.post.authorId),\n            isReposted,\n            engagementScore: \"0\",\n          };\n        }));\n        return res.json(postsWithBookmarks);\n      }\n      \n      const feedType = feedTypeParam === 'following' ? 'following' : 'for_you';\n      \n      const posts = await storage.getSocialPostsWithAlgorithm({\n        userId: userId || undefined,\n        feedType: feedType as 'for_you' | 'following',\n        userLat: userLat && !isNaN(userLat) ? userLat : undefined,\n        userLng: userLng && !isNaN(userLng) ? userLng : undefined\n      });\n      \n      // If logged in, also check bookmark status\n      if (userId) {\n        const postsWithBookmarks = await Promise.all(posts.map(async (post) => ({\n          ...post,\n          isBookmarked: await storage.isPostBookmarked(userId, post.id)\n        })));\n        res.json(postsWithBookmarks);\n      } else {\n        res.json(posts.map(p => ({ ...p, isBookmarked: false })));\n      }\n    } catch (error) {\n      console.error(\"Error fetching feed:\", error);\n      res.status(500).json({ message: \"Failed to fetch feed\" });\n    }\n  });\n  \n  // Track post view (unique: 1 view per user per 24 hours)\n  app.post(\"/api/social-posts/:id/view\", async (req: any, res) => {\n    try {\n      const postId = req.params.id;\n      const userId = getUserId(req);\n      \n      // For authenticated users, use unique view tracking\n      if (userId) {\n        const isNewView = await storage.recordUniquePostView(postId, userId);\n        res.json({ success: true, isNewView });\n      } else {\n        // For anonymous users, use session-based tracking\n        const sessionId = req.session?.id || req.ip;\n        if (sessionId) {\n          const viewerKey = `anon_${sessionId}`;\n          const isNewView = await storage.recordUniquePostView(postId, viewerKey);\n          res.json({ success: true, isNewView });\n        } else {\n          // Fallback: just increment without tracking (rare edge case)\n          await storage.incrementPostViews(postId);\n          await storage.updatePostEngagementScore(postId);\n          res.json({ success: true, isNewView: true });\n        }\n      }\n    } catch (error) {\n      console.error(\"Error tracking view:\", error);\n      res.status(500).json({ message: \"Failed to track view\" });\n    }\n  });\n  \n  // Track post share\n  app.post(\"/api/social-posts/:id/share\", async (req: any, res) => {\n    try {\n      const postId = req.params.id;\n      await storage.incrementPostShares(postId);\n      await storage.updatePostEngagementScore(postId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error tracking share:\", error);\n      res.status(500).json({ message: \"Failed to track share\" });\n    }\n  });\n\n  // ========== POST PIN ENDPOINTS ==========\n  \n  // Pin a post\n  app.post(\"/api/social-posts/:id/pin\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const postId = req.params.id;\n      const post = await storage.getSocialPostById(postId);\n      \n      if (!post || post.authorId !== userId) {\n        return res.status(403).json({ message: \"You can only pin your own posts\" });\n      }\n      \n      await storage.pinSocialPost(postId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error pinning post:\", error);\n      res.status(500).json({ message: \"Failed to pin post\" });\n    }\n  });\n  \n  // Unpin a post\n  app.delete(\"/api/social-posts/:id/pin\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const postId = req.params.id;\n      const post = await storage.getSocialPostById(postId);\n      \n      if (!post || post.authorId !== userId) {\n        return res.status(403).json({ message: \"You can only unpin your own posts\" });\n      }\n      \n      await storage.unpinSocialPost(postId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error unpinning post:\", error);\n      res.status(500).json({ message: \"Failed to unpin post\" });\n    }\n  });\n  \n  // Get user's pinned posts\n  app.get(\"/api/users/:id/pinned-posts\", async (req, res) => {\n    try {\n      const userId = req.params.id;\n      const pinnedPosts = await storage.getUserPinnedPosts(userId);\n      res.json(pinnedPosts);\n    } catch (error) {\n      console.error(\"Error fetching pinned posts:\", error);\n      res.status(500).json({ message: \"Failed to fetch pinned posts\" });\n    }\n  });\n\n  // ========== LOCATION ENDPOINTS ==========\n  \n  // Update user location (GPS coordinates)\n  app.patch(\"/api/users/me/location\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const { latitude, longitude } = req.body;\n      \n      if (latitude === undefined || longitude === undefined) {\n        return res.status(400).json({ message: \"Latitude and longitude are required\" });\n      }\n      \n      // Validate coordinates\n      const lat = parseFloat(latitude);\n      const lng = parseFloat(longitude);\n      \n      if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {\n        return res.status(400).json({ message: \"Invalid coordinates\" });\n      }\n      \n      const user = await storage.updateUserLocation(userId, lat.toString(), lng.toString());\n      const { password, ...safeUser } = user;\n      res.json(safeUser);\n    } catch (error) {\n      console.error(\"Error updating location:\", error);\n      res.status(500).json({ message: \"Failed to update location\" });\n    }\n  });\n\n  // ========== USERNAME AND PROFILE ENDPOINTS ==========\n  \n  // Get user by username\n  app.get(\"/api/users/username/:username\", async (req, res) => {\n    try {\n      const username = req.params.username;\n      const user = await storage.getUserByUsername(username);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      // Return safe user data (no password)\n      const { password, ...safeUser } = user;\n      res.json(safeUser);\n    } catch (error) {\n      console.error(\"Error fetching user by username:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n  \n  // Update username\n  app.patch(\"/api/users/me/username\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const { username } = req.body;\n      if (!username || username.length < 3 || username.length > 20) {\n        return res.status(400).json({ message: \"Username must be 3-20 characters\" });\n      }\n      \n      // Check if username is taken\n      const existing = await storage.getUserByUsername(username);\n      if (existing && existing.id !== userId) {\n        return res.status(409).json({ message: \"Username already taken\" });\n      }\n      \n      const user = await storage.updateUsername(userId, username);\n      const { password, ...safeUser } = user;\n      res.json(safeUser);\n    } catch (error) {\n      console.error(\"Error updating username:\", error);\n      res.status(500).json({ message: \"Failed to update username\" });\n    }\n  });\n\n  // ========== EKSUPLUG SYSTEM ACCOUNT ENDPOINTS ==========\n  \n  // Get or create Marketplace system account\n  app.get(\"/api/system/marketplace\", async (req, res) => {\n    try {\n      let marketplace = await storage.getSystemAccount(\"marketplace\");\n      \n      if (!marketplace) {\n        // Create the @EksuMarketplaceOfficial system account\n        marketplace = await storage.createSystemAccount({\n          email: \"system@eksucampusmarketplace.com\",\n          username: \"EksuMarketplaceOfficial\",\n          firstName: \"EKSU\",\n          lastName: \"Marketplace\",\n          type: \"marketplace\",\n          bio: \"Official EKSU Campus Marketplace. Your trusted platform for campus trading, announcements, and community updates.\",\n          profileImageUrl: \"/eksu-marketplace-avatar.png\"\n        });\n      }\n      \n      const { password, ...safeUser } = marketplace;\n      res.json(safeUser);\n    } catch (error) {\n      console.error(\"Error getting Marketplace account:\", error);\n      res.status(500).json({ message: \"Failed to get Marketplace account\" });\n    }\n  });\n  \n  // Post as Marketplace (Admin only)\n  app.post(\"/api/system/marketplace/post\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      // Check if user is admin\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Only admins can post as Marketplace\" });\n      }\n      \n      // Get or create Marketplace account\n      let marketplace = await storage.getSystemAccount(\"marketplace\");\n      if (!marketplace) {\n        marketplace = await storage.createSystemAccount({\n          email: \"system@eksucampusmarketplace.com\",\n          username: \"EksuMarketplaceOfficial\",\n          firstName: \"EKSU\",\n          lastName: \"Marketplace\",\n          type: \"marketplace\",\n          bio: \"Official EKSU Campus Marketplace. Your trusted platform for campus trading, announcements, and community updates.\",\n        });\n      }\n      \n      const { content, images, videos, replyRestriction } = req.body;\n      \n      // Extract hashtags from content\n      const hashtags = (content.match(/#\\w+/g) || []).map((h: string) => h.slice(1).toLowerCase());\n      \n      // Extract mentions from content\n      const mentionMatches = content.match(/@\\w+/g) || [];\n      const mentionedUsernames = mentionMatches.map((m: string) => m.slice(1).toLowerCase());\n      const mentionedUserIds: string[] = [];\n      \n      for (const username of mentionedUsernames) {\n        const user = await storage.getUserByUsername(username);\n        if (user) mentionedUserIds.push(user.id);\n      }\n      \n      const post = await storage.createSocialPostWithOptions({\n        authorId: marketplace.id,\n        content,\n        images: images || [],\n        videos: videos || [],\n        replyRestriction: replyRestriction || 'everyone',\n        mentionedUserIds,\n        hashtags,\n        isFromSystemAccount: true\n      });\n      \n      res.json(post);\n    } catch (error) {\n      console.error(\"Error posting as Marketplace:\", error);\n      res.status(500).json({ message: \"Failed to post as Marketplace\" });\n    }\n  });\n  \n  // Auto-follow Marketplace on user registration (called internally)\n  app.post(\"/api/system/marketplace/auto-follow\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      // Get Marketplace account\n      let marketplace = await storage.getSystemAccount(\"marketplace\");\n      if (!marketplace) {\n        marketplace = await storage.createSystemAccount({\n          email: \"system@eksucampusmarketplace.com\",\n          username: \"EksuMarketplaceOfficial\", \n          firstName: \"EKSU\",\n          lastName: \"Marketplace\",\n          type: \"marketplace\",\n          bio: \"Official EKSU Campus Marketplace. Your trusted platform for campus trading, announcements, and community updates.\",\n        });\n      }\n      \n      // Check if already following\n      const isFollowing = await storage.isFollowing(userId, marketplace.id);\n      if (!isFollowing) {\n        await storage.followUser(userId, marketplace.id);\n      }\n      \n      res.json({ success: true, following: true });\n    } catch (error) {\n      console.error(\"Error auto-following Marketplace:\", error);\n      res.status(500).json({ message: \"Failed to auto-follow Marketplace\" });\n    }\n  });\n\n  // Admin Metrics Routes - Database & Memory Monitoring\n  app.get(\"/api/admin/metrics/tables\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      // Query PostgreSQL catalog for table statistics\n      const result = await storage.executeRawSQL<{\n        table_name: string;\n        row_estimate: number;\n        total_size_bytes: number;\n        indexes_size_bytes: number;\n        table_size_bytes: number;\n      }>(\n        `\n        SELECT \n          schemaname || '.' || tablename as table_name,\n          n_live_tup as row_estimate,\n          pg_total_relation_size(schemaname||'.'||tablename) as total_size_bytes,\n          pg_indexes_size(schemaname||'.'||tablename) as indexes_size_bytes,\n          pg_relation_size(schemaname||'.'||tablename) as table_size_bytes\n        FROM pg_stat_user_tables\n        WHERE schemaname NOT IN ('pg_catalog', 'information_schema')\n        ORDER BY total_size_bytes DESC\n        LIMIT 50\n        `\n      );\n\n      // Get database size\n      const dbSize = await storage.executeRawSQL<{ db_size_bytes: number }>(\n        \"SELECT pg_database_size(current_database()) as db_size_bytes\"\n      );\n\n      res.json({\n        tables: result,\n        totalDatabaseSize: dbSize[0]?.db_size_bytes || 0,\n      });\n    } catch (error) {\n      console.error(\"Error fetching table metrics:\", error);\n      res.status(500).json({ message: \"Failed to fetch table metrics\" });\n    }\n  });\n\n  app.get(\"/api/admin/metrics/activity\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      // Query active connections from pg_stat_activity\n      const connections = await storage.executeRawSQL<{\n        state: string;\n        count: number;\n      }>(\n        `\n        SELECT \n          state,\n          COUNT(*) as count\n        FROM pg_stat_activity\n        WHERE datname = current_database()\n        GROUP BY state\n        `\n      );\n\n      // Get total connection count and max age\n      const stats = await storage.executeRawSQL<{\n        total_connections: number;\n        max_connection_age_seconds: number;\n      }>(\n        `\n        SELECT \n          COUNT(*) as total_connections,\n          EXTRACT(EPOCH FROM MAX(NOW() - state_change)) as max_connection_age_seconds\n        FROM pg_stat_activity\n        WHERE datname = current_database()\n        `\n      );\n\n      res.json({\n        connectionsByState: connections,\n        totalConnections: stats[0]?.total_connections || 0,\n        maxConnectionAge: stats[0]?.max_connection_age_seconds || 0,\n      });\n    } catch (error) {\n      console.error(\"Error fetching activity metrics:\", error);\n      res.status(500).json({ message: \"Failed to fetch activity metrics\" });\n    }\n  });\n\n  app.get(\"/api/admin/metrics/performance\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      // Check if pg_stat_statements extension is available\n      const hasExtension = await storage.executeRawSQL<{ exists: boolean }>(\n        `SELECT EXISTS(SELECT 1 FROM pg_extension WHERE extname = 'pg_stat_statements') as exists`\n      );\n\n      let queryStats: Array<{\n        query: string;\n        calls: number;\n        total_time_ms: number;\n        mean_time_ms: number;\n        rows: number;\n      }> = [];\n      if (hasExtension[0]?.exists) {\n        // Get query performance stats from pg_stat_statements\n        queryStats = await storage.executeRawSQL<{\n          query: string;\n          calls: number;\n          total_time_ms: number;\n          mean_time_ms: number;\n          rows: number;\n        }>(\n          `\n          SELECT \n            LEFT(query, 100) as query,\n            calls,\n            total_exec_time as total_time_ms,\n            mean_exec_time as mean_time_ms,\n            rows\n          FROM pg_stat_statements\n          WHERE dbid = (SELECT oid FROM pg_database WHERE datname = current_database())\n          ORDER BY mean_exec_time DESC\n          LIMIT 20\n          `\n        );\n      }\n\n      // Get database-level stats (always available)\n      const dbStats = await storage.executeRawSQL<{\n        deadlocks: number;\n        temp_files: number;\n        temp_bytes: number;\n      }>(\n        `\n        SELECT \n          deadlocks,\n          temp_files,\n          temp_bytes\n        FROM pg_stat_database\n        WHERE datname = current_database()\n        `\n      );\n\n      res.json({\n        queryStats,\n        databaseStats: dbStats[0] || { deadlocks: 0, temp_files: 0, temp_bytes: 0 },\n        extensionAvailable: hasExtension[0]?.exists || false,\n      });\n    } catch (error) {\n      console.error(\"Error fetching performance metrics:\", error);\n      res.status(500).json({ message: \"Failed to fetch performance metrics\" });\n    }\n  });\n\n  // Admin - Get all platform settings\n  app.get(\"/api/admin/platform-settings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const settings = await storage.getAllPlatformSettings();\n      res.json(settings);\n    } catch (error) {\n      console.error(\"Error fetching platform settings:\", error);\n      res.status(500).json({ message: \"Failed to fetch platform settings\" });\n    }\n  });\n\n  // Admin - Update platform setting\n  app.patch(\"/api/admin/platform-settings/:key\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const { key } = req.params;\n      const { value } = req.body;\n\n      if (!key) {\n        return res.status(400).json({ message: \"Setting key is required\" });\n      }\n\n      if (typeof value !== \"string\") {\n        return res.status(400).json({ message: \"Value must be a string\" });\n      }\n\n      const setting = await storage.updatePlatformSetting(key, value, userId);\n      res.json(setting);\n    } catch (error) {\n      console.error(\"Error updating platform setting:\", error);\n      res.status(500).json({ message: \"Failed to update platform setting\" });\n    }\n  });\n\n  // ==================== VTU API ROUTES ====================\n\n  // ==================== VTU BENEFICIARIES ====================\n\n  // Get user's saved beneficiaries\n  app.get(\"/api/vtu/beneficiaries\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const beneficiaries = await storage.getUserBeneficiaries(userId);\n      res.json(beneficiaries);\n    } catch (error) {\n      console.error(\"Error fetching beneficiaries:\", error);\n      res.status(500).json({ message: \"Failed to fetch beneficiaries\" });\n    }\n  });\n\n  // Create a new beneficiary\n  app.post(\"/api/vtu/beneficiaries\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const validationResult = createBeneficiarySchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Validation failed\",\n          errors: validationResult.error.flatten().fieldErrors\n        });\n      }\n\n      const beneficiary = await storage.createBeneficiary({\n        userId,\n        ...validationResult.data,\n      });\n      res.json(beneficiary);\n    } catch (error) {\n      console.error(\"Error creating beneficiary:\", error);\n      res.status(500).json({ message: \"Failed to create beneficiary\" });\n    }\n  });\n\n  // Update a beneficiary\n  app.put(\"/api/vtu/beneficiaries/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { id } = req.params;\n      const beneficiary = await storage.getBeneficiary(id);\n      \n      if (!beneficiary) {\n        return res.status(404).json({ message: \"Beneficiary not found\" });\n      }\n      \n      if (beneficiary.userId !== userId) {\n        return res.status(403).json({ message: \"Not authorized to update this beneficiary\" });\n      }\n\n      const updated = await storage.updateBeneficiary(id, req.body);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating beneficiary:\", error);\n      res.status(500).json({ message: \"Failed to update beneficiary\" });\n    }\n  });\n\n  // Delete a beneficiary\n  app.delete(\"/api/vtu/beneficiaries/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { id } = req.params;\n      const beneficiary = await storage.getBeneficiary(id);\n      \n      if (!beneficiary) {\n        return res.status(404).json({ message: \"Beneficiary not found\" });\n      }\n      \n      if (beneficiary.userId !== userId) {\n        return res.status(403).json({ message: \"Not authorized to delete this beneficiary\" });\n      }\n\n      await storage.deleteBeneficiary(id);\n      res.json({ success: true, message: \"Beneficiary deleted\" });\n    } catch (error) {\n      console.error(\"Error deleting beneficiary:\", error);\n      res.status(500).json({ message: \"Failed to delete beneficiary\" });\n    }\n  });\n\n  // Get user's VTU transaction history with filters\n  app.get(\"/api/vtu/transactions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { status, network, startDate, endDate } = req.query;\n      \n      const filters: { status?: string; network?: string; startDate?: Date; endDate?: Date } = {};\n      if (status && typeof status === \"string\") filters.status = status;\n      if (network && typeof network === \"string\") filters.network = network;\n      if (startDate && typeof startDate === \"string\") filters.startDate = new Date(startDate);\n      if (endDate && typeof endDate === \"string\") filters.endDate = new Date(endDate);\n\n      const transactions = await storage.getUserVtuTransactions(userId, filters);\n      res.json(transactions);\n    } catch (error) {\n      console.error(\"Error fetching VTU transactions:\", error);\n      res.status(500).json({ message: \"Failed to fetch transactions\" });\n    }\n  });\n\n  // Get all VTU plans (optionally filter by network)\n  app.get(\"/api/vtu/plans\", async (req, res) => {\n    try {\n      const { network } = req.query;\n      const plans = await storage.getVtuPlans(typeof network === \"string\" ? network : undefined);\n      res.json(plans);\n    } catch (error) {\n      console.error(\"Error fetching VTU plans:\", error);\n      res.status(500).json({ message: \"Failed to fetch VTU plans\" });\n    }\n  });\n\n  // Admin endpoint: Update VTU plan pricing (manual management)\n  // Note: SMEDATA API doesn't have a plans endpoint - plans must be manually managed\n  app.post(\"/api/admin/vtu/update-plan\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Only admins can update VTU plans\" });\n      }\n\n      const { planId, costPrice, sellingPrice, isActive } = req.body;\n      \n      if (!planId) {\n        return res.status(400).json({ message: \"Plan ID is required\" });\n      }\n\n      const plan = await storage.getVtuPlan(planId);\n      if (!plan) {\n        return res.status(404).json({ message: \"VTU plan not found\" });\n      }\n\n      // Update plan with new pricing\n      await storage.upsertVtuPlan({\n        network: plan.network as any,\n        planName: plan.planName,\n        dataAmount: plan.dataAmount,\n        validity: plan.validity,\n        costPrice: costPrice ?? plan.costPrice,\n        sellingPrice: sellingPrice ?? plan.sellingPrice,\n        planCode: plan.planCode,\n        isActive: isActive ?? plan.isActive,\n        sortOrder: plan.sortOrder ?? 0,\n      });\n\n      console.log(`[VTU Admin] Updated plan ${plan.planName}: cost=${costPrice}, sell=${sellingPrice}, active=${isActive}`);\n\n      res.json({\n        success: true,\n        message: `Plan \"${plan.planName}\" updated successfully`,\n      });\n    } catch (error: any) {\n      console.error(\"[VTU Admin] Error updating VTU plan:\", error);\n      res.status(500).json({ \n        success: false,\n        message: \"Failed to update VTU plan\",\n      });\n    }\n  });\n\n  // Admin endpoint: Add new VTU plan\n  app.post(\"/api/admin/vtu/add-plan\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Only admins can add VTU plans\" });\n      }\n\n      const { network, planName, dataAmount, validity, costPrice, sellingPrice, planCode, sortOrder } = req.body;\n      \n      if (!network || !planName || !dataAmount || !costPrice || !sellingPrice) {\n        return res.status(400).json({ \n          message: \"Missing required fields: network, planName, dataAmount, costPrice, sellingPrice\" \n        });\n      }\n\n      // Validate network\n      const validNetworks = [\"mtn_sme\", \"glo_cg\", \"airtel_cg\", \"9mobile\"];\n      if (!validNetworks.includes(network)) {\n        return res.status(400).json({ message: \"Invalid network. Must be one of: \" + validNetworks.join(\", \") });\n      }\n\n      // Check for duplicate\n      const existing = await storage.getVtuPlanByNetworkAndDataAmount(network, dataAmount);\n      if (existing) {\n        return res.status(409).json({ message: `Plan for ${network} ${dataAmount} already exists` });\n      }\n\n      await storage.upsertVtuPlan({\n        network: network as any,\n        planName,\n        dataAmount: dataAmount.toUpperCase(),\n        validity: validity || \"30 days\",\n        costPrice,\n        sellingPrice,\n        planCode: planCode || `${network}_${dataAmount}`.toLowerCase().replace(/\\s+/g, \"_\"),\n        isActive: true,\n        sortOrder: sortOrder ?? 0,\n      });\n\n      console.log(`[VTU Admin] Added new plan: ${planName}`);\n\n      res.json({\n        success: true,\n        message: `Plan \"${planName}\" added successfully`,\n      });\n    } catch (error: any) {\n      console.error(\"[VTU Admin] Error adding VTU plan:\", error);\n      res.status(500).json({ \n        success: false,\n        message: \"Failed to add VTU plan\",\n      });\n    }\n  });\n\n  // Admin endpoint: Requery order status\n  app.post(\"/api/admin/vtu/requery\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Only admins can requery orders\" });\n      }\n\n      const { orderId } = req.body;\n      if (!orderId) {\n        return res.status(400).json({ message: \"Order ID is required\" });\n      }\n\n      const result = await requeryOrder(orderId);\n      res.json(result);\n    } catch (error: any) {\n      console.error(\"[VTU Admin] Error requerying order:\", error);\n      res.status(500).json({ \n        success: false,\n        message: \"Failed to requery order\",\n      });\n    }\n  });\n\n  // Admin endpoint: Get all VTU plans (including inactive)\n  app.get(\"/api/admin/vtu/all-plans\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      if (!(await isAdminUser(userId))) {\n        return res.status(403).json({ message: \"Only admins can view all VTU plans\" });\n      }\n\n      const plans = await storage.getAllVtuPlans();\n      res.json(plans);\n    } catch (error) {\n      console.error(\"Error fetching all VTU plans:\", error);\n      res.status(500).json({ message: \"Failed to fetch VTU plans\" });\n    }\n  });\n\n  // Purchase VTU data\n  app.post(\"/api/vtu/purchase\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      // Validate request body\n      const validationResult = purchaseVtuSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Validation failed\",\n          errors: validationResult.error.flatten().fieldErrors\n        });\n      }\n\n      const { planId, phoneNumber } = validationResult.data;\n\n      // Validate Nigerian phone number\n      if (!isValidNigerianPhone(phoneNumber)) {\n        return res.status(400).json({ message: \"Invalid Nigerian phone number\" });\n      }\n\n      // Get the VTU plan\n      const plan = await storage.getVtuPlan(planId);\n      if (!plan) {\n        return res.status(404).json({ message: \"VTU plan not found\" });\n      }\n\n      if (!plan.isActive) {\n        return res.status(400).json({ message: \"This VTU plan is currently unavailable\" });\n      }\n\n      const planPrice = parseFloat(plan.sellingPrice);\n      const costPrice = parseFloat(plan.costPrice);\n      const profit = planPrice - costPrice;\n\n      // Get user's wallet\n      const wallet = await storage.getOrCreateWallet(userId);\n      const walletBalance = parseFloat(wallet.balance);\n\n      // Check sufficient balance\n      if (walletBalance < planPrice) {\n        return res.status(400).json({ \n          message: \"Insufficient wallet balance\",\n          required: planPrice,\n          available: walletBalance\n        });\n      }\n\n      // Deduct from wallet\n      await storage.updateWalletBalance(userId, planPrice.toString(), \"subtract\");\n\n      // Create VTU transaction with pending status\n      const transaction = await storage.createVtuTransaction({\n        userId,\n        planId,\n        phoneNumber,\n        amount: plan.sellingPrice,\n        network: plan.network,\n        costPrice: plan.costPrice,\n        profit: profit.toString(),\n        status: \"pending\",\n      });\n\n      // Create wallet transaction record\n      await storage.createTransaction({\n        walletId: wallet.id,\n        type: \"purchase\",\n        amount: `-${planPrice}`,\n        status: \"completed\",\n        description: `VTU Data Purchase: ${plan.dataAmount} for ${phoneNumber}`,\n        relatedUserId: userId,\n      });\n\n      // Process the actual purchase if API is configured\n      if (isSMEDataConfigured()) {\n        try {\n          // Use dataAmount (e.g., \"1GB\", \"500MB\") for SME Data API, not planCode\n          const purchaseResult = await purchaseData(plan.network, phoneNumber, plan.dataAmount);\n          \n          if (purchaseResult.success) {\n            // Update transaction as successful\n            await storage.updateVtuTransaction(transaction.id, {\n              status: \"success\",\n              smedataReference: purchaseResult.reference,\n            });\n\n            res.json({\n              success: true,\n              message: \"Data purchase successful\",\n              transaction: {\n                ...transaction,\n                status: \"success\",\n                smedataReference: purchaseResult.reference,\n              },\n            });\n          } else {\n            // Purchase failed - refund the user\n            await storage.updateWalletBalance(userId, planPrice.toString(), \"add\");\n            await storage.updateVtuTransaction(transaction.id, {\n              status: \"failed\",\n              errorMessage: purchaseResult.message || purchaseResult.error,\n            });\n\n            // Create refund transaction record\n            await storage.createTransaction({\n              walletId: wallet.id,\n              type: \"refund\",\n              amount: planPrice.toString(),\n              status: \"completed\",\n              description: `VTU Refund: ${plan.dataAmount} for ${phoneNumber} - ${purchaseResult.message}`,\n              relatedUserId: userId,\n            });\n\n            res.status(400).json({\n              success: false,\n              message: purchaseResult.message || \"Data purchase failed. Amount refunded.\",\n              error: purchaseResult.error,\n            });\n          }\n        } catch (apiError: any) {\n          // API call failed - refund the user\n          await storage.updateWalletBalance(userId, planPrice.toString(), \"add\");\n          await storage.updateVtuTransaction(transaction.id, {\n            status: \"failed\",\n            errorMessage: apiError.message || \"API error\",\n          });\n\n          // Create refund transaction record\n          await storage.createTransaction({\n            walletId: wallet.id,\n            type: \"refund\",\n            amount: planPrice.toString(),\n            status: \"completed\",\n            description: `VTU Refund: ${plan.dataAmount} for ${phoneNumber} - API Error`,\n            relatedUserId: userId,\n          });\n\n          console.error(\"VTU API error:\", apiError);\n          res.status(500).json({\n            success: false,\n            message: \"Data purchase failed due to network error. Amount refunded.\",\n          });\n        }\n      } else {\n        // API not configured - mark as pending for manual processing\n        await storage.updateVtuTransaction(transaction.id, {\n          status: \"pending\",\n          errorMessage: \"VTU service temporarily unavailable\",\n        });\n\n        res.json({\n          success: true,\n          message: \"Purchase request submitted. Your data will be delivered shortly.\",\n          transaction,\n        });\n      }\n    } catch (error) {\n      console.error(\"Error processing VTU purchase:\", error);\n      res.status(500).json({ message: \"Failed to process VTU purchase\" });\n    }\n  });\n\n  // Purchase airtime\n  app.post(\"/api/vtu/airtime\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const validationResult = purchaseAirtimeSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Validation failed\",\n          errors: validationResult.error.flatten().fieldErrors\n        });\n      }\n\n      const { phoneNumber, amount, network } = validationResult.data;\n\n      if (!isValidNigerianPhone(phoneNumber)) {\n        return res.status(400).json({ message: \"Invalid Nigerian phone number\" });\n      }\n\n      const wallet = await storage.getOrCreateWallet(userId);\n      const walletBalance = parseFloat(wallet.balance);\n\n      if (walletBalance < amount) {\n        return res.status(400).json({ \n          message: \"Insufficient wallet balance\",\n          required: amount,\n          available: walletBalance\n        });\n      }\n\n      await storage.updateWalletBalance(userId, amount.toString(), \"subtract\");\n\n      await storage.createTransaction({\n        walletId: wallet.id,\n        type: \"purchase\",\n        amount: `-${amount}`,\n        status: \"pending\",\n        description: `Airtime Purchase: ₦${amount} for ${phoneNumber}`,\n      });\n\n      if (isSMEDataConfigured()) {\n        try {\n          const purchaseResult = await purchaseAirtime(network, phoneNumber, amount);\n          \n          if (purchaseResult.success) {\n            await storage.createTransaction({\n              walletId: wallet.id,\n              type: \"purchase\",\n              amount: `-${amount}`,\n              status: \"completed\",\n              description: `Airtime Purchase: ₦${amount} for ${phoneNumber}`,\n            });\n\n            res.json({\n              success: true,\n              message: \"Airtime purchase successful\",\n              reference: purchaseResult.reference,\n            });\n          } else {\n            await storage.updateWalletBalance(userId, amount.toString(), \"add\");\n            await storage.createTransaction({\n              walletId: wallet.id,\n              type: \"refund\",\n              amount: amount.toString(),\n              status: \"completed\",\n              description: `Airtime Refund: ₦${amount} for ${phoneNumber} - ${purchaseResult.message}`,\n            });\n\n            res.status(400).json({\n              success: false,\n              message: purchaseResult.message || \"Airtime purchase failed. Amount refunded.\",\n              error: purchaseResult.error,\n            });\n          }\n        } catch (apiError: any) {\n          await storage.updateWalletBalance(userId, amount.toString(), \"add\");\n          await storage.createTransaction({\n            walletId: wallet.id,\n            type: \"refund\",\n            amount: amount.toString(),\n            status: \"completed\",\n            description: `Airtime Refund: ₦${amount} for ${phoneNumber} - API Error`,\n          });\n\n          console.error(\"Airtime API error:\", apiError);\n          res.status(500).json({\n            success: false,\n            message: \"Airtime purchase failed due to network error. Amount refunded.\",\n          });\n        }\n      } else {\n        res.json({\n          success: true,\n          message: \"Airtime purchase request submitted. Your airtime will be delivered shortly.\",\n        });\n      }\n    } catch (error) {\n      console.error(\"Error processing airtime purchase:\", error);\n      res.status(500).json({ message: \"Failed to process airtime purchase\" });\n    }\n  });\n\n  // ==================== SCHEDULED VTU PURCHASES API ROUTES ====================\n\n  // Get user's scheduled purchases\n  app.get(\"/api/vtu/scheduled-purchases\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const purchases = await storage.getScheduledPurchases(userId);\n      res.json(purchases);\n    } catch (error) {\n      console.error(\"Error fetching scheduled purchases:\", error);\n      res.status(500).json({ message: \"Failed to fetch scheduled purchases\" });\n    }\n  });\n\n  // Create a scheduled purchase\n  app.post(\"/api/vtu/scheduled-purchases\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const validationResult = createScheduledPurchaseApiSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({\n          message: \"Validation failed\",\n          errors: validationResult.error.flatten().fieldErrors,\n        });\n      }\n\n      const { serviceType, planId, network, phoneNumber, amount, frequency, dayOfWeek, dayOfMonth, timeOfDay } = validationResult.data;\n\n      if (!isValidNigerianPhone(phoneNumber)) {\n        return res.status(400).json({ message: \"Invalid Nigerian phone number\" });\n      }\n\n      // Validate that data purchases have planId\n      if (serviceType === \"data\" && !planId) {\n        return res.status(400).json({ message: \"Plan ID is required for data purchases\" });\n      }\n\n      // Validate that airtime purchases have amount\n      if (serviceType === \"airtime\" && !amount) {\n        return res.status(400).json({ message: \"Amount is required for airtime purchases\" });\n      }\n\n      // Validate frequency-specific fields\n      if (frequency === \"weekly\" && (dayOfWeek === undefined || dayOfWeek < 0 || dayOfWeek > 6)) {\n        return res.status(400).json({ message: \"Day of week (0-6) is required for weekly frequency\" });\n      }\n      if (frequency === \"monthly\" && (dayOfMonth === undefined || dayOfMonth < 1 || dayOfMonth > 28)) {\n        return res.status(400).json({ message: \"Day of month (1-28) is required for monthly frequency\" });\n      }\n\n      // Calculate next run time\n      const now = new Date();\n      let nextRunAt = new Date();\n      const [hours, minutes] = (timeOfDay || \"09:00\").split(\":\").map(Number);\n      nextRunAt.setHours(hours, minutes, 0, 0);\n\n      if (frequency === \"daily\") {\n        if (nextRunAt <= now) {\n          nextRunAt.setDate(nextRunAt.getDate() + 1);\n        }\n      } else if (frequency === \"weekly\") {\n        const currentDay = now.getDay();\n        let daysUntilTarget = (dayOfWeek! - currentDay + 7) % 7;\n        if (daysUntilTarget === 0 && nextRunAt <= now) {\n          daysUntilTarget = 7;\n        }\n        nextRunAt.setDate(now.getDate() + daysUntilTarget);\n      } else if (frequency === \"monthly\") {\n        nextRunAt.setDate(dayOfMonth!);\n        if (nextRunAt <= now) {\n          nextRunAt.setMonth(nextRunAt.getMonth() + 1);\n        }\n      }\n\n      const purchase = await storage.createScheduledPurchase({\n        userId,\n        serviceType,\n        planId: planId || null,\n        network,\n        phoneNumber,\n        amount: amount?.toString() || null,\n        frequency,\n        dayOfWeek: dayOfWeek ?? null,\n        dayOfMonth: dayOfMonth ?? null,\n        timeOfDay: timeOfDay || \"09:00\",\n        nextRunAt,\n        status: \"active\",\n      });\n\n      res.status(201).json(purchase);\n    } catch (error) {\n      console.error(\"Error creating scheduled purchase:\", error);\n      res.status(500).json({ message: \"Failed to create scheduled purchase\" });\n    }\n  });\n\n  // Update a scheduled purchase\n  app.put(\"/api/vtu/scheduled-purchases/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { id } = req.params;\n      const existing = await storage.getScheduledPurchase(id);\n      \n      if (!existing) {\n        return res.status(404).json({ message: \"Scheduled purchase not found\" });\n      }\n\n      if (existing.userId !== userId) {\n        return res.status(403).json({ message: \"Not authorized to update this scheduled purchase\" });\n      }\n\n      const updateData: Record<string, any> = {};\n      const { status, phoneNumber, timeOfDay, frequency, dayOfWeek, dayOfMonth } = req.body;\n\n      if (status && [\"active\", \"paused\", \"cancelled\"].includes(status)) {\n        updateData.status = status;\n      }\n\n      if (phoneNumber) {\n        if (!isValidNigerianPhone(phoneNumber)) {\n          return res.status(400).json({ message: \"Invalid Nigerian phone number\" });\n        }\n        updateData.phoneNumber = phoneNumber;\n      }\n\n      if (timeOfDay) {\n        updateData.timeOfDay = timeOfDay;\n      }\n\n      if (frequency) {\n        updateData.frequency = frequency;\n        if (frequency === \"weekly\" && dayOfWeek !== undefined) {\n          updateData.dayOfWeek = dayOfWeek;\n        }\n        if (frequency === \"monthly\" && dayOfMonth !== undefined) {\n          updateData.dayOfMonth = dayOfMonth;\n        }\n      }\n\n      const updated = await storage.updateScheduledPurchase(id, updateData);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating scheduled purchase:\", error);\n      res.status(500).json({ message: \"Failed to update scheduled purchase\" });\n    }\n  });\n\n  // Delete a scheduled purchase\n  app.delete(\"/api/vtu/scheduled-purchases/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { id } = req.params;\n      const existing = await storage.getScheduledPurchase(id);\n      \n      if (!existing) {\n        return res.status(404).json({ message: \"Scheduled purchase not found\" });\n      }\n\n      if (existing.userId !== userId) {\n        return res.status(403).json({ message: \"Not authorized to delete this scheduled purchase\" });\n      }\n\n      await storage.deleteScheduledPurchase(id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting scheduled purchase:\", error);\n      res.status(500).json({ message: \"Failed to delete scheduled purchase\" });\n    }\n  });\n\n  // ==================== GIFT DATA API ROUTES ====================\n\n  // Helper function to generate random gift code\n  function generateGiftCode(): string {\n    return crypto.randomBytes(4).toString(\"hex\").toUpperCase();\n  }\n\n  // Get user's sent gifts\n  app.get(\"/api/vtu/gift-data\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const gifts = await storage.getGiftsByUser(userId);\n      res.json(gifts);\n    } catch (error) {\n      console.error(\"Error fetching gifts:\", error);\n      res.status(500).json({ message: \"Failed to fetch gifts\" });\n    }\n  });\n\n  // Create a gift data\n  app.post(\"/api/vtu/gift-data\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const validationResult = createGiftDataApiSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({\n          message: \"Validation failed\",\n          errors: validationResult.error.flatten().fieldErrors,\n        });\n      }\n\n      const { recipientPhone, planId, network, message } = validationResult.data;\n\n      if (!isValidNigerianPhone(recipientPhone)) {\n        return res.status(400).json({ message: \"Invalid Nigerian phone number\" });\n      }\n\n      // Verify the plan exists\n      const plan = await storage.getVtuPlan(planId);\n      if (!plan) {\n        return res.status(400).json({ message: \"Invalid data plan\" });\n      }\n\n      // Check if user has sufficient balance\n      const wallet = await storage.getOrCreateWallet(userId);\n      const planPrice = parseFloat(plan.sellingPrice);\n      const walletBalance = parseFloat(wallet.balance);\n\n      if (walletBalance < planPrice) {\n        return res.status(400).json({\n          message: \"Insufficient wallet balance\",\n          required: planPrice,\n          available: walletBalance,\n        });\n      }\n\n      // Deduct from wallet\n      await storage.updateWalletBalance(userId, planPrice.toString(), \"subtract\");\n\n      // Create transaction record\n      await storage.createTransaction({\n        walletId: wallet.id,\n        type: \"purchase\",\n        amount: `-${planPrice}`,\n        status: \"completed\",\n        description: `Gift Data: ${plan.dataAmount} for ${recipientPhone}`,\n      });\n\n      // Generate unique gift code\n      let giftCode = generateGiftCode();\n      let existingGift = await storage.getGiftByCode(giftCode);\n      while (existingGift) {\n        giftCode = generateGiftCode();\n        existingGift = await storage.getGiftByCode(giftCode);\n      }\n\n      // Set expiry (7 days from now)\n      const expiresAt = new Date();\n      expiresAt.setDate(expiresAt.getDate() + 7);\n\n      const gift = await storage.createGiftData({\n        senderId: userId,\n        recipientPhone,\n        planId,\n        network,\n        message: message || null,\n        giftCode,\n        status: \"pending\",\n        expiresAt,\n      });\n\n      res.status(201).json({\n        ...gift,\n        plan,\n        message: `Gift created successfully. Share the code ${giftCode} with the recipient.`,\n      });\n    } catch (error) {\n      console.error(\"Error creating gift:\", error);\n      res.status(500).json({ message: \"Failed to create gift\" });\n    }\n  });\n\n  // Claim a gift using gift code\n  app.post(\"/api/vtu/gift-data/:code/claim\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { code } = req.params;\n      const gift = await storage.getGiftByCode(code.toUpperCase());\n\n      if (!gift) {\n        return res.status(404).json({ message: \"Gift code not found\" });\n      }\n\n      if (gift.status === \"claimed\") {\n        return res.status(400).json({ message: \"This gift has already been claimed\" });\n      }\n\n      if (gift.status === \"expired\") {\n        return res.status(400).json({ message: \"This gift has expired\" });\n      }\n\n      if (gift.status === \"cancelled\") {\n        return res.status(400).json({ message: \"This gift has been cancelled\" });\n      }\n\n      if (gift.expiresAt && new Date(gift.expiresAt) < new Date()) {\n        // Update status to expired\n        await storage.claimGiftData(gift.id, userId);\n        return res.status(400).json({ message: \"This gift has expired\" });\n      }\n\n      // Verify the plan still exists\n      const plan = await storage.getVtuPlan(gift.planId);\n      if (!plan) {\n        return res.status(400).json({ message: \"Data plan no longer available\" });\n      }\n\n      // Process the data purchase if SME Data is configured\n      if (isSMEDataConfigured()) {\n        try {\n          const purchaseResult = await purchaseData(gift.network, gift.recipientPhone, plan.dataAmount);\n          \n          if (purchaseResult.success) {\n            // Create VTU transaction record\n            const transaction = await storage.createVtuTransaction({\n              userId: gift.senderId,\n              planId: gift.planId,\n              network: gift.network,\n              phoneNumber: gift.recipientPhone,\n              amount: plan.sellingPrice,\n              costPrice: plan.costPrice,\n              profit: (parseFloat(plan.sellingPrice) - parseFloat(plan.costPrice)).toFixed(2),\n              status: \"success\",\n              smedataReference: purchaseResult.reference,\n            });\n\n            // Update gift as claimed with transaction reference\n            const claimedGift = await storage.claimGiftData(gift.id, userId);\n\n            res.json({\n              success: true,\n              message: `Gift claimed successfully! ${plan.dataAmount} data sent to ${gift.recipientPhone}`,\n              gift: claimedGift,\n            });\n          } else {\n            res.status(400).json({\n              success: false,\n              message: purchaseResult.message || \"Failed to process the gift data. Please try again.\",\n            });\n          }\n        } catch (apiError: any) {\n          console.error(\"Gift data claim API error:\", apiError);\n          res.status(500).json({\n            success: false,\n            message: \"Failed to process gift due to network error. Please try again.\",\n          });\n        }\n      } else {\n        // SME not configured - just mark as claimed\n        const claimedGift = await storage.claimGiftData(gift.id, userId);\n        res.json({\n          success: true,\n          message: \"Gift claimed successfully! Your data will be delivered shortly.\",\n          gift: claimedGift,\n        });\n      }\n    } catch (error) {\n      console.error(\"Error claiming gift:\", error);\n      res.status(500).json({ message: \"Failed to claim gift\" });\n    }\n  });\n\n  // ==================== BILL PAYMENTS API ROUTES ====================\n\n  // Validate customer ID (decoder/meter number)\n  app.post(\"/api/bills/validate\", isAuthenticated, async (req: any, res) => {\n    try {\n      const validationResult = validateCustomerSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({\n          message: \"Invalid input\",\n          errors: validationResult.error.errors,\n        });\n      }\n\n      const { serviceType, customerId } = validationResult.data;\n      const result = await validateBillCustomer(serviceType, customerId);\n\n      if (result.success) {\n        res.json({\n          success: true,\n          customerName: result.data?.customerName,\n          customerId: result.data?.customerId,\n          meterType: result.data?.meterType,\n        });\n      } else {\n        res.status(400).json({\n          success: false,\n          message: result.message || \"Customer validation failed\",\n        });\n      }\n    } catch (error) {\n      console.error(\"Error validating customer:\", error);\n      res.status(500).json({ message: \"Failed to validate customer\" });\n    }\n  });\n\n  // Get available packages for cable TV services\n  app.get(\"/api/bills/packages/:service\", async (req, res) => {\n    try {\n      const { service } = req.params;\n      const serviceInfo = getBillServiceInfo(service);\n\n      if (!serviceInfo || serviceInfo.type !== \"cable\") {\n        return res.status(400).json({ message: \"Invalid cable service type\" });\n      }\n\n      const result = await getCablePackages(service);\n\n      if (result.success) {\n        res.json({\n          success: true,\n          packages: result.packages || [],\n        });\n      } else {\n        res.status(400).json({\n          success: false,\n          message: result.message || \"Failed to get packages\",\n        });\n      }\n    } catch (error) {\n      console.error(\"Error fetching packages:\", error);\n      res.status(500).json({ message: \"Failed to fetch packages\" });\n    }\n  });\n\n  // Process bill payment\n  app.post(\"/api/bills/pay\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const validationResult = payBillSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({\n          message: \"Invalid input\",\n          errors: validationResult.error.errors,\n        });\n      }\n\n      const { serviceType, billType, customerId, amount, packageCode, packageName } = validationResult.data;\n\n      // Get user's wallet\n      const wallet = await storage.getOrCreateWallet(userId);\n      if (!wallet) {\n        return res.status(400).json({ message: \"Wallet not found. Please contact support.\" });\n      }\n\n      // Check if user has sufficient balance\n      const walletBalance = parseFloat(wallet.balance);\n      if (walletBalance < amount) {\n        return res.status(400).json({\n          message: \"Insufficient wallet balance\",\n          required: amount,\n          available: walletBalance,\n        });\n      }\n\n      // Create bill payment record\n      const billPayment = await storage.createBillPayment({\n        userId,\n        serviceType: serviceType as any,\n        billType,\n        customerId,\n        amount: amount.toString(),\n        packageName: packageName || null,\n        status: \"pending\",\n      });\n\n      // Process with SMEDATA API\n      if (isSMEDataConfigured()) {\n        try {\n          // Update status to processing\n          await storage.updateBillPayment(billPayment.id, { status: \"processing\" });\n\n          // Call SMEDATA bill payment API\n          const apiResult = await payBill(serviceType, customerId, amount, packageCode);\n\n          if (apiResult.success) {\n            // Deduct from wallet\n            await storage.updateWalletBalance(userId, amount.toString(), \"subtract\");\n\n            // Create wallet transaction\n            const walletTransaction = await storage.createTransaction({\n              walletId: wallet.id,\n              type: \"purchase\",\n              amount: (-amount).toString(),\n              description: `${billType === \"cable\" ? \"Cable TV\" : \"Electricity\"} bill payment - ${serviceType.toUpperCase()} - ${customerId} (Ref: ${apiResult.reference || 'N/A'})`,\n              status: \"completed\",\n            });\n\n            // Update bill payment as successful\n            await storage.updateBillPayment(billPayment.id, {\n              status: \"success\",\n              reference: apiResult.reference || null,\n              token: apiResult.token || null,\n              apiResponse: apiResult.data,\n              walletTransactionId: walletTransaction.id,\n            });\n\n            res.json({\n              success: true,\n              message: apiResult.token\n                ? `Bill payment successful! Your token: ${apiResult.token}`\n                : \"Bill payment successful!\",\n              reference: apiResult.reference,\n              token: apiResult.token,\n              newBalance: walletBalance - amount,\n            });\n          } else {\n            // Update bill payment as failed\n            await storage.updateBillPayment(billPayment.id, {\n              status: \"failed\",\n              errorMessage: apiResult.message,\n              apiResponse: apiResult,\n            });\n\n            res.status(400).json({\n              success: false,\n              message: apiResult.message || \"Bill payment failed. Please try again.\",\n            });\n          }\n        } catch (apiError: any) {\n          console.error(\"Bill payment API error:\", apiError);\n          await storage.updateBillPayment(billPayment.id, {\n            status: \"failed\",\n            errorMessage: apiError.message || \"API error\",\n          });\n\n          res.status(500).json({\n            success: false,\n            message: \"Bill payment failed due to network error. Please try again.\",\n          });\n        }\n      } else {\n        // SMEDATA not configured - simulate for testing\n        await storage.updateBillPayment(billPayment.id, {\n          status: \"failed\",\n          errorMessage: \"Bill payment service is not configured\",\n        });\n\n        res.status(503).json({\n          success: false,\n          message: \"Bill payment service is currently unavailable. Please try again later.\",\n        });\n      }\n    } catch (error) {\n      console.error(\"Error processing bill payment:\", error);\n      res.status(500).json({ message: \"Failed to process bill payment\" });\n    }\n  });\n\n  // Get user's bill payment history\n  app.get(\"/api/bills/history\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const payments = await storage.getUserBillPayments(userId);\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error fetching bill history:\", error);\n      res.status(500).json({ message: \"Failed to fetch bill history\" });\n    }\n  });\n\n  // ==================== SETTINGS API ROUTES ====================\n\n  // Get user's settings\n  app.get(\"/api/settings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const settings = await storage.getOrCreateUserSettings(userId);\n      res.json(settings);\n    } catch (error) {\n      console.error(\"Error fetching user settings:\", error);\n      res.status(500).json({ message: \"Failed to fetch settings\" });\n    }\n  });\n\n  // Update user's settings\n  app.patch(\"/api/settings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      // Validate request body\n      const validationResult = updateUserSettingsSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Validation failed\",\n          errors: validationResult.error.flatten().fieldErrors\n        });\n      }\n\n      // Convert latitude and longitude from number to string (database stores as decimal string)\n      const settingsData = {\n        ...validationResult.data,\n        latitude: validationResult.data.latitude !== undefined ? String(validationResult.data.latitude) : undefined,\n        longitude: validationResult.data.longitude !== undefined ? String(validationResult.data.longitude) : undefined,\n      };\n\n      const settings = await storage.updateUserSettings(userId, settingsData);\n      res.json(settings);\n    } catch (error) {\n      console.error(\"Error updating user settings:\", error);\n      res.status(500).json({ message: \"Failed to update settings\" });\n    }\n  });\n\n  // Request account deletion\n  app.post(\"/api/settings/delete-account\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      // Validate request body\n      const validationResult = requestAccountDeletionSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Validation failed\",\n          errors: validationResult.error.flatten().fieldErrors\n        });\n      }\n\n      const { usernameConfirmation } = validationResult.data;\n\n      // Get the user to verify the confirmation\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Verify the username/email confirmation\n      const expectedConfirmation = user.email.split(\"@\")[0].toLowerCase();\n      if (usernameConfirmation.toLowerCase() !== expectedConfirmation && \n          usernameConfirmation.toLowerCase() !== user.email.toLowerCase()) {\n        return res.status(400).json({ \n          message: \"Username confirmation does not match\" \n        });\n      }\n\n      const settings = await storage.requestAccountDeletion(userId);\n      res.json({\n        success: true,\n        message: \"Account deletion requested. Your account will be deleted after the grace period.\",\n        settings,\n      });\n    } catch (error) {\n      console.error(\"Error requesting account deletion:\", error);\n      res.status(500).json({ message: \"Failed to request account deletion\" });\n    }\n  });\n\n  // Cancel account deletion\n  app.post(\"/api/settings/cancel-deletion\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const settings = await storage.cancelAccountDeletion(userId);\n      res.json({\n        success: true,\n        message: \"Account deletion cancelled successfully.\",\n        settings,\n      });\n    } catch (error) {\n      console.error(\"Error cancelling account deletion:\", error);\n      res.status(500).json({ message: \"Failed to cancel account deletion\" });\n    }\n  });\n\n  // ==================== ADS API ROUTES ====================\n\n  // Get active sponsored ads\n  app.get(\"/api/ads\", async (req, res) => {\n    try {\n      const { type } = req.query;\n      const ads = await storage.getActiveSponsoredAds(typeof type === \"string\" ? type : undefined);\n      res.json(ads);\n    } catch (error) {\n      console.error(\"Error fetching ads:\", error);\n      res.status(500).json({ message: \"Failed to fetch ads\" });\n    }\n  });\n\n  // Record ad impression\n  app.post(\"/api/ads/:id/impression\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      if (!id) {\n        return res.status(400).json({ message: \"Ad ID is required\" });\n      }\n\n      await storage.recordAdImpression(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error recording ad impression:\", error);\n      res.status(500).json({ message: \"Failed to record impression\" });\n    }\n  });\n\n  // Record ad click\n  app.post(\"/api/ads/:id/click\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      if (!id) {\n        return res.status(400).json({ message: \"Ad ID is required\" });\n      }\n\n      await storage.recordAdClick(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error recording ad click:\", error);\n      res.status(500).json({ message: \"Failed to record click\" });\n    }\n  });\n\n  // ==================== CART API ROUTES ====================\n\n  // Get user's cart items with products\n  app.get(\"/api/cart\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      const cartItems = await storage.getCartItems(userId);\n      res.json(cartItems);\n    } catch (error) {\n      console.error(\"Error fetching cart:\", error);\n      res.status(500).json({ message: \"Failed to fetch cart items\" });\n    }\n  });\n\n  // Add item to cart\n  app.post(\"/api/cart\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { productId, quantity = 1 } = req.body;\n\n      if (!productId) {\n        return res.status(400).json({ message: \"Product ID is required\" });\n      }\n\n      if (typeof quantity !== 'number' || quantity < 1) {\n        return res.status(400).json({ message: \"Quantity must be a positive number\" });\n      }\n\n      // Verify product exists and is available\n      const product = await storage.getProduct(productId);\n      if (!product) {\n        return res.status(404).json({ message: \"Product not found\" });\n      }\n      if (!product.isAvailable) {\n        return res.status(400).json({ message: \"Product is not available\" });\n      }\n\n      const cartItem = await storage.addToCart(userId, productId, quantity);\n      res.json(cartItem);\n    } catch (error) {\n      console.error(\"Error adding to cart:\", error);\n      res.status(500).json({ message: \"Failed to add item to cart\" });\n    }\n  });\n\n  // Update cart item quantity\n  app.patch(\"/api/cart/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { id } = req.params;\n      const { quantity } = req.body;\n\n      if (typeof quantity !== 'number' || quantity < 1) {\n        return res.status(400).json({ message: \"Quantity must be a positive number\" });\n      }\n\n      const cartItem = await storage.updateCartItemQuantity(id, quantity);\n      res.json(cartItem);\n    } catch (error) {\n      console.error(\"Error updating cart item:\", error);\n      if (error instanceof Error && error.message.includes(\"not found\")) {\n        return res.status(404).json({ message: \"Cart item not found\" });\n      }\n      res.status(500).json({ message: \"Failed to update cart item\" });\n    }\n  });\n\n  // Remove item from cart\n  app.delete(\"/api/cart/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { id } = req.params;\n      await storage.removeFromCart(id);\n      res.json({ message: \"Item removed from cart\" });\n    } catch (error) {\n      console.error(\"Error removing from cart:\", error);\n      res.status(500).json({ message: \"Failed to remove item from cart\" });\n    }\n  });\n\n  // Clear entire cart\n  app.delete(\"/api/cart\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      await storage.clearCart(userId);\n      res.json({ message: \"Cart cleared\" });\n    } catch (error) {\n      console.error(\"Error clearing cart:\", error);\n      res.status(500).json({ message: \"Failed to clear cart\" });\n    }\n  });\n\n  // ==================== ORDER API ROUTES ====================\n\n  // Helper function to generate unique order number\n  function generateOrderNumber(): string {\n    const timestamp = Date.now().toString(36).toUpperCase();\n    const random = Math.random().toString(36).substring(2, 6).toUpperCase();\n    return `EKSU-${timestamp}-${random}`;\n  }\n\n  // Define valid status transitions\n  const validStatusTransitions: Record<string, string[]> = {\n    'pending': ['paid', 'cancelled'],\n    'paid': ['seller_confirmed', 'cancelled', 'disputed'],\n    'seller_confirmed': ['preparing', 'cancelled', 'disputed'],\n    'preparing': ['ready_for_pickup', 'cancelled', 'disputed'],\n    'ready_for_pickup': ['shipped', 'out_for_delivery', 'delivered', 'cancelled', 'disputed'],\n    'shipped': ['out_for_delivery', 'delivered', 'cancelled', 'disputed'],\n    'out_for_delivery': ['delivered', 'cancelled', 'disputed'],\n    'delivered': ['buyer_confirmed', 'disputed'],\n    'buyer_confirmed': ['completed'],\n    'completed': [],\n    'cancelled': [],\n    'disputed': ['refunded', 'completed'],\n    'refunded': [],\n  };\n\n  // Define who can make which status transitions\n  const statusTransitionPermissions: Record<string, 'buyer' | 'seller' | 'both' | 'system'> = {\n    'paid': 'system',\n    'seller_confirmed': 'seller',\n    'preparing': 'seller',\n    'ready_for_pickup': 'seller',\n    'shipped': 'seller',\n    'out_for_delivery': 'seller',\n    'delivered': 'seller',\n    'buyer_confirmed': 'buyer',\n    'completed': 'system',\n    'cancelled': 'both',\n    'disputed': 'both',\n    'refunded': 'system',\n  };\n\n  // Create a new order\n  app.post(\"/api/orders\", isAuthenticated, requireEmailVerified, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const validationResult = createOrderSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Validation failed\", \n          errors: validationResult.error.flatten().fieldErrors \n        });\n      }\n\n      const { productId, deliveryMethod, deliveryAddress, deliveryLocation, deliveryNotes, negotiationId } = validationResult.data;\n\n      // Get the product with seller info\n      const product = await storage.getProduct(productId);\n      if (!product) {\n        return res.status(404).json({ message: \"Product not found\" });\n      }\n      if (!product.isAvailable) {\n        return res.status(400).json({ message: \"Product is not available\" });\n      }\n\n      // Buyer cannot be the same as seller\n      if (product.sellerId === userId) {\n        return res.status(400).json({ message: \"You cannot purchase your own product\" });\n      }\n\n      // Calculate pricing - convert decimal to number\n      let itemPriceNum = parseFloat(product.price as string);\n      \n      // Check if there's an accepted negotiation for this product\n      if (negotiationId) {\n        const negotiation = await storage.getNegotiation(negotiationId);\n        if (negotiation && negotiation.status === 'accepted' && negotiation.buyerId === userId) {\n          // Use the counter offer price if available, otherwise the original offer price\n          const negotiatedPrice = negotiation.counterOfferPrice || negotiation.offerPrice;\n          itemPriceNum = parseFloat(negotiatedPrice as string);\n        }\n      }\n\n      const pricing = calculatePricingFromSellerPrice(itemPriceNum);\n      \n      // Generate unique order number\n      const orderNumber = generateOrderNumber();\n\n      // Create the order\n      const order = await storage.createOrder({\n        orderNumber,\n        buyerId: userId,\n        sellerId: product.sellerId,\n        productId,\n        itemPrice: itemPriceNum.toFixed(2),\n        platformFee: pricing.platformCommission.toFixed(2),\n        paymentFee: pricing.paymentFee.toFixed(2),\n        deliveryFee: \"0.00\",\n        totalAmount: pricing.buyerPays.toFixed(2),\n        sellerEarnings: pricing.sellerReceives.toFixed(2),\n        negotiationId: negotiationId || null,\n        status: \"pending\",\n        deliveryMethod: deliveryMethod || \"campus_meetup\",\n        deliveryAddress: deliveryAddress || null,\n        deliveryLocation: deliveryLocation || null,\n        deliveryNotes: deliveryNotes || null,\n      });\n\n      // Add initial status history\n      await storage.addOrderStatusHistory({\n        orderId: order.id,\n        fromStatus: null,\n        toStatus: \"pending\",\n        changedBy: userId,\n        notes: \"Order created\",\n      });\n\n      // Create notification for the seller about new order\n      const buyer = await storage.getUser(userId);\n      if (buyer) {\n        const buyerName = buyer.firstName && buyer.lastName \n          ? `${buyer.firstName} ${buyer.lastName}` \n          : buyer.email;\n        \n        await createAndBroadcastNotification({\n          userId: product.sellerId,\n          type: \"order_placed\",\n          title: \"New Order Received\",\n          message: `${buyerName} placed an order for \"${product.title}\" - Order #${orderNumber}`,\n          link: `/seller-dashboard`,\n          relatedUserId: userId,\n          relatedProductId: productId,\n        });\n      }\n\n      res.status(201).json(order);\n    } catch (error) {\n      console.error(\"Error creating order:\", error);\n      res.status(500).json({ message: \"Failed to create order\" });\n    }\n  });\n\n  // Get buyer's orders\n  app.get(\"/api/orders/buyer\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const orders = await storage.getBuyerOrders(userId);\n      res.json(orders);\n    } catch (error) {\n      console.error(\"Error fetching buyer orders:\", error);\n      res.status(500).json({ message: \"Failed to fetch orders\" });\n    }\n  });\n\n  // Get seller's orders\n  app.get(\"/api/orders/seller\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const orders = await storage.getSellerOrders(userId);\n      res.json(orders);\n    } catch (error) {\n      console.error(\"Error fetching seller orders:\", error);\n      res.status(500).json({ message: \"Failed to fetch orders\" });\n    }\n  });\n\n  // Get order details\n  app.get(\"/api/orders/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { id } = req.params;\n      const order = await storage.getOrder(id);\n\n      if (!order) {\n        return res.status(404).json({ message: \"Order not found\" });\n      }\n\n      // Only buyer or seller can view the order\n      if (order.buyerId !== userId && order.sellerId !== userId) {\n        return res.status(403).json({ message: \"You don't have permission to view this order\" });\n      }\n\n      res.json(order);\n    } catch (error) {\n      console.error(\"Error fetching order:\", error);\n      res.status(500).json({ message: \"Failed to fetch order\" });\n    }\n  });\n\n  // Update order status\n  app.put(\"/api/orders/:id/status\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { id } = req.params;\n      const validationResult = updateOrderStatusSchema.safeParse({ orderId: id, ...req.body });\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Validation failed\", \n          errors: validationResult.error.flatten().fieldErrors \n        });\n      }\n\n      const { status, notes } = validationResult.data;\n\n      const order = await storage.getOrder(id);\n      if (!order) {\n        return res.status(404).json({ message: \"Order not found\" });\n      }\n\n      // Check if user is buyer or seller\n      const isBuyer = order.buyerId === userId;\n      const isSeller = order.sellerId === userId;\n\n      if (!isBuyer && !isSeller) {\n        return res.status(403).json({ message: \"You don't have permission to update this order\" });\n      }\n\n      // Validate status transition\n      const currentStatus = order.status;\n      const allowedTransitions = validStatusTransitions[currentStatus] || [];\n      \n      if (!allowedTransitions.includes(status)) {\n        return res.status(400).json({ \n          message: `Cannot transition from '${currentStatus}' to '${status}'`,\n          allowedTransitions \n        });\n      }\n\n      // Check permission for this status change\n      const requiredRole = statusTransitionPermissions[status];\n      if (requiredRole === 'buyer' && !isBuyer) {\n        return res.status(403).json({ message: \"Only the buyer can set this status\" });\n      }\n      if (requiredRole === 'seller' && !isSeller) {\n        return res.status(403).json({ message: \"Only the seller can set this status\" });\n      }\n      if (requiredRole === 'system') {\n        return res.status(403).json({ message: \"This status can only be set by the system\" });\n      }\n\n      // Update the order status\n      const updatedOrder = await storage.updateOrderStatus(id, status, userId, notes);\n\n      // Send email notification to both buyer and seller\n      try {\n        const buyer = order.buyerId ? await storage.getUser(order.buyerId) : null;\n        const seller = order.sellerId ? await storage.getUser(order.sellerId) : null;\n        const product = order.productId ? await storage.getProduct(order.productId) : null;\n        \n        if (buyer && product && seller) {\n          const statusMessages: Record<string, 'confirmation' | 'shipped' | 'delivered' | 'completed'> = {\n            'awaiting_payment': 'confirmation',\n            'confirmed': 'confirmation',\n            'shipped': 'shipped',\n            'delivered': 'delivered',\n            'completed': 'completed',\n          };\n          \n          const emailType = statusMessages[status] || 'confirmation';\n          const sellerName = seller.firstName && seller.lastName ? `${seller.firstName} ${seller.lastName}` : seller.username || seller.email;\n          const buyerDisplayName = buyer.firstName || undefined;\n          \n          // Send to buyer\n          sendOrderEmail(buyer.email, {\n            orderId: id,\n            productName: product.title,\n            totalAmount: order.totalAmount.toString(),\n            sellerName,\n            buyerName: buyerDisplayName,\n            type: emailType,\n          }).catch(err => console.error(\"Failed to send buyer order email:\", err));\n          \n          // Send to seller\n          const buyerName = buyer.firstName && buyer.lastName ? `${buyer.firstName} ${buyer.lastName}` : buyer.username || buyer.email;\n          sendOrderEmail(seller.email, {\n            orderId: id,\n            productName: product.title,\n            totalAmount: order.totalAmount.toString(),\n            sellerName: buyerName,\n            type: emailType,\n          }).catch(err => console.error(\"Failed to send seller order email:\", err));\n        }\n      } catch (emailErr) {\n        console.error(\"Error sending order emails:\", emailErr);\n        // Don't fail the request, just log the error\n      }\n\n      res.json(updatedOrder);\n    } catch (error) {\n      console.error(\"Error updating order status:\", error);\n      res.status(500).json({ message: \"Failed to update order status\" });\n    }\n  });\n\n  // Get order status history\n  app.get(\"/api/orders/:id/history\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { id } = req.params;\n      const order = await storage.getOrder(id);\n\n      if (!order) {\n        return res.status(404).json({ message: \"Order not found\" });\n      }\n\n      // Only buyer or seller can view the order history\n      if (order.buyerId !== userId && order.sellerId !== userId) {\n        return res.status(403).json({ message: \"You don't have permission to view this order history\" });\n      }\n\n      const history = await storage.getOrderStatusHistory(id);\n      res.json(history);\n    } catch (error) {\n      console.error(\"Error fetching order history:\", error);\n      res.status(500).json({ message: \"Failed to fetch order history\" });\n    }\n  });\n\n  // ==================== GAMES API ROUTES ====================\n\n  // Get available game lobbies\n  app.get(\"/api/games\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { gameType } = req.query;\n      const games = await storage.getAvailableGames(gameType as string | undefined);\n      res.json(games);\n    } catch (error) {\n      console.error(\"Error fetching games:\", error);\n      res.status(500).json({ message: \"Failed to fetch games\" });\n    }\n  });\n\n  // Get user's game history\n  app.get(\"/api/games/history\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const games = await storage.getUserGames(userId);\n      res.json(games);\n    } catch (error) {\n      console.error(\"Error fetching game history:\", error);\n      res.status(500).json({ message: \"Failed to fetch game history\" });\n    }\n  });\n\n  // ==================== WORD BATTLE AI ENDPOINTS (PUBLIC) ====================\n\n  // Validate a word using Groq AI\n  app.post(\"/api/games/validate-word\", async (req: any, res) => {\n    try {\n      const { word } = req.body;\n      \n      if (!word || typeof word !== \"string\" || word.length < 2) {\n        return res.status(400).json({ \n          valid: false, \n          message: \"Word must be at least 2 characters\",\n          feedback: \"Too short! Words need at least 2 letters.\"\n        });\n      }\n\n      const cleanWord = word.trim().toLowerCase();\n      \n      // Check for non-alphabetic characters\n      if (!/^[a-z]+$/.test(cleanWord)) {\n        return res.status(400).json({ \n          valid: false, \n          message: \"Word must contain only letters\",\n          feedback: \"Letters only please! No numbers or symbols.\"\n        });\n      }\n\n      const apiKey = process.env.GROQ_API_KEY;\n      \n      if (!apiKey) {\n        // Fallback to basic validation without AI\n        return res.json({ \n          valid: true, \n          usedFallback: true,\n          feedback: \"Word accepted (offline mode)\",\n          funFact: null\n        });\n      }\n\n      const groq = new Groq({ apiKey });\n      \n      const prompt = `You are a word validation assistant for a word game. Determine if \"${cleanWord}\" is a valid English word.\n\nIMPORTANT RULES:\n1. The word must be a real English word found in a standard dictionary\n2. Proper nouns (names of people, places, brands) are NOT valid\n3. Abbreviations and acronyms are NOT valid\n4. Slang that isn't in standard dictionaries is NOT valid\n5. The word must be commonly recognized\n\nRespond in this exact JSON format:\n{\n  \"isValid\": true or false,\n  \"feedback\": \"A fun, encouraging message about the word (1 sentence max)\",\n  \"funFact\": \"An interesting fact about the word if valid, or null if invalid\"\n}\n\nExamples:\n- \"cat\" -> {\"isValid\": true, \"feedback\": \"Nice! A classic word choice.\", \"funFact\": \"Cats have been domesticated for about 10,000 years!\"}\n- \"xyz\" -> {\"isValid\": false, \"feedback\": \"That's not a real word - try again!\", \"funFact\": null}\n- \"london\" -> {\"isValid\": false, \"feedback\": \"That's a proper noun (place name) - regular words only!\", \"funFact\": null}`;\n\n      const completion = await groq.chat.completions.create({\n        messages: [\n          { role: \"system\", content: \"You are a helpful word game assistant. Always respond with valid JSON only.\" },\n          { role: \"user\", content: prompt }\n        ],\n        model: \"llama-3.3-70b-versatile\",\n        temperature: 0.3,\n        max_tokens: 200,\n      });\n\n      const responseText = completion.choices[0]?.message?.content || \"\";\n      \n      try {\n        // Extract JSON from response (handle potential markdown wrapping)\n        const jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\n        if (!jsonMatch) {\n          throw new Error(\"No JSON found in response\");\n        }\n        \n        const result = JSON.parse(jsonMatch[0]);\n        \n        res.json({\n          valid: result.isValid === true,\n          feedback: result.feedback || (result.isValid ? \"Valid word!\" : \"Not a valid word.\"),\n          funFact: result.funFact || null,\n          word: cleanWord\n        });\n      } catch (parseError) {\n        console.error(\"Failed to parse word validation response:\", parseError);\n        // Fallback - assume valid if we can't parse\n        res.json({ \n          valid: true, \n          usedFallback: true,\n          feedback: \"Word accepted!\",\n          funFact: null,\n          word: cleanWord\n        });\n      }\n    } catch (error: any) {\n      console.error(\"Error validating word with Groq:\", error);\n      \n      if (error.status === 401) {\n        return res.json({ \n          valid: true, \n          usedFallback: true,\n          feedback: \"Word accepted (API unavailable)\",\n          funFact: null\n        });\n      }\n      \n      if (error.status === 429) {\n        return res.json({ \n          valid: true, \n          usedFallback: true,\n          feedback: \"Word accepted (rate limited)\",\n          funFact: null\n        });\n      }\n\n      // Default fallback - accept the word\n      res.json({ \n        valid: true, \n        usedFallback: true,\n        feedback: \"Word accepted!\",\n        funFact: null\n      });\n    }\n  });\n\n  // Generate a good set of letters for Word Battle using Groq AI\n  app.get(\"/api/games/generate-letters\", async (req: any, res) => {\n    try {\n      const apiKey = process.env.GROQ_API_KEY;\n      \n      // Fallback letter generation (same as client-side)\n      const generateFallbackLetters = () => {\n        const VOWELS = \"AEIOU\";\n        const CONSONANTS = \"BCDFGHJKLMNPQRSTVWXYZ\";\n        const letters: string[] = [];\n        \n        const vowelCount = 2 + Math.floor(Math.random() * 2);\n        for (let i = 0; i < vowelCount; i++) {\n          letters.push(VOWELS[Math.floor(Math.random() * VOWELS.length)]);\n        }\n        \n        while (letters.length < 7) {\n          letters.push(CONSONANTS[Math.floor(Math.random() * CONSONANTS.length)]);\n        }\n        \n        // Shuffle\n        for (let i = letters.length - 1; i > 0; i--) {\n          const j = Math.floor(Math.random() * (i + 1));\n          [letters[i], letters[j]] = [letters[j], letters[i]];\n        }\n        \n        return letters;\n      };\n      \n      if (!apiKey) {\n        return res.json({ \n          letters: generateFallbackLetters(),\n          hint: null,\n          usedFallback: true\n        });\n      }\n\n      const groq = new Groq({ apiKey });\n      \n      const prompt = `Generate a set of 7 letters for a word game that allows players to form multiple English words.\n\nREQUIREMENTS:\n1. Include exactly 7 letters (can have duplicates)\n2. Include 2-3 vowels (A, E, I, O, U) and 4-5 consonants\n3. The letters should allow forming at least 5 different valid English words\n4. Avoid rare letters like Q, X, Z unless paired with helpful letters\n5. Make it challenging but fair - not too easy, not impossible\n\nRespond in this exact JSON format:\n{\n  \"letters\": [\"A\", \"R\", \"T\", \"S\", \"E\", \"N\", \"O\"],\n  \"possibleWords\": [\"star\", \"rate\", \"arts\", \"rest\", \"torn\"],\n  \"hint\": \"A fun hint about one possible word (optional, 1 sentence)\"\n}`;\n\n      const completion = await groq.chat.completions.create({\n        messages: [\n          { role: \"system\", content: \"You are a word game designer. Generate letter sets that are fun and challenging. Always respond with valid JSON only.\" },\n          { role: \"user\", content: prompt }\n        ],\n        model: \"llama-3.3-70b-versatile\",\n        temperature: 0.8,\n        max_tokens: 200,\n      });\n\n      const responseText = completion.choices[0]?.message?.content || \"\";\n      \n      try {\n        // Extract JSON from response\n        const jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\n        if (!jsonMatch) {\n          throw new Error(\"No JSON found in response\");\n        }\n        \n        const result = JSON.parse(jsonMatch[0]);\n        \n        // Validate the letters array\n        if (!Array.isArray(result.letters) || result.letters.length !== 7) {\n          throw new Error(\"Invalid letters array\");\n        }\n        \n        const letters = result.letters.map((l: string) => String(l).toUpperCase().charAt(0));\n        \n        // Verify all are valid letters\n        const validLetters = letters.every((l: string) => /^[A-Z]$/.test(l));\n        if (!validLetters) {\n          throw new Error(\"Invalid letter characters\");\n        }\n        \n        res.json({\n          letters,\n          hint: result.hint || null,\n          possibleWordCount: result.possibleWords?.length || 5,\n          usedFallback: false\n        });\n      } catch (parseError) {\n        console.error(\"Failed to parse letter generation response:\", parseError);\n        res.json({ \n          letters: generateFallbackLetters(),\n          hint: null,\n          usedFallback: true\n        });\n      }\n    } catch (error: any) {\n      console.error(\"Error generating letters with Groq:\", error);\n      \n      // Fallback to random generation\n      const VOWELS = \"AEIOU\";\n      const CONSONANTS = \"BCDFGHJKLMNPQRSTVWXYZ\";\n      const letters: string[] = [];\n      \n      const vowelCount = 2 + Math.floor(Math.random() * 2);\n      for (let i = 0; i < vowelCount; i++) {\n        letters.push(VOWELS[Math.floor(Math.random() * VOWELS.length)]);\n      }\n      \n      while (letters.length < 7) {\n        letters.push(CONSONANTS[Math.floor(Math.random() * CONSONANTS.length)]);\n      }\n      \n      // Shuffle\n      for (let i = letters.length - 1; i > 0; i--) {\n        const j = Math.floor(Math.random() * (i + 1));\n        [letters[i], letters[j]] = [letters[j], letters[i]];\n      }\n      \n      res.json({ \n        letters,\n        hint: null,\n        usedFallback: true\n      });\n    }\n  });\n\n  // Get single game with players\n  app.get(\"/api/games/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const game = await storage.getGame(req.params.id);\n      if (!game) {\n        return res.status(404).json({ message: \"Game not found\" });\n      }\n      res.json(game);\n    } catch (error) {\n      console.error(\"Error fetching game:\", error);\n      res.status(500).json({ message: \"Failed to fetch game\" });\n    }\n  });\n\n  // Create a new game lobby\n  app.post(\"/api/games/create\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const validated = createGameSchema.parse(req.body);\n      const stakeAmount = parseFloat(validated.stakeAmount);\n\n      // Verify sufficient balance\n      const wallet = await storage.getOrCreateWallet(userId);\n      if (parseFloat(wallet.balance) < stakeAmount) {\n        return res.status(400).json({ \n          message: `Insufficient balance. You need ${stakeAmount} but have ${wallet.balance}` \n        });\n      }\n\n      // Deduct stake from wallet\n      await storage.updateWalletBalance(userId, validated.stakeAmount, 'subtract');\n\n      // Create transaction for stake\n      await storage.createTransaction({\n        walletId: wallet.id,\n        type: 'escrow_hold',\n        amount: validated.stakeAmount,\n        description: `Game stake for ${validated.gameType.replace('_', ' ')}`,\n        status: 'completed',\n      });\n\n      // Create game\n      const game = await storage.createGame({\n        gameType: validated.gameType,\n        player1Id: userId,\n        stakeAmount: validated.stakeAmount,\n      });\n\n      res.json(game);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid input\", errors: error.errors });\n      }\n      console.error(\"Error creating game:\", error);\n      res.status(500).json({ message: \"Failed to create game\" });\n    }\n  });\n\n  // Join an existing game\n  app.post(\"/api/games/join/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const gameId = req.params.id;\n\n      // Get the game first to check stake amount\n      const existingGame = await storage.getGame(gameId);\n      if (!existingGame) {\n        return res.status(404).json({ message: \"Game not found\" });\n      }\n\n      if (existingGame.status !== \"waiting\") {\n        return res.status(400).json({ message: \"Game is no longer available\" });\n      }\n\n      if (existingGame.player1Id === userId) {\n        return res.status(400).json({ message: \"Cannot join your own game\" });\n      }\n\n      const stakeAmount = parseFloat(existingGame.stakeAmount);\n\n      // Verify sufficient balance\n      const wallet = await storage.getOrCreateWallet(userId);\n      if (parseFloat(wallet.balance) < stakeAmount) {\n        return res.status(400).json({ \n          message: `Insufficient balance. You need ${stakeAmount} but have ${wallet.balance}` \n        });\n      }\n\n      // Deduct stake from wallet\n      await storage.updateWalletBalance(userId, existingGame.stakeAmount, 'subtract');\n\n      // Create transaction for stake\n      await storage.createTransaction({\n        walletId: wallet.id,\n        type: 'escrow_hold',\n        amount: existingGame.stakeAmount,\n        description: `Game stake for ${existingGame.gameType.replace('_', ' ')}`,\n        status: 'completed',\n      });\n\n      // Join the game\n      const game = await storage.joinGame(gameId, userId);\n\n      res.json(game);\n    } catch (error) {\n      console.error(\"Error joining game:\", error);\n      res.status(500).json({ message: error instanceof Error ? error.message : \"Failed to join game\" });\n    }\n  });\n\n  // Complete a game and pay winner\n  app.post(\"/api/games/:id/complete\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const gameId = req.params.id;\n      const validated = completeGameSchema.parse(req.body);\n\n      // Get the game\n      const game = await storage.getGame(gameId);\n      if (!game) {\n        return res.status(404).json({ message: \"Game not found\" });\n      }\n\n      // Verify user is a player in this game\n      if (game.player1Id !== userId && game.player2Id !== userId) {\n        return res.status(403).json({ message: \"You are not a player in this game\" });\n      }\n\n      if (game.status !== \"in_progress\") {\n        return res.status(400).json({ message: \"Game is not in progress\" });\n      }\n\n      // Verify winner is a valid player\n      if (validated.winnerId !== game.player1Id && validated.winnerId !== game.player2Id) {\n        return res.status(400).json({ message: \"Invalid winner\" });\n      }\n\n      // Calculate prize (total stakes - platform fee)\n      const totalStake = parseFloat(game.stakeAmount) * 2;\n      const platformFee = totalStake * 0.05; // 5% platform fee\n      const winnerPrize = totalStake - platformFee;\n\n      // Complete the game\n      const completedGame = await storage.completeGame(gameId, validated.winnerId);\n\n      // Pay winner\n      const winnerWallet = await storage.getOrCreateWallet(validated.winnerId);\n      await storage.updateWalletBalance(validated.winnerId, winnerPrize.toFixed(2), 'add');\n\n      // Create transaction for winnings\n      await storage.createTransaction({\n        walletId: winnerWallet.id,\n        type: 'escrow_release',\n        amount: winnerPrize.toFixed(2),\n        description: `${game.gameType.replace('_', ' ')} game winnings`,\n        status: 'completed',\n      });\n\n      res.json({\n        game: completedGame,\n        winnings: winnerPrize,\n        platformFee,\n      });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid input\", errors: error.errors });\n      }\n      console.error(\"Error completing game:\", error);\n      res.status(500).json({ message: \"Failed to complete game\" });\n    }\n  });\n\n  // Cancel a game (only creator can cancel before anyone joins)\n  app.post(\"/api/games/:id/cancel\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const gameId = req.params.id;\n\n      // Get the game\n      const game = await storage.getGame(gameId);\n      if (!game) {\n        return res.status(404).json({ message: \"Game not found\" });\n      }\n\n      // Only creator can cancel\n      if (game.player1Id !== userId) {\n        return res.status(403).json({ message: \"Only the game creator can cancel\" });\n      }\n\n      // Can only cancel waiting games\n      if (game.status !== \"waiting\") {\n        return res.status(400).json({ message: \"Cannot cancel a game that has already started\" });\n      }\n\n      // Refund the stake\n      const wallet = await storage.getOrCreateWallet(userId);\n      await storage.updateWalletBalance(userId, game.stakeAmount, 'add');\n\n      // Create refund transaction\n      await storage.createTransaction({\n        walletId: wallet.id,\n        type: 'refund',\n        amount: game.stakeAmount,\n        description: `Refund for cancelled ${game.gameType.replace('_', ' ')} game`,\n        status: 'completed',\n      });\n\n      // Cancel the game\n      const cancelledGame = await storage.cancelGame(gameId);\n\n      res.json(cancelledGame);\n    } catch (error) {\n      console.error(\"Error cancelling game:\", error);\n      res.status(500).json({ message: \"Failed to cancel game\" });\n    }\n  });\n\n  // Get leaderboard for a specific game type\n  app.get(\"/api/games/leaderboard/:gameType\", async (req: any, res) => {\n    try {\n      const { gameType } = req.params;\n      const limit = parseInt(req.query.limit as string) || 10;\n      const leaderboard = await storage.getLeaderboard(gameType, limit);\n      res.json(leaderboard);\n    } catch (error) {\n      console.error(\"Error fetching leaderboard:\", error);\n      res.status(500).json({ message: \"Failed to fetch leaderboard\" });\n    }\n  });\n\n  // Get global leaderboard (all games combined)\n  app.get(\"/api/games/leaderboard\", async (req: any, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 10;\n      const leaderboard = await storage.getGlobalLeaderboard(limit);\n      res.json(leaderboard);\n    } catch (error) {\n      console.error(\"Error fetching global leaderboard:\", error);\n      res.status(500).json({ message: \"Failed to fetch leaderboard\" });\n    }\n  });\n\n  // Get random trivia question\n  app.get(\"/api/games/trivia/question\", isAuthenticated, async (req: any, res) => {\n    try {\n      const question = await storage.getRandomTriviaQuestion();\n      if (!question) {\n        return res.status(404).json({ message: \"No trivia questions available\" });\n      }\n      res.json(question);\n    } catch (error) {\n      console.error(\"Error fetching trivia question:\", error);\n      res.status(500).json({ message: \"Failed to fetch trivia question\" });\n    }\n  });\n\n  // Generate trivia questions using Groq AI\n  app.post(\"/api/games/trivia/questions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const apiKey = process.env.GROQ_API_KEY;\n      \n      if (!apiKey) {\n        console.warn(\"GROQ_API_KEY not configured, returning error\");\n        return res.status(503).json({ \n          message: \"AI question generation not available. Please configure GROQ_API_KEY.\",\n          useFallback: true\n        });\n      }\n\n      const groq = new Groq({ apiKey });\n\n      const categories = [\"General Knowledge\", \"Nigerian Culture\", \"Campus Life\", \"Sports\", \"Entertainment\"];\n      const difficulties = [\"easy\", \"medium\", \"hard\"];\n\n      const prompt = `Generate exactly 10 trivia questions for Nigerian university students. \n      \nRequirements:\n- Questions should be relevant to Nigerian culture, campus life, current affairs, sports, and entertainment\n- Mix of difficulty levels: 4 easy, 4 medium, 2 hard questions\n- Categories to use: ${categories.join(\", \")}\n- Each question must have exactly 4 answer options\n- Questions should be educational, fun, and appropriate for university students\n- Include questions about Nigerian music artists, Nollywood, Nigerian football, campus slang, Nigerian history, food, festivals, and pop culture\n\nReturn ONLY a valid JSON array with this exact structure (no markdown, no explanation):\n[\n  {\n    \"id\": 1,\n    \"category\": \"General Knowledge\",\n    \"question\": \"What is the capital of Nigeria?\",\n    \"options\": [\"Lagos\", \"Abuja\", \"Kano\", \"Ibadan\"],\n    \"correctAnswer\": 1,\n    \"difficulty\": \"easy\"\n  }\n]\n\nThe correctAnswer is the 0-based index of the correct option in the options array.\nGenerate exactly 10 unique questions with varied topics across all categories.`;\n\n      const completion = await groq.chat.completions.create({\n        messages: [\n          {\n            role: \"system\",\n            content: \"You are a trivia question generator specializing in Nigerian culture and university life. You always respond with valid JSON arrays only, no markdown formatting or explanations.\"\n          },\n          {\n            role: \"user\",\n            content: prompt\n          }\n        ],\n        model: \"llama-3.3-70b-versatile\",\n        temperature: 0.8,\n        max_tokens: 3000,\n      });\n\n      const responseContent = completion.choices[0]?.message?.content;\n      \n      if (!responseContent) {\n        console.error(\"Empty response from Groq API\");\n        return res.status(500).json({ \n          message: \"Failed to generate questions - empty response\",\n          useFallback: true\n        });\n      }\n\n      // Parse and validate the response\n      let questions;\n      try {\n        // Clean the response - remove any markdown formatting\n        let cleanedResponse = responseContent.trim();\n        if (cleanedResponse.startsWith(\"```json\")) {\n          cleanedResponse = cleanedResponse.slice(7);\n        }\n        if (cleanedResponse.startsWith(\"```\")) {\n          cleanedResponse = cleanedResponse.slice(3);\n        }\n        if (cleanedResponse.endsWith(\"```\")) {\n          cleanedResponse = cleanedResponse.slice(0, -3);\n        }\n        cleanedResponse = cleanedResponse.trim();\n\n        questions = JSON.parse(cleanedResponse);\n      } catch (parseError) {\n        console.error(\"Failed to parse Groq response:\", parseError);\n        console.error(\"Raw response:\", responseContent);\n        return res.status(500).json({ \n          message: \"Failed to parse AI response\",\n          useFallback: true\n        });\n      }\n\n      // Validate the questions structure\n      if (!Array.isArray(questions) || questions.length === 0) {\n        console.error(\"Invalid questions array from Groq\");\n        return res.status(500).json({ \n          message: \"Invalid questions format from AI\",\n          useFallback: true\n        });\n      }\n\n      // Validate and sanitize each question\n      const validatedQuestions = questions.map((q: any, index: number) => ({\n        id: index + 1,\n        category: categories.includes(q.category) ? q.category : \"General Knowledge\",\n        question: String(q.question || \"\"),\n        options: Array.isArray(q.options) && q.options.length === 4 \n          ? q.options.map((opt: any) => String(opt))\n          : [\"Option A\", \"Option B\", \"Option C\", \"Option D\"],\n        correctAnswer: typeof q.correctAnswer === \"number\" && q.correctAnswer >= 0 && q.correctAnswer <= 3 \n          ? q.correctAnswer \n          : 0,\n        difficulty: difficulties.includes(q.difficulty) ? q.difficulty : \"medium\"\n      }));\n\n      // Ensure we have exactly 10 questions\n      const finalQuestions = validatedQuestions.slice(0, 10);\n      \n      if (finalQuestions.length < 10) {\n        console.warn(`Only got ${finalQuestions.length} valid questions from AI`);\n      }\n\n      console.log(`Generated ${finalQuestions.length} trivia questions using Groq AI`);\n      res.json({ questions: finalQuestions, isAIGenerated: true });\n    } catch (error: any) {\n      console.error(\"Error generating trivia questions with Groq:\", error);\n      \n      // Check for specific API errors\n      if (error.status === 401) {\n        return res.status(503).json({ \n          message: \"Invalid Groq API key\",\n          useFallback: true\n        });\n      }\n      \n      if (error.status === 429) {\n        return res.status(503).json({ \n          message: \"Rate limit exceeded. Please try again later.\",\n          useFallback: true\n        });\n      }\n\n      res.status(500).json({ \n        message: \"Failed to generate questions\",\n        useFallback: true\n      });\n    }\n  });\n\n  // Generate trivia questions with category filtering using Groq AI\n  app.post(\"/api/games/generate-trivia-questions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const apiKey = process.env.GROQ_API_KEY;\n      const { category, difficulty, count = 10 } = req.body;\n      \n      if (!apiKey || apiKey === \"not-set\") {\n        console.warn(\"GROQ_API_KEY not configured, returning fallback signal\");\n        return res.status(503).json({ \n          message: \"AI question generation not available. Please configure GROQ_API_KEY.\",\n          useFallback: true,\n          isAIGenerated: false\n        });\n      }\n\n      const groq = new Groq({ apiKey });\n\n      const allCategories = [\"General Knowledge\", \"Nigerian Culture\", \"Campus Life\", \"Sports\", \"Entertainment\"];\n      const validCategory = category && allCategories.includes(category) ? category : null;\n      const difficulties = [\"easy\", \"medium\", \"hard\"];\n      const validDifficulty = difficulty && difficulties.includes(difficulty) ? difficulty : null;\n      const questionCount = Math.min(Math.max(parseInt(count) || 10, 5), 20);\n\n      let categoryInstruction = \"\";\n      if (validCategory) {\n        categoryInstruction = `Focus ONLY on the category: ${validCategory}. All questions must be from this category.`;\n      } else {\n        categoryInstruction = `Mix questions from these categories: ${allCategories.join(\", \")}.`;\n      }\n\n      let difficultyInstruction = \"\";\n      if (validDifficulty) {\n        difficultyInstruction = `All questions should be ${validDifficulty} difficulty.`;\n      } else {\n        difficultyInstruction = `Mix of difficulty levels: roughly 40% easy, 40% medium, 20% hard questions.`;\n      }\n\n      const prompt = `Generate exactly ${questionCount} unique trivia questions for Nigerian university students.\n      \nRequirements:\n${categoryInstruction}\n${difficultyInstruction}\n- Questions should be relevant to Nigerian culture, campus life, current affairs, sports, and entertainment\n- Each question must have exactly 4 answer options\n- Questions should be educational, fun, and appropriate for university students\n- Include variety: Nigerian music artists, Nollywood, Nigerian football, campus slang, Nigerian history, food, festivals, pop culture, tech, social media trends\n- Make questions engaging and current - include recent events and trending topics from 2023-2024\n- Avoid repeating similar questions - each should test different knowledge\n\nReturn ONLY a valid JSON array with this exact structure (no markdown, no explanation):\n[\n  {\n    \"id\": 1,\n    \"category\": \"${validCategory || 'General Knowledge'}\",\n    \"question\": \"What is the capital of Nigeria?\",\n    \"options\": [\"Lagos\", \"Abuja\", \"Kano\", \"Ibadan\"],\n    \"correctAnswer\": 1,\n    \"difficulty\": \"easy\"\n  }\n]\n\nThe correctAnswer is the 0-based index of the correct option in the options array.\nGenerate exactly ${questionCount} unique questions with varied topics.`;\n\n      const completion = await groq.chat.completions.create({\n        messages: [\n          {\n            role: \"system\",\n            content: \"You are a trivia question generator specializing in Nigerian culture, university life, and current events. You create engaging, accurate, and educational questions. You always respond with valid JSON arrays only, no markdown formatting or explanations. Your questions are fresh, relevant, and test real knowledge.\"\n          },\n          {\n            role: \"user\",\n            content: prompt\n          }\n        ],\n        model: \"llama-3.3-70b-versatile\",\n        temperature: 0.85,\n        max_tokens: 4000,\n      });\n\n      const responseContent = completion.choices[0]?.message?.content;\n      \n      if (!responseContent) {\n        console.error(\"Empty response from Groq API\");\n        return res.status(500).json({ \n          message: \"Failed to generate questions - empty response\",\n          useFallback: true,\n          isAIGenerated: false\n        });\n      }\n\n      // Parse and validate the response\n      let questions;\n      try {\n        // Clean the response - remove any markdown formatting\n        let cleanedResponse = responseContent.trim();\n        if (cleanedResponse.startsWith(\"```json\")) {\n          cleanedResponse = cleanedResponse.slice(7);\n        }\n        if (cleanedResponse.startsWith(\"```\")) {\n          cleanedResponse = cleanedResponse.slice(3);\n        }\n        if (cleanedResponse.endsWith(\"```\")) {\n          cleanedResponse = cleanedResponse.slice(0, -3);\n        }\n        cleanedResponse = cleanedResponse.trim();\n\n        questions = JSON.parse(cleanedResponse);\n      } catch (parseError) {\n        console.error(\"Failed to parse Groq response:\", parseError);\n        console.error(\"Raw response:\", responseContent);\n        return res.status(500).json({ \n          message: \"Failed to parse AI response\",\n          useFallback: true,\n          isAIGenerated: false\n        });\n      }\n\n      // Validate the questions structure\n      if (!Array.isArray(questions) || questions.length === 0) {\n        console.error(\"Invalid questions array from Groq\");\n        return res.status(500).json({ \n          message: \"Invalid questions format from AI\",\n          useFallback: true,\n          isAIGenerated: false\n        });\n      }\n\n      // Validate and sanitize each question\n      const validatedQuestions = questions.map((q: any, index: number) => ({\n        id: index + 1,\n        category: allCategories.includes(q.category) ? q.category : (validCategory || \"General Knowledge\"),\n        question: String(q.question || \"\"),\n        options: Array.isArray(q.options) && q.options.length === 4 \n          ? q.options.map((opt: any) => String(opt))\n          : [\"Option A\", \"Option B\", \"Option C\", \"Option D\"],\n        correctAnswer: typeof q.correctAnswer === \"number\" && q.correctAnswer >= 0 && q.correctAnswer <= 3 \n          ? q.correctAnswer \n          : 0,\n        difficulty: difficulties.includes(q.difficulty) ? q.difficulty : \"medium\"\n      }));\n\n      // Filter out any questions with empty question text\n      const finalQuestions = validatedQuestions.filter((q: any) => q.question && q.question.length > 0).slice(0, questionCount);\n      \n      if (finalQuestions.length < questionCount) {\n        console.warn(`Only got ${finalQuestions.length} valid questions from AI (requested ${questionCount})`);\n      }\n\n      console.log(`Generated ${finalQuestions.length} trivia questions using Groq AI${validCategory ? ` for category: ${validCategory}` : \"\"}`);\n      res.json({ \n        questions: finalQuestions, \n        isAIGenerated: true,\n        category: validCategory,\n        difficulty: validDifficulty,\n        count: finalQuestions.length\n      });\n    } catch (error: any) {\n      console.error(\"Error generating trivia questions with Groq:\", error);\n      \n      // Check for specific API errors\n      if (error.status === 401) {\n        return res.status(503).json({ \n          message: \"Invalid Groq API key\",\n          useFallback: true,\n          isAIGenerated: false\n        });\n      }\n      \n      if (error.status === 429) {\n        return res.status(503).json({ \n          message: \"Rate limit exceeded. Please try again later.\",\n          useFallback: true,\n          isAIGenerated: false\n        });\n      }\n\n      res.status(500).json({ \n        message: \"Failed to generate questions\",\n        useFallback: true,\n        isAIGenerated: false\n      });\n    }\n  });\n\n  // Get random typing text\n  app.get(\"/api/games/typing/text\", isAuthenticated, async (req: any, res) => {\n    try {\n      const text = await storage.getRandomTypingText();\n      if (!text) {\n        return res.status(404).json({ message: \"No typing texts available\" });\n      }\n      res.json(text);\n    } catch (error) {\n      console.error(\"Error fetching typing text:\", error);\n      res.status(500).json({ message: \"Failed to fetch typing text\" });\n    }\n  });\n\n  // Get random price guess product\n  app.get(\"/api/games/price-guess/product\", isAuthenticated, async (req: any, res) => {\n    try {\n      const product = await storage.getRandomPriceGuessProduct();\n      if (!product) {\n        return res.status(404).json({ message: \"No products available\" });\n      }\n      res.json(product);\n    } catch (error) {\n      console.error(\"Error fetching price guess product:\", error);\n      res.status(500).json({ message: \"Failed to fetch product\" });\n    }\n  });\n\n  // Update game score (single player game completion)\n  app.post(\"/api/games/score\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { gameType, won, score, earnings } = req.body;\n      const updated = await storage.updateGameScore(userId, gameType, won, score, earnings);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating game score:\", error);\n      res.status(500).json({ message: \"Failed to update score\" });\n    }\n  });\n\n  // Seed game content\n  app.post(\"/api/games/seed\", async (req: any, res) => {\n    try {\n      await storage.seedGameContent();\n      res.json({ message: \"Game content seeded successfully\" });\n    } catch (error) {\n      console.error(\"Error seeding game content:\", error);\n      res.status(500).json({ message: \"Failed to seed game content\" });\n    }\n  });\n\n  // ==================== USER RELATIONSHIPS (Block/Mute/Report) ====================\n\n  // Block a user\n  app.post(\"/api/users/:id/block\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const targetId = req.params.id;\n      if (targetId === userId) {\n        return res.status(400).json({ message: \"You cannot block yourself\" });\n      }\n\n      const targetUser = await storage.getUser(targetId);\n      if (!targetUser) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const block = await storage.blockUser(userId, targetId);\n      res.json({ success: true, block });\n    } catch (error) {\n      console.error(\"Error blocking user:\", error);\n      res.status(500).json({ message: \"Failed to block user\" });\n    }\n  });\n\n  // Unblock a user\n  app.delete(\"/api/users/:id/block\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const targetId = req.params.id;\n      await storage.unblockUser(userId, targetId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error unblocking user:\", error);\n      res.status(500).json({ message: \"Failed to unblock user\" });\n    }\n  });\n\n  // Mute a user\n  app.post(\"/api/users/:id/mute\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const targetId = req.params.id;\n      if (targetId === userId) {\n        return res.status(400).json({ message: \"You cannot mute yourself\" });\n      }\n\n      const targetUser = await storage.getUser(targetId);\n      if (!targetUser) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const mute = await storage.muteUser(userId, targetId);\n      res.json({ success: true, mute });\n    } catch (error) {\n      console.error(\"Error muting user:\", error);\n      res.status(500).json({ message: \"Failed to mute user\" });\n    }\n  });\n\n  // Unmute a user\n  app.delete(\"/api/users/:id/mute\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const targetId = req.params.id;\n      await storage.unmuteUser(userId, targetId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error unmuting user:\", error);\n      res.status(500).json({ message: \"Failed to unmute user\" });\n    }\n  });\n\n  // Report a user\n  app.post(\"/api/users/:id/report\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const targetId = req.params.id;\n      if (targetId === userId) {\n        return res.status(400).json({ message: \"You cannot report yourself\" });\n      }\n\n      const targetUser = await storage.getUser(targetId);\n      if (!targetUser) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const { reason, description } = req.body;\n      if (!reason) {\n        return res.status(400).json({ message: \"Reason is required\" });\n      }\n\n      const validReasons = [\"spam\", \"harassment\", \"scam\", \"inappropriate\", \"other\"];\n      if (!validReasons.includes(reason)) {\n        return res.status(400).json({ message: \"Invalid reason\" });\n      }\n\n      const report = await storage.createUserReport({\n        reporterId: userId,\n        reportedId: targetId,\n        reason,\n        description: description || null,\n      });\n\n      res.json({ success: true, report });\n    } catch (error) {\n      console.error(\"Error reporting user:\", error);\n      res.status(500).json({ message: \"Failed to report user\" });\n    }\n  });\n\n  // Get list of blocked users\n  app.get(\"/api/users/blocked\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const blockedUsers = await storage.getBlockedUsers(userId);\n      res.json(blockedUsers);\n    } catch (error) {\n      console.error(\"Error fetching blocked users:\", error);\n      res.status(500).json({ message: \"Failed to fetch blocked users\" });\n    }\n  });\n\n  // Get list of muted users\n  app.get(\"/api/users/muted\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const mutedUsers = await storage.getMutedUsers(userId);\n      res.json(mutedUsers);\n    } catch (error) {\n      console.error(\"Error fetching muted users:\", error);\n      res.status(500).json({ message: \"Failed to fetch muted users\" });\n    }\n  });\n\n  // Get relationship status with a user\n  app.get(\"/api/users/:id/relationship\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const targetId = req.params.id;\n      const relationship = await storage.getUserRelationship(userId, targetId);\n      res.json(relationship);\n    } catch (error) {\n      console.error(\"Error fetching user relationship:\", error);\n      res.status(500).json({ message: \"Failed to fetch user relationship\" });\n    }\n  });\n\n  // ==================== KYC VERIFICATION ROUTES ====================\n\n  // Get current user's KYC status\n  app.get(\"/api/kyc/status\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const kyc = await storage.getKycVerification(userId);\n      if (!kyc) {\n        return res.json({\n          hasKyc: false,\n          status: null,\n          message: \"No KYC verification found. Please initiate verification.\",\n        });\n      }\n\n      res.json({\n        hasKyc: true,\n        id: kyc.id,\n        status: kyc.status,\n        paymentStatus: kyc.paymentStatus,\n        similarityScore: kyc.similarityScore,\n        rejectionReason: kyc.rejectionReason,\n        createdAt: kyc.createdAt,\n        reviewedAt: kyc.reviewedAt,\n      });\n    } catch (error) {\n      console.error(\"Error fetching KYC status:\", error);\n      res.status(500).json({ message: \"Failed to fetch KYC status\" });\n    }\n  });\n\n  // Initiate KYC payment\n  app.post(\"/api/kyc/initiate-payment\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      // Check for existing KYC verification\n      const existingKyc = await storage.getKycVerification(userId);\n      if (existingKyc) {\n        if (existingKyc.status === \"approved\") {\n          return res.status(400).json({ message: \"You are already KYC verified\" });\n        }\n        if (existingKyc.status === \"pending_verification\" || existingKyc.status === \"manual_review\") {\n          return res.status(400).json({ \n            message: \"You have a pending KYC verification\",\n            kycId: existingKyc.id,\n            status: existingKyc.status\n          });\n        }\n        // Allow re-initiating if rejected or refunded\n        if (existingKyc.status !== \"rejected\" && existingKyc.status !== \"refunded\") {\n          return res.status(400).json({ \n            message: \"You have an existing KYC process in progress\",\n            kycId: existingKyc.id,\n            status: existingKyc.status\n          });\n        }\n      }\n\n      // Get user info for payment\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Create or update KYC verification record\n      const kyc = await storage.createKycVerification(userId);\n\n      // Check if Squad is configured\n      if (!isSquadConfigured()) {\n        // Log the action and return pending payment status\n        await storage.createKycLog({\n          kycId: kyc.id,\n          userId,\n          action: \"payment_initiated\",\n          result: \"pending\",\n          ipAddress: req.ip,\n          userAgent: req.headers[\"user-agent\"],\n          metadata: { note: \"Squad payment gateway not configured\" }\n        });\n\n        return res.json({\n          success: true,\n          kycId: kyc.id,\n          message: \"KYC initiated. Payment gateway is being configured.\",\n          paymentRequired: true,\n          amount: 200,\n        });\n      }\n\n      // Generate payment reference\n      const paymentReference = generatePaymentReference();\n\n      // Create Squad payment request for ₦200 KYC fee\n      const paymentData = {\n        amount: 20000, // ₦200 in kobo\n        email: user.email,\n        currency: \"NGN\",\n        initiate_type: \"inline\",\n        transaction_ref: paymentReference,\n        callback_url: `${process.env.APP_URL || 'https://eksu-marketplace.replit.app'}/kyc/payment-callback`,\n        metadata: {\n          kycId: kyc.id,\n          userId: userId,\n          type: \"kyc_verification\"\n        }\n      };\n\n      // Update KYC record with payment reference\n      await storage.updateKycVerification(kyc.id, {\n        paymentReference,\n        paymentStatus: \"pending\",\n      });\n\n      // Log the payment initiation\n      await storage.createKycLog({\n        kycId: kyc.id,\n        userId,\n        action: \"payment_initiated\",\n        result: \"pending\",\n        ipAddress: req.ip,\n        userAgent: req.headers[\"user-agent\"],\n        metadata: { paymentReference }\n      });\n\n      // Initialize Squad payment\n      try {\n        const squadResponse = await squad.initializePayment(paymentData);\n        \n        res.json({\n          success: true,\n          kycId: kyc.id,\n          paymentUrl: squadResponse.checkoutUrl,\n          paymentReference,\n          amount: 200,\n          message: \"Please complete the payment to proceed with KYC verification\",\n        });\n      } catch (squadError: any) {\n        console.error(\"Squad payment error:\", squadError);\n        res.json({\n          success: true,\n          kycId: kyc.id,\n          message: \"Payment gateway temporarily unavailable. Please try again later.\",\n          paymentRequired: true,\n          amount: 200,\n        });\n      }\n    } catch (error) {\n      console.error(\"Error initiating KYC payment:\", error);\n      res.status(500).json({ message: \"Failed to initiate KYC verification\" });\n    }\n  });\n\n  // Submit NIN details for verification\n  app.post(\"/api/kyc/submit-nin\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      // Validate request body\n      const validationResult = initiateKycSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Validation failed\",\n          errors: validationResult.error.flatten().fieldErrors\n        });\n      }\n\n      const { nin, firstName, lastName, dateOfBirth, consent } = validationResult.data;\n\n      // Get KYC verification\n      const kyc = await storage.getKycVerification(userId);\n      if (!kyc) {\n        return res.status(400).json({ \n          message: \"Please initiate KYC verification first by paying the verification fee\" \n        });\n      }\n\n      // Check if payment is completed (skip check if payment gateway not configured)\n      if (isSquadConfigured() && kyc.paymentStatus !== \"completed\") {\n        return res.status(400).json({ \n          message: \"Please complete the payment first\",\n          paymentStatus: kyc.paymentStatus\n        });\n      }\n\n      // Check if KYC is already in progress or completed\n      if (kyc.status === \"approved\") {\n        return res.status(400).json({ message: \"You are already KYC verified\" });\n      }\n      if (kyc.status === \"pending_verification\" && kyc.ninPhotoUrl) {\n        return res.status(400).json({ \n          message: \"NIN already submitted. Please upload your selfie to complete verification\",\n          status: kyc.status\n        });\n      }\n\n      // Log the NIN submission\n      await storage.createKycLog({\n        kycId: kyc.id,\n        userId,\n        action: \"nin_submitted\",\n        result: \"pending\",\n        ipAddress: req.ip,\n        userAgent: req.headers[\"user-agent\"],\n        metadata: { nin: nin.slice(0, 3) + \"****\" + nin.slice(-3) } // Masked NIN for logging\n      });\n\n      // Call SMEDATA.NG API to verify NIN and get photo\n      const ninVerification = await verifyNIN(nin, firstName, lastName, dateOfBirth);\n\n      if (!ninVerification.success || !ninVerification.data) {\n        // Log the failure\n        await storage.createKycLog({\n          kycId: kyc.id,\n          userId,\n          action: \"nin_verification\",\n          result: \"failed\",\n          ipAddress: req.ip,\n          userAgent: req.headers[\"user-agent\"],\n          metadata: { error: ninVerification.error || ninVerification.message }\n        });\n\n        return res.status(400).json({\n          success: false,\n          message: ninVerification.message || \"NIN verification failed. Please check your details and try again.\",\n          error: ninVerification.error\n        });\n      }\n\n      // Store NIN verification data (temporarily, will be deleted after verification)\n      const ninPhotoBase64 = ninVerification.data.photo;\n      let ninPhotoUrl = null;\n\n      if (ninPhotoBase64) {\n        // Store the base64 photo temporarily - in production, you'd upload to object storage\n        ninPhotoUrl = `data:image/jpeg;base64,${ninPhotoBase64}`;\n      }\n\n      // Update KYC record with NIN data\n      await storage.updateKycVerification(kyc.id, {\n        nin: nin, // Store temporarily, will be deleted after verification\n        ninFirstName: ninVerification.data.firstname,\n        ninLastName: ninVerification.data.surname,\n        ninDateOfBirth: ninVerification.data.birthdate,\n        ninPhotoUrl: ninPhotoUrl,\n        consentGiven: consent,\n        consentTimestamp: new Date(),\n        status: \"pending_verification\",\n        smedataResponse: ninVerification.data,\n      });\n\n      // Log successful NIN verification\n      await storage.createKycLog({\n        kycId: kyc.id,\n        userId,\n        action: \"nin_verification\",\n        result: \"success\",\n        ipAddress: req.ip,\n        userAgent: req.headers[\"user-agent\"],\n        metadata: { \n          matchedName: `${ninVerification.data.firstname} ${ninVerification.data.surname}`,\n          hasPhoto: !!ninPhotoBase64\n        }\n      });\n\n      res.json({\n        success: true,\n        message: \"NIN verified successfully. Please upload your selfie to complete verification.\",\n        kycId: kyc.id,\n        status: \"pending_verification\",\n        verifiedName: `${ninVerification.data.firstname} ${ninVerification.data.surname}`,\n        hasPhoto: !!ninPhotoBase64,\n      });\n    } catch (error) {\n      console.error(\"Error submitting NIN for verification:\", error);\n      res.status(500).json({ message: \"Failed to verify NIN\" });\n    }\n  });\n\n  // Upload selfie for comparison\n  app.post(\"/api/kyc/upload-selfie\", isAuthenticated, upload.single(\"selfie\"), async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      // Get KYC verification\n      const kyc = await storage.getKycVerification(userId);\n      if (!kyc) {\n        return res.status(400).json({ message: \"Please initiate KYC verification first\" });\n      }\n\n      if (kyc.status === \"approved\") {\n        return res.status(400).json({ message: \"You are already KYC verified\" });\n      }\n\n      if (!kyc.ninPhotoUrl) {\n        return res.status(400).json({ \n          message: \"Please submit your NIN details first\",\n          status: kyc.status\n        });\n      }\n\n      // Check if selfie file was uploaded\n      if (!req.file) {\n        return res.status(400).json({ message: \"Please upload a selfie image\" });\n      }\n\n      // Log the selfie upload\n      await storage.createKycLog({\n        kycId: kyc.id,\n        userId,\n        action: \"selfie_uploaded\",\n        result: \"pending\",\n        ipAddress: req.ip,\n        userAgent: req.headers[\"user-agent\"],\n      });\n\n      // Upload selfie to object storage\n      let selfieUrl: string;\n      try {\n        if (isCloudinaryConfigured()) {\n          const uploadResult = await uploadToObjectStorage(req.file, `kyc/selfie_${userId}`);\n          if (uploadResult) {\n            selfieUrl = uploadResult;\n          } else {\n            selfieUrl = `data:${req.file.mimetype};base64,${req.file.buffer.toString(\"base64\")}`;\n          }\n        } else {\n          // Store locally as base64 for development\n          selfieUrl = `data:${req.file.mimetype};base64,${req.file.buffer.toString(\"base64\")}`;\n        }\n      } catch (uploadError) {\n        console.error(\"Selfie upload error:\", uploadError);\n        return res.status(500).json({ message: \"Failed to upload selfie\" });\n      }\n\n      // FACE COMPARISON: SMEDATA.NG provides NIN verification but NOT face comparison.\n      // For production, integrate QoreID (https://docs.qoreid.com/docs/nin-face-match) or \n      // IdentityPass (https://developer.myidentitypass.com) for NIN + Face verification.\n      // Alternatively, use AWS Rekognition or Azure Face API for standalone face comparison.\n      // \n      // Example QoreID integration would call their API with the selfie and NIN, returning\n      // a match_score (0-100) with threshold of 70% for genuine face matching.\n      //\n      // Current implementation uses a placeholder random score for development/testing.\n      // TODO: Replace with real face comparison API (set FACE_API_KEY env var)\n      let similarityScore: number;\n      \n      // Check if a face comparison API is configured\n      if (process.env.QOREID_API_KEY) {\n        // Placeholder for QoreID integration - would make API call here\n        // const response = await fetch('https://api.qoreid.com/v1/ng/identities/face-verification/nin', {...})\n        // similarityScore = response.data.summary.face_verification_check.match_score\n        console.log(\"QoreID API key found - would use real face comparison here\");\n        similarityScore = Math.floor(Math.random() * 36) + 60; // Placeholder until integrated\n      } else {\n        // Development/demo mode: generate random score between 60-95\n        console.log(\"No face comparison API configured - using simulated score for demo\");\n        similarityScore = Math.floor(Math.random() * 36) + 60;\n      }\n\n      // Determine verification result based on similarity score\n      let status: \"approved\" | \"manual_review\" | \"rejected\";\n      let autoDecision = \"\";\n\n      if (similarityScore >= 85) {\n        status = \"approved\";\n        autoDecision = \"auto_approved\";\n      } else if (similarityScore >= 70) {\n        status = \"manual_review\";\n        autoDecision = \"manual_review_required\";\n      } else {\n        status = \"rejected\";\n        autoDecision = \"auto_rejected\";\n      }\n\n      // Update KYC record with selfie and comparison result\n      await storage.updateKycVerification(kyc.id, {\n        selfieUrl,\n        similarityScore: similarityScore.toString(),\n        status,\n        ...(status === \"approved\" ? { reviewedAt: new Date() } : {}),\n      });\n\n      // Log the comparison result\n      await storage.createKycLog({\n        kycId: kyc.id,\n        userId,\n        action: \"photo_comparison\",\n        result: autoDecision,\n        similarityScore: similarityScore,\n        ipAddress: req.ip,\n        userAgent: req.headers[\"user-agent\"],\n        metadata: { \n          decision: status,\n          threshold: { autoApprove: 85, manualReview: 70, reject: 0 }\n        }\n      });\n\n      // If auto-approved, update user's verification status\n      if (status === \"approved\") {\n        await storage.updateUserProfile(userId, {\n          ninVerified: true,\n          isVerified: true,\n        });\n\n        // Log the approval\n        await storage.createKycLog({\n          kycId: kyc.id,\n          userId,\n          action: \"auto_approved\",\n          result: \"success\",\n          similarityScore: similarityScore,\n          ipAddress: req.ip,\n          userAgent: req.headers[\"user-agent\"],\n        });\n\n        // Clean up sensitive data after successful verification\n        await storage.updateKycVerification(kyc.id, {\n          nin: null,\n          ninPhotoUrl: null,\n          selfieUrl: null,\n          imagesDeletedAt: new Date(),\n        });\n\n        res.json({\n          success: true,\n          message: \"Congratulations! Your identity has been verified successfully.\",\n          status: \"approved\",\n          similarityScore,\n        });\n      } else if (status === \"manual_review\") {\n        res.json({\n          success: true,\n          message: \"Your verification is under review. We'll notify you once it's complete.\",\n          status: \"manual_review\",\n          similarityScore,\n        });\n      } else {\n        // Rejected - process refund\n        const wallet = await storage.getOrCreateWallet(userId);\n        await storage.updateWalletBalance(userId, \"200\", \"add\");\n        \n        // Create refund transaction\n        await storage.createTransaction({\n          walletId: wallet.id,\n          type: \"refund\",\n          amount: \"200\",\n          status: \"completed\",\n          description: \"KYC verification fee refund - photo mismatch\",\n          relatedUserId: userId,\n        });\n\n        // Update KYC status to refunded\n        await storage.updateKycVerification(kyc.id, {\n          status: \"refunded\",\n          rejectionReason: \"Photo comparison score too low. The selfie does not sufficiently match the NIN photo.\",\n        });\n\n        // Log the rejection and refund\n        await storage.createKycLog({\n          kycId: kyc.id,\n          userId,\n          action: \"auto_rejected_refunded\",\n          result: \"refunded\",\n          similarityScore: similarityScore,\n          ipAddress: req.ip,\n          userAgent: req.headers[\"user-agent\"],\n          metadata: { refundAmount: 200 }\n        });\n\n        // Clean up sensitive data\n        await storage.updateKycVerification(kyc.id, {\n          nin: null,\n          ninPhotoUrl: null,\n          selfieUrl: null,\n          imagesDeletedAt: new Date(),\n        });\n\n        res.json({\n          success: false,\n          message: \"Verification failed. The selfie does not match the NIN photo. Your ₦200 fee has been refunded.\",\n          status: \"rejected\",\n          similarityScore,\n          refunded: true,\n        });\n      }\n    } catch (error) {\n      console.error(\"Error processing selfie upload:\", error);\n      res.status(500).json({ message: \"Failed to process selfie\" });\n    }\n  });\n\n  // Admin: Review pending KYC verifications\n  app.post(\"/api/kyc/admin/review\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      // Check if user is admin\n      const adminUser = await storage.getUser(userId);\n      if (!adminUser || adminUser.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      // Validate request body\n      const validationResult = reviewKycSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Validation failed\",\n          errors: validationResult.error.flatten().fieldErrors\n        });\n      }\n\n      const { kycId, action, notes, rejectionReason } = validationResult.data;\n\n      // Get the KYC verification\n      const kyc = await storage.getKycVerificationById(kycId);\n      if (!kyc) {\n        return res.status(404).json({ message: \"KYC verification not found\" });\n      }\n\n      if (kyc.status !== \"manual_review\") {\n        return res.status(400).json({ \n          message: \"This KYC verification is not pending review\",\n          currentStatus: kyc.status\n        });\n      }\n\n      const targetUserId = kyc.userId;\n\n      if (action === \"approve\") {\n        // Approve the verification\n        await storage.updateKycVerification(kycId, {\n          status: \"approved\",\n          reviewedBy: userId,\n          reviewedAt: new Date(),\n          reviewNotes: notes || null,\n        });\n\n        // Update user's verification status\n        await storage.updateUserProfile(targetUserId, {\n          ninVerified: true,\n          isVerified: true,\n        });\n\n        // Log the approval\n        await storage.createKycLog({\n          kycId,\n          userId: targetUserId,\n          action: \"manual_approved\",\n          result: \"success\",\n          reviewedBy: userId,\n          similarityScore: kyc.similarityScore ? parseFloat(kyc.similarityScore) : undefined,\n          metadata: { notes, adminId: userId }\n        });\n\n        // Clean up sensitive data after approval\n        await storage.updateKycVerification(kycId, {\n          nin: null,\n          ninPhotoUrl: null,\n          selfieUrl: null,\n          imagesDeletedAt: new Date(),\n        });\n\n        res.json({\n          success: true,\n          message: \"KYC verification approved successfully\",\n          kycId,\n          status: \"approved\",\n        });\n      } else {\n        // Reject the verification and refund\n        await storage.updateKycVerification(kycId, {\n          status: \"rejected\",\n          reviewedBy: userId,\n          reviewedAt: new Date(),\n          reviewNotes: notes || null,\n          rejectionReason: rejectionReason || \"Manual review rejection\",\n        });\n\n        // Process refund\n        const wallet = await storage.getOrCreateWallet(targetUserId);\n        await storage.updateWalletBalance(targetUserId, \"200\", \"add\");\n        \n        // Create refund transaction\n        await storage.createTransaction({\n          walletId: wallet.id,\n          type: \"refund\",\n          amount: \"200\",\n          status: \"completed\",\n          description: `KYC verification fee refund - ${rejectionReason || \"rejected by admin\"}`,\n          relatedUserId: targetUserId,\n        });\n\n        // Update status to refunded\n        await storage.updateKycVerification(kycId, {\n          status: \"refunded\",\n        });\n\n        // Log the rejection\n        await storage.createKycLog({\n          kycId,\n          userId: targetUserId,\n          action: \"manual_rejected\",\n          result: \"refunded\",\n          reviewedBy: userId,\n          similarityScore: kyc.similarityScore ? parseFloat(kyc.similarityScore) : undefined,\n          metadata: { notes, rejectionReason, adminId: userId, refundAmount: 200 }\n        });\n\n        // Clean up sensitive data\n        await storage.updateKycVerification(kycId, {\n          nin: null,\n          ninPhotoUrl: null,\n          selfieUrl: null,\n          imagesDeletedAt: new Date(),\n        });\n\n        res.json({\n          success: true,\n          message: \"KYC verification rejected and fee refunded\",\n          kycId,\n          status: \"refunded\",\n        });\n      }\n    } catch (error) {\n      console.error(\"Error reviewing KYC verification:\", error);\n      res.status(500).json({ message: \"Failed to review KYC verification\" });\n    }\n  });\n\n  // Admin: Get all pending KYC verifications\n  app.get(\"/api/kyc/admin/pending\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      // Check if user is admin\n      const adminUser = await storage.getUser(userId);\n      if (!adminUser || adminUser.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const pendingVerifications = await storage.getPendingKycVerifications();\n      \n      // Get user details for each verification\n      const verificationsWithUsers = await Promise.all(\n        pendingVerifications.map(async (kyc) => {\n          const user = await storage.getUser(kyc.userId);\n          return {\n            ...kyc,\n            user: user ? {\n              id: user.id,\n              email: user.email,\n              firstName: user.firstName,\n              lastName: user.lastName,\n            } : null,\n          };\n        })\n      );\n\n      res.json(verificationsWithUsers);\n    } catch (error) {\n      console.error(\"Error fetching pending KYC verifications:\", error);\n      res.status(500).json({ message: \"Failed to fetch pending verifications\" });\n    }\n  });\n\n  // Create HTTP server\n  const httpServer = createServer(app);\n\n  // Setup WebSocket server for real-time chat and notifications\n  const wss = new WebSocketServer({ server: httpServer, path: \"/ws\" });\n\n  wss.on(\"connection\", (ws: WebSocket, req) => {\n    let userId: string | null = null;\n\n    ws.on(\"message\", async (message: string) => {\n      try {\n        const data = JSON.parse(message.toString());\n        \n        // Handle authentication message with JWT token\n        if (data.type === \"auth\" && data.token) {\n          try {\n            // Verify the JWT token\n            const decoded = jwt.verify(data.token, process.env.SESSION_SECRET!) as { userId: string; purpose: string };\n            \n            // Validate token purpose\n            if (decoded.purpose !== \"websocket\") {\n              ws.send(JSON.stringify({ \n                type: \"auth_error\", \n                message: \"Invalid token purpose\" \n              }));\n              ws.close();\n              return;\n            }\n            \n            // Verify user exists and is active\n            const user = await storage.getUser(decoded.userId);\n            if (!user || user.isBanned || !user.isActive) {\n              ws.send(JSON.stringify({ \n                type: \"auth_error\", \n                message: \"User account inactive or banned\" \n              }));\n              ws.close();\n              return;\n            }\n            \n            userId = decoded.userId;\n            // Check if this is user's first connection (they were offline before)\n            const wasOffline = !isUserOnline(userId);\n            addWsConnection(userId, ws);\n            console.log(`WebSocket authenticated for user: ${userId} (connection added)`);\n            ws.send(JSON.stringify({ type: \"auth_success\", userId }));\n            \n            // Broadcast that user is now online if this was their first connection\n            if (wasOffline) {\n              broadcastUserStatusChange(userId, true);\n              console.log(`User ${userId} is now online - status broadcast sent`);\n            }\n          } catch (error) {\n            console.error(\"WebSocket auth error:\", error);\n            ws.send(JSON.stringify({ \n              type: \"auth_error\", \n              message: error instanceof jwt.JsonWebTokenError ? \"Invalid or expired token\" : \"Authentication failed\"\n            }));\n            ws.close();\n          }\n          return;\n        }\n        \n        // Handle chat messages (persist via storage and broadcast)\n        if (data.type === \"message\" && userId) {\n          // Persist the message to database\n          const savedMessage = await storage.createMessage({\n            senderId: userId,\n            receiverId: data.receiverId,\n            content: data.content,\n            productId: data.productId,\n          });\n          \n          // Send to recipient if they're connected (broadcasts to all their connections)\n          broadcastToUser(data.receiverId, {\n            type: \"new_message\",\n            message: savedMessage,\n          });\n          \n          // Create notification for message receiver\n          if (data.receiverId && data.receiverId !== userId) {\n            const sender = await storage.getUser(userId);\n            if (sender) {\n              const senderName = sender.firstName && sender.lastName \n                ? `${sender.firstName} ${sender.lastName}` \n                : sender.email;\n              \n              const messagePreview = data.content.length > 50 \n                ? data.content.substring(0, 50) + \"...\" \n                : data.content;\n              \n              await createAndBroadcastNotification({\n                userId: data.receiverId,\n                type: \"message\",\n                title: \"New Message\",\n                message: `${senderName}: ${messagePreview}`,\n                link: `/messages/${userId}`,\n                relatedUserId: userId,\n                relatedProductId: data.productId || undefined,\n              });\n            }\n          }\n          \n          // Confirm to sender\n          ws.send(JSON.stringify({\n            type: \"message_sent\",\n            message: savedMessage,\n          }));\n        }\n\n        // ========================================\n        // Game Room WebSocket Events\n        // ========================================\n\n        // Join game room WebSocket channel\n        if (data.type === \"game_room_join\" && userId) {\n          const { roomCode } = data;\n          if (!roomCode) {\n            ws.send(JSON.stringify({ type: \"game_room_error\", message: \"Room code required\" }));\n            return;\n          }\n\n          const room = await storage.getGameRoomByCode(roomCode);\n          if (!room) {\n            ws.send(JSON.stringify({ type: \"game_room_error\", message: \"Room not found\" }));\n            return;\n          }\n\n          addGameRoomConnection(roomCode, userId, ws);\n          \n          // Notify others in room\n          broadcastToGameRoom(roomCode, {\n            type: \"player_joined\",\n            playerId: userId,\n            roomCode,\n            players: room.players,\n          }, userId);\n\n          ws.send(JSON.stringify({\n            type: \"game_room_joined\",\n            room,\n          }));\n        }\n\n        // Leave game room WebSocket channel\n        if (data.type === \"game_room_leave\" && userId) {\n          const { roomCode } = data;\n          if (roomCode) {\n            removeGameRoomConnection(roomCode, userId);\n            \n            // Notify others\n            broadcastToGameRoom(roomCode, {\n              type: \"player_left\",\n              playerId: userId,\n              roomCode,\n            });\n          }\n        }\n\n        // Player ready status change\n        if (data.type === \"player_ready\" && userId) {\n          const { roomCode } = data;\n          const room = await storage.getGameRoomByCode(roomCode);\n          if (room) {\n            const player = await storage.togglePlayerReady(room.id, userId);\n            const updatedRoom = await storage.getGameRoomByCode(roomCode);\n            \n            // Broadcast to all players including sender\n            const roomConnections = gameRoomConnections.get(roomCode);\n            if (roomConnections) {\n              const message = JSON.stringify({\n                type: \"player_ready_changed\",\n                playerId: userId,\n                isReady: player.isReady,\n                room: updatedRoom,\n              });\n              roomConnections.forEach((conn) => {\n                if (conn.readyState === WebSocket.OPEN) {\n                  conn.send(message);\n                }\n              });\n            }\n          }\n        }\n\n        // Game chat message\n        if (data.type === \"game_chat\" && userId) {\n          const { roomCode, content } = data;\n          const room = await storage.getGameRoomByCode(roomCode);\n          if (room && content) {\n            const message = await storage.createGameChatMessage(room.id, userId, content);\n            const sender = await storage.getUser(userId);\n            \n            // Broadcast to all players in room\n            const roomConnections = gameRoomConnections.get(roomCode);\n            if (roomConnections) {\n              const broadcastMsg = JSON.stringify({\n                type: \"game_chat_message\",\n                message: { ...message, sender },\n              });\n              roomConnections.forEach((conn) => {\n                if (conn.readyState === WebSocket.OPEN) {\n                  conn.send(broadcastMsg);\n                }\n              });\n            }\n          }\n        }\n\n        // Game action (move, play card, etc.)\n        if (data.type === \"game_action\" && userId) {\n          const { roomCode, action, payload } = data;\n          const room = await storage.getGameRoomByCode(roomCode);\n          if (room && room.status === \"playing\") {\n            // Update game state based on action\n            const currentState = room.gameState || {};\n            const newState = { ...currentState, lastAction: { action, payload, playerId: userId, timestamp: new Date() } };\n            await storage.updateGameState(room.id, newState);\n\n            // Broadcast action to all players\n            const roomConnections = gameRoomConnections.get(roomCode);\n            if (roomConnections) {\n              const message = JSON.stringify({\n                type: \"game_action_broadcast\",\n                playerId: userId,\n                action,\n                payload,\n                gameState: newState,\n              });\n              roomConnections.forEach((conn) => {\n                if (conn.readyState === WebSocket.OPEN) {\n                  conn.send(message);\n                }\n              });\n            }\n          }\n        }\n\n        // Game state update (full state sync)\n        if (data.type === \"game_state_update\" && userId) {\n          const { roomCode, gameState } = data;\n          const room = await storage.getGameRoomByCode(roomCode);\n          if (room && room.hostId === userId) {\n            await storage.updateGameState(room.id, gameState);\n\n            // Broadcast to all players\n            const roomConnections = gameRoomConnections.get(roomCode);\n            if (roomConnections) {\n              const message = JSON.stringify({\n                type: \"game_state_sync\",\n                gameState,\n              });\n              roomConnections.forEach((conn) => {\n                if (conn.readyState === WebSocket.OPEN) {\n                  conn.send(message);\n                }\n              });\n            }\n          }\n        }\n\n        // Game start event\n        if (data.type === \"game_start\" && userId) {\n          const { roomCode } = data;\n          const room = await storage.getGameRoomByCode(roomCode);\n          if (room && room.hostId === userId) {\n            try {\n              const updatedRoom = await storage.startGameRoom(room.id);\n              \n              // Broadcast game start to all players\n              const roomConnections = gameRoomConnections.get(roomCode);\n              if (roomConnections) {\n                const message = JSON.stringify({\n                  type: \"game_started\",\n                  room: updatedRoom,\n                });\n                roomConnections.forEach((conn) => {\n                  if (conn.readyState === WebSocket.OPEN) {\n                    conn.send(message);\n                  }\n                });\n              }\n            } catch (error: any) {\n              ws.send(JSON.stringify({\n                type: \"game_room_error\",\n                message: error.message || \"Failed to start game\",\n              }));\n            }\n          }\n        }\n\n        // Game end event\n        if (data.type === \"game_end\" && userId) {\n          const { roomCode, winnerId, results } = data;\n          const room = await storage.getGameRoomByCode(roomCode);\n          if (room && room.hostId === userId) {\n            const updatedRoom = await storage.endGameRoom(room.id, winnerId, results);\n            \n            // Broadcast game end to all players\n            const roomConnections = gameRoomConnections.get(roomCode);\n            if (roomConnections) {\n              const message = JSON.stringify({\n                type: \"game_ended\",\n                room: updatedRoom,\n                winnerId,\n                results,\n              });\n              roomConnections.forEach((conn) => {\n                if (conn.readyState === WebSocket.OPEN) {\n                  conn.send(message);\n                }\n              });\n            }\n          }\n        }\n      } catch (error) {\n        console.error(\"WebSocket error:\", error);\n        ws.send(JSON.stringify({ type: \"error\", message: \"Failed to process message\" }));\n      }\n    });\n\n    ws.on(\"close\", () => {\n      if (userId) {\n        removeWsConnection(userId, ws);\n        console.log(`WebSocket disconnected for user: ${userId} (connection removed)`);\n        \n        // Broadcast that user is now offline if they have no more connections\n        if (!isUserOnline(userId)) {\n          broadcastUserStatusChange(userId, false);\n          console.log(`User ${userId} is now offline - status broadcast sent`);\n        }\n      }\n    });\n    \n    ws.on(\"error\", (error) => {\n      console.error(`WebSocket error for user ${userId}:`, error);\n      if (userId) {\n        removeWsConnection(userId, ws);\n        \n        // Broadcast that user is now offline if they have no more connections\n        if (!isUserOnline(userId)) {\n          broadcastUserStatusChange(userId, false);\n          console.log(`User ${userId} is now offline (due to error) - status broadcast sent`);\n        }\n      }\n    });\n  });\n\n  // ========================================\n  // Sponsored Ads API Routes\n  // ========================================\n  \n  // GET /api/ads/active - Get active sponsored ads (optionally filtered by type)\n  // Returns randomized results, max 3 ads\n  app.get(\"/api/ads/active\", async (req, res) => {\n    try {\n      // Check if ads are enabled in platform settings\n      const adsEnabledSetting = await storage.getPlatformSetting(\"ads_enabled\");\n      if (adsEnabledSetting?.value === \"false\") {\n        return res.json([]);\n      }\n      \n      const { type } = req.query;\n      const allAds = await storage.getActiveSponsoredAds(type as string | undefined);\n      \n      // Shuffle array using Fisher-Yates algorithm\n      const shuffled = [...allAds];\n      for (let i = shuffled.length - 1; i > 0; i--) {\n        const j = Math.floor(Math.random() * (i + 1));\n        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];\n      }\n      \n      // Return max 3 randomized ads\n      const ads = shuffled.slice(0, 3);\n      res.json(ads);\n    } catch (error) {\n      console.error(\"Error fetching active ads:\", error);\n      res.status(500).json({ message: \"Failed to fetch ads\" });\n    }\n  });\n  \n  // POST /api/ads/:id/impression - Track ad impression\n  app.post(\"/api/ads/:id/impression\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      await storage.recordAdImpression(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error recording ad impression:\", error);\n      res.status(500).json({ message: \"Failed to record impression\" });\n    }\n  });\n  \n  // POST /api/ads/:id/click - Track ad click\n  app.post(\"/api/ads/:id/click\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      await storage.recordAdClick(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error recording ad click:\", error);\n      res.status(500).json({ message: \"Failed to record click\" });\n    }\n  });\n\n  // ========================================\n  // Stories API Routes (Instagram-like 24h stories)\n  // ========================================\n  \n  // POST /api/stories - Create new story (image, video, or text)\n  app.post(\"/api/stories\", isAuthenticated, uploadMedia.single(\"media\"), async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const { type, textContent, backgroundColor, fontStyle } = req.body;\n      \n      if (!type || ![\"image\", \"video\", \"text\"].includes(type)) {\n        return res.status(400).json({ message: \"Invalid story type\" });\n      }\n      \n      let mediaUrl: string | undefined;\n      \n      if (type === \"image\" || type === \"video\") {\n        if (!req.file) {\n          return res.status(400).json({ message: \"Media file is required for image/video stories\" });\n        }\n        \n        if (type === \"video\") {\n          mediaUrl = await uploadVideoToStorage(req.file, \"stories\") || undefined;\n        } else {\n          const urls = await uploadMultipleToObjectStorage([req.file]);\n          mediaUrl = urls[0];\n        }\n      } else if (type === \"text\") {\n        if (!textContent || textContent.trim() === \"\") {\n          return res.status(400).json({ message: \"Text content is required for text stories\" });\n        }\n      }\n      \n      const story = await storage.createStory({\n        authorId: userId,\n        type: type as \"image\" | \"video\" | \"text\",\n        mediaUrl,\n        textContent: type === \"text\" ? textContent : undefined,\n        backgroundColor: backgroundColor || \"#16a34a\",\n        fontStyle: fontStyle || \"sans-serif\",\n      });\n      \n      const storyWithAuthor = await storage.getStory(story.id);\n      res.status(201).json(storyWithAuthor);\n    } catch (error) {\n      console.error(\"Error creating story:\", error);\n      res.status(500).json({ message: \"Failed to create story\" });\n    }\n  });\n  \n  // GET /api/stories - Get stories from followed users and own stories\n  app.get(\"/api/stories\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const stories = await storage.getActiveStories(userId);\n      res.json(stories);\n    } catch (error) {\n      console.error(\"Error fetching stories:\", error);\n      res.status(500).json({ message: \"Failed to fetch stories\" });\n    }\n  });\n  \n  // GET /api/stories/users - Get users with active stories (for the story ring UI)\n  app.get(\"/api/stories/users\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const usersWithStories = await storage.getUsersWithActiveStories(userId);\n      res.json(usersWithStories);\n    } catch (error) {\n      console.error(\"Error fetching users with stories:\", error);\n      res.status(500).json({ message: \"Failed to fetch users with stories\" });\n    }\n  });\n  \n  // GET /api/stories/user/:userId - Get user's active stories\n  // IMPORTANT: This route must be defined BEFORE /api/stories/:id to prevent Express\n  // from matching \"/api/stories/user/123\" as \"/api/stories/:id\" with id=\"user\"\n  app.get(\"/api/stories/user/:userId\", isAuthenticated, async (req, res) => {\n    try {\n      const { userId: targetUserId } = req.params;\n      const currentUserId = getUserId(req);\n      \n      // Get user's active stories with hasViewed flag for the current user\n      const userStories = await storage.getUserActiveStories(targetUserId);\n      \n      // Add hasViewed flag for each story\n      const storiesWithViewStatus = await Promise.all(\n        userStories.map(async (story) => {\n          const hasViewed = currentUserId \n            ? await storage.hasViewedStory(story.id, currentUserId)\n            : false;\n          return { ...story, hasViewed };\n        })\n      );\n      \n      res.json(storiesWithViewStatus);\n    } catch (error) {\n      console.error(\"Error fetching user stories:\", error);\n      res.status(500).json({ message: \"Failed to fetch user stories\" });\n    }\n  });\n  \n  // GET /api/stories/:id - Get single story\n  app.get(\"/api/stories/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const story = await storage.getStory(id);\n      \n      if (!story) {\n        return res.status(404).json({ message: \"Story not found\" });\n      }\n      \n      res.json(story);\n    } catch (error) {\n      console.error(\"Error fetching story:\", error);\n      res.status(500).json({ message: \"Failed to fetch story\" });\n    }\n  });\n  \n  // POST /api/stories/:id/view - Mark story as viewed\n  app.post(\"/api/stories/:id/view\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const { id } = req.params;\n      \n      const story = await storage.getStory(id);\n      if (!story) {\n        return res.status(404).json({ message: \"Story not found\" });\n      }\n      \n      const view = await storage.viewStory(id, userId);\n      res.json(view);\n    } catch (error) {\n      console.error(\"Error viewing story:\", error);\n      res.status(500).json({ message: \"Failed to record story view\" });\n    }\n  });\n  \n  // GET /api/stories/:id/views - Get story views\n  app.get(\"/api/stories/:id/views\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const { id } = req.params;\n      \n      const story = await storage.getStory(id);\n      if (!story) {\n        return res.status(404).json({ message: \"Story not found\" });\n      }\n      \n      // Only story author can see views\n      if (story.authorId !== userId) {\n        return res.status(403).json({ message: \"Not authorized to view story views\" });\n      }\n      \n      const views = await storage.getStoryViews(id);\n      res.json(views);\n    } catch (error) {\n      console.error(\"Error fetching story views:\", error);\n      res.status(500).json({ message: \"Failed to fetch story views\" });\n    }\n  });\n  \n  // POST /api/stories/:id/react - React to story\n  app.post(\"/api/stories/:id/react\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const { id } = req.params;\n      const { reaction } = req.body;\n      \n      if (!reaction) {\n        return res.status(400).json({ message: \"Reaction is required\" });\n      }\n      \n      const story = await storage.getStory(id);\n      if (!story) {\n        return res.status(404).json({ message: \"Story not found\" });\n      }\n      \n      const storyReaction = await storage.reactToStory(id, userId, reaction);\n      \n      // Create notification for story author\n      if (story.authorId !== userId) {\n        const reactor = await storage.getUser(userId);\n        if (reactor) {\n          const reactorName = reactor.firstName && reactor.lastName \n            ? `${reactor.firstName} ${reactor.lastName}` \n            : reactor.email;\n          \n          await createAndBroadcastNotification({\n            userId: story.authorId,\n            type: \"story_reaction\",\n            title: \"Story Reaction\",\n            message: `${reactorName} reacted ${reaction} to your story`,\n            link: `/the-plug`,\n            relatedUserId: userId,\n          });\n        }\n      }\n      \n      res.json(storyReaction);\n    } catch (error) {\n      console.error(\"Error reacting to story:\", error);\n      res.status(500).json({ message: \"Failed to react to story\" });\n    }\n  });\n  \n  // GET /api/stories/:id/reactions - Get story reactions\n  app.get(\"/api/stories/:id/reactions\", isAuthenticated, async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      const story = await storage.getStory(id);\n      if (!story) {\n        return res.status(404).json({ message: \"Story not found\" });\n      }\n      \n      const reactions = await storage.getStoryReactions(id);\n      res.json(reactions);\n    } catch (error) {\n      console.error(\"Error fetching story reactions:\", error);\n      res.status(500).json({ message: \"Failed to fetch story reactions\" });\n    }\n  });\n  \n  // POST /api/stories/:id/reply - Reply to story\n  app.post(\"/api/stories/:id/reply\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const { id } = req.params;\n      const { content } = req.body;\n      \n      if (!content || content.trim() === \"\") {\n        return res.status(400).json({ message: \"Reply content is required\" });\n      }\n      \n      const story = await storage.getStory(id);\n      if (!story) {\n        return res.status(404).json({ message: \"Story not found\" });\n      }\n      \n      const reply = await storage.replyToStory(id, userId, content);\n      \n      // Create notification for story author\n      if (story.authorId !== userId) {\n        const sender = await storage.getUser(userId);\n        if (sender) {\n          const senderName = sender.firstName && sender.lastName \n            ? `${sender.firstName} ${sender.lastName}` \n            : sender.email;\n          \n          const replyPreview = content.length > 50 \n            ? content.substring(0, 50) + \"...\" \n            : content;\n          \n          await createAndBroadcastNotification({\n            userId: story.authorId,\n            type: \"story_reply\",\n            title: \"Story Reply\",\n            message: `${senderName}: ${replyPreview}`,\n            link: `/messages/${userId}`,\n            relatedUserId: userId,\n          });\n        }\n      }\n      \n      res.json(reply);\n    } catch (error) {\n      console.error(\"Error replying to story:\", error);\n      res.status(500).json({ message: \"Failed to reply to story\" });\n    }\n  });\n  \n  // GET /api/stories/:id/replies - Get story replies\n  app.get(\"/api/stories/:id/replies\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const { id } = req.params;\n      \n      const story = await storage.getStory(id);\n      if (!story) {\n        return res.status(404).json({ message: \"Story not found\" });\n      }\n      \n      // Only story author can see all replies\n      if (story.authorId !== userId) {\n        return res.status(403).json({ message: \"Not authorized to view story replies\" });\n      }\n      \n      const replies = await storage.getStoryReplies(id);\n      res.json(replies);\n    } catch (error) {\n      console.error(\"Error fetching story replies:\", error);\n      res.status(500).json({ message: \"Failed to fetch story replies\" });\n    }\n  });\n  \n  // DELETE /api/stories/:id - Delete own story\n  app.delete(\"/api/stories/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const { id } = req.params;\n      \n      const story = await storage.getStory(id);\n      if (!story) {\n        return res.status(404).json({ message: \"Story not found\" });\n      }\n      \n      if (story.authorId !== userId) {\n        return res.status(403).json({ message: \"Not authorized to delete this story\" });\n      }\n      \n      await storage.deleteStory(id);\n      res.json({ message: \"Story deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting story:\", error);\n      res.status(500).json({ message: \"Failed to delete story\" });\n    }\n  });\n\n  // ==================== CONFESSIONS ROUTES (Anonymous Board) ====================\n\n  // Auto-approve pending confessions every minute\n  setInterval(async () => {\n    try {\n      const approved = await storage.autoApproveOldConfessions();\n      if (approved > 0) {\n        console.log(`Auto-approved ${approved} pending confessions`);\n      }\n    } catch (error) {\n      console.error(\"Error auto-approving confessions:\", error);\n    }\n  }, 60 * 1000);\n\n  // POST /api/confessions - Create new confession\n  app.post(\"/api/confessions\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { content, category, isAnonymous } = req.body;\n\n      if (!content || content.trim().length < 10) {\n        return res.status(400).json({ message: \"Confession must be at least 10 characters\" });\n      }\n\n      if (content.length > 2000) {\n        return res.status(400).json({ message: \"Confession must not exceed 2000 characters\" });\n      }\n\n      const validCategories = [\"general\", \"love\", \"academics\", \"drama\", \"advice\", \"funny\", \"secrets\"];\n      const selectedCategory = category && validCategories.includes(category) ? category : \"general\";\n\n      const confession = await storage.createConfession({\n        authorId: userId,\n        content: content.trim(),\n        category: selectedCategory,\n        isAnonymous: isAnonymous !== false,\n      });\n\n      res.status(201).json(confession);\n    } catch (error) {\n      console.error(\"Error creating confession:\", error);\n      res.status(500).json({ message: \"Failed to create confession\" });\n    }\n  });\n\n  // GET /api/confessions - Get approved confessions with pagination (allows guest access)\n  app.get(\"/api/confessions\", async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      const { category, page, limit } = req.query;\n\n      const result = await storage.getConfessions({\n        category: category as string,\n        status: \"approved\",\n        page: page ? parseInt(page as string) : 1,\n        limit: limit ? parseInt(limit as string) : 20,\n      });\n\n      // If user is logged in, enrich confessions with their vote status\n      if (userId && result.confessions && result.confessions.length > 0) {\n        const enrichedConfessions = await Promise.all(\n          result.confessions.map(async (confession) => {\n            const userVote = await storage.getUserVote(confession.id, userId);\n            return {\n              ...confession,\n              userVote: userVote?.voteType || null,\n              isOwner: confession.authorId === userId,\n            };\n          })\n        );\n        res.json({ ...result, confessions: enrichedConfessions });\n      } else {\n        // For guests, return confessions without vote info\n        const guestConfessions = result.confessions.map(confession => ({\n          ...confession,\n          userVote: null,\n          isOwner: false,\n        }));\n        res.json({ ...result, confessions: guestConfessions });\n      }\n    } catch (error) {\n      console.error(\"Error fetching confessions:\", error);\n      res.status(500).json({ message: \"Failed to fetch confessions\" });\n    }\n  });\n\n  // GET /api/confessions/trending - Get trending confessions (allows guest access)\n  app.get(\"/api/confessions/trending\", async (req, res) => {\n    try {\n      const { limit } = req.query;\n      const trending = await storage.getTrendingConfessions(\n        limit ? parseInt(limit as string) : 10\n      );\n      res.json(trending);\n    } catch (error) {\n      console.error(\"Error fetching trending confessions:\", error);\n      res.status(500).json({ message: \"Failed to fetch trending confessions\" });\n    }\n  });\n\n  // GET /api/confessions/:id - Get single confession with comments (allows guest access for approved confessions)\n  app.get(\"/api/confessions/:id\", async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      const { id } = req.params;\n\n      const confession = await storage.getConfession(id);\n      if (!confession) {\n        return res.status(404).json({ message: \"Confession not found\" });\n      }\n\n      // Allow guest access only for approved confessions\n      // Non-approved confessions can only be viewed by the owner\n      if (confession.status !== \"approved\") {\n        if (!userId || confession.authorId !== userId) {\n          return res.status(404).json({ message: \"Confession not found\" });\n        }\n      }\n\n      const comments = await storage.getConfessionComments(id);\n      const userVote = userId ? await storage.getUserVote(id, userId) : null;\n\n      res.json({\n        ...confession,\n        comments,\n        userVote: userVote?.voteType || null,\n        isOwner: userId ? confession.authorId === userId : false,\n      });\n    } catch (error) {\n      console.error(\"Error fetching confession:\", error);\n      res.status(500).json({ message: \"Failed to fetch confession\" });\n    }\n  });\n\n  // POST /api/confessions/:id/view - Track confession view (unique: 1 view per user per 24 hours)\n  app.post(\"/api/confessions/:id/view\", async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const userId = getUserId(req);\n      \n      // Verify confession exists\n      const confession = await storage.getConfession(id);\n      if (!confession || confession.status !== \"approved\") {\n        return res.status(404).json({ message: \"Confession not found\" });\n      }\n      \n      // For authenticated users, use unique view tracking\n      if (userId) {\n        const isNewView = await storage.recordUniqueConfessionView(id, userId);\n        res.json({ success: true, isNewView });\n      } else {\n        // For anonymous users, use session-based tracking\n        const sessionId = req.session?.id || req.ip;\n        if (sessionId) {\n          const viewerKey = `anon_${sessionId}`;\n          const isNewView = await storage.recordUniqueConfessionView(id, viewerKey);\n          res.json({ success: true, isNewView });\n        } else {\n          // Fallback: just increment without tracking (rare edge case)\n          await storage.incrementConfessionViews(id);\n          res.json({ success: true, isNewView: true });\n        }\n      }\n    } catch (error) {\n      console.error(\"Error tracking confession view:\", error);\n      res.status(500).json({ message: \"Failed to track view\" });\n    }\n  });\n\n  // POST /api/confessions/:id/vote - Like or dislike a confession\n  app.post(\"/api/confessions/:id/vote\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized - please login to vote\" });\n      }\n\n      const { id } = req.params;\n      let { voteType } = req.body;\n      \n      // Accept both 'upvote'/'downvote' and 'like'/'dislike' for compatibility\n      if (voteType === \"upvote\") voteType = \"like\";\n      if (voteType === \"downvote\") voteType = \"dislike\";\n\n      if (!voteType || ![\"like\", \"dislike\"].includes(voteType)) {\n        return res.status(400).json({ message: \"Invalid vote type. Must be 'like', 'dislike', 'upvote', or 'downvote'\" });\n      }\n\n      const confession = await storage.getConfession(id);\n      if (!confession || confession.status !== \"approved\") {\n        return res.status(404).json({ message: \"Confession not found\" });\n      }\n\n      const existingVote = await storage.getUserVote(id, userId);\n\n      if (existingVote && existingVote.voteType === voteType) {\n        await storage.removeVote(id, userId);\n        const updated = await storage.getConfession(id);\n        return res.json({ \n          message: \"Vote removed\", \n          likesCount: updated?.likesCount || 0,\n          dislikesCount: updated?.dislikesCount || 0,\n          userVote: null \n        });\n      }\n\n      const vote = await storage.voteConfession(id, userId, voteType as 'like' | 'dislike');\n      const updated = await storage.getConfession(id);\n\n      res.json({ \n        message: \"Vote recorded\", \n        likesCount: updated?.likesCount || 0,\n        dislikesCount: updated?.dislikesCount || 0,\n        userVote: vote.voteType \n      });\n    } catch (error: any) {\n      console.error(\"Error voting on confession:\", error);\n      res.status(500).json({ message: error.message || \"Failed to vote on confession\" });\n    }\n  });\n\n  // POST /api/confessions/:id/comments - Add comment to confession\n  app.post(\"/api/confessions/:id/comments\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { id } = req.params;\n      const { content, isAnonymous, parentId } = req.body;\n\n      if (!content || content.trim().length < 1) {\n        return res.status(400).json({ message: \"Comment content is required\" });\n      }\n\n      if (content.length > 1000) {\n        return res.status(400).json({ message: \"Comment must not exceed 1000 characters\" });\n      }\n\n      const confession = await storage.getConfession(id);\n      if (!confession || confession.status !== \"approved\") {\n        return res.status(404).json({ message: \"Confession not found\" });\n      }\n\n      const comment = await storage.createConfessionComment({\n        confessionId: id,\n        authorId: userId,\n        content: content.trim(),\n        isAnonymous: isAnonymous === true,\n        parentId: parentId || undefined,\n      });\n\n      const user = await storage.getUser(userId);\n      const commentWithAuthor = {\n        ...comment,\n        author: isAnonymous ? null : (user ? {\n          id: user.id,\n          firstName: user.firstName,\n          lastName: user.lastName,\n          profileImageUrl: user.profileImageUrl,\n        } : null),\n      };\n\n      res.status(201).json(commentWithAuthor);\n    } catch (error) {\n      console.error(\"Error creating comment:\", error);\n      res.status(500).json({ message: \"Failed to create comment\" });\n    }\n  });\n\n  // POST /api/confessions/:id/report - Report confession\n  app.post(\"/api/confessions/:id/report\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { id } = req.params;\n      const { reason, description } = req.body;\n\n      if (!reason || reason.trim().length < 1) {\n        return res.status(400).json({ message: \"Report reason is required\" });\n      }\n\n      const validReasons = [\"spam\", \"harassment\", \"inappropriate\", \"hate_speech\", \"self_harm\", \"other\"];\n      if (!validReasons.includes(reason)) {\n        return res.status(400).json({ message: \"Invalid report reason\" });\n      }\n\n      const confession = await storage.getConfession(id);\n      if (!confession) {\n        return res.status(404).json({ message: \"Confession not found\" });\n      }\n\n      const report = await storage.createConfessionReport({\n        confessionId: id,\n        reporterId: userId,\n        reason,\n        description: description?.trim() || undefined,\n      });\n\n      res.status(201).json({ message: \"Report submitted successfully\", report });\n    } catch (error) {\n      console.error(\"Error reporting confession:\", error);\n      res.status(500).json({ message: \"Failed to report confession\" });\n    }\n  });\n\n  // DELETE /api/confessions/:id - Delete own confession\n  app.delete(\"/api/confessions/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { id } = req.params;\n\n      const confession = await storage.getConfession(id);\n      if (!confession) {\n        return res.status(404).json({ message: \"Confession not found\" });\n      }\n\n      if (confession.authorId !== userId && !await isAdminUser(userId)) {\n        return res.status(403).json({ message: \"Not authorized to delete this confession\" });\n      }\n\n      await storage.deleteConfession(id);\n      res.json({ message: \"Confession deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting confession:\", error);\n      res.status(500).json({ message: \"Failed to delete confession\" });\n    }\n  });\n\n  // GET /api/confessions/:id/comments - Get comments for a confession (allows guest access)\n  app.get(\"/api/confessions/:id/comments\", async (req, res) => {\n    try {\n      const { id } = req.params;\n\n      const confession = await storage.getConfession(id);\n      if (!confession || confession.status !== \"approved\") {\n        return res.status(404).json({ message: \"Confession not found\" });\n      }\n\n      const comments = await storage.getConfessionComments(id);\n      res.json(comments);\n    } catch (error) {\n      console.error(\"Error fetching comments:\", error);\n      res.status(500).json({ message: \"Failed to fetch comments\" });\n    }\n  });\n\n  // =====================================================\n  // COMMUNITY ROUTES\n  // =====================================================\n\n  // POST /api/communities - Create new community\n  app.post(\"/api/communities\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n\n      const { name, slug, description, iconUrl, coverUrl, type, category, rules } = req.body;\n\n      if (!name || name.trim().length < 3) {\n        return res.status(400).json({ message: \"Community name must be at least 3 characters\" });\n      }\n\n      if (!slug || slug.trim().length < 3) {\n        return res.status(400).json({ message: \"Community slug must be at least 3 characters\" });\n      }\n\n      const slugRegex = /^[a-z0-9-]+$/;\n      if (!slugRegex.test(slug.","path":null,"size_bytes":360000,"size_tokens":null},"server/monnify.ts":{"content":"/**\n * Monnify Payment Gateway Integration\n * \n * This module handles all Monnify API interactions including:\n * - Authentication (OAuth 2.0)\n * - Payment initialization\n * - Transaction verification\n * - Disbursements (instant payouts)\n * - Webhook handling\n */\n\nimport crypto from 'crypto';\n\n// Environment URLs\nconst SANDBOX_BASE_URL = 'https://sandbox.monnify.com';\nconst LIVE_BASE_URL = 'https://api.monnify.com';\n\n// Get base URL based on environment\nfunction getBaseUrl(): string {\n  const isLive = process.env.MONNIFY_ENVIRONMENT === 'LIVE';\n  return isLive ? LIVE_BASE_URL : SANDBOX_BASE_URL;\n}\n\n// Token cache for authentication\nlet accessToken: string | null = null;\nlet tokenExpiry: number = 0;\n\nexport interface MonnifyCredentials {\n  apiKey: string;\n  secretKey: string;\n  contractCode: string;\n}\n\nfunction getCredentials(): MonnifyCredentials {\n  const apiKey = process.env.MONNIFY_API_KEY;\n  const secretKey = process.env.MONNIFY_SECRET_KEY;\n  const contractCode = process.env.MONNIFY_CONTRACT_CODE;\n\n  if (!apiKey || !secretKey || !contractCode) {\n    throw new Error('Monnify credentials not configured. Please set MONNIFY_API_KEY, MONNIFY_SECRET_KEY, and MONNIFY_CONTRACT_CODE environment variables.');\n  }\n\n  return { apiKey, secretKey, contractCode };\n}\n\n/**\n * Get OAuth access token from Monnify\n */\nasync function getAccessToken(): Promise<string> {\n  // Check if we have a valid cached token\n  if (accessToken && Date.now() < tokenExpiry - 60000) {\n    return accessToken;\n  }\n\n  const { apiKey, secretKey } = getCredentials();\n  const credentials = Buffer.from(`${apiKey}:${secretKey}`).toString('base64');\n\n  const response = await fetch(`${getBaseUrl()}/api/v1/auth/login`, {\n    method: 'POST',\n    headers: {\n      'Authorization': `Basic ${credentials}`,\n      'Content-Type': 'application/json',\n    },\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`Monnify authentication failed: ${error}`);\n  }\n\n  const data = await response.json();\n  \n  if (!data.requestSuccessful) {\n    throw new Error(`Monnify authentication failed: ${data.responseMessage}`);\n  }\n\n  accessToken = data.responseBody.accessToken;\n  // Token expires in 5 minutes, cache for 4 minutes\n  tokenExpiry = Date.now() + 4 * 60 * 1000;\n\n  return accessToken!;\n}\n\n/**\n * Make authenticated API request to Monnify\n */\nasync function monnifyRequest<T>(\n  endpoint: string,\n  method: 'GET' | 'POST' | 'PUT' | 'DELETE' = 'GET',\n  body?: any\n): Promise<T> {\n  const token = await getAccessToken();\n\n  const response = await fetch(`${getBaseUrl()}${endpoint}`, {\n    method,\n    headers: {\n      'Authorization': `Bearer ${token}`,\n      'Content-Type': 'application/json',\n    },\n    body: body ? JSON.stringify(body) : undefined,\n  });\n\n  const data = await response.json();\n\n  if (!data.requestSuccessful) {\n    throw new Error(`Monnify API error: ${data.responseMessage}`);\n  }\n\n  return data.responseBody as T;\n}\n\n// ==================== PAYMENT INITIALIZATION ====================\n\nexport interface InitializePaymentRequest {\n  amount: number;\n  customerName: string;\n  customerEmail: string;\n  paymentReference: string;\n  paymentDescription: string;\n  redirectUrl: string;\n  paymentMethods?: ('CARD' | 'ACCOUNT_TRANSFER' | 'USSD' | 'PHONE_NUMBER')[];\n  metadata?: Record<string, any>;\n}\n\nexport interface InitializePaymentResponse {\n  transactionReference: string;\n  paymentReference: string;\n  merchantName: string;\n  apiKey: string;\n  enabledPaymentMethod: string[];\n  checkoutUrl: string;\n}\n\n/**\n * Initialize a one-time payment transaction\n */\nexport async function initializePayment(\n  request: InitializePaymentRequest\n): Promise<InitializePaymentResponse> {\n  const { contractCode } = getCredentials();\n\n  return monnifyRequest<InitializePaymentResponse>(\n    '/api/v1/merchant/transactions/init-transaction',\n    'POST',\n    {\n      amount: request.amount,\n      customerName: request.customerName,\n      customerEmail: request.customerEmail,\n      paymentReference: request.paymentReference,\n      paymentDescription: request.paymentDescription,\n      currencyCode: 'NGN',\n      contractCode,\n      redirectUrl: request.redirectUrl,\n      paymentMethods: request.paymentMethods || ['CARD', 'ACCOUNT_TRANSFER', 'USSD'],\n      metaData: request.metadata,\n    }\n  );\n}\n\n// ==================== TRANSACTION VERIFICATION ====================\n\nexport interface TransactionStatus {\n  transactionReference: string;\n  paymentReference: string;\n  amountPaid: number;\n  totalPayable: number;\n  paymentStatus: 'PAID' | 'PENDING' | 'OVERPAID' | 'PARTIALLY_PAID' | 'FAILED' | 'CANCELLED' | 'EXPIRED';\n  paymentDescription: string;\n  currency: string;\n  paymentMethod: string;\n  product: {\n    type: string;\n    reference: string;\n  };\n  metaData: Record<string, any>;\n  customer: {\n    email: string;\n    name: string;\n  };\n  paidOn?: string;\n  createdOn: string;\n}\n\n/**\n * Verify a transaction by its reference\n */\nexport async function verifyTransaction(\n  transactionReference: string\n): Promise<TransactionStatus> {\n  const encodedReference = encodeURIComponent(transactionReference);\n  return monnifyRequest<TransactionStatus>(\n    `/api/v2/transactions/${encodedReference}`,\n    'GET'\n  );\n}\n\n/**\n * Get transaction status by payment reference\n */\nexport async function getTransactionByPaymentReference(\n  paymentReference: string\n): Promise<TransactionStatus> {\n  return monnifyRequest<TransactionStatus>(\n    `/api/v2/merchant/transactions/query?paymentReference=${encodeURIComponent(paymentReference)}`,\n    'GET'\n  );\n}\n\n// ==================== DISBURSEMENTS (PAYOUTS) ====================\n\nexport interface DisbursementRequest {\n  amount: number;\n  reference: string;\n  narration: string;\n  destinationBankCode: string;\n  destinationAccountNumber: string;\n  currency?: string;\n  sourceAccountNumber?: string;\n}\n\nexport interface DisbursementResponse {\n  amount: number;\n  reference: string;\n  status: 'SUCCESS' | 'PENDING' | 'FAILED';\n  dateCreated: string;\n  totalFee: number;\n  destinationAccountName: string;\n  destinationBankName: string;\n  destinationAccountNumber: string;\n  destinationBankCode: string;\n}\n\n/**\n * Initiate a single transfer (disbursement) to a bank account\n */\nexport async function initiateDisbursement(\n  request: DisbursementRequest\n): Promise<DisbursementResponse> {\n  return monnifyRequest<DisbursementResponse>(\n    '/api/v2/disbursements/single',\n    'POST',\n    {\n      amount: request.amount,\n      reference: request.reference,\n      narration: request.narration,\n      destinationBankCode: request.destinationBankCode,\n      destinationAccountNumber: request.destinationAccountNumber,\n      currency: request.currency || 'NGN',\n      sourceAccountNumber: request.sourceAccountNumber || process.env.MONNIFY_WALLET_ACCOUNT,\n    }\n  );\n}\n\n/**\n * Get disbursement status by reference\n */\nexport async function getDisbursementStatus(\n  reference: string\n): Promise<DisbursementResponse> {\n  return monnifyRequest<DisbursementResponse>(\n    `/api/v2/disbursements/single/summary?reference=${encodeURIComponent(reference)}`,\n    'GET'\n  );\n}\n\n// ==================== BANK VERIFICATION ====================\n\nexport interface BankAccountDetails {\n  accountNumber: string;\n  accountName: string;\n  bankCode: string;\n}\n\n/**\n * Verify bank account number and get account name\n */\nexport async function verifyBankAccount(\n  accountNumber: string,\n  bankCode: string\n): Promise<BankAccountDetails> {\n  return monnifyRequest<BankAccountDetails>(\n    `/api/v1/disbursements/account/validate?accountNumber=${accountNumber}&bankCode=${bankCode}`,\n    'GET'\n  );\n}\n\n// ==================== BANK LIST ====================\n\nexport interface Bank {\n  name: string;\n  code: string;\n  ussdTemplate?: string;\n  baseUssdCode?: string;\n  transferUssdTemplate?: string;\n}\n\n/**\n * Get list of all supported banks\n */\nexport async function getBankList(): Promise<Bank[]> {\n  return monnifyRequest<Bank[]>('/api/v1/banks', 'GET');\n}\n\n// ==================== WEBHOOK VERIFICATION ====================\n\n/**\n * Verify Monnify webhook signature\n */\nexport function verifyWebhookSignature(\n  payload: string,\n  signature: string\n): boolean {\n  const { secretKey } = getCredentials();\n  const computedHash = crypto\n    .createHmac('sha512', secretKey)\n    .update(payload)\n    .digest('hex');\n  \n  return computedHash === signature;\n}\n\nexport interface MonnifyWebhookPayload {\n  transactionReference: string;\n  paymentReference: string;\n  amountPaid: number;\n  totalPayable: number;\n  settlementAmount: number;\n  paidOn: string;\n  paymentStatus: 'PAID' | 'PENDING' | 'OVERPAID' | 'PARTIALLY_PAID' | 'FAILED' | 'CANCELLED' | 'EXPIRED';\n  paymentDescription: string;\n  transactionHash: string;\n  currency: string;\n  paymentMethod: string;\n  product: {\n    type: string;\n    reference: string;\n  };\n  cardDetails?: {\n    cardType: string;\n    last4: string;\n    expMonth: string;\n    expYear: string;\n    bin: string;\n    bankCode: string;\n    bankName: string;\n    reusable: boolean;\n    countryCode: string;\n    cardToken: string;\n    supportsTokenization: boolean;\n  };\n  accountDetails?: {\n    accountName: string;\n    accountNumber: string;\n    bankCode: string;\n    amountPaid: number;\n  };\n  accountPayments?: Array<{\n    accountName: string;\n    accountNumber: string;\n    bankCode: string;\n    amountPaid: number;\n  }>;\n  customer: {\n    email: string;\n    name: string;\n  };\n  metaData?: Record<string, any>;\n}\n\n// ==================== HELPER FUNCTIONS ====================\n\n/**\n * Generate a unique payment reference\n */\nexport function generatePaymentReference(prefix: string = 'EKSU'): string {\n  const timestamp = Date.now().toString(36).toUpperCase();\n  const random = crypto.randomBytes(4).toString('hex').toUpperCase();\n  return `${prefix}_${timestamp}_${random}`;\n}\n\n/**\n * Generate a unique disbursement reference\n */\nexport function generateDisbursementReference(): string {\n  return generatePaymentReference('PAYOUT');\n}\n\n/**\n * Check if Monnify is properly configured\n */\nexport function isMonnifyConfigured(): boolean {\n  return !!(\n    process.env.MONNIFY_API_KEY &&\n    process.env.MONNIFY_SECRET_KEY &&\n    process.env.MONNIFY_CONTRACT_CODE\n  );\n}\n\n// Export all functions\nexport const monnify = {\n  initializePayment,\n  verifyTransaction,\n  getTransactionByPaymentReference,\n  initiateDisbursement,\n  getDisbursementStatus,\n  verifyBankAccount,\n  getBankList,\n  verifyWebhookSignature,\n  generatePaymentReference,\n  generateDisbursementReference,\n  isMonnifyConfigured,\n};\n\nexport default monnify;\n","path":null,"size_bytes":10565,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"client/src/pages/messages.tsx":{"content":"import { useState, useEffect, useRef, useCallback, useMemo, memo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from \"@/components/ui/sheet\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Lightbox, useLightbox } from \"@/components/ui/lightbox\";\nimport { \n  Send, \n  Paperclip, \n  Smile, \n  Check, \n  CheckCheck, \n  CheckCircle,\n  ArrowLeft,\n  MessageCircle,\n  Users,\n  Search,\n  Wifi,\n  WifiOff,\n  Archive,\n  ArchiveRestore,\n  Timer,\n  Heart,\n  ThumbsUp,\n  Laugh,\n  Frown,\n  Angry,\n  Settings,\n  ChevronDown,\n  ChevronUp,\n  X,\n  Image as ImageIcon,\n  Loader2\n} from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\nimport { SafetyShieldModal, hasSafetyBeenAcknowledged } from \"@/components/SafetyShieldModal\";\nimport { UserActionsMenu } from \"@/components/UserActionsMenu\";\nimport type { Message, User, MessageReaction, ArchivedConversation, DisappearingMessageSetting } from \"@shared/schema\";\nimport { useSearch, useParams, useLocation } from \"wouter\";\nimport { motion, AnimatePresence, useMotionValue, useTransform } from \"framer-motion\";\n\ntype WebSocketStatus = \"connecting\" | \"connected\" | \"disconnected\" | \"error\";\n\ninterface ChatThread {\n  user: User;\n  lastMessage?: Message;\n  unreadCount: number;\n}\n\ninterface ReactionWithUser extends MessageReaction {\n  user: User;\n}\n\n// Reaction options using lucide icons\nconst REACTION_OPTIONS = [\n  { id: 'heart', icon: Heart, label: 'Heart' },\n  { id: 'thumbs_up', icon: ThumbsUp, label: 'Like' },\n  { id: 'laugh', icon: Laugh, label: 'Laugh' },\n  { id: 'surprised', icon: Frown, label: 'Surprised' },\n  { id: 'sad', icon: Frown, label: 'Sad' },\n  { id: 'angry', icon: Angry, label: 'Angry' },\n];\n\n// Disappearing message duration options\nconst DISAPPEARING_DURATIONS = [\n  { value: \"0\", label: \"Off\", seconds: 0 },\n  { value: \"86400\", label: \"24 hours\", seconds: 86400 },\n  { value: \"604800\", label: \"7 days\", seconds: 604800 },\n  { value: \"7776000\", label: \"90 days\", seconds: 7776000 },\n];\n\n// Message pagination - initial limit for better performance\nconst INITIAL_MESSAGE_LIMIT = 50;\n\n// Common emoji categories for the emoji picker\nconst EMOJI_CATEGORIES = [\n  { name: \"Smileys\", emojis: [\"😊\", \"😂\", \"🥰\", \"😍\", \"🤗\", \"😎\", \"🤔\", \"😅\", \"😇\", \"🙂\", \"😉\", \"😌\"] },\n  { name: \"Gestures\", emojis: [\"👍\", \"👎\", \"👋\", \"🙏\", \"🤝\", \"✌️\", \"🤞\", \"👏\", \"💪\", \"🤙\", \"👌\", \"✊\"] },\n  { name: \"Hearts\", emojis: [\"❤️\", \"💕\", \"💖\", \"💗\", \"💙\", \"💚\", \"💛\", \"🧡\", \"💜\", \"🖤\", \"🤍\", \"💯\"] },\n  { name: \"Objects\", emojis: [\"📱\", \"💻\", \"📦\", \"💰\", \"🎁\", \"🛒\", \"🏠\", \"🚗\", \"✨\", \"🔥\", \"⭐\", \"🎉\"] },\n];\n\n// Format relative time for message timestamps\nfunction formatRelativeTime(date: Date): string {\n  const now = new Date();\n  const diffMs = now.getTime() - date.getTime();\n  const diffMins = Math.floor(diffMs / 60000);\n  const diffHours = Math.floor(diffMs / 3600000);\n  const diffDays = Math.floor(diffMs / 86400000);\n\n  if (diffMins < 1) return \"Just now\";\n  if (diffMins < 60) return `${diffMins}m ago`;\n  if (diffHours < 24) return `${diffHours}h ago`;\n  if (diffDays === 1) return \"Yesterday\";\n  if (diffDays < 7) return `${diffDays}d ago`;\n  return date.toLocaleDateString([], { month: \"short\", day: \"numeric\" });\n}\n\n// Format date separator\nfunction formatDateSeparator(date: Date): string {\n  const now = new Date();\n  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n  const yesterday = new Date(today.getTime() - 86400000);\n  const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());\n\n  if (messageDate.getTime() === today.getTime()) return \"Today\";\n  if (messageDate.getTime() === yesterday.getTime()) return \"Yesterday\";\n  return date.toLocaleDateString([], { weekday: \"long\", month: \"long\", day: \"numeric\" });\n}\n\n// Check if two dates are on the same day\nfunction isSameDay(date1: Date, date2: Date): boolean {\n  return (\n    date1.getFullYear() === date2.getFullYear() &&\n    date1.getMonth() === date2.getMonth() &&\n    date1.getDate() === date2.getDate()\n  );\n}\n\n// Typing indicator component\nfunction TypingIndicator() {\n  return (\n    <div className=\"flex items-center gap-1 px-4 py-2\" data-testid=\"indicator-typing\">\n      <div className=\"flex items-center gap-1 bg-muted rounded-2xl rounded-bl-sm px-4 py-2\">\n        <div className=\"flex gap-1\">\n          <span className=\"w-2 h-2 bg-muted-foreground/60 rounded-full animate-bounce\" style={{ animationDelay: \"0ms\" }} />\n          <span className=\"w-2 h-2 bg-muted-foreground/60 rounded-full animate-bounce\" style={{ animationDelay: \"150ms\" }} />\n          <span className=\"w-2 h-2 bg-muted-foreground/60 rounded-full animate-bounce\" style={{ animationDelay: \"300ms\" }} />\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// Empty state component for no conversations\nfunction EmptyConversationsState() {\n  return (\n    <div className=\"flex flex-col items-center justify-center h-full p-8 text-center\" data-testid=\"state-no-conversations\">\n      <div className=\"w-24 h-24 mb-6 rounded-full bg-muted flex items-center justify-center\">\n        <Users className=\"w-12 h-12 text-muted-foreground\" />\n      </div>\n      <h3 className=\"text-lg font-semibold mb-2\">No conversations yet</h3>\n      <p className=\"text-muted-foreground text-sm max-w-xs\">\n        Start chatting with sellers or buyers to see your conversations here\n      </p>\n    </div>\n  );\n}\n\n// Empty state component for no messages in conversation\nfunction EmptyMessagesState({ userName }: { userName?: string }) {\n  return (\n    <div className=\"flex flex-col items-center justify-center h-full p-8 text-center\" data-testid=\"state-no-messages\">\n      <div className=\"w-20 h-20 mb-6 rounded-full bg-muted flex items-center justify-center\">\n        <MessageCircle className=\"w-10 h-10 text-muted-foreground\" />\n      </div>\n      <h3 className=\"text-lg font-semibold mb-2\">Start the conversation</h3>\n      <p className=\"text-muted-foreground text-sm max-w-xs\">\n        Send a message to {userName || \"this user\"} to begin chatting\n      </p>\n    </div>\n  );\n}\n\n// Empty state component for no selected conversation\nfunction NoConversationSelectedState() {\n  return (\n    <div className=\"flex flex-col items-center justify-center h-full p-8 text-center\" data-testid=\"state-no-selection\">\n      <div className=\"w-24 h-24 mb-6 rounded-full bg-muted flex items-center justify-center\">\n        <MessageCircle className=\"w-12 h-12 text-muted-foreground\" />\n      </div>\n      <h3 className=\"text-lg font-semibold mb-2\">Select a conversation</h3>\n      <p className=\"text-muted-foreground text-sm max-w-xs\">\n        Choose a conversation from the list to start messaging\n      </p>\n    </div>\n  );\n}\n\n// Reaction picker component\nfunction ReactionPicker({ \n  onSelect, \n  onClose \n}: { \n  onSelect: (reaction: string) => void;\n  onClose: () => void;\n}) {\n  return (\n    <motion.div\n      initial={{ opacity: 0, scale: 0.8 }}\n      animate={{ opacity: 1, scale: 1 }}\n      exit={{ opacity: 0, scale: 0.8 }}\n      className=\"absolute z-50 bg-card border rounded-full shadow-lg p-2 flex items-center gap-1\"\n      data-testid=\"picker-reactions\"\n    >\n      {REACTION_OPTIONS.map((reaction) => {\n        const Icon = reaction.icon;\n        return (\n          <Button\n            key={reaction.id}\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"h-8 w-8 rounded-full\"\n            onClick={() => {\n              onSelect(reaction.id);\n              onClose();\n            }}\n            data-testid={`button-reaction-${reaction.id}`}\n          >\n            <Icon className=\"h-4 w-4\" />\n          </Button>\n        );\n      })}\n    </motion.div>\n  );\n}\n\n// Message reactions display component - memoized for performance\nconst MessageReactions = memo(function MessageReactions({ \n  reactions, \n  isOwn,\n  onReactionClick\n}: { \n  reactions: ReactionWithUser[];\n  isOwn: boolean;\n  onReactionClick: (reactionId: string) => void;\n}) {\n  if (!reactions || reactions.length === 0) return null;\n\n  // Group reactions by type - memoized internally\n  const groupedReactions = useMemo(() => {\n    return reactions.reduce((acc, r) => {\n      if (!acc[r.reaction]) acc[r.reaction] = [];\n      acc[r.reaction].push(r);\n      return acc;\n    }, {} as Record<string, ReactionWithUser[]>);\n  }, [reactions]);\n\n  return (\n    <div \n      className={`flex items-center gap-1 mt-1 ${isOwn ? \"justify-end\" : \"justify-start\"}`}\n      data-testid=\"container-reactions\"\n    >\n      {Object.entries(groupedReactions).map(([reactionId, users]) => {\n        const reactionInfo = REACTION_OPTIONS.find(r => r.id === reactionId);\n        if (!reactionInfo) return null;\n        const Icon = reactionInfo.icon;\n        \n        return (\n          <button\n            key={reactionId}\n            onClick={() => onReactionClick(reactionId)}\n            className=\"flex items-center gap-1 bg-muted/80 rounded-full px-2 py-0.5 text-xs hover-elevate\"\n            data-testid={`reaction-badge-${reactionId}`}\n          >\n            <Icon className=\"h-3 w-3\" />\n            <span>{users.length}</span>\n          </button>\n        );\n      })}\n    </div>\n  );\n});\n\n// Helper function to parse message content and extract Cloudinary URLs\nconst CLOUDINARY_URL_REGEX = /(https?:\\/\\/res\\.cloudinary\\.com\\/[^\\s]+)/g;\n\nfunction parseMessageContent(content: string): Array<{ type: 'text' | 'image'; value: string }> {\n  const parts: Array<{ type: 'text' | 'image'; value: string }> = [];\n  let lastIndex = 0;\n  let match;\n\n  while ((match = CLOUDINARY_URL_REGEX.exec(content)) !== null) {\n    // Add text before the URL\n    if (match.index > lastIndex) {\n      const text = content.substring(lastIndex, match.index).trim();\n      if (text) {\n        parts.push({ type: 'text', value: text });\n      }\n    }\n    // Add the Cloudinary URL as an image\n    parts.push({ type: 'image', value: match[1] });\n    lastIndex = match.index + match[0].length;\n  }\n\n  // Add any remaining text after the last URL\n  if (lastIndex < content.length) {\n    const text = content.substring(lastIndex).trim();\n    if (text) {\n      parts.push({ type: 'text', value: text });\n    }\n  }\n\n  // If no URLs found, return the original content as text\n  if (parts.length === 0 && content) {\n    parts.push({ type: 'text', value: content });\n  }\n\n  return parts;\n}\n\n// Chat bubble component with reactions and blue checkmarks - memoized for performance\nconst ChatBubble = memo(function ChatBubble({ \n  message, \n  isOwn, \n  showTail,\n  reactions,\n  onAddReaction,\n  onRemoveReaction,\n  currentUserId,\n  onImageClick\n}: { \n  message: Message; \n  isOwn: boolean; \n  showTail: boolean;\n  reactions?: ReactionWithUser[];\n  onAddReaction: (messageId: string, reaction: string) => void;\n  onRemoveReaction: (messageId: string) => void;\n  currentUserId?: string;\n  onImageClick?: (src: string) => void;\n}) {\n  const [showReactionPicker, setShowReactionPicker] = useState(false);\n  const longPressTimerRef = useRef<NodeJS.Timeout | null>(null);\n  \n  // Memoize the date formatting to avoid recalculation\n  const formattedTime = useMemo(() => {\n    const messageDate = new Date(message.createdAt!);\n    return messageDate.toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\n  }, [message.createdAt]);\n\n  // Memoize parsed content for inline images\n  const parsedContent = useMemo(() => {\n    if (!message.content) return [];\n    return parseMessageContent(message.content);\n  }, [message.content]);\n\n  const handleTouchStart = useCallback(() => {\n    longPressTimerRef.current = setTimeout(() => {\n      setShowReactionPicker(true);\n    }, 500);\n  }, []);\n\n  const handleTouchEnd = useCallback(() => {\n    if (longPressTimerRef.current) {\n      clearTimeout(longPressTimerRef.current);\n    }\n  }, []);\n\n  const handleContextMenu = useCallback((e: React.MouseEvent) => {\n    e.preventDefault();\n    setShowReactionPicker(true);\n  }, []);\n\n  const handleReactionSelect = useCallback((reaction: string) => {\n    onAddReaction(message.id, reaction);\n    setShowReactionPicker(false);\n  }, [message.id, onAddReaction]);\n\n  const handleReactionClick = useCallback((reactionId: string) => {\n    const userReaction = reactions?.find(r => r.userId === currentUserId && r.reaction === reactionId);\n    if (userReaction) {\n      onRemoveReaction(message.id);\n    } else {\n      onAddReaction(message.id, reactionId);\n    }\n  }, [reactions, currentUserId, message.id, onAddReaction, onRemoveReaction]);\n\n  const handleCloseReactionPicker = useCallback(() => {\n    setShowReactionPicker(false);\n  }, []);\n  \n  return (\n    <div\n      className={`flex ${isOwn ? \"justify-end\" : \"justify-start\"} mb-1 relative`}\n      data-testid={`message-${message.id}`}\n      onTouchStart={handleTouchStart}\n      onTouchEnd={handleTouchEnd}\n      onContextMenu={handleContextMenu}\n    >\n      <div className=\"relative\">\n        <div\n          className={`relative max-w-[75%] ${message.imageUrl ? 'p-1' : 'px-3 py-2'} ${\n            isOwn\n              ? `bg-primary text-primary-foreground ${showTail ? \"rounded-2xl rounded-br-sm\" : \"rounded-2xl\"}`\n              : `bg-muted ${showTail ? \"rounded-2xl rounded-bl-sm\" : \"rounded-2xl\"}`\n          }`}\n        >\n          {/* Image attachment */}\n          {message.imageUrl && (\n            <div className=\"mb-1\" data-testid={`image-attachment-${message.id}`}>\n              <img\n                src={message.imageUrl}\n                alt=\"Message attachment\"\n                className=\"max-w-[250px] max-h-[300px] rounded-xl object-cover cursor-pointer hover:opacity-90 transition-opacity\"\n                onClick={() => onImageClick?.(message.imageUrl!)}\n                loading=\"lazy\"\n              />\n            </div>\n          )}\n          \n          {/* Message content with inline Cloudinary images */}\n          {message.content && (\n            <div \n              className={`text-sm ${message.imageUrl ? 'px-2 pb-1' : ''}`}\n              data-testid={`text-message-content-${message.id}`}\n            >\n              {parsedContent.map((part, index) => {\n                if (part.type === 'image') {\n                  return (\n                    <img\n                      key={index}\n                      src={part.value}\n                      alt=\"Shared image\"\n                      className=\"max-w-[250px] max-h-[300px] rounded-xl object-cover cursor-pointer hover:opacity-90 transition-opacity my-1\"\n                      onClick={() => onImageClick?.(part.value)}\n                      loading=\"lazy\"\n                      data-testid={`inline-image-${message.id}-${index}`}\n                    />\n                  );\n                }\n                return (\n                  <p \n                    key={index} \n                    className=\"whitespace-pre-wrap break-words\"\n                  >\n                    {part.value}\n                  </p>\n                );\n              })}\n            </div>\n          )}\n          \n          {/* Timestamp and read status */}\n          <div className={`flex items-center gap-1 mt-1 ${message.imageUrl ? 'px-2' : ''} ${isOwn ? \"justify-end\" : \"justify-start\"}`}>\n            <span \n              className={`text-[10px] ${isOwn ? \"text-primary-foreground/70\" : \"text-muted-foreground\"}`}\n              data-testid={`text-message-time-${message.id}`}\n            >\n              {formattedTime}\n            </span>\n            \n            {/* Read receipts for sent messages - WhatsApp style blue checkmarks */}\n            {isOwn && (\n              <span data-testid={`status-message-read-${message.id}`}>\n                {message.isRead ? (\n                  <CheckCheck className=\"w-3.5 h-3.5 text-blue-400\" />\n                ) : (\n                  <Check className=\"w-3.5 h-3.5 text-primary-foreground/70\" />\n                )}\n              </span>\n            )}\n          </div>\n          \n          {/* Tail indicator */}\n          {showTail && (\n            <div\n              className={`absolute bottom-0 w-3 h-3 ${\n                isOwn\n                  ? \"right-0 translate-x-1/2 bg-primary\"\n                  : \"left-0 -translate-x-1/2 bg-muted\"\n              }`}\n              style={{\n                clipPath: isOwn\n                  ? \"polygon(0 0, 100% 0, 0 100%)\"\n                  : \"polygon(100% 0, 0 0, 100% 100%)\",\n              }}\n            />\n          )}\n        </div>\n        \n        {/* Reactions display */}\n        {reactions && reactions.length > 0 && (\n          <MessageReactions \n            reactions={reactions} \n            isOwn={isOwn}\n            onReactionClick={handleReactionClick}\n          />\n        )}\n        \n        {/* Reaction picker popup */}\n        <AnimatePresence>\n          {showReactionPicker && (\n            <>\n              <div \n                className=\"fixed inset-0 z-40\" \n                onClick={handleCloseReactionPicker}\n              />\n              <div className={`absolute ${isOwn ? \"right-0\" : \"left-0\"} -top-12 z-50`}>\n                <ReactionPicker \n                  onSelect={handleReactionSelect}\n                  onClose={handleCloseReactionPicker}\n                />\n              </div>\n            </>\n          )}\n        </AnimatePresence>\n      </div>\n    </div>\n  );\n});\n\n// Date separator component\nfunction DateSeparator({ date }: { date: Date }) {\n  return (\n    <div className=\"flex items-center justify-center my-4\" data-testid=\"separator-date\">\n      <div className=\"bg-muted text-muted-foreground text-xs px-3 py-1 rounded-full\">\n        {formatDateSeparator(date)}\n      </div>\n    </div>\n  );\n}\n\n// Swipeable thread item component - memoized for performance\nconst ThreadItem = memo(function ThreadItem({\n  thread,\n  isSelected,\n  onClick,\n  isOnline,\n  onArchive,\n  isArchived = false,\n}: {\n  thread: ChatThread;\n  isSelected: boolean;\n  onClick: () => void;\n  isOnline: boolean;\n  onArchive: () => void;\n  isArchived?: boolean;\n}) {\n  const x = useMotionValue(0);\n  const archiveOpacity = useTransform(x, [-100, -50, 0], [1, 0.5, 0]);\n  \n  // Check if this is a system/official account (always online)\n  const isSystemAccount = thread.user.isSystemAccount === true;\n  const effectiveOnline = isSystemAccount ? true : isOnline;\n  \n  // Memoize time formatting\n  const lastMessageTime = useMemo(() => {\n    return thread.lastMessage?.createdAt\n      ? formatRelativeTime(new Date(thread.lastMessage.createdAt))\n      : null;\n  }, [thread.lastMessage?.createdAt]);\n\n  const handleDragEnd = useCallback(() => {\n    if (x.get() < -80) {\n      onArchive();\n    }\n  }, [x, onArchive]);\n\n  return (\n    <motion.div \n      className=\"relative overflow-hidden\"\n      data-testid={`thread-${thread.user.id}`}\n    >\n      {/* Archive indicator behind the thread item */}\n      <motion.div \n        className=\"absolute inset-0 flex items-center justify-end pr-6 bg-destructive\"\n        style={{ opacity: archiveOpacity }}\n      >\n        <div className=\"flex flex-col items-center gap-1\">\n          {isArchived ? (\n            <ArchiveRestore className=\"w-6 h-6 text-destructive-foreground\" />\n          ) : (\n            <Archive className=\"w-6 h-6 text-destructive-foreground\" />\n          )}\n          <span className=\"text-xs text-destructive-foreground font-medium\">\n            {isArchived ? \"Unarchive\" : \"Archive\"}\n          </span>\n        </div>\n      </motion.div>\n      \n      <motion.button\n        onClick={onClick}\n        className={`w-full p-4 hover-elevate text-left transition-all duration-200 ${\n          isSelected ? \"bg-accent\" : \"bg-background\"\n        } ${isSystemAccount ? \"border-l-2 border-l-yellow-500/50\" : \"\"}`}\n        style={{ x }}\n        drag=\"x\"\n        dragConstraints={{ left: -100, right: 0 }}\n        dragElastic={0.2}\n        onDragEnd={handleDragEnd}\n      >\n        <div className=\"flex items-center gap-3\">\n          {/* Avatar with online indicator */}\n          <div className=\"relative\">\n            <Avatar className={isSystemAccount ? \"ring-2 ring-yellow-500/50\" : \"\"}>\n              <AvatarImage src={thread.user.profileImageUrl || undefined} loading=\"lazy\" />\n              <AvatarFallback className={isSystemAccount ? \"bg-gradient-to-br from-yellow-500/30 to-amber-400/20\" : \"\"}>\n                {thread.user.firstName?.[0] || thread.user.email?.[0]}\n              </AvatarFallback>\n            </Avatar>\n            {/* Online/Offline indicator - System accounts always show online */}\n            <span\n              className={`absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-background ${\n                effectiveOnline ? \"bg-green-500\" : \"bg-muted-foreground/50\"\n              }`}\n              data-testid={`status-online-${thread.user.id}`}\n            />\n          </div>\n          \n          <div className=\"flex-1 min-w-0\">\n            <div className=\"flex items-center justify-between gap-2\">\n              <div className=\"flex items-center gap-1.5 min-w-0\">\n                <p className=\"font-medium truncate\" data-testid={`text-thread-name-${thread.user.id}`}>\n                  {thread.user.firstName || thread.user.email}\n                </p>\n                {isSystemAccount && (\n                  <CheckCircle \n                    className=\"h-4 w-4 text-yellow-500 shrink-0\" \n                    data-testid={`badge-verified-${thread.user.id}`}\n                  />\n                )}\n              </div>\n              <div className=\"flex items-center gap-2 shrink-0\">\n                {lastMessageTime && (\n                  <span \n                    className=\"text-xs text-muted-foreground\"\n                    data-testid={`text-thread-time-${thread.user.id}`}\n                  >\n                    {lastMessageTime}\n                  </span>\n                )}\n                {thread.unreadCount > 0 && (\n                  <Badge \n                    variant=\"default\" \n                    className=\"min-w-[20px] h-5 flex items-center justify-center text-xs animate-pulse\"\n                    data-testid={`badge-unread-${thread.user.id}`}\n                  >\n                    {thread.unreadCount}\n                  </Badge>\n                )}\n              </div>\n            </div>\n            {thread.lastMessage && (\n              <p \n                className=\"text-sm text-muted-foreground truncate mt-0.5\"\n                data-testid={`text-thread-preview-${thread.user.id}`}\n              >\n                {thread.lastMessage.content}\n              </p>\n            )}\n          </div>\n        </div>\n      </motion.button>\n    </motion.div>\n  );\n});\n\n// Emoji picker component\nfunction EmojiPicker({ onSelect }: { onSelect: (emoji: string) => void }) {\n  return (\n    <div className=\"grid gap-2\" data-testid=\"picker-emoji\">\n      {EMOJI_CATEGORIES.map((category) => (\n        <div key={category.name}>\n          <p className=\"text-xs text-muted-foreground mb-1\">{category.name}</p>\n          <div className=\"grid grid-cols-6 gap-1\">\n            {category.emojis.map((emoji) => (\n              <button\n                key={emoji}\n                onClick={() => onSelect(emoji)}\n                className=\"w-8 h-8 flex items-center justify-center text-lg hover-elevate rounded\"\n                data-testid={`button-emoji-${emoji}`}\n              >\n                {emoji}\n              </button>\n            ))}\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n}\n\n// Disappearing messages settings component\nfunction DisappearingMessagesSettings({\n  userId,\n  currentSetting,\n  onUpdate\n}: {\n  userId: string;\n  currentSetting?: DisappearingMessageSetting;\n  onUpdate: (duration: number) => void;\n}) {\n  const currentValue = currentSetting?.duration?.toString() || \"0\";\n  \n  return (\n    <div className=\"flex items-center justify-between gap-2 p-3 bg-muted/50 rounded-lg\" data-testid=\"settings-disappearing\">\n      <div className=\"flex items-center gap-2\">\n        <Timer className=\"h-4 w-4 text-muted-foreground\" />\n        <div>\n          <p className=\"text-sm font-medium\">Disappearing messages</p>\n          <p className=\"text-xs text-muted-foreground\">Messages will auto-delete</p>\n        </div>\n      </div>\n      <Select \n        value={currentValue} \n        onValueChange={(val) => onUpdate(parseInt(val))}\n      >\n        <SelectTrigger className=\"w-[120px]\" data-testid=\"select-disappearing-duration\">\n          <SelectValue />\n        </SelectTrigger>\n        <SelectContent>\n          {DISAPPEARING_DURATIONS.map((option) => (\n            <SelectItem key={option.value} value={option.value}>\n              {option.label}\n            </SelectItem>\n          ))}\n        </SelectContent>\n      </Select>\n    </div>\n  );\n}\n\nexport default function Messages() {\n  const { user: currentUser } = useAuth();\n  const { toast } = useToast();\n  const { userId: urlUserId } = useParams<{ userId?: string }>();\n  const search = useSearch();\n  const searchParams = new URLSearchParams(search);\n  const queryUserId = searchParams.get(\"user\");\n  // Support both URL param (/messages/:userId or /chat/:userId) and query param (?user=...)\n  const preselectedUserId = urlUserId || queryUserId;\n  const isMobile = useIsMobile();\n  const [, navigate] = useLocation();\n  \n  const [selectedUser, setSelectedUser] = useState<string | null>(null);\n  const [pendingUserId, setPendingUserId] = useState<string | null>(null);\n  const [showSafetyModal, setShowSafetyModal] = useState(false);\n  const [messageContent, setMessageContent] = useState(\"\");\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [filePreview, setFilePreview] = useState<string | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n  const [wsStatus, setWsStatus] = useState<WebSocketStatus>(\"disconnected\");\n  const [isTyping, setIsTyping] = useState(false);\n  const [showMobileChat, setShowMobileChat] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [onlineUserIds, setOnlineUserIds] = useState<Set<string>>(new Set());\n  const [showArchivedSection, setShowArchivedSection] = useState(false);\n  const [showConversationSettings, setShowConversationSettings] = useState(false);\n  const [messageReactionsMap, setMessageReactionsMap] = useState<Record<string, ReactionWithUser[]>>({});\n  \n  const { isOpen: lightboxOpen, currentImage, openLightbox, closeLightbox } = useLightbox();\n  \n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const wsRef = useRef<WebSocket | null>(null);\n  const reconnectAttemptRef = useRef(0);\n  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const pollingIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  \n  // Focus tracking refs for mobile keyboard retention\n  const isTextareaFocusedRef = useRef(false);\n  const shouldRestoreFocusRef = useRef(false);\n  const contentRef = useRef(\"\");\n\n  useEffect(() => {\n    if (preselectedUserId) {\n      if (hasSafetyBeenAcknowledged(preselectedUserId)) {\n        setSelectedUser(preselectedUserId);\n        setShowMobileChat(true);\n      } else {\n        setPendingUserId(preselectedUserId);\n        setShowSafetyModal(true);\n      }\n    }\n  }, [preselectedUserId]);\n\n  // State for message pagination - show limited messages initially\n  const [displayedMessageCount, setDisplayedMessageCount] = useState(INITIAL_MESSAGE_LIMIT);\n  const [isLoadingMore, setIsLoadingMore] = useState(false);\n\n  // Fetch chat threads with caching optimization\n  const { data: threads, isLoading: threadsLoading } = useQuery<ChatThread[]>({\n    queryKey: [\"/api/messages/threads\"],\n    staleTime: 30000, // Cache for 30 seconds\n  });\n\n  // Fetch messages for selected user with caching\n  const { data: messages, isLoading: messagesLoading } = useQuery<Message[]>({\n    queryKey: [\"/api/messages\", selectedUser],\n    enabled: !!selectedUser,\n    staleTime: 10000, // Cache for 10 seconds\n  });\n\n  // Fetch archived conversations with longer cache\n  const { data: archivedConversations, isLoading: archivedLoading } = useQuery<(ArchivedConversation & { otherUser: User })[]>({\n    queryKey: [\"/api/conversations/archived\"],\n    staleTime: 60000, // Cache for 1 minute - archives change infrequently\n  });\n\n  // Fetch disappearing message settings for current conversation\n  const { data: disappearingSettings } = useQuery<DisappearingMessageSetting>({\n    queryKey: [\"/api/conversations\", selectedUser, \"disappearing\"],\n    enabled: !!selectedUser,\n    staleTime: 60000, // Cache for 1 minute\n  });\n\n  // Fetch initial online status with appropriate caching\n  const { data: onlineStatusData } = useQuery<{ onlineUserIds: string[] }>({\n    queryKey: [\"/api/users/online-status\"],\n    refetchInterval: 30000, // Refetch every 30 seconds as backup\n    staleTime: 15000, // Cache for 15 seconds\n  });\n\n  // Fetch reactions for visible messages only (performance optimization)\n  // Only fetch for the most recent messages to reduce API calls\n  useEffect(() => {\n    if (messages && messages.length > 0) {\n      // Only fetch reactions for displayed messages (not all)\n      const visibleMessages = messages.slice(-displayedMessageCount);\n      \n      // Batch fetch reactions using Promise.all for better performance\n      const fetchReactions = async () => {\n        const reactionsPromises = visibleMessages.map(async (message) => {\n          try {\n            const response = await fetch(`/api/messages/${message.id}/reactions`, {\n              credentials: 'include'\n            });\n            if (response.ok) {\n              const reactions = await response.json();\n              return { messageId: message.id, reactions };\n            }\n          } catch (error) {\n            // Silently fail for individual reaction fetches\n          }\n          return { messageId: message.id, reactions: [] };\n        });\n\n        const results = await Promise.all(reactionsPromises);\n        const reactionsMap: Record<string, ReactionWithUser[]> = {};\n        results.forEach(({ messageId, reactions }) => {\n          if (reactions && reactions.length > 0) {\n            reactionsMap[messageId] = reactions;\n          }\n        });\n        setMessageReactionsMap(reactionsMap);\n      };\n      fetchReactions();\n    }\n  }, [messages, displayedMessageCount]);\n\n  // Reset displayed message count when switching conversations\n  useEffect(() => {\n    setDisplayedMessageCount(INITIAL_MESSAGE_LIMIT);\n  }, [selectedUser]);\n\n  // Update onlineUserIds when API data changes\n  useEffect(() => {\n    if (onlineStatusData?.onlineUserIds) {\n      setOnlineUserIds(new Set(onlineStatusData.onlineUserIds));\n    }\n  }, [onlineStatusData]);\n\n  // Add reaction mutation\n  const addReactionMutation = useMutation({\n    mutationFn: async ({ messageId, reaction }: { messageId: string; reaction: string }) => {\n      return await apiRequest(\"POST\", `/api/messages/${messageId}/reactions`, { reaction });\n    },\n    onSuccess: (_, { messageId }) => {\n      // Refetch reactions for this message\n      fetch(`/api/messages/${messageId}/reactions`, { credentials: 'include' })\n        .then(res => res.json())\n        .then(reactions => {\n          setMessageReactionsMap(prev => ({ ...prev, [messageId]: reactions }));\n        });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to add reaction\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Remove reaction mutation\n  const removeReactionMutation = useMutation({\n    mutationFn: async (messageId: string) => {\n      return await apiRequest(\"DELETE\", `/api/messages/${messageId}/reactions`);\n    },\n    onSuccess: (_, messageId) => {\n      // Refetch reactions for this message\n      fetch(`/api/messages/${messageId}/reactions`, { credentials: 'include' })\n        .then(res => res.json())\n        .then(reactions => {\n          setMessageReactionsMap(prev => ({ ...prev, [messageId]: reactions }));\n        });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to remove reaction\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Archive conversation mutation\n  const archiveMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      return await apiRequest(\"POST\", `/api/conversations/${userId}/archive`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/conversations/archived\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/messages/threads\"] });\n      toast({\n        title: \"Archived\",\n        description: \"Conversation archived successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to archive conversation\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Unarchive conversation mutation\n  const unarchiveMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      return await apiRequest(\"DELETE\", `/api/conversations/${userId}/archive`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/conversations/archived\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/messages/threads\"] });\n      toast({\n        title: \"Unarchived\",\n        description: \"Conversation restored successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to unarchive conversation\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Set disappearing messages mutation\n  const setDisappearingMutation = useMutation({\n    mutationFn: async ({ userId, duration }: { userId: string; duration: number }) => {\n      return await apiRequest(\"POST\", `/api/conversations/${userId}/disappearing`, { duration });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/conversations\", selectedUser, \"disappearing\"] });\n      toast({\n        title: \"Settings updated\",\n        description: \"Disappearing messages setting saved\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update disappearing messages setting\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Send message mutation with optimistic update\n  const sendMutation = useMutation({\n    mutationFn: async ({ content, file }: { content: string; file?: File | null }) => {\n      // If there's a file, use the attachment route with FormData\n      if (file) {\n        setIsUploading(true);\n        const formData = new FormData();\n        formData.append(\"attachment\", file);\n        formData.append(\"receiverId\", selectedUser || \"\");\n        formData.append(\"content\", content);\n\n        const response = await fetch(\"/api/messages/with-attachment\", {\n          method: \"POST\",\n          body: formData,\n          credentials: \"include\",\n        });\n\n        if (!response.ok) {\n          const error = await response.json();\n          throw new Error(error.message || \"Failed to send message\");\n        }\n\n        return await response.json();\n      }\n\n      // No file - use WebSocket if connected, or regular API\n      if (wsStatus === \"connected\" && wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\n        wsRef.current.send(JSON.stringify({\n          type: \"message\",\n          receiverId: selectedUser,\n          content,\n        }));\n        return { success: true, viaWebSocket: true };\n      }\n\n      return await apiRequest(\"POST\", \"/api/messages\", {\n        receiverId: selectedUser,\n        content,\n      });\n    },\n    onMutate: async ({ content, file }) => {\n      await queryClient.cancelQueries({ queryKey: [\"/api/messages\", selectedUser] });\n\n      const previousMessages = queryClient.getQueryData<Message[]>([\"/api/messages\", selectedUser]);\n\n      const optimisticMessage: Message = {\n        id: `temp-${Date.now()}`,\n        senderId: currentUser?.id || \"\",\n        receiverId: selectedUser || \"\",\n        content: file ? (content || \"[Image]\") : content,\n        imageUrl: file ? filePreview : null,\n        isRead: false,\n        createdAt: new Date(),\n        productId: null,\n      };\n\n      queryClient.setQueryData<Message[]>(\n        [\"/api/messages\", selectedUser],\n        (old) => [...(old || []), optimisticMessage]\n      );\n\n      return { previousMessages, optimisticMessage };\n    },\n    onSuccess: (data, _, context) => {\n      setMessageContent(\"\");\n      setSelectedFile(null);\n      setFilePreview(null);\n      setIsUploading(false);\n      contentRef.current = \"\";\n      \n      if (textareaRef.current) {\n        textareaRef.current.style.height = \"auto\";\n        \n        // Restore focus after sending on mobile to keep keyboard open\n        if (isMobile) {\n          // Use multiple techniques to ensure focus is maintained\n          requestAnimationFrame(() => {\n            textareaRef.current?.focus();\n            // Also try after a short delay for slower devices\n            setTimeout(() => {\n              textareaRef.current?.focus();\n            }, 50);\n          });\n        }\n      }\n\n      if (!(data as any)?.viaWebSocket) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/messages\", selectedUser] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/messages/threads\"] });\n      }\n    },\n    onError: (error, _, context) => {\n      setIsUploading(false);\n      if (context?.previousMessages) {\n        queryClient.setQueryData([\"/api/messages\", selectedUser], context.previousMessages);\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to send message\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Helper function to append a message to the messages cache\n  const appendMessageToCache = useCallback((newMessage: Message, isOwnMessage: boolean = false) => {\n    const conversationUserId = newMessage.senderId === currentUser?.id \n      ? newMessage.receiverId \n      : newMessage.senderId;\n    \n    queryClient.setQueryData<Message[]>(\n      [\"/api/messages\", conversationUserId],\n      (oldMessages) => {\n        if (!oldMessages) return [newMessage];\n        \n        // Check if this exact message already exists\n        const existingIndex = oldMessages.findIndex(m => m.id === newMessage.id);\n        if (existingIndex >= 0) return oldMessages;\n        \n        // If this is our own sent message, replace any temp messages with matching content\n        if (isOwnMessage) {\n          const tempIndex = oldMessages.findIndex(\n            m => m.id.startsWith('temp-') && \n                 m.content === newMessage.content && \n                 m.senderId === newMessage.senderId\n          );\n          if (tempIndex >= 0) {\n            const updated = [...oldMessages];\n            updated[tempIndex] = newMessage;\n            return updated;\n          }\n        }\n        \n        return [...oldMessages, newMessage];\n      }\n    );\n\n    queryClient.invalidateQueries({ queryKey: [\"/api/messages/threads\"] });\n  }, [currentUser?.id]);\n\n  // WebSocket connection with proper JWT authentication and reconnection\n  useEffect(() => {\n    if (!currentUser) return;\n\n    const MAX_RECONNECT_ATTEMPTS = 10;\n    const BASE_RECONNECT_DELAY = 1000;\n\n    const connectWebSocket = async () => {\n      try {\n        setWsStatus(\"connecting\");\n\n        const tokenResponse = await fetch(\"/api/auth/ws-token\", {\n          credentials: \"include\",\n        });\n\n        if (!tokenResponse.ok) {\n          console.error(\"Failed to get WebSocket token\");\n          setWsStatus(\"error\");\n          scheduleReconnect();\n          return;\n        }\n\n        const { token } = await tokenResponse.json();\n\n        const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n        const wsUrl = `${protocol}//${window.location.host}/ws`;\n        const socket = new WebSocket(wsUrl);\n\n        socket.onopen = () => {\n          console.log(\"WebSocket connection opened, authenticating...\");\n          socket.send(JSON.stringify({ type: \"auth\", token }));\n        };\n\n        socket.onmessage = (event) => {\n          try {\n            const data = JSON.parse(event.data);\n\n            if (data.type === \"auth_success\") {\n              console.log(\"WebSocket authenticated successfully\");\n              setWsStatus(\"connected\");\n              reconnectAttemptRef.current = 0;\n            }\n\n            if (data.type === \"auth_error\") {\n              console.error(\"WebSocket auth error:\", data.message);\n              setWsStatus(\"error\");\n              socket.close();\n              scheduleReconnect();\n              return;\n            }\n\n            if (data.type === \"new_message\" && data.message) {\n              console.log(\"Received new message via WebSocket:\", data.message.id);\n              appendMessageToCache(data.message, false);\n            }\n\n            if (data.type === \"message_sent\" && data.message) {\n              console.log(\"Message sent confirmation:\", data.message.id);\n              appendMessageToCache(data.message, true);\n            }\n\n            if (data.type === \"typing\" && data.userId === selectedUser) {\n              setIsTyping(true);\n              if (typingTimeoutRef.current) {\n                clearTimeout(typingTimeoutRef.current);\n              }\n              typingTimeoutRef.current = setTimeout(() => setIsTyping(false), 3000);\n            }\n\n            // Handle user online/offline status changes\n            if (data.type === \"user_status_change\") {\n              console.log(`User ${data.userId} is now ${data.isOnline ? \"online\" : \"offline\"}`);\n              setOnlineUserIds((prev) => {\n                const updated = new Set(prev);\n                if (data.isOnline) {\n                  updated.add(data.userId);\n                } else {\n                  updated.delete(data.userId);\n                }\n                return updated;\n              });\n            }\n          } catch (error) {\n            console.error(\"Error parsing WebSocket message:\", error);\n          }\n        };\n\n        socket.onclose = (event) => {\n          console.log(\"WebSocket closed:\", event.code, event.reason);\n          setWsStatus(\"disconnected\");\n          wsRef.current = null;\n\n          if (event.code !== 1000) {\n            scheduleReconnect();\n          }\n        };\n\n        socket.onerror = (error) => {\n          console.error(\"WebSocket error:\", error);\n          setWsStatus(\"error\");\n        };\n\n        wsRef.current = socket;\n      } catch (error) {\n        console.error(\"Failed to connect WebSocket:\", error);\n        setWsStatus(\"error\");\n        scheduleReconnect();\n      }\n    };\n\n    const scheduleReconnect = () => {\n      if (reconnectAttemptRef.current >= MAX_RECONNECT_ATTEMPTS) {\n        console.log(\"Max reconnection attempts reached, stopping reconnection\");\n        return;\n      }\n\n      const delay = Math.min(\n        BASE_RECONNECT_DELAY * Math.pow(2, reconnectAttemptRef.current),\n        30000\n      );\n      \n      console.log(`Scheduling reconnection attempt ${reconnectAttemptRef.current + 1} in ${delay}ms`);\n      \n      if (reconnectTimeoutRef.current) {\n        clearTimeout(reconnectTimeoutRef.current);\n      }\n\n      reconnectTimeoutRef.current = setTimeout(() => {\n        reconnectAttemptRef.current++;\n        connectWebSocket();\n      }, delay);\n    };\n\n    connectWebSocket();\n\n    return () => {\n      if (wsRef.current) {\n        wsRef.current.close(1000, \"Component unmounting\");\n        wsRef.current = null;\n      }\n      if (reconnectTimeoutRef.current) {\n        clearTimeout(reconnectTimeoutRef.current);\n      }\n      if (typingTimeoutRef.current) {\n        clearTimeout(typingTimeoutRef.current);\n      }\n    };\n  }, [currentUser, selectedUser, appendMessageToCache]);\n\n  // Polling fallback - refetch messages every 5 seconds as backup\n  useEffect(() => {\n    if (!selectedUser) return;\n\n    pollingIntervalRef.current = setInterval(() => {\n      if (wsStatus !== \"connected\") {\n        console.log(\"WebSocket not connected, polling for messages...\");\n        queryClient.invalidateQueries({ queryKey: [\"/api/messages\", selectedUser] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/messages/threads\"] });\n      }\n    }, 5000);\n\n    return () => {\n      if (pollingIntervalRef.current) {\n        clearInterval(pollingIntervalRef.current);\n      }\n    };\n  }, [selectedUser, wsStatus]);\n\n  // Scroll to bottom when messages change - with mobile keyboard awareness\n  useEffect(() => {\n    // On mobile, only scroll if textarea is not focused to avoid keyboard dismissal\n    if (isMobile && isTextareaFocusedRef.current) {\n      // Use a gentler scroll that doesn't interfere with keyboard\n      requestAnimationFrame(() => {\n        messagesEndRef.current?.scrollIntoView({ behavior: \"auto\", block: \"end\" });\n      });\n    } else {\n      messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n    }\n  }, [messages, isTyping, isMobile]);\n\n  // Auto-resize textarea - optimized to prevent focus loss\n  const handleTextareaChange = useCallback((e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    const value = e.target.value;\n    contentRef.current = value;\n    \n    // Update state without losing focus by using functional update\n    setMessageContent(value);\n    \n    // Auto-resize logic - directly modify DOM to avoid re-render\n    const textarea = e.target;\n    textarea.style.height = \"auto\";\n    textarea.style.height = `${Math.min(textarea.scrollHeight, 120)}px`;\n  }, []);\n  \n  // Focus retention effect - restore focus after state updates if needed\n  useEffect(() => {\n    if (shouldRestoreFocusRef.current && textareaRef.current) {\n      // Use requestAnimationFrame to ensure DOM is ready\n      requestAnimationFrame(() => {\n        textareaRef.current?.focus();\n        shouldRestoreFocusRef.current = false;\n      });\n    }\n  }, [messageContent]);\n\n  const handleSend = useCallback((e: React.FormEvent) => {\n    e.preventDefault();\n    if ((!messageContent.trim() && !selectedFile) || !selectedUser) return;\n    \n    // Mark that we should restore focus after sending\n    shouldRestoreFocusRef.current = true;\n    \n    sendMutation.mutate({ content: messageContent, file: selectedFile });\n    \n    // Immediately refocus on mobile to keep keyboard open\n    if (isMobile && textareaRef.current) {\n      // Use setTimeout to refocus after state update\n      setTimeout(() => {\n        textareaRef.current?.focus();\n      }, 0);\n    }\n  }, [messageContent, selectedFile, selectedUser, isMobile, sendMutation]);\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      // Validate file size (5MB limit)\n      if (file.size > 5 * 1024 * 1024) {\n        toast({\n          title: \"File too large\",\n          description: \"Please select a file under 5MB\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      // Validate file type - only images for now\n      if (!file.type.startsWith(\"image/\")) {\n        toast({\n          title: \"Invalid file type\",\n          description: \"Only images are supported for now\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      setSelectedFile(file);\n      \n      // Create preview URL\n      const previewUrl = URL.createObjectURL(file);\n      setFilePreview(previewUrl);\n    }\n    // Reset the input so the same file can be selected again\n    e.target.value = \"\";\n  };\n\n  const handleRemoveFile = () => {\n    setSelectedFile(null);\n    if (filePreview) {\n      URL.revokeObjectURL(filePreview);\n      setFilePreview(null);\n    }\n  };\n\n  const handleKeyDown = useCallback((e: React.KeyboardEvent<HTMLTextAreaElement>) => {\n    // Only handle Enter key for sending\n    if (e.key === \"Enter\" && !e.shiftKey) {\n      e.preventDefault();\n      e.stopPropagation();\n      handleSend(e);\n      \n      // Ensure focus is maintained after Enter key on mobile\n      if (isMobile) {\n        e.currentTarget.focus();\n      }\n    }\n  }, [handleSend, isMobile]);\n\n  const handleSelectThread = (userId: string) => {\n    if (hasSafetyBeenAcknowledged(userId)) {\n      setSelectedUser(userId);\n      if (isMobile) {\n        setShowMobileChat(true);\n      }\n    } else {\n      setPendingUserId(userId);\n      setShowSafetyModal(true);\n    }\n  };\n\n  const handleSafetyAcknowledge = () => {\n    if (pendingUserId) {\n      setSelectedUser(pendingUserId);\n      if (isMobile) {\n        setShowMobileChat(true);\n      }\n      setPendingUserId(null);\n    }\n  };\n\n  const handleBackToList = () => {\n    setShowMobileChat(false);\n  };\n\n  const handleEmojiSelect = useCallback((emoji: string) => {\n    setMessageContent((prev) => prev + emoji);\n    contentRef.current = contentRef.current + emoji;\n    \n    // Immediately refocus after emoji selection\n    if (textareaRef.current) {\n      textareaRef.current.focus();\n      // On mobile, use additional techniques to ensure focus\n      if (isMobile) {\n        requestAnimationFrame(() => {\n          textareaRef.current?.focus();\n        });\n      }\n    }\n  }, [isMobile]);\n\n  const handleArchiveConversation = (userId: string) => {\n    archiveMutation.mutate(userId);\n  };\n\n  const handleUnarchiveConversation = (userId: string) => {\n    unarchiveMutation.mutate(userId);\n  };\n\n  const handleAddReaction = (messageId: string, reaction: string) => {\n    addReactionMutation.mutate({ messageId, reaction });\n  };\n\n  const handleRemoveReaction = (messageId: string) => {\n    removeReactionMutation.mutate(messageId);\n  };\n\n  const handleDisappearingUpdate = (duration: number) => {\n    if (selectedUser) {\n      setDisappearingMutation.mutate({ userId: selectedUser, duration });\n    }\n  };\n\n  const selectedThread = threads?.find((t) => t.user.id === selectedUser);\n\n  // Memoize archived user IDs set for better performance\n  const archivedUserIds = useMemo(() => {\n    return new Set(archivedConversations?.map(a => a.otherUserId) || []);\n  }, [archivedConversations]);\n\n  // Memoize filtered threads to avoid recalculation on every render\n  const filteredThreads = useMemo(() => {\n    return threads?.filter((thread) => {\n      const name = thread.user.firstName || thread.user.email || \"\";\n      const matchesSearch = name.toLowerCase().includes(searchQuery.toLowerCase());\n      const notArchived = !archivedUserIds.has(thread.user.id);\n      return matchesSearch && notArchived;\n    });\n  }, [threads, searchQuery, archivedUserIds]);\n\n  // Calculate if there are more messages to load\n  const hasMoreMessages = useMemo(() => {\n    return messages ? messages.length > displayedMessageCount : false;\n  }, [messages, displayedMessageCount]);\n\n  // Get paginated messages (most recent ones)\n  const paginatedMessages = useMemo(() => {\n    if (!messages) return [];\n    // If we have more messages than displayed, slice from the end\n    if (messages.length > displayedMessageCount) {\n      return messages.slice(messages.length - displayedMessageCount);\n    }\n    return messages;\n  }, [messages, displayedMessageCount]);\n\n  // Handler to load more messages\n  const handleLoadMoreMessages = useCallback(() => {\n    setIsLoadingMore(true);\n    // Simulate a small delay for UX, then load more\n    setTimeout(() => {\n      setDisplayedMessageCount(prev => prev + INITIAL_MESSAGE_LIMIT);\n      setIsLoadingMore(false);\n    }, 200);\n  }, []);\n\n  // Memoize grouped messages - expensive computation for large message lists\n  const groupedMessages = useMemo(() => {\n    return paginatedMessages.reduce((acc, msg, index, arr) => {\n      const msgDate = new Date(msg.createdAt!);\n      const prevMsg = arr[index - 1];\n      const prevDate = prevMsg ? new Date(prevMsg.createdAt!) : null;\n\n      // Add date separator if it's a new day\n      if (!prevDate || !isSameDay(msgDate, prevDate)) {\n        acc.push({ type: \"separator\" as const, date: msgDate });\n      }\n\n      // Determine if this message should show a tail\n      const nextMsg = arr[index + 1];\n      const showTail = !nextMsg || \n        nextMsg.senderId !== msg.senderId ||\n        !isSameDay(new Date(nextMsg.createdAt!), msgDate);\n\n      acc.push({ type: \"message\" as const, message: msg, showTail });\n      return acc;\n    }, [] as Array<{ type: \"separator\"; date: Date } | { type: \"message\"; message: Message; showTail: boolean }>);\n  }, [paginatedMessages]);\n\n  // Thread list content\n  const ThreadListContent = (\n    <div className=\"flex flex-col h-full min-h-0 overflow-hidden\">\n      {/* Header */}\n      <div className=\"p-4 border-b\">\n        <h2 className=\"font-semibold text-lg mb-3\" data-testid=\"text-messages-title\">Messages</h2>\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n          <Input\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            placeholder=\"Search conversations...\"\n            className=\"pl-9\"\n            data-testid=\"input-search-threads\"\n          />\n        </div>\n      </div>\n      \n      {/* Thread list */}\n      <div className=\"flex-1 overflow-y-auto\">\n        {threadsLoading ? (\n          <div className=\"p-4 space-y-4\">\n            {[...Array(5)].map((_, i) => (\n              <div key={i} className=\"flex items-center gap-3\">\n                <Skeleton className=\"h-12 w-12 rounded-full\" />\n                <div className=\"flex-1\">\n                  <Skeleton className=\"h-4 w-32 mb-2\" />\n                  <Skeleton className=\"h-3 w-48\" />\n                </div>\n              </div>\n            ))}\n          </div>\n        ) : filteredThreads && filteredThreads.length > 0 ? (\n          <div className=\"divide-y\">\n            {filteredThreads.map((thread) => (\n              <ThreadItem\n                key={thread.user.id}\n                thread={thread}\n                isSelected={selectedUser === thread.user.id}\n                onClick={() => handleSelectThread(thread.user.id)}\n                isOnline={onlineUserIds.has(thread.user.id)}\n                onArchive={() => handleArchiveConversation(thread.user.id)}\n              />\n            ))}\n          </div>\n        ) : (\n          <EmptyConversationsState />\n        )}\n\n        {/* Archived conversations section */}\n        {archivedConversations && archivedConversations.length > 0 && (\n          <div className=\"border-t\">\n            <button\n              onClick={() => setShowArchivedSection(!showArchivedSection)}\n              className=\"w-full p-4 flex items-center justify-between text-sm text-muted-foreground hover-elevate\"\n              data-testid=\"button-toggle-archived\"\n            >\n              <div className=\"flex items-center gap-2\">\n                <Archive className=\"h-4 w-4\" />\n                <span>Archived ({archivedConversations.length})</span>\n              </div>\n              {showArchivedSection ? (\n                <ChevronUp className=\"h-4 w-4\" />\n              ) : (\n                <ChevronDown className=\"h-4 w-4\" />\n              )}\n            </button>\n            \n            <AnimatePresence>\n              {showArchivedSection && (\n                <motion.div\n                  initial={{ height: 0, opacity: 0 }}\n                  animate={{ height: \"auto\", opacity: 1 }}\n                  exit={{ height: 0, opacity: 0 }}\n                  className=\"overflow-hidden divide-y\"\n                >\n                  {archivedConversations.map((archived) => (\n                    <ThreadItem\n                      key={archived.otherUser.id}\n                      thread={{\n                        user: archived.otherUser,\n                        unreadCount: 0,\n                      }}\n                      isSelected={selectedUser === archived.otherUser.id}\n                      onClick={() => handleSelectThread(archived.otherUser.id)}\n                      isOnline={onlineUserIds.has(archived.otherUser.id)}\n                      onArchive={() => handleUnarchiveConversation(archived.otherUser.id)}\n                      isArchived={true}\n                    />\n                  ))}\n                </motion.div>\n              )}\n            </AnimatePresence>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n\n  // Chat content\n  const ChatContent = (\n    <div className=\"flex-1 flex flex-col h-full min-h-0 overflow-hidden\">\n      {selectedUser ? (\n        <>\n          {/* Chat Header */}\n          <div className=\"p-4 border-b flex items-center gap-3\">\n            {isMobile && (\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={handleBackToList}\n                data-testid=\"button-back-to-list\"\n              >\n                <ArrowLeft className=\"h-5 w-5\" />\n              </Button>\n            )}\n            <button\n              onClick={() => selectedUser && navigate(`/profile/${selectedUser}`)}\n              className=\"flex items-center gap-3 cursor-pointer hover-elevate rounded-lg p-1 -m-1\"\n              data-testid=\"button-view-seller-profile\"\n            >\n              <div className=\"relative\">\n                <Avatar className={selectedThread?.user.isSystemAccount ? \"ring-2 ring-yellow-500/50\" : \"\"}>\n                  <AvatarImage src={selectedThread?.user.profileImageUrl || undefined} />\n                  <AvatarFallback className={selectedThread?.user.isSystemAccount ? \"bg-gradient-to-br from-yellow-500/30 to-amber-400/20\" : \"\"}>\n                    {selectedThread?.user.firstName?.[0] || selectedThread?.user.email?.[0]}\n                  </AvatarFallback>\n                </Avatar>\n                {/* Online indicator - System accounts always show online */}\n                <span\n                  className={`absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-background ${\n                    (selectedThread?.user.isSystemAccount || (selectedUser && onlineUserIds.has(selectedUser))) ? \"bg-green-500\" : \"bg-muted-foreground/50\"\n                  }`}\n                  data-testid=\"status-chat-online\"\n                />\n              </div>\n              <div className=\"text-left\">\n                <div className=\"flex items-center gap-1.5\">\n                  <p className=\"font-semibold\" data-testid=\"text-chat-user-name\">\n                    {selectedThread?.user.firstName || selectedThread?.user.email}\n                  </p>\n                  {selectedThread?.user.isSystemAccount && (\n                    <CheckCircle className=\"h-4 w-4 text-yellow-500\" data-testid=\"badge-official\" />\n                  )}\n                </div>\n              </div>\n            </button>\n            <div className=\"flex-1\">\n              <div className=\"flex items-center gap-2 flex-wrap\">\n                {selectedThread?.user.isSystemAccount && (\n                  <Badge variant=\"outline\" className=\"text-xs bg-yellow-500/10 border-yellow-500/30 text-yellow-600 dark:text-yellow-400\" data-testid=\"badge-official-account\">\n                    Official\n                  </Badge>\n                )}\n                {selectedThread?.user.isVerified && !selectedThread?.user.isSystemAccount && (\n                  <Badge variant=\"outline\" className=\"text-xs\" data-testid=\"badge-verified\">\n                    Verified\n                  </Badge>\n                )}\n                {disappearingSettings && disappearingSettings.duration > 0 && (\n                  <Badge variant=\"secondary\" className=\"text-xs gap-1\" data-testid=\"badge-disappearing\">\n                    <Timer className=\"h-3 w-3\" />\n                    {DISAPPEARING_DURATIONS.find(d => d.seconds === disappearingSettings.duration)?.label || \"On\"}\n                  </Badge>\n                )}\n                <span className=\"text-xs text-muted-foreground\" data-testid=\"text-chat-status\">\n                  {(selectedThread?.user.isSystemAccount || (selectedUser && onlineUserIds.has(selectedUser))) ? \"Online\" : \"Offline\"}\n                </span>\n              </div>\n            </div>\n            {/* Connection status indicator */}\n            <div \n              className=\"flex items-center gap-1 text-xs\"\n              data-testid=\"status-connection\"\n              title={wsStatus === \"connected\" ? \"Real-time updates active\" : \"Polling for updates\"}\n            >\n              {wsStatus === \"connected\" ? (\n                <Wifi className=\"h-4 w-4 text-green-500\" />\n              ) : wsStatus === \"connecting\" ? (\n                <Wifi className=\"h-4 w-4 text-yellow-500 animate-pulse\" />\n              ) : (\n                <WifiOff className=\"h-4 w-4 text-muted-foreground\" />\n              )}\n            </div>\n\n            {/* Settings button */}\n            <Popover open={showConversationSettings} onOpenChange={setShowConversationSettings}>\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  data-testid=\"button-conversation-settings\"\n                >\n                  <Settings className=\"h-4 w-4\" />\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-72\" align=\"end\">\n                <div className=\"space-y-4\">\n                  <h4 className=\"font-medium\">Conversation Settings</h4>\n                  <DisappearingMessagesSettings\n                    userId={selectedUser}\n                    currentSetting={disappearingSettings}\n                    onUpdate={handleDisappearingUpdate}\n                  />\n                </div>\n              </PopoverContent>\n            </Popover>\n            \n            {/* User actions menu (mute/block/report) */}\n            {selectedThread && (\n              <UserActionsMenu\n                targetUserId={selectedThread.user.id}\n                targetUserName={selectedThread.user.firstName || selectedThread.user.email || \"User\"}\n              />\n            )}\n          </div>\n\n          {/* Messages */}\n          <div className=\"flex-1 overflow-y-auto p-4 min-h-0\">\n            {messagesLoading ? (\n              <div className=\"space-y-4\">\n                {[...Array(5)].map((_, i) => (\n                  <div key={i} className={i % 2 === 0 ? \"flex justify-start\" : \"flex justify-end\"}>\n                    <Skeleton className=\"h-12 w-48 rounded-2xl\" />\n                  </div>\n                ))}\n              </div>\n            ) : groupedMessages && groupedMessages.length > 0 ? (\n              <>\n                {/* Load More button - appears at top when there are more messages */}\n                {hasMoreMessages && (\n                  <div className=\"flex justify-center mb-4\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={handleLoadMoreMessages}\n                      disabled={isLoadingMore}\n                      className=\"gap-2\"\n                      data-testid=\"button-load-more-messages\"\n                    >\n                      {isLoadingMore ? (\n                        <>\n                          <Loader2 className=\"h-4 w-4 animate-spin\" />\n                          Loading...\n                        </>\n                      ) : (\n                        <>\n                          <ChevronDown className=\"h-4 w-4 rotate-180\" />\n                          Load older messages\n                        </>\n                      )}\n                    </Button>\n                  </div>\n                )}\n                {groupedMessages.map((item, index) => {\n                  if (item.type === \"separator\") {\n                    return <DateSeparator key={`sep-${index}`} date={item.date} />;\n                  }\n                  return (\n                    <ChatBubble\n                      key={item.message.id}\n                      message={item.message}\n                      isOwn={item.message.senderId === currentUser?.id}\n                      showTail={item.showTail}\n                      reactions={messageReactionsMap[item.message.id]}\n                      onAddReaction={handleAddReaction}\n                      onRemoveReaction={handleRemoveReaction}\n                      currentUserId={currentUser?.id}\n                      onImageClick={openLightbox}\n                    />\n                  );\n                })}\n                {isTyping && <TypingIndicator />}\n                <div ref={messagesEndRef} />\n              </>\n            ) : (\n              <EmptyMessagesState userName={selectedThread?.user.firstName || selectedThread?.user.email} />\n            )}\n          </div>\n\n          {/* Input Area - sticky at bottom with safe area padding */}\n          <form \n            onSubmit={handleSend} \n            className=\"p-4 border-t bg-background shrink-0\"\n            style={{\n              paddingBottom: isMobile ? 'max(1rem, env(safe-area-inset-bottom, 0px))' : '1rem'\n            }}\n          >\n            {/* File preview */}\n            {selectedFile && filePreview && (\n              <div className=\"mb-3 relative inline-block\" data-testid=\"container-file-preview\">\n                <img \n                  src={filePreview} \n                  alt=\"Preview\" \n                  className=\"max-h-24 max-w-[200px] rounded-lg object-cover border\"\n                  loading=\"lazy\"\n                />\n                <Button\n                  type=\"button\"\n                  variant=\"destructive\"\n                  size=\"icon\"\n                  className=\"absolute -top-2 -right-2 h-6 w-6 rounded-full\"\n                  onClick={handleRemoveFile}\n                  data-testid=\"button-remove-attachment\"\n                >\n                  <X className=\"h-3 w-3\" />\n                </Button>\n                {isUploading && (\n                  <div className=\"absolute inset-0 bg-background/80 flex items-center justify-center rounded-lg\">\n                    <div className=\"h-5 w-5 border-2 border-primary border-t-transparent rounded-full animate-spin\" />\n                  </div>\n                )}\n              </div>\n            )}\n            \n            <div className=\"flex items-end gap-2\">\n              {/* Attachment button */}\n              <input\n                type=\"file\"\n                id=\"file-upload\"\n                className=\"hidden\"\n                accept=\"image/*\"\n                onChange={handleFileSelect}\n              />\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"shrink-0\"\n                onClick={() => document.getElementById('file-upload')?.click()}\n                disabled={isUploading}\n                data-testid=\"button-attachment\"\n              >\n                <Paperclip className=\"h-5 w-5\" />\n              </Button>\n              \n              {/* Message input */}\n              <div className=\"flex-1 relative\">\n                <Textarea\n                  ref={textareaRef}\n                  value={messageContent}\n                  onChange={handleTextareaChange}\n                  onKeyDown={handleKeyDown}\n                  placeholder={selectedFile ? \"Add a caption (optional)...\" : \"Type a message...\"}\n                  className=\"min-h-[40px] max-h-[120px] resize-none pr-10\"\n                  rows={1}\n                  data-testid=\"input-message\"\n                  inputMode=\"text\"\n                  enterKeyHint=\"send\"\n                  autoComplete=\"off\"\n                  autoCorrect=\"off\"\n                  spellCheck={false}\n                  onFocus={(e) => {\n                    isTextareaFocusedRef.current = true;\n                    // Delay scroll to avoid keyboard flickering on mobile\n                    if (isMobile) {\n                      setTimeout(() => {\n                        if (isTextareaFocusedRef.current) {\n                          e.target.scrollIntoView({ behavior: 'smooth', block: 'end' });\n                        }\n                      }, 350);\n                    }\n                  }}\n                  onBlur={() => {\n                    isTextareaFocusedRef.current = false;\n                  }}\n                  onTouchStart={(e) => {\n                    // Prevent any default behavior that might dismiss keyboard\n                    e.stopPropagation();\n                  }}\n                  onTouchEnd={(e) => {\n                    // Ensure focus is maintained on touch end\n                    if (isMobile) {\n                      e.currentTarget.focus();\n                    }\n                  }}\n                />\n                \n                {/* Emoji picker */}\n                <Popover\n                  onOpenChange={(open) => {\n                    // Restore focus to textarea when popover closes\n                    if (!open && isMobile) {\n                      requestAnimationFrame(() => {\n                        textareaRef.current?.focus();\n                      });\n                    }\n                  }}\n                >\n                  <PopoverTrigger asChild>\n                    <Button\n                      type=\"button\"\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"absolute right-1 bottom-1 h-8 w-8\"\n                      data-testid=\"button-emoji\"\n                      onTouchEnd={(e) => {\n                        // Prevent touch end from stealing focus on mobile\n                        e.stopPropagation();\n                      }}\n                    >\n                      <Smile className=\"h-5 w-5\" />\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent \n                    className=\"w-72\" \n                    align=\"end\"\n                    onOpenAutoFocus={(e) => {\n                      // Prevent auto focus on mobile to keep keyboard visible\n                      if (isMobile) {\n                        e.preventDefault();\n                      }\n                    }}\n                    onCloseAutoFocus={(e) => {\n                      // Prevent auto focus on close to avoid focus issues\n                      if (isMobile) {\n                        e.preventDefault();\n                        textareaRef.current?.focus();\n                      }\n                    }}\n                  >\n                    <EmojiPicker onSelect={handleEmojiSelect} />\n                  </PopoverContent>\n                </Popover>\n              </div>\n              \n              {/* Send button */}\n              <Button\n                type=\"submit\"\n                size=\"icon\"\n                disabled={(!messageContent.trim() && !selectedFile) || sendMutation.isPending || isUploading}\n                className=\"shrink-0\"\n                data-testid=\"button-send-message\"\n                onTouchEnd={(e) => {\n                  // Prevent default to avoid focus loss on mobile\n                  if (isMobile) {\n                    e.preventDefault();\n                    // Trigger form submit manually\n                    const form = e.currentTarget.closest('form');\n                    if (form) {\n                      form.requestSubmit();\n                    }\n                    // Refocus textarea after sending\n                    requestAnimationFrame(() => {\n                      textareaRef.current?.focus();\n                    });\n                  }\n                }}\n              >\n                <Send className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </form>\n        </>\n      ) : (\n        <NoConversationSelectedState />\n      )}\n    </div>\n  );\n\n  // Mobile layout with Sheet\n  if (isMobile) {\n    return (\n      <>\n        <div \n          className=\"flex flex-col pb-20\"\n          style={{\n            height: 'calc(100dvh - 4rem)',\n            paddingBottom: 'calc(5rem + env(safe-area-inset-bottom, 0px))'\n          }}\n        >\n          {showMobileChat ? (\n            ChatContent\n          ) : (\n            ThreadListContent\n          )}\n        </div>\n        \n        {/* Safety Shield Modal */}\n        {pendingUserId && (\n          <SafetyShieldModal\n            sellerId={pendingUserId}\n            open={showSafetyModal}\n            onOpenChange={setShowSafetyModal}\n            onAcknowledge={handleSafetyAcknowledge}\n          />\n        )}\n        \n        {/* Image Lightbox */}\n        <Lightbox\n          src={currentImage}\n          isOpen={lightboxOpen}\n          onClose={closeLightbox}\n          alt=\"Message image\"\n        />\n      </>\n    );\n  }\n\n  // Desktop layout\n  return (\n    <>\n      <div \n        className=\"flex\"\n        style={{ height: 'calc(100dvh - 4rem)' }}\n      >\n        {/* Threads List */}\n        <div className=\"w-80 border-r flex flex-col\">\n          {ThreadListContent}\n        </div>\n\n        {/* Chat Area */}\n        {ChatContent}\n      </div>\n      \n      {/* Safety Shield Modal */}\n      {pendingUserId && (\n        <SafetyShieldModal\n          sellerId={pendingUserId}\n          open={showSafetyModal}\n          onOpenChange={setShowSafetyModal}\n          onAcknowledge={handleSafetyAcknowledge}\n        />\n      )}\n      \n      {/* Image Lightbox */}\n      <Lightbox\n        src={currentImage}\n        isOpen={lightboxOpen}\n        onClose={closeLightbox}\n        alt=\"Message image\"\n      />\n    </>\n  );\n}\n","path":null,"size_bytes":73855,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/games/WordBattleGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Input } from \"@/components/ui/input\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Clock, Trophy, Bot, User, Check, X, Send, RotateCcw, Sparkles, Loader2, Lightbulb, Zap } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface WordBattleGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ninterface WordValidationResult {\n  valid: boolean;\n  feedback?: string;\n  funFact?: string | null;\n  usedFallback?: boolean;\n}\n\ninterface LetterGenerationResult {\n  letters: string[];\n  hint?: string | null;\n  possibleWordCount?: number;\n  usedFallback?: boolean;\n}\n\nconst COMMON_WORDS = [\n  \"a\", \"i\", \"am\", \"an\", \"as\", \"at\", \"be\", \"by\", \"do\", \"go\", \"he\", \"if\", \"in\", \"is\", \"it\", \"me\", \"my\", \"no\", \"of\", \"on\", \"or\", \"so\", \"to\", \"up\", \"us\", \"we\",\n  \"ace\", \"act\", \"add\", \"age\", \"ago\", \"aid\", \"aim\", \"air\", \"all\", \"and\", \"ant\", \"any\", \"ape\", \"arc\", \"are\", \"ark\", \"arm\", \"art\", \"ask\", \"ate\", \"awe\", \"axe\",\n  \"bad\", \"bag\", \"ban\", \"bar\", \"bat\", \"bay\", \"bed\", \"bee\", \"bet\", \"bid\", \"big\", \"bin\", \"bit\", \"bow\", \"box\", \"boy\", \"bud\", \"bug\", \"bus\", \"but\", \"buy\",\n  \"cab\", \"can\", \"cap\", \"car\", \"cat\", \"cop\", \"cow\", \"cry\", \"cub\", \"cup\", \"cut\",\n  \"dad\", \"dam\", \"day\", \"den\", \"dew\", \"did\", \"die\", \"dig\", \"dim\", \"dip\", \"dog\", \"dot\", \"dry\", \"dub\", \"dud\", \"due\", \"dug\", \"dye\",\n  \"ear\", \"eat\", \"eel\", \"egg\", \"ego\", \"elf\", \"elk\", \"elm\", \"end\", \"era\", \"eve\", \"ewe\", \"eye\",\n  \"fab\", \"fad\", \"fan\", \"far\", \"fat\", \"fax\", \"fed\", \"fee\", \"few\", \"fig\", \"fin\", \"fir\", \"fit\", \"fix\", \"fly\", \"foe\", \"fog\", \"for\", \"fox\", \"fry\", \"fun\", \"fur\",\n  \"gag\", \"gap\", \"gas\", \"gay\", \"gel\", \"gem\", \"get\", \"gig\", \"gin\", \"god\", \"got\", \"gum\", \"gun\", \"gut\", \"guy\", \"gym\",\n  \"had\", \"ham\", \"has\", \"hat\", \"hay\", \"hem\", \"hen\", \"her\", \"hid\", \"him\", \"hip\", \"his\", \"hit\", \"hob\", \"hoe\", \"hog\", \"hop\", \"hot\", \"how\", \"hub\", \"hue\", \"hug\", \"hum\", \"hut\",\n  \"ice\", \"icy\", \"ill\", \"imp\", \"ink\", \"inn\", \"ion\", \"ire\", \"irk\", \"its\", \"ivy\",\n  \"jab\", \"jag\", \"jam\", \"jar\", \"jaw\", \"jay\", \"jet\", \"jig\", \"job\", \"jog\", \"jot\", \"joy\", \"jug\", \"jut\",\n  \"keg\", \"ken\", \"key\", \"kid\", \"kin\", \"kit\",\n  \"lab\", \"lad\", \"lag\", \"lap\", \"law\", \"lay\", \"lea\", \"led\", \"leg\", \"let\", \"lid\", \"lie\", \"lip\", \"lit\", \"log\", \"lot\", \"low\", \"lug\",\n  \"mad\", \"man\", \"map\", \"mar\", \"mat\", \"maw\", \"may\", \"men\", \"met\", \"mid\", \"mix\", \"mob\", \"mop\", \"mow\", \"mud\", \"mug\", \"mum\",\n  \"nab\", \"nag\", \"nap\", \"nay\", \"net\", \"new\", \"nil\", \"nip\", \"nit\", \"nod\", \"nor\", \"not\", \"now\", \"nun\", \"nut\",\n  \"oak\", \"oar\", \"oat\", \"odd\", \"ode\", \"off\", \"oft\", \"oil\", \"old\", \"one\", \"opt\", \"orb\", \"ore\", \"our\", \"out\", \"owe\", \"owl\", \"own\",\n  \"pad\", \"pal\", \"pan\", \"pap\", \"par\", \"pat\", \"paw\", \"pay\", \"pea\", \"peg\", \"pen\", \"pep\", \"per\", \"pet\", \"pew\", \"pie\", \"pig\", \"pin\", \"pit\", \"ply\", \"pod\", \"pop\", \"pot\", \"pow\", \"pro\", \"pry\", \"pub\", \"pun\", \"pup\", \"pus\", \"put\",\n  \"rag\", \"ram\", \"ran\", \"rap\", \"rat\", \"raw\", \"ray\", \"red\", \"ref\", \"rep\", \"rib\", \"rid\", \"rig\", \"rim\", \"rip\", \"rob\", \"rod\", \"roe\", \"rot\", \"row\", \"rub\", \"rug\", \"rum\", \"run\", \"rut\", \"rye\",\n  \"sac\", \"sad\", \"sag\", \"sap\", \"sat\", \"saw\", \"say\", \"sea\", \"set\", \"sew\", \"she\", \"shy\", \"sin\", \"sip\", \"sir\", \"sis\", \"sit\", \"six\", \"ski\", \"sky\", \"sly\", \"sob\", \"sod\", \"son\", \"sop\", \"sot\", \"sow\", \"soy\", \"spa\", \"spy\", \"sub\", \"sue\", \"sum\", \"sun\", \"sup\",\n  \"tab\", \"tad\", \"tag\", \"tan\", \"tap\", \"tar\", \"tax\", \"tea\", \"ten\", \"the\", \"thy\", \"tic\", \"tie\", \"tin\", \"tip\", \"toe\", \"tog\", \"ton\", \"too\", \"top\", \"tot\", \"tow\", \"toy\", \"try\", \"tub\", \"tug\", \"tun\", \"two\",\n  \"ugh\", \"ump\", \"urn\", \"use\",\n  \"van\", \"vat\", \"vet\", \"via\", \"vie\", \"vim\", \"vow\",\n  \"wad\", \"wag\", \"war\", \"was\", \"wax\", \"way\", \"web\", \"wed\", \"wee\", \"wet\", \"who\", \"why\", \"wig\", \"win\", \"wit\", \"woe\", \"wok\", \"won\", \"woo\", \"wow\",\n  \"yak\", \"yam\", \"yap\", \"yaw\", \"yea\", \"yen\", \"yes\", \"yet\", \"yew\", \"yin\", \"yip\", \"you\", \"yow\",\n  \"zag\", \"zap\", \"zed\", \"zee\", \"zen\", \"zig\", \"zip\", \"zit\", \"zoo\",\n  \"able\", \"ache\", \"acre\", \"aged\", \"also\", \"area\", \"army\", \"away\", \"baby\", \"back\", \"ball\", \"band\", \"bank\", \"base\", \"bear\", \"beat\", \"been\", \"best\", \"bird\", \"blow\", \"blue\", \"boat\", \"body\", \"bold\", \"bone\", \"book\", \"bore\", \"born\", \"boss\", \"both\", \"bowl\", \"burn\", \"busy\", \"call\", \"calm\", \"came\", \"camp\", \"cape\", \"card\", \"care\", \"case\", \"cash\", \"cast\", \"cave\", \"chef\", \"city\", \"clam\", \"clan\", \"clap\", \"clay\", \"clip\", \"club\", \"clue\", \"coal\", \"coat\", \"code\", \"coin\", \"cold\", \"come\", \"cook\", \"cool\", \"cope\", \"copy\", \"core\", \"corn\", \"cost\", \"crew\", \"crop\", \"cure\", \"cute\", \"dale\", \"damn\", \"damp\", \"dare\", \"dark\", \"data\", \"date\", \"dawn\", \"days\", \"dead\", \"deal\", \"dean\", \"dear\", \"debt\", \"deck\", \"deed\", \"deep\", \"deer\", \"deny\", \"desk\", \"dial\", \"diet\", \"disc\", \"dish\", \"dive\", \"dock\", \"does\", \"doll\", \"dome\", \"done\", \"door\", \"dose\", \"down\", \"drag\", \"draw\", \"drew\", \"drip\", \"drop\", \"drug\", \"drum\", \"dual\", \"duck\", \"dude\", \"duel\", \"duke\", \"dull\", \"dumb\", \"dump\", \"dune\", \"dunk\", \"dupe\", \"dust\", \"duty\", \"dyed\",\n  \"each\", \"earl\", \"earn\", \"ease\", \"east\", \"easy\", \"echo\", \"edge\", \"edit\", \"else\", \"emit\", \"ends\", \"epic\", \"euro\", \"even\", \"ever\", \"exam\", \"exec\", \"exit\", \"expo\", \"eyed\", \"eyes\", \"face\", \"fact\", \"fade\", \"fail\", \"fair\", \"fake\", \"fall\", \"fame\", \"fang\", \"fare\", \"farm\", \"fast\", \"fate\", \"fear\", \"feat\", \"feed\", \"feel\", \"feet\", \"fell\", \"felt\", \"fern\", \"fest\", \"file\", \"fill\", \"film\", \"find\", \"fine\", \"fire\", \"firm\", \"fish\", \"fist\", \"fits\", \"five\", \"flag\", \"flap\", \"flat\", \"flaw\", \"fled\", \"flee\", \"flew\", \"flip\", \"flit\", \"flow\", \"flux\", \"foam\", \"fold\", \"folk\", \"fond\", \"font\", \"food\", \"fool\", \"foot\", \"ford\", \"fore\", \"fork\", \"form\", \"fort\", \"foul\", \"four\", \"fowl\", \"fray\", \"free\", \"frog\", \"from\", \"fuel\", \"full\", \"fume\", \"fund\", \"funk\", \"fuse\", \"fuss\", \"gain\", \"gale\", \"game\", \"gang\", \"gaps\", \"garb\", \"gate\", \"gave\", \"gaze\", \"gear\", \"gene\", \"gift\", \"gilt\", \"girl\", \"give\", \"glad\", \"glen\", \"glue\", \"glum\", \"gnat\", \"gnaw\", \"goal\", \"goat\", \"goes\", \"gold\", \"golf\", \"gone\", \"good\", \"gore\", \"gown\", \"grab\", \"gram\", \"gray\", \"grew\", \"grey\", \"grid\", \"grim\", \"grin\", \"grip\", \"grit\", \"grow\", \"gulf\", \"gust\", \"guts\", \"hack\", \"hail\", \"hair\", \"half\", \"hall\", \"halt\", \"hand\", \"hang\", \"hard\", \"hare\", \"harm\", \"harp\", \"hash\", \"hate\", \"haul\", \"have\", \"hawk\", \"haze\", \"hazy\", \"head\", \"heal\", \"heap\", \"hear\", \"heat\", \"heel\", \"heir\", \"held\", \"hell\", \"helm\", \"help\", \"herb\", \"herd\", \"here\", \"hero\", \"hide\", \"high\", \"hike\", \"hill\", \"hint\", \"hire\", \"hold\", \"hole\", \"holy\", \"home\", \"hood\", \"hook\", \"hope\", \"horn\", \"host\", \"hour\", \"huge\", \"hull\", \"hung\", \"hunt\", \"hurt\", \"hush\", \"icon\", \"idea\", \"idle\", \"idol\", \"inch\", \"info\", \"into\", \"iron\", \"isle\", \"item\", \"jack\", \"jade\", \"jail\", \"jazz\", \"jean\", \"jerk\", \"jest\", \"jobs\", \"john\", \"join\", \"joke\", \"jolt\", \"jump\", \"june\", \"junk\", \"jury\", \"just\", \"keen\", \"keep\", \"kept\", \"kick\", \"kids\", \"kill\", \"kind\", \"king\", \"kiss\", \"kite\", \"knee\", \"knew\", \"knit\", \"knob\", \"knot\", \"know\", \"lace\", \"lack\", \"lady\", \"laid\", \"lake\", \"lamb\", \"lamp\", \"land\", \"lane\", \"laps\", \"lard\", \"last\", \"late\", \"lawn\", \"laws\", \"lazy\", \"lead\", \"leaf\", \"lean\", \"leap\", \"left\", \"lend\", \"lens\", \"less\", \"lick\", \"life\", \"lift\", \"like\", \"limb\", \"lime\", \"limp\", \"line\", \"link\", \"lion\", \"lips\", \"list\", \"live\", \"load\", \"loaf\", \"loan\", \"lock\", \"loft\", \"logo\", \"lone\", \"long\", \"look\", \"loop\", \"lord\", \"lore\", \"lose\", \"loss\", \"lost\", \"lots\", \"loud\", \"love\", \"luck\", \"lump\", \"lung\", \"lure\", \"lurk\", \"lush\", \"lust\", \"made\", \"maid\", \"mail\", \"main\", \"make\", \"male\", \"mall\", \"malt\", \"many\", \"mare\", \"mark\", \"mars\", \"mash\", \"mask\", \"mass\", \"mast\", \"mate\", \"math\", \"maul\", \"maze\", \"meal\", \"mean\", \"meat\", \"meek\", \"meet\", \"melt\", \"memo\", \"mend\", \"menu\", \"mere\", \"mesh\", \"mess\", \"mice\", \"mild\", \"mile\", \"milk\", \"mill\", \"mime\", \"mind\", \"mine\", \"mint\", \"miss\", \"mist\", \"moan\", \"moat\", \"mock\", \"mode\", \"mold\", \"mole\", \"monk\", \"mood\", \"moon\", \"more\", \"morn\", \"moss\", \"most\", \"moth\", \"move\", \"much\", \"muck\", \"mule\", \"muse\", \"mush\", \"musk\", \"must\", \"mute\", \"myth\", \"nail\", \"name\", \"nape\", \"navy\", \"near\", \"neat\", \"neck\", \"need\", \"nest\", \"news\", \"next\", \"nice\", \"nick\", \"nine\", \"node\", \"none\", \"noon\", \"norm\", \"nose\", \"note\", \"noun\", \"nude\", \"null\", \"numb\", \"nuts\", \"oath\", \"obey\", \"odds\", \"omen\", \"omit\", \"once\", \"only\", \"onto\", \"open\", \"oral\", \"oven\", \"over\", \"owed\", \"owes\", \"owns\", \"pace\", \"pack\", \"page\", \"paid\", \"pail\", \"pain\", \"pair\", \"pale\", \"palm\", \"pane\", \"pant\", \"park\", \"part\", \"pass\", \"past\", \"path\", \"pave\", \"pawn\", \"peak\", \"pear\", \"peat\", \"peck\", \"peel\", \"peer\", \"pelt\", \"pens\", \"perk\", \"perm\", \"pest\", \"pick\", \"pier\", \"pike\", \"pile\", \"pill\", \"pine\", \"pink\", \"pint\", \"pipe\", \"pity\", \"plan\", \"play\", \"plea\", \"plod\", \"plot\", \"plow\", \"ploy\", \"plug\", \"plum\", \"plus\", \"pock\", \"poem\", \"poet\", \"poke\", \"pole\", \"poll\", \"polo\", \"pomp\", \"pond\", \"pony\", \"pool\", \"poor\", \"pope\", \"pore\", \"pork\", \"port\", \"pose\", \"posh\", \"post\", \"pour\", \"pout\", \"pray\", \"prep\", \"prey\", \"prim\", \"prod\", \"prop\", \"prow\", \"puck\", \"pull\", \"pulp\", \"pump\", \"punk\", \"puns\", \"pure\", \"push\", \"quit\", \"quiz\", \"race\", \"rack\", \"raft\", \"rage\", \"raid\", \"rail\", \"rain\", \"rake\", \"ramp\", \"rang\", \"rank\", \"rant\", \"rare\", \"rash\", \"rasp\", \"rate\", \"rave\", \"rays\", \"read\", \"real\", \"ream\", \"reap\", \"rear\", \"reef\", \"reel\", \"rely\", \"rend\", \"rent\", \"rest\", \"rice\", \"rich\", \"ride\", \"rift\", \"rind\", \"ring\", \"riot\", \"ripe\", \"rise\", \"risk\", \"rite\", \"road\", \"roam\", \"roar\", \"robe\", \"rock\", \"rode\", \"role\", \"roll\", \"roof\", \"room\", \"root\", \"rope\", \"rose\", \"rosy\", \"rout\", \"rove\", \"rude\", \"ruin\", \"rule\", \"rump\", \"rung\", \"runs\", \"rush\", \"rust\", \"sack\", \"safe\", \"sage\", \"said\", \"sail\", \"sake\", \"sale\", \"salt\", \"same\", \"sand\", \"sane\", \"sang\", \"sank\", \"save\", \"scab\", \"scan\", \"scar\", \"seal\", \"seam\", \"sear\", \"seas\", \"seat\", \"sect\", \"seed\", \"seek\", \"seem\", \"seen\", \"self\", \"sell\", \"send\", \"sent\", \"sept\", \"sere\", \"serf\", \"sess\", \"sets\", \"sewn\", \"shed\", \"shim\", \"shin\", \"ship\", \"shoe\", \"shoo\", \"shop\", \"shot\", \"show\", \"shun\", \"shut\", \"sick\", \"side\", \"sift\", \"sigh\", \"sign\", \"silk\", \"silo\", \"sine\", \"sing\", \"sink\", \"site\", \"size\", \"skim\", \"skin\", \"skip\", \"slab\", \"slag\", \"slam\", \"slap\", \"slat\", \"slay\", \"sled\", \"slew\", \"slid\", \"slim\", \"slip\", \"slit\", \"slob\", \"slop\", \"slot\", \"slow\", \"slug\", \"slum\", \"slur\", \"smog\", \"snap\", \"snob\", \"snow\", \"snub\", \"snug\", \"soak\", \"soap\", \"soar\", \"sock\", \"soda\", \"sofa\", \"soft\", \"soil\", \"sold\", \"sole\", \"some\", \"song\", \"soon\", \"soot\", \"sore\", \"sort\", \"soul\", \"soup\", \"sour\", \"span\", \"spar\", \"spat\", \"spec\", \"sped\", \"spin\", \"spit\", \"spot\", \"spun\", \"spur\", \"stab\", \"stag\", \"star\", \"stay\", \"stem\", \"step\", \"stew\", \"stir\", \"stop\", \"stub\", \"stud\", \"stun\", \"suck\", \"suds\", \"suit\", \"sulk\", \"sung\", \"sunk\", \"sure\", \"surf\", \"swab\", \"swam\", \"swan\", \"swap\", \"sway\", \"swim\", \"sync\", \"tack\", \"tact\", \"tail\", \"take\", \"tale\", \"talk\", \"tall\", \"tame\", \"tank\", \"tape\", \"task\", \"team\", \"tear\", \"teem\", \"tell\", \"temp\", \"tend\", \"tens\", \"tent\", \"term\", \"test\", \"text\", \"than\", \"that\", \"thaw\", \"them\", \"then\", \"they\", \"thin\", \"this\", \"thus\", \"tick\", \"tide\", \"tidy\", \"tied\", \"tier\", \"tile\", \"till\", \"tilt\", \"time\", \"tint\", \"tiny\", \"tips\", \"tire\", \"toad\", \"toes\", \"toil\", \"told\", \"toll\", \"tomb\", \"tone\", \"tons\", \"took\", \"tool\", \"tops\", \"tore\", \"torn\", \"tort\", \"toss\", \"tour\", \"town\", \"toys\", \"tram\", \"trap\", \"tray\", \"tree\", \"trek\", \"trim\", \"trio\", \"trip\", \"trod\", \"trot\", \"true\", \"tube\", \"tuck\", \"tuna\", \"tune\", \"turf\", \"turn\", \"tusk\", \"tutu\", \"twig\", \"twin\", \"type\", \"ugly\", \"undo\", \"unit\", \"unto\", \"upon\", \"urge\", \"used\", \"user\", \"uses\", \"vain\", \"vale\", \"vane\", \"vary\", \"vase\", \"vast\", \"veal\", \"veer\", \"veil\", \"vein\", \"vent\", \"verb\", \"very\", \"vest\", \"veto\", \"vice\", \"vied\", \"view\", \"vile\", \"vine\", \"visa\", \"vita\", \"void\", \"volt\", \"vote\", \"wade\", \"wage\", \"wait\", \"wake\", \"walk\", \"wall\", \"wand\", \"want\", \"ward\", \"warm\", \"warn\", \"warp\", \"wary\", \"wash\", \"wasp\", \"wave\", \"wavy\", \"waxy\", \"ways\", \"weak\", \"wear\", \"weed\", \"week\", \"weep\", \"weld\", \"well\", \"went\", \"wept\", \"were\", \"west\", \"what\", \"when\", \"whim\", \"whip\", \"whir\", \"whom\", \"wick\", \"wide\", \"wife\", \"wild\", \"will\", \"wilt\", \"wily\", \"wimp\", \"wind\", \"wine\", \"wing\", \"wink\", \"wipe\", \"wire\", \"wiry\", \"wise\", \"wish\", \"wisp\", \"with\", \"wits\", \"woke\", \"wolf\", \"womb\", \"wont\", \"wood\", \"woof\", \"wool\", \"word\", \"wore\", \"work\", \"worm\", \"worn\", \"wove\", \"wrap\", \"wren\", \"yank\", \"yard\", \"yarn\", \"yeah\", \"year\", \"yell\", \"your\", \"yuck\", \"zeal\", \"zero\", \"zest\", \"zinc\", \"zone\", \"zoom\",\n  \"about\", \"above\", \"abuse\", \"actor\", \"adapt\", \"admit\", \"adopt\", \"adult\", \"after\", \"again\", \"agent\", \"agree\", \"ahead\", \"alarm\", \"album\", \"alien\", \"align\", \"alike\", \"alive\", \"allow\", \"alone\", \"along\", \"alter\", \"amaze\", \"among\", \"anger\", \"angle\", \"angry\", \"apart\", \"apple\", \"apply\", \"argue\", \"arise\", \"armor\", \"array\", \"arrow\", \"aside\", \"asset\", \"avoid\", \"awake\", \"award\", \"aware\", \"awful\", \"basic\", \"beach\", \"beast\", \"begin\", \"being\", \"below\", \"bench\", \"blend\", \"bless\", \"blind\", \"block\", \"blood\", \"blown\", \"board\", \"boast\", \"bonus\", \"booth\", \"bound\", \"brain\", \"brand\", \"brave\", \"bread\", \"break\", \"breed\", \"brick\", \"bride\", \"brief\", \"bring\", \"broad\", \"broke\", \"brook\", \"broom\", \"brown\", \"brush\", \"build\", \"bunch\", \"buyer\", \"cabin\", \"cable\", \"camel\", \"candy\", \"cargo\", \"carry\", \"catch\", \"cause\", \"chain\", \"chair\", \"chalk\", \"champ\", \"chant\", \"chaos\", \"charm\", \"chart\", \"chase\", \"cheap\", \"check\", \"cheek\", \"cheer\", \"chess\", \"chest\", \"chief\", \"child\", \"chill\", \"china\", \"choir\", \"chord\", \"chunk\", \"cinch\", \"claim\", \"class\", \"clean\", \"clear\", \"clerk\", \"click\", \"cliff\", \"climb\", \"clock\", \"close\", \"cloth\", \"cloud\", \"coach\", \"coast\", \"colon\", \"color\", \"comet\", \"coral\", \"couch\", \"could\", \"count\", \"court\", \"cover\", \"crack\", \"craft\", \"crane\", \"crash\", \"crawl\", \"crazy\", \"cream\", \"crest\", \"crime\", \"crisp\", \"cross\", \"crowd\", \"crown\", \"crude\", \"cruel\", \"crush\", \"curve\", \"cycle\", \"daily\", \"dance\", \"death\", \"debut\", \"decay\", \"decor\", \"delay\", \"demon\", \"dense\", \"depth\", \"derby\", \"deter\", \"diary\", \"diner\", \"dirty\", \"disco\", \"ditch\", \"dizzy\", \"dough\", \"doubt\", \"dozen\", \"draft\", \"drain\", \"drama\", \"drape\", \"drawl\", \"dread\", \"dream\", \"dress\", \"dried\", \"drift\", \"drill\", \"drink\", \"drive\", \"drown\", \"drunk\", \"dryer\", \"dwell\", \"dying\", \"eager\", \"eagle\", \"early\", \"earth\", \"eight\", \"elder\", \"elect\", \"elite\", \"empty\", \"enemy\", \"enjoy\", \"enter\", \"entry\", \"equal\", \"equip\", \"erase\", \"error\", \"essay\", \"evade\", \"event\", \"every\", \"exact\", \"exist\", \"extra\", \"fable\", \"facet\", \"faint\", \"faith\", \"false\", \"fancy\", \"farce\", \"fatal\", \"fatty\", \"fault\", \"favor\", \"feast\", \"fence\", \"ferry\", \"fetch\", \"fever\", \"fiber\", \"field\", \"fiery\", \"fifth\", \"fifty\", \"fight\", \"filth\", \"final\", \"first\", \"fixed\", \"flair\", \"flame\", \"flank\", \"flash\", \"flask\", \"fleet\", \"flesh\", \"flick\", \"fling\", \"flint\", \"float\", \"flock\", \"flood\", \"floor\", \"flora\", \"flour\", \"fluid\", \"flush\", \"focal\", \"focus\", \"foggy\", \"force\", \"forge\", \"forum\", \"found\", \"frame\", \"frank\", \"fraud\", \"freak\", \"fresh\", \"fried\", \"front\", \"frost\", \"fruit\", \"fully\", \"fungi\", \"funny\", \"fuzzy\", \"giant\", \"giddy\", \"given\", \"gland\", \"glass\", \"gleam\", \"glide\", \"globe\", \"gloom\", \"glory\", \"gloss\", \"glove\", \"going\", \"grace\", \"grade\", \"grain\", \"grand\", \"grant\", \"grape\", \"graph\", \"grasp\", \"grass\", \"grave\", \"graze\", \"great\", \"greed\", \"green\", \"greet\", \"grief\", \"grill\", \"grind\", \"groan\", \"groom\", \"gross\", \"group\", \"grove\", \"growl\", \"grown\", \"guard\", \"guess\", \"guest\", \"guide\", \"guild\", \"guilt\", \"guise\", \"gulch\", \"gummy\", \"habit\", \"hands\", \"handy\", \"happy\", \"hardy\", \"harsh\", \"haste\", \"hasty\", \"hatch\", \"haunt\", \"haven\", \"heart\", \"heavy\", \"hedge\", \"heist\", \"hello\", \"hence\", \"hired\", \"hobby\", \"hoist\", \"honey\", \"honor\", \"horse\", \"hotel\", \"hound\", \"house\", \"hover\", \"human\", \"humid\", \"humor\", \"hurry\", \"ideal\", \"image\", \"imply\", \"inbox\", \"incur\", \"index\", \"indie\", \"infer\", \"inner\", \"input\", \"inter\", \"intro\", \"issue\", \"ivory\", \"jolly\", \"joust\", \"judge\", \"juice\", \"juicy\", \"jumbo\", \"jumpy\", \"knack\", \"knead\", \"knife\", \"knock\", \"known\", \"label\", \"labor\", \"lance\", \"large\", \"laser\", \"latch\", \"later\", \"laugh\", \"layer\", \"leach\", \"learn\", \"lease\", \"least\", \"leave\", \"ledge\", \"legal\", \"lemon\", \"level\", \"lever\", \"light\", \"limit\", \"linen\", \"liner\", \"lingo\", \"lipid\", \"liter\", \"lithe\", \"liver\", \"llama\", \"local\", \"lodge\", \"logic\", \"loose\", \"lorry\", \"loser\", \"lotus\", \"lousy\", \"lover\", \"lower\", \"loyal\", \"lucid\", \"lucky\", \"lunar\", \"lunch\", \"lunge\", \"lyric\", \"macho\", \"magic\", \"major\", \"maker\", \"manga\", \"manor\", \"maple\", \"march\", \"match\", \"maxim\", \"maybe\", \"mayor\", \"meant\", \"medal\", \"media\", \"melee\", \"melon\", \"mercy\", \"merge\", \"merit\", \"merry\", \"messy\", \"metal\", \"meter\", \"micro\", \"midst\", \"might\", \"mince\", \"miner\", \"minor\", \"minus\", \"mirth\", \"misty\", \"mixed\", \"mixer\", \"model\", \"moist\", \"money\", \"month\", \"moose\", \"moral\", \"moron\", \"morph\", \"motor\", \"motto\", \"mound\", \"mount\", \"mouse\", \"mouth\", \"mover\", \"movie\", \"muddy\", \"mural\", \"music\", \"musty\", \"naive\", \"naked\", \"nasty\", \"naval\", \"niche\", \"night\", \"noble\", \"noise\", \"noisy\", \"nomad\", \"north\", \"notch\", \"noted\", \"novel\", \"nudge\", \"nurse\", \"nylon\", \"occur\", \"ocean\", \"offer\", \"often\", \"older\", \"olive\", \"omega\", \"onset\", \"opera\", \"optic\", \"orbit\", \"order\", \"organ\", \"other\", \"ought\", \"ounce\", \"outer\", \"owner\", \"oxide\", \"ozone\", \"paint\", \"panda\", \"panel\", \"panic\", \"paper\", \"party\", \"pasta\", \"paste\", \"patch\", \"patio\", \"pause\", \"peace\", \"peach\", \"pearl\", \"pedal\", \"penny\", \"perch\", \"peril\", \"perky\", \"petal\", \"petty\", \"phase\", \"phone\", \"photo\", \"piano\", \"piece\", \"pilot\", \"pinch\", \"pitch\", \"pivot\", \"pixel\", \"pizza\", \"place\", \"plain\", \"plane\", \"plant\", \"plate\", \"plaza\", \"plead\", \"pleat\", \"plier\", \"pluck\", \"plumb\", \"plump\", \"plunk\", \"point\", \"polar\", \"poise\", \"poker\", \"porch\", \"poser\", \"posse\", \"pound\", \"power\", \"prank\", \"press\", \"price\", \"pride\", \"prime\", \"print\", \"prior\", \"prism\", \"prize\", \"probe\", \"prone\", \"proof\", \"prose\", \"proud\", \"prove\", \"prowl\", \"proxy\", \"prude\", \"prune\", \"psalm\", \"pulse\", \"punch\", \"pupil\", \"puppy\", \"purse\", \"quack\", \"quake\", \"qualm\", \"queen\", \"query\", \"quest\", \"queue\", \"quick\", \"quiet\", \"quilt\", \"quirk\", \"quota\", \"quote\", \"rabid\", \"racer\", \"radar\", \"radio\", \"rally\", \"ranch\", \"range\", \"rapid\", \"raven\", \"razor\", \"reach\", \"react\", \"ready\", \"realm\", \"rebel\", \"refer\", \"reign\", \"relax\", \"relay\", \"relic\", \"renew\", \"repay\", \"reply\", \"resin\", \"retro\", \"rider\", \"ridge\", \"rifle\", \"rigid\", \"ripen\", \"risen\", \"risky\", \"rival\", \"river\", \"roast\", \"robot\", \"rocky\", \"rogue\", \"roman\", \"roots\", \"rough\", \"round\", \"royal\", \"rural\", \"rusty\", \"saint\", \"salad\", \"salon\", \"sandy\", \"sauce\", \"savor\", \"scale\", \"scare\", \"scarf\", \"scary\", \"scene\", \"scent\", \"score\", \"scout\", \"scrap\", \"seize\", \"sense\", \"serve\", \"seven\", \"shade\", \"shake\", \"shall\", \"shame\", \"shape\", \"share\", \"shark\", \"sharp\", \"sheep\", \"sheer\", \"sheet\", \"shelf\", \"shell\", \"shift\", \"shine\", \"shiny\", \"shirt\", \"shock\", \"shore\", \"short\", \"shout\", \"shown\", \"shrug\", \"sight\", \"sigma\", \"silly\", \"since\", \"sixth\", \"sixty\", \"sized\", \"skill\", \"skirt\", \"skull\", \"slash\", \"slave\", \"sleep\", \"slice\", \"slide\", \"slope\", \"slump\", \"small\", \"smart\", \"smell\", \"smile\", \"smoke\", \"snake\", \"solar\", \"solid\", \"solve\", \"sorry\", \"sound\", \"south\", \"space\", \"spare\", \"spark\", \"speak\", \"speed\", \"spell\", \"spend\", \"spent\", \"spice\", \"spicy\", \"spine\", \"split\", \"spoke\", \"spoon\", \"sport\", \"spray\", \"squad\", \"stack\", \"staff\", \"stage\", \"stain\", \"stake\", \"stamp\", \"stand\", \"stare\", \"start\", \"state\", \"steak\", \"steal\", \"steam\", \"steel\", \"steep\", \"steer\", \"stern\", \"stick\", \"stiff\", \"still\", \"stock\", \"stone\", \"stood\", \"stool\", \"store\", \"storm\", \"story\", \"stout\", \"stove\", \"strap\", \"straw\", \"strip\", \"stuck\", \"study\", \"stuff\", \"style\", \"sugar\", \"suite\", \"super\", \"swear\", \"sweat\", \"sweep\", \"sweet\", \"swift\", \"swing\", \"sword\", \"table\", \"taken\", \"taste\", \"tasty\", \"teach\", \"teeth\", \"tense\", \"tenth\", \"thank\", \"their\", \"theme\", \"there\", \"these\", \"thick\", \"thief\", \"thing\", \"think\", \"third\", \"thorn\", \"those\", \"three\", \"threw\", \"throw\", \"thumb\", \"tiger\", \"tight\", \"timer\", \"tired\", \"title\", \"toast\", \"today\", \"token\", \"tooth\", \"topic\", \"torch\", \"total\", \"touch\", \"tough\", \"tower\", \"toxic\", \"trace\", \"track\", \"trade\", \"trail\", \"train\", \"trait\", \"trash\", \"treat\", \"trend\", \"trial\", \"tribe\", \"trick\", \"tried\", \"troop\", \"truck\", \"truly\", \"trunk\", \"trust\", \"truth\", \"tumor\", \"tuned\", \"twice\", \"twist\", \"ultra\", \"uncle\", \"under\", \"union\", \"unity\", \"until\", \"upper\", \"upset\", \"urban\", \"usage\", \"usual\", \"utter\", \"valid\", \"value\", \"valve\", \"vapor\", \"vault\", \"venue\", \"verse\", \"video\", \"vigor\", \"vinyl\", \"viral\", \"virus\", \"visit\", \"vital\", \"vivid\", \"vocal\", \"vodka\", \"voice\", \"voter\", \"waste\", \"watch\", \"water\", \"weary\", \"weave\", \"wedge\", \"weigh\", \"weird\", \"whale\", \"wheat\", \"wheel\", \"where\", \"which\", \"while\", \"whine\", \"white\", \"whole\", \"whose\", \"widen\", \"wider\", \"widow\", \"width\", \"witch\", \"woman\", \"women\", \"works\", \"world\", \"worry\", \"worse\", \"worst\", \"worth\", \"would\", \"wound\", \"wrath\", \"write\", \"wrong\", \"wrote\", \"yacht\", \"yield\", \"young\", \"yours\", \"youth\", \"zebra\", \"zones\",\n  \"accept\", \"access\", \"across\", \"action\", \"active\", \"actual\", \"advice\", \"advise\", \"affair\", \"affect\", \"afford\", \"afraid\", \"agency\", \"agenda\", \"almost\", \"always\", \"amount\", \"animal\", \"annual\", \"answer\", \"anyone\", \"appear\", \"around\", \"arrive\", \"artist\", \"aspect\", \"assume\", \"attack\", \"attend\", \"author\", \"avenue\", \"battle\", \"beauty\", \"became\", \"become\", \"before\", \"behalf\", \"behind\", \"belief\", \"belong\", \"beside\", \"better\", \"beyond\", \"bigger\", \"border\", \"bother\", \"bottom\", \"bought\", \"branch\", \"bridge\", \"bright\", \"brings\", \"broken\", \"budget\", \"burden\", \"button\", \"called\", \"camera\", \"campus\", \"cancer\", \"cannot\", \"career\", \"castle\", \"caught\", \"center\", \"centre\", \"chance\", \"change\", \"charge\", \"choice\", \"choose\", \"church\", \"circle\", \"client\", \"closed\", \"closer\", \"column\", \"combat\", \"coming\", \"common\", \"county\", \"couple\", \"course\", \"covers\", \"create\", \"credit\", \"crisis\", \"custom\", \"damage\", \"danger\", \"debate\", \"decade\", \"decide\", \"deeply\", \"defeat\", \"defend\", \"define\", \"degree\", \"demand\", \"depend\", \"desert\", \"design\", \"desire\", \"detail\", \"detect\", \"device\", \"dinner\", \"direct\", \"doctor\", \"dollar\", \"domain\", \"double\", \"driven\", \"driver\", \"during\", \"easily\", \"eating\", \"editor\", \"effect\", \"effort\", \"either\", \"emerge\", \"employ\", \"enable\", \"ending\", \"energy\", \"engage\", \"engine\", \"enough\", \"ensure\", \"entire\", \"entity\", \"equity\", \"escape\", \"estate\", \"ethnic\", \"exceed\", \"except\", \"expand\", \"expect\", \"expert\", \"export\", \"extend\", \"extent\", \"fabric\", \"factor\", \"fairly\", \"fallen\", \"family\", \"famous\", \"father\", \"fellow\", \"figure\", \"filing\", \"finger\", \"finish\", \"flight\", \"flower\", \"flying\", \"follow\", \"forced\", \"forest\", \"forget\", \"formal\", \"format\", \"former\", \"freeze\", \"friend\", \"frozen\", \"future\", \"garden\", \"gather\", \"gender\", \"genius\", \"global\", \"golden\", \"gotten\", \"ground\", \"growth\", \"guilty\", \"hammer\", \"handle\", \"happen\", \"hardly\", \"headed\", \"health\", \"heaven\", \"height\", \"hidden\", \"highly\", \"honest\", \"hoping\", \"horror\", \"hunter\", \"ignore\", \"impact\", \"import\", \"impose\", \"income\", \"indeed\", \"inform\", \"injury\", \"inside\", \"invest\", \"island\", \"itself\", \"jersey\", \"junior\", \"keeper\", \"killer\", \"labour\", \"latest\", \"latter\", \"launch\", \"lawyer\", \"leader\", \"league\", \"legend\", \"length\", \"lesson\", \"letter\", \"likely\", \"linear\", \"linked\", \"liquid\", \"listen\", \"little\", \"living\", \"losing\", \"luxury\", \"making\", \"manage\", \"manner\", \"manual\", \"margin\", \"marine\", \"market\", \"master\", \"matter\", \"medium\", \"member\", \"memory\", \"mental\", \"merely\", \"method\", \"middle\", \"miller\", \"mining\", \"minute\", \"mirror\", \"mobile\", \"modern\", \"modest\", \"moment\", \"mother\", \"motion\", \"moving\", \"murder\", \"museum\", \"mutual\", \"myself\", \"namely\", \"nation\", \"native\", \"nature\", \"nearby\", \"nearly\", \"needed\", \"negate\", \"nickel\", \"nobody\", \"normal\", \"notice\", \"notion\", \"number\", \"object\", \"obtain\", \"occupy\", \"office\", \"oldest\", \"online\", \"option\", \"orange\", \"origin\", \"output\", \"oxford\", \"packet\", \"palace\", \"parade\", \"parent\", \"patent\", \"patrol\", \"patron\", \"paying\", \"people\", \"period\", \"permit\", \"person\", \"phrase\", \"picked\", \"planet\", \"player\", \"please\", \"pledge\", \"plenty\", \"pocket\", \"poetry\", \"police\", \"policy\", \"polish\", \"poster\", \"potato\", \"prefer\", \"pretty\", \"prince\", \"prison\", \"profit\", \"proper\", \"proven\", \"public\", \"pursue\", \"puzzle\", \"racial\", \"random\", \"rarely\", \"rather\", \"rating\", \"reader\", \"really\", \"reason\", \"recall\", \"recent\", \"record\", \"reduce\", \"reform\", \"refuse\", \"regard\", \"region\", \"relate\", \"relief\", \"remain\", \"remind\", \"remote\", \"remove\", \"render\", \"repeat\", \"report\", \"rescue\", \"resist\", \"resort\", \"result\", \"retail\", \"retain\", \"retire\", \"return\", \"reveal\", \"review\", \"reward\", \"rights\", \"rising\", \"robust\", \"ruling\", \"runner\", \"sacred\", \"safely\", \"safety\", \"salary\", \"sample\", \"saving\", \"saying\", \"scared\", \"scheme\", \"school\", \"screen\", \"search\", \"season\", \"second\", \"secret\", \"sector\", \"secure\", \"seeing\", \"seeing\", \"select\", \"seller\", \"senate\", \"senior\", \"sensor\", \"series\", \"server\", \"settle\", \"severe\", \"shadow\", \"should\", \"shower\", \"signed\", \"silent\", \"silver\", \"simple\", \"simply\", \"single\", \"sister\", \"slight\", \"smooth\", \"soccer\", \"social\", \"sodium\", \"solely\", \"solved\", \"sought\", \"source\", \"sphere\", \"spirit\", \"spread\", \"spring\", \"square\", \"stable\", \"statue\", \"status\", \"steady\", \"strain\", \"strand\", \"stream\", \"street\", \"stress\", \"strict\", \"strike\", \"string\", \"strong\", \"struck\", \"studio\", \"stupid\", \"submit\", \"subtle\", \"suburb\", \"sudden\", \"suffer\", \"summer\", \"summit\", \"supply\", \"surely\", \"survey\", \"switch\", \"symbol\", \"system\", \"tablet\", \"taking\", \"talent\", \"target\", \"taught\", \"temple\", \"tender\", \"tennis\", \"terror\", \"thanks\", \"theory\", \"thirty\", \"though\", \"thread\", \"threat\", \"throne\", \"thrown\", \"ticket\", \"timber\", \"timing\", \"tissue\", \"toilet\", \"tongue\", \"toward\", \"travel\", \"treaty\", \"tribes\", \"tunnel\", \"turkey\", \"twelve\", \"twenty\", \"unable\", \"unique\", \"united\", \"unless\", \"unlike\", \"update\", \"useful\", \"valley\", \"varied\", \"vendor\", \"victim\", \"virgin\", \"virtue\", \"vision\", \"visual\", \"volume\", \"voting\", \"walker\", \"wallet\", \"warmth\", \"wealth\", \"weapon\", \"weekly\", \"weight\", \"wholly\", \"widely\", \"window\", \"winner\", \"winter\", \"wisdom\", \"within\", \"wonder\", \"wooden\", \"worker\", \"worthy\", \"writer\", \"yellow\",\n];\n\nconst DICTIONARY = new Set(COMMON_WORDS);\n\nconst VOWELS = \"AEIOU\";\nconst CONSONANTS = \"BCDFGHJKLMNPQRSTVWXYZ\";\n\nconst getRandomLetters = (): string[] => {\n  const letters: string[] = [];\n  \n  const vowelCount = 2 + Math.floor(Math.random() * 2);\n  for (let i = 0; i < vowelCount; i++) {\n    letters.push(VOWELS[Math.floor(Math.random() * VOWELS.length)]);\n  }\n  \n  while (letters.length < 7) {\n    letters.push(CONSONANTS[Math.floor(Math.random() * CONSONANTS.length)]);\n  }\n  \n  for (let i = letters.length - 1; i > 0; i--) {\n    const j = Math.floor(Math.random() * (i + 1));\n    [letters[i], letters[j]] = [letters[j], letters[i]];\n  }\n  \n  return letters;\n};\n\nconst canFormWord = (word: string, availableLetters: string[]): boolean => {\n  const letterCounts = new Map<string, number>();\n  for (const letter of availableLetters) {\n    letterCounts.set(letter, (letterCounts.get(letter) || 0) + 1);\n  }\n  \n  for (const char of word.toUpperCase()) {\n    const count = letterCounts.get(char) || 0;\n    if (count === 0) return false;\n    letterCounts.set(char, count - 1);\n  }\n  \n  return true;\n};\n\nconst isValidWordLocal = (word: string): boolean => {\n  return word.length >= 2 && DICTIONARY.has(word.toLowerCase());\n};\n\nconst getWordScore = (word: string): number => {\n  const len = word.length;\n  if (len <= 2) return 1;\n  if (len === 3) return 3;\n  if (len === 4) return 5;\n  if (len === 5) return 8;\n  if (len === 6) return 12;\n  return 15 + (len - 7) * 3;\n};\n\nconst findAIWords = (letters: string[], maxWords: number = 5): string[] => {\n  const foundWords: string[] = [];\n  const wordsToCheck = [...COMMON_WORDS].sort(() => Math.random() - 0.5);\n  \n  for (const word of wordsToCheck) {\n    if (foundWords.length >= maxWords) break;\n    if (word.length >= 3 && canFormWord(word, letters) && !foundWords.includes(word)) {\n      foundWords.push(word);\n    }\n  }\n  \n  return foundWords.sort((a, b) => b.length - a.length);\n};\n\nexport default function WordBattleGame({ stake, onGameEnd, isPractice }: WordBattleGameProps) {\n  const [letters, setLetters] = useState<string[]>([]);\n  const [playerWords, setPlayerWords] = useState<string[]>([]);\n  const [aiWords, setAIWords] = useState<string[]>([]);\n  const [currentWord, setCurrentWord] = useState(\"\");\n  const [timeLeft, setTimeLeft] = useState(60);\n  const [gamePhase, setGamePhase] = useState<\"loading\" | \"playing\" | \"ai_turn\" | \"results\">(\"loading\");\n  const [message, setMessage] = useState(\"\");\n  const [playerScore, setPlayerScore] = useState(0);\n  const [aiScore, setAIScore] = useState(0);\n  const [selectedIndices, setSelectedIndices] = useState<number[]>([]);\n  const [isValidating, setIsValidating] = useState(false);\n  const [letterHint, setLetterHint] = useState<string | null>(null);\n  const [funFact, setFunFact] = useState<string | null>(null);\n  const [aiPowered, setAiPowered] = useState(false);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  const fetchAILetters = async () => {\n    try {\n      const response = await fetch(\"/api/games/generate-letters\");\n      if (!response.ok) throw new Error(\"Failed to fetch letters\");\n      \n      const data: LetterGenerationResult = await response.json();\n      setLetters(data.letters);\n      setLetterHint(data.hint || null);\n      setAiPowered(!data.usedFallback);\n      setGamePhase(\"playing\");\n    } catch (error) {\n      console.error(\"Error fetching AI letters:\", error);\n      setLetters(getRandomLetters());\n      setAiPowered(false);\n      setGamePhase(\"playing\");\n    }\n  };\n\n  useEffect(() => {\n    fetchAILetters();\n  }, []);\n\n  useEffect(() => {\n    if (gamePhase === \"playing\") {\n      inputRef.current?.focus();\n    }\n  }, [gamePhase]);\n\n  useEffect(() => {\n    if (gamePhase !== \"playing\" || timeLeft <= 0) return;\n    \n    const timer = setInterval(() => {\n      setTimeLeft((prev) => {\n        if (prev <= 1) {\n          setGamePhase(\"ai_turn\");\n          return 0;\n        }\n        return prev - 1;\n      });\n    }, 1000);\n    \n    return () => clearInterval(timer);\n  }, [gamePhase, timeLeft]);\n\n  useEffect(() => {\n    if (gamePhase === \"ai_turn\") {\n      setMessage(\"AI is finding words...\");\n      \n      setTimeout(() => {\n        const aiFoundWords = findAIWords(letters, 3 + Math.floor(Math.random() * 3));\n        const filteredAIWords = aiFoundWords.filter((w) => !playerWords.includes(w.toUpperCase()));\n        \n        let totalAIScore = 0;\n        const wordsToShow: string[] = [];\n        \n        const showNextWord = (index: number) => {\n          if (index >= filteredAIWords.length) {\n            setAIScore(totalAIScore);\n            setTimeout(() => {\n              setGamePhase(\"results\");\n            }, 500);\n            return;\n          }\n          \n          const word = filteredAIWords[index];\n          wordsToShow.push(word);\n          setAIWords([...wordsToShow]);\n          totalAIScore += getWordScore(word);\n          \n          setTimeout(() => showNextWord(index + 1), 400);\n        };\n        \n        showNextWord(0);\n      }, 1000);\n    }\n  }, [gamePhase, letters, playerWords]);\n\n  useEffect(() => {\n    if (gamePhase === \"results\") {\n      const playerWon = playerScore > aiScore;\n      onGameEnd(playerWon, playerScore);\n    }\n  }, [gamePhase, playerScore, aiScore, onGameEnd]);\n\n  const handleLetterClick = (letter: string, index: number) => {\n    if (gamePhase !== \"playing\" || isValidating) return;\n    \n    if (selectedIndices.includes(index)) {\n      setSelectedIndices((prev) => prev.filter((i) => i !== index));\n      setCurrentWord((prev) => {\n        const pos = selectedIndices.indexOf(index);\n        return prev.slice(0, pos) + prev.slice(pos + 1);\n      });\n    } else {\n      setSelectedIndices((prev) => [...prev, index]);\n      setCurrentWord((prev) => prev + letter);\n    }\n  };\n\n  const validateWordWithAI = async (word: string): Promise<WordValidationResult> => {\n    try {\n      const response = await apiRequest(\"POST\", \"/api/games/validate-word\", { word });\n      const data = await response.json() as WordValidationResult;\n      if (typeof data.valid !== 'boolean') {\n        throw new Error(\"Invalid response format\");\n      }\n      return {\n        valid: data.valid,\n        feedback: data.feedback || (data.valid ? \"Word accepted!\" : \"Not a valid word.\"),\n        usedFallback: data.usedFallback ?? false\n      };\n    } catch (error) {\n      console.error(\"Error validating word:\", error);\n      const isValid = isValidWordLocal(word);\n      return {\n        valid: isValid,\n        feedback: isValid ? \"Word accepted!\" : \"Not a valid word.\",\n        usedFallback: true\n      };\n    }\n  };\n\n  const handleSubmitWord = async () => {\n    if (gamePhase !== \"playing\" || isValidating) return;\n    \n    const word = currentWord.toUpperCase();\n    \n    if (word.length < 2) {\n      setMessage(\"Word must be at least 2 letters!\");\n      return;\n    }\n    \n    if (playerWords.includes(word)) {\n      setMessage(\"You already used that word!\");\n      setCurrentWord(\"\");\n      setSelectedIndices([]);\n      return;\n    }\n    \n    if (!canFormWord(word, letters)) {\n      setMessage(\"You can only use available letters!\");\n      setCurrentWord(\"\");\n      setSelectedIndices([]);\n      return;\n    }\n    \n    setIsValidating(true);\n    setMessage(\"Checking word...\");\n    setFunFact(null);\n    \n    try {\n      const result = await validateWordWithAI(word);\n      \n      if (!result.valid) {\n        setMessage(result.feedback || \"Not a valid word!\");\n        setCurrentWord(\"\");\n        setSelectedIndices([]);\n        setIsValidating(false);\n        setTimeout(() => setMessage(\"\"), 2500);\n        return;\n      }\n      \n      const score = getWordScore(word);\n      setPlayerWords((prev) => [...prev, word]);\n      setPlayerScore((prev) => prev + score);\n      \n      if (result.funFact) {\n        setFunFact(result.funFact);\n        setMessage(`+${score} points! ${result.feedback || \"\"}`);\n        setTimeout(() => {\n          setFunFact(null);\n          setMessage(\"\");\n        }, 4000);\n      } else {\n        setMessage(`+${score} points! ${result.feedback || \"\"}`);\n        setTimeout(() => setMessage(\"\"), 2000);\n      }\n      \n      setCurrentWord(\"\");\n      setSelectedIndices([]);\n    } catch (error) {\n      if (isValidWordLocal(word)) {\n        const score = getWordScore(word);\n        setPlayerWords((prev) => [...prev, word]);\n        setPlayerScore((prev) => prev + score);\n        setMessage(`+${score} points!`);\n        setTimeout(() => setMessage(\"\"), 1500);\n      } else {\n        setMessage(\"Not a valid word!\");\n        setTimeout(() => setMessage(\"\"), 1500);\n      }\n      setCurrentWord(\"\");\n      setSelectedIndices([]);\n    } finally {\n      setIsValidating(false);\n    }\n  };\n\n  const handleKeyPress = (e: React.KeyboardEvent) => {\n    if (e.key === \"Enter\") {\n      handleSubmitWord();\n    } else if (e.key === \"Backspace\" && selectedIndices.length > 0) {\n      setSelectedIndices((prev) => prev.slice(0, -1));\n      setCurrentWord((prev) => prev.slice(0, -1));\n    }\n  };\n\n  const clearWord = () => {\n    setCurrentWord(\"\");\n    setSelectedIndices([]);\n    setMessage(\"\");\n    setFunFact(null);\n  };\n\n  const resetGame = async () => {\n    setPlayerWords([]);\n    setAIWords([]);\n    setCurrentWord(\"\");\n    setTimeLeft(60);\n    setMessage(\"\");\n    setPlayerScore(0);\n    setAIScore(0);\n    setSelectedIndices([]);\n    setLetterHint(null);\n    setFunFact(null);\n    setGamePhase(\"loading\");\n    await fetchAILetters();\n  };\n\n  const winner = playerScore > aiScore ? \"player\" : playerScore < aiScore ? \"ai\" : \"tie\";\n\n  if (gamePhase === \"loading\") {\n    return (\n      <div className=\"w-full max-w-lg mx-auto\">\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12 gap-4\">\n            <motion.div\n              animate={{ rotate: 360 }}\n              transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\n            >\n              <Sparkles className=\"h-8 w-8 text-primary\" />\n            </motion.div>\n            <p className=\"text-muted-foreground\">AI is preparing your letters...</p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"w-full max-w-lg mx-auto space-y-4\">\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <div className=\"flex items-center justify-between gap-2\">\n            <CardTitle className=\"text-lg flex items-center gap-2 flex-wrap\">\n              Word Battle\n              {aiPowered && (\n                <Badge variant=\"outline\" className=\"text-xs gap-1\">\n                  <Zap className=\"h-3 w-3\" />\n                  AI-Powered\n                </Badge>\n              )}\n              {!isPractice && (\n                <Badge variant=\"secondary\" className=\"text-xs\">\n                  Stake: {stake} NGN\n                </Badge>\n              )}\n              {isPractice && (\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  Practice\n                </Badge>\n              )}\n            </CardTitle>\n            <div className=\"flex items-center gap-2\">\n              <Badge className=\"bg-primary/20\">\n                <Clock className=\"h-3 w-3 mr-1\" />\n                {timeLeft}s\n              </Badge>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-2\">\n              <User className=\"h-4 w-4 text-primary\" />\n              <span className=\"font-bold\">{playerScore}</span>\n              <span className=\"text-xs text-muted-foreground\">pts</span>\n            </div>\n            <Progress value={(timeLeft / 60) * 100} className=\"flex-1 h-2\" />\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-xs text-muted-foreground\">pts</span>\n              <span className=\"font-bold\">{aiScore}</span>\n              <Bot className=\"h-4 w-4 text-muted-foreground\" />\n            </div>\n          </div>\n\n          {letterHint && gamePhase === \"playing\" && (\n            <motion.div\n              initial={{ opacity: 0, y: -10 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"flex items-center gap-2 p-2 bg-primary/10 rounded-md text-sm\"\n            >\n              <Lightbulb className=\"h-4 w-4 text-primary flex-shrink-0\" />\n              <span className=\"text-muted-foreground\">{letterHint}</span>\n            </motion.div>\n          )}\n\n          <div className=\"flex flex-wrap justify-center gap-2 p-4 bg-muted/30 rounded-md\">\n            {letters.map((letter, index) => (\n              <motion.button\n                key={index}\n                className={`w-12 h-12 rounded-md font-bold text-xl border-2 transition-colors\n                  ${selectedIndices.includes(index) \n                    ? \"bg-primary text-primary-foreground border-primary\" \n                    : \"bg-card border-border\"\n                  }\n                  ${isValidating ? \"opacity-50 cursor-not-allowed\" : \"\"}`}\n                whileHover={{ scale: isValidating ? 1 : 1.05 }}\n                whileTap={{ scale: isValidating ? 1 : 0.95 }}\n                onClick={() => handleLetterClick(letter, index)}\n                disabled={gamePhase !== \"playing\" || isValidating}\n                data-testid={`letter-${index}`}\n              >\n                {letter}\n              </motion.button>\n            ))}\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex gap-2\">\n              <Input\n                ref={inputRef}\n                value={currentWord}\n                onChange={(e) => {\n                  if (isValidating) return;\n                  const newWord = e.target.value.toUpperCase();\n                  if (newWord.length > currentWord.length) {\n                    const newChar = newWord[newWord.length - 1];\n                    const availableIndex = letters.findIndex((l, i) => l === newChar && !selectedIndices.includes(i));\n                    if (availableIndex !== -1) {\n                      setSelectedIndices((prev) => [...prev, availableIndex]);\n                      setCurrentWord(newWord);\n                    }\n                  } else {\n                    setCurrentWord(newWord);\n                    setSelectedIndices(selectedIndices.slice(0, newWord.length));\n                  }\n                }}\n                onKeyDown={handleKeyPress}\n                placeholder=\"Type or click letters...\"\n                className=\"flex-1 text-center font-bold uppercase\"\n                disabled={gamePhase !== \"playing\" || isValidating}\n                data-testid=\"input-word\"\n              />\n              <Button\n                onClick={clearWord}\n                variant=\"outline\"\n                size=\"icon\"\n                disabled={gamePhase !== \"playing\" || isValidating}\n                data-testid=\"button-clear\"\n              >\n                <X className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                onClick={handleSubmitWord}\n                disabled={gamePhase !== \"playing\" || currentWord.length < 2 || isValidating}\n                data-testid=\"button-submit-word\"\n              >\n                {isValidating ? (\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                ) : (\n                  <Send className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n            \n            <AnimatePresence mode=\"wait\">\n              {message && (\n                <motion.div\n                  key=\"message\"\n                  initial={{ opacity: 0, y: -10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  exit={{ opacity: 0 }}\n                  className=\"text-center\"\n                >\n                  <p className={`text-sm font-medium ${\n                    message.includes(\"+\") || message.includes(\"points\") \n                      ? \"text-green-600 dark:text-green-400\" \n                      : message.includes(\"Checking\") \n                        ? \"text-muted-foreground\"\n                        : \"text-destructive\"\n                  }`}>\n                    {isValidating && <Loader2 className=\"h-3 w-3 inline mr-1 animate-spin\" />}\n                    {message}\n                  </p>\n                </motion.div>\n              )}\n              {funFact && (\n                <motion.div\n                  key=\"funfact\"\n                  initial={{ opacity: 0, y: 5 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  exit={{ opacity: 0 }}\n                  className=\"flex items-start gap-2 p-2 bg-muted/50 rounded-md\"\n                >\n                  <Sparkles className=\"h-4 w-4 text-primary flex-shrink-0 mt-0.5\" />\n                  <p className=\"text-xs text-muted-foreground\">{funFact}</p>\n                </motion.div>\n              )}\n            </AnimatePresence>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 text-sm font-medium\">\n                <User className=\"h-4 w-4\" />\n                Your Words ({playerWords.length})\n              </div>\n              <ScrollArea className=\"h-32 rounded-md border p-2\">\n                <div className=\"space-y-1\">\n                  {playerWords.map((word, i) => (\n                    <motion.div\n                      key={i}\n                      initial={{ opacity: 0, x: -10 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      className=\"flex items-center justify-between text-sm\"\n                    >\n                      <span className=\"font-mono\">{word}</span>\n                      <Badge variant=\"secondary\" className=\"text-xs\">\n                        +{getWordScore(word)}\n                      </Badge>\n                    </motion.div>\n                  ))}\n                </div>\n              </ScrollArea>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 text-sm font-medium\">\n                <Bot className=\"h-4 w-4\" />\n                AI Words ({aiWords.length})\n              </div>\n              <ScrollArea className=\"h-32 rounded-md border p-2\">\n                <div className=\"space-y-1\">\n                  {aiWords.map((word, i) => (\n                    <motion.div\n                      key={i}\n                      initial={{ opacity: 0, x: 10 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      className=\"flex items-center justify-between text-sm\"\n                    >\n                      <span className=\"font-mono uppercase\">{word}</span>\n                      <Badge variant=\"secondary\" className=\"text-xs\">\n                        +{getWordScore(word)}\n                      </Badge>\n                    </motion.div>\n                  ))}\n                </div>\n              </ScrollArea>\n            </div>\n          </div>\n\n          {gamePhase === \"results\" && (\n            <motion.div\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"text-center space-y-4 p-4 bg-muted/50 rounded-md\"\n            >\n              <div className=\"flex items-center justify-center gap-2\">\n                <Trophy className={`h-8 w-8 ${winner === \"player\" ? \"text-yellow-500\" : winner === \"tie\" ? \"text-muted-foreground\" : \"text-muted-foreground\"}`} />\n                <p className=\"text-xl font-bold\">\n                  {winner === \"player\" ? \"You Won!\" : winner === \"tie\" ? \"It's a Tie!\" : \"AI Won!\"}\n                </p>\n              </div>\n              <div className=\"flex justify-center gap-8\">\n                <div className=\"text-center\">\n                  <p className=\"text-2xl font-bold\">{playerScore}</p>\n                  <p className=\"text-sm text-muted-foreground\">Your Score</p>\n                </div>\n                <div className=\"text-center\">\n                  <p className=\"text-2xl font-bold\">{aiScore}</p>\n                  <p className=\"text-sm text-muted-foreground\">AI Score</p>\n                </div>\n              </div>\n              {!isPractice && (\n                <p className=\"text-sm text-muted-foreground\">\n                  {winner === \"player\" \n                    ? `You earned ${stake * 2 * 0.95} NGN!` \n                    : winner === \"tie\"\n                    ? \"Stakes returned.\"\n                    : `You lost ${stake} NGN.`}\n                </p>\n              )}\n              <Button onClick={resetGame} variant=\"outline\" data-testid=\"button-play-again\">\n                <RotateCcw className=\"h-4 w-4 mr-2\" />\n                Play Again\n              </Button>\n            </motion.div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":46722,"size_tokens":null},"client/src/pages/seller-dashboard.tsx":{"content":"import { useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Plus, Edit, Trash2, Eye, TrendingUp, ShoppingBag, MessageSquare } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport type { Product } from \"@shared/schema\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\n\nexport default function SellerDashboard() {\n  const { user, isLoading: authLoading, isSeller } = useAuth();\n  const { toast } = useToast();\n\n  // Redirect if not seller\n  useEffect(() => {\n    if (!authLoading && !isSeller) {\n      toast({\n        title: \"Access Denied\",\n        description: \"You need to be a seller to access this page\",\n        variant: \"destructive\",\n      });\n      window.location.href = \"/\";\n    }\n  }, [authLoading, isSeller, toast]);\n\n  const { data: products, isLoading } = useQuery<Product[]>({\n    queryKey: [\"/api/products/my-listings\"],\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"DELETE\", `/api/products/${id}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/products/my-listings\"] });\n      toast({\n        title: \"Success\",\n        description: \"Product deleted successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete product\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (authLoading || !user) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Skeleton className=\"h-64\" />\n      </div>\n    );\n  }\n\n  const totalProducts = products?.length || 0;\n  const activeProducts = products?.filter((p) => p.isAvailable).length || 0;\n  const totalViews = products?.reduce((sum, p) => sum + (p.views || 0), 0) || 0;\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <div className=\"flex items-center justify-between mb-8\">\n        <h1 className=\"text-3xl font-bold\">Seller Dashboard</h1>\n        <Button asChild data-testid=\"button-create-listing\">\n          <Link href=\"/products/new\">\n            <Plus className=\"mr-2 h-4 w-4\" />\n            New Listing\n          </Link>\n        </Button>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid gap-6 md:grid-cols-3 mb-8\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Listings</CardTitle>\n            <ShoppingBag className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-listings\">{totalProducts}</div>\n            <p className=\"text-xs text-muted-foreground\">\n              {activeProducts} active\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Views</CardTitle>\n            <Eye className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-views\">{totalViews}</div>\n            <p className=\"text-xs text-muted-foreground\">\n              Across all listings\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Sales</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-sales\">\n              {user.totalSales || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              All time sales\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Listings Table */}\n      <Card>\n        <CardHeader>\n          <CardTitle>My Listings</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"space-y-4\">\n              {[...Array(5)].map((_, i) => (\n                <Skeleton key={i} className=\"h-16\" />\n              ))}\n            </div>\n          ) : products && products.length > 0 ? (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Product</TableHead>\n                    <TableHead>Price</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Views</TableHead>\n                    <TableHead className=\"text-right\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {products.map((product) => (\n                    <TableRow key={product.id}>\n                      <TableCell>\n                        <div className=\"flex items-center gap-3\">\n                          <img\n                            src={product.images[0] || \"/placeholder-product.png\"}\n                            alt={product.title}\n                            className=\"h-12 w-12 rounded object-cover\"\n                            loading=\"lazy\"\n                          />\n                          <div>\n                            <p className=\"font-medium line-clamp-1\" data-testid={`text-product-title-${product.id}`}>\n                              {product.title}\n                            </p>\n                            <p className=\"text-sm text-muted-foreground\">\n                              {product.condition}\n                            </p>\n                          </div>\n                        </div>\n                      </TableCell>\n                      <TableCell className=\"font-medium\" data-testid={`text-product-price-${product.id}`}>\n                        ₦{parseFloat(product.price as string).toLocaleString()}\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant={product.isAvailable ? \"default\" : \"secondary\"}>\n                          {product.isAvailable ? \"Active\" : \"Inactive\"}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>{product.views || 0}</TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex justify-end gap-2\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            asChild\n                            data-testid={`button-view-${product.id}`}\n                          >\n                            <Link href={`/products/${product.id}`}>\n                              <Eye className=\"h-4 w-4\" />\n                            </Link>\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            asChild\n                            data-testid={`button-edit-${product.id}`}\n                          >\n                            <Link href={`/products/${product.id}/edit`}>\n                              <Edit className=\"h-4 w-4\" />\n                            </Link>\n                          </Button>\n                          <AlertDialog>\n                            <AlertDialogTrigger asChild>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                data-testid={`button-delete-${product.id}`}\n                              >\n                                <Trash2 className=\"h-4 w-4\" />\n                              </Button>\n                            </AlertDialogTrigger>\n                            <AlertDialogContent>\n                              <AlertDialogHeader>\n                                <AlertDialogTitle>Delete Listing</AlertDialogTitle>\n                                <AlertDialogDescription>\n                                  Are you sure you want to delete this listing? This action cannot be undone.\n                                </AlertDialogDescription>\n                              </AlertDialogHeader>\n                              <AlertDialogFooter>\n                                <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                <AlertDialogAction\n                                  onClick={() => deleteMutation.mutate(product.id)}\n                                >\n                                  Delete\n                                </AlertDialogAction>\n                              </AlertDialogFooter>\n                            </AlertDialogContent>\n                          </AlertDialog>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          ) : (\n            <div className=\"text-center py-12\">\n              <ShoppingBag className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n              <p className=\"text-lg font-medium\">No listings yet</p>\n              <p className=\"text-sm text-muted-foreground mt-2 mb-4\">\n                Start selling by creating your first listing\n              </p>\n              <Button asChild>\n                <Link href=\"/products/new\">\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  Create Listing\n                </Link>\n              </Button>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":10471,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"client/src/pages/announcements.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  Megaphone, \n  Sparkles, \n  AlertTriangle, \n  Pin, \n  CheckCircle2, \n  Circle,\n  Eye\n} from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport type { Announcement, User } from \"@shared/schema\";\n\ntype AnnouncementWithAuthor = Announcement & { author: User; isRead?: boolean };\n\nconst categoryConfig = {\n  update: { \n    label: \"Update\", \n    icon: Megaphone, \n    variant: \"default\" as const,\n    className: \"bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-500/30\"\n  },\n  feature: { \n    label: \"New Feature\", \n    icon: Sparkles, \n    variant: \"default\" as const,\n    className: \"bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/30\"\n  },\n  alert: { \n    label: \"Alert\", \n    icon: AlertTriangle, \n    variant: \"destructive\" as const,\n    className: \"bg-red-500/10 text-red-600 dark:text-red-400 border-red-500/30\"\n  },\n};\n\nconst priorityConfig = {\n  low: { label: \"Low\", className: \"text-muted-foreground\" },\n  normal: { label: \"Normal\", className: \"\" },\n  high: { label: \"High\", className: \"font-semibold\" },\n};\n\nexport default function AnnouncementsPage() {\n  const { user } = useAuth();\n\n  const { data: announcements, isLoading } = useQuery<AnnouncementWithAuthor[]>({\n    queryKey: [\"/api/announcements\"],\n    refetchOnMount: true,\n  });\n\n  const markAsReadMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"POST\", `/api/announcements/${id}/read`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/announcements\"] });\n    },\n  });\n\n  const handleMarkAsRead = (id: string, e: React.MouseEvent) => {\n    e.stopPropagation();\n    markAsReadMutation.mutate(id);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 max-w-3xl\">\n        <div className=\"mb-8\">\n          <Skeleton className=\"h-8 w-64 mb-2\" />\n          <Skeleton className=\"h-4 w-96\" />\n        </div>\n        <div className=\"space-y-4\">\n          {[...Array(5)].map((_, i) => (\n            <Skeleton key={i} className=\"h-48\" />\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  const pinnedAnnouncements = announcements?.filter(a => a.isPinned) || [];\n  const regularAnnouncements = announcements?.filter(a => !a.isPinned) || [];\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 max-w-3xl\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold flex items-center gap-3\" data-testid=\"text-page-title\">\n          <Megaphone className=\"h-8 w-8\" />\n          Campus Updates\n        </h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Stay informed with the latest news and updates from the EKSU marketplace\n        </p>\n      </div>\n\n      {announcements && announcements.length === 0 && (\n        <Card className=\"text-center py-16\">\n          <CardContent>\n            <Megaphone className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n            <h3 className=\"text-xl font-semibold mb-2\">No Announcements Yet</h3>\n            <p className=\"text-muted-foreground\">\n              Check back later for updates from the marketplace team.\n            </p>\n          </CardContent>\n        </Card>\n      )}\n\n      {pinnedAnnouncements.length > 0 && (\n        <div className=\"mb-8\">\n          <div className=\"flex items-center gap-2 mb-4\">\n            <Pin className=\"h-5 w-5 text-yellow-500\" />\n            <h2 className=\"text-lg font-semibold\">Pinned</h2>\n          </div>\n          <div className=\"space-y-4\">\n            {pinnedAnnouncements.map((announcement) => (\n              <AnnouncementCard\n                key={announcement.id}\n                announcement={announcement}\n                onMarkAsRead={handleMarkAsRead}\n                isPending={markAsReadMutation.isPending}\n                user={user}\n              />\n            ))}\n          </div>\n        </div>\n      )}\n\n      {regularAnnouncements.length > 0 && (\n        <div>\n          {pinnedAnnouncements.length > 0 && (\n            <div className=\"flex items-center gap-2 mb-4\">\n              <h2 className=\"text-lg font-semibold\">Recent Updates</h2>\n            </div>\n          )}\n          <div className=\"space-y-4\">\n            {regularAnnouncements.map((announcement) => (\n              <AnnouncementCard\n                key={announcement.id}\n                announcement={announcement}\n                onMarkAsRead={handleMarkAsRead}\n                isPending={markAsReadMutation.isPending}\n                user={user}\n              />\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction AnnouncementCard({\n  announcement,\n  onMarkAsRead,\n  isPending,\n  user,\n}: {\n  announcement: AnnouncementWithAuthor;\n  onMarkAsRead: (id: string, e: React.MouseEvent) => void;\n  isPending: boolean;\n  user: any;\n}) {\n  const categoryInfo = categoryConfig[announcement.category as keyof typeof categoryConfig] || categoryConfig.update;\n  const priorityInfo = priorityConfig[announcement.priority as keyof typeof priorityConfig] || priorityConfig.normal;\n  const CategoryIcon = categoryInfo.icon;\n  \n  const isRead = announcement.isRead;\n\n  return (\n    <Card \n      className={`transition-all ${!isRead ? 'border-l-4 border-l-primary' : ''}`}\n      data-testid={`card-announcement-${announcement.id}`}\n    >\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n          <div className=\"flex items-center gap-2 flex-wrap\">\n            <Badge className={categoryInfo.className} variant=\"outline\">\n              <CategoryIcon className=\"h-3 w-3 mr-1\" />\n              {categoryInfo.label}\n            </Badge>\n            {announcement.isPinned && (\n              <Badge variant=\"secondary\" className=\"gap-1\">\n                <Pin className=\"h-3 w-3\" />\n                Pinned\n              </Badge>\n            )}\n            {announcement.priority === \"high\" && (\n              <Badge variant=\"destructive\" className=\"text-xs\">\n                High Priority\n              </Badge>\n            )}\n          </div>\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            {announcement.views !== null && announcement.views > 0 && (\n              <span className=\"flex items-center gap-1\">\n                <Eye className=\"h-3 w-3\" />\n                {announcement.views}\n              </span>\n            )}\n            <span>\n              {formatDistanceToNow(new Date(announcement.createdAt!), { addSuffix: true })}\n            </span>\n          </div>\n        </div>\n        <CardTitle className={`text-xl mt-2 ${priorityInfo.className}`}>\n          {announcement.title}\n        </CardTitle>\n        {announcement.author && (\n          <CardDescription>\n            Posted by {announcement.author.firstName} {announcement.author.lastName}\n          </CardDescription>\n        )}\n      </CardHeader>\n      <CardContent>\n        <div className=\"prose prose-sm dark:prose-invert max-w-none\">\n          <p className=\"whitespace-pre-wrap\">{announcement.content}</p>\n        </div>\n        \n        {user && !isRead && (\n          <div className=\"mt-4 pt-4 border-t flex justify-end\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={(e) => onMarkAsRead(announcement.id, e)}\n              disabled={isPending}\n              className=\"gap-2\"\n              data-testid={`button-mark-read-${announcement.id}`}\n            >\n              {isRead ? (\n                <>\n                  <CheckCircle2 className=\"h-4 w-4 text-green-500\" />\n                  Read\n                </>\n              ) : (\n                <>\n                  <Circle className=\"h-4 w-4\" />\n                  Mark as Read\n                </>\n              )}\n            </Button>\n          </div>\n        )}\n        \n        {user && isRead && (\n          <div className=\"mt-4 pt-4 border-t flex justify-end\">\n            <span className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n              <CheckCircle2 className=\"h-4 w-4 text-green-500\" />\n              You've read this update\n            </span>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":8615,"size_tokens":null},"client/src/contexts/ThemeContext.tsx":{"content":"import { createContext, useContext, useEffect, useState, useMemo, useCallback } from \"react\";\n\nexport type Theme = \"light\" | \"dim\" | \"lights-out\" | \"sunset\" | \"ocean\" | \"forest\" | \"sepia\" | \"high-contrast\";\n\ninterface ThemeContextType {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n  isInitialized: boolean;\n}\n\nconst ThemeContext = createContext<ThemeContextType | undefined>(undefined);\n\nconst validThemes: Theme[] = [\"light\", \"dim\", \"lights-out\", \"sunset\", \"ocean\", \"forest\", \"sepia\", \"high-contrast\"];\n\nconst THEME_CLASSES = {\n  light: [\"light\"],\n  dim: [\"dark\", \"dim\"],\n  \"lights-out\": [\"dark\", \"lights-out\"],\n  sunset: [\"dark\", \"sunset\"],\n  ocean: [\"dark\", \"ocean\"],\n  forest: [\"dark\", \"forest\"],\n  sepia: [\"light\", \"sepia\"],\n  \"high-contrast\": [\"dark\", \"high-contrast\"],\n} as const;\n\nfunction getInitialTheme(): Theme {\n  if (typeof window === \"undefined\") return \"light\";\n  \n  try {\n    const stored = localStorage.getItem(\"theme\");\n    if (stored && validThemes.includes(stored as Theme)) {\n      return stored as Theme;\n    }\n    if (stored === \"dark\") {\n      return \"dim\";\n    }\n  } catch {\n  }\n  return \"light\";\n}\n\nfunction applyThemeToDOM(theme: Theme) {\n  if (typeof window === \"undefined\") return;\n  \n  const root = document.documentElement;\n  root.classList.remove(...validThemes, \"dark\", \"light\");\n  \n  const themeClasses = THEME_CLASSES[theme];\n  root.classList.add(...themeClasses);\n}\n\nconst initialTheme = getInitialTheme();\napplyThemeToDOM(initialTheme);\n\nexport function ThemeProvider({ children }: { children: React.ReactNode }) {\n  const [theme, setThemeState] = useState<Theme>(initialTheme);\n  const [isInitialized, setIsInitialized] = useState(true);\n\n  useEffect(() => {\n    applyThemeToDOM(theme);\n    \n    try {\n      localStorage.setItem(\"theme\", theme);\n    } catch {\n    }\n  }, [theme]);\n\n  const setTheme = useCallback((newTheme: Theme) => {\n    setThemeState(newTheme);\n  }, []);\n\n  const value = useMemo(() => ({\n    theme,\n    setTheme,\n    isInitialized,\n  }), [theme, setTheme, isInitialized]);\n\n  return (\n    <ThemeContext.Provider value={value}>\n      {children}\n    </ThemeContext.Provider>\n  );\n}\n\nexport function useTheme() {\n  const context = useContext(ThemeContext);\n  if (!context) {\n    throw new Error(\"useTheme must be used within ThemeProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":2331,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/pages/landing.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { \n  ShoppingBag, \n  MessageSquare, \n  Shield, \n  TrendingUp, \n  Menu, \n  X, \n  Wallet,\n  Users,\n  Lock,\n  Zap,\n  CheckCircle,\n  ArrowRight,\n  Star,\n  Store\n} from \"lucide-react\";\nimport { AuthModal } from \"@/components/AuthModal\";\nimport { ThemeToggle } from \"@/components/ThemeToggle\";\nimport { Sheet, SheetContent, SheetTrigger } from \"@/components/ui/sheet\";\n\nexport default function Landing() {\n  const [authModalOpen, setAuthModalOpen] = useState(false);\n  const [authModalTab, setAuthModalTab] = useState<\"signin\" | \"signup\">(\"signup\");\n  const [authModalDefaultRole, setAuthModalDefaultRole] = useState<\"buyer\" | \"seller\" | \"both\">(\"both\");\n  const [authModalReferralCode, setAuthModalReferralCode] = useState(\"\");\n  const [showSplash, setShowSplash] = useState(true);\n  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);\n\n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const refCode = urlParams.get(\"ref\");\n    \n    if (refCode) {\n      setAuthModalReferralCode(refCode.toUpperCase());\n    }\n  }, []);\n\n  useEffect(() => {\n    const hasSeenSplash = sessionStorage.getItem(\"hasSeenSplash\");\n    if (hasSeenSplash) {\n      setShowSplash(false);\n      const urlParams = new URLSearchParams(window.location.search);\n      const refCode = urlParams.get(\"ref\");\n      if (refCode) {\n        setAuthModalTab(\"signup\");\n        setAuthModalOpen(true);\n      }\n    } else {\n      const timer = setTimeout(() => {\n        setShowSplash(false);\n        sessionStorage.setItem(\"hasSeenSplash\", \"true\");\n        const urlParams = new URLSearchParams(window.location.search);\n        const refCode = urlParams.get(\"ref\");\n        if (refCode) {\n          setAuthModalTab(\"signup\");\n          setAuthModalOpen(true);\n        }\n      }, 2500);\n      return () => clearTimeout(timer);\n    }\n  }, []);\n\n  const handleGetStarted = () => {\n    setAuthModalTab(\"signup\");\n    setAuthModalDefaultRole(\"both\");\n    setAuthModalOpen(true);\n  };\n\n  const handleBrowse = () => {\n    setAuthModalTab(\"signin\");\n    setAuthModalOpen(true);\n  };\n\n  const handleBecomeMerchant = () => {\n    setAuthModalTab(\"signup\");\n    setAuthModalDefaultRole(\"seller\");\n    setAuthModalOpen(true);\n  };\n\n  const scrollToSection = (id: string) => {\n    const element = document.getElementById(id);\n    if (element) {\n      element.scrollIntoView({ behavior: \"smooth\" });\n    }\n    setMobileMenuOpen(false);\n  };\n\n  const navLinks = [\n    { label: \"Home\", href: \"#home\" },\n    { label: \"About\", href: \"#about\" },\n    { label: \"Features\", href: \"#features\" },\n    { label: \"How it Works\", href: \"#how-it-works\" },\n    { label: \"Become a Merchant\", href: \"#merchant\" },\n  ];\n\n  if (showSplash) {\n    return (\n      <div className=\"fixed inset-0 z-[100] flex items-center justify-center bg-background\">\n        <div className=\"flex flex-col items-center animate-fade-in\">\n          <div className=\"rounded-full bg-primary/10 p-8 animate-pulse-scale\">\n            <ShoppingBag className=\"h-16 w-16 text-primary\" />\n          </div>\n          <h1 className=\"mt-6 text-2xl font-bold text-primary animate-slide-up\">\n            EKSU Marketplace\n          </h1>\n          <p className=\"mt-2 text-muted-foreground animate-fade-in-delayed\">\n            Your Campus Trading Hub\n          </p>\n          <div className=\"mt-6 h-1 w-24 rounded-full bg-primary/20 overflow-hidden animate-fade-in-delayed-2\">\n            <div className=\"h-full bg-primary animate-progress-fill\" />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen\" id=\"home\">\n      <header className=\"sticky top-0 z-50 border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"flex h-16 items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-2\">\n              <ShoppingBag className=\"h-6 w-6 text-primary\" />\n              <span className=\"text-lg font-bold\">EKSU Marketplace</span>\n            </div>\n\n            <nav className=\"hidden md:flex items-center gap-6\">\n              {navLinks.map((link) => (\n                <button\n                  key={link.label}\n                  onClick={() => scrollToSection(link.href.replace(\"#\", \"\"))}\n                  className=\"text-sm font-medium text-muted-foreground transition-colors hover:text-foreground\"\n                  data-testid={`nav-${link.label.toLowerCase().replace(/\\s+/g, \"-\")}`}\n                >\n                  {link.label}\n                </button>\n              ))}\n            </nav>\n\n            <div className=\"hidden md:flex items-center gap-2\">\n              <ThemeToggle />\n              <Button variant=\"ghost\" onClick={handleBrowse} data-testid=\"button-login\">\n                Log In\n              </Button>\n              <Button onClick={handleGetStarted} data-testid=\"button-signup\">\n                Sign Up\n              </Button>\n            </div>\n\n            <div className=\"flex md:hidden items-center gap-2\">\n              <ThemeToggle />\n              <Sheet open={mobileMenuOpen} onOpenChange={setMobileMenuOpen}>\n                <SheetTrigger asChild>\n                  <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-mobile-menu\">\n                    <Menu className=\"h-5 w-5\" />\n                  </Button>\n                </SheetTrigger>\n                <SheetContent side=\"right\" className=\"w-[280px]\">\n                  <div className=\"flex flex-col gap-4 mt-8\">\n                    {navLinks.map((link) => (\n                      <button\n                        key={link.label}\n                        onClick={() => scrollToSection(link.href.replace(\"#\", \"\"))}\n                        className=\"text-left font-medium py-2 transition-colors hover:text-primary\"\n                      >\n                        {link.label}\n                      </button>\n                    ))}\n                    <div className=\"border-t pt-4 space-y-2\">\n                      <Button \n                        variant=\"outline\" \n                        className=\"w-full\" \n                        onClick={() => {\n                          setMobileMenuOpen(false);\n                          handleBrowse();\n                        }}\n                      >\n                        Log In\n                      </Button>\n                      <Button \n                        className=\"w-full\" \n                        onClick={() => {\n                          setMobileMenuOpen(false);\n                          handleGetStarted();\n                        }}\n                      >\n                        Sign Up\n                      </Button>\n                    </div>\n                  </div>\n                </SheetContent>\n              </Sheet>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <section className=\"relative bg-gradient-to-b from-primary/10 to-background py-20 px-4\">\n        <div className=\"container mx-auto text-center\">\n          <div className=\"mx-auto max-w-3xl animate-slide-up\">\n            <h1 className=\"text-4xl font-bold tracking-tight sm:text-5xl md:text-6xl\">\n              EKSU Campus Marketplace\n            </h1>\n            <p className=\"mt-6 text-lg text-muted-foreground sm:text-xl\">\n              Buy and sell anything - Fashion, Wigs, Perfumes, Clothes, Electronics, Accounts, and more!\n              Your trusted campus marketplace for students.\n            </p>\n            <div className=\"mt-10 flex flex-col gap-4 sm:flex-row sm:justify-center\">\n              <Button size=\"lg\" onClick={handleGetStarted} data-testid=\"button-get-started\">\n                Get Started\n                <ArrowRight className=\"ml-2 h-4 w-4\" />\n              </Button>\n              <Button size=\"lg\" variant=\"outline\" onClick={handleBrowse} data-testid=\"button-browse\">\n                Browse Listings\n              </Button>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      <section id=\"about\" className=\"py-16 px-4\">\n        <div className=\"container mx-auto\">\n          <div className=\"max-w-3xl mx-auto text-center\">\n            <h2 className=\"text-3xl font-bold mb-6\">About EKSU Marketplace</h2>\n            <p className=\"text-lg text-muted-foreground mb-8\">\n              EKSU Marketplace is the premier online platform for students at Ekiti State University \n              to buy and sell items within the campus community. Our platform provides a safe, \n              convenient, and efficient way for students to trade goods and services.\n            </p>\n            <div className=\"grid gap-6 md:grid-cols-3\">\n              <Card>\n                <CardContent className=\"pt-6 text-center\">\n                  <div className=\"rounded-full bg-primary/10 p-3 w-12 h-12 mx-auto mb-4 flex items-center justify-center\">\n                    <Users className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <h3 className=\"font-semibold mb-2\">5,000+</h3>\n                  <p className=\"text-sm text-muted-foreground\">Active Students</p>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"pt-6 text-center\">\n                  <div className=\"rounded-full bg-primary/10 p-3 w-12 h-12 mx-auto mb-4 flex items-center justify-center\">\n                    <ShoppingBag className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <h3 className=\"font-semibold mb-2\">10,000+</h3>\n                  <p className=\"text-sm text-muted-foreground\">Products Listed</p>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"pt-6 text-center\">\n                  <div className=\"rounded-full bg-primary/10 p-3 w-12 h-12 mx-auto mb-4 flex items-center justify-center\">\n                    <Star className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <h3 className=\"font-semibold mb-2\">4.8/5</h3>\n                  <p className=\"text-sm text-muted-foreground\">User Rating</p>\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      <section id=\"features\" className=\"py-16 px-4 bg-muted/30\">\n        <div className=\"container mx-auto\">\n          <h2 className=\"text-center text-3xl font-bold mb-4\">\n            Why Choose EKSU Marketplace?\n          </h2>\n          <p className=\"text-center text-muted-foreground mb-12 max-w-2xl mx-auto\">\n            Experience the best campus trading platform with features designed for students\n          </p>\n          <div className=\"grid gap-8 md:grid-cols-2 lg:grid-cols-4\">\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex flex-col items-center text-center gap-4\">\n                  <div className=\"rounded-full bg-primary/10 p-3\">\n                    <Shield className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <h3 className=\"font-semibold\">Verified Sellers</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Trade with confidence. All sellers go through verification.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex flex-col items-center text-center gap-4\">\n                  <div className=\"rounded-full bg-primary/10 p-3\">\n                    <MessageSquare className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <h3 className=\"font-semibold\">Real-Time Chat</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Chat instantly with buyers and sellers. Negotiate deals in real-time.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex flex-col items-center text-center gap-4\">\n                  <div className=\"rounded-full bg-primary/10 p-3\">\n                    <Wallet className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <h3 className=\"font-semibold\">Secure Wallet</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Built-in wallet with escrow protection for safe transactions.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex flex-col items-center text-center gap-4\">\n                  <div className=\"rounded-full bg-primary/10 p-3\">\n                    <Lock className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <h3 className=\"font-semibold\">Escrow System</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Money held safely until delivery is confirmed by buyer.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex flex-col items-center text-center gap-4\">\n                  <div className=\"rounded-full bg-primary/10 p-3\">\n                    <TrendingUp className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <h3 className=\"font-semibold\">Boost Products</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Promote your listings for more visibility and faster sales.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex flex-col items-center text-center gap-4\">\n                  <div className=\"rounded-full bg-primary/10 p-3\">\n                    <Users className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <h3 className=\"font-semibold\">Referral Bonus</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Invite friends and earn rewards when they join and trade.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex flex-col items-center text-center gap-4\">\n                  <div className=\"rounded-full bg-primary/10 p-3\">\n                    <Zap className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <h3 className=\"font-semibold\">Fast Delivery</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Campus-to-campus delivery. Meet up easily on campus.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex flex-col items-center text-center gap-4\">\n                  <div className=\"rounded-full bg-primary/10 p-3\">\n                    <Star className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <h3 className=\"font-semibold\">Ratings & Reviews</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Build your reputation with ratings and reviews.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </section>\n\n      <section id=\"how-it-works\" className=\"py-16 px-4\">\n        <div className=\"container mx-auto\">\n          <h2 className=\"text-center text-3xl font-bold mb-4\">\n            How It Works\n          </h2>\n          <p className=\"text-center text-muted-foreground mb-12 max-w-2xl mx-auto\">\n            Start buying or selling in just a few simple steps\n          </p>\n          <div className=\"grid gap-8 md:grid-cols-4\">\n            <div className=\"text-center\">\n              <div className=\"rounded-full bg-primary text-primary-foreground w-12 h-12 mx-auto mb-4 flex items-center justify-center font-bold text-lg\">\n                1\n              </div>\n              <h3 className=\"font-semibold mb-2\">Sign Up</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Create your account with your email. Quick and easy registration.\n              </p>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"rounded-full bg-primary text-primary-foreground w-12 h-12 mx-auto mb-4 flex items-center justify-center font-bold text-lg\">\n                2\n              </div>\n              <h3 className=\"font-semibold mb-2\">List or Browse</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                List items for sale or browse products from other students.\n              </p>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"rounded-full bg-primary text-primary-foreground w-12 h-12 mx-auto mb-4 flex items-center justify-center font-bold text-lg\">\n                3\n              </div>\n              <h3 className=\"font-semibold mb-2\">Connect</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Chat with buyers or sellers and negotiate the best price.\n              </p>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"rounded-full bg-primary text-primary-foreground w-12 h-12 mx-auto mb-4 flex items-center justify-center font-bold text-lg\">\n                4\n              </div>\n              <h3 className=\"font-semibold mb-2\">Complete Trade</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Complete your transaction safely with our escrow protection.\n              </p>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      <section id=\"merchant\" className=\"py-16 px-4 bg-primary/5\">\n        <div className=\"container mx-auto\">\n          <div className=\"max-w-4xl mx-auto\">\n            <div className=\"grid gap-8 md:grid-cols-2 items-center\">\n              <div>\n                <h2 className=\"text-3xl font-bold mb-4\">Become a Merchant</h2>\n                <p className=\"text-muted-foreground mb-6\">\n                  Start your campus business today. Sell products to thousands of students \n                  and earn money while studying. Get verified seller status for more trust and sales.\n                </p>\n                <ul className=\"space-y-3 mb-6\">\n                  <li className=\"flex items-center gap-2\">\n                    <CheckCircle className=\"h-5 w-5 text-primary\" />\n                    <span>Free to list your products</span>\n                  </li>\n                  <li className=\"flex items-center gap-2\">\n                    <CheckCircle className=\"h-5 w-5 text-primary\" />\n                    <span>Get verified seller badge</span>\n                  </li>\n                  <li className=\"flex items-center gap-2\">\n                    <CheckCircle className=\"h-5 w-5 text-primary\" />\n                    <span>Access to seller dashboard</span>\n                  </li>\n                  <li className=\"flex items-center gap-2\">\n                    <CheckCircle className=\"h-5 w-5 text-primary\" />\n                    <span>Boost products for more visibility</span>\n                  </li>\n                  <li className=\"flex items-center gap-2\">\n                    <CheckCircle className=\"h-5 w-5 text-primary\" />\n                    <span>Withdraw earnings to bank account</span>\n                  </li>\n                </ul>\n                <Button size=\"lg\" onClick={handleBecomeMerchant} data-testid=\"button-become-merchant\">\n                  <Store className=\"mr-2 h-4 w-4\" />\n                  Start Selling Today\n                </Button>\n              </div>\n              <div className=\"bg-gradient-to-br from-primary/20 to-primary/5 rounded-lg p-8\">\n                <div className=\"text-center\">\n                  <div className=\"rounded-full bg-primary/10 p-6 w-24 h-24 mx-auto mb-4 flex items-center justify-center\">\n                    <Store className=\"h-12 w-12 text-primary\" />\n                  </div>\n                  <h3 className=\"text-xl font-semibold mb-2\">Seller Benefits</h3>\n                  <p className=\"text-muted-foreground\">\n                    Join our growing community of student entrepreneurs\n                  </p>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      <section className=\"py-16 px-4\">\n        <div className=\"container mx-auto text-center\">\n          <h2 className=\"text-3xl font-bold mb-4\">Ready to Start Trading?</h2>\n          <p className=\"text-lg text-muted-foreground mb-8\">\n            Join thousands of EKSU students buying and selling safely on campus.\n          </p>\n          <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n            <Button size=\"lg\" onClick={handleGetStarted} data-testid=\"button-join-now\">\n              Join Now - It's Free\n            </Button>\n            <Button size=\"lg\" variant=\"outline\" onClick={handleBrowse}>\n              Already have an account? Log In\n            </Button>\n          </div>\n        </div>\n      </section>\n\n      <footer className=\"border-t py-8 px-4\">\n        <div className=\"container mx-auto\">\n          <div className=\"flex flex-col md:flex-row items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-2\">\n              <ShoppingBag className=\"h-5 w-5 text-primary\" />\n              <span className=\"font-semibold\">EKSU Marketplace</span>\n            </div>\n            <p className=\"text-sm text-muted-foreground\">\n              2024 EKSU Campus Marketplace. All rights reserved.\n            </p>\n          </div>\n        </div>\n      </footer>\n\n      <AuthModal\n        open={authModalOpen}\n        onOpenChange={setAuthModalOpen}\n        defaultTab={authModalTab}\n        defaultRole={authModalDefaultRole}\n        defaultReferralCode={authModalReferralCode}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":22355,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"server/pricing.ts":{"content":"/**\n * Pricing Calculator for EKSU Marketplace\n * \n * This module handles all financial calculations including:\n * - Squad transaction fees\n * - Platform commission (website fee)\n * - Seller net profit\n * - Buyer total price\n * - Security deposit calculations\n */\n\nconst DEFAULT_COMMISSION_RATE = 0.10; // 10%\nconst DEFAULT_SECURITY_DEPOSIT = 0; // Naira\n\n/**\n * Get the website commission rate from environment variables\n */\nexport function getCommissionRate(): number {\n  const rate = process.env.WEBSITE_COMMISSION_RATE;\n  if (rate) {\n    const parsed = parseFloat(rate);\n    if (!isNaN(parsed) && parsed >= 0 && parsed <= 1) {\n      return parsed;\n    }\n  }\n  return DEFAULT_COMMISSION_RATE;\n}\n\n/**\n * Get the security deposit amount from environment variables\n */\nexport function getSecurityDepositAmount(): number {\n  const amount = process.env.SECURITY_DEPOSIT_AMOUNT;\n  if (amount) {\n    const parsed = parseFloat(amount);\n    if (!isNaN(parsed) && parsed >= 0) {\n      return parsed;\n    }\n  }\n  return DEFAULT_SECURITY_DEPOSIT;\n}\n\n/**\n * Squad Fee Structure for Nigeria\n * - Bank Transfer: 1.0% (capped at ₦1,000) - Instant settlement (T+0)\n * - Card Payments: 1.5% (capped at ₦2,000)\n * - USSD: 1.5% (capped at ₦2,000)\n */\nexport interface SquadFeeResult {\n  feePercentage: number;\n  totalFee: number;\n  cappedFee: number;\n}\n\nexport type PaymentMethod = 'CARD' | 'BANK_TRANSFER' | 'USSD' | 'TRANSFER';\n\n/**\n * Calculate Squad transaction fee based on amount and payment method\n */\nexport function calculateSquadFee(\n  amount: number,\n  paymentMethod: PaymentMethod = 'BANK_TRANSFER'\n): SquadFeeResult {\n  let feePercentage: number;\n  let feeCap: number;\n  \n  switch (paymentMethod) {\n    case 'BANK_TRANSFER':\n    case 'TRANSFER':\n      feePercentage = 0.01; // 1.0% for bank transfers (instant settlement)\n      feeCap = 1000; // ₦1,000 cap\n      break;\n    case 'CARD':\n      feePercentage = 0.015; // 1.5% for cards\n      feeCap = 2000; // ₦2,000 cap\n      break;\n    case 'USSD':\n      feePercentage = 0.015; // 1.5%\n      feeCap = 2000;\n      break;\n    default:\n      feePercentage = 0.015;\n      feeCap = 2000;\n  }\n  \n  const totalFee = amount * feePercentage;\n  const cappedFee = Math.min(totalFee, feeCap);\n  \n  return {\n    feePercentage,\n    totalFee,\n    cappedFee,\n  };\n}\n\n/**\n * Pricing breakdown for a product listing\n */\nexport interface PricingBreakdown {\n  sellerPrice: number;\n  platformCommission: number;\n  paymentFee: number;\n  buyerPays: number;\n  sellerReceives: number;\n  commissionRate: number;\n}\n\n/**\n * Calculate full pricing breakdown based on seller's desired price\n */\nexport function calculatePricingFromSellerPrice(\n  sellerDesiredProfit: number,\n  paymentMethod: PaymentMethod = 'BANK_TRANSFER'\n): PricingBreakdown {\n  const commissionRate = getCommissionRate();\n  \n  const platformCommission = Math.round(sellerDesiredProfit * commissionRate * 100) / 100;\n  \n  const squadResult = calculateSquadFee(sellerDesiredProfit, paymentMethod);\n  const paymentFee = Math.round(squadResult.cappedFee * 100) / 100;\n  \n  const buyerPays = Math.round((sellerDesiredProfit + platformCommission + paymentFee) * 100) / 100;\n  \n  const sellerReceives = Math.round((sellerDesiredProfit - platformCommission) * 100) / 100;\n  \n  return {\n    sellerPrice: sellerDesiredProfit,\n    platformCommission,\n    paymentFee,\n    buyerPays,\n    sellerReceives,\n    commissionRate,\n  };\n}\n\n/**\n * Calculate pricing breakdown from the buyer's perspective\n */\nexport function calculatePricingFromBuyerPrice(\n  buyerPrice: number,\n  paymentMethod: PaymentMethod = 'BANK_TRANSFER'\n): PricingBreakdown {\n  const commissionRate = getCommissionRate();\n  \n  let estimatedSellerPrice = buyerPrice / (1 + commissionRate);\n  \n  const squadResult = calculateSquadFee(estimatedSellerPrice, paymentMethod);\n  estimatedSellerPrice = (buyerPrice - squadResult.cappedFee) / (1 + commissionRate);\n  \n  return calculatePricingFromSellerPrice(Math.round(estimatedSellerPrice * 100) / 100, paymentMethod);\n}\n\n/**\n * Recalculate pricing for a negotiated offer\n */\nexport function calculateNegotiationPricing(\n  offerPrice: number,\n  paymentMethod: PaymentMethod = 'BANK_TRANSFER'\n): PricingBreakdown {\n  return calculatePricingFromSellerPrice(offerPrice, paymentMethod);\n}\n\n/**\n * Calculate security deposit requirement\n */\nexport function calculateSecurityDepositRequired(\n  currentLockedAmount: number\n): { required: number; amountToLock: number } {\n  const requiredAmount = getSecurityDepositAmount();\n  const amountToLock = Math.max(0, requiredAmount - currentLockedAmount);\n  \n  return {\n    required: requiredAmount,\n    amountToLock,\n  };\n}\n\n/**\n * Check if withdrawal is allowed based on verification status and amount\n */\nexport function isWithdrawalAllowed(\n  amount: number,\n  isVerified: boolean,\n  balance: number,\n  securityDepositLocked: number\n): { allowed: boolean; reason?: string } {\n  const UNVERIFIED_WITHDRAWAL_LIMIT = 5000;\n  \n  if (amount > balance) {\n    return { allowed: false, reason: 'Insufficient balance' };\n  }\n  \n  if (!isVerified && amount > UNVERIFIED_WITHDRAWAL_LIMIT) {\n    return { \n      allowed: false, \n      reason: `Unverified sellers can only withdraw up to ₦${UNVERIFIED_WITHDRAWAL_LIMIT.toLocaleString()}. Please complete verification to withdraw larger amounts.`\n    };\n  }\n  \n  return { allowed: true };\n}\n\n/**\n * Format amount as Nigerian Naira\n */\nexport function formatNaira(amount: number): string {\n  return `₦${amount.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\n}\n\n/**\n * Parse Naira string to number\n */\nexport function parseNaira(nairaString: string): number {\n  const cleaned = nairaString.replace(/[₦,\\s]/g, '');\n  const parsed = parseFloat(cleaned);\n  return isNaN(parsed) ? 0 : parsed;\n}\n\nexport const pricingConfig = {\n  getCommissionRate,\n  getSecurityDepositAmount,\n  calculateSquadFee,\n  calculatePricingFromSellerPrice,\n  calculatePricingFromBuyerPrice,\n  calculateNegotiationPricing,\n  calculateSecurityDepositRequired,\n  isWithdrawalAllowed,\n  formatNaira,\n  parseNaira,\n};\n\nexport default pricingConfig;\n","path":null,"size_bytes":6120,"size_tokens":null},"client/src/pages/support.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { HelpCircle, MessageCircle, LifeBuoy, Clock, Send, Ticket, CreditCard, User, AlertTriangle, Wrench, ChevronRight, Image, X, Upload, Loader2, Phone, MapPin, Shield, CheckCircle2 } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from \"@/components/ui/form\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport type { SupportTicket } from \"@shared/schema\";\nimport { formatDistanceToNow } from \"date-fns\";\n\nconst ticketFormSchema = z.object({\n  subject: z.string().min(5, \"Subject must be at least 5 characters\"),\n  message: z.string().min(20, \"Please provide more details (minimum 20 characters)\"),\n  category: z.string().min(1, \"Please select a category\"),\n  priority: z.string().min(1, \"Please select a priority level\"),\n});\n\ntype TicketFormData = z.infer<typeof ticketFormSchema>;\n\nconst verificationFormSchema = z.object({\n  phoneNumber: z.string().optional(),\n  location: z.string().optional(),\n  ninNumber: z.string().optional(),\n}).refine(\n  (data) => data.phoneNumber || data.location || data.ninNumber,\n  { message: \"Please provide at least one verification field\" }\n);\n\ntype VerificationFormData = z.infer<typeof verificationFormSchema>;\n\nconst faqData = [\n  {\n    category: \"Account\",\n    icon: User,\n    questions: [\n      {\n        question: \"How do I verify my account?\",\n        answer: \"VERIFICATION_BUTTON\",\n        hasButton: true,\n      },\n      {\n        question: \"Can I change my role from buyer to seller?\",\n        answer: \"Yes! You can update your role in your profile settings. Choose 'Both' to buy and sell items on the marketplace, or switch between buyer and seller as needed.\"\n      },\n      {\n        question: \"How do I reset my password?\",\n        answer: \"Click on 'Forgot Password' on the login page, enter your email address, and follow the instructions sent to your email to reset your password.\"\n      },\n      {\n        question: \"What is the Verified Student badge?\",\n        answer: \"The Verified Student badge appears on profiles that have completed identity verification. This builds trust with other users and helps prevent scams on the platform.\"\n      },\n      {\n        question: \"How do I update my profile picture?\",\n        answer: \"Go to your Profile page and click the camera icon on your avatar. You can upload any image (up to 5MB). The new photo will be visible to other users immediately.\"\n      }\n    ]\n  },\n  {\n    category: \"Payment & Wallet\",\n    icon: CreditCard,\n    questions: [\n      {\n        question: \"How do I add money to my wallet?\",\n        answer: \"Go to the Wallet page, enter the amount you want to deposit (minimum 100 NGN), and complete the payment via bank transfer, card, or USSD. The funds will be credited once the payment is confirmed.\"\n      },\n      {\n        question: \"How do I withdraw money from my wallet?\",\n        answer: \"Navigate to the Wallet page, click on the Withdraw tab, enter your bank details (bank name, account number, account name) and the amount you wish to withdraw. Minimum withdrawal is 500 NGN. Withdrawals are usually processed within 24 hours.\"\n      },\n      {\n        question: \"What is escrow and how does it work?\",\n        answer: \"Escrow holds payment securely until the buyer confirms receipt of the item. When you make a purchase, the money is held safely. Once you confirm you've received the item, the payment is released to the seller. This protects both parties.\"\n      },\n      {\n        question: \"What are the platform fees?\",\n        answer: \"We charge a small fee (3-6%) on successful transactions to maintain the platform and provide security features. The exact fee is shown before you confirm any transaction.\"\n      },\n      {\n        question: \"How do I track my transactions?\",\n        answer: \"All your transactions (deposits, withdrawals, purchases, sales, and rewards) are displayed in your Wallet page under the transaction history section. You can see the amount, type, and date of each transaction.\"\n      }\n    ]\n  },\n  {\n    category: \"Buying & Selling\",\n    icon: LifeBuoy,\n    questions: [\n      {\n        question: \"How do I post an item for sale?\",\n        answer: \"If you're a seller, go to My Ads page and click 'Post New Ad'. Add photos (up to 5), title, description, price, and select a category. Your listing will be live immediately after posting.\"\n      },\n      {\n        question: \"How do I boost my listing?\",\n        answer: \"Go to My Ads, find your listing, and click 'Boost'. Choose a duration (1-168 hours) and pay with your wallet balance. Boosted items appear at the top of search results and get more visibility.\"\n      },\n      {\n        question: \"What should I do if I receive a defective item?\",\n        answer: \"If you're using escrow, don't confirm receipt yet. Contact the seller first through the messaging feature to try to resolve the issue. If no resolution is reached, you can open a dispute from your transaction details.\"\n      },\n      {\n        question: \"Can I negotiate prices?\",\n        answer: \"Yes! Use the messaging feature to chat with sellers and negotiate prices. Many sellers are open to reasonable offers. Click the 'Message' button on any listing to start a conversation.\"\n      },\n      {\n        question: \"How do I save items to buy later?\",\n        answer: \"Click the heart icon on any product to add it to your watchlist. You can view all your saved items in the Watchlist section accessible from the home page.\"\n      }\n    ]\n  },\n  {\n    category: \"Safety & Reporting\",\n    icon: AlertTriangle,\n    questions: [\n      {\n        question: \"How do I report a scammer?\",\n        answer: \"Click the 'Report' button on their profile or listing. Provide as much detail as possible including screenshots. You can attach images when submitting a support ticket. Our team reviews all reports within 24 hours.\"\n      },\n      {\n        question: \"What happens when I report someone?\",\n        answer: \"We investigate all reports thoroughly. If a violation is confirmed, the user may receive a warning, suspension, or permanent ban depending on the severity. You'll be notified of the outcome.\"\n      },\n      {\n        question: \"How can I stay safe when meeting sellers?\",\n        answer: \"Always meet in public campus areas during daytime. Bring a friend if possible. Use escrow for valuable items to ensure secure payment. Never share personal financial information like bank passwords.\"\n      },\n      {\n        question: \"What should I do if someone asks me to pay outside the platform?\",\n        answer: \"Never pay outside the platform! This is a common scam tactic. Always use our secure payment system for your protection. Report any user who asks you to pay outside the platform.\"\n      },\n      {\n        question: \"How do I block a user?\",\n        answer: \"If someone is harassing you, report them using the support ticket system. Select 'Report User/Scam' as the category and provide details about the harassment. Our team will take appropriate action.\"\n      }\n    ]\n  }\n];\n\ninterface QuickLink {\n  title: string;\n  description: string;\n  action: \"navigate\" | \"tab\" | \"modal\";\n  href?: string;\n  tab?: string;\n  category?: string;\n  modal?: string;\n  icon: typeof User;\n}\n\nconst quickLinks: QuickLink[] = [\n  { title: \"Verify Your Account\", description: \"Get verified for trust badges\", action: \"modal\", modal: \"verification\", icon: Shield },\n  { title: \"Wallet & Payments\", description: \"Add funds or withdraw money\", action: \"navigate\", href: \"/wallet\", icon: CreditCard },\n  { title: \"Report an Issue\", description: \"Report scams or violations\", action: \"tab\", tab: \"contact\", category: \"report\", icon: AlertTriangle },\n  { title: \"Technical Help\", description: \"Fix app or account issues\", action: \"tab\", tab: \"contact\", category: \"technical\", icon: Wrench },\n];\n\nfunction getStatusBadgeVariant(status: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" {\n  switch (status) {\n    case \"open\":\n      return \"destructive\";\n    case \"in_progress\":\n      return \"default\";\n    case \"resolved\":\n      return \"secondary\";\n    default:\n      return \"outline\";\n  }\n}\n\nfunction getPriorityBadgeVariant(priority: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" {\n  switch (priority) {\n    case \"urgent\":\n      return \"destructive\";\n    case \"high\":\n      return \"default\";\n    case \"medium\":\n      return \"secondary\";\n    default:\n      return \"outline\";\n  }\n}\n\nfunction getCategoryIcon(category: string) {\n  switch (category) {\n    case \"account\":\n      return User;\n    case \"payment\":\n      return CreditCard;\n    case \"technical\":\n      return Wrench;\n    case \"report\":\n      return AlertTriangle;\n    default:\n      return HelpCircle;\n  }\n}\n\nexport default function SupportPage() {\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const [, setLocation] = useLocation();\n  const search = useSearch();\n  const [activeTab, setActiveTab] = useState(\"faq\");\n  const [attachments, setAttachments] = useState<string[]>([]);\n  const [uploadingImage, setUploadingImage] = useState(false);\n  const [verificationModalOpen, setVerificationModalOpen] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const contactFormRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const params = new URLSearchParams(search);\n    const tab = params.get(\"tab\");\n    const category = params.get(\"category\");\n    \n    if (tab === \"contact\") {\n      setActiveTab(\"contact\");\n      if (category) {\n        form.setValue(\"category\", category);\n      }\n    }\n  }, [search]);\n\n  const { data: tickets = [], isLoading: ticketsLoading } = useQuery<SupportTicket[]>({\n    queryKey: [\"/api/support\"],\n  });\n\n  const form = useForm<TicketFormData>({\n    resolver: zodResolver(ticketFormSchema),\n    defaultValues: {\n      subject: \"\",\n      message: \"\",\n      category: \"\",\n      priority: \"medium\",\n    },\n  });\n\n  const verificationForm = useForm<VerificationFormData>({\n    resolver: zodResolver(verificationFormSchema),\n    defaultValues: {\n      phoneNumber: user?.phoneNumber || \"\",\n      location: user?.location || \"\",\n      ninNumber: \"\",\n    },\n  });\n\n  useEffect(() => {\n    if (user) {\n      verificationForm.reset({\n        phoneNumber: user.phoneNumber || \"\",\n        location: user.location || \"\",\n        ninNumber: \"\",\n      });\n    }\n  }, [user]);\n\n  const verificationMutation = useMutation({\n    mutationFn: async (data: VerificationFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/users/verify-account\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Account Verified\",\n        description: \"Your account has been successfully verified! You now have trust badges on your profile.\",\n      });\n      setVerificationModalOpen(false);\n      verificationForm.reset();\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Verification Failed\",\n        description: error.message || \"Failed to verify your account. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createTicketMutation = useMutation({\n    mutationFn: async (data: TicketFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/support\", {\n        ...data,\n        attachments: attachments,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Ticket Submitted\",\n        description: \"We've received your support request and will respond soon.\",\n      });\n      form.reset();\n      setAttachments([]);\n      queryClient.invalidateQueries({ queryKey: [\"/api/support\"] });\n      setActiveTab(\"tickets\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to submit ticket. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const files = event.target.files;\n    if (!files || files.length === 0) return;\n\n    if (attachments.length >= 5) {\n      toast({\n        title: \"Maximum attachments reached\",\n        description: \"You can only attach up to 5 images per ticket.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const file = files[0];\n    if (!file.type.startsWith(\"image/\")) {\n      toast({\n        title: \"Invalid file type\",\n        description: \"Please select an image file (JPG, PNG, etc.)\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (file.size > 5 * 1024 * 1024) {\n      toast({\n        title: \"File too large\",\n        description: \"Image must be less than 5MB\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setUploadingImage(true);\n    try {\n      const formData = new FormData();\n      formData.append(\"image\", file);\n\n      const response = await fetch(\"/api/upload\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to upload image\");\n      }\n\n      const { url } = await response.json();\n      setAttachments((prev) => [...prev, url]);\n      toast({\n        title: \"Image uploaded\",\n        description: \"Your image has been attached to the ticket.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Upload failed\",\n        description: \"Failed to upload image. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setUploadingImage(false);\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n    }\n  };\n\n  const removeAttachment = (index: number) => {\n    setAttachments((prev) => prev.filter((_, i) => i !== index));\n  };\n\n  const handleQuickLinkClick = (link: QuickLink) => {\n    if (link.action === \"navigate\" && link.href) {\n      setLocation(link.href);\n    } else if (link.action === \"tab\" && link.tab) {\n      setActiveTab(link.tab);\n      if (link.category) {\n        form.setValue(\"category\", link.category);\n      }\n      setTimeout(() => {\n        contactFormRef.current?.scrollIntoView({ behavior: \"smooth\", block: \"start\" });\n      }, 100);\n    } else if (link.action === \"modal\" && link.modal === \"verification\") {\n      if (!user) {\n        toast({\n          title: \"Login Required\",\n          description: \"Please log in to verify your account.\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      setVerificationModalOpen(true);\n    }\n  };\n\n  const handleOpenVerificationModal = () => {\n    if (!user) {\n      toast({\n        title: \"Login Required\",\n        description: \"Please log in to verify your account.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setVerificationModalOpen(true);\n  };\n\n  const onVerificationSubmit = (data: VerificationFormData) => {\n    verificationMutation.mutate(data);\n  };\n\n  const onSubmit = (data: TicketFormData) => {\n    createTicketMutation.mutate(data);\n  };\n\n  return (\n    <div className=\"container mx-auto px-4 py-6 max-w-5xl\">\n      <div className=\"mb-8\">\n        <div className=\"flex items-center gap-3 mb-2\">\n          <LifeBuoy className=\"h-8 w-8 text-primary\" />\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Help Center</h1>\n        </div>\n        <p className=\"text-muted-foreground\">\n          Find answers to common questions or contact our support team for assistance.\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8\">\n        {quickLinks.map((link, index) => {\n          const Icon = link.icon;\n          return (\n            <Card\n              key={index}\n              className=\"hover-elevate cursor-pointer\"\n              onClick={() => handleQuickLinkClick(link)}\n              data-testid={`card-quick-link-${index}`}\n            >\n              <CardContent className=\"flex items-center gap-3 p-4\">\n                <div className=\"p-2 rounded-md bg-primary/10\">\n                  <Icon className=\"h-5 w-5 text-primary\" />\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"font-medium text-sm\">{link.title}</p>\n                  <p className=\"text-xs text-muted-foreground truncate\">{link.description}</p>\n                </div>\n                <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n              </CardContent>\n            </Card>\n          );\n        })}\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"grid w-full grid-cols-3 mb-6\">\n          <TabsTrigger value=\"faq\" className=\"flex items-center gap-2\" data-testid=\"tab-faq\">\n            <HelpCircle className=\"h-4 w-4\" />\n            FAQ\n          </TabsTrigger>\n          <TabsTrigger value=\"contact\" className=\"flex items-center gap-2\" data-testid=\"tab-contact\">\n            <MessageCircle className=\"h-4 w-4\" />\n            Contact Us\n          </TabsTrigger>\n          <TabsTrigger value=\"tickets\" className=\"flex items-center gap-2\" data-testid=\"tab-tickets\">\n            <Ticket className=\"h-4 w-4\" />\n            My Tickets\n            {tickets.length > 0 && (\n              <Badge variant=\"secondary\" className=\"ml-1\">{tickets.length}</Badge>\n            )}\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"faq\">\n          <div className=\"space-y-6\">\n            {faqData.map((section, sectionIndex) => {\n              const Icon = section.icon;\n              return (\n                <Card key={sectionIndex} data-testid={`card-faq-section-${sectionIndex}`}>\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"flex items-center gap-2 text-lg\">\n                      <Icon className=\"h-5 w-5 text-primary\" />\n                      {section.category}\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"pt-0\">\n                    <Accordion type=\"single\" collapsible className=\"w-full\">\n                      {section.questions.map((item, index) => (\n                        <AccordionItem\n                          key={index}\n                          value={`${sectionIndex}-${index}`}\n                          data-testid={`accordion-item-${sectionIndex}-${index}`}\n                        >\n                          <AccordionTrigger className=\"text-left\">\n                            {item.question}\n                          </AccordionTrigger>\n                          <AccordionContent className=\"text-muted-foreground\">\n                            {(item as any).hasButton ? (\n                              <div className=\"space-y-4\">\n                                <p>\n                                  Account verification helps build trust with other users on the marketplace. You can verify your account by providing:\n                                </p>\n                                <ul className=\"list-disc list-inside space-y-1 ml-2\">\n                                  <li><strong>Phone Number</strong> - Verify your phone number for secure communication</li>\n                                  <li><strong>Campus Location</strong> - Confirm your campus area/hostel for local transactions</li>\n                                  <li><strong>NIN (Optional)</strong> - Add your National Identification Number for enhanced verification</li>\n                                </ul>\n                                <p>\n                                  Verified accounts get trust badges displayed on their profile, making it easier to build credibility with buyers and sellers.\n                                </p>\n                                <Button\n                                  onClick={handleOpenVerificationModal}\n                                  className=\"mt-2\"\n                                  data-testid=\"button-faq-verify-account\"\n                                >\n                                  <Shield className=\"mr-2 h-4 w-4\" />\n                                  Verify Your Account Now\n                                </Button>\n                              </div>\n                            ) : (\n                              item.answer\n                            )}\n                          </AccordionContent>\n                        </AccordionItem>\n                      ))}\n                    </Accordion>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"contact\">\n          <Card data-testid=\"card-contact-form\" ref={contactFormRef}>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Send className=\"h-5 w-5 text-primary\" />\n                Submit a Support Ticket\n              </CardTitle>\n              <CardDescription>\n                Can't find your answer in the FAQ? Submit a ticket and we'll get back to you within 24 hours.\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Form {...form}>\n                <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"category\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Category</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-category\">\n                              <SelectValue placeholder=\"Select a category\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"account\">Account Issues</SelectItem>\n                            <SelectItem value=\"payment\">Payment & Wallet</SelectItem>\n                            <SelectItem value=\"technical\">Technical Problems</SelectItem>\n                            <SelectItem value=\"report\">Report User/Scam</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"priority\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Priority</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-priority\">\n                              <SelectValue placeholder=\"Select priority level\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"low\">Low - General question</SelectItem>\n                            <SelectItem value=\"medium\">Medium - Need help soon</SelectItem>\n                            <SelectItem value=\"high\">High - Urgent issue</SelectItem>\n                            <SelectItem value=\"urgent\">Urgent - Critical problem</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"subject\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Subject</FormLabel>\n                        <FormControl>\n                          <Input\n                            placeholder=\"Brief description of your issue\"\n                            {...field}\n                            data-testid=\"input-subject\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"message\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Message</FormLabel>\n                        <FormControl>\n                          <Textarea\n                            placeholder=\"Please describe your issue in detail. Include any relevant information such as transaction IDs, usernames, or other details that might help us assist you.\"\n                            className=\"min-h-[150px]\"\n                            {...field}\n                            data-testid=\"textarea-message\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"space-y-3\">\n                    <div className=\"flex items-center justify-between\">\n                      <FormLabel>Attachments (Optional)</FormLabel>\n                      <span className=\"text-xs text-muted-foreground\">{attachments.length}/5 images</span>\n                    </div>\n                    \n                    {attachments.length > 0 && (\n                      <div className=\"flex flex-wrap gap-2\">\n                        {attachments.map((url, index) => (\n                          <div\n                            key={index}\n                            className=\"relative group rounded-md overflow-visible\"\n                            data-testid={`attachment-preview-${index}`}\n                          >\n                            <img\n                              src={url}\n                              alt={`Attachment ${index + 1}`}\n                              className=\"h-20 w-20 object-cover rounded-md border\"\n                              loading=\"lazy\"\n                            />\n                            <Button\n                              type=\"button\"\n                              variant=\"destructive\"\n                              size=\"icon\"\n                              className=\"absolute -top-2 -right-2 h-6 w-6 rounded-full opacity-0 group-hover:opacity-100 transition-opacity\"\n                              onClick={() => removeAttachment(index)}\n                              data-testid={`button-remove-attachment-${index}`}\n                            >\n                              <X className=\"h-3 w-3\" />\n                            </Button>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                    \n                    <div className=\"flex items-center gap-2\">\n                      <input\n                        ref={fileInputRef}\n                        type=\"file\"\n                        accept=\"image/*\"\n                        onChange={handleFileSelect}\n                        className=\"hidden\"\n                        data-testid=\"input-attachment\"\n                      />\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => fileInputRef.current?.click()}\n                        disabled={uploadingImage || attachments.length >= 5}\n                        data-testid=\"button-add-attachment\"\n                      >\n                        {uploadingImage ? (\n                          <>\n                            <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                            Uploading...\n                          </>\n                        ) : (\n                          <>\n                            <Image className=\"mr-2 h-4 w-4\" />\n                            Add Image\n                          </>\n                        )}\n                      </Button>\n                      <span className=\"text-xs text-muted-foreground\">\n                        Max 5MB per image. JPG, PNG, GIF supported.\n                      </span>\n                    </div>\n                  </div>\n\n                  <Button\n                    type=\"submit\"\n                    className=\"w-full\"\n                    disabled={createTicketMutation.isPending}\n                    data-testid=\"button-submit-ticket\"\n                  >\n                    {createTicketMutation.isPending ? (\n                      <>\n                        <Clock className=\"mr-2 h-4 w-4 animate-spin\" />\n                        Submitting...\n                      </>\n                    ) : (\n                      <>\n                        <Send className=\"mr-2 h-4 w-4\" />\n                        Submit Ticket\n                      </>\n                    )}\n                  </Button>\n                </form>\n              </Form>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"tickets\">\n          <Card data-testid=\"card-tickets-list\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Ticket className=\"h-5 w-5 text-primary\" />\n                Your Support Tickets\n              </CardTitle>\n              <CardDescription>\n                View and track the status of your support requests.\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {ticketsLoading ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <Clock className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                </div>\n              ) : tickets.length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <Ticket className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                  <h3 className=\"font-medium mb-2\">No tickets yet</h3>\n                  <p className=\"text-sm text-muted-foreground mb-4\">\n                    You haven't submitted any support tickets.\n                  </p>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setActiveTab(\"contact\")}\n                    data-testid=\"button-create-first-ticket\"\n                  >\n                    Create your first ticket\n                  </Button>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {tickets.map((ticket) => {\n                    const CategoryIcon = getCategoryIcon(ticket.category || \"\");\n                    const ticketAttachments = (ticket as any).attachments as string[] | undefined;\n                    return (\n                      <Card\n                        key={ticket.id}\n                        className=\"overflow-visible\"\n                        data-testid={`card-ticket-${ticket.id}`}\n                      >\n                        <CardContent className=\"p-4\">\n                          <div className=\"flex flex-col gap-3\">\n                            <div className=\"flex items-start justify-between gap-2 flex-wrap\">\n                              <div className=\"flex items-center gap-2 flex-wrap\">\n                                <CategoryIcon className=\"h-4 w-4 text-muted-foreground\" />\n                                <h4 className=\"font-medium\">{ticket.subject}</h4>\n                              </div>\n                              <div className=\"flex items-center gap-2 flex-wrap\">\n                                <Badge variant={getStatusBadgeVariant(ticket.status || \"open\")}>\n                                  {ticket.status === \"in_progress\" ? \"In Progress\" : \n                                   ticket.status ? ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1) : \"Open\"}\n                                </Badge>\n                                <Badge variant={getPriorityBadgeVariant(ticket.priority || \"medium\")}>\n                                  {ticket.priority ? ticket.priority.charAt(0).toUpperCase() + ticket.priority.slice(1) : \"Medium\"}\n                                </Badge>\n                              </div>\n                            </div>\n                            \n                            <p className=\"text-sm text-muted-foreground line-clamp-2\">\n                              {ticket.message}\n                            </p>\n\n                            {ticketAttachments && ticketAttachments.length > 0 && (\n                              <div className=\"flex flex-wrap gap-2\">\n                                {ticketAttachments.map((url, index) => (\n                                  <a\n                                    key={index}\n                                    href={url}\n                                    target=\"_blank\"\n                                    rel=\"noopener noreferrer\"\n                                    className=\"block\"\n                                    data-testid={`ticket-attachment-${ticket.id}-${index}`}\n                                  >\n                                    <img\n                                      src={url}\n                                      alt={`Attachment ${index + 1}`}\n                                      className=\"h-16 w-16 object-cover rounded-md border hover:opacity-80 transition-opacity\"\n                                      loading=\"lazy\"\n                                    />\n                                  </a>\n                                ))}\n                              </div>\n                            )}\n                            \n                            {ticket.response && (\n                              <div className=\"bg-muted/50 rounded-md p-3 mt-2\">\n                                <p className=\"text-xs font-medium text-muted-foreground mb-1\">Support Response:</p>\n                                <p className=\"text-sm\">{ticket.response}</p>\n                              </div>\n                            )}\n                            \n                            <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                              <Clock className=\"h-3 w-3\" />\n                              <span>\n                                Submitted {ticket.createdAt ? formatDistanceToNow(new Date(ticket.createdAt), { addSuffix: true }) : \"recently\"}\n                              </span>\n                              {ticket.category && (\n                                <>\n                                  <span className=\"text-muted-foreground/50\">|</span>\n                                  <span className=\"capitalize\">{ticket.category}</span>\n                                </>\n                              )}\n                              {ticketAttachments && ticketAttachments.length > 0 && (\n                                <>\n                                  <span className=\"text-muted-foreground/50\">|</span>\n                                  <span className=\"flex items-center gap-1\">\n                                    <Image className=\"h-3 w-3\" />\n                                    {ticketAttachments.length} attachment{ticketAttachments.length > 1 ? 's' : ''}\n                                  </span>\n                                </>\n                              )}\n                            </div>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    );\n                  })}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={verificationModalOpen} onOpenChange={setVerificationModalOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Shield className=\"h-5 w-5 text-primary\" />\n              Verify Your Account\n            </DialogTitle>\n            <DialogDescription>\n              Complete your verification to get trust badges on your profile. Fill in at least one field below.\n            </DialogDescription>\n          </DialogHeader>\n\n          {user?.isVerified && (\n            <div className=\"flex items-center gap-2 p-3 bg-green-50 dark:bg-green-950/20 rounded-md border border-green-200 dark:border-green-900\">\n              <CheckCircle2 className=\"h-5 w-5 text-green-600\" />\n              <div>\n                <p className=\"text-sm font-medium text-green-700 dark:text-green-400\">Account Already Verified</p>\n                <p className=\"text-xs text-green-600 dark:text-green-500\">\n                  You can still update your verification details below.\n                </p>\n              </div>\n            </div>\n          )}\n\n          <Form {...verificationForm}>\n            <form onSubmit={verificationForm.handleSubmit(onVerificationSubmit)} className=\"space-y-4\">\n              <FormField\n                control={verificationForm.control}\n                name=\"phoneNumber\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"flex items-center gap-2\">\n                      <Phone className=\"h-4 w-4\" />\n                      Phone Number\n                    </FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"e.g., +234 801 234 5678\"\n                        {...field}\n                        data-testid=\"input-verification-phone\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      Your Nigerian phone number for secure communication\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={verificationForm.control}\n                name=\"location\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"flex items-center gap-2\">\n                      <MapPin className=\"h-4 w-4\" />\n                      Campus Location\n                    </FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"e.g., EKSU Main Campus, Block A\"\n                        {...field}\n                        data-testid=\"input-verification-location\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      Your campus area or hostel location\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={verificationForm.control}\n                name=\"ninNumber\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"flex items-center gap-2\">\n                      <Shield className=\"h-4 w-4\" />\n                      NIN (National Identification Number)\n                    </FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"11-digit NIN\"\n                        maxLength={11}\n                        {...field}\n                        data-testid=\"input-verification-nin\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      Optional - for enhanced verification and trust\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              {verificationForm.formState.errors.root && (\n                <p className=\"text-sm text-destructive\">\n                  {verificationForm.formState.errors.root.message}\n                </p>\n              )}\n\n              <DialogFooter className=\"gap-2 sm:gap-0\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setVerificationModalOpen(false)}\n                  data-testid=\"button-cancel-verification\"\n                >\n                  Cancel\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={verificationMutation.isPending}\n                  data-testid=\"button-submit-verification\"\n                >\n                  {verificationMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      Verifying...\n                    </>\n                  ) : (\n                    <>\n                      <CheckCircle2 className=\"mr-2 h-4 w-4\" />\n                      Verify Account\n                    </>\n                  )}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":42282,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route, useLocation } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { ThemeProvider } from \"@/contexts/ThemeContext\";\nimport { ErrorBoundary } from \"@/components/ErrorBoundary\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Header } from \"@/components/Header\";\nimport { BottomNav } from \"@/components/BottomNav\";\nimport ChatBot from \"@/components/ChatBot\";\nimport { setupGlobalErrorHandler } from \"@/lib/globalErrorHandler\";\nimport { lazy, Suspense, useEffect } from \"react\";\nimport { PWAInstallPrompt } from \"@/components/PWAInstallPrompt\";\nimport { OfflineIndicator } from \"@/components/OfflineIndicator\";\nimport { BackToTop } from \"@/components/BackToTop\";\nimport { EmailVerificationBanner } from \"@/components/EmailVerificationBanner\";\n\nconst NotFound = lazy(() => import(\"@/pages/not-found\"));\nconst Landing = lazy(() => import(\"@/pages/landing\"));\nconst Home = lazy(() => import(\"@/pages/home\"));\nconst ProductView = lazy(() => import(\"@/pages/product-view\"));\nconst CreateProduct = lazy(() => import(\"@/pages/product-detail\"));\nconst Messages = lazy(() => import(\"@/pages/messages\"));\nconst Profile = lazy(() => import(\"@/pages/profile\"));\nconst SellerDashboard = lazy(() => import(\"@/pages/seller-dashboard\"));\nconst AdminPanel = lazy(() => import(\"@/pages/admin\"));\nconst WalletPage = lazy(() => import(\"@/pages/wallet\"));\nconst ReferralsPage = lazy(() => import(\"@/pages/referrals\"));\nconst NotificationsPage = lazy(() => import(\"@/pages/notifications\"));\nconst MyAdsPage = lazy(() => import(\"@/pages/my-ads\"));\nconst GamesPage = lazy(() => import(\"@/pages/games\"));\nconst SupportPage = lazy(() => import(\"@/pages/support\"));\nconst AnnouncementsPage = lazy(() => import(\"@/pages/announcements\"));\nconst CheckoutPage = lazy(() => import(\"@/pages/checkout\"));\nconst ThePlugPage = lazy(() => import(\"@/pages/the-plug\"));\nconst PaymentCallbackPage = lazy(() => import(\"@/pages/payment-callback\"));\nconst WishlistPage = lazy(() => import(\"@/pages/wishlist\"));\nconst VtuPage = lazy(() => import(\"@/pages/vtu\"));\nconst SettingsPage = lazy(() => import(\"@/pages/settings\"));\nconst LegalPage = lazy(() => import(\"@/pages/legal\"));\nconst KYCVerification = lazy(() => import(\"@/pages/kyc-verification\"));\nconst StoriesPage = lazy(() => import(\"@/pages/stories\"));\nconst ConfessionsPage = lazy(() => import(\"@/pages/confessions\"));\nconst CommunitiesPage = lazy(() => import(\"@/pages/communities\"));\nconst SecretMessagesPage = lazy(() => import(\"@/pages/secret-messages\"));\nconst SendSecretPage = lazy(() => import(\"@/pages/send-secret\"));\nconst SecretHubPage = lazy(() => import(\"@/pages/secret-hub\"));\nconst StudyMaterialsPage = lazy(() => import(\"@/pages/study-materials\"));\nconst HostelsPage = lazy(() => import(\"@/pages/hostels\"));\n\nfunction PageLoadingSpinner() {\n  return (\n    <div className=\"flex h-screen w-full items-center justify-center bg-background\">\n      <div className=\"text-center\">\n        <div className=\"inline-block h-10 w-10 animate-spin rounded-full border-4 border-solid border-primary border-r-transparent\"></div>\n        <p className=\"mt-4 text-sm text-muted-foreground\">Loading...</p>\n      </div>\n    </div>\n  );\n}\n\nfunction Router() {\n  const { isAuthenticated, isLoading, isError, isEmailVerified, isAdmin } = useAuth();\n  const [location] = useLocation();\n\n  // Check if current path is a public secret message route\n  const isPublicSecretRoute = location === '/secret' || location.startsWith('/secret/');\n\n  // Show loading spinner while checking authentication (but not for public routes)\n  if (isLoading && !isPublicSecretRoute) {\n    return (\n      <div className=\"flex h-screen w-full items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent\"></div>\n          <p className=\"mt-4 text-muted-foreground\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Handle public secret message route - accessible without authentication\n  if (isPublicSecretRoute) {\n    return (\n      <ErrorBoundary>\n        <Suspense fallback={<PageLoadingSpinner />}>\n          <Switch>\n            <Route path=\"/secret\" component={() => (\n              <ErrorBoundary>\n                <SecretHubPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/secret/:code\" component={() => (\n              <ErrorBoundary>\n                <SendSecretPage />\n              </ErrorBoundary>\n            )} />\n            <Route component={() => (\n              <ErrorBoundary>\n                <NotFound />\n              </ErrorBoundary>\n            )} />\n          </Switch>\n        </Suspense>\n      </ErrorBoundary>\n    );\n  }\n\n  // Show landing page for unauthenticated users or auth errors\n  if (!isAuthenticated || isError) {\n    return (\n      <ErrorBoundary>\n        <Suspense fallback={<PageLoadingSpinner />}>\n          <Landing />\n        </Suspense>\n      </ErrorBoundary>\n    );\n  }\n\n  // Show authenticated app\n  return (\n    <>\n      <Header />\n      <main className=\"pb-16 lg:pb-0\">\n        {/* Show email verification banner for non-admin users who haven't verified */}\n        {!isEmailVerified && !isAdmin && (\n          <div className=\"px-4 pt-2\">\n            <EmailVerificationBanner />\n          </div>\n        )}\n        <Suspense fallback={<PageLoadingSpinner />}>\n          <Switch>\n            <Route path=\"/\" component={() => (\n              <ErrorBoundary>\n                <Home />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/products/new\" component={() => (\n              <ErrorBoundary>\n                <CreateProduct />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/products/:id\" component={() => (\n              <ErrorBoundary>\n                <ProductView />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/products/:id/edit\" component={() => (\n              <ErrorBoundary>\n                <CreateProduct />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/messages\" component={() => (\n              <ErrorBoundary>\n                <Messages />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/messages/:userId\" component={() => (\n              <ErrorBoundary>\n                <Messages />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/chat/:userId\" component={() => (\n              <ErrorBoundary>\n                <Messages />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/profile/:userId?\" component={() => (\n              <ErrorBoundary>\n                <Profile />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/seller/dashboard\" component={() => (\n              <ErrorBoundary>\n                <SellerDashboard />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/admin\" component={() => (\n              <ErrorBoundary>\n                <AdminPanel />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/wallet\" component={() => (\n              <ErrorBoundary>\n                <WalletPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/referrals\" component={() => (\n              <ErrorBoundary>\n                <ReferralsPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/notifications\" component={() => (\n              <ErrorBoundary>\n                <NotificationsPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/my-ads\" component={() => (\n              <ErrorBoundary>\n                <MyAdsPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/games\" component={() => (\n              <ErrorBoundary>\n                <GamesPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/support\" component={() => (\n              <ErrorBoundary>\n                <SupportPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/announcements\" component={() => (\n              <ErrorBoundary>\n                <AnnouncementsPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/the-plug\" component={() => (\n              <ErrorBoundary>\n                <ThePlugPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/checkout\" component={() => (\n              <ErrorBoundary>\n                <CheckoutPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/payment/callback\" component={() => (\n              <ErrorBoundary>\n                <PaymentCallbackPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/wishlist\" component={() => (\n              <ErrorBoundary>\n                <WishlistPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/vtu\" component={() => (\n              <ErrorBoundary>\n                <VtuPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/settings\" component={() => (\n              <ErrorBoundary>\n                <SettingsPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/legal\" component={() => (\n              <ErrorBoundary>\n                <LegalPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/kyc\" component={() => (\n              <ErrorBoundary>\n                <KYCVerification />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/stories\" component={() => (\n              <ErrorBoundary>\n                <StoriesPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/confessions\" component={() => (\n              <ErrorBoundary>\n                <ConfessionsPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/communities\" component={() => (\n              <ErrorBoundary>\n                <CommunitiesPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/secret-messages\" component={() => (\n              <ErrorBoundary>\n                <SecretMessagesPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/study-materials\" component={() => (\n              <ErrorBoundary>\n                <StudyMaterialsPage />\n              </ErrorBoundary>\n            )} />\n            <Route path=\"/hostels\" component={() => (\n              <ErrorBoundary>\n                <HostelsPage />\n              </ErrorBoundary>\n            )} />\n            <Route component={() => (\n              <ErrorBoundary>\n                <NotFound />\n              </ErrorBoundary>\n            )} />\n          </Switch>\n        </Suspense>\n      </main>\n      <BottomNav />\n    </>\n  );\n}\n\nfunction App() {\n  useEffect(() => {\n    setupGlobalErrorHandler();\n\n    if ('serviceWorker' in navigator) {\n      navigator.serviceWorker.register('/sw.js').catch(() => {});\n    }\n  }, []);\n\n  return (\n    <ErrorBoundary>\n      <QueryClientProvider client={queryClient}>\n        <ThemeProvider>\n          <TooltipProvider>\n            <OfflineIndicator />\n            <Toaster />\n            <Router />\n            <ChatBot />\n            <BackToTop />\n            <PWAInstallPrompt />\n          </TooltipProvider>\n        </ThemeProvider>\n      </QueryClientProvider>\n    </ErrorBoundary>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":11679,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"client/src/components/BottomNav.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { Home, Zap, MessageSquare, Gamepad2, User } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\n\ninterface NavItemProps {\n  icon: React.ReactNode;\n  label: string;\n  href: string;\n  isActive: boolean;\n  testId: string;\n}\n\nfunction NavItem({ icon, label, href, isActive, testId }: NavItemProps) {\n  return (\n    <Link href={href}>\n      <Button\n        variant=\"ghost\"\n        className={cn(\n          \"flex flex-col items-center justify-center h-full w-full gap-0.5 rounded-none\",\n          isActive && \"text-primary\"\n        )}\n        data-testid={testId}\n      >\n        <div className=\"h-5 w-5\">{icon}</div>\n        <span className=\"text-xs\">{label}</span>\n      </Button>\n    </Link>\n  );\n}\n\nexport function BottomNav() {\n  const [location] = useLocation();\n\n  const isActive = (path: string) => {\n    if (path === \"/\") {\n      return location === \"/\";\n    }\n    return location.startsWith(path);\n  };\n\n  return (\n    <nav\n      className=\"fixed bottom-0 left-0 right-0 z-50 border-t bg-background lg:hidden\"\n      data-testid=\"bottom-nav\"\n    >\n      <div className=\"grid h-16 grid-cols-5\">\n        <NavItem\n          icon={<Home className=\"h-5 w-5\" />}\n          label=\"Home\"\n          href=\"/\"\n          isActive={isActive(\"/\")}\n          testId=\"button-nav-home\"\n        />\n\n        <NavItem\n          icon={<Zap className=\"h-5 w-5\" />}\n          label=\"The Plug\"\n          href=\"/the-plug\"\n          isActive={isActive(\"/the-plug\")}\n          testId=\"button-nav-plug\"\n        />\n\n        <NavItem\n          icon={<MessageSquare className=\"h-5 w-5\" />}\n          label=\"Messages\"\n          href=\"/messages\"\n          isActive={isActive(\"/messages\")}\n          testId=\"button-nav-messages\"\n        />\n\n        <NavItem\n          icon={<Gamepad2 className=\"h-5 w-5\" />}\n          label=\"Games\"\n          href=\"/games\"\n          isActive={isActive(\"/games\")}\n          testId=\"button-nav-games\"\n        />\n\n        <NavItem\n          icon={<User className=\"h-5 w-5\" />}\n          label=\"Profile\"\n          href=\"/profile\"\n          isActive={isActive(\"/profile\")}\n          testId=\"button-nav-profile\"\n        />\n      </div>\n    </nav>\n  );\n}\n","path":null,"size_bytes":2254,"size_tokens":null},"scripts/migrate-neon.ts":{"content":"import { neon } from \"@neondatabase/serverless\";\n\nconst NEON_URL = \"postgresql://neondb_owner:npg_4Eswfa6SyHgC@ep-ancient-dust-agz33a36.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require\";\n\nasync function migrate() {\n  const sql = neon(NEON_URL);\n\n  console.log(\"Starting Neon database migration...\");\n\n  const migrations = [\n    // Add user_role enum if missing\n    `DO $$ BEGIN\n      CREATE TYPE user_role AS ENUM ('buyer', 'seller', 'both', 'admin');\n    EXCEPTION\n      WHEN duplicate_object THEN null;\n    END $$;`,\n\n    // Add product_condition enum if missing\n    `DO $$ BEGIN\n      CREATE TYPE product_condition AS ENUM ('new', 'like_new', 'good', 'fair');\n    EXCEPTION\n      WHEN duplicate_object THEN null;\n    END $$;`,\n\n    // Add transaction_type enum if missing\n    `DO $$ BEGIN\n      CREATE TYPE transaction_type AS ENUM (\n        'welcome_bonus', 'referral_bonus', 'login_reward', 'deposit', 'sale', 'purchase',\n        'boost_payment', 'featured_payment', 'escrow_hold', 'escrow_release', 'escrow_fee',\n        'refund', 'withdrawal', 'agent_commission', 'platform_fee'\n      );\n    EXCEPTION\n      WHEN duplicate_object THEN null;\n    END $$;`,\n\n    // Add escrow_status enum if missing\n    `DO $$ BEGIN\n      CREATE TYPE escrow_status AS ENUM ('pending', 'held', 'released', 'refunded', 'disputed');\n    EXCEPTION\n      WHEN duplicate_object THEN null;\n    END $$;`,\n\n    // Add notification_type enum if missing\n    `DO $$ BEGIN\n      CREATE TYPE notification_type AS ENUM (\n        'message', 'sale', 'purchase', 'review', 'follow', 'product_update',\n        'announcement', 'dispute', 'verification_approved', 'verification_rejected',\n        'escrow_released', 'wallet_credit', 'boost_expired', 'price_alert'\n      );\n    EXCEPTION\n      WHEN duplicate_object THEN null;\n    END $$;`,\n\n    // Add announcement_category enum if missing\n    `DO $$ BEGIN\n      CREATE TYPE announcement_category AS ENUM ('update', 'feature', 'alert');\n    EXCEPTION\n      WHEN duplicate_object THEN null;\n    END $$;`,\n\n    // Add announcement_priority enum if missing\n    `DO $$ BEGIN\n      CREATE TYPE announcement_priority AS ENUM ('low', 'normal', 'high');\n    EXCEPTION\n      WHEN duplicate_object THEN null;\n    END $$;`,\n\n    // Add missing columns to users table\n    `ALTER TABLE users ADD COLUMN IF NOT EXISTS referral_code VARCHAR(8) UNIQUE`,\n    `ALTER TABLE users ADD COLUMN IF NOT EXISTS nin_verified BOOLEAN DEFAULT false`,\n    `ALTER TABLE users ADD COLUMN IF NOT EXISTS nin_verification_date TIMESTAMP`,\n    `ALTER TABLE users ADD COLUMN IF NOT EXISTS nin_hash VARCHAR UNIQUE`,\n    `ALTER TABLE users ADD COLUMN IF NOT EXISTS nin_vnin VARCHAR`,\n    `ALTER TABLE users ADD COLUMN IF NOT EXISTS nin_confidence_score DECIMAL(5,2)`,\n    `ALTER TABLE users ADD COLUMN IF NOT EXISTS instagram_handle VARCHAR`,\n    `ALTER TABLE users ADD COLUMN IF NOT EXISTS tiktok_handle VARCHAR`,\n    `ALTER TABLE users ADD COLUMN IF NOT EXISTS facebook_profile VARCHAR`,\n    `ALTER TABLE users ADD COLUMN IF NOT EXISTS is_trusted_seller BOOLEAN DEFAULT false`,\n    `ALTER TABLE users ADD COLUMN IF NOT EXISTS trusted_seller_since TIMESTAMP`,\n\n    // Create wallets table if not exists\n    `CREATE TABLE IF NOT EXISTS wallets (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      user_id VARCHAR NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,\n      balance DECIMAL(10,2) NOT NULL DEFAULT 0.00,\n      escrow_balance DECIMAL(10,2) NOT NULL DEFAULT 0.00,\n      total_earned DECIMAL(10,2) NOT NULL DEFAULT 0.00,\n      total_spent DECIMAL(10,2) NOT NULL DEFAULT 0.00,\n      created_at TIMESTAMP DEFAULT NOW(),\n      updated_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create transactions table if not exists\n    `CREATE TABLE IF NOT EXISTS transactions (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      wallet_id VARCHAR NOT NULL REFERENCES wallets(id) ON DELETE CASCADE,\n      type transaction_type NOT NULL,\n      amount DECIMAL(10,2) NOT NULL,\n      description TEXT,\n      related_product_id VARCHAR REFERENCES products(id) ON DELETE SET NULL,\n      related_user_id VARCHAR REFERENCES users(id) ON DELETE SET NULL,\n      status VARCHAR(20) DEFAULT 'completed',\n      created_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create referrals table if not exists\n    `CREATE TABLE IF NOT EXISTS referrals (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      referrer_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      referred_user_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      bonus_amount DECIMAL(10,2),\n      bonus_paid BOOLEAN DEFAULT false,\n      referred_user_made_purchase BOOLEAN DEFAULT false,\n      first_purchase_id VARCHAR,\n      bonus_paid_at TIMESTAMP,\n      created_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create welcome_bonuses table if not exists\n    `CREATE TABLE IF NOT EXISTS welcome_bonuses (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      user_id VARCHAR NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,\n      amount DECIMAL(10,2) NOT NULL,\n      claimed BOOLEAN DEFAULT true,\n      created_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create login_streaks table if not exists\n    `CREATE TABLE IF NOT EXISTS login_streaks (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      user_id VARCHAR NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,\n      current_streak INTEGER DEFAULT 0,\n      longest_streak INTEGER DEFAULT 0,\n      last_login_date TIMESTAMP,\n      total_rewards DECIMAL(10,2) DEFAULT 0.00,\n      created_at TIMESTAMP DEFAULT NOW(),\n      updated_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create seller_analytics table if not exists\n    `CREATE TABLE IF NOT EXISTS seller_analytics (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      seller_id VARCHAR NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,\n      total_views INTEGER DEFAULT 0,\n      total_messages INTEGER DEFAULT 0,\n      conversion_rate DECIMAL(5,2) DEFAULT 0.00,\n      best_posting_hour INTEGER,\n      best_posting_day INTEGER,\n      updated_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create saved_searches table if not exists\n    `CREATE TABLE IF NOT EXISTS saved_searches (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      user_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      query VARCHAR(200) NOT NULL,\n      filters JSONB,\n      max_price DECIMAL(10,2),\n      alert_enabled BOOLEAN DEFAULT true,\n      last_alert_sent TIMESTAMP,\n      created_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create draft_products table if not exists\n    `CREATE TABLE IF NOT EXISTS draft_products (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      seller_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      data JSONB NOT NULL,\n      created_at TIMESTAMP DEFAULT NOW(),\n      updated_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create scheduled_posts table if not exists\n    `CREATE TABLE IF NOT EXISTS scheduled_posts (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      seller_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      product_data JSONB NOT NULL,\n      scheduled_for TIMESTAMP NOT NULL,\n      published BOOLEAN DEFAULT false,\n      published_product_id VARCHAR REFERENCES products(id) ON DELETE SET NULL,\n      created_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create boost_requests table if not exists\n    `CREATE TABLE IF NOT EXISTS boost_requests (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      product_id VARCHAR NOT NULL REFERENCES products(id) ON DELETE CASCADE,\n      seller_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      type VARCHAR(20) NOT NULL,\n      duration INTEGER NOT NULL,\n      amount DECIMAL(10,2) NOT NULL,\n      status VARCHAR(20) DEFAULT 'pending',\n      expires_at TIMESTAMP NOT NULL,\n      created_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create disputes table if not exists\n    `CREATE TABLE IF NOT EXISTS disputes (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      product_id VARCHAR REFERENCES products(id) ON DELETE SET NULL,\n      buyer_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      seller_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      reason TEXT NOT NULL,\n      description TEXT NOT NULL,\n      evidence TEXT[] DEFAULT ARRAY[]::text[],\n      status VARCHAR(20) DEFAULT 'open',\n      resolution TEXT,\n      resolved_by VARCHAR REFERENCES users(id) ON DELETE SET NULL,\n      created_at TIMESTAMP DEFAULT NOW(),\n      resolved_at TIMESTAMP\n    )`,\n\n    // Create support_tickets table if not exists\n    `CREATE TABLE IF NOT EXISTS support_tickets (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      user_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      subject VARCHAR(200) NOT NULL,\n      message TEXT NOT NULL,\n      category VARCHAR(50),\n      priority VARCHAR(20) DEFAULT 'medium',\n      attachments TEXT[] DEFAULT ARRAY[]::text[],\n      status VARCHAR(20) DEFAULT 'open',\n      assigned_to VARCHAR REFERENCES users(id) ON DELETE SET NULL,\n      response TEXT,\n      created_at TIMESTAMP DEFAULT NOW(),\n      updated_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create follows table if not exists\n    `CREATE TABLE IF NOT EXISTS follows (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      follower_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      following_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      created_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create notifications table if not exists\n    `CREATE TABLE IF NOT EXISTS notifications (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      user_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      type notification_type NOT NULL,\n      title VARCHAR(200) NOT NULL,\n      message TEXT NOT NULL,\n      link VARCHAR,\n      is_read BOOLEAN DEFAULT false,\n      related_user_id VARCHAR REFERENCES users(id) ON DELETE SET NULL,\n      related_product_id VARCHAR REFERENCES products(id) ON DELETE SET NULL,\n      created_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create announcements table if not exists\n    `CREATE TABLE IF NOT EXISTS announcements (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      author_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      title VARCHAR(200) NOT NULL,\n      content TEXT NOT NULL,\n      category announcement_category NOT NULL DEFAULT 'update',\n      priority announcement_priority NOT NULL DEFAULT 'normal',\n      is_pinned BOOLEAN DEFAULT false,\n      is_published BOOLEAN DEFAULT true,\n      views INTEGER DEFAULT 0,\n      created_at TIMESTAMP DEFAULT NOW(),\n      updated_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create escrow_transactions table if not exists\n    `CREATE TABLE IF NOT EXISTS escrow_transactions (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      buyer_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      seller_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      product_id VARCHAR REFERENCES products(id) ON DELETE SET NULL,\n      hostel_id VARCHAR,\n      amount DECIMAL(10,2) NOT NULL,\n      platform_fee DECIMAL(10,2) NOT NULL,\n      status escrow_status NOT NULL DEFAULT 'pending',\n      hold_duration INTEGER DEFAULT 7,\n      released_at TIMESTAMP,\n      dispute_id VARCHAR,\n      buyer_confirmed BOOLEAN DEFAULT false,\n      seller_confirmed BOOLEAN DEFAULT false,\n      auto_release_date TIMESTAMP,\n      created_at TIMESTAMP DEFAULT NOW(),\n      updated_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create search_history table if not exists\n    `CREATE TABLE IF NOT EXISTS search_history (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      user_id VARCHAR REFERENCES users(id) ON DELETE CASCADE,\n      query VARCHAR(200) NOT NULL,\n      filters JSONB,\n      result_count INTEGER,\n      created_at TIMESTAMP DEFAULT NOW()\n    )`,\n\n    // Create cart_items table if not exists\n    `CREATE TABLE IF NOT EXISTS cart_items (\n      id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,\n      user_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n      product_id VARCHAR NOT NULL REFERENCES products(id) ON DELETE CASCADE,\n      quantity INTEGER NOT NULL DEFAULT 1,\n      created_at TIMESTAMP DEFAULT NOW(),\n      updated_at TIMESTAMP DEFAULT NOW()\n    )`,\n  ];\n\n  let successCount = 0;\n  let errorCount = 0;\n\n  for (const migration of migrations) {\n    try {\n      await sql(migration);\n      successCount++;\n      console.log(`✓ Migration ${successCount} completed`);\n    } catch (error: any) {\n      if (error.message?.includes(\"already exists\") || error.message?.includes(\"duplicate\")) {\n        console.log(`⊘ Skipped (already exists): ${migration.slice(0, 50)}...`);\n        successCount++;\n      } else {\n        console.error(`✗ Error: ${error.message}`);\n        console.error(`  Query: ${migration.slice(0, 100)}...`);\n        errorCount++;\n      }\n    }\n  }\n\n  console.log(`\\n✓ Migration complete: ${successCount} successful, ${errorCount} errors`);\n}\n\nmigrate().catch(console.error);\n","path":null,"size_bytes":13236,"size_tokens":null},"client/src/components/SafetyShieldModal.tsx":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Shield, AlertTriangle, Wallet, MapPin } from \"lucide-react\";\n\ninterface SafetyShieldModalProps {\n  sellerId: string;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onAcknowledge: () => void;\n}\n\nconst STORAGE_KEY_PREFIX = \"safety_acknowledged_\";\n\nexport function getSafetyAcknowledgedKey(sellerId: string): string {\n  return `${STORAGE_KEY_PREFIX}${sellerId}`;\n}\n\nexport function hasSafetyBeenAcknowledged(sellerId: string): boolean {\n  if (typeof window === \"undefined\") return false;\n  return localStorage.getItem(getSafetyAcknowledgedKey(sellerId)) === \"true\";\n}\n\nexport function acknowledgeSafety(sellerId: string): void {\n  if (typeof window === \"undefined\") return;\n  localStorage.setItem(getSafetyAcknowledgedKey(sellerId), \"true\");\n}\n\nexport function SafetyShieldModal({\n  sellerId,\n  open,\n  onOpenChange,\n  onAcknowledge,\n}: SafetyShieldModalProps) {\n  const handleAcknowledge = useCallback(() => {\n    acknowledgeSafety(sellerId);\n    onAcknowledge();\n    onOpenChange(false);\n  }, [sellerId, onAcknowledge, onOpenChange]);\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-md\" data-testid=\"modal-safety-shield\">\n        <DialogHeader>\n          <div className=\"flex items-center justify-center mb-2\">\n            <div className=\"flex items-center justify-center w-16 h-16 rounded-full bg-primary/10\">\n              <Shield className=\"w-8 h-8 text-primary\" />\n            </div>\n          </div>\n          <DialogTitle className=\"text-center text-xl\">\n            Safety First\n          </DialogTitle>\n          <DialogDescription className=\"text-center\">\n            Before you start chatting, please review these important safety guidelines\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4 py-4\">\n          <div className=\"flex items-start gap-3 p-3 bg-destructive/10 rounded-lg border border-destructive/20\">\n            <AlertTriangle className=\"w-5 h-5 text-destructive flex-shrink-0 mt-0.5\" />\n            <div>\n              <p className=\"font-medium text-sm\" data-testid=\"text-safety-warning\">\n                Do not pay this seller directly via bank transfer\n              </p>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                Direct payments are risky and not protected by EKSU Marketplace\n              </p>\n            </div>\n          </div>\n\n          <div className=\"flex items-start gap-3 p-3 bg-primary/10 rounded-lg border border-primary/20\">\n            <Wallet className=\"w-5 h-5 text-primary flex-shrink-0 mt-0.5\" />\n            <div>\n              <p className=\"font-medium text-sm\" data-testid=\"text-safety-rule\">\n                Only pay through the EKSU Marketplace Wallet/Escrow\n              </p>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                Your money is held safely until you receive your item\n              </p>\n            </div>\n          </div>\n\n          <div className=\"flex items-start gap-3 p-3 bg-green-500/10 dark:bg-green-500/20 rounded-lg border border-green-500/20 dark:border-green-500/30\">\n            <MapPin className=\"w-5 h-5 text-green-600 dark:text-green-400 flex-shrink-0 mt-0.5\" />\n            <div>\n              <p className=\"font-medium text-sm\" data-testid=\"text-safety-tip\">\n                Meet in open campus areas (e.g., SUB, Faculty building)\n              </p>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                Always meet in busy, well-lit public spaces\n              </p>\n            </div>\n          </div>\n        </div>\n\n        <DialogFooter className=\"sm:justify-center\">\n          <Button\n            onClick={handleAcknowledge}\n            className=\"w-full sm:w-auto min-w-[200px]\"\n            data-testid=\"button-safety-acknowledge\"\n          >\n            <Shield className=\"w-4 h-4 mr-2\" />\n            I Understand\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nexport default SafetyShieldModal;\n","path":null,"size_bytes":4285,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 0 0% 100%;\n  --foreground: 0 0% 9%;\n  --border: 0 0% 90%;\n  --card: 0 0% 98%;\n  --card-foreground: 0 0% 9%;\n  --card-border: 0 0% 94%;\n  --sidebar: 0 0% 96%;\n  --sidebar-foreground: 0 0% 9%;\n  --sidebar-border: 0 0% 92%;\n  --sidebar-primary: 142 76% 36%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 0 0% 92%;\n  --sidebar-accent-foreground: 0 0% 9%;\n  --sidebar-ring: 142 76% 36%;\n  --popover: 0 0% 95%;\n  --popover-foreground: 0 0% 9%;\n  --popover-border: 0 0% 91%;\n  --primary: 142 76% 36%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 0 0% 93%;\n  --secondary-foreground: 0 0% 9%;\n  --muted: 0 0% 94%;\n  --muted-foreground: 0 0% 45%;\n  --accent: 142 8% 94%;\n  --accent-foreground: 0 0% 9%;\n  --destructive: 0 84% 42%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 0 0% 75%;\n  --ring: 142 76% 36%;\n  --chart-1: 142 76% 36%;\n  --chart-2: 32 95% 44%;\n  --chart-3: 221 83% 53%;\n  --chart-4: 280 65% 60%;\n  --chart-5: 340 82% 52%;\n  --font-sans: Inter, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: .5rem;\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 2px 4px -1px hsl(0 0% 0% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 4px 6px -1px hsl(0 0% 0% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 8px 10px -1px hsl(0 0% 0% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n/* DIM MODE - Twitter-style dark blue theme */\n.dark.dim {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 210 33% 13%;\n  --foreground: 180 14% 97%;\n  --border: 210 20% 22%;\n  --card: 210 32% 16%;\n  --card-foreground: 180 14% 97%;\n  --card-border: 210 25% 19%;\n  --sidebar: 210 30% 15%;\n  --sidebar-foreground: 180 14% 97%;\n  --sidebar-border: 210 22% 18%;\n  --sidebar-primary: 142 76% 36%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 210 25% 20%;\n  --sidebar-accent-foreground: 180 14% 97%;\n  --sidebar-ring: 142 76% 36%;\n  --popover: 210 30% 17%;\n  --popover-foreground: 180 14% 97%;\n  --popover-border: 210 22% 20%;\n  --primary: 142 76% 36%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 210 25% 19%;\n  --secondary-foreground: 180 14% 97%;\n  --muted: 210 22% 18%;\n  --muted-foreground: 210 15% 60%;\n  --accent: 142 15% 18%;\n  --accent-foreground: 180 14% 97%;\n  --destructive: 0 84% 42%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 210 20% 30%;\n  --ring: 142 76% 36%;\n  --chart-1: 142 70% 65%;\n  --chart-2: 32 98% 70%;\n  --chart-3: 221 83% 70%;\n  --chart-4: 280 65% 75%;\n  --chart-5: 340 82% 68%;\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 2px 4px -1px hsl(0 0% 0% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 4px 6px -1px hsl(0 0% 0% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 8px 10px -1px hsl(0 0% 0% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n/* LIGHTS OUT MODE - Pure black AMOLED-friendly theme */\n.dark.lights-out {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 0 0% 0%;\n  --foreground: 0 0% 100%;\n  --border: 210 6% 20%;\n  --card: 220 12% 10%;\n  --card-foreground: 0 0% 100%;\n  --card-border: 210 6% 15%;\n  --sidebar: 220 10% 8%;\n  --sidebar-foreground: 0 0% 100%;\n  --sidebar-border: 210 6% 12%;\n  --sidebar-primary: 142 76% 36%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 220 8% 14%;\n  --sidebar-accent-foreground: 0 0% 100%;\n  --sidebar-ring: 142 76% 36%;\n  --popover: 220 10% 8%;\n  --popover-foreground: 0 0% 100%;\n  --popover-border: 210 6% 14%;\n  --primary: 142 76% 36%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 220 8% 12%;\n  --secondary-foreground: 0 0% 100%;\n  --muted: 220 6% 10%;\n  --muted-foreground: 0 0% 60%;\n  --accent: 142 10% 12%;\n  --accent-foreground: 0 0% 100%;\n  --destructive: 0 84% 42%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 210 6% 22%;\n  --ring: 142 76% 36%;\n  --chart-1: 142 70% 65%;\n  --chart-2: 32 98% 70%;\n  --chart-3: 221 83% 70%;\n  --chart-4: 280 65% 75%;\n  --chart-5: 340 82% 68%;\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 2px 4px -1px hsl(0 0% 0% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 4px 6px -1px hsl(0 0% 0% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 8px 10px -1px hsl(0 0% 0% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n/* SUNSET MODE - Warm orange & purple theme */\n.dark.sunset {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 20 30% 10%;\n  --foreground: 30 20% 95%;\n  --border: 20 25% 20%;\n  --card: 20 28% 14%;\n  --card-foreground: 30 20% 95%;\n  --card-border: 20 22% 18%;\n  --sidebar: 20 25% 12%;\n  --sidebar-foreground: 30 20% 95%;\n  --sidebar-border: 20 20% 16%;\n  --sidebar-primary: 25 95% 55%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 20 22% 18%;\n  --sidebar-accent-foreground: 30 20% 95%;\n  --sidebar-ring: 25 95% 55%;\n  --popover: 20 25% 13%;\n  --popover-foreground: 30 20% 95%;\n  --popover-border: 20 22% 17%;\n  --primary: 25 95% 55%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 20 22% 16%;\n  --secondary-foreground: 30 20% 95%;\n  --muted: 20 18% 14%;\n  --muted-foreground: 30 15% 55%;\n  --accent: 280 30% 20%;\n  --accent-foreground: 30 20% 95%;\n  --destructive: 0 84% 50%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 20 22% 24%;\n  --ring: 25 95% 55%;\n  --chart-1: 25 95% 60%;\n  --chart-2: 280 60% 65%;\n  --chart-3: 45 90% 55%;\n  --chart-4: 340 70% 60%;\n  --chart-5: 200 70% 55%;\n\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n/* OCEAN MODE - Deep blue & teal theme */\n.dark.ocean {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 200 50% 8%;\n  --foreground: 195 30% 95%;\n  --border: 200 40% 18%;\n  --card: 200 45% 12%;\n  --card-foreground: 195 30% 95%;\n  --card-border: 200 38% 16%;\n  --sidebar: 200 42% 10%;\n  --sidebar-foreground: 195 30% 95%;\n  --sidebar-border: 200 35% 14%;\n  --sidebar-primary: 175 70% 45%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 200 35% 16%;\n  --sidebar-accent-foreground: 195 30% 95%;\n  --sidebar-ring: 175 70% 45%;\n  --popover: 200 42% 11%;\n  --popover-foreground: 195 30% 95%;\n  --popover-border: 200 35% 15%;\n  --primary: 175 70% 45%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 200 35% 14%;\n  --secondary-foreground: 195 30% 95%;\n  --muted: 200 30% 12%;\n  --muted-foreground: 195 20% 55%;\n  --accent: 180 40% 18%;\n  --accent-foreground: 195 30% 95%;\n  --destructive: 0 84% 50%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 200 35% 22%;\n  --ring: 175 70% 45%;\n  --chart-1: 175 70% 55%;\n  --chart-2: 200 70% 60%;\n  --chart-3: 220 70% 65%;\n  --chart-4: 160 60% 50%;\n  --chart-5: 190 80% 55%;\n\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n/* FOREST MODE - Dark green theme */\n.dark.forest {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 145 35% 8%;\n  --foreground: 140 20% 95%;\n  --border: 145 30% 18%;\n  --card: 145 32% 12%;\n  --card-foreground: 140 20% 95%;\n  --card-border: 145 28% 16%;\n  --sidebar: 145 30% 10%;\n  --sidebar-foreground: 140 20% 95%;\n  --sidebar-border: 145 25% 14%;\n  --sidebar-primary: 150 60% 42%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 145 25% 16%;\n  --sidebar-accent-foreground: 140 20% 95%;\n  --sidebar-ring: 150 60% 42%;\n  --popover: 145 30% 11%;\n  --popover-foreground: 140 20% 95%;\n  --popover-border: 145 25% 15%;\n  --primary: 150 60% 42%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 145 25% 14%;\n  --secondary-foreground: 140 20% 95%;\n  --muted: 145 22% 12%;\n  --muted-foreground: 140 15% 55%;\n  --accent: 145 35% 18%;\n  --accent-foreground: 140 20% 95%;\n  --destructive: 0 84% 50%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 145 25% 22%;\n  --ring: 150 60% 42%;\n  --chart-1: 150 60% 50%;\n  --chart-2: 120 50% 55%;\n  --chart-3: 170 55% 50%;\n  --chart-4: 100 45% 50%;\n  --chart-5: 140 70% 45%;\n\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n/* SEPIA MODE - Warm reading mode (light variant) */\n.light.sepia {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 40 40% 94%;\n  --foreground: 35 30% 15%;\n  --border: 40 25% 82%;\n  --card: 40 35% 91%;\n  --card-foreground: 35 30% 15%;\n  --card-border: 40 28% 86%;\n  --sidebar: 40 32% 89%;\n  --sidebar-foreground: 35 30% 15%;\n  --sidebar-border: 40 25% 84%;\n  --sidebar-primary: 35 70% 40%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 40 28% 85%;\n  --sidebar-accent-foreground: 35 30% 15%;\n  --sidebar-ring: 35 70% 40%;\n  --popover: 40 32% 88%;\n  --popover-foreground: 35 30% 15%;\n  --popover-border: 40 25% 83%;\n  --primary: 35 70% 40%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 40 28% 86%;\n  --secondary-foreground: 35 30% 15%;\n  --muted: 40 25% 88%;\n  --muted-foreground: 35 20% 45%;\n  --accent: 35 30% 88%;\n  --accent-foreground: 35 30% 15%;\n  --destructive: 0 70% 45%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 40 25% 75%;\n  --ring: 35 70% 40%;\n  --chart-1: 35 70% 45%;\n  --chart-2: 20 65% 50%;\n  --chart-3: 45 60% 45%;\n  --chart-4: 10 55% 50%;\n  --chart-5: 30 80% 45%;\n\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n/* HIGH CONTRAST MODE - Maximum readability */\n.dark.high-contrast {\n  --button-outline: rgba(255,255,255, .20);\n  --badge-outline: rgba(255,255,255, .15);\n  --opaque-button-border-intensity: 12;\n  --elevate-1: rgba(255,255,255, .08);\n  --elevate-2: rgba(255,255,255, .15);\n  --background: 0 0% 0%;\n  --foreground: 0 0% 100%;\n  --border: 60 100% 50%;\n  --card: 0 0% 5%;\n  --card-foreground: 0 0% 100%;\n  --card-border: 60 100% 50%;\n  --sidebar: 0 0% 3%;\n  --sidebar-foreground: 0 0% 100%;\n  --sidebar-border: 60 100% 50%;\n  --sidebar-primary: 60 100% 50%;\n  --sidebar-primary-foreground: 0 0% 0%;\n  --sidebar-accent: 0 0% 12%;\n  --sidebar-accent-foreground: 0 0% 100%;\n  --sidebar-ring: 60 100% 50%;\n  --popover: 0 0% 5%;\n  --popover-foreground: 0 0% 100%;\n  --popover-border: 60 100% 50%;\n  --primary: 60 100% 50%;\n  --primary-foreground: 0 0% 0%;\n  --secondary: 0 0% 15%;\n  --secondary-foreground: 0 0% 100%;\n  --muted: 0 0% 10%;\n  --muted-foreground: 0 0% 80%;\n  --accent: 60 50% 15%;\n  --accent-foreground: 0 0% 100%;\n  --destructive: 0 100% 60%;\n  --destructive-foreground: 0 0% 100%;\n  --input: 0 0% 25%;\n  --ring: 60 100% 50%;\n  --chart-1: 60 100% 50%;\n  --chart-2: 0 100% 60%;\n  --chart-3: 180 100% 50%;\n  --chart-4: 300 100% 60%;\n  --chart-5: 120 100% 45%;\n\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n/* Fallback dark mode for compatibility (applies to both dim and lights-out base) */\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 0 0% 8%;\n  --foreground: 0 0% 98%;\n  --border: 0 0% 18%;\n  --card: 0 0% 10%;\n  --card-foreground: 0 0% 98%;\n  --card-border: 0 0% 13%;\n  --sidebar: 0 0% 12%;\n  --sidebar-foreground: 0 0% 98%;\n  --sidebar-border: 0 0% 15%;\n  --sidebar-primary: 142 76% 36%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 0 0% 15%;\n  --sidebar-accent-foreground: 0 0% 98%;\n  --sidebar-ring: 142 76% 36%;\n  --popover: 0 0% 14%;\n  --popover-foreground: 0 0% 98%;\n  --popover-border: 0 0% 17%;\n  --primary: 142 76% 36%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 0 0% 16%;\n  --secondary-foreground: 0 0% 98%;\n  --muted: 0 0% 15%;\n  --muted-foreground: 0 0% 65%;\n  --accent: 142 8% 16%;\n  --accent-foreground: 0 0% 98%;\n  --destructive: 0 84% 42%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 0 0% 28%;\n  --ring: 142 76% 36%;\n  --chart-1: 142 70% 65%;\n  --chart-2: 32 98% 70%;\n  --chart-3: 221 83% 70%;\n  --chart-4: 280 65% 75%;\n  --chart-5: 340 82% 68%;\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 2px 4px -1px hsl(0 0% 0% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 4px 6px -1px hsl(0 0% 0% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 8px 10px -1px hsl(0 0% 0% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  /* Fix mobile 100vh viewport bug - prevents white space on iOS/Android */\n  html {\n    height: 100%;\n    height: 100dvh;\n    height: -webkit-fill-available;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n    min-height: 100%;\n    min-height: 100dvh;\n    min-height: -webkit-fill-available;\n  }\n\n  /* Ensure app containers fill the viewport properly */\n  #root, .app, [class*=\"min-h-screen\"] {\n    min-height: 100dvh;\n    min-height: -webkit-fill-available;\n  }\n\n  /* Safe area insets for notched devices */\n  .safe-area-bottom {\n    padding-bottom: env(safe-area-inset-bottom);\n  }\n\n  .safe-area-top {\n    padding-top: env(safe-area-inset-top);\n  }\n\n  /* Fix keyboard covering input on mobile */\n  .keyboard-aware-input {\n    padding-bottom: env(safe-area-inset-bottom);\n  }\n\n  /* Chat input container stays above keyboard */\n  .chat-input-container {\n    position: sticky;\n    bottom: 0;\n    padding-bottom: env(safe-area-inset-bottom);\n    background: inherit;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n\n/* Splash screen animations */\n@keyframes fade-in {\n  from {\n    opacity: 0;\n    transform: scale(0.9);\n  }\n  to {\n    opacity: 1;\n    transform: scale(1);\n  }\n}\n\n@keyframes slide-up {\n  from {\n    opacity: 0;\n    transform: translateY(10px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n@keyframes pulse-scale {\n  0%, 100% {\n    transform: scale(1);\n    box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);\n  }\n  50% {\n    transform: scale(1.1);\n    box-shadow: 0 0 0 20px rgba(34, 197, 94, 0);\n  }\n}\n\n@keyframes progress-fill {\n  from {\n    width: 0;\n  }\n  to {\n    width: 100%;\n  }\n}\n\n.animate-fade-in {\n  animation: fade-in 0.5s ease-out forwards;\n}\n\n.animate-slide-up {\n  animation: slide-up 0.6s ease-out forwards;\n}\n\n.animate-pulse-scale {\n  animation: pulse-scale 1.5s ease-in-out 2;\n}\n\n.animate-fade-in-delayed {\n  animation: fade-in 0.5s ease-out 0.5s forwards;\n  opacity: 0;\n}\n\n.animate-fade-in-delayed-2 {\n  animation: fade-in 0.5s ease-out 0.7s forwards;\n  opacity: 0;\n}\n\n.animate-progress-fill {\n  animation: progress-fill 1.5s ease-out 0.8s forwards;\n  width: 0;\n}\n","path":null,"size_bytes":30526,"size_tokens":null},"server/auth.ts":{"content":"import passport from \"passport\";\nimport { Strategy as LocalStrategy } from \"passport-local\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport connectPg from \"connect-pg-simple\";\nimport bcrypt from \"bcryptjs\";\nimport { storage } from \"./storage\";\nimport type { SafeUser } from \"@shared/schema\";\n\nexport function getSession() {\n  const sessionTtl = 30 * 24 * 60 * 60 * 1000; // 30 days\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: true,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  const isProduction = process.env.NODE_ENV === \"production\";\n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    proxy: true,\n    cookie: {\n      httpOnly: true,\n      secure: isProduction,\n      sameSite: isProduction ? \"none\" : \"lax\",\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  passport.use(\n    new LocalStrategy(\n      {\n        usernameField: \"email\",\n        passwordField: \"password\",\n      },\n      async (email, password, done) => {\n        try {\n          const user = await storage.getUserByEmail(email);\n          \n          if (!user) {\n            return done(null, false, { message: \"Invalid email or password\" });\n          }\n\n          // Check if user has a password set (null for OAuth migrated users)\n          if (!user.password) {\n            return done(null, false, { message: \"Please set a password for your account\" });\n          }\n\n          const isValidPassword = await bcrypt.compare(password, user.password);\n          \n          if (!isValidPassword) {\n            return done(null, false, { message: \"Invalid email or password\" });\n          }\n\n          // Return user without password\n          const { password: _, ...safeUser } = user;\n          return done(null, safeUser as SafeUser);\n        } catch (error) {\n          return done(error);\n        }\n      }\n    )\n  );\n\n  passport.serializeUser((user: Express.User, done) => {\n    done(null, (user as SafeUser).id);\n  });\n\n  passport.deserializeUser(async (id: string, done) => {\n    try {\n      const user = await storage.getUser(id);\n      if (!user) {\n        return done(null, false);\n      }\n      // Return user without password\n      const { password: _, ...safeUser } = user;\n      done(null, safeUser);\n    } catch (error) {\n      done(error);\n    }\n  });\n}\n\nexport const isAuthenticated: RequestHandler = (req, res, next) => {\n  if (req.isAuthenticated()) {\n    return next();\n  }\n  res.status(401).json({ message: \"Unauthorized\" });\n};\n","path":null,"size_bytes":2832,"size_tokens":null},"server/squad.ts":{"content":"/**\n * Squad Payment Gateway Integration\n * \n * Clean implementation following official Squad API documentation:\n * https://docs.squadco.com\n * \n * Features:\n * - Payment initialization (Card, Bank Transfer, USSD)\n * - Transaction verification\n * - Disbursements/Transfers to bank accounts\n * - Account lookup/verification\n * - Webhook signature verification\n */\n\nimport crypto from 'crypto';\n\n// Squad API Configuration\nconst SQUAD_CONFIG = {\n  // Production URL (api-d.squadco.com) vs Sandbox (sandbox-api-d.squadco.com)\n  getBaseUrl: (): string => {\n    const secretKey = process.env.SQUAD_SECRET_KEY || '';\n    // Test keys start with sandbox_sk_ or sk_test_\n    if (secretKey.startsWith('sandbox_sk_') || secretKey.startsWith('sk_test_')) {\n      return 'https://sandbox-api-d.squadco.com';\n    }\n    return 'https://api-d.squadco.com';\n  },\n  getSecretKey: (): string => process.env.SQUAD_SECRET_KEY || '',\n  getPublicKey: (): string => process.env.SQUAD_PUBLIC_KEY || '',\n};\n\n// Error types for categorization\nexport enum SquadErrorType {\n  NETWORK_ERROR = 'NETWORK_ERROR',\n  TIMEOUT = 'TIMEOUT',\n  AUTHENTICATION_ERROR = 'AUTHENTICATION_ERROR',\n  VALIDATION_ERROR = 'VALIDATION_ERROR',\n  INVALID_REQUEST = 'INVALID_REQUEST',\n  INVALID_CREDENTIALS = 'INVALID_CREDENTIALS',\n  INSUFFICIENT_FUNDS = 'INSUFFICIENT_FUNDS',\n  RATE_LIMITED = 'RATE_LIMITED',\n  SERVER_ERROR = 'SERVER_ERROR',\n  UNKNOWN = 'UNKNOWN',\n}\n\n// Custom error class\nexport class SquadApiError extends Error {\n  public readonly type: SquadErrorType;\n  public readonly statusCode: number;\n  public readonly rawError: any;\n  public readonly userMessage: string;\n\n  constructor(\n    message: string,\n    type: SquadErrorType,\n    statusCode: number,\n    rawError?: any,\n    userMessage?: string\n  ) {\n    super(message);\n    this.name = 'SquadApiError';\n    this.type = type;\n    this.statusCode = statusCode;\n    this.rawError = rawError;\n    this.userMessage = userMessage || this.getDefaultUserMessage(type);\n  }\n\n  private getDefaultUserMessage(type: SquadErrorType): string {\n    switch (type) {\n      case SquadErrorType.NETWORK_ERROR:\n        return 'Unable to connect to payment service. Please check your internet and try again.';\n      case SquadErrorType.TIMEOUT:\n        return 'Payment request timed out. Please try again.';\n      case SquadErrorType.AUTHENTICATION_ERROR:\n        return 'Payment service configuration error. Please contact support.';\n      case SquadErrorType.VALIDATION_ERROR:\n        return 'Invalid payment details. Please check and try again.';\n      case SquadErrorType.INSUFFICIENT_FUNDS:\n        return 'Insufficient funds to complete this transaction.';\n      case SquadErrorType.RATE_LIMITED:\n        return 'Too many requests. Please wait a moment and try again.';\n      case SquadErrorType.SERVER_ERROR:\n        return 'Payment service is temporarily unavailable. Please try again later.';\n      default:\n        return 'An error occurred processing your payment. Please try again.';\n    }\n  }\n}\n\n// Type definitions\nexport interface InitializePaymentRequest {\n  amount: number; // Amount in Naira (will be converted to kobo)\n  email: string;\n  currency?: 'NGN' | 'USD';\n  transactionRef?: string;\n  callbackUrl?: string;\n  paymentChannels?: ('card' | 'bank' | 'ussd' | 'transfer')[];\n  passCharge?: boolean;\n  customerName?: string;\n  metadata?: Record<string, any>;\n}\n\nexport interface InitializePaymentResponse {\n  transactionRef: string;\n  checkoutUrl: string;\n  transactionAmount: number;\n  merchantAmount: number;\n  currency: string;\n}\n\nexport interface TransactionVerificationResponse {\n  transactionRef: string;\n  transactionStatus: 'success' | 'pending' | 'failed' | 'abandoned';\n  transactionAmount: number;\n  email: string;\n  currency: string;\n  createdAt: string;\n  transactionType: string;\n  merchantName: string;\n  gatewayRef: string;\n}\n\nexport interface AccountLookupRequest {\n  bankCode: string;\n  accountNumber: string;\n}\n\nexport interface AccountLookupResponse {\n  accountName: string;\n  accountNumber: string;\n}\n\nexport interface TransferRequest {\n  transactionReference: string;\n  amount: number; // Amount in Naira (will be converted to kobo)\n  bankCode: string;\n  accountNumber: string;\n  accountName: string;\n  remark?: string;\n}\n\nexport interface TransferResponse {\n  transactionReference: string;\n  responseDescription: string;\n  status: 'success' | 'pending' | 'failed';\n  amount: number;\n  accountNumber: string;\n  accountName: string;\n  bankName?: string;\n}\n\nexport interface Bank {\n  name: string;\n  code: string;\n}\n\nexport interface WebhookPayload {\n  Event: string;\n  TransactionRef: string;\n  Body: {\n    amount: number;\n    transaction_ref: string;\n    gateway_ref: string;\n    transaction_status: 'success' | 'pending' | 'failed' | 'abandoned';\n    email: string;\n    merchant_amount: number;\n    currency: string;\n    transaction_type: string;\n    created_at: string;\n    meta?: Record<string, any>;\n  };\n}\n\n// Helper: Make authenticated API request to Squad\nasync function squadRequest<T>(\n  endpoint: string,\n  method: 'GET' | 'POST' = 'GET',\n  body?: any\n): Promise<T> {\n  const secretKey = SQUAD_CONFIG.getSecretKey();\n  const baseUrl = SQUAD_CONFIG.getBaseUrl();\n\n  if (!secretKey) {\n    throw new SquadApiError(\n      'Squad secret key not configured',\n      SquadErrorType.AUTHENTICATION_ERROR,\n      500,\n      null,\n      'Payment service is not properly configured. Please contact support.'\n    );\n  }\n\n  const requestId = crypto.randomBytes(4).toString('hex');\n  console.log(`[Squad API] [${requestId}] ${method} ${baseUrl}${endpoint}`);\n\n  try {\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), 30000);\n\n    const response = await fetch(`${baseUrl}${endpoint}`, {\n      method,\n      headers: {\n        'Authorization': `Bearer ${secretKey}`,\n        'Content-Type': 'application/json',\n      },\n      body: body ? JSON.stringify(body) : undefined,\n      signal: controller.signal,\n    });\n\n    clearTimeout(timeoutId);\n\n    let data: any;\n    try {\n      data = await response.json();\n    } catch {\n      throw new SquadApiError(\n        'Invalid response from Squad API',\n        SquadErrorType.SERVER_ERROR,\n        response.status\n      );\n    }\n\n    console.log(`[Squad API] [${requestId}] Status: ${response.status}, Success: ${data.success}`);\n\n    if (!response.ok || !data.success) {\n      const errorType = categorizeError(response.status, data);\n      throw new SquadApiError(\n        data.message || `HTTP ${response.status}`,\n        errorType,\n        response.status,\n        data\n      );\n    }\n\n    return data.data as T;\n  } catch (error: any) {\n    if (error instanceof SquadApiError) throw error;\n\n    if (error.name === 'AbortError') {\n      throw new SquadApiError(\n        'Request timed out',\n        SquadErrorType.TIMEOUT,\n        0\n      );\n    }\n\n    throw new SquadApiError(\n      `Network error: ${error.message}`,\n      SquadErrorType.NETWORK_ERROR,\n      0,\n      error\n    );\n  }\n}\n\n// Categorize API errors\nfunction categorizeError(status: number, data: any): SquadErrorType {\n  // Check for specific error messages from Squad\n  const message = data?.message?.toLowerCase() || '';\n  \n  // Authentication errors\n  if (status === 401) return SquadErrorType.INVALID_CREDENTIALS;\n  if (status === 403) return SquadErrorType.AUTHENTICATION_ERROR;\n  \n  // Invalid request errors (malformed requests, missing fields)\n  if (status === 400) {\n    if (message.includes('invalid') || message.includes('missing') || message.includes('required')) {\n      return SquadErrorType.INVALID_REQUEST;\n    }\n    return SquadErrorType.VALIDATION_ERROR;\n  }\n  \n  // Other specific errors\n  if (status === 402) return SquadErrorType.INSUFFICIENT_FUNDS;\n  if (status === 422) return SquadErrorType.VALIDATION_ERROR;\n  if (status === 429) return SquadErrorType.RATE_LIMITED;\n  if (status >= 500) return SquadErrorType.SERVER_ERROR;\n  \n  return SquadErrorType.UNKNOWN;\n}\n\n// Generate unique payment reference\nexport function generatePaymentReference(prefix: string = 'EKSU'): string {\n  const timestamp = Date.now().toString(36).toUpperCase();\n  const random = crypto.randomBytes(4).toString('hex').toUpperCase();\n  return `${prefix}_${timestamp}_${random}`;\n}\n\n// Generate transfer reference\nexport function generateTransferReference(): string {\n  return generatePaymentReference('PAYOUT');\n}\n\n/**\n * Initialize a payment transaction\n * Redirects user to Squad checkout page\n */\nexport async function initializePayment(\n  request: InitializePaymentRequest\n): Promise<InitializePaymentResponse> {\n  // Convert amount from Naira to Kobo (multiply by 100)\n  const amountInKobo = Math.round(request.amount * 100);\n\n  const payload = {\n    amount: amountInKobo,\n    email: request.email,\n    currency: request.currency || 'NGN',\n    initiate_type: 'inline',\n    transaction_ref: request.transactionRef || generatePaymentReference(),\n    callback_url: request.callbackUrl,\n    payment_channels: request.paymentChannels || ['card', 'bank', 'ussd', 'transfer'],\n    pass_charge: request.passCharge ?? false,\n    customer_name: request.customerName,\n    metadata: request.metadata,\n  };\n\n  const response = await squadRequest<{\n    transaction_ref: string;\n    checkout_url: string;\n    transaction_amount: number;\n    merchant_amount: number;\n    currency: string;\n  }>('/transaction/initiate', 'POST', payload);\n\n  return {\n    transactionRef: response.transaction_ref,\n    checkoutUrl: response.checkout_url,\n    transactionAmount: response.transaction_amount,\n    merchantAmount: response.merchant_amount,\n    currency: response.currency,\n  };\n}\n\n/**\n * Verify a transaction by its reference\n */\nexport async function verifyTransaction(\n  transactionRef: string\n): Promise<TransactionVerificationResponse> {\n  const response = await squadRequest<{\n    transaction_ref: string;\n    transaction_status: string;\n    transaction_amount: number;\n    email: string;\n    transaction_currency_id: string;\n    created_at: string;\n    transaction_type: string;\n    merchant_name: string;\n    gateway_transaction_ref: string;\n  }>(`/transaction/verify/${transactionRef}`, 'GET');\n\n  return {\n    transactionRef: response.transaction_ref,\n    transactionStatus: response.transaction_status.toLowerCase() as TransactionVerificationResponse['transactionStatus'],\n    transactionAmount: response.transaction_amount,\n    email: response.email,\n    currency: response.transaction_currency_id,\n    createdAt: response.created_at,\n    transactionType: response.transaction_type,\n    merchantName: response.merchant_name,\n    gatewayRef: response.gateway_transaction_ref,\n  };\n}\n\n/**\n * Look up bank account details (verify account before transfer)\n */\nexport async function lookupBankAccount(\n  request: AccountLookupRequest\n): Promise<AccountLookupResponse> {\n  const response = await squadRequest<{\n    account_name: string;\n    account_number: string;\n  }>('/payout/account/lookup', 'POST', {\n    bank_code: request.bankCode,\n    account_number: request.accountNumber,\n  });\n\n  return {\n    accountName: response.account_name,\n    accountNumber: response.account_number,\n  };\n}\n\n/**\n * Verify bank account (alias for lookupBankAccount)\n * Used to verify account details before making a transfer\n */\nexport async function verifyBankAccount(\n  accountNumber: string,\n  bankCode: string\n): Promise<AccountLookupResponse> {\n  return lookupBankAccount({ accountNumber, bankCode });\n}\n\n/**\n * Initiate a transfer/payout to a bank account\n */\nexport async function initiateTransfer(\n  request: TransferRequest\n): Promise<TransferResponse> {\n  // Convert amount from Naira to Kobo\n  const amountInKobo = Math.round(request.amount * 100);\n\n  const response = await squadRequest<{\n    transaction_reference: string;\n    response_description: string;\n    status?: string;\n    amount: number;\n    account_number: string;\n    account_name: string;\n    destination_institution_name?: string;\n  }>('/payout/transfer', 'POST', {\n    transaction_reference: request.transactionReference,\n    amount: amountInKobo.toString(),\n    bank_code: request.bankCode,\n    account_number: request.accountNumber,\n    account_name: request.accountName,\n    currency_id: 'NGN',\n    remark: request.remark || 'EKSU Marketplace Payout',\n  });\n\n  return {\n    transactionReference: response.transaction_reference,\n    responseDescription: response.response_description,\n    status: (response.status?.toLowerCase() || 'pending') as TransferResponse['status'],\n    amount: response.amount,\n    accountNumber: response.account_number,\n    accountName: response.account_name,\n    bankName: response.destination_institution_name,\n  };\n}\n\n/**\n * Requery transfer status\n */\nexport async function requeryTransfer(transactionReference: string): Promise<TransferResponse> {\n  const response = await squadRequest<{\n    transaction_reference: string;\n    response_description: string;\n    amount: string;\n    account_number: string;\n    account_name: string;\n    destination_institution_name?: string;\n  }>('/payout/requery', 'POST', {\n    transaction_reference: transactionReference,\n  });\n\n  return {\n    transactionReference: response.transaction_reference,\n    responseDescription: response.response_description,\n    status: response.response_description.toLowerCase().includes('success') ? 'success' : 'pending',\n    amount: parseFloat(response.amount),\n    accountNumber: response.account_number,\n    accountName: response.account_name,\n    bankName: response.destination_institution_name,\n  };\n}\n\n/**\n * Get list of Nigerian banks\n */\nexport async function getBankList(): Promise<Bank[]> {\n  try {\n    const secretKey = SQUAD_CONFIG.getSecretKey();\n    const baseUrl = SQUAD_CONFIG.getBaseUrl();\n\n    const response = await fetch(`${baseUrl}/payout/banks/all`, {\n      headers: {\n        'Authorization': `Bearer ${secretKey}`,\n        'Content-Type': 'application/json',\n      },\n    });\n\n    const data = await response.json();\n\n    if (data.success && Array.isArray(data.data)) {\n      return data.data.map((bank: any) => ({\n        name: bank.name,\n        code: bank.code || bank.bankCode,\n      }));\n    }\n\n    return getDefaultBanks();\n  } catch (error) {\n    console.error('[Squad] Error fetching banks:', error);\n    return getDefaultBanks();\n  }\n}\n\n// Default Nigerian banks fallback\nfunction getDefaultBanks(): Bank[] {\n  return [\n    { name: 'Access Bank', code: '000014' },\n    { name: 'Citibank Nigeria', code: '000009' },\n    { name: 'Ecobank Nigeria', code: '000010' },\n    { name: 'Fidelity Bank', code: '000007' },\n    { name: 'First Bank of Nigeria', code: '000016' },\n    { name: 'First City Monument Bank', code: '000003' },\n    { name: 'Globus Bank', code: '000027' },\n    { name: 'Guaranty Trust Bank', code: '000013' },\n    { name: 'Heritage Bank', code: '000020' },\n    { name: 'Keystone Bank', code: '000002' },\n    { name: 'Kuda Bank', code: '090267' },\n    { name: 'Moniepoint MFB', code: '090405' },\n    { name: 'OPay', code: '100004' },\n    { name: 'Palmpay', code: '100033' },\n    { name: 'Polaris Bank', code: '000008' },\n    { name: 'Providus Bank', code: '000023' },\n    { name: 'Stanbic IBTC Bank', code: '000012' },\n    { name: 'Standard Chartered Bank', code: '000021' },\n    { name: 'Sterling Bank', code: '000001' },\n    { name: 'Union Bank of Nigeria', code: '000018' },\n    { name: 'United Bank for Africa', code: '000004' },\n    { name: 'Unity Bank', code: '000011' },\n    { name: 'Wema Bank', code: '000017' },\n    { name: 'Zenith Bank', code: '000015' },\n  ];\n}\n\n/**\n * Verify Squad webhook signature\n */\nexport function verifyWebhookSignature(\n  payload: string | Buffer,\n  signature: string\n): boolean {\n  const secretKey = SQUAD_CONFIG.getSecretKey();\n  if (!secretKey) return false;\n\n  const computedHash = crypto\n    .createHmac('sha512', secretKey)\n    .update(payload)\n    .digest('hex');\n\n  return computedHash.toLowerCase() === signature.toLowerCase();\n}\n\n/**\n * Check if Squad is properly configured\n */\nexport function isSquadConfigured(): boolean {\n  return !!(SQUAD_CONFIG.getSecretKey() && SQUAD_CONFIG.getPublicKey());\n}\n\n/**\n * Get Squad configuration status (for debugging)\n */\nexport function getSquadConfigStatus(): {\n  configured: boolean;\n  mode: 'sandbox' | 'live' | 'unknown';\n  baseUrl: string;\n  hasSecretKey: boolean;\n  hasPublicKey: boolean;\n} {\n  const secretKey = SQUAD_CONFIG.getSecretKey();\n  const publicKey = SQUAD_CONFIG.getPublicKey();\n\n  let mode: 'sandbox' | 'live' | 'unknown' = 'unknown';\n  if (secretKey.startsWith('sandbox_sk_') || secretKey.startsWith('sk_test_')) {\n    mode = 'sandbox';\n  } else if (secretKey) {\n    mode = 'live';\n  }\n\n  return {\n    configured: isSquadConfigured(),\n    mode,\n    baseUrl: SQUAD_CONFIG.getBaseUrl(),\n    hasSecretKey: !!secretKey,\n    hasPublicKey: !!publicKey,\n  };\n}\n\n/**\n * Calculate Squad payment fee estimate\n * Squad charges approximately 1% capped at ₦2,000\n */\nexport function calculateSquadFee(amount: number): number {\n  const feePercentage = 0.01; // 1%\n  const maxFee = 2000; // ₦2,000 cap\n  const calculatedFee = amount * feePercentage;\n  return Math.min(calculatedFee, maxFee);\n}\n\n// Export Squad instance for convenient access\nexport const squad = {\n  initializePayment,\n  verifyTransaction,\n  lookupBankAccount,\n  verifyBankAccount,\n  initiateTransfer,\n  requeryTransfer,\n  getBankList,\n  verifyWebhookSignature,\n  isConfigured: isSquadConfigured,\n  getConfigStatus: getSquadConfigStatus,\n  generatePaymentReference,\n  generateTransferReference,\n  calculateFee: calculateSquadFee,\n};\n\nexport default squad;\n","path":null,"size_bytes":17612,"size_tokens":null},"client/src/components/UserActionsMenu.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { MoreVertical, VolumeX, Volume2, Ban, UserCheck, Flag, Loader2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\ninterface UserRelationship {\n  isBlocked: boolean;\n  isMuted: boolean;\n  isBlockedByTarget: boolean;\n}\n\ninterface UserActionsMenuProps {\n  targetUserId: string;\n  targetUserName: string;\n  onAction?: (action: \"block\" | \"unblock\" | \"mute\" | \"unmute\" | \"report\") => void;\n}\n\nexport function UserActionsMenu({ targetUserId, targetUserName, onAction }: UserActionsMenuProps) {\n  const { toast } = useToast();\n  const [reportDialogOpen, setReportDialogOpen] = useState(false);\n  const [reportReason, setReportReason] = useState<string>(\"\");\n  const [reportDescription, setReportDescription] = useState(\"\");\n\n  const { data: relationship, isLoading: isLoadingRelationship } = useQuery<UserRelationship>({\n    queryKey: [\"/api/users\", targetUserId, \"relationship\"],\n    enabled: !!targetUserId,\n  });\n\n  const blockMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"POST\", `/api/users/${targetUserId}/block`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", targetUserId, \"relationship\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users/blocked\"] });\n      toast({\n        title: \"User blocked\",\n        description: `You have blocked ${targetUserName}. They can no longer contact you.`,\n      });\n      onAction?.(\"block\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to block user\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const unblockMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"DELETE\", `/api/users/${targetUserId}/block`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", targetUserId, \"relationship\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users/blocked\"] });\n      toast({\n        title: \"User unblocked\",\n        description: `You have unblocked ${targetUserName}.`,\n      });\n      onAction?.(\"unblock\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to unblock user\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const muteMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"POST\", `/api/users/${targetUserId}/mute`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", targetUserId, \"relationship\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users/muted\"] });\n      toast({\n        title: \"User muted\",\n        description: `You have muted ${targetUserName}. Their content will be hidden.`,\n      });\n      onAction?.(\"mute\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to mute user\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const unmuteMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"DELETE\", `/api/users/${targetUserId}/mute`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\", targetUserId, \"relationship\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users/muted\"] });\n      toast({\n        title: \"User unmuted\",\n        description: `You have unmuted ${targetUserName}.`,\n      });\n      onAction?.(\"unmute\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to unmute user\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const reportMutation = useMutation({\n    mutationFn: async (data: { reason: string; description?: string }) => {\n      await apiRequest(\"POST\", `/api/users/${targetUserId}/report`, data);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Report submitted\",\n        description: \"Thank you for your report. Our team will review it shortly.\",\n      });\n      setReportDialogOpen(false);\n      setReportReason(\"\");\n      setReportDescription(\"\");\n      onAction?.(\"report\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to submit report\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleReport = () => {\n    if (!reportReason) {\n      toast({\n        title: \"Please select a reason\",\n        description: \"You must select a reason for your report.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    reportMutation.mutate({\n      reason: reportReason,\n      description: reportDescription || undefined,\n    });\n  };\n\n  const isBlocked = relationship?.isBlocked ?? false;\n  const isMuted = relationship?.isMuted ?? false;\n  const isBlockedByTarget = relationship?.isBlockedByTarget ?? false;\n  const isPending = blockMutation.isPending || unblockMutation.isPending || \n                   muteMutation.isPending || unmuteMutation.isPending;\n\n  return (\n    <>\n      <DropdownMenu>\n        <DropdownMenuTrigger asChild>\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            disabled={isLoadingRelationship || isPending}\n            data-testid=\"button-user-actions\"\n          >\n            {isPending ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : (\n              <MoreVertical className=\"h-4 w-4\" />\n            )}\n          </Button>\n        </DropdownMenuTrigger>\n        <DropdownMenuContent align=\"end\">\n          {isMuted ? (\n            <DropdownMenuItem\n              onClick={() => unmuteMutation.mutate()}\n              data-testid=\"menu-item-unmute\"\n            >\n              <Volume2 className=\"mr-2 h-4 w-4\" />\n              Unmute {targetUserName}\n            </DropdownMenuItem>\n          ) : (\n            <DropdownMenuItem\n              onClick={() => muteMutation.mutate()}\n              data-testid=\"menu-item-mute\"\n            >\n              <VolumeX className=\"mr-2 h-4 w-4\" />\n              Mute {targetUserName}\n            </DropdownMenuItem>\n          )}\n\n          <DropdownMenuSeparator />\n\n          {isBlocked ? (\n            <DropdownMenuItem\n              onClick={() => unblockMutation.mutate()}\n              data-testid=\"menu-item-unblock\"\n            >\n              <UserCheck className=\"mr-2 h-4 w-4\" />\n              Unblock {targetUserName}\n            </DropdownMenuItem>\n          ) : (\n            <DropdownMenuItem\n              onClick={() => blockMutation.mutate()}\n              className=\"text-destructive focus:text-destructive\"\n              data-testid=\"menu-item-block\"\n            >\n              <Ban className=\"mr-2 h-4 w-4\" />\n              Block {targetUserName}\n            </DropdownMenuItem>\n          )}\n\n          <DropdownMenuSeparator />\n\n          <DropdownMenuItem\n            onClick={() => setReportDialogOpen(true)}\n            className=\"text-destructive focus:text-destructive\"\n            data-testid=\"menu-item-report\"\n          >\n            <Flag className=\"mr-2 h-4 w-4\" />\n            Report {targetUserName}\n          </DropdownMenuItem>\n\n          {isBlockedByTarget && (\n            <>\n              <DropdownMenuSeparator />\n              <div className=\"px-2 py-1.5 text-xs text-muted-foreground\">\n                This user has blocked you\n              </div>\n            </>\n          )}\n        </DropdownMenuContent>\n      </DropdownMenu>\n\n      <Dialog open={reportDialogOpen} onOpenChange={setReportDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Report {targetUserName}</DialogTitle>\n            <DialogDescription>\n              Help us understand the issue. Your report will be reviewed by our team.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"reason\">Reason for report</Label>\n              <Select value={reportReason} onValueChange={setReportReason}>\n                <SelectTrigger id=\"reason\" data-testid=\"select-report-reason\">\n                  <SelectValue placeholder=\"Select a reason\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"spam\">Spam</SelectItem>\n                  <SelectItem value=\"harassment\">Harassment</SelectItem>\n                  <SelectItem value=\"scam\">Scam or fraud</SelectItem>\n                  <SelectItem value=\"inappropriate\">Inappropriate content</SelectItem>\n                  <SelectItem value=\"other\">Other</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"description\">Additional details (optional)</Label>\n              <Textarea\n                id=\"description\"\n                placeholder=\"Provide more context about the issue...\"\n                value={reportDescription}\n                onChange={(e) => setReportDescription(e.target.value)}\n                rows={4}\n                data-testid=\"input-report-description\"\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setReportDialogOpen(false)}\n              data-testid=\"button-cancel-report\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleReport}\n              disabled={reportMutation.isPending || !reportReason}\n              data-testid=\"button-submit-report\"\n            >\n              {reportMutation.isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Submitting...\n                </>\n              ) : (\n                \"Submit Report\"\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n","path":null,"size_bytes":10700,"size_tokens":null},"server/smedata.ts":{"content":"// SMEDATA.NG API Integration for VTU Data Sales\n// API Documentation: https://smedata.ng/api-documentation\n// Correct endpoint: https://smedata.ng/wp-json/api/v1/\n\nconst SMEDATA_BASE_URL = \"https://smedata.ng/wp-json/api/v1\";\nconst SME_API_KEY = process.env.SME_API || \"\";\n\ninterface SMEDataResponse {\n  success: boolean;\n  message: string;\n  data?: any;\n  reference?: string;\n  error?: string;\n}\n\ninterface DataPurchaseRequest {\n  network: string;\n  phone: string;\n  plan_code: string;\n  bypass?: boolean;\n}\n\ninterface NINVerificationRequest {\n  nin: string;\n  firstname: string;\n  lastname: string;\n  dob: string; // YYYY-MM-DD format\n}\n\ninterface NINVerificationResponse {\n  success: boolean;\n  message: string;\n  data?: {\n    nin: string;\n    firstname: string;\n    middlename?: string;\n    surname: string;\n    birthdate: string;\n    gender: string;\n    phone?: string;\n    photo?: string; // Base64 encoded photo\n    vnin?: string;\n  };\n  error?: string;\n}\n\n// SME Data API Plan structure\nexport interface SMEDataPlan {\n  network: string;\n  size: string;\n  validity: string;\n  price: number;\n  planCode?: string;\n}\n\n// Parsed VTU Plan for database storage\nexport interface ParsedVtuPlan {\n  network: \"mtn_sme\" | \"glo_cg\" | \"airtel_cg\" | \"9mobile\";\n  planName: string;\n  dataAmount: string;\n  validity: string;\n  costPrice: string;\n  sellingPrice: string;\n  planCode: string;\n  isActive: boolean;\n  sortOrder: number;\n}\n\n// Network mapping for SMEDATA API\nconst NETWORK_MAP: Record<string, string> = {\n  mtn_sme: \"MTN\",\n  glo_cg: \"GLO\",\n  airtel_cg: \"AIRTEL\",\n  \"9mobile\": \"9MOBILE\",\n};\n\n// Reverse network mapping (API response to our enum)\nconst NETWORK_REVERSE_MAP: Record<string, \"mtn_sme\" | \"glo_cg\" | \"airtel_cg\" | \"9mobile\"> = {\n  MTN: \"mtn_sme\",\n  GLO: \"glo_cg\",\n  AIRTEL: \"airtel_cg\",\n  \"9MOBILE\": \"9mobile\",\n  ETISALAT: \"9mobile\",\n};\n\n// Check if SMEDATA API is configured\nexport function isSMEDataConfigured(): boolean {\n  return !!SME_API_KEY && SME_API_KEY !== \"\";\n}\n\n// Get wallet balance from SMEDATA\nexport async function getSMEDataBalance(): Promise<{ balance: number; success: boolean }> {\n  if (!isSMEDataConfigured()) {\n    return { balance: 0, success: false };\n  }\n\n  try {\n    // SME Data API uses token parameter instead of Bearer header\n    const response = await fetch(`${SMEDATA_BASE_URL}/user?token=${encodeURIComponent(SME_API_KEY)}`, {\n      method: \"GET\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n    });\n\n    const data = await response.json();\n    \n    if (data.success || data.status === \"success\") {\n      return { balance: parseFloat(data.data?.balance || data.balance || \"0\"), success: true };\n    }\n    \n    return { balance: 0, success: false };\n  } catch (error) {\n    console.error(\"SMEDATA balance check error:\", error);\n    return { balance: 0, success: false };\n  }\n}\n\n// Purchase data from SMEDATA using GET method with token parameter\n// API docs: https://smedata.ng/mtn-sme-data-api-documentation-for-developers/\nexport async function purchaseData(\n  network: string,\n  phoneNumber: string,\n  dataSize: string // Data size like \"1GB\", \"500MB\", \"2GB\" etc.\n): Promise<SMEDataResponse> {\n  if (!isSMEDataConfigured()) {\n    return {\n      success: false,\n      message: \"VTU service is not configured. Please contact support.\",\n      error: \"API_NOT_CONFIGURED\",\n    };\n  }\n\n  // Normalize phone number (remove country code, add 0 prefix if needed)\n  const normalizedPhone = normalizePhoneNumber(phoneNumber);\n  \n  // Map our network to SMEDATA network (uppercase for API)\n  const smedataNetwork = network === \"mtn_sme\" ? \"MTN\" : \n                         network === \"glo_cg\" ? \"GLO\" :\n                         network === \"airtel_cg\" ? \"AIRTEL\" :\n                         network === \"9mobile\" ? \"9MOBILE\" :\n                         network.toUpperCase();\n\n  try {\n    // SME Data API uses GET method with size parameter\n    const params = new URLSearchParams({\n      token: SME_API_KEY,\n      network: smedataNetwork,\n      phone: normalizedPhone,\n      size: dataSize.toUpperCase(), // e.g., \"1GB\", \"500MB\"\n    });\n\n    console.log(\"SME Data API Request:\", `${SMEDATA_BASE_URL}/data?${params.toString().replace(SME_API_KEY, \"***\")}`);\n\n    const response = await fetch(`${SMEDATA_BASE_URL}/data?${params.toString()}`, {\n      method: \"GET\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n    });\n\n    const data = await response.json();\n    console.log(\"SME Data API Response:\", JSON.stringify(data));\n    \n    const isSuccess = data.code === \"success\" || data.success || data.status === \"success\";\n    \n    return {\n      success: isSuccess,\n      message: data.message || (isSuccess ? \"Data purchase successful\" : \"Data purchase failed\"),\n      reference: data.data?.order_id?.toString() || data.reference || data.transid,\n      data: data.data || data,\n      error: isSuccess ? undefined : (data.message || data.error),\n    };\n  } catch (error: any) {\n    console.error(\"SMEDATA purchase error:\", error);\n    return {\n      success: false,\n      message: \"Failed to process data purchase. Please try again.\",\n      error: error.message || \"NETWORK_ERROR\",\n    };\n  }\n}\n\n// Verify NIN and get photo for KYC\nexport async function verifyNIN(\n  nin: string,\n  firstName: string,\n  lastName: string,\n  dateOfBirth: string\n): Promise<NINVerificationResponse> {\n  if (!isSMEDataConfigured()) {\n    return {\n      success: false,\n      message: \"KYC service is not configured. Please contact support.\",\n      error: \"API_NOT_CONFIGURED\",\n    };\n  }\n\n  try {\n    const response = await fetch(`${SMEDATA_BASE_URL}/kyc/nin`, {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${SME_API_KEY}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        nin: nin,\n        firstname: firstName,\n        lastname: lastName,\n        dob: dateOfBirth,\n      } as NINVerificationRequest),\n    });\n\n    const data = await response.json();\n    \n    if (data.success || data.status === \"success\") {\n      return {\n        success: true,\n        message: \"NIN verification successful\",\n        data: data.data,\n      };\n    }\n\n    return {\n      success: false,\n      message: data.message || \"NIN verification failed\",\n      error: data.error || \"VERIFICATION_FAILED\",\n    };\n  } catch (error: any) {\n    console.error(\"SMEDATA NIN verification error:\", error);\n    return {\n      success: false,\n      message: \"Failed to verify NIN. Please try again.\",\n      error: error.message || \"NETWORK_ERROR\",\n    };\n  }\n}\n\n// NOTE: SMEDATA.NG API does NOT have a /plans endpoint to fetch available plans\n// Plans must be predefined in the database and managed by admin\n// The API only supports direct purchases via /data endpoint with size parameter\n// Reference: https://smedata.ng/mtn-sme-data-api-documentation-for-developers/\n\n// Check order status via requery endpoint\nexport async function requeryOrder(orderId: string): Promise<SMEDataResponse> {\n  if (!isSMEDataConfigured()) {\n    return {\n      success: false,\n      message: \"VTU service is not configured\",\n      error: \"API_NOT_CONFIGURED\",\n    };\n  }\n\n  try {\n    const params = new URLSearchParams({\n      token: SME_API_KEY,\n      orderid: orderId,\n    });\n\n    const response = await fetch(`${SMEDATA_BASE_URL}/requery?${params.toString()}`, {\n      method: \"GET\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n    });\n\n    const data = await response.json();\n    console.log(\"[SME Data] Requery response:\", JSON.stringify(data));\n\n    return {\n      success: data.code === \"success\",\n      message: data.message || \"Order status retrieved\",\n      data: data.data,\n      reference: data.data?.order_id?.toString(),\n    };\n  } catch (error: any) {\n    console.error(\"[SME Data] Requery error:\", error);\n    return {\n      success: false,\n      message: \"Failed to check order status\",\n      error: error.message || \"NETWORK_ERROR\",\n    };\n  }\n}\n\n// Helper function to normalize Nigerian phone numbers\nfunction normalizePhoneNumber(phone: string): string {\n  // Remove all non-digit characters\n  let cleaned = phone.replace(/\\D/g, \"\");\n  \n  // Handle different formats\n  if (cleaned.startsWith(\"234\")) {\n    // Remove country code and add 0\n    cleaned = \"0\" + cleaned.substring(3);\n  } else if (cleaned.startsWith(\"+234\")) {\n    cleaned = \"0\" + cleaned.substring(4);\n  } else if (!cleaned.startsWith(\"0\") && cleaned.length === 10) {\n    // Add leading 0 if missing\n    cleaned = \"0\" + cleaned;\n  }\n  \n  return cleaned;\n}\n\n// Complete Nigerian mobile phone prefixes (updated 2024)\nconst MTN_PREFIXES = [\n  \"0803\", \"0806\", \"0703\", \"0704\", \"0706\", \"0810\", \"0813\", \"0814\", \"0816\",\n  \"0903\", \"0906\", \"0913\", \"0916\", \"0702\"\n];\nconst GLO_PREFIXES = [\"0805\", \"0807\", \"0705\", \"0815\", \"0811\", \"0905\", \"0915\"];\nconst AIRTEL_PREFIXES = [\"0802\", \"0808\", \"0708\", \"0812\", \"0701\", \"0902\", \"0901\", \"0907\", \"0912\"];\nconst NINE_MOBILE_PREFIXES = [\"0809\", \"0818\", \"0817\", \"0909\", \"0908\"];\n\nconst ALL_VALID_PREFIXES = [\n  ...MTN_PREFIXES,\n  ...GLO_PREFIXES,\n  ...AIRTEL_PREFIXES,\n  ...NINE_MOBILE_PREFIXES,\n];\n\n// Validate Nigerian phone number\nexport function isValidNigerianPhone(phone: string): boolean {\n  const normalized = normalizePhoneNumber(phone);\n  // Nigerian numbers are 11 digits starting with 0\n  if (normalized.length !== 11 || !normalized.startsWith(\"0\")) {\n    return false;\n  }\n  \n  const prefix = normalized.substring(0, 4);\n  return ALL_VALID_PREFIXES.includes(prefix);\n}\n\n// Detect network from phone number\nexport function detectNetwork(phone: string): string | null {\n  const normalized = normalizePhoneNumber(phone);\n  const prefix = normalized.substring(0, 4);\n  \n  if (MTN_PREFIXES.includes(prefix)) return \"mtn_sme\";\n  if (GLO_PREFIXES.includes(prefix)) return \"glo_cg\";\n  if (AIRTEL_PREFIXES.includes(prefix)) return \"airtel_cg\";\n  if (NINE_MOBILE_PREFIXES.includes(prefix)) return \"9mobile\";\n  \n  return null;\n}\n\n// Purchase airtime from SMEDATA\nexport async function purchaseAirtime(\n  network: string,\n  phoneNumber: string,\n  amount: number\n): Promise<SMEDataResponse> {\n  if (!isSMEDataConfigured()) {\n    return {\n      success: false,\n      message: \"VTU service is not configured. Please contact support.\",\n      error: \"API_NOT_CONFIGURED\",\n    };\n  }\n\n  const normalizedPhone = normalizePhoneNumber(phoneNumber);\n  const smedataNetwork = NETWORK_MAP[network] || network.toUpperCase();\n\n  try {\n    const response = await fetch(`${SMEDATA_BASE_URL}/airtime`, {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${SME_API_KEY}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        network: smedataNetwork,\n        phone: normalizedPhone,\n        amount: amount,\n      }),\n    });\n\n    const data = await response.json();\n    \n    return {\n      success: data.success || data.status === \"success\",\n      message: data.message || \"Airtime purchase processed\",\n      reference: data.reference || data.data?.reference,\n      data: data.data,\n      error: data.error,\n    };\n  } catch (error: any) {\n    console.error(\"SMEDATA airtime purchase error:\", error);\n    return {\n      success: false,\n      message: \"Failed to process airtime purchase. Please try again.\",\n      error: error.message || \"NETWORK_ERROR\",\n    };\n  }\n}\n\n// ===========================================\n// BILL PAYMENTS (Cable TV & Electricity)\n// ===========================================\n\n// Service type mapping for SMEDATA API\nconst BILL_SERVICE_MAP: Record<string, { apiName: string; type: string }> = {\n  // Cable TV\n  dstv: { apiName: \"dstv\", type: \"cable\" },\n  gotv: { apiName: \"gotv\", type: \"cable\" },\n  startimes: { apiName: \"startimes\", type: \"cable\" },\n  showmax: { apiName: \"showmax\", type: \"cable\" },\n  // Electricity\n  ekedc: { apiName: \"ekedc\", type: \"electricity\" },\n  ikedc: { apiName: \"ikedc\", type: \"electricity\" },\n  aedc: { apiName: \"aedc\", type: \"electricity\" },\n  ibedc: { apiName: \"ibedc\", type: \"electricity\" },\n  phedc: { apiName: \"phedc\", type: \"electricity\" },\n  eedc: { apiName: \"eedc\", type: \"electricity\" },\n};\n\ninterface CustomerValidationResponse {\n  success: boolean;\n  message: string;\n  data?: {\n    customerName: string;\n    customerId: string;\n    accountStatus?: string;\n    dueDate?: string;\n    currentBalance?: number;\n    meterType?: string; // prepaid or postpaid for electricity\n  };\n  error?: string;\n}\n\ninterface BillPackage {\n  code: string;\n  name: string;\n  amount: number;\n  validity?: string;\n}\n\ninterface BillPackagesResponse {\n  success: boolean;\n  message: string;\n  packages?: BillPackage[];\n  error?: string;\n}\n\ninterface BillPaymentResponse {\n  success: boolean;\n  message: string;\n  reference?: string;\n  token?: string; // For electricity prepaid\n  data?: any;\n  error?: string;\n}\n\n// Validate decoder/meter number\nexport async function validateBillCustomer(\n  serviceType: string,\n  customerId: string\n): Promise<CustomerValidationResponse> {\n  if (!isSMEDataConfigured()) {\n    return {\n      success: false,\n      message: \"Bill payment service is not configured. Please contact support.\",\n      error: \"API_NOT_CONFIGURED\",\n    };\n  }\n\n  const serviceInfo = BILL_SERVICE_MAP[serviceType];\n  if (!serviceInfo) {\n    return {\n      success: false,\n      message: \"Invalid service type\",\n      error: \"INVALID_SERVICE\",\n    };\n  }\n\n  try {\n    const response = await fetch(`${SMEDATA_BASE_URL}/bills/validate`, {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${SME_API_KEY}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        service: serviceInfo.apiName,\n        customer_id: customerId,\n      }),\n    });\n\n    const data = await response.json();\n    \n    if (data.success || data.status === \"success\") {\n      return {\n        success: true,\n        message: \"Customer validated successfully\",\n        data: {\n          customerName: data.data?.customer_name || data.data?.name || \"Customer\",\n          customerId: customerId,\n          accountStatus: data.data?.status,\n          dueDate: data.data?.due_date,\n          currentBalance: data.data?.balance ? parseFloat(data.data.balance) : undefined,\n          meterType: data.data?.meter_type,\n        },\n      };\n    }\n\n    return {\n      success: false,\n      message: data.message || \"Customer validation failed\",\n      error: data.error || \"VALIDATION_FAILED\",\n    };\n  } catch (error: any) {\n    console.error(\"SMEDATA bill validation error:\", error);\n    return {\n      success: false,\n      message: \"Failed to validate customer. Please try again.\",\n      error: error.message || \"NETWORK_ERROR\",\n    };\n  }\n}\n\n// Get available packages for cable TV services\nexport async function getCablePackages(serviceType: string): Promise<BillPackagesResponse> {\n  if (!isSMEDataConfigured()) {\n    return {\n      success: false,\n      message: \"Bill payment service is not configured.\",\n      error: \"API_NOT_CONFIGURED\",\n    };\n  }\n\n  const serviceInfo = BILL_SERVICE_MAP[serviceType];\n  if (!serviceInfo || serviceInfo.type !== \"cable\") {\n    return {\n      success: false,\n      message: \"Invalid cable service type\",\n      error: \"INVALID_SERVICE\",\n    };\n  }\n\n  try {\n    const response = await fetch(`${SMEDATA_BASE_URL}/bills/packages/${serviceInfo.apiName}`, {\n      method: \"GET\",\n      headers: {\n        Authorization: `Bearer ${SME_API_KEY}`,\n        \"Content-Type\": \"application/json\",\n      },\n    });\n\n    const data = await response.json();\n    \n    if (data.success || data.status === \"success\" || data.data) {\n      const packages: BillPackage[] = (data.data || data.packages || []).map((pkg: any) => ({\n        code: pkg.code || pkg.plan_code || pkg.id,\n        name: pkg.name || pkg.plan_name || pkg.description,\n        amount: parseFloat(pkg.amount || pkg.price || \"0\"),\n        validity: pkg.validity || pkg.duration,\n      }));\n\n      return {\n        success: true,\n        message: \"Packages retrieved successfully\",\n        packages,\n      };\n    }\n\n    return {\n      success: false,\n      message: data.message || \"Failed to get packages\",\n      error: data.error || \"FETCH_FAILED\",\n    };\n  } catch (error: any) {\n    console.error(\"SMEDATA get packages error:\", error);\n    return {\n      success: false,\n      message: \"Failed to get packages. Please try again.\",\n      error: error.message || \"NETWORK_ERROR\",\n    };\n  }\n}\n\n// Process bill payment\nexport async function payBill(\n  serviceType: string,\n  customerId: string,\n  amount: number,\n  packageCode?: string\n): Promise<BillPaymentResponse> {\n  if (!isSMEDataConfigured()) {\n    return {\n      success: false,\n      message: \"Bill payment service is not configured. Please contact support.\",\n      error: \"API_NOT_CONFIGURED\",\n    };\n  }\n\n  const serviceInfo = BILL_SERVICE_MAP[serviceType];\n  if (!serviceInfo) {\n    return {\n      success: false,\n      message: \"Invalid service type\",\n      error: \"INVALID_SERVICE\",\n    };\n  }\n\n  try {\n    const requestBody: any = {\n      service: serviceInfo.apiName,\n      customer_id: customerId,\n      amount: amount,\n    };\n\n    // Add package code for cable TV\n    if (serviceInfo.type === \"cable\" && packageCode) {\n      requestBody.package_code = packageCode;\n    }\n\n    const response = await fetch(`${SMEDATA_BASE_URL}/bills/pay`, {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${SME_API_KEY}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(requestBody),\n    });\n\n    const data = await response.json();\n    \n    if (data.success || data.status === \"success\") {\n      return {\n        success: true,\n        message: data.message || \"Bill payment successful\",\n        reference: data.reference || data.data?.reference,\n        token: data.data?.token, // For electricity prepaid\n        data: data.data,\n      };\n    }\n\n    return {\n      success: false,\n      message: data.message || \"Bill payment failed\",\n      error: data.error || \"PAYMENT_FAILED\",\n    };\n  } catch (error: any) {\n    console.error(\"SMEDATA bill payment error:\", error);\n    return {\n      success: false,\n      message: \"Failed to process bill payment. Please try again.\",\n      error: error.message || \"NETWORK_ERROR\",\n    };\n  }\n}\n\n// Get bill service display info\nexport function getBillServiceInfo(serviceType: string): { name: string; type: string } | null {\n  const serviceNames: Record<string, string> = {\n    dstv: \"DSTV\",\n    gotv: \"GOtv\",\n    startimes: \"StarTimes\",\n    showmax: \"Showmax\",\n    ekedc: \"Eko Electricity (EKEDC)\",\n    ikedc: \"Ikeja Electricity (IKEDC)\",\n    aedc: \"Abuja Electricity (AEDC)\",\n    ibedc: \"Ibadan Electricity (IBEDC)\",\n    phedc: \"Port Harcourt Electricity (PHEDC)\",\n    eedc: \"Enugu Electricity (EEDC)\",\n  };\n\n  const info = BILL_SERVICE_MAP[serviceType];\n  if (!info) return null;\n\n  return {\n    name: serviceNames[serviceType] || serviceType.toUpperCase(),\n    type: info.type,\n  };\n}\n\nexport { normalizePhoneNumber };\n","path":null,"size_bytes":18974,"size_tokens":null},"client/src/pages/settings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { format, formatDistanceToNow, differenceInDays } from \"date-fns\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport type { UserSettings } from \"@shared/schema\";\nimport { \n  Settings, \n  Bell, \n  User, \n  Trash2, \n  MapPin, \n  Eye, \n  Clock, \n  MessageSquare,\n  AlertTriangle,\n  Loader2,\n  Mail,\n  Phone,\n  Calendar,\n  ShoppingBag,\n  Megaphone,\n  Check,\n  X,\n  Shield,\n  BadgeCheck,\n  ExternalLink,\n  Ban,\n  VolumeX,\n  Users\n} from \"lucide-react\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Link } from \"wouter\";\n\nexport default function SettingsPage() {\n  const { user, isLoading: authLoading, isVerified } = useAuth();\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"general\");\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [usernameConfirmation, setUsernameConfirmation] = useState(\"\");\n  const [isGettingLocation, setIsGettingLocation] = useState(false);\n\n  const { data: settings, isLoading: settingsLoading } = useQuery<UserSettings>({\n    queryKey: [\"/api/settings\"],\n    enabled: !!user,\n  });\n\n  useEffect(() => {\n    if (!authLoading && !user) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"Please log in to access settings.\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [authLoading, user, toast]);\n\n  const updateSettingsMutation = useMutation({\n    mutationFn: async (data: Partial<UserSettings>) => {\n      const response = await apiRequest(\"PATCH\", \"/api/settings\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/settings\"] });\n      toast({\n        title: \"Settings Updated\",\n        description: \"Your settings have been saved.\",\n      });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"Please log in again.\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update settings. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const requestDeletionMutation = useMutation({\n    mutationFn: async (usernameConfirmation: string) => {\n      const response = await apiRequest(\"POST\", \"/api/settings/delete-account\", { usernameConfirmation });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/settings\"] });\n      setDeleteDialogOpen(false);\n      setUsernameConfirmation(\"\");\n      toast({\n        title: \"Deletion Requested\",\n        description: \"Your account will be deleted in 30 days. You can cancel anytime.\",\n        variant: \"destructive\",\n      });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"Please log in again.\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to request account deletion.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const cancelDeletionMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/settings/cancel-deletion\", {});\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/settings\"] });\n      toast({\n        title: \"Deletion Cancelled\",\n        description: \"Your account will not be deleted.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to cancel account deletion.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const { data: blockedUsers, isLoading: blockedUsersLoading } = useQuery<Array<{\n    id: string;\n    firstName: string;\n    lastName: string;\n    profileImageUrl?: string;\n    email?: string;\n  }>>({\n    queryKey: [\"/api/blocked-users\"],\n    enabled: !!user,\n  });\n\n  const { data: mutedUsers, isLoading: mutedUsersLoading } = useQuery<Array<{\n    id: string;\n    firstName: string;\n    lastName: string;\n    profileImageUrl?: string;\n    email?: string;\n  }>>({\n    queryKey: [\"/api/users/muted\"],\n    enabled: !!user,\n  });\n\n  const unblockMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      await apiRequest(\"DELETE\", `/api/users/${userId}/block`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/blocked-users\"] });\n      toast({\n        title: \"User Unblocked\",\n        description: \"You have unblocked this user.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to unblock user.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const unmuteMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      await apiRequest(\"DELETE\", `/api/users/${userId}/mute`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users/muted\"] });\n      toast({\n        title: \"User Unmuted\",\n        description: \"You have unmuted this user.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to unmute user.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSettingToggle = (key: keyof UserSettings, value: boolean) => {\n    updateSettingsMutation.mutate({ [key]: value } as Partial<UserSettings>);\n  };\n\n  const handleDeleteAccount = () => {\n    if (!usernameConfirmation.trim()) {\n      toast({\n        title: \"Confirmation Required\",\n        description: \"Please enter your username to confirm deletion.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    requestDeletionMutation.mutate(usernameConfirmation);\n  };\n\n  const handleGetLocation = () => {\n    setIsGettingLocation(true);\n\n    if (!navigator.geolocation) {\n      toast({\n        title: \"Location Not Supported\",\n        description: \"Your browser does not support geolocation.\",\n        variant: \"destructive\",\n      });\n      setIsGettingLocation(false);\n      return;\n    }\n\n    navigator.geolocation.getCurrentPosition(\n      (position) => {\n        const { latitude, longitude } = position.coords;\n        updateSettingsMutation.mutate(\n          { latitude: latitude.toString(), longitude: longitude.toString() },\n          {\n            onSuccess: () => {\n              toast({\n                title: \"Location Updated\",\n                description: \"Your location has been successfully updated.\",\n              });\n              setIsGettingLocation(false);\n            },\n            onError: () => {\n              setIsGettingLocation(false);\n            },\n          }\n        );\n      },\n      (error) => {\n        let errorMessage = \"Failed to get your location.\";\n        switch (error.code) {\n          case 1:\n            errorMessage = \"Location access was denied. Please allow location access in your browser settings.\";\n            break;\n          case 2:\n            errorMessage = \"Location information is unavailable. Please try again later.\";\n            break;\n          case 3:\n            errorMessage = \"Location request timed out. Please try again.\";\n            break;\n        }\n        toast({\n          title: \"Location Error\",\n          description: errorMessage,\n          variant: \"destructive\",\n        });\n        setIsGettingLocation(false);\n      },\n      {\n        enableHighAccuracy: true,\n        timeout: 10000,\n        maximumAge: 0,\n      }\n    );\n  };\n\n  const isLoading = authLoading || settingsLoading;\n\n  if (isLoading || !user) {\n    return (\n      <div className=\"container mx-auto px-4 py-6 max-w-2xl\">\n        <div className=\"mb-6\">\n          <Skeleton className=\"h-8 w-32 mb-2\" />\n          <Skeleton className=\"h-4 w-64\" />\n        </div>\n        <div className=\"space-y-4\">\n          <Skeleton className=\"h-12 w-full\" />\n          <Skeleton className=\"h-64 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  const username = user.email?.split(\"@\")[0] || \"user\";\n  const deletionRequested = !!settings?.deletionRequestedAt;\n  const deletionDate = settings?.deletionScheduledFor ? new Date(settings.deletionScheduledFor) : null;\n  const daysUntilDeletion = deletionDate ? differenceInDays(deletionDate, new Date()) : null;\n\n  return (\n    <div className=\"container mx-auto px-4 py-6 max-w-2xl pb-24\">\n      <div className=\"mb-6\">\n        <div className=\"flex items-center gap-2 mb-1\">\n          <Settings className=\"h-6 w-6\" />\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-settings-title\">Settings</h1>\n        </div>\n        <p className=\"text-muted-foreground\">Manage your account settings and preferences</p>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-6\">\n        <TabsList className=\"grid w-full grid-cols-4\" data-testid=\"tabs-settings\">\n          <TabsTrigger value=\"general\" data-testid=\"tab-general\">\n            <MapPin className=\"h-4 w-4 mr-2\" />\n            General\n          </TabsTrigger>\n          <TabsTrigger value=\"notifications\" data-testid=\"tab-notifications\">\n            <Bell className=\"h-4 w-4 mr-2\" />\n            Notifications\n          </TabsTrigger>\n          <TabsTrigger value=\"privacy\" data-testid=\"tab-privacy\">\n            <Shield className=\"h-4 w-4 mr-2\" />\n            Privacy\n          </TabsTrigger>\n          <TabsTrigger value=\"account\" data-testid=\"tab-account\">\n            <User className=\"h-4 w-4 mr-2\" />\n            Account\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"general\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <MapPin className=\"h-5 w-5\" />\n                Location Settings\n              </CardTitle>\n              <CardDescription>Control how your location is shared with others</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex-1\">\n                  <Label htmlFor=\"location-visibility\" className=\"flex items-center gap-2\">\n                    <Eye className=\"h-4 w-4\" />\n                    Location Visibility\n                  </Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Allow others to see your location\n                  </p>\n                </div>\n                <Switch\n                  id=\"location-visibility\"\n                  checked={settings?.locationVisible ?? true}\n                  onCheckedChange={(checked) => handleSettingToggle(\"locationVisible\", checked)}\n                  disabled={updateSettingsMutation.isPending}\n                  data-testid=\"switch-location-visibility\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex-1\">\n                  <Label htmlFor=\"distance-campus\" className=\"flex items-center gap-2\">\n                    <MapPin className=\"h-4 w-4\" />\n                    Show Distance from Campus\n                  </Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Display your distance from campus to buyers\n                  </p>\n                </div>\n                <Switch\n                  id=\"distance-campus\"\n                  checked={settings?.showDistanceFromCampus ?? true}\n                  onCheckedChange={(checked) => handleSettingToggle(\"showDistanceFromCampus\", checked)}\n                  disabled={updateSettingsMutation.isPending}\n                  data-testid=\"switch-distance-campus\"\n                />\n              </div>\n\n              <Separator />\n\n              <div>\n                <Label className=\"flex items-center gap-2 mb-2\">\n                  <MapPin className=\"h-4 w-4\" />\n                  Current Location\n                </Label>\n                {settings?.latitude && settings?.longitude ? (\n                  <div className=\"flex items-center gap-2 p-3 bg-muted rounded-md\">\n                    <Check className=\"h-4 w-4 text-green-500\" />\n                    <span className=\"text-sm\" data-testid=\"text-current-location\">\n                      Location set: {Number(settings.latitude).toFixed(4)}, {Number(settings.longitude).toFixed(4)}\n                    </span>\n                  </div>\n                ) : (\n                  <div className=\"flex items-center gap-2 p-3 bg-muted rounded-md\">\n                    <X className=\"h-4 w-4 text-muted-foreground\" />\n                    <span className=\"text-sm text-muted-foreground\" data-testid=\"text-no-location\">\n                      Location not set\n                    </span>\n                  </div>\n                )}\n                <Button\n                  onClick={handleGetLocation}\n                  disabled={isGettingLocation || updateSettingsMutation.isPending}\n                  className=\"mt-3 w-full\"\n                  data-testid=\"button-update-location\"\n                >\n                  {isGettingLocation ? (\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <MapPin className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Update My Location\n                </Button>\n                <p className=\"text-xs text-muted-foreground mt-2\">\n                  Your location helps buyers see how close you are and estimate delivery times.\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"notifications\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Bell className=\"h-5 w-5\" />\n                Notification Preferences\n              </CardTitle>\n              <CardDescription>Choose how you want to be notified</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex-1\">\n                  <Label htmlFor=\"push-notifications\" className=\"flex items-center gap-2\">\n                    <Bell className=\"h-4 w-4\" />\n                    Push Notifications\n                  </Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Receive push notifications on your device\n                  </p>\n                </div>\n                <Switch\n                  id=\"push-notifications\"\n                  checked={settings?.pushNotifications ?? true}\n                  onCheckedChange={(checked) => handleSettingToggle(\"pushNotifications\", checked)}\n                  disabled={updateSettingsMutation.isPending}\n                  data-testid=\"switch-push-notifications\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex-1\">\n                  <Label htmlFor=\"email-notifications\" className=\"flex items-center gap-2\">\n                    <Mail className=\"h-4 w-4\" />\n                    Email Notifications\n                  </Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Receive important updates via email\n                  </p>\n                </div>\n                <Switch\n                  id=\"email-notifications\"\n                  checked={settings?.emailNotifications ?? true}\n                  onCheckedChange={(checked) => handleSettingToggle(\"emailNotifications\", checked)}\n                  disabled={updateSettingsMutation.isPending}\n                  data-testid=\"switch-email-notifications\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex-1\">\n                  <Label htmlFor=\"message-notifications\" className=\"flex items-center gap-2\">\n                    <MessageSquare className=\"h-4 w-4\" />\n                    Message Notifications\n                  </Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Get notified about new messages\n                  </p>\n                </div>\n                <Switch\n                  id=\"message-notifications\"\n                  checked={settings?.messageNotifications ?? true}\n                  onCheckedChange={(checked) => handleSettingToggle(\"messageNotifications\", checked)}\n                  disabled={updateSettingsMutation.isPending}\n                  data-testid=\"switch-message-notifications\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex-1\">\n                  <Label htmlFor=\"order-notifications\" className=\"flex items-center gap-2\">\n                    <ShoppingBag className=\"h-4 w-4\" />\n                    Order Notifications\n                  </Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Updates about your orders and sales\n                  </p>\n                </div>\n                <Switch\n                  id=\"order-notifications\"\n                  checked={settings?.orderNotifications ?? true}\n                  onCheckedChange={(checked) => handleSettingToggle(\"orderNotifications\", checked)}\n                  disabled={updateSettingsMutation.isPending}\n                  data-testid=\"switch-order-notifications\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex-1\">\n                  <Label htmlFor=\"promotional-notifications\" className=\"flex items-center gap-2\">\n                    <Megaphone className=\"h-4 w-4\" />\n                    Promotional Notifications\n                  </Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Deals, offers, and promotional content\n                  </p>\n                </div>\n                <Switch\n                  id=\"promotional-notifications\"\n                  checked={settings?.promotionalNotifications ?? false}\n                  onCheckedChange={(checked) => handleSettingToggle(\"promotionalNotifications\", checked)}\n                  disabled={updateSettingsMutation.isPending}\n                  data-testid=\"switch-promotional-notifications\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <MessageSquare className=\"h-5 w-5\" />\n                Chat Settings\n              </CardTitle>\n              <CardDescription>Control your chat privacy and status</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex-1\">\n                  <Label htmlFor=\"typing-status\">Show Typing Status</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Let others see when you&apos;re typing\n                  </p>\n                </div>\n                <Switch\n                  id=\"typing-status\"\n                  checked={settings?.showTypingStatus ?? true}\n                  onCheckedChange={(checked) => handleSettingToggle(\"showTypingStatus\", checked)}\n                  disabled={updateSettingsMutation.isPending}\n                  data-testid=\"switch-typing-status\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex-1\">\n                  <Label htmlFor=\"read-receipts\">Show Read Receipts</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Let others see when you&apos;ve read their messages\n                  </p>\n                </div>\n                <Switch\n                  id=\"read-receipts\"\n                  checked={settings?.showReadReceipts ?? true}\n                  onCheckedChange={(checked) => handleSettingToggle(\"showReadReceipts\", checked)}\n                  disabled={updateSettingsMutation.isPending}\n                  data-testid=\"switch-read-receipts\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex-1\">\n                  <Label htmlFor=\"online-status\">Show Online Status</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Let others see when you&apos;re online\n                  </p>\n                </div>\n                <Switch\n                  id=\"online-status\"\n                  checked={settings?.showOnlineStatus ?? true}\n                  onCheckedChange={(checked) => handleSettingToggle(\"showOnlineStatus\", checked)}\n                  disabled={updateSettingsMutation.isPending}\n                  data-testid=\"switch-online-status\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"privacy\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Ban className=\"h-5 w-5\" />\n                Blocked Accounts\n              </CardTitle>\n              <CardDescription>Users you have blocked</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {blockedUsersLoading ? (\n                <div className=\"space-y-3\" data-testid=\"skeleton-blocked-users\">\n                  {[1, 2, 3].map((i) => (\n                    <div key={i} className=\"flex items-center justify-between gap-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <Skeleton className=\"h-10 w-10 rounded-full\" />\n                        <Skeleton className=\"h-4 w-32\" />\n                      </div>\n                      <Skeleton className=\"h-9 w-20\" />\n                    </div>\n                  ))}\n                </div>\n              ) : blockedUsers && blockedUsers.length > 0 ? (\n                <div className=\"space-y-3\" data-testid=\"list-blocked-users\">\n                  {blockedUsers.map((blockedUser) => (\n                    <div\n                      key={blockedUser.id}\n                      className=\"flex items-center justify-between gap-4\"\n                      data-testid={`blocked-user-${blockedUser.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <Avatar className=\"h-10 w-10\">\n                          <AvatarImage src={blockedUser.profileImageUrl || undefined} />\n                          <AvatarFallback>\n                            {blockedUser.firstName?.[0] || \"\"}\n                            {blockedUser.lastName?.[0] || \"\"}\n                          </AvatarFallback>\n                        </Avatar>\n                        <span className=\"font-medium\" data-testid={`text-blocked-user-name-${blockedUser.id}`}>\n                          {blockedUser.firstName} {blockedUser.lastName}\n                        </span>\n                      </div>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => unblockMutation.mutate(blockedUser.id)}\n                        disabled={unblockMutation.isPending}\n                        data-testid={`button-unblock-${blockedUser.id}`}\n                      >\n                        {unblockMutation.isPending ? (\n                          <Loader2 className=\"h-4 w-4 animate-spin\" />\n                        ) : (\n                          \"Unblock\"\n                        )}\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"flex flex-col items-center justify-center py-8 text-center\" data-testid=\"empty-blocked-users\">\n                  <Ban className=\"h-12 w-12 text-muted-foreground mb-3\" />\n                  <p className=\"text-muted-foreground\">No blocked users</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Users you block will appear here\n                  </p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <VolumeX className=\"h-5 w-5\" />\n                Muted Accounts\n              </CardTitle>\n              <CardDescription>Users you have muted</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {mutedUsersLoading ? (\n                <div className=\"space-y-3\" data-testid=\"skeleton-muted-users\">\n                  {[1, 2, 3].map((i) => (\n                    <div key={i} className=\"flex items-center justify-between gap-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <Skeleton className=\"h-10 w-10 rounded-full\" />\n                        <Skeleton className=\"h-4 w-32\" />\n                      </div>\n                      <Skeleton className=\"h-9 w-20\" />\n                    </div>\n                  ))}\n                </div>\n              ) : mutedUsers && mutedUsers.length > 0 ? (\n                <div className=\"space-y-3\" data-testid=\"list-muted-users\">\n                  {mutedUsers.map((mutedUser) => (\n                    <div\n                      key={mutedUser.id}\n                      className=\"flex items-center justify-between gap-4\"\n                      data-testid={`muted-user-${mutedUser.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <Avatar className=\"h-10 w-10\">\n                          <AvatarImage src={mutedUser.profileImageUrl || undefined} />\n                          <AvatarFallback>\n                            {mutedUser.firstName?.[0] || \"\"}\n                            {mutedUser.lastName?.[0] || \"\"}\n                          </AvatarFallback>\n                        </Avatar>\n                        <span className=\"font-medium\" data-testid={`text-muted-user-name-${mutedUser.id}`}>\n                          {mutedUser.firstName} {mutedUser.lastName}\n                        </span>\n                      </div>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => unmuteMutation.mutate(mutedUser.id)}\n                        disabled={unmuteMutation.isPending}\n                        data-testid={`button-unmute-${mutedUser.id}`}\n                      >\n                        {unmuteMutation.isPending ? (\n                          <Loader2 className=\"h-4 w-4 animate-spin\" />\n                        ) : (\n                          \"Unmute\"\n                        )}\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"flex flex-col items-center justify-center py-8 text-center\" data-testid=\"empty-muted-users\">\n                  <VolumeX className=\"h-12 w-12 text-muted-foreground mb-3\" />\n                  <p className=\"text-muted-foreground\">No muted users</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Users you mute will appear here\n                  </p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"account\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <User className=\"h-5 w-5\" />\n                Account Information\n              </CardTitle>\n              <CardDescription>Your account details</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-muted rounded-md\">\n                    <Mail className=\"h-4 w-4\" />\n                  </div>\n                  <div>\n                    <Label>Email</Label>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"text-user-email\">\n                      {user.email || \"Not set\"}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-muted rounded-md\">\n                    <Phone className=\"h-4 w-4\" />\n                  </div>\n                  <div>\n                    <Label>Phone</Label>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"text-user-phone\">\n                      {user.phoneNumber || \"Not set\"}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-muted rounded-md\">\n                    <Calendar className=\"h-4 w-4\" />\n                  </div>\n                  <div>\n                    <Label>Member Since</Label>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"text-member-since\">\n                      {user.createdAt \n                        ? format(new Date(user.createdAt), \"MMMM d, yyyy\")\n                        : \"Unknown\"\n                      }\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between gap-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-muted rounded-md\">\n                    <Users className=\"h-4 w-4\" />\n                  </div>\n                  <div className=\"flex-1\">\n                    <Label htmlFor=\"gender\">Gender</Label>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Optional - used for personalized experience\n                    </p>\n                  </div>\n                </div>\n                <Select\n                  value={(user as any).gender || \"\"}\n                  onValueChange={async (value) => {\n                    try {\n                      await apiRequest(\"PUT\", `/api/users/${user.id}`, { gender: value || null });\n                      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n                      toast({ title: \"Gender updated\" });\n                    } catch (error) {\n                      toast({ title: \"Failed to update gender\", variant: \"destructive\" });\n                    }\n                  }}\n                >\n                  <SelectTrigger className=\"w-[180px]\" data-testid=\"select-gender\">\n                    <SelectValue placeholder=\"Select gender\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"male\">Male</SelectItem>\n                    <SelectItem value=\"female\">Female</SelectItem>\n                    <SelectItem value=\"other\">Other</SelectItem>\n                    <SelectItem value=\"prefer_not_to_say\">Prefer not to say</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className={isVerified ? \"border-green-500/50\" : \"border-yellow-500/50\"}>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Shield className={`h-5 w-5 ${isVerified ? \"text-green-500\" : \"text-yellow-500\"}`} />\n                KYC Verification\n              </CardTitle>\n              <CardDescription>\n                {isVerified \n                  ? \"Your identity has been verified\" \n                  : \"Verify your identity to unlock seller features\"\n                }\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {isVerified ? (\n                <div className=\"flex items-center gap-3 p-4 bg-green-500/10 rounded-md border border-green-500/20\">\n                  <BadgeCheck className=\"h-6 w-6 text-green-500\" />\n                  <div>\n                    <p className=\"font-medium text-green-600 dark:text-green-400\" data-testid=\"text-verification-status\">\n                      Verified Seller\n                    </p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      You can list products and create ads on the marketplace\n                    </p>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  <Alert className=\"border-yellow-500/50 bg-yellow-500/10\">\n                    <AlertTriangle className=\"h-4 w-4 text-yellow-500\" />\n                    <AlertTitle className=\"text-yellow-600 dark:text-yellow-400\">Verification Required</AlertTitle>\n                    <AlertDescription>\n                      Complete identity verification to list products for sale on the marketplace. \n                      This helps build trust and prevents scams.\n                    </AlertDescription>\n                  </Alert>\n                  \n                  <div className=\"space-y-2\">\n                    <h4 className=\"font-medium\">Benefits of verification:</h4>\n                    <ul className=\"list-disc pl-5 text-sm text-muted-foreground space-y-1\">\n                      <li>Green verified badge on your profile</li>\n                      <li>Ability to list and sell products</li>\n                      <li>Higher trust from buyers</li>\n                      <li>Access to all seller features</li>\n                    </ul>\n                  </div>\n                  \n                  <Link href=\"/kyc\">\n                    <Button className=\"w-full\" data-testid=\"button-verify-kyc\">\n                      <Shield className=\"mr-2 h-4 w-4\" />\n                      Get Verified Now\n                      <ExternalLink className=\"ml-2 h-4 w-4\" />\n                    </Button>\n                  </Link>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-destructive/50\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2 text-destructive\">\n                <Trash2 className=\"h-5 w-5\" />\n                Delete Account\n              </CardTitle>\n              <CardDescription>Permanently delete your account and all data</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <Alert variant=\"destructive\">\n                <AlertTriangle className=\"h-4 w-4\" />\n                <AlertTitle>Warning: Account Deletion Policy</AlertTitle>\n                <AlertDescription>\n                  When you request account deletion, your account will be scheduled for permanent deletion after a 30-day grace period. \n                  During this time, you can cancel the deletion request. After 30 days, all your data including listings, messages, \n                  wallet balance, and personal information will be permanently deleted and cannot be recovered.\n                </AlertDescription>\n              </Alert>\n\n              {deletionRequested && deletionDate && daysUntilDeletion !== null ? (\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center gap-2 p-4 bg-destructive/10 rounded-md border border-destructive/20\">\n                    <Clock className=\"h-5 w-5 text-destructive\" />\n                    <div>\n                      <p className=\"font-medium text-destructive\" data-testid=\"text-deletion-status\">\n                        Account Deletion Scheduled\n                      </p>\n                      <p className=\"text-sm text-muted-foreground\" data-testid=\"text-deletion-countdown\">\n                        Your account will be deleted in {daysUntilDeletion} days \n                        ({format(deletionDate, \"MMMM d, yyyy\")})\n                      </p>\n                    </div>\n                  </div>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => cancelDeletionMutation.mutate()}\n                    disabled={cancelDeletionMutation.isPending}\n                    data-testid=\"button-cancel-deletion\"\n                  >\n                    {cancelDeletionMutation.isPending ? (\n                      <>\n                        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                        Cancelling...\n                      </>\n                    ) : (\n                      <>\n                        <X className=\"mr-2 h-4 w-4\" />\n                        Cancel Deletion\n                      </>\n                    )}\n                  </Button>\n                </div>\n              ) : (\n                <Button\n                  variant=\"destructive\"\n                  onClick={() => setDeleteDialogOpen(true)}\n                  data-testid=\"button-delete-account\"\n                >\n                  <Trash2 className=\"mr-2 h-4 w-4\" />\n                  Delete Account\n                </Button>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-destructive\">\n              <AlertTriangle className=\"h-5 w-5\" />\n              Confirm Account Deletion\n            </DialogTitle>\n            <DialogDescription>\n              This action will schedule your account for permanent deletion. To confirm, please type your username or email below.\n            </DialogDescription>\n          </DialogHeader>\n\n          <Alert variant=\"destructive\">\n            <AlertTriangle className=\"h-4 w-4\" />\n            <AlertTitle>This will delete:</AlertTitle>\n            <AlertDescription>\n              <ul className=\"list-disc list-inside mt-2 space-y-1\">\n                <li>All your product listings</li>\n                <li>Your wallet balance and transaction history</li>\n                <li>All messages and conversations</li>\n                <li>Your reviews and ratings</li>\n                <li>All personal information</li>\n              </ul>\n            </AlertDescription>\n          </Alert>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"username-confirmation\">\n              Type <span className=\"font-mono font-bold\">{username}</span> or your email to confirm\n            </Label>\n            <Input\n              id=\"username-confirmation\"\n              value={usernameConfirmation}\n              onChange={(e) => setUsernameConfirmation(e.target.value)}\n              placeholder=\"Enter username or email\"\n              data-testid=\"input-username-confirmation\"\n            />\n          </div>\n\n          <DialogFooter className=\"gap-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setDeleteDialogOpen(false);\n                setUsernameConfirmation(\"\");\n              }}\n              data-testid=\"button-cancel-dialog\"\n            >\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={handleDeleteAccount}\n              disabled={requestDeletionMutation.isPending || !usernameConfirmation.trim()}\n              data-testid=\"button-confirm-delete\"\n            >\n              {requestDeletionMutation.isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Requesting...\n                </>\n              ) : (\n                <>\n                  <Trash2 className=\"mr-2 h-4 w-4\" />\n                  Delete My Account\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":42245,"size_tokens":null},"client/src/pages/vtu.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { \n  Wallet, Smartphone, Signal, CheckCircle, XCircle, Clock, Loader2, Plus, AlertCircle, \n  Search, Phone, Zap, Users, Star, Trash2, Filter, Gift, Sparkles, Calendar, \n  Play, Pause, Send, Copy, Download, Tv, Lightbulb, Receipt\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { format } from \"date-fns\";\nimport type { \n  Wallet as WalletType, \n  VtuPlan, \n  VtuTransaction, \n  VtuBeneficiary,\n  ScheduledVtuPurchase,\n  GiftData,\n  BillPayment\n} from \"@shared/schema\";\n\ntype NetworkType = \"mtn_sme\" | \"glo_cg\" | \"airtel_cg\" | \"9mobile\";\ntype ServiceType = \"data\" | \"airtime\" | \"schedule\" | \"gift\" | \"bills\";\ntype BillType = \"cable\" | \"electricity\";\ntype BillServiceType = \"dstv\" | \"gotv\" | \"startimes\" | \"showmax\" | \"ekedc\" | \"ikedc\" | \"aedc\" | \"ibedc\" | \"phedc\" | \"eedc\";\n\ninterface BillPackage {\n  code: string;\n  name: string;\n  amount: number;\n  validity?: string;\n}\n\nconst CABLE_SERVICES = [\n  { id: \"dstv\" as BillServiceType, name: \"DSTV\", icon: \"TV\" },\n  { id: \"gotv\" as BillServiceType, name: \"GOtv\", icon: \"TV\" },\n  { id: \"startimes\" as BillServiceType, name: \"StarTimes\", icon: \"TV\" },\n  { id: \"showmax\" as BillServiceType, name: \"Showmax\", icon: \"TV\" },\n];\n\nconst ELECTRICITY_SERVICES = [\n  { id: \"ekedc\" as BillServiceType, name: \"Eko (EKEDC)\", region: \"Lagos\" },\n  { id: \"ikedc\" as BillServiceType, name: \"Ikeja (IKEDC)\", region: \"Lagos\" },\n  { id: \"aedc\" as BillServiceType, name: \"Abuja (AEDC)\", region: \"Abuja\" },\n  { id: \"ibedc\" as BillServiceType, name: \"Ibadan (IBEDC)\", region: \"Ibadan\" },\n  { id: \"phedc\" as BillServiceType, name: \"Port Harcourt (PHEDC)\", region: \"PH\" },\n  { id: \"eedc\" as BillServiceType, name: \"Enugu (EEDC)\", region: \"Enugu\" },\n];\n\ntype ScheduleFrequency = \"daily\" | \"weekly\" | \"monthly\";\n\ninterface NetworkInfo {\n  id: NetworkType;\n  name: string;\n  displayName: string;\n  color: string;\n  bgColor: string;\n  textColor: string;\n  prefixes: string[];\n}\n\nconst NETWORKS: NetworkInfo[] = [\n  {\n    id: \"mtn_sme\",\n    name: \"MTN SME\",\n    displayName: \"MTN\",\n    color: \"bg-yellow-500\",\n    bgColor: \"bg-yellow-100 dark:bg-yellow-900/30\",\n    textColor: \"text-yellow-700 dark:text-yellow-300\",\n    prefixes: [\"0803\", \"0806\", \"0703\", \"0704\", \"0706\", \"0810\", \"0813\", \"0814\", \"0816\", \"0903\", \"0906\", \"0913\", \"0916\", \"0702\"],\n  },\n  {\n    id: \"glo_cg\",\n    name: \"GLO CG\",\n    displayName: \"GLO\",\n    color: \"bg-green-600\",\n    bgColor: \"bg-green-100 dark:bg-green-900/30\",\n    textColor: \"text-green-700 dark:text-green-300\",\n    prefixes: [\"0805\", \"0807\", \"0705\", \"0815\", \"0811\", \"0905\", \"0915\"],\n  },\n  {\n    id: \"airtel_cg\",\n    name: \"Airtel CG\",\n    displayName: \"Airtel\",\n    color: \"bg-red-500\",\n    bgColor: \"bg-red-100 dark:bg-red-900/30\",\n    textColor: \"text-red-700 dark:text-red-300\",\n    prefixes: [\"0802\", \"0808\", \"0708\", \"0812\", \"0701\", \"0902\", \"0907\", \"0901\", \"0912\"],\n  },\n  {\n    id: \"9mobile\",\n    name: \"9mobile\",\n    displayName: \"9mobile\",\n    color: \"bg-green-500\",\n    bgColor: \"bg-emerald-100 dark:bg-emerald-900/30\",\n    textColor: \"text-emerald-700 dark:text-emerald-300\",\n    prefixes: [\"0809\", \"0817\", \"0818\", \"0909\", \"0908\"],\n  },\n];\n\nconst AIRTIME_AMOUNTS = [50, 100, 200, 500, 1000, 2000, 5000, 10000];\n\nconst DAYS_OF_WEEK = [\n  { value: 0, label: \"Sunday\" },\n  { value: 1, label: \"Monday\" },\n  { value: 2, label: \"Tuesday\" },\n  { value: 3, label: \"Wednesday\" },\n  { value: 4, label: \"Thursday\" },\n  { value: 5, label: \"Friday\" },\n  { value: 6, label: \"Saturday\" },\n];\n\nfunction detectNetwork(phoneNumber: string): NetworkInfo | null {\n  const cleaned = phoneNumber.replace(/\\D/g, \"\");\n  if (cleaned.length < 4) return null;\n  \n  const prefix = cleaned.startsWith(\"234\") \n    ? \"0\" + cleaned.slice(3, 6) \n    : cleaned.slice(0, 4);\n  \n  for (const network of NETWORKS) {\n    if (network.prefixes.includes(prefix)) {\n      return network;\n    }\n  }\n  return null;\n}\n\nfunction validatePhoneNumber(phone: string): { valid: boolean; message: string } {\n  const cleaned = phone.replace(/\\D/g, \"\");\n  \n  if (!cleaned) {\n    return { valid: false, message: \"\" };\n  }\n  \n  if (cleaned.startsWith(\"234\")) {\n    if (cleaned.length !== 13) {\n      return { valid: false, message: \"Phone number must be 13 digits when starting with 234\" };\n    }\n    return { valid: true, message: \"\" };\n  }\n  \n  if (cleaned.startsWith(\"0\")) {\n    if (cleaned.length !== 11) {\n      return { valid: false, message: \"Phone number must be 11 digits\" };\n    }\n    return { valid: true, message: \"\" };\n  }\n  \n  return { valid: false, message: \"Phone number must start with 0 or 234\" };\n}\n\nexport default function VtuPage() {\n  const { toast } = useToast();\n  const [serviceType, setServiceType] = useState<ServiceType>(\"data\");\n  const [selectedNetwork, setSelectedNetwork] = useState<NetworkType>(\"mtn_sme\");\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n  const [selectedPlanId, setSelectedPlanId] = useState<string | null>(null);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [customAirtimeAmount, setCustomAirtimeAmount] = useState(\"\");\n  const [selectedAirtimeAmount, setSelectedAirtimeAmount] = useState<number | null>(null);\n  \n  // Beneficiary states\n  const [showBeneficiaryDialog, setShowBeneficiaryDialog] = useState(false);\n  const [newBeneficiaryName, setNewBeneficiaryName] = useState(\"\");\n  const [selectedBeneficiary, setSelectedBeneficiary] = useState<VtuBeneficiary | null>(null);\n  \n  // Transaction filter states\n  const [txStatusFilter, setTxStatusFilter] = useState<string>(\"all\");\n  const [txNetworkFilter, setTxNetworkFilter] = useState<string>(\"all\");\n\n  // Schedule states\n  const [showScheduleDialog, setShowScheduleDialog] = useState(false);\n  const [scheduleFrequency, setScheduleFrequency] = useState<ScheduleFrequency>(\"daily\");\n  const [scheduleDayOfWeek, setScheduleDayOfWeek] = useState<number>(1);\n  const [scheduleDayOfMonth, setScheduleDayOfMonth] = useState<number>(1);\n  const [scheduleTimeOfDay, setScheduleTimeOfDay] = useState<string>(\"09:00\");\n  const [schedulePhoneNumber, setSchedulePhoneNumber] = useState(\"\");\n  const [scheduleNetwork, setScheduleNetwork] = useState<NetworkType>(\"mtn_sme\");\n  const [scheduleServiceType, setScheduleServiceType] = useState<\"data\" | \"airtime\">(\"data\");\n  const [schedulePlanId, setSchedulePlanId] = useState<string | null>(null);\n  const [scheduleAirtimeAmount, setScheduleAirtimeAmount] = useState<string>(\"\");\n\n  // Gift Data states\n  const [showGiftDialog, setShowGiftDialog] = useState(false);\n  const [giftRecipientPhone, setGiftRecipientPhone] = useState(\"\");\n  const [giftMessage, setGiftMessage] = useState(\"\");\n  const [giftPlanId, setGiftPlanId] = useState<string | null>(null);\n  const [giftNetwork, setGiftNetwork] = useState<NetworkType>(\"mtn_sme\");\n  const [giftTab, setGiftTab] = useState<\"send\" | \"sent\" | \"received\">(\"send\");\n\n  // Bill Payment states\n  const [billType, setBillType] = useState<BillType>(\"cable\");\n  const [selectedBillService, setSelectedBillService] = useState<BillServiceType>(\"dstv\");\n  const [billCustomerId, setBillCustomerId] = useState(\"\");\n  const [billCustomerName, setBillCustomerName] = useState<string | null>(null);\n  const [billCustomerValidated, setBillCustomerValidated] = useState(false);\n  const [selectedBillPackage, setSelectedBillPackage] = useState<BillPackage | null>(null);\n  const [billElectricityAmount, setBillElectricityAmount] = useState(\"\");\n  const [billPackages, setBillPackages] = useState<BillPackage[]>([]);\n  const [loadingBillPackages, setLoadingBillPackages] = useState(false);\n\n  const { data: wallet, isLoading: walletLoading } = useQuery<WalletType>({\n    queryKey: [\"/api/wallet\"],\n  });\n\n  const { data: plans, isLoading: plansLoading } = useQuery<VtuPlan[]>({\n    queryKey: [\"/api/vtu/plans\", { network: selectedNetwork }],\n  });\n\n  const { data: schedulePlans } = useQuery<VtuPlan[]>({\n    queryKey: [\"/api/vtu/plans\", { network: scheduleNetwork }],\n    enabled: showScheduleDialog,\n  });\n\n  const { data: giftPlans } = useQuery<VtuPlan[]>({\n    queryKey: [\"/api/vtu/plans\", { network: giftNetwork }],\n    enabled: serviceType === \"gift\" || showGiftDialog,\n  });\n\n  const { data: transactions, isLoading: transactionsLoading } = useQuery<VtuTransaction[]>({\n    queryKey: [\"/api/vtu/transactions\", { status: txStatusFilter !== \"all\" ? txStatusFilter : undefined, network: txNetworkFilter !== \"all\" ? txNetworkFilter : undefined }],\n  });\n\n  const { data: beneficiaries } = useQuery<VtuBeneficiary[]>({\n    queryKey: [\"/api/vtu/beneficiaries\"],\n  });\n\n  const { data: scheduledPurchases, isLoading: schedulesLoading } = useQuery<ScheduledVtuPurchase[]>({\n    queryKey: [\"/api/vtu/scheduled-purchases\"],\n    enabled: serviceType === \"schedule\",\n  });\n\n  const { data: sentGifts, isLoading: sentGiftsLoading } = useQuery<GiftData[]>({\n    queryKey: [\"/api/vtu/gift-data\", { type: \"sent\" }],\n    enabled: serviceType === \"gift\",\n  });\n\n  const { data: receivedGifts, isLoading: receivedGiftsLoading } = useQuery<GiftData[]>({\n    queryKey: [\"/api/vtu/gift-data\", { type: \"received\" }],\n    enabled: serviceType === \"gift\",\n  });\n\n  const { data: billPayments, isLoading: billPaymentsLoading } = useQuery<BillPayment[]>({\n    queryKey: [\"/api/bills/history\"],\n    enabled: serviceType === \"bills\",\n  });\n\n  const createBeneficiaryMutation = useMutation({\n    mutationFn: async (data: { name: string; phoneNumber: string; network: NetworkType }) => {\n      const response = await apiRequest(\"POST\", \"/api/vtu/beneficiaries\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Saved\", description: \"Beneficiary saved successfully\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/vtu/beneficiaries\"] });\n      setShowBeneficiaryDialog(false);\n      setNewBeneficiaryName(\"\");\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to save beneficiary\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteBeneficiaryMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"DELETE\", `/api/vtu/beneficiaries/${id}`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Deleted\", description: \"Beneficiary removed\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/vtu/beneficiaries\"] });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to delete beneficiary\", variant: \"destructive\" });\n    },\n  });\n\n  const purchaseDataMutation = useMutation({\n    mutationFn: async (data: { planId: string; phoneNumber: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/vtu/purchase\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Purchase Successful\",\n        description: \"Data has been sent to the phone number.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/vtu/transactions\"] });\n      setSelectedPlanId(null);\n      setPhoneNumber(\"\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Purchase Failed\",\n        description: error.message || \"Unable to complete the purchase. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const purchaseAirtimeMutation = useMutation({\n    mutationFn: async (data: { phoneNumber: string; amount: number; network: NetworkType }) => {\n      const response = await apiRequest(\"POST\", \"/api/vtu/airtime\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Airtime Purchase Successful\",\n        description: \"Airtime has been sent to the phone number.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/vtu/transactions\"] });\n      setSelectedAirtimeAmount(null);\n      setCustomAirtimeAmount(\"\");\n      setPhoneNumber(\"\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Airtime Purchase Failed\",\n        description: error.message || \"Unable to complete the purchase. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Schedule mutations\n  const createScheduleMutation = useMutation({\n    mutationFn: async (data: {\n      serviceType: \"data\" | \"airtime\";\n      planId?: string;\n      network: NetworkType;\n      phoneNumber: string;\n      amount?: number;\n      frequency: ScheduleFrequency;\n      dayOfWeek?: number;\n      dayOfMonth?: number;\n      timeOfDay?: string;\n    }) => {\n      const response = await apiRequest(\"POST\", \"/api/vtu/scheduled-purchases\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Schedule Created\", description: \"Your scheduled purchase has been set up.\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/vtu/scheduled-purchases\"] });\n      setShowScheduleDialog(false);\n      resetScheduleForm();\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to create schedule\", variant: \"destructive\" });\n    },\n  });\n\n  const updateScheduleStatusMutation = useMutation({\n    mutationFn: async ({ id, status }: { id: string; status: \"active\" | \"paused\" }) => {\n      const response = await apiRequest(\"PUT\", `/api/vtu/scheduled-purchases/${id}`, { status });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Updated\", description: \"Schedule status updated.\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/vtu/scheduled-purchases\"] });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to update schedule\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteScheduleMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"DELETE\", `/api/vtu/scheduled-purchases/${id}`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Deleted\", description: \"Schedule removed.\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/vtu/scheduled-purchases\"] });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to delete schedule\", variant: \"destructive\" });\n    },\n  });\n\n  // Gift mutations\n  const sendGiftMutation = useMutation({\n    mutationFn: async (data: { recipientPhone: string; planId: string; network: NetworkType; message?: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/vtu/gift-data\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Gift Sent\", description: \"Your data gift has been sent successfully!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/vtu/gift-data\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n      setShowGiftDialog(false);\n      resetGiftForm();\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to send gift\", variant: \"destructive\" });\n    },\n  });\n\n  const claimGiftMutation = useMutation({\n    mutationFn: async (code: string) => {\n      const response = await apiRequest(\"POST\", `/api/vtu/gift-data/${code}/claim`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Gift Claimed\", description: \"Data has been added to your phone!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/vtu/gift-data\"] });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to claim gift\", variant: \"destructive\" });\n    },\n  });\n\n  const validateBillCustomerMutation = useMutation({\n    mutationFn: async (data: { serviceType: BillServiceType; customerId: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/bills/validate\", data);\n      return response.json();\n    },\n    onSuccess: (data: any) => {\n      if (data.success) {\n        setBillCustomerName(data.customerName);\n        setBillCustomerValidated(true);\n        toast({ title: \"Verified\", description: `Customer: ${data.customerName}` });\n      } else {\n        setBillCustomerName(null);\n        setBillCustomerValidated(false);\n        toast({ title: \"Validation Failed\", description: data.message || \"Invalid customer ID\", variant: \"destructive\" });\n      }\n    },\n    onError: (error: any) => {\n      setBillCustomerName(null);\n      setBillCustomerValidated(false);\n      toast({ title: \"Error\", description: error.message || \"Failed to validate customer\", variant: \"destructive\" });\n    },\n  });\n\n  const payBillMutation = useMutation({\n    mutationFn: async (data: { \n      serviceType: BillServiceType; \n      billType: BillType; \n      customerId: string; \n      amount: number;\n      packageCode?: string;\n      packageName?: string;\n    }) => {\n      const response = await apiRequest(\"POST\", \"/api/bills/pay\", data);\n      return response.json();\n    },\n    onSuccess: (data: any) => {\n      if (data.success) {\n        toast({ \n          title: \"Payment Successful\", \n          description: data.token \n            ? `Token: ${data.token}` \n            : \"Bill payment completed successfully!\" \n        });\n        queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/bills/history\"] });\n        resetBillForm();\n      } else {\n        toast({ title: \"Payment Failed\", description: data.message || \"Bill payment failed\", variant: \"destructive\" });\n      }\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to process payment\", variant: \"destructive\" });\n    },\n  });\n\n  const resetScheduleForm = () => {\n    setSchedulePhoneNumber(\"\");\n    setScheduleNetwork(\"mtn_sme\");\n    setScheduleServiceType(\"data\");\n    setSchedulePlanId(null);\n    setScheduleAirtimeAmount(\"\");\n    setScheduleFrequency(\"daily\");\n    setScheduleDayOfWeek(1);\n    setScheduleDayOfMonth(1);\n    setScheduleTimeOfDay(\"09:00\");\n  };\n\n  const resetGiftForm = () => {\n    setGiftRecipientPhone(\"\");\n    setGiftMessage(\"\");\n    setGiftPlanId(null);\n    setGiftNetwork(\"mtn_sme\");\n  };\n\n  const resetBillForm = () => {\n    setBillCustomerId(\"\");\n    setBillCustomerName(null);\n    setBillCustomerValidated(false);\n    setSelectedBillPackage(null);\n    setBillElectricityAmount(\"\");\n    setBillPackages([]);\n  };\n\n  const fetchCablePackages = async (service: BillServiceType) => {\n    setLoadingBillPackages(true);\n    try {\n      const response = await fetch(`/api/bills/packages/${service}`);\n      const data = await response.json();\n      if (data.success && data.packages) {\n        setBillPackages(data.packages);\n      } else {\n        setBillPackages([]);\n      }\n    } catch (error) {\n      setBillPackages([]);\n    } finally {\n      setLoadingBillPackages(false);\n    }\n  };\n\n  const handleBillServiceChange = (service: BillServiceType) => {\n    setSelectedBillService(service);\n    resetBillForm();\n    if (billType === \"cable\") {\n      fetchCablePackages(service);\n    }\n  };\n\n  const handleBillTypeChange = (type: BillType) => {\n    setBillType(type);\n    resetBillForm();\n    if (type === \"cable\") {\n      setSelectedBillService(\"dstv\");\n      fetchCablePackages(\"dstv\");\n    } else {\n      setSelectedBillService(\"ekedc\");\n    }\n  };\n\n  const handleValidateCustomer = () => {\n    if (!billCustomerId.trim()) return;\n    validateBillCustomerMutation.mutate({\n      serviceType: selectedBillService,\n      customerId: billCustomerId.trim(),\n    });\n  };\n\n  const handleBillPayment = () => {\n    const amount = billType === \"cable\" \n      ? selectedBillPackage?.amount || 0 \n      : parseFloat(billElectricityAmount) || 0;\n\n    if (!amount || !billCustomerValidated) return;\n\n    payBillMutation.mutate({\n      serviceType: selectedBillService,\n      billType,\n      customerId: billCustomerId.trim(),\n      amount,\n      packageCode: selectedBillPackage?.code,\n      packageName: selectedBillPackage?.name,\n    });\n  };\n\n  const walletBalance = parseFloat(wallet?.balance || \"0\");\n\n  const canPayBill = billCustomerValidated && (\n    (billType === \"cable\" && selectedBillPackage && walletBalance >= selectedBillPackage.amount) ||\n    (billType === \"electricity\" && parseFloat(billElectricityAmount) >= 500 && walletBalance >= parseFloat(billElectricityAmount))\n  );\n\n  const getBillServiceName = (service: BillServiceType): string => {\n    const cable = CABLE_SERVICES.find(s => s.id === service);\n    if (cable) return cable.name;\n    const elec = ELECTRICITY_SERVICES.find(s => s.id === service);\n    return elec?.name || service.toUpperCase();\n  };\n\n  const detectedNetwork = useMemo(() => detectNetwork(phoneNumber), [phoneNumber]);\n  const phoneValidation = useMemo(() => validatePhoneNumber(phoneNumber), [phoneNumber]);\n  const networkMatch = detectedNetwork?.id === selectedNetwork;\n\n  const schedulePhoneValidation = useMemo(() => validatePhoneNumber(schedulePhoneNumber), [schedulePhoneNumber]);\n  const giftPhoneValidation = useMemo(() => validatePhoneNumber(giftRecipientPhone), [giftRecipientPhone]);\n\n  const filteredPlans = useMemo(() => {\n    if (!plans) return [];\n    if (!searchQuery.trim()) return plans;\n    \n    const query = searchQuery.toLowerCase();\n    return plans.filter(plan => \n      plan.dataAmount.toLowerCase().includes(query) ||\n      plan.validity.toLowerCase().includes(query) ||\n      plan.planName.toLowerCase().includes(query) ||\n      plan.sellingPrice.includes(query)\n    );\n  }, [plans, searchQuery]);\n\n  const selectedPlan = plans?.find((p) => p.id === selectedPlanId);\n  \n  const canPurchaseData = \n    selectedPlanId && \n    phoneValidation.valid && \n    selectedPlan && \n    walletBalance >= parseFloat(selectedPlan.sellingPrice);\n\n  const airtimeAmount = selectedAirtimeAmount || (customAirtimeAmount ? parseFloat(customAirtimeAmount) : 0);\n  const canPurchaseAirtime = \n    phoneValidation.valid && \n    airtimeAmount >= 50 && \n    airtimeAmount <= 50000 &&\n    walletBalance >= airtimeAmount;\n\n  const canCreateSchedule = \n    schedulePhoneValidation.valid &&\n    ((scheduleServiceType === \"data\" && schedulePlanId) || \n     (scheduleServiceType === \"airtime\" && parseFloat(scheduleAirtimeAmount) >= 50));\n\n  const selectedGiftPlan = giftPlans?.find(p => p.id === giftPlanId);\n  const canSendGift = \n    giftPhoneValidation.valid &&\n    giftPlanId &&\n    selectedGiftPlan &&\n    walletBalance >= parseFloat(selectedGiftPlan.sellingPrice);\n\n  const handleDataPurchase = () => {\n    if (!selectedPlanId || !phoneValidation.valid) return;\n\n    if (detectedNetwork && !networkMatch) {\n      toast({\n        title: \"Network Mismatch\",\n        description: `The phone number appears to be ${detectedNetwork.displayName}, but you selected ${NETWORKS.find(n => n.id === selectedNetwork)?.displayName}. Are you sure you want to continue?`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    purchaseDataMutation.mutate({ planId: selectedPlanId, phoneNumber });\n  };\n\n  const handleAirtimePurchase = () => {\n    if (!phoneValidation.valid || airtimeAmount < 50) return;\n\n    const network = detectedNetwork?.id || selectedNetwork;\n\n    purchaseAirtimeMutation.mutate({ \n      phoneNumber, \n      amount: airtimeAmount, \n      network \n    });\n  };\n\n  const handleSelectBeneficiary = (beneficiary: VtuBeneficiary) => {\n    setPhoneNumber(beneficiary.phoneNumber);\n    setSelectedNetwork(beneficiary.network as NetworkType);\n    setSelectedBeneficiary(beneficiary);\n    toast({ title: \"Contact Selected\", description: `Using ${beneficiary.name}'s number` });\n  };\n\n  const handleSaveBeneficiary = () => {\n    if (!phoneValidation.valid || !newBeneficiaryName.trim()) return;\n    const network = detectedNetwork?.id || selectedNetwork;\n    createBeneficiaryMutation.mutate({\n      name: newBeneficiaryName.trim(),\n      phoneNumber,\n      network,\n    });\n  };\n\n  const handleCreateSchedule = () => {\n    if (!canCreateSchedule) return;\n\n    createScheduleMutation.mutate({\n      serviceType: scheduleServiceType,\n      planId: scheduleServiceType === \"data\" ? schedulePlanId ?? undefined : undefined,\n      network: scheduleNetwork,\n      phoneNumber: schedulePhoneNumber,\n      amount: scheduleServiceType === \"airtime\" ? parseFloat(scheduleAirtimeAmount) : undefined,\n      frequency: scheduleFrequency,\n      dayOfWeek: scheduleFrequency === \"weekly\" ? scheduleDayOfWeek : undefined,\n      dayOfMonth: scheduleFrequency === \"monthly\" ? scheduleDayOfMonth : undefined,\n      timeOfDay: scheduleTimeOfDay,\n    });\n  };\n\n  const handleSendGift = () => {\n    if (!canSendGift || !giftPlanId) return;\n\n    sendGiftMutation.mutate({\n      recipientPhone: giftRecipientPhone,\n      planId: giftPlanId,\n      network: giftNetwork,\n      message: giftMessage || undefined,\n    });\n  };\n\n  const handleCopyGiftCode = (code: string) => {\n    navigator.clipboard.writeText(code);\n    toast({ title: \"Copied\", description: \"Gift code copied to clipboard\" });\n  };\n\n  const getNetworkBadge = (networkId: NetworkType | string) => {\n    const network = NETWORKS.find((n) => n.id === networkId);\n    if (!network) return null;\n    return (\n      <Badge className={`${network.bgColor} ${network.textColor} border-0`}>\n        {network.displayName}\n      </Badge>\n    );\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"success\":\n        return (\n          <Badge variant=\"default\" className=\"bg-green-500\">\n            <CheckCircle className=\"h-3 w-3 mr-1\" />\n            Success\n          </Badge>\n        );\n      case \"pending\":\n      case \"processing\":\n        return (\n          <Badge variant=\"secondary\">\n            <Clock className=\"h-3 w-3 mr-1\" />\n            {status === \"processing\" ? \"Processing\" : \"Pending\"}\n          </Badge>\n        );\n      case \"failed\":\n        return (\n          <Badge variant=\"destructive\">\n            <XCircle className=\"h-3 w-3 mr-1\" />\n            Failed\n          </Badge>\n        );\n      case \"refunded\":\n        return (\n          <Badge variant=\"outline\">\n            Refunded\n          </Badge>\n        );\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  const getScheduleStatusBadge = (status: string) => {\n    switch (status) {\n      case \"active\":\n        return (\n          <Badge variant=\"default\" className=\"bg-green-500\">\n            <Play className=\"h-3 w-3 mr-1\" />\n            Active\n          </Badge>\n        );\n      case \"paused\":\n        return (\n          <Badge variant=\"secondary\">\n            <Pause className=\"h-3 w-3 mr-1\" />\n            Paused\n          </Badge>\n        );\n      case \"cancelled\":\n        return (\n          <Badge variant=\"destructive\">\n            <XCircle className=\"h-3 w-3 mr-1\" />\n            Cancelled\n          </Badge>\n        );\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  const getGiftStatusBadge = (status: string) => {\n    switch (status) {\n      case \"pending\":\n        return (\n          <Badge variant=\"secondary\">\n            <Clock className=\"h-3 w-3 mr-1\" />\n            Pending\n          </Badge>\n        );\n      case \"accepted\":\n      case \"claimed\":\n        return (\n          <Badge variant=\"default\" className=\"bg-green-500\">\n            <CheckCircle className=\"h-3 w-3 mr-1\" />\n            Claimed\n          </Badge>\n        );\n      case \"expired\":\n        return (\n          <Badge variant=\"destructive\">\n            <XCircle className=\"h-3 w-3 mr-1\" />\n            Expired\n          </Badge>\n        );\n      case \"cancelled\":\n        return (\n          <Badge variant=\"outline\">\n            Cancelled\n          </Badge>\n        );\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  const handlePhoneChange = (value: string) => {\n    const numericValue = value.replace(/\\D/g, \"\").slice(0, 13);\n    setPhoneNumber(numericValue);\n  };\n\n  const getFrequencyLabel = (schedule: ScheduledVtuPurchase) => {\n    switch (schedule.frequency) {\n      case \"daily\":\n        return `Daily at ${schedule.timeOfDay}`;\n      case \"weekly\":\n        return `${DAYS_OF_WEEK.find(d => d.value === schedule.dayOfWeek)?.label || \"\"} at ${schedule.timeOfDay}`;\n      case \"monthly\":\n        return `${schedule.dayOfMonth}${getDaySuffix(schedule.dayOfMonth || 1)} of each month at ${schedule.timeOfDay}`;\n      default:\n        return schedule.frequency;\n    }\n  };\n\n  const getDaySuffix = (day: number) => {\n    if (day >= 11 && day <= 13) return \"th\";\n    switch (day % 10) {\n      case 1: return \"st\";\n      case 2: return \"nd\";\n      case 3: return \"rd\";\n      default: return \"th\";\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 max-w-4xl\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold mb-2\">VTU Services</h1>\n        <p className=\"text-muted-foreground\">Purchase data bundles and airtime for any network</p>\n      </div>\n\n      <Card className=\"mb-8 bg-gradient-to-br from-primary/20 to-primary/5\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex flex-col sm:flex-row items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"rounded-full bg-primary/10 p-3\">\n                <Wallet className=\"h-6 w-6 text-primary\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Wallet Balance</p>\n                {walletLoading ? (\n                  <Skeleton className=\"h-8 w-24\" />\n                ) : (\n                  <h2 className=\"text-2xl font-bold text-primary\" data-testid=\"text-wallet-balance\">\n                    ₦{walletBalance.toLocaleString()}\n                  </h2>\n                )}\n              </div>\n            </div>\n            <Link href=\"/wallet\">\n              <Button variant=\"outline\" data-testid=\"link-fund-wallet\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Fund Wallet\n              </Button>\n            </Link>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Tabs value={serviceType} onValueChange={(v) => setServiceType(v as ServiceType)} className=\"mb-8\">\n        <TabsList className=\"grid w-full grid-cols-5 mb-6\">\n          <TabsTrigger value=\"data\" data-testid=\"tab-service-data\" className=\"flex items-center gap-2\">\n            <Signal className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Buy</span> Data\n          </TabsTrigger>\n          <TabsTrigger value=\"airtime\" data-testid=\"tab-service-airtime\" className=\"flex items-center gap-2\">\n            <Phone className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Buy</span> Airtime\n          </TabsTrigger>\n          <TabsTrigger value=\"bills\" data-testid=\"tab-service-bills\" className=\"flex items-center gap-2\">\n            <Receipt className=\"h-4 w-4\" />\n            Bills\n          </TabsTrigger>\n          <TabsTrigger value=\"schedule\" data-testid=\"tab-service-schedule\" className=\"flex items-center gap-2\">\n            <Calendar className=\"h-4 w-4\" />\n            Schedule\n          </TabsTrigger>\n          <TabsTrigger value=\"gift\" data-testid=\"tab-service-gift\" className=\"flex items-center gap-2\">\n            <Gift className=\"h-4 w-4\" />\n            Gift\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"data\">\n          <Card className=\"mb-8\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Signal className=\"h-5 w-5\" />\n                Select Network & Plan\n              </CardTitle>\n              <CardDescription>Choose your preferred network and data plan</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Tabs value={selectedNetwork} onValueChange={(v) => {\n                setSelectedNetwork(v as NetworkType);\n                setSelectedPlanId(null);\n                setSearchQuery(\"\");\n              }}>\n                <TabsList className=\"grid w-full grid-cols-4 mb-6\">\n                  {NETWORKS.map((network) => (\n                    <TabsTrigger \n                      key={network.id} \n                      value={network.id}\n                      data-testid={`tab-network-${network.id}`}\n                      className=\"data-[state=active]:bg-primary data-[state=active]:text-primary-foreground\"\n                    >\n                      <span className={`w-2 h-2 rounded-full ${network.color} mr-2`} />\n                      {network.displayName}\n                    </TabsTrigger>\n                  ))}\n                </TabsList>\n\n                <div className=\"mb-4\">\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"Search plans (e.g., 1GB, 30 days, 500)\"\n                      value={searchQuery}\n                      onChange={(e) => setSearchQuery(e.target.value)}\n                      className=\"pl-10\"\n                      data-testid=\"input-search-plans\"\n                    />\n                  </div>\n                  {searchQuery && (\n                    <p className=\"text-sm text-muted-foreground mt-2\">\n                      Showing {filteredPlans.length} of {plans?.length || 0} plans\n                    </p>\n                  )}\n                </div>\n\n                {NETWORKS.map((network) => (\n                  <TabsContent key={network.id} value={network.id}>\n                    {plansLoading ? (\n                      <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4\">\n                        {[...Array(6)].map((_, i) => (\n                          <Skeleton key={i} className=\"h-28\" />\n                        ))}\n                      </div>\n                    ) : filteredPlans && filteredPlans.length > 0 ? (\n                      <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[400px] overflow-y-auto pr-2\">\n                        {filteredPlans.map((plan) => (\n                          <div\n                            key={plan.id}\n                            onClick={() => setSelectedPlanId(plan.id)}\n                            className={`p-4 rounded-md border-2 cursor-pointer transition-all ${\n                              selectedPlanId === plan.id\n                                ? \"border-primary bg-primary/5\"\n                                : \"border-border hover-elevate\"\n                            }`}\n                            data-testid={`card-plan-${plan.id}`}\n                          >\n                            <div className=\"text-lg font-bold\">{plan.dataAmount}</div>\n                            <div className=\"text-sm text-muted-foreground\">{plan.validity}</div>\n                            <div className=\"text-lg font-semibold text-primary mt-2\">\n                              ₦{parseFloat(plan.sellingPrice).toLocaleString()}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"text-center py-12 text-muted-foreground\">\n                        <Signal className=\"h-12 w-12 mx-auto mb-4 opacity-30\" />\n                        <p>{searchQuery ? \"No plans match your search.\" : \"No plans available for this network.\"}</p>\n                        {searchQuery && (\n                          <Button \n                            variant=\"ghost\" \n                            onClick={() => setSearchQuery(\"\")}\n                            className=\"mt-2\"\n                          >\n                            Clear search\n                          </Button>\n                        )}\n                      </div>\n                    )}\n                  </TabsContent>\n                ))}\n              </Tabs>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"airtime\">\n          <Card className=\"mb-8\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Zap className=\"h-5 w-5\" />\n                Select Airtime Amount\n              </CardTitle>\n              <CardDescription>Choose or enter the airtime amount</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Tabs value={selectedNetwork} onValueChange={(v) => setSelectedNetwork(v as NetworkType)}>\n                <TabsList className=\"grid w-full grid-cols-4 mb-6\">\n                  {NETWORKS.map((network) => (\n                    <TabsTrigger \n                      key={network.id} \n                      value={network.id}\n                      data-testid={`tab-airtime-network-${network.id}`}\n                      className=\"data-[state=active]:bg-primary data-[state=active]:text-primary-foreground\"\n                    >\n                      <span className={`w-2 h-2 rounded-full ${network.color} mr-2`} />\n                      {network.displayName}\n                    </TabsTrigger>\n                  ))}\n                </TabsList>\n              </Tabs>\n\n              <div className=\"grid grid-cols-4 gap-3 mb-6\">\n                {AIRTIME_AMOUNTS.map((amount) => (\n                  <div\n                    key={amount}\n                    onClick={() => {\n                      setSelectedAirtimeAmount(amount);\n                      setCustomAirtimeAmount(\"\");\n                    }}\n                    className={`p-3 rounded-md border-2 cursor-pointer transition-all text-center ${\n                      selectedAirtimeAmount === amount\n                        ? \"border-primary bg-primary/5\"\n                        : \"border-border hover-elevate\"\n                    }`}\n                    data-testid={`card-airtime-${amount}`}\n                  >\n                    <div className=\"font-bold\">₦{amount.toLocaleString()}</div>\n                  </div>\n                ))}\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"custom-amount\">Or enter custom amount</Label>\n                <Input\n                  id=\"custom-amount\"\n                  type=\"number\"\n                  placeholder=\"Enter amount (50 - 50,000)\"\n                  value={customAirtimeAmount}\n                  onChange={(e) => {\n                    setCustomAirtimeAmount(e.target.value);\n                    setSelectedAirtimeAmount(null);\n                  }}\n                  min={50}\n                  max={50000}\n                  data-testid=\"input-custom-airtime\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Minimum: ₦50 | Maximum: ₦50,000\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"bills\">\n          <Card className=\"mb-8\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Receipt className=\"h-5 w-5\" />\n                Pay Bills\n              </CardTitle>\n              <CardDescription>Pay cable TV and electricity bills</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"flex gap-2\">\n                <Button\n                  type=\"button\"\n                  variant={billType === \"cable\" ? \"default\" : \"outline\"}\n                  onClick={() => handleBillTypeChange(\"cable\")}\n                  className=\"flex-1\"\n                  data-testid=\"button-bill-type-cable\"\n                >\n                  <Tv className=\"h-4 w-4 mr-2\" />\n                  Cable TV\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant={billType === \"electricity\" ? \"default\" : \"outline\"}\n                  onClick={() => handleBillTypeChange(\"electricity\")}\n                  className=\"flex-1\"\n                  data-testid=\"button-bill-type-electricity\"\n                >\n                  <Lightbulb className=\"h-4 w-4 mr-2\" />\n                  Electricity\n                </Button>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Service Provider</Label>\n                <Select \n                  value={selectedBillService} \n                  onValueChange={(v) => handleBillServiceChange(v as BillServiceType)}\n                >\n                  <SelectTrigger data-testid=\"select-bill-service\">\n                    <SelectValue placeholder=\"Select provider\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {billType === \"cable\" ? (\n                      CABLE_SERVICES.map(s => (\n                        <SelectItem key={s.id} value={s.id}>\n                          <span className=\"flex items-center gap-2\">\n                            <Tv className=\"h-4 w-4\" />\n                            {s.name}\n                          </span>\n                        </SelectItem>\n                      ))\n                    ) : (\n                      ELECTRICITY_SERVICES.map(s => (\n                        <SelectItem key={s.id} value={s.id}>\n                          <span className=\"flex items-center gap-2\">\n                            <Lightbulb className=\"h-4 w-4\" />\n                            {s.name}\n                          </span>\n                        </SelectItem>\n                      ))\n                    )}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>{billType === \"cable\" ? \"Decoder Number\" : \"Meter Number\"}</Label>\n                <div className=\"flex gap-2\">\n                  <Input\n                    placeholder={billType === \"cable\" ? \"Enter decoder number\" : \"Enter meter number\"}\n                    value={billCustomerId}\n                    onChange={(e) => {\n                      setBillCustomerId(e.target.value);\n                      setBillCustomerValidated(false);\n                      setBillCustomerName(null);\n                    }}\n                    className=\"flex-1\"\n                    data-testid=\"input-bill-customer-id\"\n                  />\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={handleValidateCustomer}\n                    disabled={!billCustomerId.trim() || validateBillCustomerMutation.isPending}\n                    data-testid=\"button-validate-customer\"\n                  >\n                    {validateBillCustomerMutation.isPending ? (\n                      <Loader2 className=\"h-4 w-4 animate-spin\" />\n                    ) : (\n                      \"Verify\"\n                    )}\n                  </Button>\n                </div>\n                {billCustomerValidated && billCustomerName && (\n                  <div className=\"flex items-center gap-2 text-sm text-green-600 dark:text-green-400\">\n                    <CheckCircle className=\"h-4 w-4\" />\n                    Customer: {billCustomerName}\n                  </div>\n                )}\n              </div>\n\n              {billType === \"cable\" ? (\n                <div className=\"space-y-2\">\n                  <Label>Select Package</Label>\n                  {loadingBillPackages ? (\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\n                      {[...Array(4)].map((_, i) => (\n                        <Skeleton key={i} className=\"h-16\" />\n                      ))}\n                    </div>\n                  ) : billPackages.length > 0 ? (\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2 max-h-[300px] overflow-y-auto\">\n                      {billPackages.map((pkg) => (\n                        <div\n                          key={pkg.code}\n                          onClick={() => setSelectedBillPackage(pkg)}\n                          className={`p-3 rounded-md border-2 cursor-pointer transition-all ${\n                            selectedBillPackage?.code === pkg.code\n                              ? \"border-primary bg-primary/5\"\n                              : \"border-border hover-elevate\"\n                          }`}\n                          data-testid={`card-bill-package-${pkg.code}`}\n                        >\n                          <div className=\"font-medium\">{pkg.name}</div>\n                          <div className=\"text-lg font-bold text-primary\">\n                            ₦{pkg.amount.toLocaleString()}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      <Tv className=\"h-8 w-8 mx-auto mb-2 opacity-30\" />\n                      <p>No packages available. Select a provider first.</p>\n                    </div>\n                  )}\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  <Label>Amount (min ₦500)</Label>\n                  <Input\n                    type=\"number\"\n                    placeholder=\"Enter amount\"\n                    value={billElectricityAmount}\n                    onChange={(e) => setBillElectricityAmount(e.target.value)}\n                    min={500}\n                    data-testid=\"input-bill-electricity-amount\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Minimum amount: ₦500\n                  </p>\n                </div>\n              )}\n\n              <Button\n                onClick={handleBillPayment}\n                disabled={!canPayBill || payBillMutation.isPending}\n                className=\"w-full\"\n                data-testid=\"button-pay-bill\"\n              >\n                {payBillMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    Processing...\n                  </>\n                ) : (\n                  <>\n                    Pay Bill\n                    {billType === \"cable\" && selectedBillPackage && ` - ₦${selectedBillPackage.amount.toLocaleString()}`}\n                    {billType === \"electricity\" && billElectricityAmount && ` - ₦${parseFloat(billElectricityAmount).toLocaleString()}`}\n                  </>\n                )}\n              </Button>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Clock className=\"h-5 w-5\" />\n                Bill Payment History\n              </CardTitle>\n              <CardDescription>Your recent bill payments</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {billPaymentsLoading ? (\n                <div className=\"space-y-4\">\n                  {[...Array(3)].map((_, i) => (\n                    <Skeleton key={i} className=\"h-16\" />\n                  ))}\n                </div>\n              ) : billPayments && billPayments.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {billPayments.map((payment) => (\n                    <div\n                      key={payment.id}\n                      className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-2 p-4 rounded-md bg-muted/30\"\n                      data-testid={`bill-payment-${payment.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"p-2 rounded-full bg-primary/10\">\n                          {payment.billType === \"cable\" ? (\n                            <Tv className=\"h-4 w-4 text-primary\" />\n                          ) : (\n                            <Lightbulb className=\"h-4 w-4 text-primary\" />\n                          )}\n                        </div>\n                        <div>\n                          <div className=\"font-medium flex flex-wrap items-center gap-2\">\n                            {getBillServiceName(payment.serviceType as BillServiceType)}\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              {payment.billType === \"cable\" ? \"Cable\" : \"Electricity\"}\n                            </Badge>\n                          </div>\n                          <div className=\"text-sm text-muted-foreground\">\n                            {payment.customerId}\n                            {payment.token && (\n                              <span className=\"ml-2 text-green-600 dark:text-green-400\">\n                                Token: {payment.token}\n                              </span>\n                            )}\n                          </div>\n                          <div className=\"text-xs text-muted-foreground\">\n                            {payment.createdAt && format(new Date(payment.createdAt), \"MMM d, yyyy 'at' h:mm a\")}\n                          </div>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-4 sm:text-right\">\n                        <div>\n                          <div className=\"font-bold\">₦{parseFloat(payment.amount).toLocaleString()}</div>\n                        </div>\n                        {getStatusBadge(payment.status)}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-12 text-muted-foreground\">\n                  <Receipt className=\"h-12 w-12 mx-auto mb-4 opacity-30\" />\n                  <p>No bill payments yet.</p>\n                  <p className=\"text-sm\">Your bill payment history will appear here.</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"schedule\">\n          <Card className=\"mb-8\">\n            <CardHeader>\n              <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Calendar className=\"h-5 w-5\" />\n                    Scheduled Purchases\n                  </CardTitle>\n                  <CardDescription>Automate your data and airtime purchases</CardDescription>\n                </div>\n                <Dialog open={showScheduleDialog} onOpenChange={setShowScheduleDialog}>\n                  <DialogTrigger asChild>\n                    <Button data-testid=\"button-create-schedule\">\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      New Schedule\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"max-w-lg max-h-[90vh] overflow-y-auto\">\n                    <DialogHeader>\n                      <DialogTitle>Create Scheduled Purchase</DialogTitle>\n                      <DialogDescription>Set up automatic data or airtime purchases</DialogDescription>\n                    </DialogHeader>\n                    <div className=\"space-y-4 py-4\">\n                      <div className=\"space-y-2\">\n                        <Label>Service Type</Label>\n                        <div className=\"flex gap-2\">\n                          <Button\n                            type=\"button\"\n                            variant={scheduleServiceType === \"data\" ? \"default\" : \"outline\"}\n                            onClick={() => setScheduleServiceType(\"data\")}\n                            className=\"flex-1\"\n                            data-testid=\"button-schedule-type-data\"\n                          >\n                            <Signal className=\"h-4 w-4 mr-2\" />\n                            Data\n                          </Button>\n                          <Button\n                            type=\"button\"\n                            variant={scheduleServiceType === \"airtime\" ? \"default\" : \"outline\"}\n                            onClick={() => setScheduleServiceType(\"airtime\")}\n                            className=\"flex-1\"\n                            data-testid=\"button-schedule-type-airtime\"\n                          >\n                            <Phone className=\"h-4 w-4 mr-2\" />\n                            Airtime\n                          </Button>\n                        </div>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label>Network</Label>\n                        <Select value={scheduleNetwork} onValueChange={(v) => {\n                          setScheduleNetwork(v as NetworkType);\n                          setSchedulePlanId(null);\n                        }}>\n                          <SelectTrigger data-testid=\"select-schedule-network\">\n                            <SelectValue placeholder=\"Select network\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {NETWORKS.map(n => (\n                              <SelectItem key={n.id} value={n.id}>\n                                <span className=\"flex items-center gap-2\">\n                                  <span className={`w-2 h-2 rounded-full ${n.color}`} />\n                                  {n.displayName}\n                                </span>\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label>Phone Number</Label>\n                        <Input\n                          placeholder=\"08012345678\"\n                          value={schedulePhoneNumber}\n                          onChange={(e) => setSchedulePhoneNumber(e.target.value.replace(/\\D/g, \"\").slice(0, 13))}\n                          data-testid=\"input-schedule-phone\"\n                        />\n                        {schedulePhoneValidation.message && (\n                          <p className=\"text-sm text-red-500\">{schedulePhoneValidation.message}</p>\n                        )}\n                        {beneficiaries && beneficiaries.length > 0 && (\n                          <div className=\"flex flex-wrap gap-1 mt-2\">\n                            {beneficiaries.slice(0, 3).map((b) => (\n                              <Button\n                                key={b.id}\n                                type=\"button\"\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => {\n                                  setSchedulePhoneNumber(b.phoneNumber);\n                                  setScheduleNetwork(b.network as NetworkType);\n                                }}\n                                className=\"text-xs\"\n                                data-testid={`button-schedule-beneficiary-${b.id}`}\n                              >\n                                {b.name}\n                              </Button>\n                            ))}\n                          </div>\n                        )}\n                      </div>\n\n                      {scheduleServiceType === \"data\" ? (\n                        <div className=\"space-y-2\">\n                          <Label>Data Plan</Label>\n                          <Select value={schedulePlanId || \"\"} onValueChange={setSchedulePlanId}>\n                            <SelectTrigger data-testid=\"select-schedule-plan\">\n                              <SelectValue placeholder=\"Select plan\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {schedulePlans?.map(plan => (\n                                <SelectItem key={plan.id} value={plan.id}>\n                                  {plan.dataAmount} - {plan.validity} (₦{parseFloat(plan.sellingPrice).toLocaleString()})\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                      ) : (\n                        <div className=\"space-y-2\">\n                          <Label>Airtime Amount</Label>\n                          <Input\n                            type=\"number\"\n                            placeholder=\"Enter amount (50 - 50,000)\"\n                            value={scheduleAirtimeAmount}\n                            onChange={(e) => setScheduleAirtimeAmount(e.target.value)}\n                            min={50}\n                            max={50000}\n                            data-testid=\"input-schedule-airtime-amount\"\n                          />\n                        </div>\n                      )}\n\n                      <div className=\"space-y-2\">\n                        <Label>Frequency</Label>\n                        <Select value={scheduleFrequency} onValueChange={(v) => setScheduleFrequency(v as ScheduleFrequency)}>\n                          <SelectTrigger data-testid=\"select-schedule-frequency\">\n                            <SelectValue placeholder=\"Select frequency\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"daily\">Daily</SelectItem>\n                            <SelectItem value=\"weekly\">Weekly</SelectItem>\n                            <SelectItem value=\"monthly\">Monthly</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      {scheduleFrequency === \"weekly\" && (\n                        <div className=\"space-y-2\">\n                          <Label>Day of Week</Label>\n                          <Select value={scheduleDayOfWeek.toString()} onValueChange={(v) => setScheduleDayOfWeek(parseInt(v))}>\n                            <SelectTrigger data-testid=\"select-schedule-day-of-week\">\n                              <SelectValue placeholder=\"Select day\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {DAYS_OF_WEEK.map(d => (\n                                <SelectItem key={d.value} value={d.value.toString()}>{d.label}</SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                      )}\n\n                      {scheduleFrequency === \"monthly\" && (\n                        <div className=\"space-y-2\">\n                          <Label>Day of Month</Label>\n                          <Select value={scheduleDayOfMonth.toString()} onValueChange={(v) => setScheduleDayOfMonth(parseInt(v))}>\n                            <SelectTrigger data-testid=\"select-schedule-day-of-month\">\n                              <SelectValue placeholder=\"Select day\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {Array.from({ length: 28 }, (_, i) => i + 1).map(d => (\n                                <SelectItem key={d} value={d.toString()}>{d}{getDaySuffix(d)}</SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                      )}\n\n                      <div className=\"space-y-2\">\n                        <Label>Time</Label>\n                        <Input\n                          type=\"time\"\n                          value={scheduleTimeOfDay}\n                          onChange={(e) => setScheduleTimeOfDay(e.target.value)}\n                          data-testid=\"input-schedule-time\"\n                        />\n                      </div>\n                    </div>\n                    <DialogFooter>\n                      <Button\n                        onClick={handleCreateSchedule}\n                        disabled={!canCreateSchedule || createScheduleMutation.isPending}\n                        data-testid=\"button-confirm-create-schedule\"\n                      >\n                        {createScheduleMutation.isPending ? (\n                          <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n                        ) : (\n                          <Calendar className=\"h-4 w-4 mr-2\" />\n                        )}\n                        Create Schedule\n                      </Button>\n                    </DialogFooter>\n                  </DialogContent>\n                </Dialog>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {schedulesLoading ? (\n                <div className=\"space-y-4\">\n                  {[...Array(3)].map((_, i) => (\n                    <Skeleton key={i} className=\"h-20\" />\n                  ))}\n                </div>\n              ) : scheduledPurchases && scheduledPurchases.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {scheduledPurchases.map((schedule) => (\n                    <div\n                      key={schedule.id}\n                      className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-3 p-4 rounded-md bg-muted/30\"\n                      data-testid={`schedule-${schedule.id}`}\n                    >\n                      <div className=\"flex items-start gap-3\">\n                        <div className={`p-2 rounded-full ${NETWORKS.find(n => n.id === schedule.network)?.bgColor || \"bg-muted\"}`}>\n                          {schedule.serviceType === \"data\" ? (\n                            <Signal className={`h-4 w-4 ${NETWORKS.find(n => n.id === schedule.network)?.textColor || \"text-muted-foreground\"}`} />\n                          ) : (\n                            <Phone className={`h-4 w-4 ${NETWORKS.find(n => n.id === schedule.network)?.textColor || \"text-muted-foreground\"}`} />\n                          )}\n                        </div>\n                        <div>\n                          <div className=\"font-medium flex flex-wrap items-center gap-2\">\n                            {schedule.phoneNumber}\n                            {getNetworkBadge(schedule.network)}\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              {schedule.serviceType === \"data\" ? \"Data\" : \"Airtime\"}\n                            </Badge>\n                          </div>\n                          <div className=\"text-sm text-muted-foreground mt-1\">\n                            {getFrequencyLabel(schedule)}\n                          </div>\n                          {schedule.nextRunAt && (\n                            <div className=\"text-xs text-muted-foreground mt-1\">\n                              Next: {format(new Date(schedule.nextRunAt), \"MMM d, yyyy 'at' h:mm a\")}\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        {schedule.amount && (\n                          <span className=\"font-bold\">₦{parseFloat(schedule.amount).toLocaleString()}</span>\n                        )}\n                        {getScheduleStatusBadge(schedule.status || \"active\")}\n                        <div className=\"flex items-center gap-1\">\n                          <Switch\n                            checked={schedule.status === \"active\"}\n                            onCheckedChange={(checked) => {\n                              updateScheduleStatusMutation.mutate({\n                                id: schedule.id,\n                                status: checked ? \"active\" : \"paused\",\n                              });\n                            }}\n                            data-testid={`switch-schedule-${schedule.id}`}\n                          />\n                          <Button\n                            size=\"icon\"\n                            variant=\"ghost\"\n                            onClick={() => {\n                              if (confirm(\"Are you sure you want to delete this schedule?\")) {\n                                deleteScheduleMutation.mutate(schedule.id);\n                              }\n                            }}\n                            data-testid={`button-delete-schedule-${schedule.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-12 text-muted-foreground\">\n                  <Calendar className=\"h-12 w-12 mx-auto mb-4 opacity-30\" />\n                  <p>No scheduled purchases yet.</p>\n                  <p className=\"text-sm\">Create a schedule to automate your purchases.</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"gift\">\n          <Card className=\"mb-8\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Gift className=\"h-5 w-5\" />\n                Gift Data\n              </CardTitle>\n              <CardDescription>Send data as a gift or claim received gifts</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Tabs value={giftTab} onValueChange={(v) => setGiftTab(v as \"send\" | \"sent\" | \"received\")}>\n                <TabsList className=\"grid w-full grid-cols-3 mb-6\">\n                  <TabsTrigger value=\"send\" data-testid=\"tab-gift-send\" className=\"flex items-center gap-2\">\n                    <Send className=\"h-4 w-4\" />\n                    Send Gift\n                  </TabsTrigger>\n                  <TabsTrigger value=\"sent\" data-testid=\"tab-gift-sent\" className=\"flex items-center gap-2\">\n                    <Sparkles className=\"h-4 w-4\" />\n                    Sent Gifts\n                  </TabsTrigger>\n                  <TabsTrigger value=\"received\" data-testid=\"tab-gift-received\" className=\"flex items-center gap-2\">\n                    <Download className=\"h-4 w-4\" />\n                    Received\n                  </TabsTrigger>\n                </TabsList>\n\n                <TabsContent value=\"send\">\n                  <div className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Recipient Phone Number</Label>\n                      <Input\n                        placeholder=\"08012345678\"\n                        value={giftRecipientPhone}\n                        onChange={(e) => setGiftRecipientPhone(e.target.value.replace(/\\D/g, \"\").slice(0, 13))}\n                        data-testid=\"input-gift-recipient-phone\"\n                      />\n                      {giftPhoneValidation.message && (\n                        <p className=\"text-sm text-red-500\">{giftPhoneValidation.message}</p>\n                      )}\n                      {beneficiaries && beneficiaries.length > 0 && (\n                        <div className=\"flex flex-wrap gap-1 mt-2\">\n                          {beneficiaries.slice(0, 4).map((b) => (\n                            <Button\n                              key={b.id}\n                              type=\"button\"\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => {\n                                setGiftRecipientPhone(b.phoneNumber);\n                                setGiftNetwork(b.network as NetworkType);\n                              }}\n                              className=\"text-xs\"\n                              data-testid={`button-gift-beneficiary-${b.id}`}\n                            >\n                              {b.name}\n                            </Button>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Network</Label>\n                      <Select value={giftNetwork} onValueChange={(v) => {\n                        setGiftNetwork(v as NetworkType);\n                        setGiftPlanId(null);\n                      }}>\n                        <SelectTrigger data-testid=\"select-gift-network\">\n                          <SelectValue placeholder=\"Select network\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {NETWORKS.map(n => (\n                            <SelectItem key={n.id} value={n.id}>\n                              <span className=\"flex items-center gap-2\">\n                                <span className={`w-2 h-2 rounded-full ${n.color}`} />\n                                {n.displayName}\n                              </span>\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Data Plan</Label>\n                      <Select value={giftPlanId || \"\"} onValueChange={setGiftPlanId}>\n                        <SelectTrigger data-testid=\"select-gift-plan\">\n                          <SelectValue placeholder=\"Select plan to gift\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {giftPlans?.map(plan => (\n                            <SelectItem key={plan.id} value={plan.id}>\n                              {plan.dataAmount} - {plan.validity} (₦{parseFloat(plan.sellingPrice).toLocaleString()})\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Message (Optional)</Label>\n                      <Textarea\n                        placeholder=\"Add a personal message...\"\n                        value={giftMessage}\n                        onChange={(e) => setGiftMessage(e.target.value)}\n                        maxLength={200}\n                        className=\"resize-none\"\n                        data-testid=\"input-gift-message\"\n                      />\n                      <p className=\"text-xs text-muted-foreground text-right\">{giftMessage.length}/200</p>\n                    </div>\n\n                    {selectedGiftPlan && (\n                      <div className=\"p-4 rounded-md bg-muted/50 space-y-2\">\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-muted-foreground\">Plan:</span>\n                          <span className=\"font-medium\">{selectedGiftPlan.dataAmount} - {selectedGiftPlan.validity}</span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-muted-foreground\">Network:</span>\n                          {getNetworkBadge(giftNetwork)}\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-muted-foreground\">Amount:</span>\n                          <span className=\"font-bold text-primary\">₦{parseFloat(selectedGiftPlan.sellingPrice).toLocaleString()}</span>\n                        </div>\n                      </div>\n                    )}\n\n                    {selectedGiftPlan && walletBalance < parseFloat(selectedGiftPlan.sellingPrice) && (\n                      <div className=\"p-4 rounded-md bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 flex items-center gap-3\">\n                        <AlertCircle className=\"h-5 w-5 flex-shrink-0\" />\n                        <div>\n                          <p className=\"font-medium\">Insufficient Balance</p>\n                          <p className=\"text-sm\">You need ₦{(parseFloat(selectedGiftPlan.sellingPrice) - walletBalance).toLocaleString()} more to send this gift.</p>\n                        </div>\n                      </div>\n                    )}\n\n                    <Button\n                      onClick={handleSendGift}\n                      disabled={!canSendGift || sendGiftMutation.isPending}\n                      className=\"w-full\"\n                      data-testid=\"button-send-gift\"\n                    >\n                      {sendGiftMutation.isPending ? (\n                        <>\n                          <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                          Sending...\n                        </>\n                      ) : (\n                        <>\n                          <Gift className=\"h-4 w-4 mr-2\" />\n                          Send Gift\n                          {selectedGiftPlan && ` - ₦${parseFloat(selectedGiftPlan.sellingPrice).toLocaleString()}`}\n                        </>\n                      )}\n                    </Button>\n                  </div>\n                </TabsContent>\n\n                <TabsContent value=\"sent\">\n                  {sentGiftsLoading ? (\n                    <div className=\"space-y-4\">\n                      {[...Array(3)].map((_, i) => (\n                        <Skeleton key={i} className=\"h-20\" />\n                      ))}\n                    </div>\n                  ) : sentGifts && sentGifts.length > 0 ? (\n                    <div className=\"space-y-4\">\n                      {sentGifts.map((gift) => (\n                        <div\n                          key={gift.id}\n                          className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-3 p-4 rounded-md bg-muted/30\"\n                          data-testid={`sent-gift-${gift.id}`}\n                        >\n                          <div className=\"flex items-start gap-3\">\n                            <div className={`p-2 rounded-full ${NETWORKS.find(n => n.id === gift.network)?.bgColor || \"bg-muted\"}`}>\n                              <Gift className={`h-4 w-4 ${NETWORKS.find(n => n.id === gift.network)?.textColor || \"text-muted-foreground\"}`} />\n                            </div>\n                            <div>\n                              <div className=\"font-medium flex flex-wrap items-center gap-2\">\n                                To: {gift.recipientPhone}\n                                {getNetworkBadge(gift.network)}\n                              </div>\n                              {gift.message && (\n                                <p className=\"text-sm text-muted-foreground mt-1 italic\">\"{gift.message}\"</p>\n                              )}\n                              <div className=\"text-xs text-muted-foreground mt-1\">\n                                {gift.createdAt && format(new Date(gift.createdAt), \"MMM d, yyyy 'at' h:mm a\")}\n                              </div>\n                            </div>\n                          </div>\n                          <div className=\"flex flex-col sm:items-end gap-2\">\n                            {getGiftStatusBadge(gift.status || \"pending\")}\n                            {gift.giftCode && (\n                              <div className=\"flex items-center gap-2\">\n                                <code className=\"text-xs bg-muted px-2 py-1 rounded\">{gift.giftCode}</code>\n                                <Button\n                                  size=\"icon\"\n                                  variant=\"ghost\"\n                                  onClick={() => handleCopyGiftCode(gift.giftCode!)}\n                                  data-testid={`button-copy-gift-code-${gift.id}`}\n                                >\n                                  <Copy className=\"h-3 w-3\" />\n                                </Button>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-12 text-muted-foreground\">\n                      <Sparkles className=\"h-12 w-12 mx-auto mb-4 opacity-30\" />\n                      <p>No gifts sent yet.</p>\n                      <p className=\"text-sm\">Send your first data gift to someone special!</p>\n                    </div>\n                  )}\n                </TabsContent>\n\n                <TabsContent value=\"received\">\n                  {receivedGiftsLoading ? (\n                    <div className=\"space-y-4\">\n                      {[...Array(3)].map((_, i) => (\n                        <Skeleton key={i} className=\"h-20\" />\n                      ))}\n                    </div>\n                  ) : receivedGifts && receivedGifts.length > 0 ? (\n                    <div className=\"space-y-4\">\n                      {receivedGifts.map((gift) => (\n                        <div\n                          key={gift.id}\n                          className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-3 p-4 rounded-md bg-muted/30\"\n                          data-testid={`received-gift-${gift.id}`}\n                        >\n                          <div className=\"flex items-start gap-3\">\n                            <div className={`p-2 rounded-full ${NETWORKS.find(n => n.id === gift.network)?.bgColor || \"bg-muted\"}`}>\n                              <Gift className={`h-4 w-4 ${NETWORKS.find(n => n.id === gift.network)?.textColor || \"text-muted-foreground\"}`} />\n                            </div>\n                            <div>\n                              <div className=\"font-medium flex flex-wrap items-center gap-2\">\n                                Data Gift\n                                {getNetworkBadge(gift.network)}\n                              </div>\n                              {gift.message && (\n                                <p className=\"text-sm text-muted-foreground mt-1 italic\">\"{gift.message}\"</p>\n                              )}\n                              <div className=\"text-xs text-muted-foreground mt-1\">\n                                {gift.createdAt && format(new Date(gift.createdAt), \"MMM d, yyyy 'at' h:mm a\")}\n                              </div>\n                              {gift.expiresAt && gift.status === \"pending\" && (\n                                <div className=\"text-xs text-amber-600 dark:text-amber-400 mt-1\">\n                                  Expires: {format(new Date(gift.expiresAt), \"MMM d, yyyy\")}\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                          <div className=\"flex flex-col sm:items-end gap-2\">\n                            {getGiftStatusBadge(gift.status || \"pending\")}\n                            {gift.status === \"pending\" && gift.giftCode && (\n                              <Button\n                                size=\"sm\"\n                                onClick={() => claimGiftMutation.mutate(gift.giftCode!)}\n                                disabled={claimGiftMutation.isPending}\n                                data-testid={`button-claim-gift-${gift.id}`}\n                              >\n                                {claimGiftMutation.isPending ? (\n                                  <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n                                ) : (\n                                  <Download className=\"h-4 w-4 mr-2\" />\n                                )}\n                                Claim Gift\n                              </Button>\n                            )}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-12 text-muted-foreground\">\n                      <Download className=\"h-12 w-12 mx-auto mb-4 opacity-30\" />\n                      <p>No gifts received yet.</p>\n                      <p className=\"text-sm\">Gifts you receive will appear here.</p>\n                    </div>\n                  )}\n                </TabsContent>\n              </Tabs>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      {/* Saved Beneficiaries Quick Select - Only show for data and airtime tabs */}\n      {(serviceType === \"data\" || serviceType === \"airtime\") && beneficiaries && beneficiaries.length > 0 && (\n        <Card className=\"mb-4\">\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm flex items-center gap-2\">\n              <Users className=\"h-4 w-4\" />\n              Quick Select\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex flex-wrap gap-2\">\n              {beneficiaries.slice(0, 5).map((b) => (\n                <Button\n                  key={b.id}\n                  variant={selectedBeneficiary?.id === b.id ? \"default\" : \"outline\"}\n                  size=\"sm\"\n                  onClick={() => handleSelectBeneficiary(b)}\n                  className=\"flex items-center gap-2\"\n                  data-testid={`button-beneficiary-${b.id}`}\n                >\n                  <span className=\"truncate max-w-[80px]\">{b.name}</span>\n                  <Badge className={`${NETWORKS.find(n => n.id === b.network)?.bgColor} ${NETWORKS.find(n => n.id === b.network)?.textColor} border-0 text-xs`}>\n                    {NETWORKS.find(n => n.id === b.network)?.displayName}\n                  </Badge>\n                </Button>\n              ))}\n              {beneficiaries.length > 5 && (\n                <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-more-beneficiaries\">\n                  +{beneficiaries.length - 5} more\n                </Button>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Phone Number and Purchase Card - Only show for data and airtime tabs */}\n      {(serviceType === \"data\" || serviceType === \"airtime\") && (\n        <Card className=\"mb-8\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Smartphone className=\"h-5 w-5\" />\n              Phone Number\n            </CardTitle>\n            <CardDescription>Enter the phone number to recharge</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"phone-number\">Phone Number</Label>\n              <div className=\"relative\">\n                <Input\n                  id=\"phone-number\"\n                  type=\"tel\"\n                  placeholder=\"08012345678\"\n                  value={phoneNumber}\n                  onChange={(e) => handlePhoneChange(e.target.value)}\n                  className={`pr-24 ${phoneValidation.message ? \"border-red-500\" : \"\"}`}\n                  data-testid=\"input-phone-number\"\n                />\n                {detectedNetwork && (\n                  <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                    <Badge \n                      className={`${detectedNetwork.bgColor} ${detectedNetwork.textColor} border-0`}\n                      data-testid=\"badge-detected-network\"\n                    >\n                      {detectedNetwork.displayName}\n                    </Badge>\n                  </div>\n                )}\n              </div>\n              {phoneValidation.message && (\n                <p className=\"text-sm text-red-500 flex items-center gap-1\" data-testid=\"text-phone-error\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  {phoneValidation.message}\n                </p>\n              )}\n              {detectedNetwork && !networkMatch && phoneValidation.valid && (\n                <p className=\"text-sm text-amber-600 dark:text-amber-400 flex items-center gap-1\" data-testid=\"text-network-mismatch\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  This number appears to be {detectedNetwork.displayName}, but you selected{\" \"}\n                  {NETWORKS.find((n) => n.id === selectedNetwork)?.displayName}\n                </p>\n              )}\n              {networkMatch && phoneValidation.valid && (\n                <div className=\"flex items-center justify-between\">\n                  <p className=\"text-sm text-green-600 dark:text-green-400 flex items-center gap-1\" data-testid=\"text-network-match\">\n                    <CheckCircle className=\"h-4 w-4\" />\n                    Network verified\n                  </p>\n                  {!beneficiaries?.some(b => b.phoneNumber === phoneNumber) && (\n                    <Dialog open={showBeneficiaryDialog} onOpenChange={setShowBeneficiaryDialog}>\n                      <DialogTrigger asChild>\n                        <Button variant=\"ghost\" size=\"sm\" className=\"text-xs\" data-testid=\"button-save-beneficiary\">\n                          <Star className=\"h-3 w-3 mr-1\" />\n                          Save Contact\n                        </Button>\n                      </DialogTrigger>\n                      <DialogContent>\n                        <DialogHeader>\n                          <DialogTitle>Save Contact</DialogTitle>\n                          <DialogDescription>Save this number for quick access next time</DialogDescription>\n                        </DialogHeader>\n                        <div className=\"space-y-4 py-4\">\n                          <div className=\"space-y-2\">\n                            <Label htmlFor=\"beneficiary-name\">Name</Label>\n                            <Input\n                              id=\"beneficiary-name\"\n                              placeholder=\"e.g., Self, Mom, Friend\"\n                              value={newBeneficiaryName}\n                              onChange={(e) => setNewBeneficiaryName(e.target.value)}\n                              data-testid=\"input-beneficiary-name\"\n                            />\n                          </div>\n                          <div className=\"p-3 rounded-md bg-muted/50 flex items-center justify-between\">\n                            <span>{phoneNumber}</span>\n                            {getNetworkBadge(detectedNetwork?.id || selectedNetwork)}\n                          </div>\n                        </div>\n                        <DialogFooter>\n                          <Button \n                            onClick={handleSaveBeneficiary}\n                            disabled={!newBeneficiaryName.trim() || createBeneficiaryMutation.isPending}\n                            data-testid=\"button-confirm-save-beneficiary\"\n                          >\n                            {createBeneficiaryMutation.isPending ? (\n                              <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n                            ) : (\n                              <Star className=\"h-4 w-4 mr-2\" />\n                            )}\n                            Save Contact\n                          </Button>\n                        </DialogFooter>\n                      </DialogContent>\n                    </Dialog>\n                  )}\n                </div>\n              )}\n            </div>\n\n            {serviceType === \"data\" && selectedPlan && (\n              <div className=\"p-4 rounded-md bg-muted/50 space-y-2\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Plan:</span>\n                  <span className=\"font-medium\">{selectedPlan.dataAmount} - {selectedPlan.validity}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Network:</span>\n                  {getNetworkBadge(selectedNetwork)}\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Amount:</span>\n                  <span className=\"font-bold text-primary\">₦{parseFloat(selectedPlan.sellingPrice).toLocaleString()}</span>\n                </div>\n              </div>\n            )}\n\n            {serviceType === \"airtime\" && airtimeAmount > 0 && (\n              <div className=\"p-4 rounded-md bg-muted/50 space-y-2\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Service:</span>\n                  <span className=\"font-medium\">Airtime Top-up</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Network:</span>\n                  {getNetworkBadge(detectedNetwork?.id || selectedNetwork)}\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Amount:</span>\n                  <span className=\"font-bold text-primary\">₦{airtimeAmount.toLocaleString()}</span>\n                </div>\n              </div>\n            )}\n\n            {serviceType === \"data\" && selectedPlan && walletBalance < parseFloat(selectedPlan.sellingPrice) && (\n              <div className=\"p-4 rounded-md bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 flex items-center gap-3\">\n                <AlertCircle className=\"h-5 w-5 flex-shrink-0\" />\n                <div>\n                  <p className=\"font-medium\">Insufficient Balance</p>\n                  <p className=\"text-sm\">You need ₦{(parseFloat(selectedPlan.sellingPrice) - walletBalance).toLocaleString()} more to purchase this plan.</p>\n                </div>\n              </div>\n            )}\n\n            {serviceType === \"airtime\" && airtimeAmount > 0 && walletBalance < airtimeAmount && (\n              <div className=\"p-4 rounded-md bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 flex items-center gap-3\">\n                <AlertCircle className=\"h-5 w-5 flex-shrink-0\" />\n                <div>\n                  <p className=\"font-medium\">Insufficient Balance</p>\n                  <p className=\"text-sm\">You need ₦{(airtimeAmount - walletBalance).toLocaleString()} more to purchase this airtime.</p>\n                </div>\n              </div>\n            )}\n\n            {serviceType === \"data\" ? (\n              <Button\n                onClick={handleDataPurchase}\n                disabled={!canPurchaseData || purchaseDataMutation.isPending}\n                className=\"w-full\"\n                data-testid=\"button-purchase-data\"\n              >\n                {purchaseDataMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    Processing...\n                  </>\n                ) : (\n                  <>\n                    Purchase Data\n                    {selectedPlan && ` - ₦${parseFloat(selectedPlan.sellingPrice).toLocaleString()}`}\n                  </>\n                )}\n              </Button>\n            ) : (\n              <Button\n                onClick={handleAirtimePurchase}\n                disabled={!canPurchaseAirtime || purchaseAirtimeMutation.isPending}\n                className=\"w-full\"\n                data-testid=\"button-purchase-airtime\"\n              >\n                {purchaseAirtimeMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    Processing...\n                  </>\n                ) : (\n                  <>\n                    Purchase Airtime\n                    {airtimeAmount > 0 && ` - ₦${airtimeAmount.toLocaleString()}`}\n                  </>\n                )}\n              </Button>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Transaction History - Only show for data and airtime tabs */}\n      {(serviceType === \"data\" || serviceType === \"airtime\") && (\n        <Card>\n          <CardHeader>\n            <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n              <div>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Clock className=\"h-5 w-5\" />\n                  Transaction History\n                </CardTitle>\n                <CardDescription>Your recent VTU purchases</CardDescription>\n              </div>\n              <div className=\"flex flex-wrap items-center gap-2\">\n                <Select value={txStatusFilter} onValueChange={setTxStatusFilter}>\n                  <SelectTrigger className=\"w-[120px]\" data-testid=\"select-status-filter\">\n                    <Filter className=\"h-3 w-3 mr-1\" />\n                    <SelectValue placeholder=\"Status\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Status</SelectItem>\n                    <SelectItem value=\"success\">Success</SelectItem>\n                    <SelectItem value=\"pending\">Pending</SelectItem>\n                    <SelectItem value=\"failed\">Failed</SelectItem>\n                  </SelectContent>\n                </Select>\n                <Select value={txNetworkFilter} onValueChange={setTxNetworkFilter}>\n                  <SelectTrigger className=\"w-[120px]\" data-testid=\"select-network-filter\">\n                    <Signal className=\"h-3 w-3 mr-1\" />\n                    <SelectValue placeholder=\"Network\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Networks</SelectItem>\n                    {NETWORKS.map(n => (\n                      <SelectItem key={n.id} value={n.id}>{n.displayName}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            {transactionsLoading ? (\n              <div className=\"space-y-4\">\n                {[...Array(3)].map((_, i) => (\n                  <Skeleton key={i} className=\"h-16\" />\n                ))}\n              </div>\n            ) : transactions && transactions.length > 0 ? (\n              <div className=\"space-y-4\">\n                {transactions.map((tx) => (\n                  <div\n                    key={tx.id}\n                    className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-2 p-4 rounded-md bg-muted/30\"\n                    data-testid={`transaction-${tx.id}`}\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <div className={`p-2 rounded-full ${NETWORKS.find(n => n.id === tx.network)?.bgColor || \"bg-muted\"}`}>\n                        <Signal className={`h-4 w-4 ${NETWORKS.find(n => n.id === tx.network)?.textColor || \"text-muted-foreground\"}`} />\n                      </div>\n                      <div>\n                        <div className=\"font-medium flex flex-wrap items-center gap-2\">\n                          {tx.phoneNumber}\n                          {getNetworkBadge(tx.network as NetworkType)}\n                          {!tx.planId && (\n                            <Badge variant=\"outline\" className=\"text-xs\">Airtime</Badge>\n                          )}\n                        </div>\n                        <div className=\"text-sm text-muted-foreground\">\n                          {tx.createdAt && format(new Date(tx.createdAt), \"MMM d, yyyy 'at' h:mm a\")}\n                        </div>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-4 sm:text-right\">\n                      <div>\n                        <div className=\"font-bold\">₦{parseFloat(tx.amount).toLocaleString()}</div>\n                      </div>\n                      {getStatusBadge(tx.status)}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <div className=\"text-center py-12 text-muted-foreground\">\n                <Clock className=\"h-12 w-12 mx-auto mb-4 opacity-30\" />\n                <p>No transactions {txStatusFilter !== \"all\" || txNetworkFilter !== \"all\" ? \"matching filters\" : \"yet\"}.</p>\n                <p className=\"text-sm\">\n                  {txStatusFilter !== \"all\" || txNetworkFilter !== \"all\" \n                    ? \"Try adjusting your filters\" \n                    : \"Your VTU purchase history will appear here.\"}\n                </p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":97576,"size_tokens":null},"client/src/pages/legal.tsx":{"content":"import { useState } from \"react\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { Shield, FileText, HelpCircle, AlertTriangle, Lock, Scale } from \"lucide-react\";\n\nexport default function LegalPage() {\n  const [activeTab, setActiveTab] = useState(\"privacy\");\n\n  return (\n    <div className=\"container mx-auto max-w-4xl px-4 py-6\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-2xl font-bold\" data-testid=\"text-legal-title\">Legal & Privacy</h1>\n        <p className=\"text-muted-foreground\">\n          Important information about how we handle your data and our terms of service\n        </p>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-4\">\n        <TabsList className=\"grid w-full grid-cols-4\">\n          <TabsTrigger value=\"privacy\" className=\"flex items-center gap-1\" data-testid=\"tab-privacy\">\n            <Lock className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Privacy</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"terms\" className=\"flex items-center gap-1\" data-testid=\"tab-terms\">\n            <FileText className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Terms</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"faqs\" className=\"flex items-center gap-1\" data-testid=\"tab-faqs\">\n            <HelpCircle className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">FAQs</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"disclaimer\" className=\"flex items-center gap-1\" data-testid=\"tab-disclaimer\">\n            <AlertTriangle className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Disclaimer</span>\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"privacy\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <Shield className=\"h-5 w-5 text-primary\" />\n                <CardTitle>Privacy Policy</CardTitle>\n              </div>\n              <CardDescription>Last updated: November 2025</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <ScrollArea className=\"h-[60vh] pr-4\">\n                <div className=\"space-y-6 text-sm\">\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">1. Information We Collect</h3>\n                    <p className=\"text-muted-foreground mb-2\">\n                      We collect information you provide directly to us, including:\n                    </p>\n                    <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground\">\n                      <li>Account information (name, email, phone number)</li>\n                      <li>Profile information (photo, bio, campus location)</li>\n                      <li>Transaction data (purchases, sales, wallet activity)</li>\n                      <li>Communication data (messages, support tickets)</li>\n                      <li>Verification documents (NIN, selfie for KYC - deleted after verification)</li>\n                    </ul>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">2. How We Use Your Information</h3>\n                    <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground\">\n                      <li>To provide and maintain our marketplace services</li>\n                      <li>To process transactions and payments</li>\n                      <li>To verify your identity (one-time KYC process)</li>\n                      <li>To communicate with you about orders and updates</li>\n                      <li>To detect and prevent fraud or scams</li>\n                      <li>To improve our platform and user experience</li>\n                    </ul>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">3. KYC Verification & Data Handling</h3>\n                    <p className=\"text-muted-foreground mb-2\">\n                      For identity verification, we follow strict data handling practices:\n                    </p>\n                    <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground\">\n                      <li>NIN photos and selfies are used ONLY for one-time verification</li>\n                      <li>Both images are automatically deleted within 24 hours of verification decision</li>\n                      <li>We store only a hashed version of your NIN (not the actual number)</li>\n                      <li>Verification logs are kept for 1 year for security purposes</li>\n                      <li>Your explicit consent is required before any verification</li>\n                    </ul>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">4. Information Sharing</h3>\n                    <p className=\"text-muted-foreground mb-2\">\n                      We do not sell your personal information. We may share information:\n                    </p>\n                    <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground\">\n                      <li>With other users (limited profile info for transactions)</li>\n                      <li>With payment processors to complete transactions</li>\n                      <li>With verification providers for KYC (SMEDATA.NG)</li>\n                      <li>When required by law or to protect our rights</li>\n                    </ul>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">5. Data Security</h3>\n                    <p className=\"text-muted-foreground\">\n                      We implement industry-standard security measures including encryption, \n                      secure connections (HTTPS), and access controls. However, no system is \n                      100% secure. We encourage you to protect your account credentials and \n                      report any suspicious activity.\n                    </p>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">6. Your Rights</h3>\n                    <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground\">\n                      <li>Access your personal data</li>\n                      <li>Request correction of inaccurate data</li>\n                      <li>Request deletion of your account (30-day grace period)</li>\n                      <li>Opt out of promotional communications</li>\n                      <li>Control your location visibility settings</li>\n                    </ul>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">7. Contact Us</h3>\n                    <p className=\"text-muted-foreground\">\n                      For privacy-related questions, contact us through the Support page \n                      or email our data protection team.\n                    </p>\n                  </section>\n                </div>\n              </ScrollArea>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"terms\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <Scale className=\"h-5 w-5 text-primary\" />\n                <CardTitle>Terms & Conditions</CardTitle>\n              </div>\n              <CardDescription>Last updated: November 2025</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <ScrollArea className=\"h-[60vh] pr-4\">\n                <div className=\"space-y-6 text-sm\">\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">1. Acceptance of Terms</h3>\n                    <p className=\"text-muted-foreground\">\n                      By using EKSU Marketplace, you agree to these terms. \n                      If you do not agree, please do not use our platform.\n                    </p>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">2. Eligibility</h3>\n                    <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground\">\n                      <li>You must be at least 18 years old</li>\n                      <li>You must be a current student or affiliate of EKSU</li>\n                      <li>You must provide accurate registration information</li>\n                      <li>One account per person (enforced via phone/NIN)</li>\n                    </ul>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">3. Account Responsibilities</h3>\n                    <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground\">\n                      <li>Keep your login credentials secure</li>\n                      <li>You are responsible for all activity under your account</li>\n                      <li>Report unauthorized access immediately</li>\n                      <li>Do not share your account with others</li>\n                    </ul>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">4. Seller Requirements</h3>\n                    <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground\">\n                      <li>Sellers must complete KYC verification before listing products</li>\n                      <li>List only items you legally own and can sell</li>\n                      <li>Provide accurate descriptions and images</li>\n                      <li>Honor pricing and availability of listed items</li>\n                      <li>Respond to inquiries in a timely manner</li>\n                    </ul>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">5. Transaction Limits (Tier-1)</h3>\n                    <p className=\"text-muted-foreground mb-2\">\n                      To comply with financial regulations, all accounts are Tier-1 with:\n                    </p>\n                    <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground\">\n                      <li>Maximum daily transaction limit: N50,000</li>\n                      <li>Maximum wallet balance: N200,000</li>\n                      <li>Higher limits may be available with additional verification</li>\n                    </ul>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">6. Prohibited Activities</h3>\n                    <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground\">\n                      <li>Selling illegal, stolen, or counterfeit items</li>\n                      <li>Fraudulent transactions or scams</li>\n                      <li>Harassment, abuse, or threatening behavior</li>\n                      <li>Creating multiple accounts</li>\n                      <li>Manipulating reviews or ratings</li>\n                      <li>Bypassing platform fees or escrow</li>\n                    </ul>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">7. Fees & Payments</h3>\n                    <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground\">\n                      <li>Platform fees: 3-6% on successful transactions</li>\n                      <li>KYC verification fee: N200 (one-time)</li>\n                      <li>Withdrawal processing within 24 hours</li>\n                      <li>Escrow protection on all transactions</li>\n                    </ul>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">8. Dispute Resolution</h3>\n                    <p className=\"text-muted-foreground\">\n                      We encourage buyers and sellers to resolve disputes directly. \n                      If unsuccessful, you may open a dispute through our Support system. \n                      Our team will review evidence and make a fair decision.\n                    </p>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">9. Account Termination</h3>\n                    <p className=\"text-muted-foreground\">\n                      We may suspend or terminate accounts for violations of these terms. \n                      You may also request account deletion with a 30-day grace period \n                      to recover your account if needed.\n                    </p>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">10. Limitation of Liability</h3>\n                    <p className=\"text-muted-foreground\">\n                      We are a platform connecting buyers and sellers. We are not responsible \n                      for the quality of items, delivery issues, or disputes between users. \n                      Use escrow and our safety features to protect yourself.\n                    </p>\n                  </section>\n                </div>\n              </ScrollArea>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"faqs\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <HelpCircle className=\"h-5 w-5 text-primary\" />\n                <CardTitle>Frequently Asked Questions</CardTitle>\n              </div>\n              <CardDescription>Quick answers to common questions</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <ScrollArea className=\"h-[60vh] pr-4\">\n                <Accordion type=\"single\" collapsible className=\"w-full\">\n                  <AccordionItem value=\"what-is\">\n                    <AccordionTrigger>What is EKSU Marketplace?</AccordionTrigger>\n                    <AccordionContent className=\"text-muted-foreground\">\n                      EKSU Marketplace is a secure marketplace platform designed specifically for EKSU students. \n                      You can buy and sell items, purchase VTU data, play games, and connect with other students - \n                      all with built-in safety features like escrow and identity verification.\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"verification\">\n                    <AccordionTrigger>Why do I need to verify my identity?</AccordionTrigger>\n                    <AccordionContent className=\"text-muted-foreground\">\n                      Verification helps prevent scams and builds trust. Verified sellers can list products, \n                      and verified users get a green badge on their profile. The N200 fee covers the cost \n                      of NIN verification and helps ensure only real people use the platform.\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"fees\">\n                    <AccordionTrigger>What are the platform fees?</AccordionTrigger>\n                    <AccordionContent className=\"text-muted-foreground\">\n                      <ul className=\"list-disc pl-5 space-y-1\">\n                        <li>Transaction fee: 3-6% on successful sales</li>\n                        <li>KYC verification: N200 (one-time)</li>\n                        <li>Deposits: Free</li>\n                        <li>Withdrawals: Small processing fee</li>\n                      </ul>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"escrow\">\n                    <AccordionTrigger>How does escrow protection work?</AccordionTrigger>\n                    <AccordionContent className=\"text-muted-foreground\">\n                      When you make a purchase, the payment is held securely by the platform. \n                      Once you confirm you've received the item, the payment is released to the seller. \n                      If there's a problem, you can open a dispute and our team will help resolve it.\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"vtu\">\n                    <AccordionTrigger>What is VTU Data?</AccordionTrigger>\n                    <AccordionContent className=\"text-muted-foreground\">\n                      VTU (Virtual Top-Up) allows you to buy data directly from the app. \n                      We offer MTN SME, GLO CG, Airtel CG, and 9mobile data at discounted rates. \n                      Data is delivered instantly to any Nigerian phone number.\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"games\">\n                    <AccordionTrigger>Can I win real money playing games?</AccordionTrigger>\n                    <AccordionContent className=\"text-muted-foreground\">\n                      Yes! You can stake money on games like Ludo, Word Battle, and Trivia. \n                      Winnings are credited to your wallet and can be withdrawn. \n                      You can also practice for free before staking real money.\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"refund\">\n                    <AccordionTrigger>How do refunds work?</AccordionTrigger>\n                    <AccordionContent className=\"text-muted-foreground\">\n                      If you're using escrow and there's an issue with your order, don't confirm receipt. \n                      Contact the seller first. If unresolved, open a dispute. If the dispute is resolved \n                      in your favor, you'll receive a full refund to your wallet.\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"delete-account\">\n                    <AccordionTrigger>How do I delete my account?</AccordionTrigger>\n                    <AccordionContent className=\"text-muted-foreground\">\n                      Go to Settings, then the Account tab, and click \"Request Account Deletion\". \n                      You'll have a 30-day grace period to cancel the deletion if you change your mind. \n                      After 30 days, your account and data will be permanently deleted.\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"support\">\n                    <AccordionTrigger>How do I contact support?</AccordionTrigger>\n                    <AccordionContent className=\"text-muted-foreground\">\n                      Visit the Support page to submit a ticket, chat with our AI assistant, \n                      or browse FAQs. For urgent issues, use the live chat feature. \n                      Our team typically responds within 24 hours.\n                    </AccordionContent>\n                  </AccordionItem>\n                </Accordion>\n              </ScrollArea>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"disclaimer\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"h-5 w-5 text-primary\" />\n                <CardTitle>Disclaimer</CardTitle>\n              </div>\n              <CardDescription>Important notices and limitations</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <ScrollArea className=\"h-[60vh] pr-4\">\n                <div className=\"space-y-6 text-sm\">\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">Platform Role</h3>\n                    <p className=\"text-muted-foreground\">\n                      EKSU Marketplace is a platform that connects buyers and sellers. \n                      We do not own, manufacture, or sell any products listed on the platform. \n                      We are not responsible for the quality, safety, legality, or accuracy of listings.\n                    </p>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">User Responsibility</h3>\n                    <p className=\"text-muted-foreground\">\n                      Users are responsible for their own transactions. While we provide safety \n                      features like escrow and verification, we cannot guarantee that all users \n                      will act honestly. Always use caution and common sense when transacting.\n                    </p>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">No Financial Advice</h3>\n                    <p className=\"text-muted-foreground\">\n                      Any information on the platform about pricing, investments, or financial \n                      matters is for informational purposes only and should not be considered \n                      financial advice. Consult a professional for financial decisions.\n                    </p>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">Games & Staking</h3>\n                    <p className=\"text-muted-foreground\">\n                      Games with staking involve real money and risk. Only stake what you can \n                      afford to lose. We are not responsible for losses incurred through gaming. \n                      Please gamble responsibly and within legal limits.\n                    </p>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">VTU Services</h3>\n                    <p className=\"text-muted-foreground\">\n                      VTU data services are provided through third-party APIs. While we strive \n                      for reliability, we cannot guarantee 100% uptime or instant delivery. \n                      Refunds for failed transactions will be processed according to our policy.\n                    </p>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">Identity Verification</h3>\n                    <p className=\"text-muted-foreground\">\n                      Our KYC verification is a basic in-house real-person check, not a \n                      CBN-approved biometric verification. It helps build trust but does not \n                      guarantee the identity or intentions of users. Always verify independently \n                      for high-value transactions.\n                    </p>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">Service Availability</h3>\n                    <p className=\"text-muted-foreground\">\n                      We strive to maintain platform availability but cannot guarantee uninterrupted \n                      service. We may perform maintenance, updates, or experience technical issues \n                      that temporarily affect service.\n                    </p>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">Changes to Terms</h3>\n                    <p className=\"text-muted-foreground\">\n                      We may update these terms and policies at any time. Continued use of the \n                      platform after changes constitutes acceptance of the new terms. Major \n                      changes will be communicated through announcements.\n                    </p>\n                  </section>\n\n                  <section>\n                    <h3 className=\"font-semibold text-base mb-2\">Contact</h3>\n                    <p className=\"text-muted-foreground\">\n                      For questions about these disclaimers or any legal matters, please contact \n                      us through the Support page or email our legal team.\n                    </p>\n                  </section>\n                </div>\n              </ScrollArea>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":24601,"size_tokens":null},"client/src/pages/kyc.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Shield, CheckCircle2, XCircle, Clock, Camera, Upload, AlertTriangle, CreditCard, User, Calendar, FileText, Loader2, RefreshCw } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle, CardFooter } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from \"@/components/ui/form\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport type { KycVerification, User as UserType } from \"@shared/schema\";\n\nconst kycFormSchema = z.object({\n  nin: z.string().length(11, \"NIN must be exactly 11 digits\").regex(/^\\d+$/, \"NIN must contain only numbers\"),\n  firstName: z.string().min(1, \"First name is required\"),\n  lastName: z.string().min(1, \"Last name is required\"),\n  dateOfBirth: z.string().min(1, \"Date of birth is required\"),\n  consent: z.boolean().refine(val => val === true, \"You must agree to the verification terms\"),\n});\n\ntype KycFormData = z.infer<typeof kycFormSchema>;\n\nexport default function KycPage() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [step, setStep] = useState<\"info\" | \"payment\" | \"nin\" | \"selfie\" | \"processing\" | \"result\">(\"info\");\n  const [selfieFile, setSelfieFile] = useState<File | null>(null);\n  const [selfiePreview, setSelfiePreview] = useState<string | null>(null);\n  const [currentKycId, setCurrentKycId] = useState<string | null>(null);\n  const [paymentUrl, setPaymentUrl] = useState<string | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const form = useForm<KycFormData>({\n    resolver: zodResolver(kycFormSchema),\n    defaultValues: {\n      nin: \"\",\n      firstName: user?.firstName || \"\",\n      lastName: user?.lastName || \"\",\n      dateOfBirth: \"\",\n      consent: false,\n    },\n  });\n\n  const { data: kycStatus, isLoading: loadingStatus } = useQuery<KycVerification | null>({\n    queryKey: [\"/api/kyc/status\"],\n    retry: false,\n  });\n\n  const initiatePaymentMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/kyc/initiate-payment\");\n      const result = await response.json();\n      return result as { paymentUrl: string; kycId: string };\n    },\n    onSuccess: (data) => {\n      setCurrentKycId(data.kycId);\n      setPaymentUrl(data.paymentUrl);\n      if (data.paymentUrl) {\n        window.open(data.paymentUrl, \"_blank\");\n      }\n      setStep(\"nin\");\n      toast({\n        title: \"Payment initiated\",\n        description: \"Complete the payment in the new window, then continue here.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Payment failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const submitNinMutation = useMutation({\n    mutationFn: async (data: KycFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/kyc/submit-nin\", {\n        kycId: currentKycId,\n        nin: data.nin,\n        firstName: data.firstName,\n        lastName: data.lastName,\n        dateOfBirth: data.dateOfBirth,\n        consent: data.consent,\n      });\n      const result = await response.json();\n      return result as { kycId: string; ninPhotoReceived: boolean };\n    },\n    onSuccess: (data) => {\n      setCurrentKycId(data.kycId);\n      setStep(\"selfie\");\n      toast({\n        title: \"NIN verified\",\n        description: \"Now take a clear selfie for comparison.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"NIN verification failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const uploadSelfieMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append(\"selfie\", file);\n      formData.append(\"kycId\", currentKycId || \"\");\n      \n      const response = await fetch(\"/api/kyc/upload-selfie\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to upload selfie\");\n      }\n      \n      return response.json();\n    },\n    onSuccess: (data) => {\n      setStep(\"processing\");\n      checkVerificationStatus();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Selfie upload failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const checkVerificationStatus = async () => {\n    try {\n      await new Promise(resolve => setTimeout(resolve, 3000));\n      queryClient.invalidateQueries({ queryKey: [\"/api/kyc/status\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      setStep(\"result\");\n    } catch (error) {\n      console.error(\"Error checking status:\", error);\n    }\n  };\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      if (file.size > 5 * 1024 * 1024) {\n        toast({\n          title: \"File too large\",\n          description: \"Please upload an image smaller than 5MB\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      setSelfieFile(file);\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setSelfiePreview(reader.result as string);\n      };\n      reader.readAsDataURL(file);\n    }\n  };\n\n  const handleSubmitSelfie = () => {\n    if (selfieFile) {\n      uploadSelfieMutation.mutate(selfieFile);\n    }\n  };\n\n  const onSubmitNin = (data: KycFormData) => {\n    submitNinMutation.mutate(data);\n  };\n\n  if (loadingStatus) {\n    return (\n      <div className=\"container mx-auto max-w-2xl px-4 py-6\">\n        <div className=\"flex items-center justify-center py-12\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (user?.isVerified || user?.ninVerified) {\n    return (\n      <div className=\"container mx-auto max-w-2xl px-4 py-6\">\n        <Card>\n          <CardHeader className=\"text-center\">\n            <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-green-100 dark:bg-green-900\">\n              <CheckCircle2 className=\"h-8 w-8 text-green-600\" />\n            </div>\n            <CardTitle>Already Verified</CardTitle>\n            <CardDescription>\n              Your identity has been verified. You have full access to all platform features.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"text-center\">\n            <Badge variant=\"default\" className=\"text-sm\">\n              <Shield className=\"mr-1 h-3 w-3\" />\n              Verified User\n            </Badge>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (kycStatus?.status === \"pending_verification\" || kycStatus?.status === \"manual_review\") {\n    return (\n      <div className=\"container mx-auto max-w-2xl px-4 py-6\">\n        <Card>\n          <CardHeader className=\"text-center\">\n            <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-yellow-100 dark:bg-yellow-900\">\n              <Clock className=\"h-8 w-8 text-yellow-600\" />\n            </div>\n            <CardTitle>Verification In Progress</CardTitle>\n            <CardDescription>\n              {kycStatus?.status === \"manual_review\" \n                ? \"Your verification is being reviewed by our team. This usually takes 1-24 hours.\"\n                : \"Your verification is being processed. Please wait...\"\n              }\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between text-sm\">\n              <span className=\"text-muted-foreground\">Status</span>\n              <Badge variant=\"secondary\">\n                {kycStatus?.status === \"manual_review\" ? \"Manual Review\" : \"Processing\"}\n              </Badge>\n            </div>\n            {kycStatus?.similarityScore && (\n              <div className=\"flex items-center justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Match Score</span>\n                <span>{parseFloat(kycStatus.similarityScore).toFixed(1)}%</span>\n              </div>\n            )}\n          </CardContent>\n          <CardFooter>\n            <Button \n              variant=\"outline\" \n              className=\"w-full\"\n              onClick={() => queryClient.invalidateQueries({ queryKey: [\"/api/kyc/status\"] })}\n            >\n              <RefreshCw className=\"mr-2 h-4 w-4\" />\n              Refresh Status\n            </Button>\n          </CardFooter>\n        </Card>\n      </div>\n    );\n  }\n\n  if (kycStatus?.status === \"rejected\") {\n    return (\n      <div className=\"container mx-auto max-w-2xl px-4 py-6\">\n        <Card>\n          <CardHeader className=\"text-center\">\n            <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-red-100 dark:bg-red-900\">\n              <XCircle className=\"h-8 w-8 text-red-600\" />\n            </div>\n            <CardTitle>Verification Rejected</CardTitle>\n            <CardDescription>\n              {kycStatus?.rejectionReason || \"Your verification was not successful. A refund has been processed.\"}\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Alert variant=\"destructive\">\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertTitle>What went wrong?</AlertTitle>\n              <AlertDescription>\n                The selfie didn't match the NIN photo closely enough. Common reasons:\n                <ul className=\"list-disc pl-4 mt-2 text-sm\">\n                  <li>Poor lighting in selfie</li>\n                  <li>Face not clearly visible</li>\n                  <li>Wearing sunglasses or face coverings</li>\n                  <li>Different angle than NIN photo</li>\n                </ul>\n              </AlertDescription>\n            </Alert>\n          </CardContent>\n          <CardFooter>\n            <Button className=\"w-full\" onClick={() => setStep(\"info\")}>\n              Try Again\n            </Button>\n          </CardFooter>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto max-w-2xl px-4 py-6\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-2xl font-bold\" data-testid=\"text-kyc-title\">Identity Verification</h1>\n        <p className=\"text-muted-foreground\">\n          Verify your identity to unlock all platform features\n        </p>\n      </div>\n\n      <div className=\"mb-6\">\n        <Progress \n          value={\n            step === \"info\" ? 0 :\n            step === \"payment\" ? 25 :\n            step === \"nin\" ? 50 :\n            step === \"selfie\" ? 75 :\n            100\n          } \n          className=\"h-2\"\n        />\n        <div className=\"mt-2 flex justify-between text-xs text-muted-foreground\">\n          <span>Start</span>\n          <span>Payment</span>\n          <span>NIN</span>\n          <span>Selfie</span>\n          <span>Done</span>\n        </div>\n      </div>\n\n      {step === \"info\" && (\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center gap-2\">\n              <Shield className=\"h-5 w-5 text-primary\" />\n              <CardTitle>Why Verify?</CardTitle>\n            </div>\n            <CardDescription>\n              Verification helps prevent scams and builds trust\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"grid gap-4\">\n              <div className=\"flex items-start gap-3\">\n                <CheckCircle2 className=\"h-5 w-5 text-green-500 mt-0.5\" />\n                <div>\n                  <p className=\"font-medium\">Verified Badge</p>\n                  <p className=\"text-sm text-muted-foreground\">Get a green verified badge on your profile</p>\n                </div>\n              </div>\n              <div className=\"flex items-start gap-3\">\n                <CheckCircle2 className=\"h-5 w-5 text-green-500 mt-0.5\" />\n                <div>\n                  <p className=\"font-medium\">Sell Products</p>\n                  <p className=\"text-sm text-muted-foreground\">Only verified users can list items for sale</p>\n                </div>\n              </div>\n              <div className=\"flex items-start gap-3\">\n                <CheckCircle2 className=\"h-5 w-5 text-green-500 mt-0.5\" />\n                <div>\n                  <p className=\"font-medium\">Higher Trust</p>\n                  <p className=\"text-sm text-muted-foreground\">Buyers prefer verified sellers</p>\n                </div>\n              </div>\n            </div>\n\n            <Alert>\n              <CreditCard className=\"h-4 w-4\" />\n              <AlertTitle>Verification Fee: N200</AlertTitle>\n              <AlertDescription>\n                This one-time fee covers the cost of NIN verification. If verification fails, \n                you'll receive a full refund.\n              </AlertDescription>\n            </Alert>\n\n            <Alert variant=\"destructive\">\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertTitle>Important Privacy Notice</AlertTitle>\n              <AlertDescription>\n                Your NIN photo and selfie will be used ONLY for one-time verification and \n                deleted within 24 hours. We never store your actual NIN number.\n              </AlertDescription>\n            </Alert>\n          </CardContent>\n          <CardFooter>\n            <Button \n              className=\"w-full\" \n              onClick={() => initiatePaymentMutation.mutate()}\n              disabled={initiatePaymentMutation.isPending}\n              data-testid=\"button-start-verification\"\n            >\n              {initiatePaymentMutation.isPending ? (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              ) : (\n                <CreditCard className=\"mr-2 h-4 w-4\" />\n              )}\n              Pay N200 & Start Verification\n            </Button>\n          </CardFooter>\n        </Card>\n      )}\n\n      {step === \"nin\" && (\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center gap-2\">\n              <User className=\"h-5 w-5 text-primary\" />\n              <CardTitle>Enter NIN Details</CardTitle>\n            </div>\n            <CardDescription>\n              Enter your National Identification Number and personal details\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmitNin)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"nin\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>NIN (11 digits)</FormLabel>\n                      <FormControl>\n                        <Input \n                          placeholder=\"12345678901\" \n                          maxLength={11}\n                          {...field} \n                          data-testid=\"input-nin\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"firstName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>First Name</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"John\" {...field} data-testid=\"input-first-name\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"lastName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Last Name</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"Doe\" {...field} data-testid=\"input-last-name\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <FormField\n                  control={form.control}\n                  name=\"dateOfBirth\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Date of Birth</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"date\" \n                          {...field} \n                          data-testid=\"input-dob\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"consent\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4\">\n                      <FormControl>\n                        <Checkbox\n                          checked={field.value}\n                          onCheckedChange={field.onChange}\n                          data-testid=\"checkbox-consent\"\n                        />\n                      </FormControl>\n                      <div className=\"space-y-1 leading-none\">\n                        <FormLabel>I consent to verification</FormLabel>\n                        <FormDescription>\n                          I allow EKSU Marketplace to compare my selfie with my NIN photo for \n                          one-time verification. Both images will be deleted immediately after verification.\n                        </FormDescription>\n                      </div>\n                    </FormItem>\n                  )}\n                />\n\n                <Button \n                  type=\"submit\" \n                  className=\"w-full\"\n                  disabled={submitNinMutation.isPending}\n                  data-testid=\"button-submit-nin\"\n                >\n                  {submitNinMutation.isPending ? (\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  ) : null}\n                  Continue to Selfie\n                </Button>\n              </form>\n            </Form>\n          </CardContent>\n        </Card>\n      )}\n\n      {step === \"selfie\" && (\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center gap-2\">\n              <Camera className=\"h-5 w-5 text-primary\" />\n              <CardTitle>Take a Selfie</CardTitle>\n            </div>\n            <CardDescription>\n              Take a clear photo of your face for comparison with your NIN photo\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <Alert>\n              <Camera className=\"h-4 w-4\" />\n              <AlertTitle>Selfie Tips</AlertTitle>\n              <AlertDescription>\n                <ul className=\"list-disc pl-4 mt-2 text-sm\">\n                  <li>Use good lighting (face the light source)</li>\n                  <li>Look directly at the camera</li>\n                  <li>Remove glasses or face coverings</li>\n                  <li>Keep a neutral expression</li>\n                </ul>\n              </AlertDescription>\n            </Alert>\n\n            <div \n              className=\"flex flex-col items-center justify-center border-2 border-dashed rounded-lg p-8 cursor-pointer\"\n              onClick={() => fileInputRef.current?.click()}\n            >\n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                accept=\"image/*\"\n                capture=\"user\"\n                className=\"hidden\"\n                onChange={handleFileChange}\n                data-testid=\"input-selfie\"\n              />\n              \n              {selfiePreview ? (\n                <div className=\"relative\">\n                  <img \n                    src={selfiePreview} \n                    alt=\"Selfie preview\" \n                    className=\"max-w-[200px] rounded-lg\"\n                    loading=\"lazy\"\n                  />\n                  <Button\n                    size=\"sm\"\n                    variant=\"secondary\"\n                    className=\"absolute -top-2 -right-2\"\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      setSelfieFile(null);\n                      setSelfiePreview(null);\n                    }}\n                  >\n                    Change\n                  </Button>\n                </div>\n              ) : (\n                <>\n                  <Upload className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                  <p className=\"text-sm text-muted-foreground text-center\">\n                    Click to take a selfie or upload a photo\n                  </p>\n                </>\n              )}\n            </div>\n          </CardContent>\n          <CardFooter>\n            <Button \n              className=\"w-full\"\n              disabled={!selfieFile || uploadSelfieMutation.isPending}\n              onClick={handleSubmitSelfie}\n              data-testid=\"button-submit-selfie\"\n            >\n              {uploadSelfieMutation.isPending ? (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              ) : null}\n              Submit for Verification\n            </Button>\n          </CardFooter>\n        </Card>\n      )}\n\n      {step === \"processing\" && (\n        <Card>\n          <CardHeader className=\"text-center\">\n            <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-primary/10\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n            </div>\n            <CardTitle>Verifying Your Identity</CardTitle>\n            <CardDescription>\n              Please wait while we compare your selfie with your NIN photo...\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"text-center\">\n            <Progress value={66} className=\"mb-4\" />\n            <p className=\"text-sm text-muted-foreground\">\n              This usually takes less than a minute\n            </p>\n          </CardContent>\n        </Card>\n      )}\n\n      {step === \"result\" && kycStatus?.status === \"approved\" && (\n        <Card>\n          <CardHeader className=\"text-center\">\n            <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-green-100 dark:bg-green-900\">\n              <CheckCircle2 className=\"h-8 w-8 text-green-600\" />\n            </div>\n            <CardTitle>Verification Successful!</CardTitle>\n            <CardDescription>\n              Your identity has been verified. You now have full access to all platform features.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"text-center space-y-4\">\n            <Badge variant=\"default\" className=\"text-sm\">\n              <Shield className=\"mr-1 h-3 w-3\" />\n              Verified User\n            </Badge>\n            {kycStatus?.similarityScore && (\n              <p className=\"text-sm text-muted-foreground\">\n                Match confidence: {parseFloat(kycStatus.similarityScore).toFixed(1)}%\n              </p>\n            )}\n          </CardContent>\n          <CardFooter className=\"flex gap-2\">\n            <Button variant=\"outline\" className=\"flex-1\" asChild>\n              <a href=\"/profile\">View Profile</a>\n            </Button>\n            <Button className=\"flex-1\" asChild>\n              <a href=\"/products/new\">Start Selling</a>\n            </Button>\n          </CardFooter>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":24808,"size_tokens":null},"client/src/components/SponsoredAdCard.tsx":{"content":"import { useEffect, useRef } from \"react\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ExternalLink, Megaphone } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { SponsoredAd } from \"@shared/schema\";\n\ninterface SponsoredAdCardProps {\n  ad: SponsoredAd;\n  variant?: \"marketplace\" | \"plug\";\n}\n\nexport function SponsoredAdCard({ ad, variant = \"marketplace\" }: SponsoredAdCardProps) {\n  const hasTrackedImpression = useRef(false);\n\n  useEffect(() => {\n    if (!hasTrackedImpression.current) {\n      hasTrackedImpression.current = true;\n      apiRequest(\"POST\", `/api/ads/${ad.id}/impression`).catch(() => {});\n    }\n  }, [ad.id]);\n\n  const handleClick = () => {\n    apiRequest(\"POST\", `/api/ads/${ad.id}/click`).catch(() => {});\n  };\n\n  const destination = ad.productId \n    ? `/products/${ad.productId}` \n    : ad.linkUrl || \"#\";\n\n  const isExternalLink = ad.linkUrl && !ad.productId;\n\n  if (variant === \"plug\") {\n    return (\n      <article \n        className=\"py-4 border-b\"\n        data-testid={`sponsored-ad-plug-${ad.id}`}\n      >\n        <div className=\"flex gap-3\">\n          <div className=\"h-10 w-10 flex-shrink-0 rounded-full bg-primary/10 flex items-center justify-center\">\n            <Megaphone className=\"h-5 w-5 text-primary\" />\n          </div>\n          \n          <div className=\"flex-1 min-w-0\">\n            <div className=\"flex items-center gap-2 mb-1\">\n              <span className=\"font-bold text-sm\">{ad.title}</span>\n              <Badge \n                variant=\"outline\" \n                className=\"text-[10px] px-1.5 py-0 h-4 border-muted-foreground/30 text-muted-foreground font-normal\"\n              >\n                Sponsored\n              </Badge>\n            </div>\n            \n            {ad.description && (\n              <p className=\"text-[15px] leading-relaxed text-foreground whitespace-pre-wrap mb-3\">\n                {ad.description}\n              </p>\n            )}\n            \n            {ad.imageUrl && (\n              <div className=\"mt-3 mb-3 rounded-xl overflow-hidden\">\n                <img\n                  src={ad.imageUrl}\n                  alt={ad.title}\n                  className=\"w-full aspect-video object-cover\"\n                  loading=\"lazy\"\n                />\n              </div>\n            )}\n            \n            {isExternalLink ? (\n              <a \n                href={destination}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                onClick={handleClick}\n                className=\"inline-flex items-center gap-1 text-sm text-primary hover:underline\"\n              >\n                Learn more\n                <ExternalLink className=\"h-3 w-3\" />\n              </a>\n            ) : (\n              <Link \n                href={destination}\n                onClick={handleClick}\n                className=\"inline-flex items-center gap-1 text-sm text-primary hover:underline\"\n              >\n                Learn more\n              </Link>\n            )}\n          </div>\n        </div>\n      </article>\n    );\n  }\n\n  return (\n    <Card \n      className=\"overflow-hidden hover-elevate cursor-pointer group\"\n      data-testid={`sponsored-ad-marketplace-${ad.id}`}\n    >\n      {isExternalLink ? (\n        <a \n          href={destination}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          onClick={handleClick}\n          className=\"block\"\n        >\n          <div className=\"relative\">\n            {ad.imageUrl ? (\n              <img\n                src={ad.imageUrl}\n                alt={ad.title}\n                className=\"aspect-square w-full object-cover transition-transform duration-300 group-hover:scale-[1.02]\"\n                loading=\"lazy\"\n              />\n            ) : (\n              <div className=\"aspect-square w-full bg-muted flex items-center justify-center\">\n                <Megaphone className=\"h-12 w-12 text-muted-foreground/40\" />\n              </div>\n            )}\n            <Badge \n              variant=\"secondary\"\n              className=\"absolute top-2 left-2 text-[10px] px-1.5 py-0 h-5 bg-background/90 backdrop-blur-sm text-muted-foreground font-normal\"\n            >\n              Sponsored\n            </Badge>\n          </div>\n          <CardContent className=\"p-3\">\n            <h3 className=\"font-medium text-sm line-clamp-2 mb-1 group-hover:text-primary transition-colors\">\n              {ad.title}\n            </h3>\n            {ad.description && (\n              <p className=\"text-xs text-muted-foreground line-clamp-2\">\n                {ad.description}\n              </p>\n            )}\n          </CardContent>\n        </a>\n      ) : (\n        <Link \n          href={destination}\n          onClick={handleClick}\n          className=\"block\"\n        >\n          <div className=\"relative\">\n            {ad.imageUrl ? (\n              <img\n                src={ad.imageUrl}\n                alt={ad.title}\n                className=\"aspect-square w-full object-cover transition-transform duration-300 group-hover:scale-[1.02]\"\n                loading=\"lazy\"\n              />\n            ) : (\n              <div className=\"aspect-square w-full bg-muted flex items-center justify-center\">\n                <Megaphone className=\"h-12 w-12 text-muted-foreground/40\" />\n              </div>\n            )}\n            <Badge \n              variant=\"secondary\"\n              className=\"absolute top-2 left-2 text-[10px] px-1.5 py-0 h-5 bg-background/90 backdrop-blur-sm text-muted-foreground font-normal\"\n            >\n              Sponsored\n            </Badge>\n          </div>\n          <CardContent className=\"p-3\">\n            <h3 className=\"font-medium text-sm line-clamp-2 mb-1 group-hover:text-primary transition-colors\">\n              {ad.title}\n            </h3>\n            {ad.description && (\n              <p className=\"text-xs text-muted-foreground line-clamp-2\">\n                {ad.description}\n              </p>\n            )}\n          </CardContent>\n        </Link>\n      )}\n    </Card>\n  );\n}\n","path":null,"size_bytes":6121,"size_tokens":null},"server/email.ts":{"content":"import { Resend } from 'resend';\n\nconst RESEND_API_KEY = process.env.RESEND_API_KEY;\nconst FROM_EMAIL = process.env.FROM_EMAIL || 'no-reply@eksuplug.com.ng';\nconst APP_NAME = process.env.APP_NAME || 'EKSU Plug';\n\nlet resend: Resend | null = null;\n\nexport function isResendConfigured(): boolean {\n  return !!RESEND_API_KEY;\n}\n\nfunction getResendClient(): Resend | null {\n  if (!RESEND_API_KEY) {\n    return null;\n  }\n  if (!resend) {\n    resend = new Resend(RESEND_API_KEY);\n  }\n  return resend;\n}\n\nfunction logWarning(functionName: string): void {\n  console.warn(`[Email] ${functionName}: RESEND_API_KEY not configured. Email not sent.`);\n}\n\nfunction logError(functionName: string, error: any): void {\n  console.error(`[Email] ${functionName} failed:`, error?.message || error);\n}\n\nfunction logSuccess(functionName: string, to: string): void {\n  console.log(`[Email] ${functionName}: Email sent successfully to ${to}`);\n}\n\nexport interface OrderDetails {\n  orderId: string;\n  productName: string;\n  quantity: number;\n  totalAmount: string;\n  sellerName: string;\n  deliveryAddress?: string;\n  estimatedDelivery?: string;\n}\n\nexport interface EmailResult {\n  success: boolean;\n  messageId?: string;\n  error?: string;\n}\n\nexport async function sendWelcomeEmail(\n  email: string,\n  firstName: string\n): Promise<EmailResult> {\n  const client = getResendClient();\n  \n  if (!client) {\n    logWarning('sendWelcomeEmail');\n    return { success: false, error: 'Resend not configured' };\n  }\n\n  try {\n    const { data, error } = await client.emails.send({\n      from: FROM_EMAIL,\n      to: email,\n      subject: `Welcome to ${APP_NAME}! 🎉`,\n      html: `\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px 10px 0 0; text-align: center;\">\n            <h1 style=\"color: white; margin: 0; font-size: 28px;\">Welcome to ${APP_NAME}!</h1>\n          </div>\n          <div style=\"background: #ffffff; padding: 30px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 10px 10px;\">\n            <p style=\"font-size: 18px; margin-top: 0;\">Hey ${firstName}! 👋</p>\n            <p>We're thrilled to have you join our campus marketplace community. Here's what you can do:</p>\n            <ul style=\"padding-left: 20px;\">\n              <li><strong>Buy & Sell:</strong> List your items or discover deals from fellow students</li>\n              <li><strong>Safe Transactions:</strong> Use our secure escrow system for peace of mind</li>\n              <li><strong>Connect:</strong> Chat with buyers and sellers directly in the app</li>\n              <li><strong>Earn Rewards:</strong> Refer friends and earn bonus credits</li>\n            </ul>\n            <div style=\"text-align: center; margin: 30px 0;\">\n              <a href=\"${process.env.APP_URL || 'https://eksu-marketplace.com'}\" style=\"display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; font-size: 16px;\">Start Exploring</a>\n            </div>\n            <p style=\"color: #666; font-size: 14px;\">Need help? Reply to this email or visit our support page.</p>\n            <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;\">\n            <p style=\"color: #999; font-size: 12px; text-align: center; margin: 0;\">\n              © ${new Date().getFullYear()} ${APP_NAME}. All rights reserved.\n            </p>\n          </div>\n        </body>\n        </html>\n      `,\n    });\n\n    if (error) {\n      logError('sendWelcomeEmail', error);\n      return { success: false, error: error.message };\n    }\n\n    logSuccess('sendWelcomeEmail', email);\n    return { success: true, messageId: data?.id };\n  } catch (error: any) {\n    logError('sendWelcomeEmail', error);\n    return { success: false, error: error?.message || 'Unknown error' };\n  }\n}\n\nexport async function sendOrderConfirmationEmail(\n  email: string,\n  orderDetails: OrderDetails\n): Promise<EmailResult> {\n  const client = getResendClient();\n  \n  if (!client) {\n    logWarning('sendOrderConfirmationEmail');\n    return { success: false, error: 'Resend not configured' };\n  }\n\n  try {\n    const { data, error } = await client.emails.send({\n      from: FROM_EMAIL,\n      to: email,\n      subject: `Order Confirmed - ${orderDetails.orderId}`,\n      html: `\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <div style=\"background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 10px 10px 0 0; text-align: center;\">\n            <h1 style=\"color: white; margin: 0; font-size: 28px;\">Order Confirmed! ✅</h1>\n          </div>\n          <div style=\"background: #ffffff; padding: 30px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 10px 10px;\">\n            <p style=\"font-size: 16px; margin-top: 0;\">Your order has been placed successfully!</p>\n            \n            <div style=\"background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0;\">\n              <h3 style=\"margin-top: 0; color: #374151;\">Order Details</h3>\n              <table style=\"width: 100%; border-collapse: collapse;\">\n                <tr>\n                  <td style=\"padding: 8px 0; color: #6b7280;\">Order ID:</td>\n                  <td style=\"padding: 8px 0; font-weight: bold;\">${orderDetails.orderId}</td>\n                </tr>\n                <tr>\n                  <td style=\"padding: 8px 0; color: #6b7280;\">Product:</td>\n                  <td style=\"padding: 8px 0;\">${orderDetails.productName}</td>\n                </tr>\n                <tr>\n                  <td style=\"padding: 8px 0; color: #6b7280;\">Quantity:</td>\n                  <td style=\"padding: 8px 0;\">${orderDetails.quantity}</td>\n                </tr>\n                <tr>\n                  <td style=\"padding: 8px 0; color: #6b7280;\">Seller:</td>\n                  <td style=\"padding: 8px 0;\">${orderDetails.sellerName}</td>\n                </tr>\n                ${orderDetails.deliveryAddress ? `\n                <tr>\n                  <td style=\"padding: 8px 0; color: #6b7280;\">Delivery To:</td>\n                  <td style=\"padding: 8px 0;\">${orderDetails.deliveryAddress}</td>\n                </tr>\n                ` : ''}\n                ${orderDetails.estimatedDelivery ? `\n                <tr>\n                  <td style=\"padding: 8px 0; color: #6b7280;\">Est. Delivery:</td>\n                  <td style=\"padding: 8px 0;\">${orderDetails.estimatedDelivery}</td>\n                </tr>\n                ` : ''}\n              </table>\n              <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 15px 0;\">\n              <table style=\"width: 100%;\">\n                <tr>\n                  <td style=\"font-size: 18px; font-weight: bold;\">Total:</td>\n                  <td style=\"font-size: 18px; font-weight: bold; text-align: right; color: #059669;\">₦${orderDetails.totalAmount}</td>\n                </tr>\n              </table>\n            </div>\n\n            <p style=\"color: #666; font-size: 14px;\">\n              Your payment is held securely in escrow until you confirm receipt of your item.\n            </p>\n            \n            <div style=\"text-align: center; margin: 30px 0;\">\n              <a href=\"${process.env.APP_URL || 'https://eksu-marketplace.com'}/messages\" style=\"display: inline-block; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; font-size: 16px;\">Contact Seller</a>\n            </div>\n\n            <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;\">\n            <p style=\"color: #999; font-size: 12px; text-align: center; margin: 0;\">\n              © ${new Date().getFullYear()} ${APP_NAME}. All rights reserved.\n            </p>\n          </div>\n        </body>\n        </html>\n      `,\n    });\n\n    if (error) {\n      logError('sendOrderConfirmationEmail', error);\n      return { success: false, error: error.message };\n    }\n\n    logSuccess('sendOrderConfirmationEmail', email);\n    return { success: true, messageId: data?.id };\n  } catch (error: any) {\n    logError('sendOrderConfirmationEmail', error);\n    return { success: false, error: error?.message || 'Unknown error' };\n  }\n}\n\nexport async function sendVerificationStatusEmail(\n  email: string,\n  status: 'approved' | 'rejected' | 'pending',\n  reason?: string\n): Promise<EmailResult> {\n  const client = getResendClient();\n  \n  if (!client) {\n    logWarning('sendVerificationStatusEmail');\n    return { success: false, error: 'Resend not configured' };\n  }\n\n  const statusConfig = {\n    approved: {\n      color: '#10b981',\n      gradient: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',\n      icon: '✅',\n      title: 'Verification Approved!',\n      message: 'Congratulations! Your account has been verified. You now have access to all features and a verified badge on your profile.',\n    },\n    rejected: {\n      color: '#ef4444',\n      gradient: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',\n      icon: '❌',\n      title: 'Verification Not Approved',\n      message: 'Unfortunately, we were unable to verify your account at this time.',\n    },\n    pending: {\n      color: '#f59e0b',\n      gradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',\n      icon: '⏳',\n      title: 'Verification In Progress',\n      message: 'Your verification documents have been received and are being reviewed. This usually takes 1-2 business days.',\n    },\n  };\n\n  const config = statusConfig[status];\n\n  try {\n    const { data, error } = await client.emails.send({\n      from: FROM_EMAIL,\n      to: email,\n      subject: `${config.icon} ${config.title}`,\n      html: `\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <div style=\"background: ${config.gradient}; padding: 30px; border-radius: 10px 10px 0 0; text-align: center;\">\n            <h1 style=\"color: white; margin: 0; font-size: 28px;\">${config.title}</h1>\n          </div>\n          <div style=\"background: #ffffff; padding: 30px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 10px 10px;\">\n            <p style=\"font-size: 16px; margin-top: 0;\">${config.message}</p>\n            \n            ${reason ? `\n            <div style=\"background: #fef2f2; border-left: 4px solid ${config.color}; padding: 15px; margin: 20px 0; border-radius: 0 8px 8px 0;\">\n              <strong>Reason:</strong>\n              <p style=\"margin: 5px 0 0 0;\">${reason}</p>\n            </div>\n            ` : ''}\n            \n            ${status === 'rejected' ? `\n            <p style=\"color: #666; font-size: 14px;\">\n              You can resubmit your verification documents after addressing the issues mentioned above.\n            </p>\n            <div style=\"text-align: center; margin: 30px 0;\">\n              <a href=\"${process.env.APP_URL || 'https://eksu-marketplace.com'}/kyc\" style=\"display: inline-block; background: ${config.gradient}; color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; font-size: 16px;\">Resubmit Documents</a>\n            </div>\n            ` : ''}\n            \n            ${status === 'approved' ? `\n            <div style=\"text-align: center; margin: 30px 0;\">\n              <a href=\"${process.env.APP_URL || 'https://eksu-marketplace.com'}/profile\" style=\"display: inline-block; background: ${config.gradient}; color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; font-size: 16px;\">View Your Profile</a>\n            </div>\n            ` : ''}\n\n            <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;\">\n            <p style=\"color: #999; font-size: 12px; text-align: center; margin: 0;\">\n              © ${new Date().getFullYear()} ${APP_NAME}. All rights reserved.\n            </p>\n          </div>\n        </body>\n        </html>\n      `,\n    });\n\n    if (error) {\n      logError('sendVerificationStatusEmail', error);\n      return { success: false, error: error.message };\n    }\n\n    logSuccess('sendVerificationStatusEmail', email);\n    return { success: true, messageId: data?.id };\n  } catch (error: any) {\n    logError('sendVerificationStatusEmail', error);\n    return { success: false, error: error?.message || 'Unknown error' };\n  }\n}\n\nexport async function sendNewMessageNotification(\n  email: string,\n  senderName: string\n): Promise<EmailResult> {\n  const client = getResendClient();\n  \n  if (!client) {\n    logWarning('sendNewMessageNotification');\n    return { success: false, error: 'Resend not configured' };\n  }\n\n  try {\n    const { data, error } = await client.emails.send({\n      from: FROM_EMAIL,\n      to: email,\n      subject: `💬 New message from ${senderName}`,\n      html: `\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        </head>\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <div style=\"background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); padding: 30px; border-radius: 10px 10px 0 0; text-align: center;\">\n            <h1 style=\"color: white; margin: 0; font-size: 28px;\">New Message 💬</h1>\n          </div>\n          <div style=\"background: #ffffff; padding: 30px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 10px 10px;\">\n            <p style=\"font-size: 18px; margin-top: 0;\">You have a new message!</p>\n            \n            <div style=\"background: #f0f9ff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #3b82f6;\">\n              <p style=\"margin: 0; font-size: 16px;\">\n                <strong>${senderName}</strong> sent you a message on ${APP_NAME}.\n              </p>\n            </div>\n\n            <p style=\"color: #666; font-size: 14px;\">\n              Log in to view and reply to your message. Quick responses help build trust with buyers and sellers!\n            </p>\n            \n            <div style=\"text-align: center; margin: 30px 0;\">\n              <a href=\"${process.env.APP_URL || 'https://eksu-marketplace.com'}/messages\" style=\"display: inline-block; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; font-size: 16px;\">View Message</a>\n            </div>\n\n            <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;\">\n            <p style=\"color: #999; font-size: 12px; text-align: center; margin: 0;\">\n              You're receiving this because you have email notifications enabled.<br>\n              <a href=\"${process.env.APP_URL || 'https://eksu-marketplace.com'}/settings\" style=\"color: #3b82f6; text-decoration: none;\">Manage notification preferences</a>\n            </p>\n            <p style=\"color: #999; font-size: 12px; text-align: center; margin: 10px 0 0 0;\">\n              © ${new Date().getFullYear()} ${APP_NAME}. All rights reserved.\n            </p>\n          </div>\n        </body>\n        </html>\n      `,\n    });\n\n    if (error) {\n      logError('sendNewMessageNotification', error);\n      return { success: false, error: error.message };\n    }\n\n    logSuccess('sendNewMessageNotification', email);\n    return { success: true, messageId: data?.id };\n  } catch (error: any) {\n    logError('sendNewMessageNotification', error);\n    return { success: false, error: error?.message || 'Unknown error' };\n  }\n}\n","path":null,"size_bytes":16746,"size_tokens":null},"client/src/lib/distance.ts":{"content":"/**\n * Calculate the distance between two geographic coordinates using the Haversine formula\n * @param lat1 - Latitude of point 1 in decimal degrees\n * @param lon1 - Longitude of point 1 in decimal degrees\n * @param lat2 - Latitude of point 2 in decimal degrees\n * @param lon2 - Longitude of point 2 in decimal degrees\n * @returns Distance in kilometers\n */\nexport function calculateDistance(\n  lat1: number,\n  lon1: number,\n  lat2: number,\n  lon2: number\n): number {\n  const R = 6371; // Earth's radius in kilometers\n  \n  // Convert degrees to radians\n  const toRad = (deg: number) => deg * (Math.PI / 180);\n  \n  const dLat = toRad(lat2 - lat1);\n  const dLon = toRad(lon2 - lon1);\n  \n  const a =\n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *\n    Math.sin(dLon / 2) * Math.sin(dLon / 2);\n  \n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  \n  return R * c;\n}\n\n/**\n * Format distance for display\n * @param distanceInKm - Distance in kilometers\n * @returns Formatted string (e.g., \"2.3km\" or \"500m\")\n */\nexport function formatDistance(distanceInKm: number): string {\n  if (distanceInKm < 0.1) {\n    // Less than 100m, show in meters\n    const meters = Math.round(distanceInKm * 1000);\n    return `${meters}m`;\n  } else if (distanceInKm < 1) {\n    // Less than 1km, show in meters\n    const meters = Math.round(distanceInKm * 1000);\n    return `${meters}m`;\n  } else if (distanceInKm < 10) {\n    // Less than 10km, show with 1 decimal\n    return `${distanceInKm.toFixed(1)}km`;\n  } else {\n    // 10+ km, show whole number\n    return `${Math.round(distanceInKm)}km`;\n  }\n}\n\n/**\n * Calculate and format distance between two coordinates\n * @param buyerLat - Buyer's latitude\n * @param buyerLon - Buyer's longitude\n * @param sellerLat - Seller's latitude\n * @param sellerLon - Seller's longitude\n * @returns Formatted distance string or null if coordinates are invalid\n */\nexport function getDistanceDisplay(\n  buyerLat: number | string | null | undefined,\n  buyerLon: number | string | null | undefined,\n  sellerLat: number | string | null | undefined,\n  sellerLon: number | string | null | undefined\n): string | null {\n  // Parse coordinates, handling both number and string types\n  const parsedBuyerLat = typeof buyerLat === 'string' ? parseFloat(buyerLat) : buyerLat;\n  const parsedBuyerLon = typeof buyerLon === 'string' ? parseFloat(buyerLon) : buyerLon;\n  const parsedSellerLat = typeof sellerLat === 'string' ? parseFloat(sellerLat) : sellerLat;\n  const parsedSellerLon = typeof sellerLon === 'string' ? parseFloat(sellerLon) : sellerLon;\n\n  // Check if all coordinates are valid numbers\n  if (\n    parsedBuyerLat == null || isNaN(parsedBuyerLat) ||\n    parsedBuyerLon == null || isNaN(parsedBuyerLon) ||\n    parsedSellerLat == null || isNaN(parsedSellerLat) ||\n    parsedSellerLon == null || isNaN(parsedSellerLon)\n  ) {\n    return null;\n  }\n\n  const distance = calculateDistance(\n    parsedBuyerLat,\n    parsedBuyerLon,\n    parsedSellerLat,\n    parsedSellerLon\n  );\n\n  return formatDistance(distance);\n}\n","path":null,"size_bytes":3072,"size_tokens":null},"client/src/pages/kyc-verification.tsx":{"content":"import { useState, useRef, useCallback, useEffect } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport {\n  Camera,\n  Check,\n  X,\n  ChevronRight,\n  Loader2,\n  Shield,\n  AlertTriangle,\n  RefreshCw,\n  User,\n  Phone,\n  Calendar,\n  FileText,\n  CreditCard,\n  BadgeCheck,\n} from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle, CardFooter } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Label } from \"@/components/ui/label\";\n\nconst kycFormSchema = z.object({\n  fullName: z.string().min(3, \"Full name must be at least 3 characters\"),\n  dateOfBirth: z.string().min(1, \"Date of birth is required\"),\n  nin: z.string().length(11, \"NIN must be exactly 11 digits\").regex(/^\\d+$/, \"NIN must contain only numbers\"),\n  phoneNumber: z.string().min(10, \"Phone number must be at least 10 digits\").regex(/^\\d+$/, \"Phone number must contain only numbers\"),\n});\n\ntype KycFormData = z.infer<typeof kycFormSchema>;\n\nconst LIVENESS_PROMPTS = [\n  \"Please blink your eyes\",\n  \"Turn your head slightly to the left\",\n  \"Turn your head slightly to the right\",\n  \"Look up briefly\",\n  \"Smile naturally\",\n];\n\nexport default function KYCVerification() {\n  const { toast } = useToast();\n  const [step, setStep] = useState<1 | 2 | 3 | 4 | 5 | 6>(1);\n  const [termsAccepted, setTermsAccepted] = useState(false);\n  const [capturedImage, setCapturedImage] = useState<string | null>(null);\n  const [isProcessingPayment, setIsProcessingPayment] = useState(false);\n  const [isVerifying, setIsVerifying] = useState(false);\n  const [verificationResult, setVerificationResult] = useState<\"success\" | \"failure\" | null>(null);\n  const [cameraError, setCameraError] = useState<string | null>(null);\n  const [isCameraReady, setIsCameraReady] = useState(false);\n  const [currentLivenessPrompt, setCurrentLivenessPrompt] = useState(0);\n  const [livenessChecked, setLivenessChecked] = useState(false);\n  \n  const videoRef = useRef<HTMLVideoElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const streamRef = useRef<MediaStream | null>(null);\n\n  const form = useForm<KycFormData>({\n    resolver: zodResolver(kycFormSchema),\n    defaultValues: {\n      fullName: \"\",\n      dateOfBirth: \"\",\n      nin: \"\",\n      phoneNumber: \"\",\n    },\n  });\n\n  const getProgressValue = () => {\n    switch (step) {\n      case 1: return 0;\n      case 2: return 20;\n      case 3: return 40;\n      case 4: return 60;\n      case 5: return 80;\n      case 6: return 100;\n      default: return 0;\n    }\n  };\n\n  const startCamera = useCallback(async () => {\n    setCameraError(null);\n    setIsCameraReady(false);\n\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({\n        video: {\n          facingMode: \"user\",\n          width: { ideal: 640 },\n          height: { ideal: 480 },\n        },\n        audio: false,\n      });\n\n      streamRef.current = stream;\n\n      if (videoRef.current) {\n        videoRef.current.srcObject = stream;\n        videoRef.current.onloadedmetadata = () => {\n          videoRef.current?.play();\n          setIsCameraReady(true);\n        };\n      }\n    } catch (error) {\n      console.error(\"Camera access error:\", error);\n      if (error instanceof DOMException) {\n        if (error.name === \"NotAllowedError\") {\n          setCameraError(\"Camera access was denied. Please allow camera access in your browser settings and try again.\");\n        } else if (error.name === \"NotFoundError\") {\n          setCameraError(\"No camera found. Please connect a camera and try again.\");\n        } else if (error.name === \"NotReadableError\") {\n          setCameraError(\"Camera is in use by another application. Please close other apps using the camera and try again.\");\n        } else {\n          setCameraError(\"Failed to access camera. Please try again.\");\n        }\n      } else {\n        setCameraError(\"An unexpected error occurred while accessing the camera.\");\n      }\n    }\n  }, []);\n\n  const stopCamera = useCallback(() => {\n    if (streamRef.current) {\n      streamRef.current.getTracks().forEach((track) => track.stop());\n      streamRef.current = null;\n    }\n    if (videoRef.current) {\n      videoRef.current.srcObject = null;\n    }\n    setIsCameraReady(false);\n  }, []);\n\n  const capturePhoto = useCallback(() => {\n    if (!videoRef.current || !canvasRef.current) return;\n\n    const video = videoRef.current;\n    const canvas = canvasRef.current;\n    const context = canvas.getContext(\"2d\");\n\n    if (!context) return;\n\n    canvas.width = video.videoWidth;\n    canvas.height = video.videoHeight;\n\n    context.drawImage(video, 0, 0, canvas.width, canvas.height);\n\n    const imageDataUrl = canvas.toDataURL(\"image/jpeg\", 0.8);\n    setCapturedImage(imageDataUrl);\n\n    stopCamera();\n  }, [stopCamera]);\n\n  const retakePhoto = useCallback(() => {\n    setCapturedImage(null);\n    setLivenessChecked(false);\n    setCurrentLivenessPrompt(0);\n    startCamera();\n  }, [startCamera]);\n\n  useEffect(() => {\n    if (step === 4 && !capturedImage) {\n      startCamera();\n    }\n\n    return () => {\n      if (step !== 4) {\n        stopCamera();\n      }\n    };\n  }, [step, capturedImage, startCamera, stopCamera]);\n\n  useEffect(() => {\n    if (step === 4 && isCameraReady && !capturedImage && !livenessChecked) {\n      const interval = setInterval(() => {\n        setCurrentLivenessPrompt((prev) => {\n          const next = prev + 1;\n          if (next >= LIVENESS_PROMPTS.length) {\n            setLivenessChecked(true);\n            clearInterval(interval);\n            return prev;\n          }\n          return next;\n        });\n      }, 2500);\n\n      return () => clearInterval(interval);\n    }\n  }, [step, isCameraReady, capturedImage, livenessChecked]);\n\n  const handleTermsAccept = () => {\n    if (!termsAccepted) {\n      toast({\n        title: \"Terms Required\",\n        description: \"Please accept the terms and conditions to continue.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setStep(2);\n  };\n\n  const handleInfoSubmit = (data: KycFormData) => {\n    setStep(3);\n  };\n\n  const handlePayment = async () => {\n    setIsProcessingPayment(true);\n    \n    await new Promise((resolve) => setTimeout(resolve, 2000));\n    \n    setIsProcessingPayment(false);\n    toast({\n      title: \"Payment Successful\",\n      description: \"Your payment of ₦500 has been processed.\",\n    });\n    setStep(4);\n  };\n\n  const handleSubmitSelfie = async () => {\n    if (!capturedImage) {\n      toast({\n        title: \"Photo Required\",\n        description: \"Please capture a photo before submitting.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setStep(5);\n    setIsVerifying(true);\n\n    await new Promise((resolve) => setTimeout(resolve, 2000));\n\n    setIsVerifying(false);\n    setVerificationResult(\"success\");\n    setStep(6);\n  };\n\n  const handleRetry = () => {\n    setStep(1);\n    setTermsAccepted(false);\n    setCapturedImage(null);\n    setVerificationResult(null);\n    setLivenessChecked(false);\n    setCurrentLivenessPrompt(0);\n    form.reset();\n  };\n\n  return (\n    <div className=\"container mx-auto max-w-2xl px-4 py-6 pb-24\">\n      <div className=\"mb-6\">\n        <div className=\"flex items-center gap-2 mb-1\">\n          <Shield className=\"h-6 w-6 text-primary\" />\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-kyc-verification-title\">\n            Identity Verification\n          </h1>\n        </div>\n        <p className=\"text-muted-foreground\">\n          Complete verification to unlock all platform features\n        </p>\n      </div>\n\n      <div className=\"mb-6\">\n        <Progress value={getProgressValue()} className=\"h-2\" />\n        <div className=\"mt-2 flex justify-between text-xs text-muted-foreground\">\n          <span>Terms</span>\n          <span>Info</span>\n          <span>Payment</span>\n          <span>Selfie</span>\n          <span>Verify</span>\n          <span>Done</span>\n        </div>\n      </div>\n\n      {step === 1 && (\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center gap-2\">\n              <FileText className=\"h-5 w-5 text-primary\" />\n              <CardTitle>Terms & Conditions</CardTitle>\n            </div>\n            <CardDescription>\n              Please read and accept the terms to proceed with verification\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"rounded-md border p-4 max-h-64 overflow-y-auto text-sm space-y-3\">\n              <h3 className=\"font-semibold\">Identity Verification Terms</h3>\n              <p>\n                By proceeding with identity verification, you agree to the following terms:\n              </p>\n              <ul className=\"list-disc pl-5 space-y-2\">\n                <li>\n                  <strong>Data Collection:</strong> We will collect your National Identification Number (NIN), \n                  date of birth, phone number, and a selfie photograph for verification purposes.\n                </li>\n                <li>\n                  <strong>Data Usage:</strong> Your information will be used solely for identity verification \n                  and fraud prevention on our platform.\n                </li>\n                <li>\n                  <strong>Data Security:</strong> All collected data is encrypted and stored securely. \n                  Your selfie and NIN details will be deleted within 24 hours after verification.\n                </li>\n                <li>\n                  <strong>Third-Party Processing:</strong> We may use secure third-party services to \n                  process and verify your identity documents.\n                </li>\n                <li>\n                  <strong>Verification Fee:</strong> A non-refundable fee of ₦500 is required to process \n                  your verification. If verification fails due to system error, a full refund will be issued.\n                </li>\n                <li>\n                  <strong>Accuracy:</strong> You confirm that all information provided is accurate and \n                  belongs to you. Providing false information may result in account suspension.\n                </li>\n                <li>\n                  <strong>Consent:</strong> You consent to the capture and processing of your biometric \n                  data (facial features) for liveness detection and identity matching.\n                </li>\n              </ul>\n              <p className=\"text-muted-foreground\">\n                By checking the box below, you acknowledge that you have read, understood, and agree \n                to these terms and conditions.\n              </p>\n            </div>\n\n            <div className=\"flex items-start space-x-3 rounded-md border p-4\">\n              <Checkbox\n                id=\"terms\"\n                checked={termsAccepted}\n                onCheckedChange={(checked) => setTermsAccepted(checked === true)}\n                data-testid=\"checkbox-terms\"\n              />\n              <div className=\"space-y-1 leading-none\">\n                <Label htmlFor=\"terms\" className=\"cursor-pointer\">\n                  I have read and agree to the Terms & Conditions\n                </Label>\n                <p className=\"text-xs text-muted-foreground\">\n                  You must accept the terms to proceed with verification\n                </p>\n              </div>\n            </div>\n          </CardContent>\n          <CardFooter>\n            <Button\n              className=\"w-full\"\n              onClick={handleTermsAccept}\n              disabled={!termsAccepted}\n              data-testid=\"button-terms-continue\"\n            >\n              Continue\n              <ChevronRight className=\"ml-2 h-4 w-4\" />\n            </Button>\n          </CardFooter>\n        </Card>\n      )}\n\n      {step === 2 && (\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center gap-2\">\n              <User className=\"h-5 w-5 text-primary\" />\n              <CardTitle>Personal Information</CardTitle>\n            </div>\n            <CardDescription>\n              Enter your details exactly as they appear on your NIN document\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(handleInfoSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"fullName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"flex items-center gap-2\">\n                        <User className=\"h-4 w-4\" />\n                        Full Name\n                      </FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder=\"Enter your full name\"\n                          {...field}\n                          data-testid=\"input-full-name\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"dateOfBirth\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"flex items-center gap-2\">\n                        <Calendar className=\"h-4 w-4\" />\n                        Date of Birth\n                      </FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"date\"\n                          {...field}\n                          data-testid=\"input-date-of-birth\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"nin\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"flex items-center gap-2\">\n                        <FileText className=\"h-4 w-4\" />\n                        NIN (11 digits)\n                      </FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder=\"Enter your 11-digit NIN\"\n                          maxLength={11}\n                          {...field}\n                          data-testid=\"input-nin\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"phoneNumber\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"flex items-center gap-2\">\n                        <Phone className=\"h-4 w-4\" />\n                        Phone Number\n                      </FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder=\"Enter your phone number\"\n                          maxLength={15}\n                          {...field}\n                          data-testid=\"input-phone-number\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <Button type=\"submit\" className=\"w-full\" data-testid=\"button-info-continue\">\n                  Continue\n                  <ChevronRight className=\"ml-2 h-4 w-4\" />\n                </Button>\n              </form>\n            </Form>\n          </CardContent>\n        </Card>\n      )}\n\n      {step === 3 && (\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center gap-2\">\n              <CreditCard className=\"h-5 w-5 text-primary\" />\n              <CardTitle>Verification Payment</CardTitle>\n            </div>\n            <CardDescription>\n              A one-time fee is required to process your verification\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"rounded-md border p-4 space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-muted-foreground\">Verification Fee</span>\n                <span className=\"text-xl font-bold\">₦500</span>\n              </div>\n              <div className=\"text-sm text-muted-foreground\">\n                This fee covers:\n                <ul className=\"list-disc pl-5 mt-2 space-y-1\">\n                  <li>NIN verification processing</li>\n                  <li>Biometric face matching</li>\n                  <li>Liveness detection check</li>\n                  <li>Verified badge on your profile</li>\n                </ul>\n              </div>\n            </div>\n\n            <Alert>\n              <Shield className=\"h-4 w-4\" />\n              <AlertTitle>Secure Payment</AlertTitle>\n              <AlertDescription>\n                Your payment is processed securely through PayStack. We do not store your card details.\n              </AlertDescription>\n            </Alert>\n          </CardContent>\n          <CardFooter>\n            <Button\n              className=\"w-full\"\n              onClick={handlePayment}\n              disabled={isProcessingPayment}\n              data-testid=\"button-pay\"\n            >\n              {isProcessingPayment ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Processing Payment...\n                </>\n              ) : (\n                <>\n                  <CreditCard className=\"mr-2 h-4 w-4\" />\n                  Pay ₦500\n                </>\n              )}\n            </Button>\n          </CardFooter>\n        </Card>\n      )}\n\n      {step === 4 && (\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center gap-2\">\n              <Camera className=\"h-5 w-5 text-primary\" />\n              <CardTitle>Capture Selfie</CardTitle>\n            </div>\n            <CardDescription>\n              Take a clear photo of your face for identity verification\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {cameraError ? (\n              <Alert variant=\"destructive\">\n                <AlertTriangle className=\"h-4 w-4\" />\n                <AlertTitle>Camera Error</AlertTitle>\n                <AlertDescription>{cameraError}</AlertDescription>\n              </Alert>\n            ) : null}\n\n            {!capturedImage && !cameraError && (\n              <Alert>\n                <Camera className=\"h-4 w-4\" />\n                <AlertTitle>Photo Tips</AlertTitle>\n                <AlertDescription>\n                  <ul className=\"list-disc pl-4 mt-1 text-sm\">\n                    <li>Ensure good lighting on your face</li>\n                    <li>Look directly at the camera</li>\n                    <li>Remove glasses or face coverings</li>\n                    <li>Keep a neutral expression</li>\n                  </ul>\n                </AlertDescription>\n              </Alert>\n            )}\n\n            <div className=\"flex flex-col items-center space-y-4\">\n              {!capturedImage ? (\n                <>\n                  <div\n                    className=\"relative w-64 h-64 rounded-full overflow-hidden border-4 border-primary bg-muted flex items-center justify-center\"\n                    data-testid=\"camera-container\"\n                  >\n                    <video\n                      ref={videoRef}\n                      autoPlay\n                      playsInline\n                      muted\n                      className=\"w-full h-full object-cover\"\n                      data-testid=\"video-camera-feed\"\n                    />\n                    {!isCameraReady && !cameraError && (\n                      <div className=\"absolute inset-0 flex items-center justify-center bg-background/80\">\n                        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n                      </div>\n                    )}\n                  </div>\n\n                  {isCameraReady && !livenessChecked && (\n                    <div className=\"text-center p-3 rounded-md bg-primary/10 border border-primary/20\">\n                      <p className=\"text-sm font-medium text-primary\" data-testid=\"text-liveness-prompt\">\n                        {LIVENESS_PROMPTS[currentLivenessPrompt]}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Follow the prompts for liveness detection\n                      </p>\n                    </div>\n                  )}\n\n                  {livenessChecked && (\n                    <div className=\"text-center p-3 rounded-md bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-800\">\n                      <p className=\"text-sm font-medium text-green-700 dark:text-green-400 flex items-center justify-center gap-2\">\n                        <Check className=\"h-4 w-4\" />\n                        Liveness check complete\n                      </p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        You can now capture your photo\n                      </p>\n                    </div>\n                  )}\n\n                  <Button\n                    onClick={capturePhoto}\n                    disabled={!isCameraReady || !livenessChecked}\n                    data-testid=\"button-capture-photo\"\n                  >\n                    <Camera className=\"mr-2 h-4 w-4\" />\n                    Capture Photo\n                  </Button>\n\n                  {cameraError && (\n                    <Button\n                      variant=\"outline\"\n                      onClick={startCamera}\n                      data-testid=\"button-retry-camera\"\n                    >\n                      <RefreshCw className=\"mr-2 h-4 w-4\" />\n                      Try Again\n                    </Button>\n                  )}\n                </>\n              ) : (\n                <>\n                  <div className=\"relative w-64 h-64 rounded-full overflow-hidden border-4 border-green-500\">\n                    <img\n                      src={capturedImage}\n                      alt=\"Captured selfie\"\n                      className=\"w-full h-full object-cover\"\n                      loading=\"lazy\"\n                      data-testid=\"img-captured-selfie\"\n                    />\n                    <div className=\"absolute top-2 right-2 bg-green-500 text-white rounded-full p-1\">\n                      <Check className=\"h-4 w-4\" />\n                    </div>\n                  </div>\n\n                  <p className=\"text-sm text-muted-foreground text-center\">\n                    Photo captured successfully. Review and submit or retake.\n                  </p>\n\n                  <div className=\"flex gap-3\">\n                    <Button\n                      variant=\"outline\"\n                      onClick={retakePhoto}\n                      data-testid=\"button-retake\"\n                    >\n                      <RefreshCw className=\"mr-2 h-4 w-4\" />\n                      Retake\n                    </Button>\n                    <Button\n                      onClick={handleSubmitSelfie}\n                      data-testid=\"button-submit-selfie\"\n                    >\n                      <Check className=\"mr-2 h-4 w-4\" />\n                      Submit\n                    </Button>\n                  </div>\n                </>\n              )}\n            </div>\n\n            <canvas ref={canvasRef} className=\"hidden\" />\n          </CardContent>\n        </Card>\n      )}\n\n      {step === 5 && (\n        <Card>\n          <CardHeader className=\"text-center\">\n            <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-primary/10\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n            </div>\n            <CardTitle>Verifying Your Identity</CardTitle>\n            <CardDescription>\n              Please wait while we process your verification...\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n                <span data-testid=\"text-verifying-status\">Analyzing facial features...</span>\n              </div>\n            </div>\n\n            <Alert>\n              <Shield className=\"h-4 w-4\" />\n              <AlertTitle>Secure Processing</AlertTitle>\n              <AlertDescription>\n                Your data is being processed securely. This usually takes a few seconds.\n              </AlertDescription>\n            </Alert>\n          </CardContent>\n        </Card>\n      )}\n\n      {step === 6 && (\n        <Card>\n          <CardHeader className=\"text-center\">\n            {verificationResult === \"success\" ? (\n              <>\n                <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/30\">\n                  <BadgeCheck className=\"h-8 w-8 text-green-600\" />\n                </div>\n                <CardTitle data-testid=\"text-verification-success\">\n                  Verification Successful!\n                </CardTitle>\n                <CardDescription>\n                  Your identity has been verified successfully\n                </CardDescription>\n              </>\n            ) : (\n              <>\n                <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/30\">\n                  <X className=\"h-8 w-8 text-red-600\" />\n                </div>\n                <CardTitle data-testid=\"text-verification-failure\">\n                  Verification Failed\n                </CardTitle>\n                <CardDescription>\n                  We couldn't verify your identity\n                </CardDescription>\n              </>\n            )}\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {verificationResult === \"success\" ? (\n              <>\n                <div className=\"text-center\">\n                  <Badge variant=\"default\" className=\"text-sm\">\n                    <Shield className=\"mr-1 h-3 w-3\" />\n                    Verified User\n                  </Badge>\n                </div>\n\n                <div className=\"rounded-md border p-4 space-y-2 text-sm\">\n                  <div className=\"flex items-center gap-2 text-green-600\">\n                    <Check className=\"h-4 w-4\" />\n                    <span>NIN verified successfully</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 text-green-600\">\n                    <Check className=\"h-4 w-4\" />\n                    <span>Face match confirmed</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 text-green-600\">\n                    <Check className=\"h-4 w-4\" />\n                    <span>Liveness check passed</span>\n                  </div>\n                </div>\n\n                <Alert>\n                  <BadgeCheck className=\"h-4 w-4\" />\n                  <AlertTitle>What's Next?</AlertTitle>\n                  <AlertDescription>\n                    You now have full access to all platform features. Your verified badge \n                    will be visible on your profile and product listings.\n                  </AlertDescription>\n                </Alert>\n              </>\n            ) : (\n              <>\n                <Alert variant=\"destructive\">\n                  <AlertTriangle className=\"h-4 w-4\" />\n                  <AlertTitle>Verification Failed</AlertTitle>\n                  <AlertDescription>\n                    The verification process couldn't confirm your identity. \n                    This could be due to poor image quality or a mismatch with your NIN details.\n                  </AlertDescription>\n                </Alert>\n\n                <div className=\"rounded-md border p-4 space-y-2 text-sm\">\n                  <p className=\"font-medium\">Common reasons for failure:</p>\n                  <ul className=\"list-disc pl-5 space-y-1 text-muted-foreground\">\n                    <li>Poor lighting in the selfie</li>\n                    <li>Face not clearly visible</li>\n                    <li>Wearing glasses or face coverings</li>\n                    <li>Information doesn't match NIN records</li>\n                  </ul>\n                </div>\n              </>\n            )}\n          </CardContent>\n          <CardFooter>\n            {verificationResult === \"success\" ? (\n              <Button className=\"w-full\" data-testid=\"button-done\">\n                <Check className=\"mr-2 h-4 w-4\" />\n                Done\n              </Button>\n            ) : (\n              <Button\n                className=\"w-full\"\n                onClick={handleRetry}\n                data-testid=\"button-retry-verification\"\n              >\n                <RefreshCw className=\"mr-2 h-4 w-4\" />\n                Try Again\n              </Button>\n            )}\n          </CardFooter>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":29953,"size_tokens":null},"client/src/pages/confessions.tsx":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  ThumbsUp, \n  ThumbsDown, \n  MessageCircle, \n  Send, \n  Eye,\n  MoreHorizontal,\n  Trash2,\n  Flag,\n  Plus,\n  TrendingUp,\n  Heart,\n  Sparkles,\n  GraduationCap,\n  Theater,\n  MessageSquare,\n  Smile,\n  Lock,\n  AlertTriangle,\n  Link2\n} from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { Link } from \"wouter\";\nimport type { Confession, ConfessionComment } from \"@shared/schema\";\n\nconst CATEGORIES = [\n  { value: \"all\", label: \"All\", icon: Sparkles },\n  { value: \"general\", label: \"General\", icon: MessageSquare },\n  { value: \"love\", label: \"Love\", icon: Heart },\n  { value: \"academics\", label: \"Academics\", icon: GraduationCap },\n  { value: \"drama\", label: \"Drama\", icon: Theater },\n  { value: \"advice\", label: \"Advice\", icon: MessageCircle },\n  { value: \"funny\", label: \"Funny\", icon: Smile },\n  { value: \"secrets\", label: \"Secrets\", icon: Lock },\n];\n\nconst CATEGORY_COLORS: Record<string, string> = {\n  general: \"bg-gray-500/10 text-gray-600 dark:text-gray-400 border-gray-500/30\",\n  love: \"bg-pink-500/10 text-pink-600 dark:text-pink-400 border-pink-500/30\",\n  academics: \"bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-500/30\",\n  drama: \"bg-orange-500/10 text-orange-600 dark:text-orange-400 border-orange-500/30\",\n  advice: \"bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/30\",\n  funny: \"bg-yellow-500/10 text-yellow-600 dark:text-yellow-400 border-yellow-500/30\",\n  secrets: \"bg-purple-500/10 text-purple-600 dark:text-purple-400 border-purple-500/30\",\n};\n\nconst REPORT_REASONS = [\n  { value: \"spam\", label: \"Spam\" },\n  { value: \"harassment\", label: \"Harassment\" },\n  { value: \"inappropriate\", label: \"Inappropriate Content\" },\n  { value: \"hate_speech\", label: \"Hate Speech\" },\n  { value: \"self_harm\", label: \"Self Harm Content\" },\n  { value: \"other\", label: \"Other\" },\n];\n\ntype ConfessionWithMeta = Confession & {\n  author?: { id: string; firstName: string | null; lastName: string | null; profileImageUrl: string | null } | null;\n  comments?: CommentWithAuthor[];\n  userVote?: \"like\" | \"dislike\" | null;\n  isOwner?: boolean;\n};\n\ntype CommentWithAuthor = ConfessionComment & {\n  author?: { id: string; firstName: string | null; lastName: string | null; profileImageUrl: string | null } | null;\n};\n\nfunction MaskedAvatar({ size = \"md\" }: { size?: \"sm\" | \"md\" }) {\n  const sizeClasses = size === \"sm\" ? \"h-8 w-8\" : \"h-10 w-10\";\n  return (\n    <Avatar className={sizeClasses}>\n      <AvatarFallback className=\"bg-purple-500/20 text-purple-600 dark:text-purple-400\">\n        <Eye className={size === \"sm\" ? \"h-4 w-4\" : \"h-5 w-5\"} />\n      </AvatarFallback>\n    </Avatar>\n  );\n}\n\nfunction CategoryBadge({ category }: { category: string }) {\n  const Icon = CATEGORIES.find(c => c.value === category)?.icon || MessageSquare;\n  const colorClass = CATEGORY_COLORS[category] || CATEGORY_COLORS.general;\n  \n  return (\n    <Badge variant=\"outline\" className={`text-xs gap-1 ${colorClass}`}>\n      <Icon className=\"h-3 w-3\" />\n      {category.charAt(0).toUpperCase() + category.slice(1)}\n    </Badge>\n  );\n}\n\nfunction ConfessionCard({ \n  confession, \n  onVote, \n  onComment, \n  onDelete, \n  onReport,\n  currentUserId \n}: { \n  confession: ConfessionWithMeta;\n  onVote: (id: string, type: \"like\" | \"dislike\") => void;\n  onComment: (id: string) => void;\n  onDelete: (id: string) => void;\n  onReport: (id: string) => void;\n  currentUserId?: string;\n}) {\n  const isOwner = confession.authorId === currentUserId;\n  const displayName = confession.isAnonymous ? \"Anonymous Confessor\" : \n    (confession.author ? `${confession.author.firstName} ${confession.author.lastName}` : \"Anonymous Confessor\");\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, y: -20 }}\n      transition={{ duration: 0.3 }}\n    >\n      <Card className=\"bg-zinc-900/50 dark:bg-zinc-900/50 border-zinc-800/50 dark:border-zinc-800/50 overflow-visible\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-start gap-3\">\n            {confession.isAnonymous ? (\n              <MaskedAvatar />\n            ) : (\n              <Avatar className=\"h-10 w-10\">\n                <AvatarImage src={confession.author?.profileImageUrl || undefined} />\n                <AvatarFallback className=\"bg-purple-500/20 text-purple-600\">\n                  {displayName.charAt(0).toUpperCase()}\n                </AvatarFallback>\n              </Avatar>\n            )}\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center gap-2 flex-wrap\">\n                <span className=\"font-semibold text-foreground text-sm\">\n                  {displayName}\n                </span>\n                <CategoryBadge category={confession.category || \"general\"} />\n                <span className=\"text-xs text-muted-foreground\">\n                  {formatDistanceToNow(new Date(confession.createdAt!), { addSuffix: true })}\n                </span>\n                {confession.isTrending && (\n                  <Badge variant=\"secondary\" className=\"text-xs bg-purple-500/20 text-purple-400 border-purple-500/30\">\n                    <TrendingUp className=\"h-3 w-3 mr-1\" />\n                    Trending\n                  </Badge>\n                )}\n              </div>\n              \n              <p className=\"mt-2 text-foreground whitespace-pre-wrap break-words text-sm leading-relaxed\">\n                {confession.content}\n              </p>\n\n              <div className=\"flex items-center gap-4 mt-3 pt-2 border-t border-zinc-800/50\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => onVote(confession.id, \"like\")}\n                  className={`gap-1.5 text-muted-foreground ${\n                    confession.userVote === \"like\" ? \"text-purple-500\" : \"\"\n                  }`}\n                  data-testid={`button-like-${confession.id}`}\n                >\n                  <ThumbsUp className={`h-4 w-4 ${confession.userVote === \"like\" ? \"fill-current\" : \"\"}`} />\n                  <span>{confession.likesCount || 0}</span>\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => onVote(confession.id, \"dislike\")}\n                  className={`gap-1.5 text-muted-foreground ${\n                    confession.userVote === \"dislike\" ? \"text-red-500\" : \"\"\n                  }`}\n                  data-testid={`button-dislike-${confession.id}`}\n                >\n                  <ThumbsDown className={`h-4 w-4 ${confession.userVote === \"dislike\" ? \"fill-current\" : \"\"}`} />\n                  <span>{confession.dislikesCount || 0}</span>\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => onComment(confession.id)}\n                  className=\"gap-1.5 text-muted-foreground\"\n                  data-testid={`button-comment-${confession.id}`}\n                >\n                  <MessageCircle className=\"h-4 w-4\" />\n                  <span>{confession.commentsCount || 0}</span>\n                </Button>\n                \n                <div className=\"ml-auto\">\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\n                        <MoreHorizontal className=\"h-4 w-4\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      {isOwner && (\n                        <DropdownMenuItem \n                          onClick={() => onDelete(confession.id)}\n                          className=\"text-destructive\"\n                          data-testid={`button-delete-${confession.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4 mr-2\" />\n                          Delete\n                        </DropdownMenuItem>\n                      )}\n                      {!isOwner && (\n                        <DropdownMenuItem \n                          onClick={() => onReport(confession.id)}\n                          data-testid={`button-report-${confession.id}`}\n                        >\n                          <Flag className=\"h-4 w-4 mr-2\" />\n                          Report\n                        </DropdownMenuItem>\n                      )}\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </div>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nfunction CommentItem({ comment }: { comment: CommentWithAuthor }) {\n  const displayName = comment.isAnonymous ? \"Anonymous\" : \n    (comment.author ? `${comment.author.firstName} ${comment.author.lastName}` : \"Anonymous\");\n\n  return (\n    <div className=\"flex items-start gap-3 py-3 border-b border-zinc-800/30 last:border-b-0\">\n      {comment.isAnonymous ? (\n        <MaskedAvatar size=\"sm\" />\n      ) : (\n        <Avatar className=\"h-8 w-8\">\n          <AvatarImage src={comment.author?.profileImageUrl || undefined} />\n          <AvatarFallback className=\"bg-purple-500/20 text-purple-600 text-xs\">\n            {displayName.charAt(0).toUpperCase()}\n          </AvatarFallback>\n        </Avatar>\n      )}\n      <div className=\"flex-1 min-w-0\">\n        <div className=\"flex items-center gap-2\">\n          <span className=\"font-medium text-sm text-foreground\">{displayName}</span>\n          <span className=\"text-xs text-muted-foreground\">\n            {formatDistanceToNow(new Date(comment.createdAt!), { addSuffix: true })}\n          </span>\n        </div>\n        <p className=\"text-sm text-foreground mt-1\">{comment.content}</p>\n      </div>\n    </div>\n  );\n}\n\nfunction TrendingSection({ trending }: { trending: Confession[] }) {\n  if (!trending || trending.length === 0) return null;\n\n  return (\n    <div className=\"mb-4\">\n      <div className=\"flex items-center gap-2 mb-3\">\n        <TrendingUp className=\"h-5 w-5 text-purple-500\" />\n        <h3 className=\"font-semibold text-foreground\">Trending Confessions</h3>\n      </div>\n      <div className=\"flex gap-3 overflow-x-auto pb-2 -mx-4 px-4\">\n        {trending.slice(0, 5).map((confession) => (\n          <Card \n            key={confession.id} \n            className=\"min-w-[280px] max-w-[280px] bg-gradient-to-br from-purple-500/10 to-pink-500/10 border-purple-500/20\"\n          >\n            <CardContent className=\"p-3\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <MaskedAvatar size=\"sm\" />\n                <CategoryBadge category={confession.category || \"general\"} />\n              </div>\n              <p className=\"text-sm text-foreground line-clamp-2\">{confession.content}</p>\n              <div className=\"flex items-center gap-3 mt-2 text-xs text-muted-foreground\">\n                <span className=\"flex items-center gap-1\">\n                  <ThumbsUp className=\"h-3 w-3\" />\n                  {confession.likesCount || 0}\n                </span>\n                <span className=\"flex items-center gap-1\">\n                  <MessageCircle className=\"h-3 w-3\" />\n                  {confession.commentsCount || 0}\n                </span>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction ConfessionSkeleton() {\n  return (\n    <Card className=\"bg-zinc-900/50 border-zinc-800/50\">\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-start gap-3\">\n          <Skeleton className=\"h-10 w-10 rounded-full\" />\n          <div className=\"flex-1\">\n            <div className=\"flex items-center gap-2\">\n              <Skeleton className=\"h-4 w-32\" />\n              <Skeleton className=\"h-4 w-16\" />\n            </div>\n            <Skeleton className=\"h-4 w-full mt-2\" />\n            <Skeleton className=\"h-4 w-3/4 mt-1\" />\n            <div className=\"flex gap-4 mt-3\">\n              <Skeleton className=\"h-6 w-16\" />\n              <Skeleton className=\"h-6 w-16\" />\n              <Skeleton className=\"h-6 w-16\" />\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default function ConfessionsPage() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [selectedCategory, setSelectedCategory] = useState(\"all\");\n  const [page, setPage] = useState(1);\n  const [showNewDialog, setShowNewDialog] = useState(false);\n  const [showCommentDialog, setShowCommentDialog] = useState(false);\n  const [showReportDialog, setShowReportDialog] = useState(false);\n  const [selectedConfessionId, setSelectedConfessionId] = useState<string | null>(null);\n  const [newContent, setNewContent] = useState(\"\");\n  const [newCategory, setNewCategory] = useState(\"general\");\n  const [isAnonymous, setIsAnonymous] = useState(true);\n  const [commentContent, setCommentContent] = useState(\"\");\n  const [isCommentAnonymous, setIsCommentAnonymous] = useState(false);\n  const [reportReason, setReportReason] = useState(\"\");\n  const [reportDescription, setReportDescription] = useState(\"\");\n\n  const { data: confessionsData, isLoading } = useQuery<{ confessions: ConfessionWithMeta[]; total: number }>({\n    queryKey: [\"/api/confessions\", selectedCategory, page],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (selectedCategory !== \"all\") params.append(\"category\", selectedCategory);\n      params.append(\"page\", page.toString());\n      params.append(\"limit\", \"20\");\n      const res = await fetch(`/api/confessions?${params}`);\n      if (!res.ok) throw new Error(\"Failed to fetch confessions\");\n      return res.json();\n    },\n  });\n\n  const { data: trendingData } = useQuery<Confession[]>({\n    queryKey: [\"/api/confessions/trending\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/confessions/trending?limit=5\");\n      if (!res.ok) throw new Error(\"Failed to fetch trending\");\n      return res.json();\n    },\n  });\n\n  const { data: selectedConfession, refetch: refetchConfession } = useQuery<ConfessionWithMeta>({\n    queryKey: [\"/api/confessions\", selectedConfessionId],\n    queryFn: async () => {\n      if (!selectedConfessionId) return null;\n      const res = await fetch(`/api/confessions/${selectedConfessionId}`);\n      if (!res.ok) throw new Error(\"Failed to fetch confession\");\n      return res.json();\n    },\n    enabled: !!selectedConfessionId,\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/confessions\", {\n        content: newContent,\n        category: newCategory,\n        isAnonymous,\n      });\n    },\n    onSuccess: () => {\n      toast({ title: \"Confession posted!\", description: \"Your confession will be visible after moderation.\" });\n      setShowNewDialog(false);\n      setNewContent(\"\");\n      setNewCategory(\"general\");\n      setIsAnonymous(true);\n      queryClient.invalidateQueries({ queryKey: [\"/api/confessions\"] });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to post confession\", variant: \"destructive\" });\n    },\n  });\n\n  const voteMutation = useMutation({\n    mutationFn: async ({ id, voteType }: { id: string; voteType: \"like\" | \"dislike\" }) => {\n      return apiRequest(\"POST\", `/api/confessions/${id}/vote`, { voteType });\n    },\n    onMutate: async ({ id, voteType }) => {\n      await queryClient.cancelQueries({ queryKey: [\"/api/confessions\"] });\n      const previousData = queryClient.getQueryData([\"/api/confessions\", selectedCategory, page]);\n      \n      queryClient.setQueryData([\"/api/confessions\", selectedCategory, page], (old: any) => {\n        if (!old?.confessions) return old;\n        return {\n          ...old,\n          confessions: old.confessions.map((c: ConfessionWithMeta) => {\n            if (c.id !== id) return c;\n            const prevVote = c.userVote;\n            const newVote = prevVote === voteType ? null : voteType;\n            let likesCount = c.likesCount || 0;\n            let dislikesCount = c.dislikesCount || 0;\n            if (prevVote === \"like\") likesCount--;\n            if (prevVote === \"dislike\") dislikesCount--;\n            if (newVote === \"like\") likesCount++;\n            if (newVote === \"dislike\") dislikesCount++;\n            return { ...c, userVote: newVote, likesCount, dislikesCount };\n          }),\n        };\n      });\n      \n      return { previousData };\n    },\n    onError: (error: any, variables, context) => {\n      if (context?.previousData) {\n        queryClient.setQueryData([\"/api/confessions\", selectedCategory, page], context.previousData);\n      }\n      if (error?.message?.includes(\"401\") || error?.message?.includes(\"Unauthorized\")) {\n        toast({ title: \"Login Required\", description: \"Please login to vote on confessions\", variant: \"destructive\" });\n      } else {\n        toast({ title: \"Error\", description: \"Failed to vote\", variant: \"destructive\" });\n      }\n    },\n    onSettled: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/confessions\"] });\n      if (selectedConfessionId) refetchConfession();\n    },\n  });\n\n  const commentMutation = useMutation({\n    mutationFn: async () => {\n      if (!selectedConfessionId) return;\n      return apiRequest(\"POST\", `/api/confessions/${selectedConfessionId}/comments`, {\n        content: commentContent,\n        isAnonymous: isCommentAnonymous,\n      });\n    },\n    onSuccess: () => {\n      toast({ title: \"Comment added!\" });\n      setCommentContent(\"\");\n      setIsCommentAnonymous(false);\n      refetchConfession();\n      queryClient.invalidateQueries({ queryKey: [\"/api/confessions\"] });\n    },\n    onError: (error: any) => {\n      if (error?.message?.includes(\"401\") || error?.message?.includes(\"Unauthorized\")) {\n        toast({ title: \"Login Required\", description: \"Please login to add comments\", variant: \"destructive\" });\n      } else {\n        toast({ title: \"Error\", description: \"Failed to add comment\", variant: \"destructive\" });\n      }\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/confessions/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Confession deleted\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/confessions\"] });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to delete confession\", variant: \"destructive\" });\n    },\n  });\n\n  const reportMutation = useMutation({\n    mutationFn: async () => {\n      if (!selectedConfessionId) return;\n      return apiRequest(\"POST\", `/api/confessions/${selectedConfessionId}/report`, {\n        reason: reportReason,\n        description: reportDescription,\n      });\n    },\n    onSuccess: () => {\n      toast({ title: \"Report submitted\", description: \"Thank you for helping keep the community safe.\" });\n      setShowReportDialog(false);\n      setReportReason(\"\");\n      setReportDescription(\"\");\n      setSelectedConfessionId(null);\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to submit report\", variant: \"destructive\" });\n    },\n  });\n\n  const handleVote = useCallback((id: string, type: \"like\" | \"dislike\") => {\n    if (!user) {\n      toast({ title: \"Login Required\", description: \"Please login to vote on confessions\", variant: \"destructive\" });\n      return;\n    }\n    voteMutation.mutate({ id, voteType: type });\n  }, [voteMutation, user, toast]);\n\n  const handleComment = useCallback((id: string) => {\n    if (!user) {\n      toast({ title: \"Login Required\", description: \"Please login to add comments\", variant: \"destructive\" });\n      return;\n    }\n    setSelectedConfessionId(id);\n    setShowCommentDialog(true);\n  }, [user, toast]);\n\n  const handleDelete = useCallback((id: string) => {\n    if (confirm(\"Are you sure you want to delete this confession?\")) {\n      deleteMutation.mutate(id);\n    }\n  }, [deleteMutation]);\n\n  const handleReport = useCallback((id: string) => {\n    setSelectedConfessionId(id);\n    setShowReportDialog(true);\n  }, []);\n\n  useEffect(() => {\n    setPage(1);\n  }, [selectedCategory]);\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"max-w-2xl mx-auto px-4 py-4\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div>\n            <h1 className=\"text-xl font-bold text-foreground flex items-center gap-2\">\n              <Eye className=\"h-6 w-6 text-purple-500\" />\n              Confessions\n            </h1>\n            <p className=\"text-sm text-muted-foreground\">Share anonymously with the community</p>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Link href=\"/secret-messages\">\n              <Button \n                variant=\"outline\"\n                className=\"border-purple-500/30 text-purple-400\"\n                data-testid=\"button-secret-messages\"\n              >\n                <Link2 className=\"h-4 w-4 mr-1\" />\n                Secret Links\n              </Button>\n            </Link>\n            <Button \n              onClick={() => {\n                if (!user) {\n                  toast({ title: \"Login Required\", description: \"Please login to post a confession\", variant: \"destructive\" });\n                  return;\n                }\n                setShowNewDialog(true);\n              }} \n              className=\"bg-purple-600 hover:bg-purple-700\"\n              data-testid=\"button-new-confession\"\n            >\n              <Plus className=\"h-4 w-4 mr-1\" />\n              Confess\n            </Button>\n          </div>\n        </div>\n\n        <Tabs value={selectedCategory} onValueChange={setSelectedCategory} className=\"mb-4\">\n          <TabsList className=\"w-full justify-start overflow-x-auto flex-nowrap bg-transparent gap-1 p-0\">\n            {CATEGORIES.map((cat) => {\n              const Icon = cat.icon;\n              return (\n                <TabsTrigger\n                  key={cat.value}\n                  value={cat.value}\n                  className=\"flex-shrink-0 gap-1.5 data-[state=active]:bg-purple-500/20 data-[state=active]:text-purple-400\"\n                  data-testid={`tab-${cat.value}`}\n                >\n                  <Icon className=\"h-3.5 w-3.5\" />\n                  {cat.label}\n                </TabsTrigger>\n              );\n            })}\n          </TabsList>\n        </Tabs>\n\n        {selectedCategory === \"all\" && <TrendingSection trending={trendingData || []} />}\n\n        <div className=\"space-y-3\">\n          {isLoading ? (\n            Array.from({ length: 3 }).map((_, i) => <ConfessionSkeleton key={i} />)\n          ) : confessionsData?.confessions && confessionsData.confessions.length > 0 ? (\n            <AnimatePresence>\n              {confessionsData.confessions.map((confession) => (\n                <ConfessionCard\n                  key={confession.id}\n                  confession={confession}\n                  onVote={handleVote}\n                  onComment={handleComment}\n                  onDelete={handleDelete}\n                  onReport={handleReport}\n                  currentUserId={user?.id}\n                />\n              ))}\n            </AnimatePresence>\n          ) : (\n            <Card className=\"bg-zinc-900/50 border-zinc-800/50\">\n              <CardContent className=\"p-8 text-center\">\n                <Eye className=\"h-12 w-12 mx-auto text-purple-500/50 mb-3\" />\n                <h3 className=\"font-semibold text-foreground mb-1\">No confessions yet</h3>\n                <p className=\"text-sm text-muted-foreground mb-4\">Be the first to share something!</p>\n                <Button \n                  onClick={() => {\n                    if (!user) {\n                      toast({ title: \"Login Required\", description: \"Please login to post a confession\", variant: \"destructive\" });\n                      return;\n                    }\n                    setShowNewDialog(true);\n                  }}\n                  className=\"bg-purple-600 hover:bg-purple-700\"\n                >\n                  <Plus className=\"h-4 w-4 mr-1\" />\n                  Make a Confession\n                </Button>\n              </CardContent>\n            </Card>\n          )}\n        </div>\n\n        {confessionsData && confessionsData.total > 20 && (\n          <div className=\"flex justify-center gap-2 mt-4\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              disabled={page === 1}\n              onClick={() => setPage(p => Math.max(1, p - 1))}\n              data-testid=\"button-prev-page\"\n            >\n              Previous\n            </Button>\n            <span className=\"flex items-center px-3 text-sm text-muted-foreground\">\n              Page {page} of {Math.ceil(confessionsData.total / 20)}\n            </span>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              disabled={page >= Math.ceil(confessionsData.total / 20)}\n              onClick={() => setPage(p => p + 1)}\n              data-testid=\"button-next-page\"\n            >\n              Next\n            </Button>\n          </div>\n        )}\n\n        <Dialog open={showNewDialog} onOpenChange={setShowNewDialog}>\n          <DialogContent className=\"sm:max-w-md\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-2\">\n                <Eye className=\"h-5 w-5 text-purple-500\" />\n                New Confession\n              </DialogTitle>\n              <DialogDescription>\n                Share your thoughts with the community. You can choose to be anonymous.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"category\">Category</Label>\n                <Select value={newCategory} onValueChange={setNewCategory}>\n                  <SelectTrigger data-testid=\"select-category\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {CATEGORIES.filter(c => c.value !== \"all\").map((cat) => (\n                      <SelectItem key={cat.value} value={cat.value}>\n                        <span className=\"flex items-center gap-2\">\n                          <cat.icon className=\"h-4 w-4\" />\n                          {cat.label}\n                        </span>\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <Label htmlFor=\"content\">Your Confession</Label>\n                <Textarea\n                  id=\"content\"\n                  placeholder=\"What's on your mind...\"\n                  value={newContent}\n                  onChange={(e) => setNewContent(e.target.value)}\n                  className=\"min-h-[120px] resize-none\"\n                  maxLength={2000}\n                  data-testid=\"textarea-confession\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1 text-right\">\n                  {newContent.length}/2000\n                </p>\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <Switch \n                    id=\"anonymous\" \n                    checked={isAnonymous} \n                    onCheckedChange={setIsAnonymous}\n                    data-testid=\"switch-anonymous\"\n                  />\n                  <Label htmlFor=\"anonymous\" className=\"flex items-center gap-1.5\">\n                    <Eye className=\"h-4 w-4\" />\n                    Post Anonymously\n                  </Label>\n                </div>\n              </div>\n              {!isAnonymous && (\n                <div className=\"flex items-center gap-2 p-2 rounded-md bg-yellow-500/10 text-yellow-600 dark:text-yellow-400\">\n                  <AlertTriangle className=\"h-4 w-4 flex-shrink-0\" />\n                  <span className=\"text-xs\">Your name and profile will be visible to others</span>\n                </div>\n              )}\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setShowNewDialog(false)}>\n                Cancel\n              </Button>\n              <Button \n                onClick={() => createMutation.mutate()}\n                disabled={newContent.trim().length < 10 || createMutation.isPending}\n                className=\"bg-purple-600 hover:bg-purple-700\"\n                data-testid=\"button-submit-confession\"\n              >\n                {createMutation.isPending ? \"Posting...\" : \"Post Confession\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n\n        <Sheet open={showCommentDialog} onOpenChange={(open) => {\n          if (!open) {\n            setShowCommentDialog(false);\n            setSelectedConfessionId(null);\n          }\n        }}>\n          <SheetContent side=\"bottom\" className=\"h-[85vh] rounded-t-xl px-4 pb-safe\">\n            <div className=\"mx-auto w-12 h-1.5 bg-muted-foreground/30 rounded-full mb-4 mt-2\" />\n            <SheetHeader className=\"text-left pb-3\">\n              <SheetTitle className=\"flex items-center gap-2\">\n                <MessageCircle className=\"h-5 w-5 text-purple-500\" />\n                Comments\n              </SheetTitle>\n            </SheetHeader>\n            {selectedConfession && (\n              <div className=\"flex flex-col h-[calc(100%-4rem)]\">\n                <div className=\"p-3 rounded-lg bg-muted/50 border border-border/50 mb-4\">\n                  <p className=\"text-sm text-foreground line-clamp-3\">{selectedConfession.content}</p>\n                </div>\n                \n                <ScrollArea className=\"flex-1 -mx-4 px-4\">\n                  <div className=\"pr-2\">\n                    {selectedConfession.comments && selectedConfession.comments.length > 0 ? (\n                      selectedConfession.comments.map((comment) => (\n                        <CommentItem key={comment.id} comment={comment} />\n                      ))\n                    ) : (\n                      <div className=\"text-center py-12\">\n                        <MessageCircle className=\"h-12 w-12 mx-auto text-muted-foreground/30 mb-3\" />\n                        <p className=\"text-sm text-muted-foreground\">\n                          No comments yet. Be the first!\n                        </p>\n                      </div>\n                    )}\n                  </div>\n                </ScrollArea>\n\n                <div className=\"pt-4 border-t mt-auto keyboard-aware-input\">\n                  <Textarea\n                    placeholder=\"Add a comment...\"\n                    value={commentContent}\n                    onChange={(e) => setCommentContent(e.target.value)}\n                    className=\"min-h-[60px] resize-none mb-3\"\n                    maxLength={1000}\n                    data-testid=\"textarea-comment\"\n                  />\n                  <div className=\"flex items-center justify-between gap-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <Switch \n                        id=\"comment-anonymous\" \n                        checked={isCommentAnonymous} \n                        onCheckedChange={setIsCommentAnonymous}\n                        data-testid=\"switch-comment-anonymous\"\n                      />\n                      <Label htmlFor=\"comment-anonymous\" className=\"text-sm\">Anonymous</Label>\n                    </div>\n                    <Button \n                      onClick={() => commentMutation.mutate()}\n                      disabled={!commentContent.trim() || commentMutation.isPending}\n                      className=\"bg-purple-600 hover:bg-purple-700\"\n                      data-testid=\"button-submit-comment\"\n                    >\n                      <Send className=\"h-4 w-4 mr-2\" />\n                      {commentMutation.isPending ? \"Posting...\" : \"Comment\"}\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            )}\n          </SheetContent>\n        </Sheet>\n\n        <Dialog open={showReportDialog} onOpenChange={(open) => {\n          if (!open) {\n            setShowReportDialog(false);\n            setSelectedConfessionId(null);\n            setReportReason(\"\");\n            setReportDescription(\"\");\n          }\n        }}>\n          <DialogContent className=\"sm:max-w-md\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-2\">\n                <Flag className=\"h-5 w-5 text-destructive\" />\n                Report Confession\n              </DialogTitle>\n              <DialogDescription>\n                Help us maintain a safe community by reporting inappropriate content.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"reason\">Reason for Report</Label>\n                <Select value={reportReason} onValueChange={setReportReason}>\n                  <SelectTrigger data-testid=\"select-report-reason\">\n                    <SelectValue placeholder=\"Select a reason\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {REPORT_REASONS.map((reason) => (\n                      <SelectItem key={reason.value} value={reason.value}>\n                        {reason.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <Label htmlFor=\"description\">Additional Details (Optional)</Label>\n                <Textarea\n                  id=\"description\"\n                  placeholder=\"Provide any additional context...\"\n                  value={reportDescription}\n                  onChange={(e) => setReportDescription(e.target.value)}\n                  className=\"min-h-[80px] resize-none\"\n                  data-testid=\"textarea-report-description\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setShowReportDialog(false)}>\n                Cancel\n              </Button>\n              <Button \n                variant=\"destructive\"\n                onClick={() => reportMutation.mutate()}\n                disabled={!reportReason || reportMutation.isPending}\n                data-testid=\"button-submit-report\"\n              >\n                {reportMutation.isPending ? \"Submitting...\" : \"Submit Report\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":36088,"size_tokens":null},"server/email-service.ts":{"content":"import { Resend } from 'resend';\n\nconst APP_NAME = process.env.APP_NAME || 'EKSU Plug';\nconst APP_URL = process.env.APP_URL || 'https://eksuplug.com.ng';\nconst FROM_EMAIL = process.env.FROM_EMAIL || 'system@eksuplug.com.ng';\nconst ADMIN_EMAIL = process.env.ADMIN_EMAIL || 'eksucampusmarketplace@gmail.com';\n\nlet resendClient: Resend | null = null;\n\nfunction getResendClient(): Resend | null {\n  const apiKey = process.env.RESEND_API_KEY;\n  if (!apiKey) {\n    console.warn('[Email] RESEND_API_KEY not configured');\n    return null;\n  }\n  if (!resendClient) {\n    resendClient = new Resend(apiKey);\n  }\n  return resendClient;\n}\n\nexport interface EmailResult {\n  success: boolean;\n  messageId?: string;\n  error?: string;\n}\n\nfunction logSuccess(functionName: string, to: string): void {\n  console.log(`[Email] ${functionName}: Email sent successfully to ${to}`);\n}\n\nfunction logError(functionName: string, error: any): void {\n  console.error(`[Email] ${functionName} failed:`, error?.message || error);\n}\n\nfunction logWarning(functionName: string): void {\n  console.warn(`[Email] ${functionName}: Resend not configured. Email not sent.`);\n}\n\nexport async function sendEmail(to: string, subject: string, html: string): Promise<EmailResult> {\n  const client = getResendClient();\n  \n  if (!client) {\n    logWarning('sendEmail');\n    return { success: false, error: 'Resend not configured' };\n  }\n\n  try {\n    const { data, error } = await client.emails.send({\n      from: FROM_EMAIL,\n      to,\n      subject,\n      html,\n    });\n\n    if (error) {\n      logError('sendEmail', error);\n      return { success: false, error: error.message };\n    }\n\n    logSuccess('sendEmail', to);\n    return { success: true, messageId: data?.id };\n  } catch (err: any) {\n    logError('sendEmail', err);\n    return { success: false, error: err?.message || 'Unknown error' };\n  }\n}\n\nfunction getBaseTemplate(title: string, content: string): string {\n  return `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"utf-8\">\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    </head>\n    <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n      <div style=\"background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); padding: 30px; border-radius: 10px 10px 0 0; text-align: center;\">\n        <h1 style=\"color: white; margin: 0; font-size: 24px;\">${title}</h1>\n      </div>\n      <div style=\"background: #ffffff; padding: 30px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 10px 10px;\">\n        ${content}\n        <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;\">\n        <p style=\"color: #999; font-size: 12px; text-align: center; margin: 0;\">\n          &copy; ${new Date().getFullYear()} ${APP_NAME}. All rights reserved.\n        </p>\n      </div>\n    </body>\n    </html>\n  `;\n}\n\nexport async function sendWelcomeEmail(email: string, firstName: string): Promise<EmailResult> {\n  const content = `\n    <p style=\"font-size: 18px; margin-top: 0;\">Hey ${firstName}! Welcome to ${APP_NAME}</p>\n    <p>We're super excited to have you join our campus community. Here's what you can do:</p>\n    <ul style=\"padding-left: 20px;\">\n      <li><strong>Buy & Sell:</strong> List items or find great deals from fellow students</li>\n      <li><strong>Safe Transactions:</strong> Our escrow system protects every trade</li>\n      <li><strong>Connect:</strong> Chat with buyers and sellers directly</li>\n      <li><strong>Games:</strong> Play Ludo, Whot, and more with friends</li>\n      <li><strong>The Plug:</strong> Stay updated with campus news and gist</li>\n      <li><strong>VTU Services:</strong> Buy airtime and data at discounted rates</li>\n    </ul>\n    <p style=\"background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 20px 0;\">\n      <strong>Pro tip:</strong> Complete your profile verification to get a verified badge and build trust with other users!\n    </p>\n    <div style=\"text-align: center; margin: 30px 0;\">\n      <a href=\"${APP_URL}\" style=\"display: inline-block; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold;\">Start Exploring</a>\n    </div>\n    <p style=\"color: #666; font-size: 14px;\">Questions? Just reply to this email or reach out to our support team.</p>\n  `;\n  return sendEmail(email, `Welcome to ${APP_NAME}!`, getBaseTemplate(`Welcome to ${APP_NAME}!`, content));\n}\n\nexport async function sendEmailVerificationCode(\n  email: string, \n  firstName: string, \n  verificationCode: string, \n  verificationLink: string\n): Promise<EmailResult> {\n  const content = `\n    <p style=\"font-size: 18px; margin-top: 0;\">Hey ${firstName}, verify your email</p>\n    <p>Thanks for signing up! Please verify your email address to complete your registration and unlock all features.</p>\n    \n    <div style=\"background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 30px; border-radius: 12px; margin: 25px 0; text-align: center; border: 2px dashed #16a34a;\">\n      <p style=\"font-size: 14px; color: #166534; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px;\">Your Verification Code</p>\n      <p style=\"font-size: 36px; font-weight: bold; color: #15803d; margin: 0; letter-spacing: 8px; font-family: monospace;\">${verificationCode}</p>\n      <p style=\"font-size: 12px; color: #166534; margin: 15px 0 0 0;\">Code expires in 24 hours</p>\n    </div>\n    \n    <p style=\"text-align: center; color: #666;\">Or click the button below to verify instantly:</p>\n    \n    <div style=\"text-align: center; margin: 25px 0;\">\n      <a href=\"${verificationLink}\" style=\"display: inline-block; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; text-decoration: none; padding: 15px 40px; border-radius: 8px; font-weight: bold; font-size: 16px;\">Verify Email Address</a>\n    </div>\n    \n    <div style=\"background: #fefce8; padding: 15px; border-radius: 8px; margin-top: 20px;\">\n      <p style=\"margin: 0; font-size: 13px; color: #854d0e;\">\n        <strong>Security tip:</strong> If you didn't create an account on ${APP_NAME}, please ignore this email.\n      </p>\n    </div>\n  `;\n  return sendEmail(email, `Verify your email - ${APP_NAME}`, getBaseTemplate('Verify Your Email', content));\n}\n\nexport async function sendVerificationEmail(email: string, status: 'approved' | 'rejected' | 'pending', reason?: string): Promise<EmailResult> {\n  const config = {\n    approved: { title: 'Verification Approved!', color: '#16a34a', icon: 'Verified Badge Activated' },\n    rejected: { title: 'Verification Update', color: '#ef4444', icon: 'Action Required' },\n    pending: { title: 'Verification In Progress', color: '#f59e0b', icon: 'Under Review' },\n  };\n  const c = config[status];\n  const content = `\n    <p style=\"font-size: 16px; margin-top: 0;\">${c.icon}</p>\n    ${status === 'approved' ? '<p>Congratulations! Your account is now verified. You have a verified badge on your profile showing your department, level, and name.</p>' : ''}\n    ${status === 'rejected' && reason ? `<p style=\"background: #fef2f2; padding: 15px; border-radius: 8px;\"><strong>Reason:</strong> ${reason}</p>` : ''}\n    ${status === 'pending' ? '<p>We received your verification documents. Review usually takes 1-2 hours.</p>' : ''}\n    <div style=\"text-align: center; margin: 30px 0;\">\n      <a href=\"${APP_URL}/profile\" style=\"display: inline-block; background: ${c.color}; color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold;\">View Profile</a>\n    </div>\n  `;\n  return sendEmail(email, c.title, getBaseTemplate(c.title, content));\n}\n\nexport async function sendOrderEmail(email: string, orderDetails: {\n  orderId: string;\n  productName: string;\n  totalAmount: string;\n  sellerName: string;\n  buyerName?: string;\n  type: 'confirmation' | 'shipped' | 'delivered' | 'completed';\n}): Promise<EmailResult> {\n  const titles = {\n    confirmation: 'Order Confirmed!',\n    shipped: 'Order Shipped!',\n    delivered: 'Order Delivered!',\n    completed: 'Transaction Complete!',\n  };\n  const content = `\n    <p style=\"font-size: 16px; margin-top: 0;\">Order #${orderDetails.orderId}</p>\n    <div style=\"background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0;\">\n      <p><strong>Product:</strong> ${orderDetails.productName}</p>\n      <p><strong>Amount:</strong> NGN ${orderDetails.totalAmount}</p>\n      <p><strong>Seller:</strong> ${orderDetails.sellerName}</p>\n    </div>\n    <div style=\"text-align: center; margin: 30px 0;\">\n      <a href=\"${APP_URL}/messages\" style=\"display: inline-block; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold;\">View Order</a>\n    </div>\n  `;\n  return sendEmail(email, titles[orderDetails.type], getBaseTemplate(titles[orderDetails.type], content));\n}\n\nexport async function sendMessageNotification(email: string, senderName: string): Promise<EmailResult> {\n  const content = `\n    <p style=\"font-size: 16px; margin-top: 0;\">You have a new message from <strong>${senderName}</strong>!</p>\n    <div style=\"text-align: center; margin: 30px 0;\">\n      <a href=\"${APP_URL}/messages\" style=\"display: inline-block; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold;\">View Message</a>\n    </div>\n    <p style=\"color: #666; font-size: 14px;\">Quick responses build trust with buyers and sellers!</p>\n  `;\n  return sendEmail(email, `New message from ${senderName}`, getBaseTemplate('New Message', content));\n}\n\nexport async function sendPasswordReset(email: string, resetLink: string): Promise<EmailResult> {\n  const content = `\n    <p style=\"font-size: 16px; margin-top: 0;\">You requested a password reset.</p>\n    <div style=\"text-align: center; margin: 30px 0;\">\n      <a href=\"${resetLink}\" style=\"display: inline-block; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold;\">Reset Password</a>\n    </div>\n    <p style=\"color: #666; font-size: 14px;\">This link expires in 1 hour. If you didn't request this, ignore this email.</p>\n  `;\n  return sendEmail(email, 'Reset Your Password', getBaseTemplate('Password Reset', content));\n}\n\nexport async function sendNewFollowerEmail(email: string, followerName: string, followerUsername: string): Promise<EmailResult> {\n  const content = `\n    <p style=\"font-size: 16px; margin-top: 0;\">Great news! <strong>${followerName}</strong> (@${followerUsername}) just started following you!</p>\n    <p>They'll now see your posts and products in their feed. Keep sharing great content to grow your audience!</p>\n    <div style=\"text-align: center; margin: 30px 0;\">\n      <a href=\"${APP_URL}/profile/${followerUsername}\" style=\"display: inline-block; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold;\">View Their Profile</a>\n    </div>\n  `;\n  return sendEmail(email, `${followerName} started following you!`, getBaseTemplate('New Follower', content));\n}\n\nexport async function sendNewPostFromFollowingEmail(\n  email: string, \n  authorName: string, \n  authorUsername: string,\n  postPreview: string,\n  postId: string\n): Promise<EmailResult> {\n  const truncatedPreview = postPreview.length > 150 ? postPreview.substring(0, 150) + '...' : postPreview;\n  const content = `\n    <p style=\"font-size: 16px; margin-top: 0;\"><strong>${authorName}</strong> (@${authorUsername}) just shared a new post!</p>\n    <div style=\"background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #16a34a;\">\n      <p style=\"margin: 0; color: #374151; font-style: italic;\">\"${truncatedPreview}\"</p>\n    </div>\n    <div style=\"text-align: center; margin: 30px 0;\">\n      <a href=\"${APP_URL}/the-plug?post=${postId}\" style=\"display: inline-block; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold;\">View Post</a>\n    </div>\n    <p style=\"color: #666; font-size: 14px; text-align: center;\">\n      <a href=\"${APP_URL}/settings\" style=\"color: #16a34a; text-decoration: none;\">Manage notification preferences</a>\n    </p>\n  `;\n  return sendEmail(email, `${authorName} shared a new post`, getBaseTemplate('New Post', content));\n}\n\nexport async function sendNewProductFromFollowingEmail(\n  email: string, \n  sellerName: string, \n  sellerUsername: string,\n  productName: string,\n  productPrice: string,\n  productId: string,\n  productImage?: string\n): Promise<EmailResult> {\n  const content = `\n    <p style=\"font-size: 16px; margin-top: 0;\"><strong>${sellerName}</strong> (@${sellerUsername}) just listed a new product!</p>\n    <div style=\"background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0;\">\n      ${productImage ? `<img src=\"${productImage}\" alt=\"${productName}\" style=\"width: 100%; max-width: 300px; border-radius: 8px; margin-bottom: 15px;\">` : ''}\n      <h3 style=\"margin: 0 0 10px 0; color: #111;\">${productName}</h3>\n      <p style=\"font-size: 24px; font-weight: bold; color: #16a34a; margin: 0;\">NGN ${productPrice}</p>\n    </div>\n    <div style=\"text-align: center; margin: 30px 0;\">\n      <a href=\"${APP_URL}/product/${productId}\" style=\"display: inline-block; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold;\">View Product</a>\n    </div>\n    <p style=\"color: #666; font-size: 14px; text-align: center;\">\n      <a href=\"${APP_URL}/settings\" style=\"color: #16a34a; text-decoration: none;\">Manage notification preferences</a>\n    </p>\n  `;\n  return sendEmail(email, `${sellerName} listed: ${productName}`, getBaseTemplate('New Product Listed', content));\n}\n\nexport async function sendStreakRewardEmail(email: string, streakDays: number, rewardAmount: number): Promise<EmailResult> {\n  const content = `\n    <div style=\"text-align: center;\">\n      <p style=\"font-size: 48px; margin: 0;\">🔥</p>\n      <p style=\"font-size: 24px; font-weight: bold; margin: 10px 0;\">${streakDays} Day Streak!</p>\n      <p style=\"font-size: 18px; color: #16a34a;\">You earned NGN ${rewardAmount}!</p>\n      <p>Keep it going! Log in daily to maintain your streak and earn more rewards.</p>\n    </div>\n    <div style=\"text-align: center; margin: 30px 0;\">\n      <a href=\"${APP_URL}\" style=\"display: inline-block; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold;\">Continue Streak</a>\n    </div>\n  `;\n  return sendEmail(email, `${streakDays} Day Streak! You earned NGN ${rewardAmount}`, getBaseTemplate('Streak Reward!', content));\n}\n\nexport async function sendGameInvite(email: string, inviterName: string, gameType: string, stakeAmount: string): Promise<EmailResult> {\n  const content = `\n    <p style=\"font-size: 16px; margin-top: 0;\"><strong>${inviterName}</strong> invited you to play ${gameType}!</p>\n    <div style=\"background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center;\">\n      <p style=\"font-size: 24px; margin: 0;\">Stake: NGN ${stakeAmount}</p>\n    </div>\n    <div style=\"text-align: center; margin: 30px 0;\">\n      <a href=\"${APP_URL}/games\" style=\"display: inline-block; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold;\">Accept Challenge</a>\n    </div>\n  `;\n  return sendEmail(email, `${inviterName} challenged you to ${gameType}!`, getBaseTemplate('Game Invitation', content));\n}\n\nexport async function sendStoryViewNotification(email: string, viewerName: string): Promise<EmailResult> {\n  const content = `\n    <p style=\"font-size: 16px; margin-top: 0;\"><strong>${viewerName}</strong> viewed your story!</p>\n    <div style=\"text-align: center; margin: 30px 0;\">\n      <a href=\"${APP_URL}/the-plug\" style=\"display: inline-block; background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold;\">View Stories</a>\n    </div>\n  `;\n  return sendEmail(email, `${viewerName} viewed your story`, getBaseTemplate('Story View', content));\n}\n\nexport async function sendConfessionReaction(email: string, reaction: string): Promise<EmailResult> {\n  const content = `\n    <p style=\"font-size: 16px; margin-top: 0;\">Someone reacted to your confession!</p>\n    <div style=\"text-align: center; margin: 20px 0;\">\n      <span style=\"font-size: 48px;\">${reaction}</span>\n    </div>\n    <div style=\"text-align: center; margin: 30px 0;\">\n      <a href=\"${APP_URL}/confessions\" style=\"display: inline-block; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold;\">View Confession</a>\n    </div>\n  `;\n  return sendEmail(email, 'New reaction on your confession', getBaseTemplate('Confession Reaction', content));\n}\n\nexport async function sendErrorReportToAdmin(\n  errorTitle: string,\n  errorMessage: string,\n  details?: Record<string, any>\n): Promise<EmailResult> {\n  const timestamp = new Date().toISOString();\n  \n  let detailsHtml = '';\n  if (details) {\n    const sanitizedDetails = { ...details };\n    delete sanitizedDetails.password;\n    delete sanitizedDetails.token;\n    delete sanitizedDetails.apiKey;\n    delete sanitizedDetails.secretKey;\n    \n    detailsHtml = `\n      <div style=\"background: #1e1e1e; padding: 15px; border-radius: 8px; margin: 15px 0; overflow-x: auto;\">\n        <pre style=\"color: #d4d4d4; font-family: 'Monaco', 'Consolas', monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; margin: 0;\">${JSON.stringify(sanitizedDetails, null, 2)}</pre>\n      </div>\n    `;\n  }\n  \n  const content = `\n    <div style=\"background: #fef2f2; border: 2px solid #ef4444; padding: 20px; border-radius: 12px; margin-bottom: 20px;\">\n      <h2 style=\"color: #dc2626; margin: 0 0 10px 0; font-size: 20px;\">Error Report: ${errorTitle}</h2>\n      <p style=\"color: #7f1d1d; margin: 0;\">An error occurred in the ${APP_NAME} application</p>\n    </div>\n    \n    <div style=\"margin: 20px 0;\">\n      <h3 style=\"color: #374151; margin: 0 0 10px 0;\">Error Message</h3>\n      <div style=\"background: #fff1f2; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;\">\n        <p style=\"color: #dc2626; margin: 0; font-family: monospace;\">${errorMessage}</p>\n      </div>\n    </div>\n    \n    <div style=\"margin: 20px 0;\">\n      <h3 style=\"color: #374151; margin: 0 0 10px 0;\">Timestamp</h3>\n      <p style=\"color: #6b7280; margin: 0;\">${timestamp}</p>\n    </div>\n    \n    ${details ? `\n    <div style=\"margin: 20px 0;\">\n      <h3 style=\"color: #374151; margin: 0 0 10px 0;\">Technical Details</h3>\n      ${detailsHtml}\n    </div>\n    ` : ''}\n    \n    <div style=\"background: #f3f4f6; padding: 15px; border-radius: 8px; margin-top: 25px;\">\n      <p style=\"margin: 0; font-size: 13px; color: #6b7280;\">\n        This is an automated error notification from the ${APP_NAME} system.\n      </p>\n    </div>\n  `;\n  \n  console.log(`[Email] Sending error report to admin: ${errorTitle}`);\n  return sendEmail(ADMIN_EMAIL, `[ERROR] ${APP_NAME}: ${errorTitle}`, getBaseTemplate('Error Report', content));\n}\n\nexport async function sendVtuSyncReport(\n  syncResult: { success: boolean; message: string; plansUpdated?: number; plansCreated?: number; errors?: string[] }\n): Promise<EmailResult> {\n  const statusColor = syncResult.success ? '#16a34a' : '#dc2626';\n  const statusText = syncResult.success ? 'Success' : 'Failed';\n  const timestamp = new Date().toISOString();\n  \n  let errorsHtml = '';\n  if (syncResult.errors && syncResult.errors.length > 0) {\n    errorsHtml = `\n      <div style=\"margin: 20px 0;\">\n        <h3 style=\"color: #374151; margin: 0 0 10px 0;\">Errors (${syncResult.errors.length})</h3>\n        <ul style=\"background: #fef2f2; padding: 15px 15px 15px 30px; border-radius: 8px; margin: 0;\">\n          ${syncResult.errors.map(err => `<li style=\"color: #dc2626; margin: 5px 0;\">${err}</li>`).join('')}\n        </ul>\n      </div>\n    `;\n  }\n  \n  const content = `\n    <div style=\"background: ${syncResult.success ? '#f0fdf4' : '#fef2f2'}; border: 2px solid ${statusColor}; padding: 20px; border-radius: 12px; margin-bottom: 20px;\">\n      <h2 style=\"color: ${statusColor}; margin: 0 0 10px 0; font-size: 20px;\">VTU Plans Sync: ${statusText}</h2>\n      <p style=\"color: #374151; margin: 0;\">${syncResult.message}</p>\n    </div>\n    \n    ${syncResult.success ? `\n    <div style=\"display: flex; gap: 20px; margin: 20px 0;\">\n      <div style=\"flex: 1; background: #f0fdf4; padding: 20px; border-radius: 8px; text-align: center;\">\n        <p style=\"font-size: 32px; font-weight: bold; color: #16a34a; margin: 0;\">${syncResult.plansUpdated || 0}</p>\n        <p style=\"color: #166534; margin: 5px 0 0 0;\">Plans Updated</p>\n      </div>\n      <div style=\"flex: 1; background: #eff6ff; padding: 20px; border-radius: 8px; text-align: center;\">\n        <p style=\"font-size: 32px; font-weight: bold; color: #2563eb; margin: 0;\">${syncResult.plansCreated || 0}</p>\n        <p style=\"color: #1d4ed8; margin: 5px 0 0 0;\">Plans Created</p>\n      </div>\n    </div>\n    ` : ''}\n    \n    ${errorsHtml}\n    \n    <div style=\"margin: 20px 0;\">\n      <h3 style=\"color: #374151; margin: 0 0 10px 0;\">Timestamp</h3>\n      <p style=\"color: #6b7280; margin: 0;\">${timestamp}</p>\n    </div>\n    \n    <div style=\"background: #f3f4f6; padding: 15px; border-radius: 8px; margin-top: 25px;\">\n      <p style=\"margin: 0; font-size: 13px; color: #6b7280;\">\n        This is an automated VTU sync notification from the ${APP_NAME} system.\n      </p>\n    </div>\n  `;\n  \n  return sendEmail(ADMIN_EMAIL, `[VTU Sync] ${APP_NAME}: ${statusText}`, getBaseTemplate('VTU Plans Sync Report', content));\n}\n\nexport async function sendTestEmail(to: string): Promise<EmailResult> {\n  const content = `\n    <p style=\"font-size: 18px; margin-top: 0;\">Test Email Successful!</p>\n    <p>This is a test email from ${APP_NAME} to verify that the Resend email integration is working correctly.</p>\n    <div style=\"background: #f0fdf4; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center;\">\n      <p style=\"font-size: 24px; color: #16a34a; margin: 0;\">Email Service is Working!</p>\n      <p style=\"color: #166534; margin: 10px 0 0 0;\">Sent from: ${FROM_EMAIL}</p>\n    </div>\n    <p style=\"color: #666; font-size: 14px;\">If you received this email, the Resend integration is configured correctly.</p>\n  `;\n  return sendEmail(to, `Test Email from ${APP_NAME}`, getBaseTemplate('Test Email', content));\n}\n","path":null,"size_bytes":23090,"size_tokens":null},"client/src/pages/stories.tsx":{"content":"import { useState, useRef, useEffect, useCallback } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { ScrollArea, ScrollBar } from \"@/components/ui/scroll-area\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Plus,\n  X, \n  ChevronLeft,\n  ChevronRight,\n  Heart,\n  Send,\n  Image as ImageIcon,\n  Type,\n  Eye,\n  Trash2,\n  Pause,\n  Play,\n  Volume2,\n  VolumeX\n} from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport type { User, Story } from \"@shared/schema\";\n\ntype StoryWithAuthor = Story & { \n  author: User; \n  hasViewed?: boolean;\n};\n\ntype UserWithStories = {\n  user: User;\n  storyCount: number;\n  hasUnviewed: boolean;\n  latestStoryAt: string;\n};\n\nconst STORY_DURATION = 5000;\n\nconst BACKGROUND_COLORS = [\n  \"#16a34a\",\n  \"#3b82f6\", \n  \"#ec4899\",\n  \"#f59e0b\",\n  \"#8b5cf6\",\n  \"#000000\",\n];\n\nconst FONT_STYLES = [\n  { name: \"Sans\", value: \"sans-serif\" },\n  { name: \"Serif\", value: \"serif\" },\n  { name: \"Mono\", value: \"monospace\" },\n];\n\nconst REACTIONS = [\"fire\", \"heart\", \"clap\", \"eyes\", \"laugh\", \"wow\"];\n\nconst REACTION_ICONS: Record<string, string> = {\n  fire: \"M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z\",\n  heart: \"M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z\",\n  clap: \"M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0\",\n  eyes: \"M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z M15 12a3 3 0 11-6 0 3 3 0 016 0z\",\n  laugh: \"M15.182 15.182a4.5 4.5 0 01-6.364 0M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z\",\n  wow: \"M15.182 16.318A4.486 4.486 0 0012.016 15a4.486 4.486 0 00-3.198 1.318M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z\",\n};\n\nfunction StoryRing({ \n  user, \n  hasUnviewed, \n  isOwn,\n  onClick,\n  size = \"md\"\n}: { \n  user: User; \n  hasUnviewed: boolean;\n  isOwn?: boolean;\n  onClick: () => void;\n  size?: \"sm\" | \"md\" | \"lg\";\n}) {\n  const sizeClasses = {\n    sm: \"w-12 h-12\",\n    md: \"w-16 h-16\",\n    lg: \"w-20 h-20\",\n  };\n  \n  const ringClasses = hasUnviewed \n    ? \"ring-2 ring-[#16a34a] ring-offset-2 ring-offset-background\" \n    : \"ring-2 ring-muted ring-offset-2 ring-offset-background\";\n\n  const initials = user.firstName && user.lastName \n    ? `${user.firstName[0]}${user.lastName[0]}`.toUpperCase()\n    : user.email.substring(0, 2).toUpperCase();\n\n  return (\n    <button\n      onClick={onClick}\n      className=\"flex flex-col items-center gap-1 min-w-[72px]\"\n      data-testid={`story-ring-${user.id}`}\n    >\n      <div className={`relative ${sizeClasses[size]} rounded-full ${ringClasses}`}>\n        <Avatar className=\"w-full h-full\">\n          <AvatarImage src={user.profileImageUrl || undefined} alt={user.firstName || user.email} />\n          <AvatarFallback className=\"text-xs bg-muted\">{initials}</AvatarFallback>\n        </Avatar>\n        {isOwn && (\n          <div className=\"absolute -bottom-1 -right-1 w-5 h-5 bg-[#16a34a] rounded-full flex items-center justify-center border-2 border-background\">\n            <Plus className=\"w-3 h-3 text-white\" />\n          </div>\n        )}\n      </div>\n      <span className=\"text-xs truncate max-w-[64px] text-muted-foreground\">\n        {isOwn ? \"Your story\" : user.firstName || user.email.split(\"@\")[0]}\n      </span>\n    </button>\n  );\n}\n\nexport function StoryViewer({\n  stories,\n  initialStoryIndex = 0,\n  onClose,\n  currentUserId,\n}: {\n  stories: StoryWithAuthor[];\n  initialStoryIndex?: number;\n  onClose: () => void;\n  currentUserId: string;\n}) {\n  const [currentIndex, setCurrentIndex] = useState(initialStoryIndex);\n  const [progress, setProgress] = useState(0);\n  const [isPaused, setIsPaused] = useState(false);\n  const [isMuted, setIsMuted] = useState(true);\n  const [replyText, setReplyText] = useState(\"\");\n  const [showReactions, setShowReactions] = useState(false);\n  const progressInterval = useRef<NodeJS.Timeout | null>(null);\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const { toast } = useToast();\n  \n  const currentStory = stories[currentIndex];\n  const isOwnStory = currentStory?.authorId === currentUserId;\n  \n  const viewMutation = useMutation({\n    mutationFn: async (storyId: string) => {\n      return apiRequest(\"POST\", `/api/stories/${storyId}/view`);\n    },\n  });\n  \n  const reactMutation = useMutation({\n    mutationFn: async ({ storyId, reaction }: { storyId: string; reaction: string }) => {\n      return apiRequest(\"POST\", `/api/stories/${storyId}/react`, { reaction });\n    },\n    onSuccess: () => {\n      toast({ title: \"Reaction sent!\" });\n      setShowReactions(false);\n    },\n  });\n  \n  const replyMutation = useMutation({\n    mutationFn: async ({ storyId, content }: { storyId: string; content: string }) => {\n      return apiRequest(\"POST\", `/api/stories/${storyId}/reply`, { content });\n    },\n    onSuccess: () => {\n      toast({ title: \"Reply sent!\" });\n      setReplyText(\"\");\n    },\n  });\n  \n  const deleteMutation = useMutation({\n    mutationFn: async (storyId: string) => {\n      return apiRequest(\"DELETE\", `/api/stories/${storyId}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Story deleted\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stories\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stories/users\"] });\n      if (stories.length === 1) {\n        onClose();\n      } else if (currentIndex >= stories.length - 1) {\n        setCurrentIndex(currentIndex - 1);\n      }\n    },\n  });\n  \n  const startProgress = useCallback(() => {\n    if (progressInterval.current) {\n      clearInterval(progressInterval.current);\n    }\n    \n    setProgress(0);\n    \n    const duration = currentStory?.type === \"video\" && videoRef.current \n      ? (videoRef.current.duration || 15) * 1000 \n      : STORY_DURATION;\n    \n    const interval = 50;\n    const increment = (interval / duration) * 100;\n    \n    progressInterval.current = setInterval(() => {\n      setProgress(prev => {\n        if (prev >= 100) {\n          clearInterval(progressInterval.current!);\n          goToNext();\n          return 0;\n        }\n        return prev + increment;\n      });\n    }, interval);\n  }, [currentStory?.type]);\n  \n  const pauseProgress = useCallback(() => {\n    if (progressInterval.current) {\n      clearInterval(progressInterval.current);\n    }\n  }, []);\n  \n  const goToNext = useCallback(() => {\n    if (currentIndex < stories.length - 1) {\n      setCurrentIndex(currentIndex + 1);\n    } else {\n      onClose();\n    }\n  }, [currentIndex, stories.length, onClose]);\n  \n  const goToPrev = useCallback(() => {\n    if (currentIndex > 0) {\n      setCurrentIndex(currentIndex - 1);\n    }\n  }, [currentIndex]);\n  \n  useEffect(() => {\n    if (currentStory && !currentStory.hasViewed && currentStory.authorId !== currentUserId) {\n      viewMutation.mutate(currentStory.id);\n    }\n  }, [currentStory?.id]);\n  \n  useEffect(() => {\n    if (!isPaused) {\n      startProgress();\n    } else {\n      pauseProgress();\n    }\n    \n    return () => {\n      if (progressInterval.current) {\n        clearInterval(progressInterval.current);\n      }\n    };\n  }, [currentIndex, isPaused, startProgress, pauseProgress]);\n  \n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.key === \"ArrowRight\") goToNext();\n      if (e.key === \"ArrowLeft\") goToPrev();\n      if (e.key === \"Escape\") onClose();\n      if (e.key === \" \") {\n        e.preventDefault();\n        setIsPaused(p => !p);\n      }\n    };\n    \n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [goToNext, goToPrev, onClose]);\n  \n  if (!currentStory) return null;\n  \n  const author = currentStory.author;\n  const initials = author.firstName && author.lastName \n    ? `${author.firstName[0]}${author.lastName[0]}`.toUpperCase()\n    : author.email.substring(0, 2).toUpperCase();\n  \n  const handleTap = (e: React.MouseEvent) => {\n    const rect = e.currentTarget.getBoundingClientRect();\n    const x = e.clientX - rect.left;\n    const isLeftSide = x < rect.width / 3;\n    const isRightSide = x > (rect.width * 2) / 3;\n    \n    if (isLeftSide) {\n      goToPrev();\n    } else if (isRightSide) {\n      goToNext();\n    }\n  };\n  \n  const handleReact = (reaction: string) => {\n    reactMutation.mutate({ storyId: currentStory.id, reaction });\n  };\n  \n  const handleReply = () => {\n    if (replyText.trim()) {\n      replyMutation.mutate({ storyId: currentStory.id, content: replyText.trim() });\n    }\n  };\n\n  return (\n    <div className=\"fixed inset-0 z-50 bg-black flex items-center justify-center\">\n      <div \n        className=\"relative w-full h-full max-w-[420px] max-h-[100vh] flex flex-col\"\n        onClick={handleTap}\n        data-testid=\"story-viewer\"\n      >\n        <div className=\"absolute top-0 left-0 right-0 z-10 p-2 flex gap-1\">\n          {stories.map((_, idx) => (\n            <div key={idx} className=\"flex-1 h-0.5 bg-white/30 rounded-full overflow-hidden\">\n              <div \n                className=\"h-full bg-white transition-all\"\n                style={{ \n                  width: idx < currentIndex ? \"100%\" : idx === currentIndex ? `${progress}%` : \"0%\" \n                }}\n              />\n            </div>\n          ))}\n        </div>\n        \n        <div className=\"absolute top-6 left-0 right-0 z-10 flex items-center justify-between px-4\">\n          <div className=\"flex items-center gap-3\">\n            <Avatar className=\"w-10 h-10 ring-2 ring-white/50\">\n              <AvatarImage src={author.profileImageUrl || undefined} />\n              <AvatarFallback className=\"text-xs\">{initials}</AvatarFallback>\n            </Avatar>\n            <div className=\"text-white\">\n              <p className=\"font-medium text-sm\" data-testid=\"story-author-name\">\n                {author.firstName && author.lastName \n                  ? `${author.firstName} ${author.lastName}` \n                  : author.email}\n              </p>\n              <p className=\"text-xs text-white/70\" data-testid=\"story-time\">\n                {currentStory.createdAt && formatDistanceToNow(new Date(currentStory.createdAt), { addSuffix: true })}\n              </p>\n            </div>\n          </div>\n          \n          <div className=\"flex items-center gap-2\">\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              className=\"text-white\"\n              onClick={(e) => {\n                e.stopPropagation();\n                setIsPaused(p => !p);\n              }}\n              data-testid=\"button-pause-story\"\n            >\n              {isPaused ? <Play className=\"w-5 h-5\" /> : <Pause className=\"w-5 h-5\" />}\n            </Button>\n            {currentStory.type === \"video\" && (\n              <Button\n                size=\"icon\"\n                variant=\"ghost\"\n                className=\"text-white\"\n                onClick={(e) => {\n                  e.stopPropagation();\n                  setIsMuted(m => !m);\n                  if (videoRef.current) {\n                    videoRef.current.muted = !isMuted;\n                  }\n                }}\n                data-testid=\"button-mute-story\"\n              >\n                {isMuted ? <VolumeX className=\"w-5 h-5\" /> : <Volume2 className=\"w-5 h-5\" />}\n              </Button>\n            )}\n            {isOwnStory && (\n              <Button\n                size=\"icon\"\n                variant=\"ghost\"\n                className=\"text-white\"\n                onClick={(e) => {\n                  e.stopPropagation();\n                  deleteMutation.mutate(currentStory.id);\n                }}\n                data-testid=\"button-delete-story\"\n              >\n                <Trash2 className=\"w-5 h-5\" />\n              </Button>\n            )}\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              className=\"text-white\"\n              onClick={(e) => {\n                e.stopPropagation();\n                onClose();\n              }}\n              data-testid=\"button-close-story\"\n            >\n              <X className=\"w-5 h-5\" />\n            </Button>\n          </div>\n        </div>\n        \n        <div className=\"flex-1 flex items-center justify-center\">\n          {currentStory.type === \"text\" ? (\n            <div \n              className=\"w-full h-full flex items-center justify-center p-8\"\n              style={{ backgroundColor: currentStory.backgroundColor || \"#16a34a\" }}\n            >\n              <p \n                className=\"text-white text-2xl font-semibold text-center break-words\"\n                style={{ fontFamily: currentStory.fontStyle || \"sans-serif\" }}\n                data-testid=\"story-text-content\"\n              >\n                {currentStory.textContent}\n              </p>\n            </div>\n          ) : currentStory.type === \"image\" ? (\n            <img \n              src={currentStory.mediaUrl || \"\"} \n              alt=\"Story\" \n              className=\"w-full h-full object-contain\"\n              data-testid=\"story-image\"\n            />\n          ) : (\n            <video\n              ref={videoRef}\n              src={currentStory.mediaUrl || \"\"}\n              className=\"w-full h-full object-contain\"\n              autoPlay\n              muted={isMuted}\n              loop={false}\n              playsInline\n              onLoadedMetadata={() => startProgress()}\n              data-testid=\"story-video\"\n            />\n          )}\n        </div>\n        \n        {isOwnStory ? (\n          <div className=\"absolute bottom-4 left-0 right-0 flex items-center justify-center gap-4 px-4\">\n            <div className=\"flex items-center gap-2 bg-black/50 rounded-full px-4 py-2\">\n              <Eye className=\"w-5 h-5 text-white\" />\n              <span className=\"text-white text-sm\" data-testid=\"story-views-count\">\n                {currentStory.viewsCount || 0} views\n              </span>\n            </div>\n            <div className=\"flex items-center gap-2 bg-black/50 rounded-full px-4 py-2\">\n              <Heart className=\"w-5 h-5 text-white\" />\n              <span className=\"text-white text-sm\" data-testid=\"story-likes-count\">\n                {currentStory.likesCount || 0}\n              </span>\n            </div>\n          </div>\n        ) : (\n          <div className=\"absolute bottom-4 left-0 right-0 px-4 flex flex-col gap-2\">\n            <AnimatePresence>\n              {showReactions && (\n                <motion.div\n                  initial={{ opacity: 0, y: 20 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  exit={{ opacity: 0, y: 20 }}\n                  className=\"flex justify-center gap-3 bg-black/60 rounded-full px-4 py-2 mx-auto\"\n                >\n                  {REACTIONS.map(reaction => (\n                    <button\n                      key={reaction}\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        handleReact(reaction);\n                      }}\n                      className=\"text-2xl\"\n                      data-testid={`reaction-${reaction}`}\n                    >\n                      <svg className=\"w-8 h-8 text-white\" fill=\"none\" viewBox=\"0 0 24 24\" strokeWidth={1.5} stroke=\"currentColor\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d={REACTION_ICONS[reaction]} />\n                      </svg>\n                    </button>\n                  ))}\n                </motion.div>\n              )}\n            </AnimatePresence>\n            \n            <div className=\"flex items-center gap-2\" onClick={(e) => e.stopPropagation()}>\n              <Input\n                value={replyText}\n                onChange={(e) => setReplyText(e.target.value)}\n                placeholder=\"Reply to story...\"\n                className=\"flex-1 bg-black/50 border-white/20 text-white placeholder:text-white/50\"\n                onFocus={() => setIsPaused(true)}\n                onBlur={() => setIsPaused(false)}\n                onKeyPress={(e) => e.key === \"Enter\" && handleReply()}\n                data-testid=\"input-story-reply\"\n              />\n              <Button\n                size=\"icon\"\n                variant=\"ghost\"\n                className=\"text-white\"\n                onClick={() => setShowReactions(s => !s)}\n                data-testid=\"button-show-reactions\"\n              >\n                <Heart className=\"w-5 h-5\" />\n              </Button>\n              <Button\n                size=\"icon\"\n                variant=\"ghost\"\n                className=\"text-white\"\n                onClick={handleReply}\n                disabled={!replyText.trim() || replyMutation.isPending}\n                data-testid=\"button-send-reply\"\n              >\n                <Send className=\"w-5 h-5\" />\n              </Button>\n            </div>\n          </div>\n        )}\n        \n        <button\n          className=\"absolute left-0 top-1/2 -translate-y-1/2 p-2 text-white/70\"\n          onClick={(e) => {\n            e.stopPropagation();\n            goToPrev();\n          }}\n          disabled={currentIndex === 0}\n          data-testid=\"button-prev-story\"\n        >\n          <ChevronLeft className=\"w-8 h-8\" />\n        </button>\n        \n        <button\n          className=\"absolute right-0 top-1/2 -translate-y-1/2 p-2 text-white/70\"\n          onClick={(e) => {\n            e.stopPropagation();\n            goToNext();\n          }}\n          data-testid=\"button-next-story\"\n        >\n          <ChevronRight className=\"w-8 h-8\" />\n        </button>\n      </div>\n    </div>\n  );\n}\n\nfunction CreateStoryModal({\n  isOpen,\n  onClose,\n}: {\n  isOpen: boolean;\n  onClose: () => void;\n}) {\n  const [storyType, setStoryType] = useState<\"text\" | \"image\" | \"video\">(\"text\");\n  const [textContent, setTextContent] = useState(\"\");\n  const [backgroundColor, setBackgroundColor] = useState(BACKGROUND_COLORS[0]);\n  const [fontStyle, setFontStyle] = useState(\"sans-serif\");\n  const [mediaFile, setMediaFile] = useState<File | null>(null);\n  const [mediaPreview, setMediaPreview] = useState<string | null>(null);\n  const [uploadProgress, setUploadProgress] = useState(0);\n  const [isUploading, setIsUploading] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const { toast } = useToast();\n  \n  const createMutation = useMutation({\n    mutationFn: async (formData: FormData) => {\n      setIsUploading(true);\n      setUploadProgress(0);\n      \n      return new Promise((resolve, reject) => {\n        const xhr = new XMLHttpRequest();\n        \n        xhr.upload.addEventListener(\"progress\", (event) => {\n          if (event.lengthComputable) {\n            const percent = Math.round((event.loaded / event.total) * 100);\n            setUploadProgress(percent);\n          }\n        });\n        \n        xhr.addEventListener(\"load\", () => {\n          setIsUploading(false);\n          if (xhr.status >= 200 && xhr.status < 300) {\n            resolve(JSON.parse(xhr.responseText));\n          } else {\n            try {\n              const error = JSON.parse(xhr.responseText);\n              reject(new Error(error.message || \"Failed to create story\"));\n            } catch {\n              reject(new Error(\"Failed to create story\"));\n            }\n          }\n        });\n        \n        xhr.addEventListener(\"error\", () => {\n          setIsUploading(false);\n          reject(new Error(\"Network error occurred\"));\n        });\n        \n        xhr.open(\"POST\", \"/api/stories\");\n        xhr.withCredentials = true;\n        xhr.send(formData);\n      });\n    },\n    onSuccess: () => {\n      toast({ title: \"Story posted!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stories\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stories/users\"] });\n      handleClose();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n  \n  const handleClose = () => {\n    setStoryType(\"text\");\n    setTextContent(\"\");\n    setBackgroundColor(BACKGROUND_COLORS[0]);\n    setFontStyle(\"sans-serif\");\n    setMediaFile(null);\n    setMediaPreview(null);\n    setUploadProgress(0);\n    setIsUploading(false);\n    onClose();\n  };\n  \n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      setMediaFile(file);\n      const reader = new FileReader();\n      reader.onload = () => setMediaPreview(reader.result as string);\n      reader.readAsDataURL(file);\n      \n      if (file.type.startsWith(\"video/\")) {\n        setStoryType(\"video\");\n      } else {\n        setStoryType(\"image\");\n      }\n    }\n  };\n  \n  const handleSubmit = () => {\n    if (storyType === \"text\" && !textContent.trim()) {\n      toast({ title: \"Please enter some text\", variant: \"destructive\" });\n      return;\n    }\n    \n    if ((storyType === \"image\" || storyType === \"video\") && !mediaFile) {\n      toast({ title: \"Please select a file\", variant: \"destructive\" });\n      return;\n    }\n    \n    const formData = new FormData();\n    formData.append(\"type\", storyType);\n    \n    if (storyType === \"text\") {\n      formData.append(\"textContent\", textContent);\n      formData.append(\"backgroundColor\", backgroundColor);\n      formData.append(\"fontStyle\", fontStyle);\n    } else if (mediaFile) {\n      formData.append(\"media\", mediaFile);\n    }\n    \n    createMutation.mutate(formData);\n  };\n  \n  const canSubmit = storyType === \"text\" \n    ? textContent.trim().length > 0 \n    : !!mediaFile;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={(open) => !open && handleClose()}>\n      <DialogContent className=\"max-w-md p-0 flex flex-col max-h-[80vh] sm:max-h-[85vh] overflow-hidden\">\n        <DialogHeader className=\"p-4 border-b shrink-0\">\n          <DialogTitle>Create Story</DialogTitle>\n        </DialogHeader>\n        \n        <div className=\"flex-1 overflow-y-auto min-h-0 p-4\">\n          <div className=\"flex gap-2 mb-4\">\n            <Button\n              variant={storyType === \"text\" ? \"default\" : \"outline\"}\n              onClick={() => {\n                setStoryType(\"text\");\n                setMediaFile(null);\n                setMediaPreview(null);\n              }}\n              className=\"flex-1\"\n              data-testid=\"button-story-type-text\"\n              aria-label=\"Create text story\"\n            >\n              <Type className=\"w-4 h-4 mr-2\" aria-hidden=\"true\" />\n              Text\n            </Button>\n            <Button\n              variant={(storyType === \"image\" || storyType === \"video\") ? \"default\" : \"outline\"}\n              onClick={() => {\n                fileInputRef.current?.click();\n              }}\n              className=\"flex-1\"\n              data-testid=\"button-story-type-media\"\n              aria-label=\"Upload photo or video for story\"\n            >\n              <ImageIcon className=\"w-4 h-4 mr-2\" aria-hidden=\"true\" />\n              Media\n            </Button>\n          </div>\n          \n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            accept=\"image/*,video/*\"\n            className=\"hidden\"\n            onChange={handleFileSelect}\n            data-testid=\"input-story-media\"\n            aria-label=\"Upload photo or video for story\"\n          />\n          \n          {storyType === \"text\" ? (\n            <>\n              <div \n                className=\"aspect-[9/16] max-h-[35vh] rounded-lg mb-4 flex items-center justify-center p-4\"\n                style={{ backgroundColor }}\n              >\n                <Textarea\n                  value={textContent}\n                  onChange={(e) => setTextContent(e.target.value)}\n                  placeholder=\"Type your story...\"\n                  className=\"bg-transparent border-none text-white text-xl text-center resize-none focus-visible:ring-0 placeholder:text-white/50\"\n                  style={{ fontFamily: fontStyle }}\n                  rows={6}\n                  data-testid=\"textarea-story-text\"\n                />\n              </div>\n              \n              <div className=\"mb-4\">\n                <p className=\"text-sm text-muted-foreground mb-2\">Background Color</p>\n                <div className=\"flex gap-2 flex-wrap\">\n                  {BACKGROUND_COLORS.map(color => (\n                    <button\n                      key={color}\n                      className={`w-8 h-8 rounded-full ${backgroundColor === color ? \"ring-2 ring-offset-2 ring-foreground\" : \"\"}`}\n                      style={{ backgroundColor: color }}\n                      onClick={() => setBackgroundColor(color)}\n                      data-testid={`color-${color.replace(\"#\", \"\")}`}\n                    />\n                  ))}\n                </div>\n              </div>\n              \n              <div className=\"mb-4\">\n                <p className=\"text-sm text-muted-foreground mb-2\">Font Style</p>\n                <div className=\"flex gap-2 flex-wrap\">\n                  {FONT_STYLES.map(font => (\n                    <Button\n                      key={font.value}\n                      variant={fontStyle === font.value ? \"default\" : \"outline\"}\n                      size=\"sm\"\n                      onClick={() => setFontStyle(font.value)}\n                      style={{ fontFamily: font.value }}\n                      data-testid={`font-${font.value}`}\n                    >\n                      {font.name}\n                    </Button>\n                  ))}\n                </div>\n              </div>\n            </>\n          ) : (\n            <div \n              className=\"aspect-[9/16] max-h-[35vh] rounded-lg mb-4 bg-muted flex items-center justify-center overflow-hidden cursor-pointer\"\n              onClick={() => !mediaPreview && fileInputRef.current?.click()}\n            >\n              {mediaPreview ? (\n                storyType === \"video\" ? (\n                  <video \n                    src={mediaPreview} \n                    className=\"w-full h-full object-contain\" \n                    controls\n                    playsInline\n                    data-testid=\"preview-video\"\n                  />\n                ) : (\n                  <img \n                    src={mediaPreview} \n                    alt=\"Preview\" \n                    className=\"w-full h-full object-contain\"\n                    data-testid=\"preview-image\"\n                  />\n                )\n              ) : (\n                <div className=\"text-center text-muted-foreground p-4\">\n                  <ImageIcon className=\"w-12 h-12 mx-auto mb-2\" />\n                  <p>Tap to select media</p>\n                </div>\n              )}\n            </div>\n          )}\n          \n          {mediaPreview && (storyType === \"image\" || storyType === \"video\") && (\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => fileInputRef.current?.click()}\n              className=\"w-full mb-4\"\n              data-testid=\"button-change-media\"\n            >\n              <ImageIcon className=\"w-4 h-4 mr-2\" />\n              Change Media\n            </Button>\n          )}\n        </div>\n        \n        <div className=\"shrink-0 p-4 border-t bg-background z-50\">\n          {isUploading && (\n            <div className=\"mb-3\">\n              <div className=\"flex items-center justify-between text-sm text-muted-foreground mb-1\">\n                <span>Uploading...</span>\n                <span>{uploadProgress}%</span>\n              </div>\n              <Progress value={uploadProgress} className=\"h-2\" data-testid=\"upload-progress\" />\n            </div>\n          )}\n          \n          <Button\n            className=\"w-full\"\n            onClick={handleSubmit}\n            disabled={createMutation.isPending || isUploading || !canSubmit}\n            data-testid=\"button-post-story\"\n          >\n            {isUploading ? (\n              <>\n                <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                  <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                </svg>\n                Uploading {uploadProgress}%\n              </>\n            ) : createMutation.isPending ? (\n              \"Posting...\"\n            ) : (\n              \"Post Story\"\n            )}\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nexport function StoriesBar({ onViewStory }: { onViewStory?: (stories: StoryWithAuthor[], startIndex: number) => void }) {\n  const { user } = useAuth();\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [selectedUserStories, setSelectedUserStories] = useState<StoryWithAuthor[] | null>(null);\n  \n  const { data: usersWithStories, isLoading: usersLoading } = useQuery<UserWithStories[]>({\n    queryKey: [\"/api/stories/users\"],\n    enabled: !!user,\n  });\n  \n  const { data: allStories } = useQuery<StoryWithAuthor[]>({\n    queryKey: [\"/api/stories\"],\n    enabled: !!user,\n  });\n  \n  const { data: ownStories } = useQuery<StoryWithAuthor[]>({\n    queryKey: [\"/api/stories/user\", user?.id],\n    enabled: !!user?.id,\n  });\n  \n  const hasOwnStory = ownStories && ownStories.length > 0;\n  \n  const handleStoryClick = (userId: string) => {\n    if (userId === user?.id) {\n      if (hasOwnStory && ownStories) {\n        if (onViewStory) {\n          onViewStory(ownStories, 0);\n        } else {\n          setSelectedUserStories(ownStories);\n        }\n      } else {\n        setShowCreateModal(true);\n      }\n    } else {\n      const userStories = allStories?.filter(s => s.authorId === userId) || [];\n      if (userStories.length > 0) {\n        if (onViewStory) {\n          onViewStory(userStories, 0);\n        } else {\n          setSelectedUserStories(userStories);\n        }\n      }\n    }\n  };\n  \n  if (!user) return null;\n\n  return (\n    <>\n      <ScrollArea className=\"w-full\">\n        <div className=\"flex gap-3 p-3\" data-testid=\"stories-bar\">\n          <StoryRing\n            user={user}\n            hasUnviewed={false}\n            isOwn={true}\n            onClick={() => handleStoryClick(user.id)}\n          />\n          \n          {usersLoading ? (\n            Array.from({ length: 5 }).map((_, i) => (\n              <div key={i} className=\"flex flex-col items-center gap-1 min-w-[72px]\">\n                <Skeleton className=\"w-16 h-16 rounded-full\" />\n                <Skeleton className=\"w-12 h-3\" />\n              </div>\n            ))\n          ) : (\n            usersWithStories?.filter(u => u.user.id !== user.id).map(({ user: storyUser, hasUnviewed }) => (\n              <StoryRing\n                key={storyUser.id}\n                user={storyUser}\n                hasUnviewed={hasUnviewed}\n                onClick={() => handleStoryClick(storyUser.id)}\n              />\n            ))\n          )}\n        </div>\n        <ScrollBar orientation=\"horizontal\" />\n      </ScrollArea>\n      \n      <CreateStoryModal\n        isOpen={showCreateModal}\n        onClose={() => setShowCreateModal(false)}\n      />\n      \n      {selectedUserStories && user && (\n        <StoryViewer\n          stories={selectedUserStories}\n          onClose={() => setSelectedUserStories(null)}\n          currentUserId={user.id}\n        />\n      )}\n    </>\n  );\n}\n\nexport default function StoriesPage() {\n  const { user } = useAuth();\n  const [selectedStories, setSelectedStories] = useState<StoryWithAuthor[] | null>(null);\n  \n  if (!user) {\n    return (\n      <div className=\"flex items-center justify-center h-[calc(100vh-4rem)]\">\n        <p className=\"text-muted-foreground\">Please log in to view stories</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col h-full\">\n      <div className=\"border-b\">\n        <StoriesBar \n          onViewStory={(stories) => setSelectedStories(stories)}\n        />\n      </div>\n      \n      <div className=\"flex-1 flex items-center justify-center p-8\">\n        <div className=\"text-center text-muted-foreground\">\n          <p className=\"text-lg mb-2\">Click on a story to view</p>\n          <p>Stories disappear after 24 hours</p>\n        </div>\n      </div>\n      \n      {selectedStories && (\n        <StoryViewer\n          stories={selectedStories}\n          onClose={() => setSelectedStories(null)}\n          currentUserId={user.id}\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":33800,"size_tokens":null},"client/src/pages/communities.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Label } from \"@/components/ui/label\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Users,\n  Plus,\n  Heart,\n  MessageCircle,\n  Send,\n  ArrowLeft,\n  Globe,\n  Lock,\n  Mail,\n  Image as ImageIcon,\n  X,\n  Pin,\n  BookOpen,\n  Gamepad2,\n  Music,\n  Film,\n  Code,\n  Utensils,\n  Briefcase,\n  Shirt,\n  MoreHorizontal,\n  Search,\n  TrendingUp,\n  CheckCircle,\n  Crown,\n  Shield,\n  ChevronRight,\n} from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport type { Community, CommunityPost, CommunityPostComment, CommunityMember } from \"@shared/schema\";\n\nconst COMMUNITY_CATEGORIES = [\n  { value: \"general\", label: \"General\", icon: Globe },\n  { value: \"academics\", label: \"Academics\", icon: BookOpen },\n  { value: \"gaming\", label: \"Gaming\", icon: Gamepad2 },\n  { value: \"music\", label: \"Music\", icon: Music },\n  { value: \"entertainment\", label: \"Entertainment\", icon: Film },\n  { value: \"technology\", label: \"Technology\", icon: Code },\n  { value: \"food\", label: \"Food & Cooking\", icon: Utensils },\n  { value: \"career\", label: \"Career & Jobs\", icon: Briefcase },\n  { value: \"fashion\", label: \"Fashion\", icon: Shirt },\n];\n\nconst CATEGORY_COLORS: Record<string, string> = {\n  general: \"bg-gray-500/10 text-gray-600 dark:text-gray-400\",\n  academics: \"bg-blue-500/10 text-blue-600 dark:text-blue-400\",\n  gaming: \"bg-purple-500/10 text-purple-600 dark:text-purple-400\",\n  music: \"bg-pink-500/10 text-pink-600 dark:text-pink-400\",\n  entertainment: \"bg-orange-500/10 text-orange-600 dark:text-orange-400\",\n  technology: \"bg-cyan-500/10 text-cyan-600 dark:text-cyan-400\",\n  food: \"bg-yellow-500/10 text-yellow-600 dark:text-yellow-400\",\n  career: \"bg-green-500/10 text-green-600 dark:text-green-400\",\n  fashion: \"bg-rose-500/10 text-rose-600 dark:text-rose-400\",\n};\n\nconst TYPE_CONFIG = {\n  public: { icon: Globe, label: \"Public\", desc: \"Anyone can join\" },\n  private: { icon: Lock, label: \"Private\", desc: \"Requires approval\" },\n  invite_only: { icon: Mail, label: \"Invite Only\", desc: \"By invitation\" },\n};\n\nconst ROLE_BADGES: Record<string, { color: string; icon: typeof Crown }> = {\n  owner: { color: \"bg-yellow-500/10 text-yellow-600 dark:text-yellow-400\", icon: Crown },\n  admin: { color: \"bg-red-500/10 text-red-600 dark:text-red-400\", icon: Shield },\n  moderator: { color: \"bg-blue-500/10 text-blue-600 dark:text-blue-400\", icon: Shield },\n  member: { color: \"bg-green-500/10 text-green-600 dark:text-green-400\", icon: CheckCircle },\n};\n\ntype CommunityWithOwner = Community & {\n  owner?: { id: string; firstName: string | null; lastName: string | null; profileImageUrl: string | null } | null;\n  membership?: CommunityMember | null;\n};\n\ntype PostWithAuthor = CommunityPost & {\n  author?: { id: string; firstName: string | null; lastName: string | null; profileImageUrl: string | null } | null;\n  isLiked?: boolean;\n};\n\ntype CommentWithAuthor = CommunityPostComment & {\n  author?: { id: string; firstName: string | null; lastName: string | null; profileImageUrl: string | null } | null;\n};\n\nfunction CategoryBadge({ category }: { category: string }) {\n  const cat = COMMUNITY_CATEGORIES.find(c => c.value === category);\n  const Icon = cat?.icon || Globe;\n  const colorClass = CATEGORY_COLORS[category] || CATEGORY_COLORS.general;\n  \n  return (\n    <Badge variant=\"outline\" className={`text-xs gap-1 ${colorClass}`}>\n      <Icon className=\"h-3 w-3\" />\n      {cat?.label || category}\n    </Badge>\n  );\n}\n\nfunction CommunityCard({ \n  community, \n  onClick \n}: { \n  community: CommunityWithOwner;\n  onClick: () => void;\n}) {\n  const typeConfig = TYPE_CONFIG[community.type as keyof typeof TYPE_CONFIG] || TYPE_CONFIG.public;\n  const TypeIcon = typeConfig.icon;\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.3 }}\n    >\n      <Card \n        className=\"overflow-visible hover-elevate cursor-pointer\"\n        onClick={onClick}\n        data-testid={`card-community-${community.id}`}\n      >\n        <div className=\"relative h-24 bg-gradient-to-br from-primary/20 to-primary/5\">\n          {community.coverUrl && (\n            <img \n              src={community.coverUrl} \n              alt=\"\" \n              className=\"w-full h-full object-cover\"\n            />\n          )}\n          <div className=\"absolute -bottom-6 left-4\">\n            <Avatar className=\"h-14 w-14 border-4 border-background\">\n              <AvatarImage src={community.iconUrl || undefined} />\n              <AvatarFallback className=\"bg-primary/20 text-primary text-lg font-bold\">\n                {community.name.charAt(0).toUpperCase()}\n              </AvatarFallback>\n            </Avatar>\n          </div>\n        </div>\n        <CardContent className=\"pt-8 pb-4\">\n          <div className=\"flex items-start justify-between gap-2\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center gap-2 flex-wrap\">\n                <h3 className=\"font-semibold text-foreground truncate\">{community.name}</h3>\n                <TypeIcon className=\"h-4 w-4 text-muted-foreground\" />\n              </div>\n              <p className=\"text-xs text-muted-foreground\">c/{community.slug}</p>\n            </div>\n            {community.category && <CategoryBadge category={community.category} />}\n          </div>\n          \n          {community.description && (\n            <p className=\"mt-2 text-sm text-muted-foreground line-clamp-2\">\n              {community.description}\n            </p>\n          )}\n          \n          <div className=\"flex items-center gap-4 mt-3 text-xs text-muted-foreground\">\n            <span className=\"flex items-center gap-1\">\n              <Users className=\"h-3.5 w-3.5\" />\n              {community.membersCount || 0} members\n            </span>\n            <span className=\"flex items-center gap-1\">\n              <MessageCircle className=\"h-3.5 w-3.5\" />\n              {community.postsCount || 0} posts\n            </span>\n          </div>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nfunction PostCard({\n  post,\n  community,\n  onLike,\n  onComment,\n  currentUserId,\n}: {\n  post: PostWithAuthor;\n  community: CommunityWithOwner;\n  onLike: (postId: string) => void;\n  onComment: (postId: string) => void;\n  currentUserId?: string;\n}) {\n  const authorName = post.author \n    ? `${post.author.firstName} ${post.author.lastName}` \n    : \"Unknown User\";\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.3 }}\n    >\n      <Card className=\"overflow-visible\" data-testid={`card-post-${post.id}`}>\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-start gap-3\">\n            <Avatar className=\"h-10 w-10\">\n              <AvatarImage src={post.author?.profileImageUrl || undefined} />\n              <AvatarFallback className=\"bg-primary/20 text-primary\">\n                {authorName.charAt(0).toUpperCase()}\n              </AvatarFallback>\n            </Avatar>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center gap-2 flex-wrap\">\n                <span className=\"font-semibold text-foreground text-sm\">\n                  {authorName}\n                </span>\n                {post.isPinned && (\n                  <Badge variant=\"secondary\" className=\"text-xs bg-primary/10 text-primary\">\n                    <Pin className=\"h-3 w-3 mr-1\" />\n                    Pinned\n                  </Badge>\n                )}\n                <span className=\"text-xs text-muted-foreground\">\n                  {formatDistanceToNow(new Date(post.createdAt!), { addSuffix: true })}\n                </span>\n              </div>\n              \n              {post.title && (\n                <h4 className=\"mt-1 font-medium text-foreground\">{post.title}</h4>\n              )}\n              \n              <p className=\"mt-2 text-foreground whitespace-pre-wrap break-words text-sm leading-relaxed\">\n                {post.content}\n              </p>\n\n              {post.images && post.images.length > 0 && (\n                <div className=\"mt-3 grid grid-cols-2 gap-2\">\n                  {post.images.slice(0, 4).map((img, idx) => (\n                    <img \n                      key={idx}\n                      src={img}\n                      alt=\"\"\n                      className=\"rounded-md object-cover w-full h-32\"\n                    />\n                  ))}\n                </div>\n              )}\n\n              <div className=\"flex items-center gap-4 mt-3 pt-2 border-t border-border\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={(e) => { e.stopPropagation(); onLike(post.id); }}\n                  className={`gap-1.5 ${post.isLiked ? \"text-red-500\" : \"text-muted-foreground\"}`}\n                  data-testid={`button-like-post-${post.id}`}\n                >\n                  <Heart className={`h-4 w-4 ${post.isLiked ? \"fill-current\" : \"\"}`} />\n                  <span>{post.likesCount || 0}</span>\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={(e) => { e.stopPropagation(); onComment(post.id); }}\n                  className=\"gap-1.5 text-muted-foreground\"\n                  data-testid={`button-comment-post-${post.id}`}\n                >\n                  <MessageCircle className=\"h-4 w-4\" />\n                  <span>{post.commentsCount || 0}</span>\n                </Button>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nfunction CommentsDialog({\n  open,\n  onOpenChange,\n  postId,\n  communityId,\n}: {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  postId: string | null;\n  communityId: string;\n}) {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [newComment, setNewComment] = useState(\"\");\n\n  const { data: comments = [], isLoading } = useQuery<CommentWithAuthor[]>({\n    queryKey: ['/api/community-posts', postId, 'comments'],\n    enabled: !!postId && open,\n  });\n\n  const addCommentMutation = useMutation({\n    mutationFn: async (data: { content: string }) => {\n      const res = await apiRequest('POST', `/api/community-posts/${postId}/comments`, data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/community-posts', postId, 'comments'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/communities', communityId, 'posts'] });\n      setNewComment(\"\");\n      toast({ title: \"Comment added!\" });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const handleSubmitComment = () => {\n    if (!newComment.trim()) return;\n    addCommentMutation.mutate({ content: newComment.trim() });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-lg max-h-[80vh] flex flex-col\">\n        <DialogHeader>\n          <DialogTitle>Comments</DialogTitle>\n        </DialogHeader>\n        \n        <ScrollArea className=\"flex-1 pr-4\">\n          <div className=\"space-y-4\">\n            {isLoading ? (\n              <div className=\"space-y-3\">\n                {[1, 2, 3].map(i => (\n                  <div key={i} className=\"flex gap-3\">\n                    <Skeleton className=\"h-8 w-8 rounded-full\" />\n                    <div className=\"flex-1 space-y-2\">\n                      <Skeleton className=\"h-4 w-24\" />\n                      <Skeleton className=\"h-12 w-full\" />\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : comments.length === 0 ? (\n              <p className=\"text-center text-muted-foreground py-8\">No comments yet. Be the first!</p>\n            ) : (\n              comments.map(comment => (\n                <div key={comment.id} className=\"flex gap-3\" data-testid={`comment-${comment.id}`}>\n                  <Avatar className=\"h-8 w-8\">\n                    <AvatarImage src={comment.author?.profileImageUrl || undefined} />\n                    <AvatarFallback className=\"bg-primary/20 text-primary text-xs\">\n                      {comment.author?.firstName?.charAt(0) || \"?\"}\n                    </AvatarFallback>\n                  </Avatar>\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-sm font-medium\">\n                        {comment.author ? `${comment.author.firstName} ${comment.author.lastName}` : \"Unknown\"}\n                      </span>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {formatDistanceToNow(new Date(comment.createdAt!), { addSuffix: true })}\n                      </span>\n                    </div>\n                    <p className=\"text-sm text-foreground mt-1\">{comment.content}</p>\n                  </div>\n                </div>\n              ))\n            )}\n          </div>\n        </ScrollArea>\n\n        <div className=\"flex gap-2 pt-4 border-t mt-4\">\n          <Input\n            placeholder=\"Write a comment...\"\n            value={newComment}\n            onChange={(e) => setNewComment(e.target.value)}\n            onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && handleSubmitComment()}\n            data-testid=\"input-new-comment\"\n          />\n          <Button \n            onClick={handleSubmitComment}\n            disabled={!newComment.trim() || addCommentMutation.isPending}\n            data-testid=\"button-submit-comment\"\n          >\n            <Send className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction CreateCommunityDialog({\n  open,\n  onOpenChange,\n}: {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}) {\n  const { toast } = useToast();\n  const [name, setName] = useState(\"\");\n  const [slug, setSlug] = useState(\"\");\n  const [description, setDescription] = useState(\"\");\n  const [type, setType] = useState<string>(\"public\");\n  const [category, setCategory] = useState<string>(\"general\");\n  const [rules, setRules] = useState(\"\");\n\n  const createMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const res = await apiRequest('POST', '/api/communities', data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/communities'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/communities/joined'] });\n      onOpenChange(false);\n      resetForm();\n      toast({ title: \"Community created successfully!\" });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const resetForm = () => {\n    setName(\"\");\n    setSlug(\"\");\n    setDescription(\"\");\n    setType(\"public\");\n    setCategory(\"general\");\n    setRules(\"\");\n  };\n\n  const handleNameChange = (value: string) => {\n    setName(value);\n    setSlug(value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, ''));\n  };\n\n  const handleSubmit = () => {\n    if (!name.trim() || !slug.trim()) {\n      toast({ title: \"Please fill in required fields\", variant: \"destructive\" });\n      return;\n    }\n\n    const rulesArray = rules.split('\\n').filter(r => r.trim()).map(r => r.trim());\n\n    createMutation.mutate({\n      name: name.trim(),\n      slug: slug.trim(),\n      description: description.trim() || undefined,\n      type,\n      category,\n      rules: rulesArray,\n    });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-md max-h-[85vh] flex flex-col\">\n        <DialogHeader className=\"shrink-0\">\n          <DialogTitle>Create Community</DialogTitle>\n          <DialogDescription>\n            Create a new community for people to join and share content.\n          </DialogDescription>\n        </DialogHeader>\n\n        <ScrollArea className=\"flex-1 pr-4\">\n        <div className=\"space-y-4 py-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"name\">Community Name *</Label>\n            <Input\n              id=\"name\"\n              placeholder=\"e.g., EKSU Tech Enthusiasts\"\n              value={name}\n              onChange={(e) => handleNameChange(e.target.value)}\n              data-testid=\"input-community-name\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"slug\">URL Slug *</Label>\n            <div className=\"flex items-center gap-1\">\n              <span className=\"text-muted-foreground text-sm\">c/</span>\n              <Input\n                id=\"slug\"\n                placeholder=\"eksu-tech\"\n                value={slug}\n                onChange={(e) => setSlug(e.target.value.toLowerCase().replace(/[^a-z0-9-]/g, ''))}\n                data-testid=\"input-community-slug\"\n              />\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"description\">Description</Label>\n            <Textarea\n              id=\"description\"\n              placeholder=\"What's this community about?\"\n              value={description}\n              onChange={(e) => setDescription(e.target.value)}\n              rows={3}\n              data-testid=\"input-community-description\"\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Type</Label>\n              <Select value={type} onValueChange={setType}>\n                <SelectTrigger data-testid=\"select-community-type\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {Object.entries(TYPE_CONFIG).map(([key, config]) => (\n                    <SelectItem key={key} value={key}>\n                      <div className=\"flex items-center gap-2\">\n                        <config.icon className=\"h-4 w-4\" />\n                        {config.label}\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Category</Label>\n              <Select value={category} onValueChange={setCategory}>\n                <SelectTrigger data-testid=\"select-community-category\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {COMMUNITY_CATEGORIES.map(cat => (\n                    <SelectItem key={cat.value} value={cat.value}>\n                      <div className=\"flex items-center gap-2\">\n                        <cat.icon className=\"h-4 w-4\" />\n                        {cat.label}\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"rules\">Community Rules (one per line)</Label>\n            <Textarea\n              id=\"rules\"\n              placeholder=\"Be respectful&#10;No spam&#10;Stay on topic\"\n              value={rules}\n              onChange={(e) => setRules(e.target.value)}\n              rows={3}\n              data-testid=\"input-community-rules\"\n            />\n          </div>\n        </div>\n        </ScrollArea>\n\n        <DialogFooter className=\"shrink-0\">\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)}>\n            Cancel\n          </Button>\n          <Button \n            onClick={handleSubmit}\n            disabled={createMutation.isPending || !name.trim() || !slug.trim()}\n            data-testid=\"button-create-community\"\n          >\n            {createMutation.isPending ? \"Creating...\" : \"Create Community\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction CreatePostDialog({\n  open,\n  onOpenChange,\n  communityId,\n}: {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  communityId: string;\n}) {\n  const { toast } = useToast();\n  const [title, setTitle] = useState(\"\");\n  const [content, setContent] = useState(\"\");\n  const [images, setImages] = useState<string[]>([]);\n  const [imageUrl, setImageUrl] = useState(\"\");\n\n  const createMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const res = await apiRequest('POST', `/api/communities/${communityId}/posts`, data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/communities', communityId, 'posts'] });\n      onOpenChange(false);\n      resetForm();\n      toast({ title: \"Post created!\" });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const resetForm = () => {\n    setTitle(\"\");\n    setContent(\"\");\n    setImages([]);\n    setImageUrl(\"\");\n  };\n\n  const handleAddImage = () => {\n    if (imageUrl.trim() && images.length < 4) {\n      setImages([...images, imageUrl.trim()]);\n      setImageUrl(\"\");\n    }\n  };\n\n  const handleRemoveImage = (idx: number) => {\n    setImages(images.filter((_, i) => i !== idx));\n  };\n\n  const handleSubmit = () => {\n    if (!content.trim()) {\n      toast({ title: \"Please write some content\", variant: \"destructive\" });\n      return;\n    }\n\n    createMutation.mutate({\n      title: title.trim() || undefined,\n      content: content.trim(),\n      images: images.length > 0 ? images : undefined,\n    });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-md\">\n        <DialogHeader>\n          <DialogTitle>Create Post</DialogTitle>\n          <DialogDescription>\n            Share something with the community.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4 py-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"post-title\">Title (optional)</Label>\n            <Input\n              id=\"post-title\"\n              placeholder=\"Give your post a title\"\n              value={title}\n              onChange={(e) => setTitle(e.target.value)}\n              data-testid=\"input-post-title\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"post-content\">Content *</Label>\n            <Textarea\n              id=\"post-content\"\n              placeholder=\"What do you want to share?\"\n              value={content}\n              onChange={(e) => setContent(e.target.value)}\n              rows={5}\n              data-testid=\"input-post-content\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label>Images (up to 4)</Label>\n            {images.length > 0 && (\n              <div className=\"grid grid-cols-4 gap-2 mb-2\">\n                {images.map((img, idx) => (\n                  <div key={idx} className=\"relative\">\n                    <img src={img} alt=\"\" className=\"w-full h-16 object-cover rounded-md\" />\n                    <Button\n                      size=\"icon\"\n                      variant=\"destructive\"\n                      className=\"absolute -top-2 -right-2 h-6 w-6\"\n                      onClick={() => handleRemoveImage(idx)}\n                    >\n                      <X className=\"h-3 w-3\" />\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            )}\n            {images.length < 4 && (\n              <div className=\"flex gap-2\">\n                <Input\n                  placeholder=\"Image URL\"\n                  value={imageUrl}\n                  onChange={(e) => setImageUrl(e.target.value)}\n                  data-testid=\"input-image-url\"\n                />\n                <Button variant=\"outline\" onClick={handleAddImage} disabled={!imageUrl.trim()}>\n                  <ImageIcon className=\"h-4 w-4\" />\n                </Button>\n              </div>\n            )}\n          </div>\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)}>\n            Cancel\n          </Button>\n          <Button \n            onClick={handleSubmit}\n            disabled={createMutation.isPending || !content.trim()}\n            data-testid=\"button-create-post\"\n          >\n            {createMutation.isPending ? \"Posting...\" : \"Post\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction CommunityDetailView({\n  slug,\n  onBack,\n}: {\n  slug: string;\n  onBack: () => void;\n}) {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [showCreatePost, setShowCreatePost] = useState(false);\n  const [selectedPostId, setSelectedPostId] = useState<string | null>(null);\n\n  const { data: community, isLoading: communityLoading } = useQuery<CommunityWithOwner>({\n    queryKey: ['/api/communities', slug],\n  });\n\n  const { data: posts = [], isLoading: postsLoading } = useQuery<PostWithAuthor[]>({\n    queryKey: ['/api/communities', community?.id, 'posts'],\n    enabled: !!community?.id,\n  });\n\n  const joinMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest('POST', `/api/communities/${community?.id}/join`);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/communities', slug] });\n      queryClient.invalidateQueries({ queryKey: ['/api/communities/joined'] });\n      toast({ title: \"Joined community!\" });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const leaveMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest('POST', `/api/communities/${community?.id}/leave`);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/communities', slug] });\n      queryClient.invalidateQueries({ queryKey: ['/api/communities/joined'] });\n      toast({ title: \"Left community\" });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const likeMutation = useMutation({\n    mutationFn: async (postId: string) => {\n      const res = await apiRequest('POST', `/api/community-posts/${postId}/like`);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/communities', community?.id, 'posts'] });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  if (communityLoading) {\n    return (\n      <div className=\"space-y-4 p-4\">\n        <Skeleton className=\"h-32 w-full rounded-lg\" />\n        <Skeleton className=\"h-8 w-48\" />\n        <Skeleton className=\"h-20 w-full\" />\n      </div>\n    );\n  }\n\n  if (!community) {\n    return (\n      <div className=\"text-center py-12\">\n        <p className=\"text-muted-foreground\">Community not found</p>\n        <Button variant=\"ghost\" onClick={onBack}>Go back</Button>\n      </div>\n    );\n  }\n\n  const isMember = !!community.membership;\n  const typeConfig = TYPE_CONFIG[community.type as keyof typeof TYPE_CONFIG] || TYPE_CONFIG.public;\n  const TypeIcon = typeConfig.icon;\n\n  const pinnedPosts = posts.filter(p => p.isPinned);\n  const regularPosts = posts.filter(p => !p.isPinned);\n  const sortedPosts = [...pinnedPosts, ...regularPosts];\n\n  return (\n    <div className=\"flex flex-col pb-20 lg:pb-4\">\n      <div className=\"relative h-40 bg-gradient-to-br from-primary/30 to-primary/10\">\n        {community.coverUrl && (\n          <img \n            src={community.coverUrl} \n            alt=\"\" \n            className=\"w-full h-full object-cover\"\n          />\n        )}\n        <div className=\"absolute inset-0 bg-gradient-to-t from-background/80 to-transparent\" />\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className=\"absolute top-4 left-4 bg-background/50 backdrop-blur-sm\"\n          onClick={onBack}\n          data-testid=\"button-back\"\n        >\n          <ArrowLeft className=\"h-5 w-5\" />\n        </Button>\n      </div>\n\n      <div className=\"relative px-4 -mt-12\">\n        <div className=\"flex items-end gap-4\">\n          <Avatar className=\"h-24 w-24 border-4 border-background\">\n            <AvatarImage src={community.iconUrl || undefined} />\n            <AvatarFallback className=\"bg-primary/20 text-primary text-3xl font-bold\">\n              {community.name.charAt(0).toUpperCase()}\n            </AvatarFallback>\n          </Avatar>\n          <div className=\"flex-1 min-w-0 pb-2\">\n            <h1 className=\"text-2xl font-bold text-foreground truncate\">{community.name}</h1>\n            <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n              <TypeIcon className=\"h-4 w-4\" />\n              <span>c/{community.slug}</span>\n              {community.category && (\n                <>\n                  <span>-</span>\n                  <CategoryBadge category={community.category} />\n                </>\n              )}\n            </div>\n          </div>\n        </div>\n\n        <div className=\"flex items-center justify-between gap-4 mt-4\">\n          <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n            <span className=\"flex items-center gap-1\">\n              <Users className=\"h-4 w-4\" />\n              {community.membersCount || 0} members\n            </span>\n            <span className=\"flex items-center gap-1\">\n              <MessageCircle className=\"h-4 w-4\" />\n              {community.postsCount || 0} posts\n            </span>\n          </div>\n          \n          {isMember ? (\n            <Button \n              variant=\"outline\" \n              onClick={() => leaveMutation.mutate()}\n              disabled={leaveMutation.isPending || community.membership?.role === 'owner'}\n              data-testid=\"button-leave-community\"\n            >\n              {community.membership?.role === 'owner' ? 'Owner' : leaveMutation.isPending ? 'Leaving...' : 'Leave'}\n            </Button>\n          ) : (\n            <Button \n              onClick={() => joinMutation.mutate()}\n              disabled={joinMutation.isPending}\n              data-testid=\"button-join-community\"\n            >\n              {joinMutation.isPending ? 'Joining...' : 'Join Community'}\n            </Button>\n          )}\n        </div>\n      </div>\n\n      <div className=\"p-4 space-y-6\">\n        {community.description && (\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm\">About</CardTitle>\n            </CardHeader>\n            <CardContent className=\"text-sm text-muted-foreground\">\n              {community.description}\n            </CardContent>\n          </Card>\n        )}\n\n        {community.rules && community.rules.length > 0 && (\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm\">Rules</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ol className=\"list-decimal list-inside space-y-1 text-sm text-muted-foreground\">\n                {(community.rules as string[]).map((rule, idx) => (\n                  <li key={idx}>{rule}</li>\n                ))}\n              </ol>\n            </CardContent>\n          </Card>\n        )}\n\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-lg font-semibold\">Posts</h2>\n          {isMember && (\n            <Button onClick={() => setShowCreatePost(true)} data-testid=\"button-new-post\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              New Post\n            </Button>\n          )}\n        </div>\n\n        {postsLoading ? (\n          <div className=\"space-y-4\">\n            {[1, 2, 3].map(i => (\n              <Card key={i}>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex gap-3\">\n                    <Skeleton className=\"h-10 w-10 rounded-full\" />\n                    <div className=\"flex-1 space-y-2\">\n                      <Skeleton className=\"h-4 w-32\" />\n                      <Skeleton className=\"h-20 w-full\" />\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        ) : sortedPosts.length === 0 ? (\n          <Card>\n            <CardContent className=\"py-12 text-center\">\n              <MessageCircle className=\"h-12 w-12 mx-auto text-muted-foreground/50 mb-4\" />\n              <p className=\"text-muted-foreground\">No posts yet. Be the first to share!</p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"space-y-4\">\n            <AnimatePresence>\n              {sortedPosts.map(post => (\n                <PostCard\n                  key={post.id}\n                  post={post}\n                  community={community}\n                  onLike={(postId) => likeMutation.mutate(postId)}\n                  onComment={(postId) => setSelectedPostId(postId)}\n                  currentUserId={user?.id}\n                />\n              ))}\n            </AnimatePresence>\n          </div>\n        )}\n      </div>\n\n      <CreatePostDialog\n        open={showCreatePost}\n        onOpenChange={setShowCreatePost}\n        communityId={community.id}\n      />\n\n      <CommentsDialog\n        open={!!selectedPostId}\n        onOpenChange={(open) => !open && setSelectedPostId(null)}\n        postId={selectedPostId}\n        communityId={community.id}\n      />\n    </div>\n  );\n}\n\nexport default function CommunitiesPage() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"discover\");\n  const [selectedSlug, setSelectedSlug] = useState<string | null>(null);\n  const [showCreateCommunity, setShowCreateCommunity] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const { data: allCommunities = [], isLoading: allLoading } = useQuery<CommunityWithOwner[]>({\n    queryKey: ['/api/communities'],\n  });\n\n  const { data: joinedCommunities = [], isLoading: joinedLoading } = useQuery<CommunityWithOwner[]>({\n    queryKey: ['/api/communities/joined'],\n  });\n\n  const filteredCommunities = searchQuery.trim()\n    ? allCommunities.filter(c => \n        c.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        c.slug.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        c.description?.toLowerCase().includes(searchQuery.toLowerCase())\n      )\n    : allCommunities;\n\n  if (selectedSlug) {\n    return (\n      <CommunityDetailView\n        slug={selectedSlug}\n        onBack={() => setSelectedSlug(null)}\n      />\n    );\n  }\n\n  return (\n    <div className=\"container max-w-4xl mx-auto px-4 py-6 pb-24 lg:pb-6\">\n      <div className=\"flex items-center justify-between gap-4 mb-6\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-foreground\">Communities</h1>\n          <p className=\"text-sm text-muted-foreground\">Join groups and connect with others</p>\n        </div>\n        <Button onClick={() => setShowCreateCommunity(true)} data-testid=\"button-create-community\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Create\n        </Button>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n        <TabsList className=\"w-full grid grid-cols-2 mb-6\">\n          <TabsTrigger value=\"discover\" className=\"gap-2\" data-testid=\"tab-discover\">\n            <TrendingUp className=\"h-4 w-4\" />\n            Discover\n          </TabsTrigger>\n          <TabsTrigger value=\"joined\" className=\"gap-2\" data-testid=\"tab-joined\">\n            <Users className=\"h-4 w-4\" />\n            My Communities\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"discover\" className=\"mt-0\">\n          <div className=\"mb-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search communities...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"input-search-communities\"\n              />\n            </div>\n          </div>\n\n          {allLoading ? (\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              {[1, 2, 3, 4].map(i => (\n                <Card key={i}>\n                  <div className=\"h-24\">\n                    <Skeleton className=\"h-full w-full\" />\n                  </div>\n                  <CardContent className=\"pt-8 pb-4\">\n                    <Skeleton className=\"h-5 w-32 mb-2\" />\n                    <Skeleton className=\"h-4 w-full\" />\n                    <Skeleton className=\"h-4 w-2/3 mt-1\" />\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          ) : filteredCommunities.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-12 text-center\">\n                <Users className=\"h-12 w-12 mx-auto text-muted-foreground/50 mb-4\" />\n                <p className=\"text-muted-foreground\">\n                  {searchQuery ? \"No communities found matching your search\" : \"No communities yet. Create the first one!\"}\n                </p>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <AnimatePresence>\n                {filteredCommunities.map(community => (\n                  <CommunityCard\n                    key={community.id}\n                    community={community}\n                    onClick={() => setSelectedSlug(community.slug)}\n                  />\n                ))}\n              </AnimatePresence>\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"joined\" className=\"mt-0\">\n          {joinedLoading ? (\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              {[1, 2].map(i => (\n                <Card key={i}>\n                  <div className=\"h-24\">\n                    <Skeleton className=\"h-full w-full\" />\n                  </div>\n                  <CardContent className=\"pt-8 pb-4\">\n                    <Skeleton className=\"h-5 w-32 mb-2\" />\n                    <Skeleton className=\"h-4 w-full\" />\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          ) : joinedCommunities.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-12 text-center\">\n                <Users className=\"h-12 w-12 mx-auto text-muted-foreground/50 mb-4\" />\n                <p className=\"text-muted-foreground mb-4\">You haven't joined any communities yet</p>\n                <Button variant=\"outline\" onClick={() => setActiveTab(\"discover\")}>\n                  <Search className=\"h-4 w-4 mr-2\" />\n                  Browse Communities\n                </Button>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <AnimatePresence>\n                {joinedCommunities.map(community => (\n                  <CommunityCard\n                    key={community.id}\n                    community={community}\n                    onClick={() => setSelectedSlug(community.slug)}\n                  />\n                ))}\n              </AnimatePresence>\n            </div>\n          )}\n        </TabsContent>\n      </Tabs>\n\n      <CreateCommunityDialog\n        open={showCreateCommunity}\n        onOpenChange={setShowCreateCommunity}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":40732,"size_tokens":null},"client/src/components/PullToRefresh.tsx":{"content":"import { useState, useEffect, useRef, ReactNode } from 'react';\nimport { RefreshCw } from 'lucide-react';\nimport { motion } from 'framer-motion';\nimport { hapticFeedback } from '@/lib/haptics';\n\ninterface PullToRefreshProps {\n  onRefresh: () => Promise<void>;\n  children: ReactNode;\n  className?: string;\n}\n\nexport function PullToRefresh({ onRefresh, children, className = '' }: PullToRefreshProps) {\n  const [isPulling, setIsPulling] = useState(false);\n  const [pullDistance, setPullDistance] = useState(0);\n  const [isRefreshing, setIsRefreshing] = useState(false);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const startY = useRef(0);\n  const isAtTop = useRef(true);\n\n  const TRIGGER_THRESHOLD = 80;\n  const MAX_PULL = 120;\n\n  useEffect(() => {\n    const container = containerRef.current;\n    if (!container) return;\n\n    const handleTouchStart = (e: TouchEvent) => {\n      if (window.scrollY <= 0) {\n        isAtTop.current = true;\n        startY.current = e.touches[0].clientY;\n      } else {\n        isAtTop.current = false;\n      }\n    };\n\n    const handleTouchMove = (e: TouchEvent) => {\n      if (!isAtTop.current || isRefreshing) return;\n      \n      const currentY = e.touches[0].clientY;\n      const diff = currentY - startY.current;\n      \n      if (diff > 0) {\n        setIsPulling(true);\n        const distance = Math.min(diff * 0.5, MAX_PULL);\n        setPullDistance(distance);\n        \n        if (distance >= TRIGGER_THRESHOLD && !isPulling) {\n          hapticFeedback('light');\n        }\n      }\n    };\n\n    const handleTouchEnd = async () => {\n      if (!isPulling) return;\n      \n      if (pullDistance >= TRIGGER_THRESHOLD && !isRefreshing) {\n        setIsRefreshing(true);\n        hapticFeedback('medium');\n        \n        try {\n          await onRefresh();\n        } finally {\n          setIsRefreshing(false);\n        }\n      }\n      \n      setIsPulling(false);\n      setPullDistance(0);\n    };\n\n    container.addEventListener('touchstart', handleTouchStart, { passive: true });\n    container.addEventListener('touchmove', handleTouchMove, { passive: true });\n    container.addEventListener('touchend', handleTouchEnd, { passive: true });\n\n    return () => {\n      container.removeEventListener('touchstart', handleTouchStart);\n      container.removeEventListener('touchmove', handleTouchMove);\n      container.removeEventListener('touchend', handleTouchEnd);\n    };\n  }, [isPulling, pullDistance, isRefreshing, onRefresh]);\n\n  const progress = Math.min(pullDistance / TRIGGER_THRESHOLD, 1);\n  const rotation = progress * 360;\n\n  return (\n    <div ref={containerRef} className={`relative ${className}`}>\n      <motion.div\n        className=\"absolute left-1/2 -translate-x-1/2 z-10 flex items-center justify-center\"\n        style={{ top: pullDistance - 40 }}\n        animate={{ opacity: isPulling || isRefreshing ? 1 : 0 }}\n      >\n        <div \n          className={`w-8 h-8 rounded-full bg-background border shadow-sm flex items-center justify-center ${isRefreshing ? 'animate-spin' : ''}`}\n          style={{ transform: isRefreshing ? undefined : `rotate(${rotation}deg)` }}\n        >\n          <RefreshCw className=\"w-4 h-4 text-primary\" />\n        </div>\n      </motion.div>\n      \n      <motion.div\n        style={{ transform: isPulling ? `translateY(${pullDistance}px)` : undefined }}\n        transition={{ type: 'spring', stiffness: 300, damping: 30 }}\n      >\n        {children}\n      </motion.div>\n    </div>\n  );\n}\n","path":null,"size_bytes":3463,"size_tokens":null},"client/src/components/OfflineIndicator.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { WifiOff, RefreshCw } from 'lucide-react';\nimport { motion, AnimatePresence } from 'framer-motion';\n\nexport function OfflineIndicator() {\n  const [isOffline, setIsOffline] = useState(false);\n  const [isReconnecting, setIsReconnecting] = useState(false);\n\n  useEffect(() => {\n    const handleOnline = () => {\n      setIsReconnecting(true);\n      setTimeout(() => {\n        setIsOffline(false);\n        setIsReconnecting(false);\n      }, 1000);\n    };\n\n    const handleOffline = () => {\n      setIsOffline(true);\n    };\n\n    setIsOffline(!navigator.onLine);\n\n    window.addEventListener('online', handleOnline);\n    window.addEventListener('offline', handleOffline);\n\n    return () => {\n      window.removeEventListener('online', handleOnline);\n      window.removeEventListener('offline', handleOffline);\n    };\n  }, []);\n\n  return (\n    <AnimatePresence>\n      {(isOffline || isReconnecting) && (\n        <motion.div\n          initial={{ opacity: 0, y: -50 }}\n          animate={{ opacity: 1, y: 0 }}\n          exit={{ opacity: 0, y: -50 }}\n          className=\"fixed top-0 left-0 right-0 z-[100] bg-destructive text-destructive-foreground py-2 px-4 text-center text-sm\"\n          data-testid=\"offline-indicator\"\n        >\n          <div className=\"flex items-center justify-center gap-2\">\n            {isReconnecting ? (\n              <>\n                <RefreshCw className=\"w-4 h-4 animate-spin\" />\n                <span>Reconnecting...</span>\n              </>\n            ) : (\n              <>\n                <WifiOff className=\"w-4 h-4\" />\n                <span>No internet connection</span>\n              </>\n            )}\n          </div>\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}\n","path":null,"size_bytes":1763,"size_tokens":null},"client/src/lib/haptics.ts":{"content":"export function hapticFeedback(type: 'light' | 'medium' | 'heavy' = 'light') {\n  if (typeof navigator === 'undefined' || !navigator.vibrate) {\n    return;\n  }\n\n  const durations = {\n    light: 10,\n    medium: 25,\n    heavy: 50\n  };\n\n  try {\n    navigator.vibrate(durations[type]);\n  } catch {\n  }\n}\n\nexport function hapticSuccess() {\n  if (typeof navigator === 'undefined' || !navigator.vibrate) {\n    return;\n  }\n\n  try {\n    navigator.vibrate([10, 50, 20]);\n  } catch {\n  }\n}\n\nexport function hapticError() {\n  if (typeof navigator === 'undefined' || !navigator.vibrate) {\n    return;\n  }\n\n  try {\n    navigator.vibrate([50, 30, 50, 30, 50]);\n  } catch {\n  }\n}\n\nexport function hapticNotification() {\n  if (typeof navigator === 'undefined' || !navigator.vibrate) {\n    return;\n  }\n\n  try {\n    navigator.vibrate([30, 50, 30]);\n  } catch {\n  }\n}\n","path":null,"size_bytes":847,"size_tokens":null},"client/src/lib/location.ts":{"content":"const EKSU_CAMPUS = {\n  lat: 7.6451,\n  lng: 5.2247,\n  radiusKm: 1.5\n};\n\nconst ADO_EKITI = {\n  lat: 7.6211,\n  lng: 5.2349,\n  radiusKm: 15\n};\n\nconst EKITI_STATE = {\n  lat: 7.7000,\n  lng: 5.3000,\n  radiusKm: 100\n};\n\nexport interface LocationInfo {\n  latitude: number | null;\n  longitude: number | null;\n  displayText: string;\n  distanceKm: number | null;\n  isOnCampus: boolean;\n  locationLevel: 'campus' | 'ado_ekiti' | 'ekiti_state' | 'far_away' | 'unknown';\n}\n\nfunction calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {\n  const R = 6371;\n  const dLat = (lat2 - lat1) * Math.PI / 180;\n  const dLon = (lon2 - lon1) * Math.PI / 180;\n  const a = \n    Math.sin(dLat/2) * Math.sin(dLat/2) +\n    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * \n    Math.sin(dLon/2) * Math.sin(dLon/2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));\n  return R * c;\n}\n\nexport function getLocationDisplayText(lat: number, lng: number): LocationInfo {\n  const distanceFromCampus = calculateDistance(lat, lng, EKSU_CAMPUS.lat, EKSU_CAMPUS.lng);\n  const distanceFromAdo = calculateDistance(lat, lng, ADO_EKITI.lat, ADO_EKITI.lng);\n  const distanceFromEkiti = calculateDistance(lat, lng, EKITI_STATE.lat, EKITI_STATE.lng);\n\n  if (distanceFromCampus <= EKSU_CAMPUS.radiusKm) {\n    return {\n      latitude: lat,\n      longitude: lng,\n      displayText: \"On Campus · EKSU\",\n      distanceKm: distanceFromCampus,\n      isOnCampus: true,\n      locationLevel: 'campus'\n    };\n  }\n\n  if (distanceFromCampus <= 3) {\n    return {\n      latitude: lat,\n      longitude: lng,\n      displayText: `${distanceFromCampus.toFixed(1)}km · Near EKSU`,\n      distanceKm: distanceFromCampus,\n      isOnCampus: false,\n      locationLevel: 'campus'\n    };\n  }\n\n  if (distanceFromAdo <= ADO_EKITI.radiusKm) {\n    return {\n      latitude: lat,\n      longitude: lng,\n      displayText: \"In Ado-Ekiti\",\n      distanceKm: distanceFromCampus,\n      isOnCampus: false,\n      locationLevel: 'ado_ekiti'\n    };\n  }\n\n  if (distanceFromEkiti <= EKITI_STATE.radiusKm) {\n    return {\n      latitude: lat,\n      longitude: lng,\n      displayText: \"In Ekiti State\",\n      distanceKm: distanceFromCampus,\n      isOnCampus: false,\n      locationLevel: 'ekiti_state'\n    };\n  }\n\n  return {\n    latitude: lat,\n    longitude: lng,\n    displayText: \"Far away · Outside Ekiti\",\n    distanceKm: distanceFromCampus,\n    isOnCampus: false,\n    locationLevel: 'far_away'\n  };\n}\n\nexport function getUnknownLocation(): LocationInfo {\n  return {\n    latitude: null,\n    longitude: null,\n    displayText: \"\",\n    distanceKm: null,\n    isOnCampus: false,\n    locationLevel: 'unknown'\n  };\n}\n\nlet cachedLocation: LocationInfo | null = null;\nlet lastLocationFetch: number = 0;\nconst LOCATION_CACHE_MS = 5 * 60 * 1000;\n\nexport async function getCurrentLocation(): Promise<LocationInfo> {\n  if (cachedLocation && Date.now() - lastLocationFetch < LOCATION_CACHE_MS) {\n    return cachedLocation;\n  }\n\n  try {\n    const position = await new Promise<GeolocationPosition>((resolve, reject) => {\n      if (!navigator.geolocation) {\n        reject(new Error('Geolocation not supported'));\n        return;\n      }\n\n      navigator.geolocation.getCurrentPosition(resolve, reject, {\n        enableHighAccuracy: false,\n        timeout: 5000,\n        maximumAge: 300000\n      });\n    });\n\n    const location = getLocationDisplayText(\n      position.coords.latitude,\n      position.coords.longitude\n    );\n    cachedLocation = location;\n    lastLocationFetch = Date.now();\n    return location;\n  } catch {\n    try {\n      const response = await fetch('https://ipapi.co/json/', { \n        signal: AbortSignal.timeout(3000)\n      });\n      \n      if (response.ok) {\n        const data = await response.json();\n        if (data.latitude && data.longitude) {\n          const location = getLocationDisplayText(data.latitude, data.longitude);\n          cachedLocation = location;\n          lastLocationFetch = Date.now();\n          return location;\n        }\n      }\n    } catch {\n    }\n    \n    return getUnknownLocation();\n  }\n}\n\nexport function getLocationForUser(userLat?: string | number | null, userLng?: string | number | null): LocationInfo {\n  if (!userLat || !userLng) {\n    return getUnknownLocation();\n  }\n\n  const lat = typeof userLat === 'string' ? parseFloat(userLat) : userLat;\n  const lng = typeof userLng === 'string' ? parseFloat(userLng) : userLng;\n\n  if (isNaN(lat) || isNaN(lng)) {\n    return getUnknownLocation();\n  }\n\n  return getLocationDisplayText(lat, lng);\n}\n\nexport function getDistanceBetweenUsers(\n  lat1?: string | number | null, \n  lng1?: string | number | null,\n  lat2?: string | number | null,\n  lng2?: string | number | null\n): number | null {\n  if (!lat1 || !lng1 || !lat2 || !lng2) {\n    return null;\n  }\n\n  const parsedLat1 = typeof lat1 === 'string' ? parseFloat(lat1) : lat1;\n  const parsedLng1 = typeof lng1 === 'string' ? parseFloat(lng1) : lng1;\n  const parsedLat2 = typeof lat2 === 'string' ? parseFloat(lat2) : lat2;\n  const parsedLng2 = typeof lng2 === 'string' ? parseFloat(lng2) : lng2;\n\n  if (isNaN(parsedLat1) || isNaN(parsedLng1) || isNaN(parsedLat2) || isNaN(parsedLng2)) {\n    return null;\n  }\n\n  return calculateDistance(parsedLat1, parsedLng1, parsedLat2, parsedLng2);\n}\n","path":null,"size_bytes":5286,"size_tokens":null},"client/src/hooks/useLocation.ts":{"content":"import { useState, useEffect, useCallback } from 'react';\nimport { getCurrentLocation, getLocationForUser, type LocationInfo } from '@/lib/location';\nimport { apiRequest } from '@/lib/queryClient';\n\nexport function useCurrentLocation() {\n  const [location, setLocation] = useState<LocationInfo | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  const fetchLocation = useCallback(async () => {\n    setIsLoading(true);\n    setError(null);\n    \n    try {\n      const loc = await getCurrentLocation();\n      setLocation(loc);\n      \n      if (loc.latitude && loc.longitude) {\n        try {\n          await apiRequest('PATCH', '/api/users/me/location', {\n            latitude: loc.latitude,\n            longitude: loc.longitude\n          });\n        } catch {\n        }\n      }\n    } catch (err) {\n      setError('Could not get location');\n    } finally {\n      setIsLoading(false);\n    }\n  }, []);\n\n  useEffect(() => {\n    fetchLocation();\n  }, [fetchLocation]);\n\n  return { location, isLoading, error, refetch: fetchLocation };\n}\n\nexport function useUserLocation(userLat?: string | number | null, userLng?: string | number | null) {\n  return getLocationForUser(userLat, userLng);\n}\n","path":null,"size_bytes":1257,"size_tokens":null},"client/public/sw.js":{"content":"const CACHE_NAME = 'eksu-market-v1';\nconst STATIC_CACHE = 'eksu-static-v1';\n\nconst STATIC_ASSETS = [\n  '/',\n  '/favicon.png',\n  '/manifest.json'\n];\n\nself.addEventListener('install', (event) => {\n  event.waitUntil(\n    caches.open(STATIC_CACHE).then((cache) => {\n      return cache.addAll(STATIC_ASSETS);\n    })\n  );\n  self.skipWaiting();\n});\n\nself.addEventListener('activate', (event) => {\n  event.waitUntil(\n    caches.keys().then((cacheNames) => {\n      return Promise.all(\n        cacheNames\n          .filter((name) => name !== CACHE_NAME && name !== STATIC_CACHE)\n          .map((name) => caches.delete(name))\n      );\n    })\n  );\n  self.clients.claim();\n});\n\nself.addEventListener('fetch', (event) => {\n  const { request } = event;\n  const url = new URL(request.url);\n\n  if (request.method !== 'GET') {\n    return;\n  }\n\n  if (url.pathname.startsWith('/api/')) {\n    event.respondWith(\n      fetch(request).catch(() => {\n        return new Response(\n          JSON.stringify({ error: 'Offline', message: 'No internet connection' }),\n          { status: 503, headers: { 'Content-Type': 'application/json' } }\n        );\n      })\n    );\n    return;\n  }\n\n  if (request.destination === 'image') {\n    event.respondWith(\n      caches.match(request).then((cachedResponse) => {\n        if (cachedResponse) {\n          return cachedResponse;\n        }\n        return fetch(request).then((response) => {\n          if (response.ok) {\n            const responseClone = response.clone();\n            caches.open(CACHE_NAME).then((cache) => {\n              cache.put(request, responseClone);\n            });\n          }\n          return response;\n        }).catch(() => {\n          return new Response('', { status: 404 });\n        });\n      })\n    );\n    return;\n  }\n\n  event.respondWith(\n    fetch(request)\n      .then((response) => {\n        if (response.ok && url.origin === location.origin) {\n          const responseClone = response.clone();\n          caches.open(CACHE_NAME).then((cache) => {\n            cache.put(request, responseClone);\n          });\n        }\n        return response;\n      })\n      .catch(() => {\n        return caches.match(request).then((cachedResponse) => {\n          if (cachedResponse) {\n            return cachedResponse;\n          }\n          if (request.destination === 'document') {\n            return caches.match('/');\n          }\n          return new Response('Offline', { status: 503 });\n        });\n      })\n  );\n});\n\nself.addEventListener('push', (event) => {\n  const data = event.data?.json() || {};\n  const title = data.title || 'EKSU Marketplace';\n  const options = {\n    body: data.body || 'You have a new notification',\n    icon: '/favicon.png',\n    badge: '/favicon.png',\n    tag: data.tag || 'default',\n    data: { url: data.url || '/' }\n  };\n\n  event.waitUntil(\n    self.registration.showNotification(title, options)\n  );\n});\n\nself.addEventListener('notificationclick', (event) => {\n  event.notification.close();\n  const url = event.notification.data?.url || '/';\n  \n  event.waitUntil(\n    clients.matchAll({ type: 'window', includeUncontrolled: true }).then((clientList) => {\n      for (const client of clientList) {\n        if (client.url.includes(url) && 'focus' in client) {\n          return client.focus();\n        }\n      }\n      if (clients.openWindow) {\n        return clients.openWindow(url);\n      }\n    })\n  );\n});\n","path":null,"size_bytes":3370,"size_tokens":null},"client/src/components/BackToTop.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { ChevronUp } from 'lucide-react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { hapticFeedback } from '@/lib/haptics';\n\nexport function BackToTop() {\n  const [isVisible, setIsVisible] = useState(false);\n\n  useEffect(() => {\n    const handleScroll = () => {\n      setIsVisible(window.scrollY > 400);\n    };\n\n    window.addEventListener('scroll', handleScroll, { passive: true });\n    return () => window.removeEventListener('scroll', handleScroll);\n  }, []);\n\n  const scrollToTop = () => {\n    hapticFeedback('light');\n    window.scrollTo({ top: 0, behavior: 'smooth' });\n  };\n\n  return (\n    <AnimatePresence>\n      {isVisible && (\n        <motion.div\n          initial={{ opacity: 0, scale: 0.8 }}\n          animate={{ opacity: 1, scale: 1 }}\n          exit={{ opacity: 0, scale: 0.8 }}\n          className=\"fixed bottom-20 right-4 z-40 lg:bottom-8\"\n        >\n          <Button\n            size=\"icon\"\n            variant=\"secondary\"\n            onClick={scrollToTop}\n            className=\"h-10 w-10 rounded-full shadow-lg\"\n            data-testid=\"button-back-to-top\"\n          >\n            <ChevronUp className=\"w-5 h-5\" />\n          </Button>\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}\n","path":null,"size_bytes":1332,"size_tokens":null},"client/src/components/PWAInstallPrompt.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { Download, X } from 'lucide-react';\nimport { motion, AnimatePresence } from 'framer-motion';\n\ninterface BeforeInstallPromptEvent extends Event {\n  prompt: () => Promise<void>;\n  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;\n}\n\nexport function PWAInstallPrompt() {\n  const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);\n  const [showPrompt, setShowPrompt] = useState(false);\n  const [dismissed, setDismissed] = useState(false);\n\n  useEffect(() => {\n    const dismissedAt = localStorage.getItem('pwa-prompt-dismissed');\n    if (dismissedAt) {\n      const daysSince = (Date.now() - parseInt(dismissedAt)) / (1000 * 60 * 60 * 24);\n      if (daysSince < 7) {\n        setDismissed(true);\n        return;\n      }\n    }\n\n    const handler = (e: Event) => {\n      e.preventDefault();\n      setDeferredPrompt(e as BeforeInstallPromptEvent);\n      setTimeout(() => {\n        if (!dismissed) {\n          setShowPrompt(true);\n        }\n      }, 3000);\n    };\n\n    window.addEventListener('beforeinstallprompt', handler);\n    return () => window.removeEventListener('beforeinstallprompt', handler);\n  }, [dismissed]);\n\n  const handleInstall = async () => {\n    if (!deferredPrompt) return;\n\n    try {\n      await deferredPrompt.prompt();\n      const { outcome } = await deferredPrompt.userChoice;\n      \n      if (outcome === 'accepted') {\n        setShowPrompt(false);\n      }\n      setDeferredPrompt(null);\n    } catch {\n    }\n  };\n\n  const handleDismiss = () => {\n    setShowPrompt(false);\n    setDismissed(true);\n    localStorage.setItem('pwa-prompt-dismissed', Date.now().toString());\n  };\n\n  if (!showPrompt || dismissed) return null;\n\n  return (\n    <AnimatePresence>\n      <motion.div\n        initial={{ opacity: 0, y: 100 }}\n        animate={{ opacity: 1, y: 0 }}\n        exit={{ opacity: 0, y: 100 }}\n        className=\"fixed bottom-20 left-4 right-4 z-50 lg:left-auto lg:right-4 lg:bottom-4 lg:max-w-sm\"\n      >\n        <Card className=\"shadow-lg border-primary/20\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-start gap-3\">\n              <div className=\"w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center shrink-0\">\n                <Download className=\"w-5 h-5 text-primary\" />\n              </div>\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"font-medium text-sm\">Install EKSU Marketplace</p>\n                <p className=\"text-xs text-muted-foreground mt-0.5\">\n                  Get faster access and offline support\n                </p>\n                <div className=\"flex gap-2 mt-3\">\n                  <Button size=\"sm\" onClick={handleInstall} data-testid=\"button-install-pwa\">\n                    Install\n                  </Button>\n                  <Button size=\"sm\" variant=\"ghost\" onClick={handleDismiss} data-testid=\"button-dismiss-pwa\">\n                    Not now\n                  </Button>\n                </div>\n              </div>\n              <Button\n                size=\"icon\"\n                variant=\"ghost\"\n                className=\"h-6 w-6 shrink-0\"\n                onClick={handleDismiss}\n              >\n                <X className=\"w-4 h-4\" />\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </motion.div>\n    </AnimatePresence>\n  );\n}\n","path":null,"size_bytes":3505,"size_tokens":null},"client/src/pages/bookmarks.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Heart, \n  MessageCircle, \n  Send, \n  Bookmark,\n  BookmarkX,\n  Repeat2,\n  Share,\n  Play,\n  BadgeCheck,\n  Store,\n  Trash2,\n  ArrowLeft\n} from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { Link } from \"wouter\";\nimport type { User, SocialPost, PostBookmark } from \"@shared/schema\";\n\ntype BookmarkWithPost = PostBookmark & { \n  post: SocialPost; \n  author: User;\n};\n\ntype Comment = {\n  id: string;\n  content: string;\n  authorId: string;\n  createdAt: string;\n  author: User;\n};\n\nfunction formatEngagement(count: number): string {\n  if (count >= 1000000) {\n    return `${(count / 1000000).toFixed(1).replace(/\\.0$/, '')}M`;\n  }\n  if (count >= 1000) {\n    return `${(count / 1000).toFixed(1).replace(/\\.0$/, '')}K`;\n  }\n  return count.toString();\n}\n\nfunction MediaGrid({ images, videos }: { images?: string[] | null; videos?: string[] | null }) {\n  const allMedia = [\n    ...(images || []).map(url => ({ url, type: 'image' as const })),\n    ...(videos || []).map(url => ({ url, type: 'video' as const }))\n  ];\n\n  if (allMedia.length === 0) return null;\n\n  const getGridClasses = () => {\n    switch (allMedia.length) {\n      case 1:\n        return \"grid-cols-1\";\n      case 2:\n        return \"grid-cols-2\";\n      case 3:\n        return \"grid-cols-2\";\n      case 4:\n        return \"grid-cols-2\";\n      default:\n        return \"grid-cols-2\";\n    }\n  };\n\n  const getItemClasses = (index: number, total: number) => {\n    if (total === 1) return \"aspect-video\";\n    if (total === 2) return \"aspect-square\";\n    if (total === 3) {\n      if (index === 0) return \"row-span-2 aspect-[2/3]\";\n      return \"aspect-square\";\n    }\n    if (total >= 4) return \"aspect-square\";\n    return \"aspect-square\";\n  };\n\n  return (\n    <div className={`grid ${getGridClasses()} gap-0.5 rounded-xl overflow-hidden`}>\n      {allMedia.slice(0, 4).map((media, idx) => {\n        const isMoreThanFour = allMedia.length > 4 && idx === 3;\n        \n        return (\n          <div \n            key={idx} \n            className={`relative ${getItemClasses(idx, allMedia.length)} overflow-hidden bg-muted`}\n          >\n            {media.type === 'video' ? (\n              <div className=\"relative w-full h-full group\">\n                <video\n                  src={media.url}\n                  className=\"w-full h-full object-cover\"\n                  controls\n                  playsInline\n                  preload=\"metadata\"\n                />\n                <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity bg-black/20\">\n                  <div className=\"h-12 w-12 rounded-full bg-white/90 flex items-center justify-center\">\n                    <Play className=\"h-6 w-6 text-black fill-black ml-0.5\" />\n                  </div>\n                </div>\n              </div>\n            ) : (\n              <img\n                src={media.url}\n                alt={`Media ${idx + 1}`}\n                className=\"w-full h-full object-cover hover:scale-[1.02] transition-transform duration-300\"\n                loading=\"lazy\"\n              />\n            )}\n            {isMoreThanFour && (\n              <div className=\"absolute inset-0 bg-black/60 flex items-center justify-center\">\n                <span className=\"text-white text-xl font-semibold\">+{allMedia.length - 4}</span>\n              </div>\n            )}\n          </div>\n        );\n      })}\n    </div>\n  );\n}\n\nfunction VerifiedBadge({ size = \"sm\" }: { size?: \"sm\" | \"md\" }) {\n  const sizeClasses = size === \"sm\" ? \"h-3.5 w-3.5\" : \"h-4 w-4\";\n  return (\n    <div className=\"relative inline-flex\">\n      <BadgeCheck className={`${sizeClasses} text-primary fill-primary/10`} />\n    </div>\n  );\n}\n\nfunction SellerBadge() {\n  return (\n    <Badge \n      variant=\"outline\" \n      className=\"text-[10px] px-1.5 py-0 h-4 border-orange-500/30 bg-orange-500/10 text-orange-600 dark:text-orange-400 font-medium gap-0.5\"\n    >\n      <Store className=\"h-2.5 w-2.5\" />\n      Seller\n    </Badge>\n  );\n}\n\nfunction EKSUPlugBadge({ size = \"sm\" }: { size?: \"sm\" | \"md\" }) {\n  const sizeClasses = size === \"sm\" ? \"h-3.5 w-3.5\" : \"h-4 w-4\";\n  return (\n    <div className=\"relative inline-flex\">\n      <BadgeCheck className={`${sizeClasses} text-amber-500 fill-amber-500/20`} />\n    </div>\n  );\n}\n\nfunction isEKSUPlugAccount(author: User): boolean {\n  return author?.isSystemAccount === true && author?.systemAccountType === 'eksuplug';\n}\n\nexport default function BookmarksPage() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [commentText, setCommentText] = useState<Record<string, string>>({});\n  const [expandedComments, setExpandedComments] = useState<string | null>(null);\n  const [likedPosts, setLikedPosts] = useState<Set<string>>(new Set());\n  const [repostedPosts, setRepostedPosts] = useState<Set<string>>(new Set());\n\n  const { data: bookmarks, isLoading } = useQuery<BookmarkWithPost[]>({\n    queryKey: [\"/api/users/me/bookmarks\"],\n  });\n\n  const { data: comments } = useQuery<Comment[]>({\n    queryKey: [\"/api/social-posts\", expandedComments, \"comments\"],\n    enabled: !!expandedComments,\n  });\n\n  const unbookmarkMutation = useMutation({\n    mutationFn: async (postId: string) => {\n      const response = await apiRequest(\"POST\", `/api/social-posts/${postId}/bookmark`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Removed from bookmarks\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users/me/bookmarks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/feed\"] });\n    },\n    onError: () => {\n      toast({ title: \"Failed to remove bookmark\", variant: \"destructive\" });\n    },\n  });\n\n  const likeMutation = useMutation({\n    mutationFn: async (postId: string) => {\n      const response = await apiRequest(\"POST\", `/api/social-posts/${postId}/like`);\n      return response.json();\n    },\n    onMutate: (postId) => {\n      setLikedPosts(prev => {\n        const newSet = new Set(prev);\n        if (newSet.has(postId)) {\n          newSet.delete(postId);\n        } else {\n          newSet.add(postId);\n        }\n        return newSet;\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users/me/bookmarks\"] });\n    },\n  });\n\n  const repostMutation = useMutation({\n    mutationFn: async (postId: string) => {\n      const response = await apiRequest(\"POST\", `/api/social-posts/${postId}/repost`);\n      return response.json();\n    },\n    onMutate: (postId) => {\n      setRepostedPosts(prev => {\n        const newSet = new Set(prev);\n        if (newSet.has(postId)) {\n          newSet.delete(postId);\n        } else {\n          newSet.add(postId);\n        }\n        return newSet;\n      });\n    },\n    onSuccess: (data) => {\n      if (data.action === \"reposted\") {\n        toast({ title: \"Reposted!\" });\n      } else {\n        toast({ title: \"Removed repost\" });\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/users/me/bookmarks\"] });\n    },\n  });\n\n  const commentMutation = useMutation({\n    mutationFn: async ({ postId, content }: { postId: string; content: string }) => {\n      const response = await apiRequest(\"POST\", `/api/social-posts/${postId}/comments`, { content });\n      return response.json();\n    },\n    onSuccess: (_, variables) => {\n      setCommentText((prev) => ({ ...prev, [variables.postId]: \"\" }));\n      queryClient.invalidateQueries({ queryKey: [\"/api/social-posts\", variables.postId, \"comments\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users/me/bookmarks\"] });\n    },\n  });\n\n  const getInitials = (firstName?: string | null, lastName?: string | null) => {\n    return `${firstName?.[0] || \"\"}${lastName?.[0] || \"\"}`.toUpperCase() || \"U\";\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"container mx-auto px-4 py-6 max-w-xl\">\n        <motion.div \n          initial={{ opacity: 0, y: -10 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"flex items-center gap-3 mb-6\"\n        >\n          <Link href=\"/the-plug\">\n            <Button variant=\"ghost\" size=\"icon\" className=\"h-9 w-9 rounded-full\" data-testid=\"button-back\">\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Button>\n          </Link>\n          <div className=\"flex items-center gap-3\">\n            <div className=\"h-10 w-10 rounded-xl bg-primary/10 flex items-center justify-center\">\n              <Bookmark className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div>\n              <h1 className=\"text-xl font-bold tracking-tight\">Bookmarks</h1>\n              <p className=\"text-xs text-muted-foreground\">\n                {bookmarks?.length || 0} saved posts\n              </p>\n            </div>\n          </div>\n        </motion.div>\n\n        {isLoading ? (\n          <div className=\"space-y-0 divide-y\">\n            {[...Array(3)].map((_, i) => (\n              <div key={i} className=\"py-4\">\n                <div className=\"flex items-start gap-3\">\n                  <Skeleton className=\"h-10 w-10 rounded-full flex-shrink-0\" />\n                  <div className=\"flex-1 space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <Skeleton className=\"h-4 w-24\" />\n                      <Skeleton className=\"h-3 w-16\" />\n                    </div>\n                    <Skeleton className=\"h-16 w-full\" />\n                    <div className=\"flex gap-6\">\n                      <Skeleton className=\"h-8 w-14\" />\n                      <Skeleton className=\"h-8 w-14\" />\n                      <Skeleton className=\"h-8 w-14\" />\n                    </div>\n                  </div>\n                </div>\n              </div>\n            ))}\n          </div>\n        ) : bookmarks && bookmarks.length > 0 ? (\n          <motion.div \n            className=\"divide-y\"\n            initial=\"hidden\"\n            animate=\"visible\"\n            variants={{\n              visible: {\n                transition: {\n                  staggerChildren: 0.05\n                }\n              }\n            }}\n          >\n            {bookmarks.map((bookmark) => {\n              const post = bookmark.post;\n              const author = bookmark.author;\n              \n              return (\n                <motion.article\n                  key={bookmark.id}\n                  variants={{\n                    hidden: { opacity: 0 },\n                    visible: { opacity: 1 }\n                  }}\n                  transition={{ duration: 0.2 }}\n                  className=\"py-4\"\n                  data-testid={`bookmark-card-${bookmark.id}`}\n                >\n                  <div className=\"flex gap-3\">\n                    <Link href={`/profile/${post.authorId}`}>\n                      <Avatar className=\"h-10 w-10 flex-shrink-0 cursor-pointer hover:opacity-90 transition-opacity\">\n                        <AvatarImage src={author?.profileImageUrl || undefined} />\n                        <AvatarFallback className=\"bg-primary/10 text-primary font-medium text-sm\">\n                          {getInitials(author?.firstName, author?.lastName)}\n                        </AvatarFallback>\n                      </Avatar>\n                    </Link>\n                    \n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-start justify-between gap-2\">\n                        <div className=\"flex items-center gap-1 flex-wrap min-w-0\">\n                          <Link href={`/profile/${post.authorId}`}>\n                            <span className={`font-bold text-sm hover:underline cursor-pointer truncate ${isEKSUPlugAccount(author) ? 'text-amber-600 dark:text-amber-400' : ''}`}>\n                              {author?.firstName} {author?.lastName}\n                            </span>\n                          </Link>\n                          {isEKSUPlugAccount(author) ? (\n                            <EKSUPlugBadge />\n                          ) : author?.isVerified ? (\n                            <VerifiedBadge />\n                          ) : null}\n                          {author?.role === \"seller\" && !isEKSUPlugAccount(author) && (\n                            <SellerBadge />\n                          )}\n                          <span className=\"text-muted-foreground text-sm\">·</span>\n                          <span className=\"text-muted-foreground text-sm\">\n                            {post.createdAt && formatDistanceToNow(new Date(post.createdAt), { addSuffix: false })}\n                          </span>\n                        </div>\n                        \n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => unbookmarkMutation.mutate(post.id)}\n                          disabled={unbookmarkMutation.isPending}\n                          className=\"h-8 w-8 text-muted-foreground hover:text-destructive rounded-full flex-shrink-0\"\n                          data-testid={`button-unbookmark-${post.id}`}\n                        >\n                          <BookmarkX className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n\n                      {post.content && (\n                        <p className=\"text-[15px] leading-relaxed text-foreground whitespace-pre-wrap mt-1 mb-3\">\n                          {post.content}\n                        </p>\n                      )}\n\n                      {((post.images && post.images.length > 0) || (post.videos && post.videos.length > 0)) && (\n                        <div className=\"mt-3 mb-3\">\n                          <MediaGrid images={post.images} videos={post.videos} />\n                        </div>\n                      )}\n\n                      <div className=\"flex items-center justify-between mt-3 -ml-2\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => setExpandedComments(expandedComments === post.id ? null : post.id)}\n                          className=\"h-8 px-2 gap-1 rounded-full text-muted-foreground hover:text-primary hover:bg-primary/10 group\"\n                          data-testid={`button-comments-${post.id}`}\n                        >\n                          <MessageCircle className=\"h-[18px] w-[18px] group-hover:text-primary\" />\n                          <span className=\"text-sm tabular-nums\">{formatEngagement(post.commentsCount || 0)}</span>\n                        </Button>\n\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => repostMutation.mutate(post.id)}\n                          disabled={repostMutation.isPending}\n                          className={`h-8 px-2 gap-1 rounded-full group ${\n                            repostedPosts.has(post.id)\n                              ? \"text-green-500\"\n                              : \"text-muted-foreground hover:text-green-500 hover:bg-green-500/10\"\n                          }`}\n                          data-testid={`button-repost-${post.id}`}\n                        >\n                          <Repeat2 className={`h-[18px] w-[18px] ${repostedPosts.has(post.id) ? \"text-green-500\" : \"group-hover:text-green-500\"}`} />\n                          <span className=\"text-sm tabular-nums\">{formatEngagement(post.repostsCount || 0)}</span>\n                        </Button>\n\n                        <motion.div whileTap={{ scale: 0.9 }}>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => likeMutation.mutate(post.id)}\n                            className={`h-8 px-2 gap-1 rounded-full group ${\n                              likedPosts.has(post.id) \n                                ? \"text-red-500\" \n                                : \"text-muted-foreground hover:text-red-500 hover:bg-red-500/10\"\n                            }`}\n                            data-testid={`button-like-${post.id}`}\n                          >\n                            <motion.div\n                              animate={likedPosts.has(post.id) ? { scale: [1, 1.2, 1] } : {}}\n                              transition={{ duration: 0.2 }}\n                            >\n                              <Heart className={`h-[18px] w-[18px] ${likedPosts.has(post.id) ? \"fill-current\" : \"group-hover:text-red-500\"}`} />\n                            </motion.div>\n                            <span className=\"text-sm tabular-nums\">{formatEngagement(post.likesCount || 0)}</span>\n                          </Button>\n                        </motion.div>\n\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => unbookmarkMutation.mutate(post.id)}\n                          disabled={unbookmarkMutation.isPending}\n                          className=\"h-8 px-2 gap-1 rounded-full group text-primary\"\n                          data-testid={`button-bookmark-action-${post.id}`}\n                        >\n                          <Bookmark className=\"h-[18px] w-[18px] fill-current\" />\n                        </Button>\n                      </div>\n\n                      <AnimatePresence>\n                        {expandedComments === post.id && (\n                          <motion.div\n                            initial={{ opacity: 0, height: 0 }}\n                            animate={{ opacity: 1, height: \"auto\" }}\n                            exit={{ opacity: 0, height: 0 }}\n                            transition={{ duration: 0.2 }}\n                            className=\"overflow-hidden\"\n                          >\n                            <Separator className=\"my-3\" />\n                            <div className=\"space-y-3\">\n                              {comments?.map((comment) => (\n                                <motion.div \n                                  key={comment.id} \n                                  className=\"flex gap-2\"\n                                  initial={{ opacity: 0, x: -10 }}\n                                  animate={{ opacity: 1, x: 0 }}\n                                >\n                                  <Avatar className=\"h-8 w-8 flex-shrink-0\">\n                                    <AvatarImage src={comment.author?.profileImageUrl || undefined} />\n                                    <AvatarFallback className=\"text-[10px] bg-muted\">\n                                      {getInitials(comment.author?.firstName, comment.author?.lastName)}\n                                    </AvatarFallback>\n                                  </Avatar>\n                                  <div className=\"flex-1\">\n                                    <div className=\"bg-muted/50 rounded-2xl rounded-tl-md px-3 py-2\">\n                                      <div className=\"flex items-center gap-1\">\n                                        <span className=\"font-semibold text-xs\">\n                                          {comment.author?.firstName} {comment.author?.lastName}\n                                        </span>\n                                        {comment.author?.isVerified && <VerifiedBadge size=\"sm\" />}\n                                        <span className=\"text-muted-foreground text-xs\">·</span>\n                                        <span className=\"text-muted-foreground text-xs\">\n                                          {formatDistanceToNow(new Date(comment.createdAt), { addSuffix: false })}\n                                        </span>\n                                      </div>\n                                      <p className=\"text-sm text-foreground/90 mt-0.5\">{comment.content}</p>\n                                    </div>\n                                  </div>\n                                </motion.div>\n                              ))}\n                              \n                              <div className=\"flex gap-2 items-center pt-1\">\n                                <Avatar className=\"h-8 w-8 flex-shrink-0\">\n                                  <AvatarImage src={user?.profileImageUrl || undefined} />\n                                  <AvatarFallback className=\"text-[10px] bg-primary/10 text-primary\">\n                                    {getInitials(user?.firstName, user?.lastName)}\n                                  </AvatarFallback>\n                                </Avatar>\n                                <div className=\"flex-1 flex gap-2\">\n                                  <Input\n                                    placeholder=\"Post your reply\"\n                                    value={commentText[post.id] || \"\"}\n                                    onChange={(e) => setCommentText((prev) => ({ ...prev, [post.id]: e.target.value }))}\n                                    onKeyDown={(e) => {\n                                      if (e.key === \"Enter\" && commentText[post.id]?.trim()) {\n                                        commentMutation.mutate({ postId: post.id, content: commentText[post.id] });\n                                      }\n                                    }}\n                                    className=\"h-9 text-sm rounded-full bg-muted/50 border-0 focus-visible:ring-1 focus-visible:ring-primary/30\"\n                                    data-testid={`input-comment-${post.id}`}\n                                  />\n                                  <Button\n                                    size=\"icon\"\n                                    onClick={() => {\n                                      if (commentText[post.id]?.trim()) {\n                                        commentMutation.mutate({ postId: post.id, content: commentText[post.id] });\n                                      }\n                                    }}\n                                    disabled={!commentText[post.id]?.trim() || commentMutation.isPending}\n                                    className=\"h-9 w-9 rounded-full flex-shrink-0\"\n                                    data-testid={`button-send-comment-${post.id}`}\n                                  >\n                                    <Send className=\"h-4 w-4\" />\n                                  </Button>\n                                </div>\n                              </div>\n                            </div>\n                          </motion.div>\n                        )}\n                      </AnimatePresence>\n                    </div>\n                  </div>\n                </motion.article>\n              );\n            })}\n          </motion.div>\n        ) : (\n          <motion.div\n            initial={{ opacity: 0, scale: 0.95 }}\n            animate={{ opacity: 1, scale: 1 }}\n            transition={{ duration: 0.3 }}\n            className=\"py-16 text-center\"\n          >\n            <motion.div\n              initial={{ scale: 0 }}\n              animate={{ scale: 1 }}\n              transition={{ delay: 0.2, type: \"spring\", stiffness: 200 }}\n              className=\"h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4\"\n            >\n              <Bookmark className=\"h-8 w-8 text-primary\" />\n            </motion.div>\n            <h3 className=\"text-lg font-semibold mb-2\">No saved posts yet</h3>\n            <p className=\"text-sm text-muted-foreground max-w-xs mx-auto mb-4\">\n              When you bookmark posts, they'll show up here for easy access later.\n            </p>\n            <Link href=\"/the-plug\">\n              <Button data-testid=\"button-browse-plug\">\n                Browse The Plug\n              </Button>\n            </Link>\n          </motion.div>\n        )}\n\n        <div className=\"h-24 md:h-8\" />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":24560,"size_tokens":null},"client/src/components/games/TruthOrDareGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { \n  Clock, \n  Trophy, \n  Bot, \n  User, \n  RotateCcw, \n  Heart,\n  Sparkles,\n  Play,\n  SkipForward,\n  CheckCircle2,\n  XCircle,\n  Flame,\n  MessageCircle,\n  Zap,\n  Target,\n  Star,\n  Crown,\n  ThumbsUp,\n  AlertTriangle\n} from \"lucide-react\";\n\ninterface TruthOrDareGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype Difficulty = \"easy\" | \"medium\" | \"spicy\";\ntype PromptType = \"truth\" | \"dare\";\ntype GamePhase = \"ready\" | \"choosing\" | \"prompt\" | \"responding\" | \"ai_turn\" | \"round_result\" | \"finished\";\n\ninterface Prompt {\n  id: number;\n  type: PromptType;\n  difficulty: Difficulty;\n  text: string;\n  points: number;\n}\n\nconst TRUTHS: Prompt[] = [\n  { id: 1, type: \"truth\", difficulty: \"easy\", text: \"What's your favorite course this semester and why?\", points: 5 },\n  { id: 2, type: \"truth\", difficulty: \"easy\", text: \"Have you ever fallen asleep during a lecture? Which class?\", points: 5 },\n  { id: 3, type: \"truth\", difficulty: \"easy\", text: \"What's the first thing you do when you wake up in your hostel?\", points: 5 },\n  { id: 4, type: \"truth\", difficulty: \"easy\", text: \"What's your go-to spot on campus to hang out?\", points: 5 },\n  { id: 5, type: \"truth\", difficulty: \"easy\", text: \"What song do you secretly listen to that would surprise people?\", points: 5 },\n  { id: 6, type: \"truth\", difficulty: \"easy\", text: \"If you could swap rooms with anyone in your hostel, who would it be?\", points: 5 },\n  { id: 7, type: \"truth\", difficulty: \"easy\", text: \"What's your guilty pleasure snack from the campus cafeteria?\", points: 5 },\n  { id: 8, type: \"truth\", difficulty: \"easy\", text: \"What's the longest you've procrastinated on an assignment?\", points: 5 },\n  \n  { id: 9, type: \"truth\", difficulty: \"medium\", text: \"What's the most embarrassing thing that happened to you on campus?\", points: 10 },\n  { id: 10, type: \"truth\", difficulty: \"medium\", text: \"Have you ever had a crush on a classmate? What happened?\", points: 10 },\n  { id: 11, type: \"truth\", difficulty: \"medium\", text: \"What's the biggest lie you've told a lecturer?\", points: 10 },\n  { id: 12, type: \"truth\", difficulty: \"medium\", text: \"If you could change one decision from your university life, what would it be?\", points: 10 },\n  { id: 13, type: \"truth\", difficulty: \"medium\", text: \"What's your biggest fear about graduating?\", points: 10 },\n  { id: 14, type: \"truth\", difficulty: \"medium\", text: \"Have you ever cheated on a test? (Be honest!)\", points: 10 },\n  { id: 15, type: \"truth\", difficulty: \"medium\", text: \"What's the most money you've ever wasted on something you regret?\", points: 10 },\n  { id: 16, type: \"truth\", difficulty: \"medium\", text: \"Who do you secretly look up to on campus?\", points: 10 },\n  \n  { id: 17, type: \"truth\", difficulty: \"spicy\", text: \"What's the most controversial opinion you hold that you've never shared?\", points: 15 },\n  { id: 18, type: \"truth\", difficulty: \"spicy\", text: \"Have you ever developed feelings for your roommate or close friend?\", points: 15 },\n  { id: 19, type: \"truth\", difficulty: \"spicy\", text: \"What's something you've done that would disappoint your parents?\", points: 15 },\n  { id: 20, type: \"truth\", difficulty: \"spicy\", text: \"Who is the most attractive person you know on campus?\", points: 15 },\n  { id: 21, type: \"truth\", difficulty: \"spicy\", text: \"What's a secret you've never told anyone at university?\", points: 15 },\n  { id: 22, type: \"truth\", difficulty: \"spicy\", text: \"Have you ever pretended to be someone you're not to impress someone?\", points: 15 },\n  { id: 23, type: \"truth\", difficulty: \"spicy\", text: \"What's the pettiest thing you've done to someone who wronged you?\", points: 15 },\n  { id: 24, type: \"truth\", difficulty: \"spicy\", text: \"If you had to confess something to your best friend, what would it be?\", points: 15 },\n];\n\nconst DARES: Prompt[] = [\n  { id: 101, type: \"dare\", difficulty: \"easy\", text: \"Do 10 jumping jacks right now!\", points: 8 },\n  { id: 102, type: \"dare\", difficulty: \"easy\", text: \"Send a compliment to your best friend right now.\", points: 8 },\n  { id: 103, type: \"dare\", difficulty: \"easy\", text: \"Speak in an accent for the next 30 seconds.\", points: 8 },\n  { id: 104, type: \"dare\", difficulty: \"easy\", text: \"Strike a funny pose and hold it for 10 seconds.\", points: 8 },\n  { id: 105, type: \"dare\", difficulty: \"easy\", text: \"Say the alphabet backwards as fast as you can.\", points: 8 },\n  { id: 106, type: \"dare\", difficulty: \"easy\", text: \"Do your best impression of a popular lecturer.\", points: 8 },\n  { id: 107, type: \"dare\", difficulty: \"easy\", text: \"Share your most recent photo in your gallery (if appropriate).\", points: 8 },\n  { id: 108, type: \"dare\", difficulty: \"easy\", text: \"Sing the chorus of your favorite song out loud.\", points: 8 },\n  \n  { id: 109, type: \"dare\", difficulty: \"medium\", text: \"Post a story saying something nice about EKSU.\", points: 12 },\n  { id: 110, type: \"dare\", difficulty: \"medium\", text: \"Text your crush 'Hi' with no follow-up explanation.\", points: 12 },\n  { id: 111, type: \"dare\", difficulty: \"medium\", text: \"Share your most embarrassing moment from this year.\", points: 12 },\n  { id: 112, type: \"dare\", difficulty: \"medium\", text: \"Do 20 squats while counting out loud.\", points: 12 },\n  { id: 113, type: \"dare\", difficulty: \"medium\", text: \"Let someone pick a song and you have to dance to it.\", points: 12 },\n  { id: 114, type: \"dare\", difficulty: \"medium\", text: \"Call a friend and tell them you appreciate them without explaining why.\", points: 12 },\n  { id: 115, type: \"dare\", difficulty: \"medium\", text: \"Make up a short poem about university life on the spot.\", points: 12 },\n  { id: 116, type: \"dare\", difficulty: \"medium\", text: \"Do your best runway walk across the room.\", points: 12 },\n  \n  { id: 117, type: \"dare\", difficulty: \"spicy\", text: \"Post a throwback photo from when you first arrived at university.\", points: 18 },\n  { id: 118, type: \"dare\", difficulty: \"spicy\", text: \"Reveal your last 3 search history items (if appropriate).\", points: 18 },\n  { id: 119, type: \"dare\", difficulty: \"spicy\", text: \"Send a voice note to your crush saying something nice.\", points: 18 },\n  { id: 120, type: \"dare\", difficulty: \"spicy\", text: \"Let someone go through your phone's photo gallery for 30 seconds.\", points: 18 },\n  { id: 121, type: \"dare\", difficulty: \"spicy\", text: \"Share a screenshot of your most used emojis.\", points: 18 },\n  { id: 122, type: \"dare\", difficulty: \"spicy\", text: \"Call a family member and tell them you love them.\", points: 18 },\n  { id: 123, type: \"dare\", difficulty: \"spicy\", text: \"Make a TikTok-style video doing a trending dance.\", points: 18 },\n  { id: 124, type: \"dare\", difficulty: \"spicy\", text: \"Write and send a sincere apology to someone you've wronged.\", points: 18 },\n];\n\nconst TOTAL_ROUNDS = 10;\nconst RESPONSE_TIME = 30;\n\nconst getDifficultyColor = (difficulty: Difficulty) => {\n  switch (difficulty) {\n    case \"easy\": return \"bg-green-500/20 text-green-600 dark:text-green-400\";\n    case \"medium\": return \"bg-amber-500/20 text-amber-600 dark:text-amber-400\";\n    case \"spicy\": return \"bg-red-500/20 text-red-600 dark:text-red-400\";\n  }\n};\n\nconst getDifficultyIcon = (difficulty: Difficulty) => {\n  switch (difficulty) {\n    case \"easy\": return Star;\n    case \"medium\": return Zap;\n    case \"spicy\": return Flame;\n  }\n};\n\nconst shuffleArray = <T,>(array: T[]): T[] => {\n  const shuffled = [...array];\n  for (let i = shuffled.length - 1; i > 0; i--) {\n    const j = Math.floor(Math.random() * (i + 1));\n    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];\n  }\n  return shuffled;\n};\n\nconst getRandomPrompt = (type: PromptType, usedIds: Set<number>): Prompt => {\n  const prompts = type === \"truth\" ? TRUTHS : DARES;\n  const available = prompts.filter(p => !usedIds.has(p.id));\n  \n  if (available.length === 0) {\n    const shuffled = shuffleArray(prompts);\n    return shuffled[0];\n  }\n  \n  const shuffled = shuffleArray(available);\n  return shuffled[0];\n};\n\nconst simulateAIChoice = (): { choice: PromptType; completed: boolean; difficulty: Difficulty } => {\n  const choice: PromptType = Math.random() > 0.5 ? \"truth\" : \"dare\";\n  const difficulties: Difficulty[] = [\"easy\", \"medium\", \"spicy\"];\n  const weights = [0.5, 0.35, 0.15];\n  const random = Math.random();\n  let sum = 0;\n  let difficulty: Difficulty = \"easy\";\n  \n  for (let i = 0; i < weights.length; i++) {\n    sum += weights[i];\n    if (random < sum) {\n      difficulty = difficulties[i];\n      break;\n    }\n  }\n  \n  const completionChance = difficulty === \"easy\" ? 0.95 : difficulty === \"medium\" ? 0.80 : 0.65;\n  const completed = Math.random() < completionChance;\n  \n  return { choice, completed, difficulty };\n};\n\nconst getAIPoints = (completed: boolean, difficulty: Difficulty): number => {\n  if (!completed) return 0;\n  switch (difficulty) {\n    case \"easy\": return 6;\n    case \"medium\": return 11;\n    case \"spicy\": return 16;\n  }\n};\n\nexport default function TruthOrDareGame({ stake, onGameEnd, isPractice }: TruthOrDareGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"ready\");\n  const [currentRound, setCurrentRound] = useState(1);\n  const [playerScore, setPlayerScore] = useState(0);\n  const [aiScore, setAiScore] = useState(0);\n  const [currentPrompt, setCurrentPrompt] = useState<Prompt | null>(null);\n  const [timeLeft, setTimeLeft] = useState(RESPONSE_TIME);\n  const [usedPromptIds, setUsedPromptIds] = useState<Set<number>>(new Set());\n  const [selectedChoice, setSelectedChoice] = useState<PromptType | null>(null);\n  const [roundResult, setRoundResult] = useState<{ completed: boolean; points: number; skipped: boolean } | null>(null);\n  const [aiRoundResult, setAiRoundResult] = useState<{ choice: PromptType; completed: boolean; points: number } | null>(null);\n  const [showPromptReveal, setShowPromptReveal] = useState(false);\n  \n  const timerRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (timerRef.current) {\n        clearTimeout(timerRef.current);\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (gamePhase === \"responding\" && timeLeft > 0) {\n      timerRef.current = setTimeout(() => {\n        setTimeLeft(prev => prev - 1);\n      }, 1000);\n    } else if (gamePhase === \"responding\" && timeLeft === 0) {\n      handleSkip();\n    }\n    \n    return () => {\n      if (timerRef.current) {\n        clearTimeout(timerRef.current);\n      }\n    };\n  }, [gamePhase, timeLeft]);\n\n  const startGame = useCallback(() => {\n    setGamePhase(\"choosing\");\n    setCurrentRound(1);\n    setPlayerScore(0);\n    setAiScore(0);\n    setUsedPromptIds(new Set());\n    setCurrentPrompt(null);\n    setTimeLeft(RESPONSE_TIME);\n    setRoundResult(null);\n    setAiRoundResult(null);\n  }, []);\n\n  const handleChoice = (choice: PromptType) => {\n    setSelectedChoice(choice);\n    const prompt = getRandomPrompt(choice, usedPromptIds);\n    setCurrentPrompt(prompt);\n    setUsedPromptIds(prev => {\n      const newSet = new Set(Array.from(prev));\n      newSet.add(prompt.id);\n      return newSet;\n    });\n    setShowPromptReveal(true);\n    setGamePhase(\"prompt\");\n    \n    setTimeout(() => {\n      setShowPromptReveal(false);\n      setGamePhase(\"responding\");\n      setTimeLeft(RESPONSE_TIME);\n    }, 2000);\n  };\n\n  const handleComplete = () => {\n    if (!currentPrompt) return;\n    \n    const points = currentPrompt.points;\n    setPlayerScore(prev => prev + points);\n    setRoundResult({ completed: true, points, skipped: false });\n    setGamePhase(\"ai_turn\");\n    \n    setTimeout(() => {\n      processAITurn();\n    }, 1500);\n  };\n\n  const handleSkip = () => {\n    const penaltyPoints = -3;\n    setPlayerScore(prev => Math.max(0, prev + penaltyPoints));\n    setRoundResult({ completed: false, points: penaltyPoints, skipped: true });\n    setGamePhase(\"ai_turn\");\n    \n    setTimeout(() => {\n      processAITurn();\n    }, 1500);\n  };\n\n  const processAITurn = () => {\n    const aiResult = simulateAIChoice();\n    const aiPoints = getAIPoints(aiResult.completed, aiResult.difficulty);\n    \n    setAiScore(prev => prev + aiPoints);\n    setAiRoundResult({\n      choice: aiResult.choice,\n      completed: aiResult.completed,\n      points: aiPoints\n    });\n    \n    setTimeout(() => {\n      setGamePhase(\"round_result\");\n    }, 1500);\n  };\n\n  const nextRound = () => {\n    if (currentRound >= TOTAL_ROUNDS) {\n      setGamePhase(\"finished\");\n      const won = playerScore > aiScore;\n      onGameEnd(won, playerScore);\n    } else {\n      setCurrentRound(prev => prev + 1);\n      setCurrentPrompt(null);\n      setSelectedChoice(null);\n      setRoundResult(null);\n      setAiRoundResult(null);\n      setGamePhase(\"choosing\");\n    }\n  };\n\n  const resetGame = () => {\n    setGamePhase(\"ready\");\n    setCurrentRound(1);\n    setPlayerScore(0);\n    setAiScore(0);\n    setCurrentPrompt(null);\n    setSelectedChoice(null);\n    setUsedPromptIds(new Set());\n    setTimeLeft(RESPONSE_TIME);\n    setRoundResult(null);\n    setAiRoundResult(null);\n  };\n\n  const progressPercentage = (currentRound / TOTAL_ROUNDS) * 100;\n  const timerPercentage = (timeLeft / RESPONSE_TIME) * 100;\n\n  if (gamePhase === \"ready\") {\n    return (\n      <Card className=\"max-w-2xl mx-auto\">\n        <CardHeader className=\"text-center\">\n          <motion.div\n            initial={{ scale: 0 }}\n            animate={{ scale: 1 }}\n            transition={{ type: \"spring\", stiffness: 200 }}\n          >\n            <Heart className=\"h-16 w-16 mx-auto text-rose-500 mb-4\" />\n          </motion.div>\n          <CardTitle className=\"text-2xl\">Truth or Dare</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"text-center space-y-2\">\n            <p className=\"text-muted-foreground\">\n              The classic party game! Choose Truth or Dare each round, complete the challenge, and score points.\n            </p>\n            <p className=\"text-sm text-muted-foreground\">\n              Harder challenges = more points. Beat the AI over 10 rounds to win!\n            </p>\n          </div>\n          \n          <div className=\"grid grid-cols-3 gap-3\">\n            <div className=\"text-center p-3 rounded-lg bg-green-500/10\">\n              <Star className=\"h-6 w-6 mx-auto text-green-500 mb-1\" />\n              <div className=\"text-xs font-medium text-green-600 dark:text-green-400\">Easy</div>\n              <div className=\"text-xs text-muted-foreground\">5-8 pts</div>\n            </div>\n            <div className=\"text-center p-3 rounded-lg bg-amber-500/10\">\n              <Zap className=\"h-6 w-6 mx-auto text-amber-500 mb-1\" />\n              <div className=\"text-xs font-medium text-amber-600 dark:text-amber-400\">Medium</div>\n              <div className=\"text-xs text-muted-foreground\">10-12 pts</div>\n            </div>\n            <div className=\"text-center p-3 rounded-lg bg-red-500/10\">\n              <Flame className=\"h-6 w-6 mx-auto text-red-500 mb-1\" />\n              <div className=\"text-xs font-medium text-red-600 dark:text-red-400\">Spicy</div>\n              <div className=\"text-xs text-muted-foreground\">15-18 pts</div>\n            </div>\n          </div>\n          \n          {!isPractice && stake > 0 && (\n            <div className=\"text-center p-3 bg-primary/10 rounded-lg\">\n              <p className=\"text-sm font-medium\">Stake: {stake.toLocaleString()} NGN</p>\n              <p className=\"text-xs text-muted-foreground\">Win to double your stake!</p>\n            </div>\n          )}\n          \n          <Button \n            onClick={startGame} \n            size=\"lg\" \n            className=\"w-full\"\n            data-testid=\"button-start-game\"\n          >\n            <Play className=\"h-5 w-5 mr-2\" />\n            Start Game\n          </Button>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (gamePhase === \"finished\") {\n    const won = playerScore > aiScore;\n    const tied = playerScore === aiScore;\n    \n    return (\n      <Card className=\"max-w-2xl mx-auto\">\n        <CardHeader className=\"text-center\">\n          <motion.div\n            initial={{ scale: 0, rotate: -180 }}\n            animate={{ scale: 1, rotate: 0 }}\n            transition={{ type: \"spring\", stiffness: 200 }}\n          >\n            {won ? (\n              <Trophy className=\"h-20 w-20 mx-auto text-yellow-500 mb-4\" />\n            ) : tied ? (\n              <Target className=\"h-20 w-20 mx-auto text-blue-500 mb-4\" />\n            ) : (\n              <AlertTriangle className=\"h-20 w-20 mx-auto text-red-500 mb-4\" />\n            )}\n          </motion.div>\n          <CardTitle className=\"text-2xl\">\n            {won ? \"You Won!\" : tied ? \"It's a Tie!\" : \"AI Wins!\"}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <motion.div \n              className={`p-4 rounded-lg text-center ${won ? 'bg-green-500/10 ring-2 ring-green-500' : 'bg-muted/50'}`}\n              initial={{ x: -50, opacity: 0 }}\n              animate={{ x: 0, opacity: 1 }}\n              transition={{ delay: 0.2 }}\n            >\n              <User className=\"h-8 w-8 mx-auto mb-2 text-blue-500\" />\n              <div className=\"text-sm text-muted-foreground\">You</div>\n              <div className=\"text-3xl font-bold\">{playerScore}</div>\n              <div className=\"text-xs text-muted-foreground\">points</div>\n            </motion.div>\n            <motion.div \n              className={`p-4 rounded-lg text-center ${!won && !tied ? 'bg-red-500/10 ring-2 ring-red-500' : 'bg-muted/50'}`}\n              initial={{ x: 50, opacity: 0 }}\n              animate={{ x: 0, opacity: 1 }}\n              transition={{ delay: 0.2 }}\n            >\n              <Bot className=\"h-8 w-8 mx-auto mb-2 text-orange-500\" />\n              <div className=\"text-sm text-muted-foreground\">AI</div>\n              <div className=\"text-3xl font-bold\">{aiScore}</div>\n              <div className=\"text-xs text-muted-foreground\">points</div>\n            </motion.div>\n          </div>\n          \n          {!isPractice && stake > 0 && (\n            <motion.div \n              className={`text-center p-4 rounded-lg ${won ? 'bg-green-500/10' : 'bg-red-500/10'}`}\n              initial={{ y: 20, opacity: 0 }}\n              animate={{ y: 0, opacity: 1 }}\n              transition={{ delay: 0.4 }}\n            >\n              {won ? (\n                <>\n                  <Sparkles className=\"h-8 w-8 mx-auto text-green-500 mb-2\" />\n                  <p className=\"font-bold text-green-600 dark:text-green-400\">\n                    You earned {(stake * 1.8).toLocaleString()} NGN!\n                  </p>\n                </>\n              ) : (\n                <p className=\"font-medium text-red-600 dark:text-red-400\">\n                  You lost {stake.toLocaleString()} NGN\n                </p>\n              )}\n            </motion.div>\n          )}\n          \n          <div className=\"flex gap-3\">\n            <Button variant=\"outline\" onClick={resetGame} className=\"flex-1\" data-testid=\"button-play-again\">\n              <RotateCcw className=\"h-4 w-4 mr-2\" />\n              Play Again\n            </Button>\n            <Button onClick={() => onGameEnd(won, playerScore)} className=\"flex-1\" data-testid=\"button-exit-game\">\n              Exit Game\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"max-w-2xl mx-auto\">\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-center justify-between gap-3\">\n          <div className=\"flex items-center gap-2\">\n            <Heart className=\"h-5 w-5 text-rose-500\" />\n            <span className=\"font-semibold\">Round {currentRound}/{TOTAL_ROUNDS}</span>\n          </div>\n          <div className=\"flex items-center gap-4\">\n            <div className=\"flex items-center gap-1.5\">\n              <User className=\"h-4 w-4 text-blue-500\" />\n              <span className=\"font-bold\">{playerScore}</span>\n            </div>\n            <div className=\"flex items-center gap-1.5\">\n              <Bot className=\"h-4 w-4 text-orange-500\" />\n              <span className=\"font-bold\">{aiScore}</span>\n            </div>\n          </div>\n        </div>\n        <Progress value={progressPercentage} className=\"h-2 mt-2\" />\n      </CardHeader>\n      \n      <CardContent className=\"space-y-6\">\n        <AnimatePresence mode=\"wait\">\n          {gamePhase === \"choosing\" && (\n            <motion.div\n              key=\"choosing\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, y: -20 }}\n              className=\"space-y-6\"\n            >\n              <div className=\"text-center\">\n                <h3 className=\"text-xl font-bold mb-2\">Make Your Choice</h3>\n                <p className=\"text-muted-foreground\">Truth or Dare?</p>\n              </div>\n              \n              <div className=\"grid grid-cols-2 gap-4\">\n                <motion.button\n                  className=\"p-6 rounded-xl bg-blue-500/10 border-2 border-blue-500/20 text-center space-y-3\"\n                  whileHover={{ scale: 1.03, borderColor: \"rgb(59 130 246)\" }}\n                  whileTap={{ scale: 0.98 }}\n                  onClick={() => handleChoice(\"truth\")}\n                  data-testid=\"button-choose-truth\"\n                >\n                  <MessageCircle className=\"h-12 w-12 mx-auto text-blue-500\" />\n                  <div className=\"font-bold text-lg\">Truth</div>\n                  <div className=\"text-xs text-muted-foreground\">Answer honestly</div>\n                </motion.button>\n                \n                <motion.button\n                  className=\"p-6 rounded-xl bg-rose-500/10 border-2 border-rose-500/20 text-center space-y-3\"\n                  whileHover={{ scale: 1.03, borderColor: \"rgb(244 63 94)\" }}\n                  whileTap={{ scale: 0.98 }}\n                  onClick={() => handleChoice(\"dare\")}\n                  data-testid=\"button-choose-dare\"\n                >\n                  <Flame className=\"h-12 w-12 mx-auto text-rose-500\" />\n                  <div className=\"font-bold text-lg\">Dare</div>\n                  <div className=\"text-xs text-muted-foreground\">Complete the challenge</div>\n                </motion.button>\n              </div>\n            </motion.div>\n          )}\n\n          {gamePhase === \"prompt\" && currentPrompt && (\n            <motion.div\n              key=\"prompt\"\n              initial={{ opacity: 0, scale: 0.8 }}\n              animate={{ opacity: 1, scale: 1 }}\n              exit={{ opacity: 0, scale: 0.8 }}\n              className=\"text-center space-y-4\"\n            >\n              <motion.div\n                animate={{ rotate: [0, 5, -5, 0] }}\n                transition={{ repeat: Infinity, duration: 1 }}\n              >\n                {currentPrompt.type === \"truth\" ? (\n                  <MessageCircle className=\"h-16 w-16 mx-auto text-blue-500\" />\n                ) : (\n                  <Flame className=\"h-16 w-16 mx-auto text-rose-500\" />\n                )}\n              </motion.div>\n              <div className=\"text-lg font-medium\">\n                Revealing your {currentPrompt.type}...\n              </div>\n              <div className=\"flex justify-center gap-2\">\n                <Badge className={getDifficultyColor(currentPrompt.difficulty)}>\n                  {currentPrompt.difficulty}\n                </Badge>\n                <Badge variant=\"outline\">+{currentPrompt.points} pts</Badge>\n              </div>\n            </motion.div>\n          )}\n\n          {gamePhase === \"responding\" && currentPrompt && (\n            <motion.div\n              key=\"responding\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, y: -20 }}\n              className=\"space-y-6\"\n            >\n              <div className=\"flex justify-center gap-2\">\n                <Badge variant={currentPrompt.type === \"truth\" ? \"default\" : \"destructive\"}>\n                  {currentPrompt.type.toUpperCase()}\n                </Badge>\n                <Badge className={getDifficultyColor(currentPrompt.difficulty)}>\n                  {(() => {\n                    const Icon = getDifficultyIcon(currentPrompt.difficulty);\n                    return <Icon className=\"h-3 w-3 mr-1\" />;\n                  })()}\n                  {currentPrompt.difficulty}\n                </Badge>\n              </div>\n              \n              <motion.div \n                className=\"p-6 rounded-xl bg-muted/50 text-center\"\n                initial={{ scale: 0.95 }}\n                animate={{ scale: 1 }}\n              >\n                <p className=\"text-lg font-medium leading-relaxed\">{currentPrompt.text}</p>\n              </motion.div>\n              \n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between text-sm\">\n                  <div className=\"flex items-center gap-1.5 text-muted-foreground\">\n                    <Clock className=\"h-4 w-4\" />\n                    <span>Time remaining</span>\n                  </div>\n                  <span className={`font-bold ${timeLeft <= 10 ? 'text-red-500' : ''}`}>\n                    {timeLeft}s\n                  </span>\n                </div>\n                <Progress \n                  value={timerPercentage} \n                  className={`h-2 ${timeLeft <= 10 ? '[&>div]:bg-red-500' : ''}`}\n                />\n              </div>\n              \n              <div className=\"text-center text-sm text-muted-foreground\">\n                Complete the {currentPrompt.type} to earn <strong>{currentPrompt.points} points</strong>\n              </div>\n              \n              <div className=\"grid grid-cols-2 gap-3\">\n                <Button\n                  variant=\"outline\"\n                  onClick={handleSkip}\n                  data-testid=\"button-skip\"\n                >\n                  <SkipForward className=\"h-4 w-4 mr-2\" />\n                  Skip (-3 pts)\n                </Button>\n                <Button\n                  onClick={handleComplete}\n                  data-testid=\"button-complete\"\n                >\n                  <CheckCircle2 className=\"h-4 w-4 mr-2\" />\n                  Completed!\n                </Button>\n              </div>\n            </motion.div>\n          )}\n\n          {gamePhase === \"ai_turn\" && (\n            <motion.div\n              key=\"ai_turn\"\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              className=\"text-center space-y-4 py-8\"\n            >\n              <motion.div\n                animate={{ rotate: 360 }}\n                transition={{ repeat: Infinity, duration: 2, ease: \"linear\" }}\n              >\n                <Bot className=\"h-16 w-16 mx-auto text-orange-500\" />\n              </motion.div>\n              <div className=\"text-lg font-medium\">AI is taking their turn...</div>\n              \n              {roundResult && (\n                <motion.div \n                  className={`p-3 rounded-lg inline-flex items-center gap-2 ${\n                    roundResult.completed ? 'bg-green-500/10 text-green-600 dark:text-green-400' : 'bg-red-500/10 text-red-600 dark:text-red-400'\n                  }`}\n                  initial={{ scale: 0 }}\n                  animate={{ scale: 1 }}\n                >\n                  {roundResult.completed ? (\n                    <>\n                      <CheckCircle2 className=\"h-5 w-5\" />\n                      <span>You earned +{roundResult.points} pts</span>\n                    </>\n                  ) : (\n                    <>\n                      <XCircle className=\"h-5 w-5\" />\n                      <span>{roundResult.skipped ? \"Skipped\" : \"Time up\"}: {roundResult.points} pts</span>\n                    </>\n                  )}\n                </motion.div>\n              )}\n            </motion.div>\n          )}\n\n          {gamePhase === \"round_result\" && (\n            <motion.div\n              key=\"round_result\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, y: -20 }}\n              className=\"space-y-6\"\n            >\n              <div className=\"text-center\">\n                <h3 className=\"text-xl font-bold mb-1\">Round {currentRound} Complete!</h3>\n                <p className=\"text-muted-foreground\">See how you both did</p>\n              </div>\n              \n              <div className=\"grid grid-cols-2 gap-4\">\n                <motion.div \n                  className={`p-4 rounded-lg ${\n                    roundResult?.completed ? 'bg-green-500/10' : 'bg-red-500/10'\n                  }`}\n                  initial={{ x: -30, opacity: 0 }}\n                  animate={{ x: 0, opacity: 1 }}\n                  transition={{ delay: 0.1 }}\n                >\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <User className=\"h-5 w-5 text-blue-500\" />\n                    <span className=\"font-medium\">You</span>\n                  </div>\n                  <div className=\"text-center\">\n                    {roundResult?.completed ? (\n                      <CheckCircle2 className=\"h-8 w-8 mx-auto text-green-500 mb-1\" />\n                    ) : (\n                      <XCircle className=\"h-8 w-8 mx-auto text-red-500 mb-1\" />\n                    )}\n                    <div className={`font-bold text-lg ${\n                      roundResult?.completed ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'\n                    }`}>\n                      {roundResult?.completed ? `+${roundResult.points}` : roundResult?.points}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">\n                      {selectedChoice === \"truth\" ? \"Truth\" : \"Dare\"}\n                    </div>\n                  </div>\n                </motion.div>\n                \n                <motion.div \n                  className={`p-4 rounded-lg ${\n                    aiRoundResult?.completed ? 'bg-green-500/10' : 'bg-red-500/10'\n                  }`}\n                  initial={{ x: 30, opacity: 0 }}\n                  animate={{ x: 0, opacity: 1 }}\n                  transition={{ delay: 0.2 }}\n                >\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <Bot className=\"h-5 w-5 text-orange-500\" />\n                    <span className=\"font-medium\">AI</span>\n                  </div>\n                  <div className=\"text-center\">\n                    {aiRoundResult?.completed ? (\n                      <CheckCircle2 className=\"h-8 w-8 mx-auto text-green-500 mb-1\" />\n                    ) : (\n                      <XCircle className=\"h-8 w-8 mx-auto text-red-500 mb-1\" />\n                    )}\n                    <div className={`font-bold text-lg ${\n                      aiRoundResult?.completed ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'\n                    }`}>\n                      {aiRoundResult?.completed ? `+${aiRoundResult.points}` : '0'}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">\n                      {aiRoundResult?.choice === \"truth\" ? \"Truth\" : \"Dare\"}\n                    </div>\n                  </div>\n                </motion.div>\n              </div>\n              \n              <motion.div \n                className=\"flex items-center justify-center gap-4 p-3 bg-muted/50 rounded-lg\"\n                initial={{ y: 20, opacity: 0 }}\n                animate={{ y: 0, opacity: 1 }}\n                transition={{ delay: 0.3 }}\n              >\n                <div className=\"text-center\">\n                  <div className=\"text-xs text-muted-foreground mb-1\">Your Score</div>\n                  <div className=\"text-2xl font-bold text-blue-500\">{playerScore}</div>\n                </div>\n                <div className=\"text-2xl text-muted-foreground\">vs</div>\n                <div className=\"text-center\">\n                  <div className=\"text-xs text-muted-foreground mb-1\">AI Score</div>\n                  <div className=\"text-2xl font-bold text-orange-500\">{aiScore}</div>\n                </div>\n              </motion.div>\n              \n              <Button \n                onClick={nextRound} \n                className=\"w-full\" \n                size=\"lg\"\n                data-testid=\"button-next-round\"\n              >\n                {currentRound >= TOTAL_ROUNDS ? (\n                  <>\n                    <Trophy className=\"h-5 w-5 mr-2\" />\n                    See Final Results\n                  </>\n                ) : (\n                  <>\n                    <Play className=\"h-5 w-5 mr-2\" />\n                    Next Round\n                  </>\n                )}\n              </Button>\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":33306,"size_tokens":null},"client/src/components/games/SpeedTypingGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { \n  Clock, \n  Trophy, \n  Bot, \n  User, \n  RotateCcw, \n  Keyboard, \n  Zap,\n  Target,\n  Star,\n  Crown,\n  Sparkles,\n  Play,\n  ChevronRight,\n  Award,\n  Timer\n} from \"lucide-react\";\n\ninterface SpeedTypingGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ninterface Passage {\n  id: number;\n  category: string;\n  text: string;\n  difficulty: \"easy\" | \"medium\" | \"hard\";\n}\n\nconst PASSAGES: Passage[] = [\n  {\n    id: 1,\n    category: \"University Life\",\n    text: \"The campus library is always full during exam period. Students gather to read and prepare for their tests. Success requires dedication and hard work.\",\n    difficulty: \"easy\"\n  },\n  {\n    id: 2,\n    category: \"University Life\",\n    text: \"Hostel life at EKSU teaches you how to survive and thrive with limited resources. You learn to manage your time, money, and relationships all at once.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 3,\n    category: \"University Life\",\n    text: \"The Student Union Government election season brings excitement to campus. Candidates campaign with posters, rallies, and promises of better welfare for students.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 4,\n    category: \"University Life\",\n    text: \"Carrying over a course is never the end of the world. Many successful graduates once struggled with some subjects before finding their footing and excelling in their studies.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 5,\n    category: \"University Life\",\n    text: \"Registration week is always chaotic. Long queues at the bursary, rushing to pay school fees, and the scramble to complete course registration before the deadline closes.\",\n    difficulty: \"hard\"\n  },\n  {\n    id: 6,\n    category: \"Nigerian Culture\",\n    text: \"Jollof rice remains the king of Nigerian parties. No owambe is complete without a generous serving of this beloved one-pot rice dish.\",\n    difficulty: \"easy\"\n  },\n  {\n    id: 7,\n    category: \"Nigerian Culture\",\n    text: \"The Yoruba people celebrate the Eyo festival in Lagos with colorful masquerades dancing through the streets. It is a spectacular display of culture and tradition.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 8,\n    category: \"Nigerian Culture\",\n    text: \"Aso-ebi at Nigerian weddings has become a beautiful tradition. Friends and family coordinate their attire to show unity and support for the couple getting married.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 9,\n    category: \"Nigerian Culture\",\n    text: \"From Afrobeats to Highlife, Nigerian music has conquered the world stage. Artists like Burna Boy, Wizkid, and Davido have put our sounds on the global map.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 10,\n    category: \"Nigerian Culture\",\n    text: \"The New Yam Festival celebrated by the Igbo people marks the end of harvest season. It is a time of thanksgiving, feasting, and cultural performances that unite communities together.\",\n    difficulty: \"hard\"\n  },\n  {\n    id: 11,\n    category: \"Tech & Coding\",\n    text: \"Learning to code opens doors to endless opportunities. Start with the basics and build your skills one project at a time.\",\n    difficulty: \"easy\"\n  },\n  {\n    id: 12,\n    category: \"Tech & Coding\",\n    text: \"JavaScript is the language of the web. With it, you can build websites, mobile apps, and even server-side applications using Node.js.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 13,\n    category: \"Tech & Coding\",\n    text: \"Debugging is an essential skill for every programmer. When your code breaks, stay calm, read the error message, and trace your logic step by step until you find the bug.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 14,\n    category: \"Tech & Coding\",\n    text: \"The Nigerian tech ecosystem is growing rapidly. Startups like Paystack, Flutterwave, and Andela have shown that world-class technology companies can emerge from Africa.\",\n    difficulty: \"hard\"\n  },\n  {\n    id: 15,\n    category: \"Tech & Coding\",\n    text: \"Version control with Git helps developers collaborate effectively. Commit your changes often, write clear messages, and always pull the latest code before pushing your updates to the repository.\",\n    difficulty: \"hard\"\n  },\n  {\n    id: 16,\n    category: \"Motivational\",\n    text: \"Success is not final, failure is not fatal. It is the courage to continue that counts. Keep pushing forward every day.\",\n    difficulty: \"easy\"\n  },\n  {\n    id: 17,\n    category: \"Motivational\",\n    text: \"Your dreams are valid no matter where you come from. Hard work and persistence can take you places you never imagined possible.\",\n    difficulty: \"easy\"\n  },\n  {\n    id: 18,\n    category: \"Motivational\",\n    text: \"The road to success is paved with setbacks and challenges. Embrace them as opportunities to learn and grow stronger. Winners never quit and quitters never win.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 19,\n    category: \"Motivational\",\n    text: \"Education is the passport to the future. Invest in yourself, read widely, and never stop learning. The knowledge you gain today will shape your tomorrow.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 20,\n    category: \"Motivational\",\n    text: \"Great achievements require great sacrifice. Stay focused on your goals, work diligently, and maintain a positive attitude even when progress seems slow. Your breakthrough is coming.\",\n    difficulty: \"hard\"\n  },\n  {\n    id: 21,\n    category: \"University Life\",\n    text: \"Group projects teach valuable teamwork skills. Coordinating schedules, dividing tasks, and presenting together builds bonds that last beyond graduation.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 22,\n    category: \"Nigerian Culture\",\n    text: \"Palm wine is a traditional beverage tapped from palm trees. It is enjoyed at ceremonies and gatherings, connecting us to our roots and ancestors.\",\n    difficulty: \"easy\"\n  },\n  {\n    id: 23,\n    category: \"Tech & Coding\",\n    text: \"APIs allow different software systems to communicate with each other. Understanding how to work with APIs is crucial for building modern web applications.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 24,\n    category: \"Motivational\",\n    text: \"The future belongs to those who believe in the beauty of their dreams. Take action today and build the life you envision for yourself.\",\n    difficulty: \"easy\"\n  },\n  {\n    id: 25,\n    category: \"University Life\",\n    text: \"The cafeteria serves as a social hub on campus. Between lectures, students gather to share meals, discuss assignments, and catch up on the latest campus gossip and news.\",\n    difficulty: \"hard\"\n  },\n  {\n    id: 26,\n    category: \"Nigerian Culture\",\n    text: \"Nollywood is the second largest film industry in the world by volume. Nigerian movies tell our stories and have captivated audiences across Africa and beyond.\",\n    difficulty: \"medium\"\n  },\n  {\n    id: 27,\n    category: \"Tech & Coding\",\n    text: \"Clean code is readable, maintainable, and efficient. Write code as if the next person to read it will be you six months from now.\",\n    difficulty: \"easy\"\n  },\n  {\n    id: 28,\n    category: \"Motivational\",\n    text: \"Every expert was once a beginner. Do not be afraid to start from scratch. The journey of a thousand miles begins with a single step.\",\n    difficulty: \"easy\"\n  },\n  {\n    id: 29,\n    category: \"University Life\",\n    text: \"Convocation day is the culmination of years of hard work and sacrifice. Wearing your academic gown and receiving your certificate is a moment of immense pride for graduates and their families.\",\n    difficulty: \"hard\"\n  },\n  {\n    id: 30,\n    category: \"Nigerian Culture\",\n    text: \"Suya is a beloved Nigerian street food made from grilled meat skewers seasoned with spicy pepper mix. The aroma of suya grilling in the evening attracts hungry customers from far and wide.\",\n    difficulty: \"hard\"\n  }\n];\n\nconst getCategoryColor = (category: string) => {\n  switch (category) {\n    case \"University Life\": return \"bg-purple-500/20 text-purple-600 dark:text-purple-400\";\n    case \"Nigerian Culture\": return \"bg-green-500/20 text-green-600 dark:text-green-400\";\n    case \"Tech & Coding\": return \"bg-cyan-500/20 text-cyan-600 dark:text-cyan-400\";\n    case \"Motivational\": return \"bg-amber-500/20 text-amber-600 dark:text-amber-400\";\n    default: return \"bg-muted\";\n  }\n};\n\nconst getDifficultyColor = (difficulty: string) => {\n  switch (difficulty) {\n    case \"easy\": return \"bg-green-500/20 text-green-600 dark:text-green-400\";\n    case \"medium\": return \"bg-yellow-500/20 text-yellow-600 dark:text-yellow-400\";\n    case \"hard\": return \"bg-red-500/20 text-red-600 dark:text-red-400\";\n    default: return \"bg-muted\";\n  }\n};\n\nconst shuffleArray = <T,>(array: T[]): T[] => {\n  const shuffled = [...array];\n  for (let i = shuffled.length - 1; i > 0; i--) {\n    const j = Math.floor(Math.random() * (i + 1));\n    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];\n  }\n  return shuffled;\n};\n\nconst getRandomPassage = (): Passage => {\n  const shuffled = shuffleArray(PASSAGES);\n  return shuffled[0];\n};\n\nconst calculateWPM = (correctChars: number, timeElapsed: number): number => {\n  if (timeElapsed <= 0) return 0;\n  const wordsTyped = correctChars / 5;\n  const minutesElapsed = timeElapsed / 60;\n  return Math.round(wordsTyped / minutesElapsed);\n};\n\nconst calculateAccuracy = (correctChars: number, totalTyped: number): number => {\n  if (totalTyped === 0) return 100;\n  return Math.round((correctChars / totalTyped) * 100);\n};\n\nconst generateAIPerformance = (passage: Passage): { wpm: number; accuracy: number } => {\n  const baseWPM = {\n    easy: 65,\n    medium: 55,\n    hard: 45\n  };\n  \n  const baseAccuracy = {\n    easy: 96,\n    medium: 94,\n    hard: 91\n  };\n  \n  const wpmVariation = Math.floor(Math.random() * 20) - 10;\n  const accuracyVariation = Math.floor(Math.random() * 4) - 2;\n  \n  return {\n    wpm: baseWPM[passage.difficulty] + wpmVariation,\n    accuracy: Math.min(99, Math.max(85, baseAccuracy[passage.difficulty] + accuracyVariation))\n  };\n};\n\nconst calculateScore = (wpm: number, accuracy: number): number => {\n  return Math.round((wpm * (accuracy / 100)) * 2);\n};\n\nexport default function SpeedTypingGame({ stake, onGameEnd, isPractice }: SpeedTypingGameProps) {\n  const [passage, setPassage] = useState<Passage | null>(null);\n  const [typedText, setTypedText] = useState(\"\");\n  const [timeLeft, setTimeLeft] = useState(60);\n  const [timeElapsed, setTimeElapsed] = useState(0);\n  const [gamePhase, setGamePhase] = useState<\"ready\" | \"playing\" | \"finished\">(\"ready\");\n  const [wpm, setWpm] = useState(0);\n  const [accuracy, setAccuracy] = useState(100);\n  const [correctChars, setCorrectChars] = useState(0);\n  const [incorrectChars, setIncorrectChars] = useState(0);\n  const [aiPerformance, setAIPerformance] = useState<{ wpm: number; accuracy: number } | null>(null);\n  const [showCursor, setShowCursor] = useState(true);\n  const [completed, setCompleted] = useState(false);\n  \n  const inputRef = useRef<HTMLInputElement>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const cursorInterval = setInterval(() => {\n      setShowCursor(prev => !prev);\n    }, 530);\n    return () => clearInterval(cursorInterval);\n  }, []);\n\n  useEffect(() => {\n    const newPassage = getRandomPassage();\n    setPassage(newPassage);\n    setAIPerformance(generateAIPerformance(newPassage));\n  }, []);\n\n  useEffect(() => {\n    if (gamePhase !== \"playing\" || timeLeft <= 0) return;\n    \n    const timer = setInterval(() => {\n      setTimeLeft((prev) => {\n        if (prev <= 1) {\n          setGamePhase(\"finished\");\n          return 0;\n        }\n        return prev - 1;\n      });\n      setTimeElapsed((prev) => prev + 1);\n    }, 1000);\n    \n    return () => clearInterval(timer);\n  }, [gamePhase, timeLeft]);\n\n  useEffect(() => {\n    if (gamePhase === \"playing\" && timeElapsed > 0) {\n      const newWpm = calculateWPM(correctChars, timeElapsed);\n      setWpm(newWpm);\n    }\n  }, [correctChars, timeElapsed, gamePhase]);\n\n  useEffect(() => {\n    if (gamePhase === \"finished\" && aiPerformance) {\n      const playerScore = calculateScore(wpm, accuracy);\n      const aiScore = calculateScore(aiPerformance.wpm, aiPerformance.accuracy);\n      const won = playerScore > aiScore;\n      onGameEnd(won, playerScore);\n    }\n  }, [gamePhase, wpm, accuracy, aiPerformance, onGameEnd]);\n\n  const handleInputChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {\n    if (gamePhase !== \"playing\" || !passage) return;\n    \n    const newTypedText = e.target.value;\n    const passageText = passage.text;\n    \n    let newCorrectChars = 0;\n    let newIncorrectChars = 0;\n    \n    for (let i = 0; i < newTypedText.length; i++) {\n      if (i < passageText.length) {\n        if (newTypedText[i] === passageText[i]) {\n          newCorrectChars++;\n        } else {\n          newIncorrectChars++;\n        }\n      }\n    }\n    \n    setTypedText(newTypedText);\n    setCorrectChars(newCorrectChars);\n    setIncorrectChars(newIncorrectChars);\n    \n    const totalTyped = newTypedText.length;\n    const newAccuracy = calculateAccuracy(newCorrectChars, totalTyped);\n    setAccuracy(newAccuracy);\n    \n    if (newTypedText.length >= passageText.length && newCorrectChars === passageText.length) {\n      setCompleted(true);\n      setGamePhase(\"finished\");\n    }\n  }, [gamePhase, passage]);\n\n  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {\n    if (gamePhase === \"ready\") {\n      setGamePhase(\"playing\");\n      inputRef.current?.focus();\n    }\n  }, [gamePhase]);\n\n  const handleContainerClick = useCallback(() => {\n    if (gamePhase === \"ready\") {\n      setGamePhase(\"playing\");\n    }\n    inputRef.current?.focus();\n  }, [gamePhase]);\n\n  const startGame = useCallback(() => {\n    setGamePhase(\"playing\");\n    inputRef.current?.focus();\n  }, []);\n\n  const resetGame = useCallback(() => {\n    const newPassage = getRandomPassage();\n    setPassage(newPassage);\n    setAIPerformance(generateAIPerformance(newPassage));\n    setTypedText(\"\");\n    setTimeLeft(60);\n    setTimeElapsed(0);\n    setGamePhase(\"ready\");\n    setWpm(0);\n    setAccuracy(100);\n    setCorrectChars(0);\n    setIncorrectChars(0);\n    setCompleted(false);\n  }, []);\n\n  const renderPassageText = () => {\n    if (!passage) return null;\n    \n    const passageText = passage.text;\n    const chars: JSX.Element[] = [];\n    \n    for (let i = 0; i < passageText.length; i++) {\n      let className = \"text-muted-foreground\";\n      \n      if (i < typedText.length) {\n        if (typedText[i] === passageText[i]) {\n          className = \"text-green-600 dark:text-green-400\";\n        } else {\n          className = \"text-red-600 dark:text-red-400 bg-red-500/20\";\n        }\n      }\n      \n      const showCursorHere = i === typedText.length && showCursor && gamePhase === \"playing\";\n      \n      chars.push(\n        <span key={i} className={`relative ${className}`}>\n          {showCursorHere && (\n            <span className=\"absolute left-0 top-0 h-full w-0.5 bg-primary animate-pulse\" />\n          )}\n          {passageText[i]}\n        </span>\n      );\n    }\n    \n    if (typedText.length === passageText.length && showCursor && gamePhase === \"playing\") {\n      chars.push(\n        <span key=\"cursor-end\" className=\"relative\">\n          <span className=\"absolute left-0 top-0 h-full w-0.5 bg-primary animate-pulse\" />\n        </span>\n      );\n    }\n    \n    return chars;\n  };\n\n  const playerScore = calculateScore(wpm, accuracy);\n  const aiScore = aiPerformance ? calculateScore(aiPerformance.wpm, aiPerformance.accuracy) : 0;\n  const winner = playerScore > aiScore ? \"player\" : playerScore < aiScore ? \"ai\" : \"tie\";\n\n  if (!passage || !aiPerformance) {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto\">\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12 gap-4\">\n            <motion.div\n              animate={{ rotate: 360 }}\n              transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\n            >\n              <Keyboard className=\"h-8 w-8 text-primary\" />\n            </motion.div>\n            <p className=\"text-muted-foreground\">Preparing your passage...</p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (gamePhase === \"ready\") {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"text-xl flex items-center gap-2\">\n              <Keyboard className=\"h-6 w-6 text-primary\" />\n              Speed Typing Challenge\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"text-center space-y-4\"\n            >\n              <div className=\"relative mx-auto w-24 h-24 mb-4\">\n                <motion.div\n                  animate={{ \n                    scale: [1, 1.1, 1],\n                  }}\n                  transition={{ \n                    duration: 1.5, \n                    repeat: Infinity,\n                    repeatType: \"reverse\"\n                  }}\n                  className=\"w-full h-full rounded-full bg-gradient-to-br from-cyan-500 via-blue-500 to-purple-500 flex items-center justify-center shadow-lg\"\n                >\n                  <Keyboard className=\"h-12 w-12 text-white\" />\n                </motion.div>\n                <motion.div\n                  animate={{ \n                    scale: [1, 1.3, 1],\n                    opacity: [0.5, 1, 0.5]\n                  }}\n                  transition={{ \n                    duration: 1.5, \n                    repeat: Infinity \n                  }}\n                  className=\"absolute -top-1 -right-1 w-8 h-8 rounded-full bg-yellow-400 flex items-center justify-center\"\n                >\n                  <Zap className=\"h-4 w-4 text-yellow-800\" />\n                </motion.div>\n              </div>\n              \n              <div>\n                <h3 className=\"text-lg font-semibold\">Test Your Typing Speed</h3>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Type the passage as fast and accurately as you can in 60 seconds!\n                </p>\n              </div>\n            </motion.div>\n\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                <Badge className={getCategoryColor(passage.category)}>\n                  {passage.category}\n                </Badge>\n                <Badge className={getDifficultyColor(passage.difficulty)}>\n                  {passage.difficulty.charAt(0).toUpperCase() + passage.difficulty.slice(1)}\n                </Badge>\n              </div>\n\n              <div className=\"p-4 bg-muted/50 rounded-md\">\n                <p className=\"text-sm leading-relaxed text-muted-foreground\">\n                  <span className=\"font-medium text-foreground\">Preview: </span>\n                  {passage.text.substring(0, 100)}...\n                </p>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                <div className=\"flex items-center gap-2 p-3 bg-muted/30 rounded-md\">\n                  <Timer className=\"h-4 w-4 text-primary\" />\n                  <span>60 seconds</span>\n                </div>\n                <div className=\"flex items-center gap-2 p-3 bg-muted/30 rounded-md\">\n                  <Target className=\"h-4 w-4 text-primary\" />\n                  <span>{passage.text.split(' ').length} words</span>\n                </div>\n              </div>\n\n              {!isPractice && (\n                <div className=\"flex items-center justify-between gap-4 p-3 bg-primary/10 rounded-md\">\n                  <span className=\"text-sm font-medium\">Stake Amount</span>\n                  <Badge variant=\"secondary\">{stake.toLocaleString()} NGN</Badge>\n                </div>\n              )}\n            </div>\n\n            <Button \n              onClick={startGame} \n              className=\"w-full\" \n              size=\"lg\"\n              data-testid=\"button-start-typing\"\n            >\n              <Play className=\"h-5 w-5 mr-2\" />\n              Start Typing\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (gamePhase === \"finished\") {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"text-xl flex items-center gap-2\">\n              <Trophy className=\"h-6 w-6 text-yellow-500\" />\n              Game Complete!\n              {completed && <Badge className=\"ml-2 bg-green-500/20 text-green-600\">Passage Completed</Badge>}\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <motion.div\n              initial={{ scale: 0.8, opacity: 0 }}\n              animate={{ scale: 1, opacity: 1 }}\n              className=\"text-center\"\n            >\n              {winner === \"player\" ? (\n                <div className=\"space-y-2\">\n                  <motion.div\n                    animate={{ rotate: [0, -10, 10, -10, 10, 0] }}\n                    transition={{ duration: 0.5 }}\n                  >\n                    <Crown className=\"h-16 w-16 mx-auto text-yellow-500\" />\n                  </motion.div>\n                  <h3 className=\"text-2xl font-bold text-green-600 dark:text-green-400\">You Won!</h3>\n                  <p className=\"text-muted-foreground\">\n                    {isPractice \n                      ? \"Great typing skills! You beat the AI.\"\n                      : `You earned ${Math.round(stake * 1.9).toLocaleString()} NGN!`\n                    }\n                  </p>\n                </div>\n              ) : winner === \"ai\" ? (\n                <div className=\"space-y-2\">\n                  <Bot className=\"h-16 w-16 mx-auto text-muted-foreground\" />\n                  <h3 className=\"text-2xl font-bold text-red-600 dark:text-red-400\">AI Wins</h3>\n                  <p className=\"text-muted-foreground\">\n                    {isPractice \n                      ? \"Keep practicing! The AI was faster this time.\"\n                      : `You lost ${stake.toLocaleString()} NGN. Better luck next time!`\n                    }\n                  </p>\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  <Star className=\"h-16 w-16 mx-auto text-yellow-500\" />\n                  <h3 className=\"text-2xl font-bold\">It's a Tie!</h3>\n                  <p className=\"text-muted-foreground\">\n                    {isPractice \n                      ? \"Impressive! You matched the AI exactly.\"\n                      : \"Your stake has been returned.\"}\n                  </p>\n                </div>\n              )}\n            </motion.div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <Card className=\"border-2 border-primary/20\">\n                <CardContent className=\"p-4 space-y-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <User className=\"h-5 w-5 text-primary\" />\n                    <span className=\"font-semibold\">You</span>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                    <div className=\"p-2 bg-muted/50 rounded-md\">\n                      <p className=\"text-muted-foreground text-xs\">WPM</p>\n                      <p className=\"font-bold text-lg\">{wpm}</p>\n                    </div>\n                    <div className=\"p-2 bg-muted/50 rounded-md\">\n                      <p className=\"text-muted-foreground text-xs\">Accuracy</p>\n                      <p className=\"font-bold text-lg\">{accuracy}%</p>\n                    </div>\n                  </div>\n                  <div className=\"text-center pt-2 border-t\">\n                    <p className=\"text-xs text-muted-foreground\">Score</p>\n                    <p className=\"text-2xl font-bold text-primary\">{playerScore}</p>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card className=\"border-2 border-muted\">\n                <CardContent className=\"p-4 space-y-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <Bot className=\"h-5 w-5 text-muted-foreground\" />\n                    <span className=\"font-semibold\">AI</span>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                    <div className=\"p-2 bg-muted/50 rounded-md\">\n                      <p className=\"text-muted-foreground text-xs\">WPM</p>\n                      <p className=\"font-bold text-lg\">{aiPerformance.wpm}</p>\n                    </div>\n                    <div className=\"p-2 bg-muted/50 rounded-md\">\n                      <p className=\"text-muted-foreground text-xs\">Accuracy</p>\n                      <p className=\"font-bold text-lg\">{aiPerformance.accuracy}%</p>\n                    </div>\n                  </div>\n                  <div className=\"text-center pt-2 border-t\">\n                    <p className=\"text-xs text-muted-foreground\">Score</p>\n                    <p className=\"text-2xl font-bold\">{aiScore}</p>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n\n            <div className=\"grid grid-cols-3 gap-3 text-sm\">\n              <div className=\"flex items-center gap-2 p-3 bg-muted/30 rounded-md\">\n                <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Time Used</p>\n                  <p className=\"font-medium\">{timeElapsed}s</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2 p-3 bg-green-500/10 rounded-md\">\n                <Award className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Correct</p>\n                  <p className=\"font-medium text-green-600 dark:text-green-400\">{correctChars}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2 p-3 bg-red-500/10 rounded-md\">\n                <Target className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Errors</p>\n                  <p className=\"font-medium text-red-600 dark:text-red-400\">{incorrectChars}</p>\n                </div>\n              </div>\n            </div>\n\n            <Button \n              onClick={resetGame} \n              className=\"w-full\"\n              data-testid=\"button-play-again\"\n            >\n              <RotateCcw className=\"h-4 w-4 mr-2\" />\n              Play Again\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n            <CardTitle className=\"text-lg flex items-center gap-2 flex-wrap\">\n              Speed Typing\n              {isPractice ? (\n                <Badge variant=\"outline\" className=\"text-xs\">Practice</Badge>\n              ) : (\n                <Badge variant=\"secondary\" className=\"text-xs\">\n                  Stake: {stake.toLocaleString()} NGN\n                </Badge>\n              )}\n            </CardTitle>\n            <div className=\"flex items-center gap-2\">\n              <Badge className={`${timeLeft <= 10 ? 'bg-red-500/20 text-red-600 animate-pulse' : 'bg-primary/20'}`}>\n                <Clock className=\"h-3 w-3 mr-1\" />\n                {timeLeft}s\n              </Badge>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-2\">\n              <User className=\"h-4 w-4 text-primary\" />\n              <span className=\"font-bold\">{wpm}</span>\n              <span className=\"text-xs text-muted-foreground\">WPM</span>\n            </div>\n            <Progress value={(60 - timeLeft) / 60 * 100} className=\"flex-1 h-2\" />\n            <div className=\"flex items-center gap-2\">\n              <span className=\"font-bold\">{accuracy}%</span>\n              <span className=\"text-xs text-muted-foreground\">Accuracy</span>\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <Badge className={getCategoryColor(passage.category)}>\n              {passage.category}\n            </Badge>\n            <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n              <span>{typedText.length}/{passage.text.length}</span>\n              <span>characters</span>\n            </div>\n          </div>\n\n          <div \n            ref={containerRef}\n            onClick={handleContainerClick}\n            className=\"relative p-4 bg-muted/30 rounded-md cursor-text min-h-[120px] border-2 border-dashed border-primary/30 focus-within:border-primary transition-colors\"\n          >\n            <p className=\"text-lg leading-relaxed font-mono whitespace-pre-wrap break-words\">\n              {renderPassageText()}\n            </p>\n            <input\n              ref={inputRef}\n              type=\"text\"\n              value={typedText}\n              onChange={handleInputChange}\n              onKeyDown={handleKeyDown}\n              className=\"absolute inset-0 w-full h-full opacity-0 cursor-text\"\n              autoFocus\n              autoComplete=\"off\"\n              autoCorrect=\"off\"\n              autoCapitalize=\"off\"\n              spellCheck={false}\n              data-testid=\"input-typing\"\n            />\n          </div>\n\n          <div className=\"flex items-center justify-center gap-2 text-sm text-muted-foreground\">\n            <Keyboard className=\"h-4 w-4\" />\n            <span>Click or tap above to start typing</span>\n          </div>\n\n          <div className=\"grid grid-cols-3 gap-3 text-sm\">\n            <div className=\"text-center p-3 bg-muted/30 rounded-md\">\n              <Zap className=\"h-4 w-4 mx-auto mb-1 text-primary\" />\n              <p className=\"font-bold\">{wpm}</p>\n              <p className=\"text-xs text-muted-foreground\">WPM</p>\n            </div>\n            <div className=\"text-center p-3 bg-green-500/10 rounded-md\">\n              <Target className=\"h-4 w-4 mx-auto mb-1 text-green-600 dark:text-green-400\" />\n              <p className=\"font-bold text-green-600 dark:text-green-400\">{correctChars}</p>\n              <p className=\"text-xs text-muted-foreground\">Correct</p>\n            </div>\n            <div className=\"text-center p-3 bg-red-500/10 rounded-md\">\n              <Target className=\"h-4 w-4 mx-auto mb-1 text-red-600 dark:text-red-400\" />\n              <p className=\"font-bold text-red-600 dark:text-red-400\">{incorrectChars}</p>\n              <p className=\"text-xs text-muted-foreground\">Errors</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":31574,"size_tokens":null},"client/src/components/games/WhotGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  RotateCcw, \n  Trophy, \n  Bot, \n  User, \n  Play,\n  Spade,\n  Hand,\n  AlertCircle,\n  Sparkles,\n  Crown,\n  Star,\n  Circle,\n  Triangle,\n  Square,\n  Plus,\n  X\n} from \"lucide-react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\n\ninterface WhotGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype Shape = \"circle\" | \"triangle\" | \"cross\" | \"square\" | \"star\" | \"whot\";\ntype Player = \"player\" | \"ai\";\ntype GamePhase = \"ready\" | \"playing\" | \"checkup\" | \"finished\";\n\ninterface WhotCard {\n  id: string;\n  shape: Shape;\n  number: number;\n}\n\nconst SHAPES: Shape[] = [\"circle\", \"triangle\", \"cross\", \"square\", \"star\"];\n\nconst SHAPE_COLORS: Record<Shape, { bg: string; text: string; border: string }> = {\n  circle: { bg: \"bg-red-500\", text: \"text-red-500\", border: \"border-red-500\" },\n  triangle: { bg: \"bg-blue-500\", text: \"text-blue-500\", border: \"border-blue-500\" },\n  cross: { bg: \"bg-yellow-500\", text: \"text-yellow-500\", border: \"border-yellow-500\" },\n  square: { bg: \"bg-green-500\", text: \"text-green-500\", border: \"border-green-500\" },\n  star: { bg: \"bg-purple-500\", text: \"text-purple-500\", border: \"border-purple-500\" },\n  whot: { bg: \"bg-gradient-to-br from-orange-500 to-pink-500\", text: \"text-orange-500\", border: \"border-orange-500\" },\n};\n\nconst SHAPE_ICONS: Record<Shape, typeof Circle> = {\n  circle: Circle,\n  triangle: Triangle,\n  cross: Plus,\n  square: Square,\n  star: Star,\n  whot: Sparkles,\n};\n\nconst SPECIAL_CARDS: Record<number, { name: string; effect: string }> = {\n  1: { name: \"Hold On\", effect: \"Blocks the next player\" },\n  2: { name: \"Pick Two\", effect: \"Next player picks 2 cards\" },\n  5: { name: \"Pick Three\", effect: \"Next player picks 3 cards\" },\n  8: { name: \"Suspension\", effect: \"Skip the next player\" },\n  14: { name: \"General Market\", effect: \"All players pick one card\" },\n  20: { name: \"Whot!\", effect: \"Wild card - call any shape\" },\n};\n\nconst createDeck = (): WhotCard[] => {\n  const deck: WhotCard[] = [];\n  let id = 0;\n  \n  for (const shape of SHAPES) {\n    for (let num = 1; num <= 14; num++) {\n      deck.push({ id: `${id++}`, shape, number: num });\n    }\n  }\n  \n  for (let i = 0; i < 5; i++) {\n    deck.push({ id: `${id++}`, shape: \"whot\", number: 20 });\n  }\n  \n  return deck;\n};\n\nconst shuffleDeck = (deck: WhotCard[]): WhotCard[] => {\n  const shuffled = [...deck];\n  for (let i = shuffled.length - 1; i > 0; i--) {\n    const j = Math.floor(Math.random() * (i + 1));\n    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];\n  }\n  return shuffled;\n};\n\nconst canPlayCard = (card: WhotCard, topCard: WhotCard, calledShape: Shape | null): boolean => {\n  if (card.shape === \"whot\") return true;\n  if (calledShape && card.shape === calledShape) return true;\n  if (!calledShape) {\n    if (card.shape === topCard.shape) return true;\n    if (card.number === topCard.number) return true;\n  }\n  return false;\n};\n\nconst getCardDisplayNumber = (num: number): string => {\n  if (num === 20) return \"W\";\n  return num.toString();\n};\n\nconst CardComponent = ({ \n  card, \n  onClick, \n  isPlayable = false, \n  isSelected = false,\n  isFaceDown = false,\n  size = \"normal\"\n}: { \n  card: WhotCard; \n  onClick?: () => void; \n  isPlayable?: boolean;\n  isSelected?: boolean;\n  isFaceDown?: boolean;\n  size?: \"small\" | \"normal\" | \"large\";\n}) => {\n  const colors = SHAPE_COLORS[card.shape];\n  const ShapeIcon = SHAPE_ICONS[card.shape];\n  \n  const sizeClasses = {\n    small: \"w-12 h-18 text-xs\",\n    normal: \"w-16 h-24 text-sm\",\n    large: \"w-20 h-30 text-base\"\n  };\n  \n  const iconSizes = {\n    small: \"h-4 w-4\",\n    normal: \"h-6 w-6\",\n    large: \"h-8 w-8\"\n  };\n  \n  if (isFaceDown) {\n    return (\n      <motion.div\n        className={`${sizeClasses[size]} rounded-lg bg-gradient-to-br from-green-700 via-green-600 to-green-800 border-2 border-green-500 flex items-center justify-center shadow-lg cursor-pointer`}\n        whileHover={{ scale: 1.05 }}\n        onClick={onClick}\n      >\n        <div className=\"text-green-300 font-bold text-lg\">W</div>\n      </motion.div>\n    );\n  }\n  \n  const isSpecial = SPECIAL_CARDS[card.number];\n  \n  return (\n    <motion.div\n      className={`\n        ${sizeClasses[size]} rounded-lg bg-white dark:bg-gray-800 border-2 \n        ${isPlayable ? `${colors.border} ring-2 ring-offset-2 ring-primary cursor-pointer` : 'border-gray-300 dark:border-gray-600'}\n        ${isSelected ? 'ring-4 ring-primary scale-110' : ''}\n        flex flex-col items-center justify-between p-1.5 shadow-lg relative overflow-hidden\n        ${isPlayable ? 'hover:shadow-xl' : 'opacity-70'}\n        transition-all duration-200\n      `}\n      whileHover={isPlayable ? { scale: 1.08, y: -5 } : {}}\n      whileTap={isPlayable ? { scale: 0.95 } : {}}\n      onClick={isPlayable ? onClick : undefined}\n      layout\n    >\n      <div className={`absolute top-0 left-0 w-full h-1 ${colors.bg}`} />\n      \n      <div className=\"flex items-center justify-between w-full px-0.5\">\n        <span className={`font-bold ${colors.text}`}>\n          {getCardDisplayNumber(card.number)}\n        </span>\n        <ShapeIcon className={`${iconSizes[size]} ${colors.text}`} />\n      </div>\n      \n      <div className=\"flex-1 flex items-center justify-center\">\n        <ShapeIcon className={`${size === \"small\" ? \"h-6 w-6\" : size === \"normal\" ? \"h-10 w-10\" : \"h-14 w-14\"} ${colors.text}`} />\n      </div>\n      \n      <div className=\"flex items-center justify-between w-full px-0.5\">\n        <ShapeIcon className={`${iconSizes[size]} ${colors.text} rotate-180`} />\n        <span className={`font-bold ${colors.text} rotate-180`}>\n          {getCardDisplayNumber(card.number)}\n        </span>\n      </div>\n      \n      {isSpecial && (\n        <motion.div \n          className=\"absolute inset-0 bg-gradient-to-br from-transparent via-white/10 to-transparent pointer-events-none\"\n          animate={{ \n            opacity: [0.3, 0.6, 0.3],\n          }}\n          transition={{ duration: 2, repeat: Infinity }}\n        />\n      )}\n    </motion.div>\n  );\n};\n\nconst ShapeSelector = ({ \n  onSelect, \n  onCancel \n}: { \n  onSelect: (shape: Shape) => void;\n  onCancel: () => void;\n}) => {\n  return (\n    <Dialog open={true} onOpenChange={(open) => !open && onCancel()}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Sparkles className=\"h-5 w-5 text-orange-500\" />\n            Call a Shape\n          </DialogTitle>\n          <DialogDescription>\n            You played a Whot card! Choose the shape you want to call.\n          </DialogDescription>\n        </DialogHeader>\n        <div className=\"grid grid-cols-5 gap-3 py-4\">\n          {SHAPES.map((shape) => {\n            const ShapeIcon = SHAPE_ICONS[shape];\n            const colors = SHAPE_COLORS[shape];\n            return (\n              <motion.button\n                key={shape}\n                className={`p-4 rounded-lg ${colors.bg} text-white flex flex-col items-center gap-2 shadow-lg`}\n                whileHover={{ scale: 1.1 }}\n                whileTap={{ scale: 0.95 }}\n                onClick={() => onSelect(shape)}\n                data-testid={`button-shape-${shape}`}\n              >\n                <ShapeIcon className=\"h-8 w-8\" />\n                <span className=\"text-xs font-medium capitalize\">{shape}</span>\n              </motion.button>\n            );\n          })}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default function WhotGame({ stake, onGameEnd, isPractice }: WhotGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"ready\");\n  const [deck, setDeck] = useState<WhotCard[]>([]);\n  const [discardPile, setDiscardPile] = useState<WhotCard[]>([]);\n  const [playerHand, setPlayerHand] = useState<WhotCard[]>([]);\n  const [aiHand, setAiHand] = useState<WhotCard[]>([]);\n  const [currentPlayer, setCurrentPlayer] = useState<Player>(\"player\");\n  const [calledShape, setCalledShape] = useState<Shape | null>(null);\n  const [showShapeSelector, setShowShapeSelector] = useState(false);\n  const [pendingWhotCard, setPendingWhotCard] = useState<WhotCard | null>(null);\n  const [message, setMessage] = useState(\"Ready to play Whot!\");\n  const [winner, setWinner] = useState<Player | null>(null);\n  const [isBlocked, setIsBlocked] = useState(false);\n  const [pendingPickUp, setPendingPickUp] = useState(0);\n  const [lastPlayedCard, setLastPlayedCard] = useState<WhotCard | null>(null);\n  const [isAiThinking, setIsAiThinking] = useState(false);\n  const [checkUpCalled, setCheckUpCalled] = useState(false);\n  \n  const aiTurnRef = useRef(false);\n  const timeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current);\n      }\n    };\n  }, []);\n\n  const initGame = useCallback(() => {\n    const newDeck = shuffleDeck(createDeck());\n    \n    const playerCards = newDeck.splice(0, 5);\n    const aiCards = newDeck.splice(0, 5);\n    \n    let startCard = newDeck.shift()!;\n    while (startCard.shape === \"whot\" || SPECIAL_CARDS[startCard.number]) {\n      newDeck.push(startCard);\n      startCard = newDeck.shift()!;\n    }\n    \n    setDeck(newDeck);\n    setDiscardPile([startCard]);\n    setPlayerHand(playerCards);\n    setAiHand(aiCards);\n    setCurrentPlayer(\"player\");\n    setCalledShape(null);\n    setShowShapeSelector(false);\n    setPendingWhotCard(null);\n    setMessage(\"Your turn! Match by shape or number.\");\n    setWinner(null);\n    setIsBlocked(false);\n    setPendingPickUp(0);\n    setLastPlayedCard(null);\n    setIsAiThinking(false);\n    setCheckUpCalled(false);\n    setGamePhase(\"playing\");\n    aiTurnRef.current = false;\n  }, []);\n\n  const drawCard = useCallback((count: number = 1): WhotCard[] => {\n    const drawnCards: WhotCard[] = [];\n    let currentDeck = [...deck];\n    let currentDiscard = [...discardPile];\n    \n    for (let i = 0; i < count; i++) {\n      if (currentDeck.length === 0) {\n        if (currentDiscard.length <= 1) break;\n        const topCard = currentDiscard.pop()!;\n        currentDeck = shuffleDeck(currentDiscard);\n        currentDiscard = [topCard];\n      }\n      \n      const card = currentDeck.shift();\n      if (card) drawnCards.push(card);\n    }\n    \n    setDeck(currentDeck);\n    setDiscardPile(currentDiscard);\n    return drawnCards;\n  }, [deck, discardPile]);\n\n  const checkWinner = useCallback((player: Player, hand: WhotCard[]) => {\n    if (hand.length === 0) {\n      setWinner(player);\n      setGamePhase(\"finished\");\n      const won = player === \"player\";\n      onGameEnd(won, won ? 100 : 0);\n      return true;\n    }\n    return false;\n  }, [onGameEnd]);\n\n  const applySpecialEffect = useCallback((card: WhotCard, playedBy: Player) => {\n    const opponent = playedBy === \"player\" ? \"ai\" : \"player\";\n    \n    switch (card.number) {\n      case 1: // Hold On\n        setIsBlocked(true);\n        setMessage(`${playedBy === \"player\" ? \"AI\" : \"You\"} blocked! ${playedBy === \"player\" ? \"You play\" : \"AI plays\"} again.`);\n        break;\n      case 2: // Pick Two\n        setPendingPickUp(prev => prev + 2);\n        setMessage(`${opponent === \"player\" ? \"You\" : \"AI\"} must pick 2 cards or play a 2!`);\n        break;\n      case 5: // Pick Three\n        setPendingPickUp(prev => prev + 3);\n        setMessage(`${opponent === \"player\" ? \"You\" : \"AI\"} must pick 3 cards or play a 5!`);\n        break;\n      case 8: // Suspension\n        setIsBlocked(true);\n        setMessage(`${opponent === \"player\" ? \"You are\" : \"AI is\"} suspended! Turn skipped.`);\n        break;\n      case 14: // General Market\n        const playerPickup = drawCard(1);\n        const aiPickup = drawCard(1);\n        if (playedBy === \"player\") {\n          setAiHand(prev => [...prev, ...aiPickup]);\n        } else {\n          setPlayerHand(prev => [...prev, ...playerPickup]);\n        }\n        setMessage(\"General Market! Everyone picks a card.\");\n        break;\n    }\n  }, [drawCard]);\n\n  const playCard = useCallback((card: WhotCard, player: Player) => {\n    if (player === \"player\") {\n      setPlayerHand(prev => prev.filter(c => c.id !== card.id));\n    } else {\n      setAiHand(prev => prev.filter(c => c.id !== card.id));\n    }\n    \n    setDiscardPile(prev => [...prev, card]);\n    setLastPlayedCard(card);\n    setCalledShape(null);\n    \n    if (card.shape === \"whot\") {\n      if (player === \"player\") {\n        setPendingWhotCard(card);\n        setShowShapeSelector(true);\n      } else {\n        const shapes = [\"circle\", \"triangle\", \"cross\", \"square\", \"star\"] as Shape[];\n        const randomShape = shapes[Math.floor(Math.random() * shapes.length)];\n        setCalledShape(randomShape);\n        setMessage(`AI called ${randomShape}!`);\n      }\n    } else if (SPECIAL_CARDS[card.number] && card.number !== 20) {\n      applySpecialEffect(card, player);\n    }\n    \n    setPendingPickUp(0);\n  }, [applySpecialEffect]);\n\n  const handleShapeSelection = useCallback((shape: Shape) => {\n    setShowShapeSelector(false);\n    setCalledShape(shape);\n    setPendingWhotCard(null);\n    setMessage(`You called ${shape}!`);\n    \n    const updatedHand = playerHand.filter(c => c.id !== pendingWhotCard?.id);\n    if (checkWinner(\"player\", updatedHand)) return;\n    \n    if (!isBlocked) {\n      setCurrentPlayer(\"ai\");\n    } else {\n      setIsBlocked(false);\n    }\n  }, [playerHand, pendingWhotCard, isBlocked, checkWinner]);\n\n  const handlePlayerCardClick = useCallback((card: WhotCard) => {\n    if (gamePhase !== \"playing\" || currentPlayer !== \"player\" || isAiThinking) return;\n    \n    const topCard = discardPile[discardPile.length - 1];\n    \n    if (pendingPickUp > 0) {\n      if ((card.number === 2 && pendingPickUp <= 4) || (card.number === 5 && pendingPickUp <= 6)) {\n        playCard(card, \"player\");\n        const updatedHand = playerHand.filter(c => c.id !== card.id);\n        if (checkWinner(\"player\", updatedHand)) return;\n        setCurrentPlayer(\"ai\");\n        return;\n      } else {\n        setMessage(\"You must play a matching pick card or draw!\");\n        return;\n      }\n    }\n    \n    if (!canPlayCard(card, topCard, calledShape)) {\n      setMessage(\"Invalid move! Match by shape or number.\");\n      return;\n    }\n    \n    if (playerHand.length === 2 && !checkUpCalled) {\n      setMessage(\"You must call 'Check Up' before playing second-to-last card!\");\n      return;\n    }\n    \n    playCard(card, \"player\");\n    \n    if (card.shape === \"whot\") return;\n    \n    const updatedHand = playerHand.filter(c => c.id !== card.id);\n    if (checkWinner(\"player\", updatedHand)) return;\n    \n    if (!isBlocked && !SPECIAL_CARDS[card.number]) {\n      setCurrentPlayer(\"ai\");\n      setMessage(\"AI's turn...\");\n    } else if (isBlocked) {\n      setIsBlocked(false);\n      setMessage(\"Your turn again!\");\n    }\n  }, [gamePhase, currentPlayer, isAiThinking, discardPile, pendingPickUp, calledShape, playerHand, checkUpCalled, playCard, checkWinner, isBlocked]);\n\n  const handlePlayerDraw = useCallback(() => {\n    if (gamePhase !== \"playing\" || currentPlayer !== \"player\" || isAiThinking) return;\n    \n    const count = pendingPickUp > 0 ? pendingPickUp : 1;\n    const drawnCards = drawCard(count);\n    \n    if (drawnCards.length > 0) {\n      setPlayerHand(prev => [...prev, ...drawnCards]);\n      setMessage(`You picked ${drawnCards.length} card(s).`);\n      setPendingPickUp(0);\n      \n      if (!isBlocked) {\n        setCurrentPlayer(\"ai\");\n      } else {\n        setIsBlocked(false);\n      }\n    }\n  }, [gamePhase, currentPlayer, isAiThinking, pendingPickUp, drawCard, isBlocked]);\n\n  const handleCheckUp = useCallback(() => {\n    if (playerHand.length === 2 && !checkUpCalled) {\n      setCheckUpCalled(true);\n      setMessage(\"Check Up! One card left after this!\");\n    }\n  }, [playerHand.length, checkUpCalled]);\n\n  useEffect(() => {\n    if (gamePhase !== \"playing\" || currentPlayer !== \"ai\" || aiTurnRef.current) return;\n    \n    aiTurnRef.current = true;\n    setIsAiThinking(true);\n    \n    timeoutRef.current = setTimeout(() => {\n      const topCard = discardPile[discardPile.length - 1];\n      \n      if (pendingPickUp > 0) {\n        const counterCard = aiHand.find(c => \n          (c.number === 2 && pendingPickUp <= 4) || \n          (c.number === 5 && pendingPickUp <= 6)\n        );\n        \n        if (counterCard) {\n          playCard(counterCard, \"ai\");\n          const updatedHand = aiHand.filter(c => c.id !== counterCard.id);\n          if (checkWinner(\"ai\", updatedHand)) {\n            setIsAiThinking(false);\n            aiTurnRef.current = false;\n            return;\n          }\n          setCurrentPlayer(\"player\");\n          setIsAiThinking(false);\n          aiTurnRef.current = false;\n          setMessage(\"Your turn!\");\n          return;\n        } else {\n          const drawnCards = drawCard(pendingPickUp);\n          setAiHand(prev => [...prev, ...drawnCards]);\n          setPendingPickUp(0);\n          setMessage(`AI picked ${drawnCards.length} cards. Your turn!`);\n          setCurrentPlayer(\"player\");\n          setIsAiThinking(false);\n          aiTurnRef.current = false;\n          return;\n        }\n      }\n      \n      const playableCards = aiHand.filter(c => canPlayCard(c, topCard, calledShape));\n      \n      if (playableCards.length > 0) {\n        const specialCards = playableCards.filter(c => SPECIAL_CARDS[c.number]);\n        const normalCards = playableCards.filter(c => !SPECIAL_CARDS[c.number]);\n        \n        let cardToPlay: WhotCard;\n        if (aiHand.length <= 3 && normalCards.length > 0) {\n          cardToPlay = normalCards[0];\n        } else if (specialCards.length > 0 && Math.random() > 0.3) {\n          cardToPlay = specialCards[Math.floor(Math.random() * specialCards.length)];\n        } else {\n          cardToPlay = playableCards[Math.floor(Math.random() * playableCards.length)];\n        }\n        \n        playCard(cardToPlay, \"ai\");\n        \n        const updatedHand = aiHand.filter(c => c.id !== cardToPlay.id);\n        \n        if (updatedHand.length === 1) {\n          setMessage(\"AI calls Check Up!\");\n        }\n        \n        if (checkWinner(\"ai\", updatedHand)) {\n          setIsAiThinking(false);\n          aiTurnRef.current = false;\n          return;\n        }\n        \n        if (cardToPlay.shape === \"whot\") {\n          timeoutRef.current = setTimeout(() => {\n            if (!isBlocked) {\n              setCurrentPlayer(\"player\");\n              setMessage(\"Your turn!\");\n            } else {\n              setIsBlocked(false);\n            }\n            setIsAiThinking(false);\n            aiTurnRef.current = false;\n          }, 500);\n          return;\n        }\n        \n        if (!isBlocked && !SPECIAL_CARDS[cardToPlay.number]) {\n          setCurrentPlayer(\"player\");\n          setMessage(\"Your turn!\");\n        } else if (isBlocked) {\n          setIsBlocked(false);\n          setMessage(\"AI plays again!\");\n          aiTurnRef.current = false;\n          timeoutRef.current = setTimeout(() => {\n            setCurrentPlayer(\"ai\");\n          }, 500);\n          setIsAiThinking(false);\n          return;\n        }\n      } else {\n        const drawnCards = drawCard(1);\n        if (drawnCards.length > 0) {\n          setAiHand(prev => [...prev, ...drawnCards]);\n          setMessage(\"AI picked a card. Your turn!\");\n        }\n        setCurrentPlayer(\"player\");\n      }\n      \n      setIsAiThinking(false);\n      aiTurnRef.current = false;\n    }, 1200);\n  }, [gamePhase, currentPlayer, discardPile, aiHand, calledShape, pendingPickUp, isBlocked, playCard, drawCard, checkWinner]);\n\n  const resetGame = useCallback(() => {\n    if (timeoutRef.current) {\n      clearTimeout(timeoutRef.current);\n    }\n    aiTurnRef.current = false;\n    setGamePhase(\"ready\");\n  }, []);\n\n  const topCard = discardPile[discardPile.length - 1];\n  \n  const playablePlayerCards = playerHand.filter(card => {\n    if (pendingPickUp > 0) {\n      return (card.number === 2 && pendingPickUp <= 4) || (card.number === 5 && pendingPickUp <= 6);\n    }\n    return canPlayCard(card, topCard, calledShape);\n  });\n\n  if (gamePhase === \"ready\") {\n    return (\n      <Card className=\"overflow-visible\">\n        <CardHeader className=\"pb-4\">\n          <CardTitle className=\"text-xl flex items-center gap-2\">\n            <Spade className=\"h-6 w-6 text-orange-500\" />\n            Whot Card Game\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <motion.div\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"text-center space-y-4\"\n          >\n            <div className=\"relative mx-auto w-32 h-32 mb-4\">\n              <motion.div\n                animate={{ \n                  rotateY: [0, 180, 360],\n                }}\n                transition={{ \n                  duration: 3, \n                  repeat: Infinity,\n                  ease: \"easeInOut\"\n                }}\n                className=\"w-full h-full rounded-xl bg-gradient-to-br from-green-600 via-green-500 to-green-700 flex items-center justify-center shadow-2xl border-4 border-green-400\"\n              >\n                <span className=\"text-4xl font-bold text-white\">W</span>\n              </motion.div>\n              <motion.div\n                animate={{ \n                  scale: [1, 1.2, 1],\n                  opacity: [0.5, 1, 0.5]\n                }}\n                transition={{ \n                  duration: 1.5, \n                  repeat: Infinity \n                }}\n                className=\"absolute -top-2 -right-2 w-10 h-10 rounded-full bg-orange-500 flex items-center justify-center shadow-lg\"\n              >\n                <Crown className=\"h-5 w-5 text-white\" />\n              </motion.div>\n            </div>\n            \n            <div>\n              <h3 className=\"text-lg font-semibold\">Nigerian Whot</h3>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                The classic Nigerian card game! Match by shape or number.\n              </p>\n            </div>\n          </motion.div>\n\n          <div className=\"space-y-3 p-4 rounded-lg bg-muted/50\">\n            <h4 className=\"font-medium text-sm\">Game Rules:</h4>\n            <ul className=\"text-xs text-muted-foreground space-y-1\">\n              <li className=\"flex items-center gap-2\">\n                <Circle className=\"h-3 w-3 text-red-500\" />\n                Match cards by shape or number\n              </li>\n              <li className=\"flex items-center gap-2\">\n                <Sparkles className=\"h-3 w-3 text-orange-500\" />\n                Whot cards are wild - call any shape!\n              </li>\n              <li className=\"flex items-center gap-2\">\n                <Hand className=\"h-3 w-3 text-blue-500\" />\n                Special cards: 1 (Hold), 2 (Pick 2), 5 (Pick 3), 8 (Skip), 14 (Market)\n              </li>\n              <li className=\"flex items-center gap-2\">\n                <Trophy className=\"h-3 w-3 text-yellow-500\" />\n                First to empty their hand wins!\n              </li>\n            </ul>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4 text-center\">\n            <div className=\"p-3 rounded-lg bg-blue-500/10\">\n              <User className=\"h-5 w-5 mx-auto mb-1 text-blue-500\" />\n              <p className=\"text-sm font-medium\">You</p>\n            </div>\n            <div className=\"p-3 rounded-lg bg-red-500/10\">\n              <Bot className=\"h-5 w-5 mx-auto mb-1 text-red-500\" />\n              <p className=\"text-sm font-medium\">AI Opponent</p>\n            </div>\n          </div>\n\n          {!isPractice && stake > 0 && (\n            <div className=\"text-center p-3 rounded-lg bg-green-500/10\">\n              <p className=\"text-sm text-muted-foreground\">Stake</p>\n              <p className=\"text-lg font-bold text-green-600\">{stake.toLocaleString()} NGN</p>\n            </div>\n          )}\n\n          <Button \n            onClick={initGame} \n            className=\"w-full\" \n            size=\"lg\"\n            data-testid=\"button-start-whot\"\n          >\n            <Play className=\"h-5 w-5 mr-2\" />\n            Start Game\n          </Button>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (gamePhase === \"finished\") {\n    return (\n      <Card className=\"overflow-visible\">\n        <CardContent className=\"py-8\">\n          <motion.div\n            initial={{ scale: 0 }}\n            animate={{ scale: 1 }}\n            className=\"text-center space-y-6\"\n          >\n            <motion.div\n              animate={{ \n                rotate: winner === \"player\" ? [0, 10, -10, 0] : 0,\n                scale: winner === \"player\" ? [1, 1.1, 1] : 1\n              }}\n              transition={{ duration: 0.5, repeat: winner === \"player\" ? Infinity : 0, repeatDelay: 1 }}\n              className={`w-24 h-24 mx-auto rounded-full flex items-center justify-center ${\n                winner === \"player\" \n                  ? \"bg-gradient-to-br from-yellow-400 to-orange-500\" \n                  : \"bg-gradient-to-br from-gray-400 to-gray-600\"\n              }`}\n            >\n              <Trophy className={`h-12 w-12 ${winner === \"player\" ? \"text-white\" : \"text-gray-300\"}`} />\n            </motion.div>\n            \n            <div>\n              <h2 className=\"text-2xl font-bold\">\n                {winner === \"player\" ? \"You Won!\" : \"AI Wins!\"}\n              </h2>\n              <p className=\"text-muted-foreground mt-1\">\n                {winner === \"player\" \n                  ? \"Congratulations! You emptied your hand first!\" \n                  : \"The AI emptied their hand first. Better luck next time!\"}\n              </p>\n            </div>\n\n            {!isPractice && stake > 0 && (\n              <div className={`p-4 rounded-lg ${winner === \"player\" ? \"bg-green-500/10\" : \"bg-red-500/10\"}`}>\n                <p className=\"text-sm text-muted-foreground\">\n                  {winner === \"player\" ? \"You won\" : \"You lost\"}\n                </p>\n                <p className={`text-xl font-bold ${winner === \"player\" ? \"text-green-600\" : \"text-red-600\"}`}>\n                  {winner === \"player\" ? \"+\" : \"-\"}{stake.toLocaleString()} NGN\n                </p>\n              </div>\n            )}\n\n            <Button \n              onClick={resetGame} \n              size=\"lg\"\n              data-testid=\"button-play-again\"\n            >\n              <RotateCcw className=\"h-5 w-5 mr-2\" />\n              Play Again\n            </Button>\n          </motion.div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      {showShapeSelector && (\n        <ShapeSelector \n          onSelect={handleShapeSelection}\n          onCancel={() => setShowShapeSelector(false)}\n        />\n      )}\n      \n      <div className=\"flex items-center justify-between gap-4\">\n        <Badge \n          variant={currentPlayer === \"ai\" ? \"default\" : \"outline\"}\n          className=\"flex items-center gap-1\"\n        >\n          <Bot className=\"h-3 w-3\" />\n          AI: {aiHand.length} cards\n        </Badge>\n        \n        <div className=\"text-center\">\n          <p className=\"text-sm text-muted-foreground\">{message}</p>\n        </div>\n        \n        <Badge \n          variant={currentPlayer === \"player\" ? \"default\" : \"outline\"}\n          className=\"flex items-center gap-1\"\n        >\n          <User className=\"h-3 w-3\" />\n          You: {playerHand.length} cards\n        </Badge>\n      </div>\n\n      <Card className=\"p-4\">\n        <div className=\"flex items-center justify-between mb-2\">\n          <span className=\"text-sm font-medium text-muted-foreground\">AI Hand</span>\n          {isAiThinking && (\n            <Badge variant=\"secondary\" className=\"animate-pulse\">\n              Thinking...\n            </Badge>\n          )}\n        </div>\n        <div className=\"flex flex-wrap justify-center gap-1\">\n          {aiHand.map((_, index) => (\n            <motion.div\n              key={index}\n              initial={{ opacity: 0, y: -20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: index * 0.05 }}\n              className=\"w-8 h-12 rounded bg-gradient-to-br from-green-700 to-green-800 border border-green-500\"\n            />\n          ))}\n        </div>\n      </Card>\n\n      <div className=\"flex items-center justify-center gap-6\">\n        <div className=\"text-center\">\n          <p className=\"text-xs text-muted-foreground mb-2\">Deck ({deck.length})</p>\n          <motion.div\n            whileHover={{ scale: 1.05 }}\n            whileTap={{ scale: 0.95 }}\n            className=\"cursor-pointer\"\n            onClick={handlePlayerDraw}\n          >\n            <div className=\"relative\">\n              {deck.length > 2 && (\n                <div className=\"absolute -top-1 -left-1 w-16 h-24 rounded-lg bg-gradient-to-br from-green-800 to-green-900 border-2 border-green-600\" />\n              )}\n              {deck.length > 1 && (\n                <div className=\"absolute -top-0.5 -left-0.5 w-16 h-24 rounded-lg bg-gradient-to-br from-green-700 to-green-800 border-2 border-green-500\" />\n              )}\n              <div className=\"relative w-16 h-24 rounded-lg bg-gradient-to-br from-green-600 to-green-700 border-2 border-green-400 flex items-center justify-center shadow-lg\">\n                <span className=\"text-2xl font-bold text-green-200\">W</span>\n              </div>\n            </div>\n          </motion.div>\n          <p className=\"text-xs text-muted-foreground mt-1\">Click to draw</p>\n        </div>\n\n        <div className=\"text-center\">\n          <p className=\"text-xs text-muted-foreground mb-2\">\n            Discard Pile\n            {calledShape && (\n              <span className=\"ml-1\">\n                (Called: <span className={SHAPE_COLORS[calledShape].text}>{calledShape}</span>)\n              </span>\n            )}\n          </p>\n          <AnimatePresence mode=\"wait\">\n            {topCard && (\n              <motion.div\n                key={topCard.id}\n                initial={{ scale: 0, rotate: -180 }}\n                animate={{ scale: 1, rotate: 0 }}\n                exit={{ scale: 0, rotate: 180 }}\n                transition={{ type: \"spring\", damping: 15 }}\n              >\n                <CardComponent card={topCard} size=\"normal\" />\n              </motion.div>\n            )}\n          </AnimatePresence>\n          {lastPlayedCard && SPECIAL_CARDS[lastPlayedCard.number] && (\n            <Badge variant=\"secondary\" className=\"mt-2\">\n              {SPECIAL_CARDS[lastPlayedCard.number].name}\n            </Badge>\n          )}\n        </div>\n      </div>\n\n      {pendingPickUp > 0 && currentPlayer === \"player\" && (\n        <motion.div\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"flex items-center justify-center gap-2 p-3 rounded-lg bg-red-500/10 border border-red-500/30\"\n        >\n          <AlertCircle className=\"h-5 w-5 text-red-500\" />\n          <span className=\"text-sm font-medium text-red-500\">\n            You must pick {pendingPickUp} cards or play a counter card!\n          </span>\n          <Button \n            variant=\"destructive\" \n            size=\"sm\"\n            onClick={handlePlayerDraw}\n            data-testid=\"button-pick-cards\"\n          >\n            Pick {pendingPickUp} Cards\n          </Button>\n        </motion.div>\n      )}\n\n      {playerHand.length === 2 && !checkUpCalled && (\n        <motion.div\n          initial={{ opacity: 0, scale: 0.9 }}\n          animate={{ opacity: 1, scale: 1 }}\n          className=\"flex items-center justify-center\"\n        >\n          <Button \n            onClick={handleCheckUp}\n            variant=\"outline\"\n            className=\"border-orange-500 text-orange-500\"\n            data-testid=\"button-check-up\"\n          >\n            <Hand className=\"h-4 w-4 mr-2\" />\n            Call Check Up!\n          </Button>\n        </motion.div>\n      )}\n\n      <Card className=\"p-4\">\n        <div className=\"flex items-center justify-between mb-2\">\n          <span className=\"text-sm font-medium text-muted-foreground\">Your Hand</span>\n          {playerHand.length === 1 && (\n            <Badge className=\"bg-orange-500\">Last Card!</Badge>\n          )}\n        </div>\n        <div className=\"flex flex-wrap justify-center gap-2\">\n          <AnimatePresence>\n            {playerHand.map((card, index) => {\n              const isPlayable = currentPlayer === \"player\" && \n                !isAiThinking && \n                playablePlayerCards.some(c => c.id === card.id);\n              \n              return (\n                <motion.div\n                  key={card.id}\n                  initial={{ opacity: 0, y: 50, scale: 0 }}\n                  animate={{ \n                    opacity: 1, \n                    y: 0, \n                    scale: 1,\n                    rotate: (index - playerHand.length / 2) * 3\n                  }}\n                  exit={{ opacity: 0, scale: 0, y: -50 }}\n                  transition={{ delay: index * 0.05, type: \"spring\" }}\n                  style={{ \n                    marginLeft: index > 0 ? \"-10px\" : 0,\n                    zIndex: index\n                  }}\n                >\n                  <CardComponent \n                    card={card} \n                    onClick={() => handlePlayerCardClick(card)}\n                    isPlayable={isPlayable}\n                  />\n                </motion.div>\n              );\n            })}\n          </AnimatePresence>\n        </div>\n        \n        {playablePlayerCards.length === 0 && currentPlayer === \"player\" && pendingPickUp === 0 && (\n          <p className=\"text-center text-sm text-muted-foreground mt-3\">\n            No playable cards. Draw from the deck!\n          </p>\n        )}\n      </Card>\n\n      <div className=\"flex items-center justify-center\">\n        <Button \n          variant=\"ghost\" \n          size=\"sm\" \n          onClick={resetGame}\n          data-testid=\"button-reset-game\"\n        >\n          <RotateCcw className=\"h-4 w-4 mr-2\" />\n          Reset Game\n        </Button>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":34345,"size_tokens":null},"client/src/components/games/GuessThePriceGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Input } from \"@/components/ui/input\";\nimport { \n  Clock, \n  Trophy, \n  Bot, \n  User, \n  RotateCcw, \n  Tag,\n  Sparkles,\n  Play,\n  CheckCircle2,\n  XCircle,\n  Target,\n  Star,\n  Crown,\n  ArrowRight,\n  ShoppingBag,\n  Smartphone,\n  Shirt,\n  Book,\n  UtensilsCrossed,\n  Home,\n  Package\n} from \"lucide-react\";\n\ninterface GuessThePriceGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype GamePhase = \"ready\" | \"playing\" | \"result\" | \"finished\";\ntype ProductCategory = \"electronics\" | \"fashion\" | \"books\" | \"food\" | \"household\";\n\ninterface Product {\n  id: number;\n  name: string;\n  category: ProductCategory;\n  actualPrice: number;\n  minPrice: number;\n  maxPrice: number;\n  image: string;\n  description: string;\n}\n\ninterface RoundResult {\n  product: Product;\n  guessedPrice: number;\n  actualPrice: number;\n  points: number;\n  percentageOff: number;\n}\n\nconst PRODUCTS: Product[] = [\n  {\n    id: 1,\n    name: \"iPhone 12 (UK Used)\",\n    category: \"electronics\",\n    actualPrice: 280000,\n    minPrice: 100000,\n    maxPrice: 500000,\n    image: \"https://images.unsplash.com/photo-1611472173362-3f53dbd65d80?w=400&h=400&fit=crop\",\n    description: \"128GB, Good condition\"\n  },\n  {\n    id: 2,\n    name: \"Samsung Galaxy A54\",\n    category: \"electronics\",\n    actualPrice: 195000,\n    minPrice: 100000,\n    maxPrice: 350000,\n    image: \"https://images.unsplash.com/photo-1610945415295-d9bbf067e59c?w=400&h=400&fit=crop\",\n    description: \"Brand new, 128GB\"\n  },\n  {\n    id: 3,\n    name: \"HP Laptop 15 (Refurbished)\",\n    category: \"electronics\",\n    actualPrice: 165000,\n    minPrice: 80000,\n    maxPrice: 300000,\n    image: \"https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=400&h=400&fit=crop\",\n    description: \"Core i5, 8GB RAM, 256GB SSD\"\n  },\n  {\n    id: 4,\n    name: \"JBL Bluetooth Speaker\",\n    category: \"electronics\",\n    actualPrice: 45000,\n    minPrice: 15000,\n    maxPrice: 100000,\n    image: \"https://images.unsplash.com/photo-1608043152269-423dbba4e7e1?w=400&h=400&fit=crop\",\n    description: \"Portable, Waterproof\"\n  },\n  {\n    id: 5,\n    name: \"Wireless Earbuds\",\n    category: \"electronics\",\n    actualPrice: 8500,\n    minPrice: 3000,\n    maxPrice: 25000,\n    image: \"https://images.unsplash.com/photo-1590658268037-6bf12165a8df?w=400&h=400&fit=crop\",\n    description: \"Noise cancelling, 24hr battery\"\n  },\n  {\n    id: 6,\n    name: \"Power Bank 20000mAh\",\n    category: \"electronics\",\n    actualPrice: 12000,\n    minPrice: 5000,\n    maxPrice: 30000,\n    image: \"https://images.unsplash.com/photo-1609091839311-d5365f9ff1c5?w=400&h=400&fit=crop\",\n    description: \"Fast charging, LED display\"\n  },\n  {\n    id: 7,\n    name: \"Nike Air Force 1\",\n    category: \"fashion\",\n    actualPrice: 38000,\n    minPrice: 15000,\n    maxPrice: 80000,\n    image: \"https://images.unsplash.com/photo-1595950653106-6c9ebd614d3a?w=400&h=400&fit=crop\",\n    description: \"Original, White, Size 42\"\n  },\n  {\n    id: 8,\n    name: \"Adidas Tracksuit\",\n    category: \"fashion\",\n    actualPrice: 25000,\n    minPrice: 10000,\n    maxPrice: 50000,\n    image: \"https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=400&h=400&fit=crop\",\n    description: \"Complete set, Black\"\n  },\n  {\n    id: 9,\n    name: \"Designer Wristwatch\",\n    category: \"fashion\",\n    actualPrice: 15000,\n    minPrice: 5000,\n    maxPrice: 40000,\n    image: \"https://images.unsplash.com/photo-1524592094714-0f0654e20314?w=400&h=400&fit=crop\",\n    description: \"Stainless steel, Water resistant\"\n  },\n  {\n    id: 10,\n    name: \"Campus Backpack\",\n    category: \"fashion\",\n    actualPrice: 8500,\n    minPrice: 3000,\n    maxPrice: 20000,\n    image: \"https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400&h=400&fit=crop\",\n    description: \"Laptop compartment, USB port\"\n  },\n  {\n    id: 11,\n    name: \"Native Agbada Set\",\n    category: \"fashion\",\n    actualPrice: 45000,\n    minPrice: 20000,\n    maxPrice: 100000,\n    image: \"https://images.unsplash.com/photo-1590735213920-68192a487bc2?w=400&h=400&fit=crop\",\n    description: \"Premium Atiku fabric, Custom made\"\n  },\n  {\n    id: 12,\n    name: \"Ladies Gown (Ankara)\",\n    category: \"fashion\",\n    actualPrice: 18000,\n    minPrice: 8000,\n    maxPrice: 40000,\n    image: \"https://images.unsplash.com/photo-1595777457583-95e059d581b8?w=400&h=400&fit=crop\",\n    description: \"Beautiful Ankara print\"\n  },\n  {\n    id: 13,\n    name: \"Medical Textbook Bundle\",\n    category: \"books\",\n    actualPrice: 25000,\n    minPrice: 10000,\n    maxPrice: 50000,\n    image: \"https://images.unsplash.com/photo-1456513080510-7bf3a84b82f8?w=400&h=400&fit=crop\",\n    description: \"5 essential medical books\"\n  },\n  {\n    id: 14,\n    name: \"Engineering Calculator\",\n    category: \"books\",\n    actualPrice: 15000,\n    minPrice: 5000,\n    maxPrice: 35000,\n    image: \"https://images.unsplash.com/photo-1564466809058-bf4114d55352?w=400&h=400&fit=crop\",\n    description: \"Scientific calculator, Solar powered\"\n  },\n  {\n    id: 15,\n    name: \"Notebook Bundle (10 pcs)\",\n    category: \"books\",\n    actualPrice: 3500,\n    minPrice: 1500,\n    maxPrice: 8000,\n    image: \"https://images.unsplash.com/photo-1531346878377-a5be20888e57?w=400&h=400&fit=crop\",\n    description: \"A4 size, 80 leaves each\"\n  },\n  {\n    id: 16,\n    name: \"Law Textbooks Set\",\n    category: \"books\",\n    actualPrice: 35000,\n    minPrice: 15000,\n    maxPrice: 60000,\n    image: \"https://images.unsplash.com/photo-1589829085413-56de8ae18c73?w=400&h=400&fit=crop\",\n    description: \"Nigerian Constitution + 4 core texts\"\n  },\n  {\n    id: 17,\n    name: \"Bag of Rice (50kg)\",\n    category: \"food\",\n    actualPrice: 75000,\n    minPrice: 40000,\n    maxPrice: 120000,\n    image: \"https://images.unsplash.com/photo-1586201375761-83865001e31c?w=400&h=400&fit=crop\",\n    description: \"Premium Nigerian rice\"\n  },\n  {\n    id: 18,\n    name: \"Carton of Indomie (40 packs)\",\n    category: \"food\",\n    actualPrice: 12000,\n    minPrice: 6000,\n    maxPrice: 20000,\n    image: \"https://images.unsplash.com/photo-1612929633738-8fe44f7ec841?w=400&h=400&fit=crop\",\n    description: \"Chicken flavour, Student favourite\"\n  },\n  {\n    id: 19,\n    name: \"5L Groundnut Oil\",\n    category: \"food\",\n    actualPrice: 8500,\n    minPrice: 4000,\n    maxPrice: 15000,\n    image: \"https://images.unsplash.com/photo-1474979266404-7eaacbcd87c5?w=400&h=400&fit=crop\",\n    description: \"Pure vegetable oil\"\n  },\n  {\n    id: 20,\n    name: \"Garri (Paint Bucket)\",\n    category: \"food\",\n    actualPrice: 4500,\n    minPrice: 2000,\n    maxPrice: 10000,\n    image: \"https://images.unsplash.com/photo-1509440159596-0249088772ff?w=400&h=400&fit=crop\",\n    description: \"White garri, 10kg\"\n  },\n  {\n    id: 21,\n    name: \"Electric Kettle\",\n    category: \"household\",\n    actualPrice: 6500,\n    minPrice: 3000,\n    maxPrice: 15000,\n    image: \"https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=400&h=400&fit=crop\",\n    description: \"1.8L, Stainless steel\"\n  },\n  {\n    id: 22,\n    name: \"Hot Plate (Electric Stove)\",\n    category: \"household\",\n    actualPrice: 8000,\n    minPrice: 4000,\n    maxPrice: 18000,\n    image: \"https://images.unsplash.com/photo-1585771724684-38269d6639fd?w=400&h=400&fit=crop\",\n    description: \"Single burner, 1000W\"\n  },\n  {\n    id: 23,\n    name: \"Standing Fan\",\n    category: \"household\",\n    actualPrice: 22000,\n    minPrice: 10000,\n    maxPrice: 45000,\n    image: \"https://images.unsplash.com/photo-1587212805787-e17e9f0c8980?w=400&h=400&fit=crop\",\n    description: \"18 inches, 3 speed settings\"\n  },\n  {\n    id: 24,\n    name: \"Iron Pressing\",\n    category: \"household\",\n    actualPrice: 7500,\n    minPrice: 3000,\n    maxPrice: 15000,\n    image: \"https://images.unsplash.com/photo-1585771724684-38269d6639fd?w=400&h=400&fit=crop\",\n    description: \"Steam iron, Non-stick sole\"\n  },\n  {\n    id: 25,\n    name: \"Rechargeable Lamp\",\n    category: \"household\",\n    actualPrice: 5500,\n    minPrice: 2500,\n    maxPrice: 12000,\n    image: \"https://images.unsplash.com/photo-1507473885765-e6ed057f782c?w=400&h=400&fit=crop\",\n    description: \"LED, 8 hours battery life\"\n  },\n];\n\nconst TOTAL_ROUNDS = 5;\nconst TIME_PER_ROUND = 15;\n\nconst getCategoryIcon = (category: ProductCategory) => {\n  switch (category) {\n    case \"electronics\": return Smartphone;\n    case \"fashion\": return Shirt;\n    case \"books\": return Book;\n    case \"food\": return UtensilsCrossed;\n    case \"household\": return Home;\n  }\n};\n\nconst getCategoryColor = (category: ProductCategory) => {\n  switch (category) {\n    case \"electronics\": return \"bg-blue-500/20 text-blue-600 dark:text-blue-400\";\n    case \"fashion\": return \"bg-pink-500/20 text-pink-600 dark:text-pink-400\";\n    case \"books\": return \"bg-amber-500/20 text-amber-600 dark:text-amber-400\";\n    case \"food\": return \"bg-green-500/20 text-green-600 dark:text-green-400\";\n    case \"household\": return \"bg-purple-500/20 text-purple-600 dark:text-purple-400\";\n  }\n};\n\nconst getPointsForAccuracy = (guessedPrice: number, actualPrice: number): { points: number; percentageOff: number } => {\n  const percentageOff = Math.abs((guessedPrice - actualPrice) / actualPrice) * 100;\n  \n  if (percentageOff === 0) return { points: 100, percentageOff: 0 };\n  if (percentageOff <= 10) return { points: 80, percentageOff };\n  if (percentageOff <= 25) return { points: 50, percentageOff };\n  if (percentageOff <= 50) return { points: 20, percentageOff };\n  return { points: 0, percentageOff };\n};\n\nconst getPointsBadgeColor = (points: number) => {\n  if (points === 100) return \"bg-green-500 text-white\";\n  if (points >= 80) return \"bg-emerald-500/20 text-emerald-600 dark:text-emerald-400\";\n  if (points >= 50) return \"bg-amber-500/20 text-amber-600 dark:text-amber-400\";\n  if (points >= 20) return \"bg-orange-500/20 text-orange-600 dark:text-orange-400\";\n  return \"bg-red-500/20 text-red-600 dark:text-red-400\";\n};\n\nconst shuffleArray = <T,>(array: T[]): T[] => {\n  const shuffled = [...array];\n  for (let i = shuffled.length - 1; i > 0; i--) {\n    const j = Math.floor(Math.random() * (i + 1));\n    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];\n  }\n  return shuffled;\n};\n\nconst formatPrice = (price: number): string => {\n  return new Intl.NumberFormat('en-NG').format(price);\n};\n\nexport default function GuessThePriceGame({ stake, onGameEnd, isPractice }: GuessThePriceGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"ready\");\n  const [currentRound, setCurrentRound] = useState(1);\n  const [totalScore, setTotalScore] = useState(0);\n  const [aiScore, setAiScore] = useState(0);\n  const [timeLeft, setTimeLeft] = useState(TIME_PER_ROUND);\n  const [currentProduct, setCurrentProduct] = useState<Product | null>(null);\n  const [guessedPrice, setGuessedPrice] = useState<number>(0);\n  const [roundResults, setRoundResults] = useState<RoundResult[]>([]);\n  const [usedProductIds, setUsedProductIds] = useState<Set<number>>(new Set());\n  const [showResult, setShowResult] = useState(false);\n  const [lastRoundResult, setLastRoundResult] = useState<RoundResult | null>(null);\n  const [imageLoaded, setImageLoaded] = useState(false);\n\n  const timerRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (timerRef.current) {\n        clearTimeout(timerRef.current);\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (gamePhase === \"playing\" && timeLeft > 0) {\n      timerRef.current = setTimeout(() => {\n        setTimeLeft(prev => prev - 1);\n      }, 1000);\n    } else if (gamePhase === \"playing\" && timeLeft === 0) {\n      handleSubmitGuess();\n    }\n    \n    return () => {\n      if (timerRef.current) {\n        clearTimeout(timerRef.current);\n      }\n    };\n  }, [gamePhase, timeLeft]);\n\n  const getRandomProduct = useCallback((): Product => {\n    const available = PRODUCTS.filter(p => !usedProductIds.has(p.id));\n    if (available.length === 0) {\n      const shuffled = shuffleArray(PRODUCTS);\n      return shuffled[0];\n    }\n    const shuffled = shuffleArray(available);\n    return shuffled[0];\n  }, [usedProductIds]);\n\n  const simulateAIGuess = (product: Product): number => {\n    const variance = 0.15 + Math.random() * 0.25;\n    const direction = Math.random() > 0.5 ? 1 : -1;\n    const aiGuess = product.actualPrice * (1 + direction * variance * Math.random());\n    return Math.round(aiGuess / 100) * 100;\n  };\n\n  const startGame = useCallback(() => {\n    const product = getRandomProduct();\n    setCurrentProduct(product);\n    setGuessedPrice(Math.round((product.minPrice + product.maxPrice) / 2));\n    setUsedProductIds(prev => new Set(Array.from(prev).concat(product.id)));\n    setGamePhase(\"playing\");\n    setTimeLeft(TIME_PER_ROUND);\n    setImageLoaded(false);\n    setCurrentRound(1);\n    setTotalScore(0);\n    setAiScore(0);\n    setRoundResults([]);\n  }, [getRandomProduct]);\n\n  const handleSubmitGuess = useCallback(() => {\n    if (!currentProduct) return;\n\n    const { points, percentageOff } = getPointsForAccuracy(guessedPrice, currentProduct.actualPrice);\n    \n    const aiGuess = simulateAIGuess(currentProduct);\n    const { points: aiPoints } = getPointsForAccuracy(aiGuess, currentProduct.actualPrice);\n    \n    const result: RoundResult = {\n      product: currentProduct,\n      guessedPrice,\n      actualPrice: currentProduct.actualPrice,\n      points,\n      percentageOff,\n    };\n\n    setLastRoundResult(result);\n    setRoundResults(prev => [...prev, result]);\n    setTotalScore(prev => prev + points);\n    setAiScore(prev => prev + aiPoints);\n    setShowResult(true);\n    setGamePhase(\"result\");\n  }, [currentProduct, guessedPrice]);\n\n  const nextRound = useCallback(() => {\n    if (currentRound >= TOTAL_ROUNDS) {\n      setGamePhase(\"finished\");\n      const won = totalScore > aiScore;\n      onGameEnd(won, totalScore);\n    } else {\n      const product = getRandomProduct();\n      setCurrentProduct(product);\n      setGuessedPrice(Math.round((product.minPrice + product.maxPrice) / 2));\n      setUsedProductIds(prev => new Set(Array.from(prev).concat(product.id)));\n      setCurrentRound(prev => prev + 1);\n      setTimeLeft(TIME_PER_ROUND);\n      setShowResult(false);\n      setLastRoundResult(null);\n      setImageLoaded(false);\n      setGamePhase(\"playing\");\n    }\n  }, [currentRound, getRandomProduct, totalScore, aiScore, onGameEnd]);\n\n  const resetGame = useCallback(() => {\n    setGamePhase(\"ready\");\n    setCurrentRound(1);\n    setTotalScore(0);\n    setAiScore(0);\n    setTimeLeft(TIME_PER_ROUND);\n    setCurrentProduct(null);\n    setGuessedPrice(0);\n    setRoundResults([]);\n    setUsedProductIds(new Set());\n    setShowResult(false);\n    setLastRoundResult(null);\n    setImageLoaded(false);\n  }, []);\n\n  const handleSliderChange = (value: number[]) => {\n    setGuessedPrice(value[0]);\n  };\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const value = parseInt(e.target.value.replace(/,/g, ''), 10);\n    if (!isNaN(value) && currentProduct) {\n      const clampedValue = Math.max(currentProduct.minPrice, Math.min(currentProduct.maxPrice, value));\n      setGuessedPrice(clampedValue);\n    }\n  };\n\n  const progressPercentage = (currentRound / TOTAL_ROUNDS) * 100;\n  const timerPercentage = (timeLeft / TIME_PER_ROUND) * 100;\n\n  if (gamePhase === \"ready\") {\n    return (\n      <Card className=\"max-w-2xl mx-auto\">\n        <CardHeader className=\"text-center\">\n          <motion.div\n            initial={{ scale: 0 }}\n            animate={{ scale: 1 }}\n            transition={{ type: \"spring\", stiffness: 200 }}\n          >\n            <Tag className=\"h-16 w-16 mx-auto text-amber-500 mb-4\" />\n          </motion.div>\n          <CardTitle className=\"text-2xl\">Guess the Price</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"text-center space-y-2\">\n            <p className=\"text-muted-foreground\">\n              Can you guess the market price of campus products? The closer your guess, the more points you earn!\n            </p>\n            <p className=\"text-sm text-muted-foreground\">\n              5 rounds, 15 seconds each. Beat the AI to win!\n            </p>\n          </div>\n          \n          <div className=\"grid grid-cols-2 gap-3\">\n            <div className=\"text-center p-3 rounded-lg bg-green-500/10\">\n              <div className=\"text-lg font-bold text-green-600 dark:text-green-400\">100 pts</div>\n              <div className=\"text-xs text-muted-foreground\">Exact match</div>\n            </div>\n            <div className=\"text-center p-3 rounded-lg bg-emerald-500/10\">\n              <div className=\"text-lg font-bold text-emerald-600 dark:text-emerald-400\">80 pts</div>\n              <div className=\"text-xs text-muted-foreground\">Within 10%</div>\n            </div>\n            <div className=\"text-center p-3 rounded-lg bg-amber-500/10\">\n              <div className=\"text-lg font-bold text-amber-600 dark:text-amber-400\">50 pts</div>\n              <div className=\"text-xs text-muted-foreground\">Within 25%</div>\n            </div>\n            <div className=\"text-center p-3 rounded-lg bg-orange-500/10\">\n              <div className=\"text-lg font-bold text-orange-600 dark:text-orange-400\">20 pts</div>\n              <div className=\"text-xs text-muted-foreground\">Within 50%</div>\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-center gap-2 flex-wrap\">\n            {([\"electronics\", \"fashion\", \"books\", \"food\", \"household\"] as ProductCategory[]).map(category => {\n              const Icon = getCategoryIcon(category);\n              return (\n                <Badge key={category} className={getCategoryColor(category)} >\n                  <Icon className=\"h-3 w-3 mr-1\" />\n                  {category.charAt(0).toUpperCase() + category.slice(1)}\n                </Badge>\n              );\n            })}\n          </div>\n          \n          {!isPractice && stake > 0 && (\n            <div className=\"text-center p-3 bg-primary/10 rounded-lg\">\n              <p className=\"text-sm font-medium\">Stake: {formatPrice(stake)} NGN</p>\n              <p className=\"text-xs text-muted-foreground\">Win to double your stake!</p>\n            </div>\n          )}\n          \n          <Button \n            onClick={startGame} \n            size=\"lg\" \n            className=\"w-full\"\n            data-testid=\"button-start-game\"\n          >\n            <Play className=\"h-5 w-5 mr-2\" />\n            Start Game\n          </Button>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (gamePhase === \"finished\") {\n    const won = totalScore > aiScore;\n    const tied = totalScore === aiScore;\n    \n    return (\n      <Card className=\"max-w-2xl mx-auto\">\n        <CardHeader className=\"text-center\">\n          <motion.div\n            initial={{ scale: 0, rotate: -180 }}\n            animate={{ scale: 1, rotate: 0 }}\n            transition={{ type: \"spring\", stiffness: 200 }}\n          >\n            {won ? (\n              <Trophy className=\"h-20 w-20 mx-auto text-yellow-500 mb-4\" />\n            ) : tied ? (\n              <Target className=\"h-20 w-20 mx-auto text-blue-500 mb-4\" />\n            ) : (\n              <Bot className=\"h-20 w-20 mx-auto text-red-500 mb-4\" />\n            )}\n          </motion.div>\n          <CardTitle className=\"text-2xl\">\n            {won ? \"You Won!\" : tied ? \"It's a Tie!\" : \"AI Wins!\"}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <motion.div \n              className={`p-4 rounded-lg text-center ${won ? 'bg-green-500/10 ring-2 ring-green-500' : 'bg-muted/50'}`}\n              initial={{ x: -50, opacity: 0 }}\n              animate={{ x: 0, opacity: 1 }}\n              transition={{ delay: 0.2 }}\n            >\n              <User className=\"h-8 w-8 mx-auto mb-2 text-blue-500\" />\n              <div className=\"text-sm text-muted-foreground\">Your Score</div>\n              <div className=\"text-2xl font-bold\">{totalScore}</div>\n            </motion.div>\n            <motion.div \n              className={`p-4 rounded-lg text-center ${!won && !tied ? 'bg-green-500/10 ring-2 ring-green-500' : 'bg-muted/50'}`}\n              initial={{ x: 50, opacity: 0 }}\n              animate={{ x: 0, opacity: 1 }}\n              transition={{ delay: 0.2 }}\n            >\n              <Bot className=\"h-8 w-8 mx-auto mb-2 text-purple-500\" />\n              <div className=\"text-sm text-muted-foreground\">AI Score</div>\n              <div className=\"text-2xl font-bold\">{aiScore}</div>\n            </motion.div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <h4 className=\"font-medium text-sm\">Round Results</h4>\n            <div className=\"space-y-2 max-h-60 overflow-y-auto\">\n              {roundResults.map((result, index) => (\n                <motion.div\n                  key={index}\n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ delay: 0.3 + index * 0.1 }}\n                  className=\"flex items-center justify-between p-3 bg-muted/30 rounded-lg gap-2\"\n                >\n                  <div className=\"flex items-center gap-2 min-w-0 flex-1\">\n                    <span className=\"text-xs text-muted-foreground shrink-0\">R{index + 1}</span>\n                    <span className=\"text-sm truncate\">{result.product.name}</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 shrink-0\">\n                    <div className=\"text-xs text-right\">\n                      <div className=\"text-muted-foreground\">Guess: {formatPrice(result.guessedPrice)}</div>\n                      <div className=\"font-medium\">Actual: {formatPrice(result.actualPrice)}</div>\n                    </div>\n                    <Badge className={getPointsBadgeColor(result.points)} >\n                      +{result.points}\n                    </Badge>\n                  </div>\n                </motion.div>\n              ))}\n            </div>\n          </div>\n\n          {!isPractice && (\n            <div className=\"text-center p-3 rounded-lg bg-muted/50\">\n              {won ? (\n                <p className=\"text-green-600 dark:text-green-400 font-medium\">\n                  You won {formatPrice(stake * 1.9)} NGN!\n                </p>\n              ) : (\n                <p className=\"text-muted-foreground\">\n                  You lost {formatPrice(stake)} NGN. Better luck next time!\n                </p>\n              )}\n            </div>\n          )}\n\n          <div className=\"flex gap-3\">\n            <Button \n              onClick={resetGame} \n              variant=\"outline\" \n              className=\"flex-1\"\n              data-testid=\"button-play-again\"\n            >\n              <RotateCcw className=\"h-4 w-4 mr-2\" />\n              Play Again\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"max-w-2xl mx-auto\">\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n          <div className=\"flex items-center gap-2\">\n            <Tag className=\"h-5 w-5 text-amber-500\" />\n            <CardTitle className=\"text-lg\">Guess the Price</CardTitle>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <Badge variant=\"outline\">\n              Round {currentRound}/{TOTAL_ROUNDS}\n            </Badge>\n            <Badge variant=\"secondary\">\n              Score: {totalScore}\n            </Badge>\n          </div>\n        </div>\n        <Progress value={progressPercentage} className=\"h-1 mt-2\" />\n      </CardHeader>\n      \n      <CardContent className=\"space-y-4\">\n        <AnimatePresence mode=\"wait\">\n          {gamePhase === \"result\" && lastRoundResult ? (\n            <motion.div\n              key=\"result\"\n              initial={{ opacity: 0, scale: 0.9 }}\n              animate={{ opacity: 1, scale: 1 }}\n              exit={{ opacity: 0, scale: 0.9 }}\n              className=\"space-y-4\"\n            >\n              <div className=\"text-center p-4 rounded-lg bg-muted/50\">\n                <div className=\"flex items-center justify-center gap-2 mb-2\">\n                  {lastRoundResult.points > 0 ? (\n                    <CheckCircle2 className=\"h-8 w-8 text-green-500\" />\n                  ) : (\n                    <XCircle className=\"h-8 w-8 text-red-500\" />\n                  )}\n                  <Badge className={getPointsBadgeColor(lastRoundResult.points)} >\n                    +{lastRoundResult.points} points\n                  </Badge>\n                </div>\n                \n                <h3 className=\"font-semibold text-lg mb-1\">{lastRoundResult.product.name}</h3>\n                \n                <div className=\"grid grid-cols-2 gap-4 mt-4\">\n                  <div className=\"text-center\">\n                    <div className=\"text-xs text-muted-foreground\">Your Guess</div>\n                    <div className=\"text-lg font-semibold\">{formatPrice(lastRoundResult.guessedPrice)} NGN</div>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"text-xs text-muted-foreground\">Actual Price</div>\n                    <div className=\"text-lg font-semibold text-green-600 dark:text-green-400\">\n                      {formatPrice(lastRoundResult.actualPrice)} NGN\n                    </div>\n                  </div>\n                </div>\n                \n                {lastRoundResult.percentageOff > 0 && (\n                  <p className=\"text-sm text-muted-foreground mt-2\">\n                    You were {lastRoundResult.percentageOff.toFixed(1)}% off\n                  </p>\n                )}\n              </div>\n              \n              <Button \n                onClick={nextRound} \n                className=\"w-full\"\n                data-testid=\"button-next-round\"\n              >\n                {currentRound >= TOTAL_ROUNDS ? (\n                  <>See Results</>\n                ) : (\n                  <>\n                    Next Product\n                    <ArrowRight className=\"h-4 w-4 ml-2\" />\n                  </>\n                )}\n              </Button>\n            </motion.div>\n          ) : currentProduct && (\n            <motion.div\n              key=\"playing\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, y: -20 }}\n              className=\"space-y-4\"\n            >\n              <div className={`flex items-center justify-between p-2 rounded-lg ${timerPercentage < 30 ? 'bg-red-500/10' : 'bg-muted/50'}`}>\n                <div className=\"flex items-center gap-2\">\n                  <Clock className={`h-4 w-4 ${timerPercentage < 30 ? 'text-red-500' : 'text-muted-foreground'}`} />\n                  <span className={`font-mono font-bold ${timerPercentage < 30 ? 'text-red-500' : ''}`}>\n                    {timeLeft}s\n                  </span>\n                </div>\n                <Progress \n                  value={timerPercentage} \n                  className={`w-24 h-2 ${timerPercentage < 30 ? '[&>div]:bg-red-500' : ''}`} \n                />\n              </div>\n\n              <div className=\"relative rounded-lg overflow-hidden bg-muted/30\">\n                <div className=\"aspect-square max-h-48 mx-auto relative\">\n                  {!imageLoaded && (\n                    <div className=\"absolute inset-0 flex items-center justify-center bg-muted/50\">\n                      <Package className=\"h-12 w-12 text-muted-foreground animate-pulse\" />\n                    </div>\n                  )}\n                  <img\n                    src={currentProduct.image}\n                    alt={currentProduct.name}\n                    className={`w-full h-full object-cover transition-opacity ${imageLoaded ? 'opacity-100' : 'opacity-0'}`}\n                    onLoad={() => setImageLoaded(true)}\n                    onError={() => setImageLoaded(true)}\n                  />\n                </div>\n              </div>\n\n              <div className=\"text-center space-y-2\">\n                <div className=\"flex items-center justify-center gap-2 flex-wrap\">\n                  <Badge className={getCategoryColor(currentProduct.category)} >\n                    {(() => {\n                      const Icon = getCategoryIcon(currentProduct.category);\n                      return <Icon className=\"h-3 w-3 mr-1\" />;\n                    })()}\n                    {currentProduct.category.charAt(0).toUpperCase() + currentProduct.category.slice(1)}\n                  </Badge>\n                </div>\n                <h3 className=\"text-xl font-bold\">{currentProduct.name}</h3>\n                <p className=\"text-sm text-muted-foreground\">{currentProduct.description}</p>\n              </div>\n\n              <div className=\"space-y-4 p-4 bg-muted/30 rounded-lg\">\n                <div className=\"text-center\">\n                  <div className=\"text-xs text-muted-foreground mb-1\">Your Guess</div>\n                  <div className=\"text-3xl font-bold text-primary\">\n                    {formatPrice(guessedPrice)} NGN\n                  </div>\n                </div>\n\n                <Slider\n                  value={[guessedPrice]}\n                  min={currentProduct.minPrice}\n                  max={currentProduct.maxPrice}\n                  step={Math.round((currentProduct.maxPrice - currentProduct.minPrice) / 100)}\n                  onValueChange={handleSliderChange}\n                  className=\"w-full\"\n                  data-testid=\"slider-price-guess\"\n                />\n\n                <div className=\"flex justify-between text-xs text-muted-foreground\">\n                  <span>{formatPrice(currentProduct.minPrice)} NGN</span>\n                  <span>{formatPrice(currentProduct.maxPrice)} NGN</span>\n                </div>\n\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"text-sm text-muted-foreground\">Or type:</span>\n                  <Input\n                    type=\"text\"\n                    value={formatPrice(guessedPrice)}\n                    onChange={handleInputChange}\n                    className=\"flex-1 text-center font-mono\"\n                    data-testid=\"input-price-guess\"\n                  />\n                  <span className=\"text-sm text-muted-foreground\">NGN</span>\n                </div>\n              </div>\n\n              <Button \n                onClick={handleSubmitGuess}\n                className=\"w-full\"\n                size=\"lg\"\n                data-testid=\"button-submit-guess\"\n              >\n                <Target className=\"h-5 w-5 mr-2\" />\n                Lock In Guess\n              </Button>\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":31133,"size_tokens":null},"client/src/components/games/CampusBingoGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { \n  Clock, \n  Trophy, \n  Bot, \n  User, \n  RotateCcw, \n  Grid3X3,\n  Sparkles,\n  Play,\n  Star,\n  Crown,\n  Target,\n  Volume2,\n  CheckCircle2,\n  Megaphone,\n  GraduationCap,\n  Zap,\n  CornerDownRight\n} from \"lucide-react\";\n\ninterface CampusBingoGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype GamePhase = \"ready\" | \"playing\" | \"claiming\" | \"finished\";\n\ntype WinPattern = \"line\" | \"four_corners\" | \"full_house\" | null;\n\ninterface BingoCell {\n  phrase: string;\n  marked: boolean;\n  isFreeSpace: boolean;\n}\n\ntype BingoCard = BingoCell[][];\n\ninterface PatternInfo {\n  name: string;\n  icon: React.ComponentType<{ className?: string }>;\n  multiplier: number;\n  description: string;\n}\n\nconst PATTERNS: Record<string, PatternInfo> = {\n  line: { name: \"Line\", icon: Target, multiplier: 0.20, description: \"Any horizontal, vertical, or diagonal line\" },\n  four_corners: { name: \"Four Corners\", icon: CornerDownRight, multiplier: 0.30, description: \"All four corner cells marked\" },\n  full_house: { name: \"Full House\", icon: Crown, multiplier: 0.50, description: \"All cells marked\" },\n};\n\nconst CAMPUS_PHRASES: string[] = [\n  \"Lecturer no come\",\n  \"NEPA take light\",\n  \"Sign out\",\n  \"No water in hostel\",\n  \"Carry over\",\n  \"Project defense\",\n  \"Clear course\",\n  \"Sorority party\",\n  \"Night class\",\n  \"No data on phone\",\n  \"Broke before month end\",\n  \"SUG election\",\n  \"School fees deadline\",\n  \"Crush sat beside me\",\n  \"Extra credit assignment\",\n  \"Last minute studying\",\n  \"Cafe food spoil\",\n  \"Roommate wahala\",\n  \"Generator don spoil\",\n  \"TDB on result\",\n  \"Surprise test\",\n  \"Extension on deadline\",\n  \"Departmental party\",\n  \"Hostel allocation stress\",\n  \"Course registration closed\",\n  \"Library full\",\n  \"Porter catch you\",\n  \"VC speech too long\",\n  \"Convocation postponed\",\n  \"Textbook too expensive\",\n  \"Group project drama\",\n  \"Lab practical cancelled\",\n  \"Exam hall too hot\",\n  \"Result delayed\",\n  \"Power bank die\",\n  \"Wifi down again\",\n  \"Class cancelled last minute\",\n  \"Sign my clearance form\",\n  \"Missed attendance\",\n  \"Course clash\",\n  \"Retake semester\",\n  \"Dean's list achievement\",\n  \"All-night reading\",\n  \"Transport fare increase\",\n  \"Handout not ready\",\n  \"Lecturer ask question\",\n  \"Phone confiscated\",\n  \"Hostel inspection\",\n  \"ID card expired\",\n  \"Burst pipe in hostel\",\n];\n\nconst CALL_INTERVAL = 4000;\n\nconst CAMPUS_ANNOUNCEMENTS = [\n  \"The Registrar announces:\",\n  \"Hostel living experience:\",\n  \"Campus survival moment:\",\n  \"Academic wahala:\",\n  \"Student life reality:\",\n  \"Nigerian university vibes:\",\n  \"Campus chronicle:\",\n  \"Hall of residence news:\",\n  \"Faculty announcement:\",\n  \"Student union broadcast:\",\n];\n\nconst shuffleArray = <T,>(array: T[]): T[] => {\n  const shuffled = [...array];\n  for (let i = shuffled.length - 1; i > 0; i--) {\n    const j = Math.floor(Math.random() * (i + 1));\n    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];\n  }\n  return shuffled;\n};\n\nconst generateBingoCard = (): BingoCard => {\n  const shuffledPhrases = shuffleArray([...CAMPUS_PHRASES]);\n  const card: BingoCard = [];\n  let phraseIndex = 0;\n  \n  for (let row = 0; row < 5; row++) {\n    const cardRow: BingoCell[] = [];\n    for (let col = 0; col < 5; col++) {\n      if (row === 2 && col === 2) {\n        cardRow.push({\n          phrase: \"FREE SPACE\",\n          marked: true,\n          isFreeSpace: true,\n        });\n      } else {\n        cardRow.push({\n          phrase: shuffledPhrases[phraseIndex++],\n          marked: false,\n          isFreeSpace: false,\n        });\n      }\n    }\n    card.push(cardRow);\n  }\n  \n  return card;\n};\n\nconst generateCallableList = (): string[] => {\n  return shuffleArray([...CAMPUS_PHRASES]);\n};\n\nconst checkLine = (card: BingoCard): boolean => {\n  for (let row = 0; row < 5; row++) {\n    if (card[row].every(cell => cell.marked)) return true;\n  }\n  \n  for (let col = 0; col < 5; col++) {\n    if (card.every(row => row[col].marked)) return true;\n  }\n  \n  if (card[0][0].marked && card[1][1].marked && card[2][2].marked && card[3][3].marked && card[4][4].marked) {\n    return true;\n  }\n  if (card[0][4].marked && card[1][3].marked && card[2][2].marked && card[3][1].marked && card[4][0].marked) {\n    return true;\n  }\n  \n  return false;\n};\n\nconst checkFourCorners = (card: BingoCard): boolean => {\n  return card[0][0].marked && card[0][4].marked && card[4][0].marked && card[4][4].marked;\n};\n\nconst checkFullHouse = (card: BingoCard): boolean => {\n  return card.every(row => row.every(cell => cell.marked));\n};\n\nconst detectWinPattern = (card: BingoCard): WinPattern => {\n  if (checkFullHouse(card)) return \"full_house\";\n  if (checkFourCorners(card)) return \"four_corners\";\n  if (checkLine(card)) return \"line\";\n  return null;\n};\n\nconst calculatePoints = (pattern: WinPattern, stake: number, isPractice: boolean): number => {\n  if (!pattern) return 0;\n  if (isPractice) {\n    return Math.round(PATTERNS[pattern].multiplier * 100);\n  }\n  return Math.round(stake * PATTERNS[pattern].multiplier);\n};\n\nconst getPatternColor = (pattern: WinPattern): string => {\n  switch (pattern) {\n    case \"line\": return \"bg-blue-500/20 text-blue-600 dark:text-blue-400\";\n    case \"four_corners\": return \"bg-amber-500/20 text-amber-600 dark:text-amber-400\";\n    case \"full_house\": return \"bg-green-500/20 text-green-600 dark:text-green-400\";\n    default: return \"bg-muted\";\n  }\n};\n\nexport default function CampusBingoGame({ stake, onGameEnd, isPractice }: CampusBingoGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"ready\");\n  const [playerCard, setPlayerCard] = useState<BingoCard>([]);\n  const [aiCard, setAiCard] = useState<BingoCard>([]);\n  const [calledPhrases, setCalledPhrases] = useState<string[]>([]);\n  const [currentPhrase, setCurrentPhrase] = useState<string | null>(null);\n  const [callableList, setCallableList] = useState<string[]>([]);\n  const [nextCallIn, setNextCallIn] = useState(4);\n  const [playerScore, setPlayerScore] = useState(0);\n  const [aiScore, setAiScore] = useState(0);\n  const [playerWinPattern, setPlayerWinPattern] = useState<WinPattern>(null);\n  const [aiWinPattern, setAiWinPattern] = useState<WinPattern>(null);\n  const [winner, setWinner] = useState<\"player\" | \"ai\" | null>(null);\n  const [announcement, setAnnouncement] = useState(\"\");\n  const [isAnimating, setIsAnimating] = useState(false);\n  const [missedPhrases, setMissedPhrases] = useState<string[]>([]);\n\n  const callIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  const countdownRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (callIntervalRef.current) clearInterval(callIntervalRef.current);\n      if (countdownRef.current) clearInterval(countdownRef.current);\n    };\n  }, []);\n\n  const startGame = useCallback(() => {\n    const newPlayerCard = generateBingoCard();\n    const newAiCard = generateBingoCard();\n    const phrases = generateCallableList();\n    \n    setPlayerCard(newPlayerCard);\n    setAiCard(newAiCard);\n    setCallableList(phrases);\n    setCalledPhrases([]);\n    setCurrentPhrase(null);\n    setPlayerScore(0);\n    setAiScore(0);\n    setPlayerWinPattern(null);\n    setAiWinPattern(null);\n    setWinner(null);\n    setNextCallIn(4);\n    setMissedPhrases([]);\n    setGamePhase(\"playing\");\n    setAnnouncement(\"Get ready! First phrase coming...\");\n  }, []);\n\n  useEffect(() => {\n    if (gamePhase !== \"playing\" || winner) return;\n\n    countdownRef.current = setInterval(() => {\n      setNextCallIn(prev => {\n        if (prev <= 1) {\n          return 4;\n        }\n        return prev - 1;\n      });\n    }, 1000);\n\n    return () => {\n      if (countdownRef.current) clearInterval(countdownRef.current);\n    };\n  }, [gamePhase, winner]);\n\n  useEffect(() => {\n    if (gamePhase !== \"playing\" || winner) return;\n\n    callIntervalRef.current = setInterval(() => {\n      setCallableList(prev => {\n        if (prev.length === 0) return prev;\n        \n        const [nextPhrase, ...rest] = prev;\n        \n        setCurrentPhrase(nextPhrase);\n        setCalledPhrases(called => [...called, nextPhrase]);\n        setIsAnimating(true);\n        \n        const randomAnnouncement = CAMPUS_ANNOUNCEMENTS[Math.floor(Math.random() * CAMPUS_ANNOUNCEMENTS.length)];\n        setAnnouncement(`${randomAnnouncement} \"${nextPhrase}\"`);\n        \n        setTimeout(() => setIsAnimating(false), 500);\n        \n        setAiCard(prevCard => {\n          const newCard = prevCard.map(row => \n            row.map(cell => {\n              if (cell.phrase === nextPhrase && !cell.marked) {\n                return { ...cell, marked: true };\n              }\n              return cell;\n            })\n          );\n          \n          const aiPattern = detectWinPattern(newCard);\n          if (aiPattern && !aiWinPattern) {\n            setAiWinPattern(aiPattern);\n            setAiScore(calculatePoints(aiPattern, stake, isPractice));\n          }\n          \n          return newCard;\n        });\n        \n        return rest;\n      });\n    }, CALL_INTERVAL);\n\n    return () => {\n      if (callIntervalRef.current) clearInterval(callIntervalRef.current);\n    };\n  }, [gamePhase, winner, aiWinPattern, stake, isPractice]);\n\n  const markPhrase = useCallback((row: number, col: number) => {\n    if (gamePhase !== \"playing\" || winner) return;\n    \n    const cell = playerCard[row][col];\n    if (cell.isFreeSpace || cell.marked) return;\n    \n    if (!calledPhrases.includes(cell.phrase)) {\n      setAnnouncement(`\"${cell.phrase}\" hasn't been called yet!`);\n      return;\n    }\n    \n    setPlayerCard(prevCard => {\n      const newCard = prevCard.map((r, ri) => \n        r.map((c, ci) => {\n          if (ri === row && ci === col) {\n            return { ...c, marked: true };\n          }\n          return c;\n        })\n      );\n      \n      const pattern = detectWinPattern(newCard);\n      if (pattern) {\n        setPlayerWinPattern(pattern);\n        setPlayerScore(calculatePoints(pattern, stake, isPractice));\n      }\n      \n      return newCard;\n    });\n  }, [gamePhase, winner, playerCard, calledPhrases, stake, isPractice]);\n\n  const claimBingo = useCallback(() => {\n    if (!playerWinPattern) {\n      setAnnouncement(\"You don't have a winning pattern yet!\");\n      return;\n    }\n    \n    setGamePhase(\"claiming\");\n    \n    if (callIntervalRef.current) clearInterval(callIntervalRef.current);\n    if (countdownRef.current) clearInterval(countdownRef.current);\n    \n    const playerPoints = calculatePoints(playerWinPattern, stake, isPractice);\n    const aiPoints = aiWinPattern ? calculatePoints(aiWinPattern, stake, isPractice) : 0;\n    \n    if (playerPoints >= aiPoints) {\n      setWinner(\"player\");\n      setAnnouncement(`BINGO! You won with ${PATTERNS[playerWinPattern].name}!`);\n    } else {\n      setWinner(\"ai\");\n      setAnnouncement(`AI already had ${PATTERNS[aiWinPattern!].name}! You still get points though.`);\n    }\n    \n    setTimeout(() => {\n      setGamePhase(\"finished\");\n      const won = playerPoints >= aiPoints;\n      onGameEnd(won, playerPoints);\n    }, 2000);\n  }, [playerWinPattern, aiWinPattern, stake, isPractice, onGameEnd]);\n\n  useEffect(() => {\n    if (aiWinPattern && !playerWinPattern && gamePhase === \"playing\") {\n      setTimeout(() => {\n        if (callIntervalRef.current) clearInterval(callIntervalRef.current);\n        if (countdownRef.current) clearInterval(countdownRef.current);\n        \n        setWinner(\"ai\");\n        setAnnouncement(`AI got ${PATTERNS[aiWinPattern].name}! Better luck next time!`);\n        setGamePhase(\"finished\");\n        onGameEnd(false, playerScore);\n      }, 1500);\n    }\n  }, [aiWinPattern, playerWinPattern, gamePhase, onGameEnd, playerScore]);\n\n  useEffect(() => {\n    if (gamePhase === \"playing\" && currentPhrase) {\n      const playerHasPhrase = playerCard.some(row => \n        row.some(cell => cell.phrase === currentPhrase && !cell.marked && !cell.isFreeSpace)\n      );\n      \n      if (playerHasPhrase) {\n        const timer = setTimeout(() => {\n          const stillUnmarked = playerCard.some(row => \n            row.some(cell => cell.phrase === currentPhrase && !cell.marked && !cell.isFreeSpace)\n          );\n          if (stillUnmarked) {\n            setMissedPhrases(prev => [...prev, currentPhrase]);\n          }\n        }, CALL_INTERVAL - 500);\n        \n        return () => clearTimeout(timer);\n      }\n    }\n  }, [currentPhrase, playerCard, gamePhase]);\n\n  const resetGame = useCallback(() => {\n    if (callIntervalRef.current) clearInterval(callIntervalRef.current);\n    if (countdownRef.current) clearInterval(countdownRef.current);\n    setGamePhase(\"ready\");\n    setPlayerCard([]);\n    setAiCard([]);\n    setCalledPhrases([]);\n    setCurrentPhrase(null);\n    setCallableList([]);\n    setPlayerScore(0);\n    setAiScore(0);\n    setPlayerWinPattern(null);\n    setAiWinPattern(null);\n    setWinner(null);\n    setNextCallIn(4);\n    setAnnouncement(\"\");\n    setMissedPhrases([]);\n  }, []);\n\n  const getUnmarkedCalledPhrases = useCallback(() => {\n    return calledPhrases.filter(phrase => \n      playerCard.some(row => \n        row.some(cell => cell.phrase === phrase && !cell.marked && !cell.isFreeSpace)\n      )\n    );\n  }, [calledPhrases, playerCard]);\n\n  if (gamePhase === \"ready\") {\n    return (\n      <Card className=\"max-w-2xl mx-auto\" data-testid=\"bingo-ready-screen\">\n        <CardHeader className=\"text-center\">\n          <motion.div\n            initial={{ scale: 0 }}\n            animate={{ scale: 1 }}\n            transition={{ type: \"spring\", stiffness: 200 }}\n          >\n            <GraduationCap className=\"h-16 w-16 mx-auto text-green-500 mb-4\" />\n          </motion.div>\n          <CardTitle className=\"text-2xl\">Campus Bingo</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"text-center space-y-2\">\n            <p className=\"text-muted-foreground\">\n              Mark Nigerian campus life experiences as they're called. First to complete a pattern wins!\n            </p>\n            <p className=\"text-sm text-muted-foreground\">\n              Phrases called every 4 seconds. Beat the AI to shout BINGO!\n            </p>\n          </div>\n          \n          <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3\">\n            {Object.entries(PATTERNS).map(([key, pattern]) => {\n              const Icon = pattern.icon;\n              const points = isPractice ? Math.round(pattern.multiplier * 100) : Math.round(stake * pattern.multiplier);\n              return (\n                <div key={key} className={`text-center p-3 rounded-lg ${getPatternColor(key as WinPattern)}`}>\n                  <div className=\"flex items-center justify-center gap-2 mb-1\">\n                    <Icon className=\"h-4 w-4\" />\n                    <span className=\"font-semibold text-sm\">{pattern.name}</span>\n                  </div>\n                  <div className=\"text-lg font-bold\">\n                    {isPractice ? `${points} pts` : `${points.toLocaleString()} NGN`}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground\">{Math.round(pattern.multiplier * 100)}% of stake</div>\n                </div>\n              );\n            })}\n          </div>\n          \n          <div className=\"flex flex-col gap-3\">\n            {!isPractice && stake > 0 && (\n              <div className=\"text-center p-3 rounded-lg bg-amber-500/10\">\n                <div className=\"text-sm text-muted-foreground\">Stake Amount</div>\n                <div className=\"text-xl font-bold text-amber-600 dark:text-amber-400\">\n                  {stake.toLocaleString()} NGN\n                </div>\n              </div>\n            )}\n            \n            <Button \n              size=\"lg\" \n              onClick={startGame}\n              className=\"w-full\"\n              data-testid=\"button-start-bingo\"\n            >\n              <Play className=\"h-5 w-5 mr-2\" />\n              {isPractice ? \"Start Practice Game\" : \"Start Game\"}\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const unmarkedCalledPhrases = getUnmarkedCalledPhrases();\n\n  return (\n    <div className=\"max-w-4xl mx-auto space-y-4\" data-testid=\"bingo-game-screen\">\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <GraduationCap className=\"h-5 w-5 text-green-500\" />\n              Campus Bingo\n            </CardTitle>\n            \n            <div className=\"flex items-center gap-4\">\n              <div className=\"flex items-center gap-2\">\n                <User className=\"h-4 w-4 text-blue-500\" />\n                <span className=\"font-semibold\" data-testid=\"player-score\">{playerScore}</span>\n              </div>\n              <span className=\"text-muted-foreground\">vs</span>\n              <div className=\"flex items-center gap-2\">\n                <Bot className=\"h-4 w-4 text-red-500\" />\n                <span className=\"font-semibold\" data-testid=\"ai-score\">{aiScore}</span>\n              </div>\n            </div>\n          </div>\n        </CardHeader>\n        \n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-center justify-between gap-4 p-3 rounded-lg bg-muted/50\">\n            <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n              <Megaphone className=\"h-4 w-4 text-amber-500 flex-shrink-0\" />\n              <span className=\"text-sm font-medium truncate\" data-testid=\"announcement\">{announcement || \"Get ready...\"}</span>\n            </div>\n            {gamePhase === \"playing\" && !winner && (\n              <div className=\"flex items-center gap-2 flex-shrink-0\">\n                <Clock className=\"h-4 w-4\" />\n                <span className=\"text-sm\" data-testid=\"next-call-timer\">Next: {nextCallIn}s</span>\n              </div>\n            )}\n          </div>\n\n          <AnimatePresence mode=\"wait\">\n            {currentPhrase && (\n              <motion.div\n                key={currentPhrase}\n                initial={{ scale: 0, opacity: 0 }}\n                animate={{ scale: 1, opacity: 1 }}\n                exit={{ scale: 0, opacity: 0 }}\n                className=\"flex justify-center\"\n              >\n                <div className=\"px-6 py-4 rounded-lg bg-gradient-to-r from-green-500 to-emerald-600 text-white shadow-lg text-center\">\n                  <Zap className=\"h-5 w-5 mx-auto mb-1\" />\n                  <span className=\"text-lg font-bold\" data-testid=\"current-phrase\">{currentPhrase}</span>\n                </div>\n              </motion.div>\n            )}\n          </AnimatePresence>\n\n          {unmarkedCalledPhrases.length > 0 && (\n            <div className=\"p-2 rounded-lg bg-amber-500/10 border border-amber-500/20\">\n              <div className=\"flex items-center gap-2 text-xs text-amber-600 dark:text-amber-400 mb-1\">\n                <Volume2 className=\"h-3 w-3\" />\n                <span>On your card (not marked yet):</span>\n              </div>\n              <div className=\"flex flex-wrap gap-1\">\n                {unmarkedCalledPhrases.slice(-5).map((phrase, index) => (\n                  <Badge \n                    key={index}\n                    variant=\"secondary\"\n                    className=\"text-xs bg-amber-500/20\"\n                  >\n                    {phrase}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n          )}\n\n          <div className=\"flex justify-center overflow-x-auto pb-2\">\n            <div className=\"inline-block min-w-fit\">\n              <div className=\"grid grid-cols-5 gap-1\">\n                {playerCard.map((row, rowIndex) => (\n                  row.map((cell, colIndex) => {\n                    const isCallable = !cell.marked && !cell.isFreeSpace && calledPhrases.includes(cell.phrase);\n                    return (\n                      <motion.button\n                        key={`${rowIndex}-${colIndex}`}\n                        whileHover={isCallable ? { scale: 1.02 } : {}}\n                        whileTap={isCallable ? { scale: 0.98 } : {}}\n                        onClick={() => markPhrase(rowIndex, colIndex)}\n                        disabled={cell.marked || cell.isFreeSpace || gamePhase !== \"playing\"}\n                        className={`\n                          w-16 h-16 sm:w-20 sm:h-20 \n                          rounded-md border-2 \n                          flex items-center justify-center \n                          p-1 text-center\n                          transition-all duration-200\n                          ${cell.isFreeSpace \n                            ? \"bg-gradient-to-br from-green-500 to-emerald-600 text-white border-green-400\" \n                            : cell.marked\n                              ? \"bg-gradient-to-br from-blue-500 to-purple-600 text-white border-blue-400 shadow-md\"\n                              : isCallable\n                                ? \"bg-amber-500/20 border-amber-500 cursor-pointer ring-2 ring-amber-500/50\"\n                                : \"bg-card border-border\"\n                          }\n                        `}\n                        data-testid={`bingo-cell-${rowIndex}-${colIndex}`}\n                      >\n                        {cell.isFreeSpace ? (\n                          <div className=\"text-center\">\n                            <GraduationCap className=\"h-5 w-5 mx-auto\" />\n                            <span className=\"text-[8px] font-bold\">FREE</span>\n                          </div>\n                        ) : cell.marked ? (\n                          <CheckCircle2 className=\"h-6 w-6\" />\n                        ) : (\n                          <span className=\"text-[9px] sm:text-[10px] font-medium leading-tight\">\n                            {cell.phrase}\n                          </span>\n                        )}\n                      </motion.button>\n                    );\n                  })\n                ))}\n              </div>\n            </div>\n          </div>\n\n          {playerWinPattern && gamePhase === \"playing\" && (\n            <motion.div\n              initial={{ scale: 0 }}\n              animate={{ scale: 1 }}\n              className=\"flex justify-center\"\n            >\n              <Button \n                size=\"lg\"\n                onClick={claimBingo}\n                className=\"bg-gradient-to-r from-green-500 to-emerald-600 text-white px-8\"\n                data-testid=\"button-claim-bingo\"\n              >\n                <Sparkles className=\"h-5 w-5 mr-2\" />\n                BINGO! Claim {PATTERNS[playerWinPattern].name}\n              </Button>\n            </motion.div>\n          )}\n\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between text-sm\">\n              <span className=\"text-muted-foreground\">Called Phrases</span>\n              <span className=\"font-medium\">{calledPhrases.length}/{CAMPUS_PHRASES.length}</span>\n            </div>\n            <Progress value={(calledPhrases.length / CAMPUS_PHRASES.length) * 100} className=\"h-2\" />\n            \n            <ScrollArea className=\"h-20 rounded-md border p-2\">\n              <div className=\"flex flex-wrap gap-1\">\n                {calledPhrases.map((phrase, index) => (\n                  <Badge \n                    key={index}\n                    variant=\"secondary\"\n                    className=\"text-xs\"\n                    data-testid={`called-phrase-${index}`}\n                  >\n                    {phrase}\n                  </Badge>\n                ))}\n              </div>\n            </ScrollArea>\n          </div>\n        </CardContent>\n      </Card>\n\n      {gamePhase === \"finished\" && (\n        <Card data-testid=\"bingo-result-screen\">\n          <CardContent className=\"pt-6\">\n            <motion.div\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"text-center space-y-4\"\n            >\n              {winner === \"player\" ? (\n                <>\n                  <Trophy className=\"h-16 w-16 mx-auto text-yellow-500\" />\n                  <h3 className=\"text-2xl font-bold\" data-testid=\"result-title\">BINGO! You Won!</h3>\n                  <p className=\"text-muted-foreground\" data-testid=\"result-pattern\">\n                    {playerWinPattern && `${PATTERNS[playerWinPattern].name} - ${isPractice ? `${playerScore} points` : `${playerScore.toLocaleString()} NGN`}!`}\n                  </p>\n                </>\n              ) : (\n                <>\n                  <Bot className=\"h-16 w-16 mx-auto text-red-500\" />\n                  <h3 className=\"text-2xl font-bold\" data-testid=\"result-title\">AI Wins!</h3>\n                  <p className=\"text-muted-foreground\" data-testid=\"result-pattern\">\n                    {aiWinPattern && `AI got ${PATTERNS[aiWinPattern].name} first!`}\n                  </p>\n                </>\n              )}\n              \n              <div className=\"grid grid-cols-2 gap-4 pt-4\">\n                <div className=\"text-center p-3 rounded-lg bg-blue-500/10\">\n                  <User className=\"h-5 w-5 mx-auto text-blue-500 mb-1\" />\n                  <div className=\"text-lg font-bold\" data-testid=\"final-player-score\">\n                    {isPractice ? `${playerScore} pts` : `${playerScore.toLocaleString()} NGN`}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground\">Your Winnings</div>\n                </div>\n                <div className=\"text-center p-3 rounded-lg bg-red-500/10\">\n                  <Bot className=\"h-5 w-5 mx-auto text-red-500 mb-1\" />\n                  <div className=\"text-lg font-bold\" data-testid=\"final-ai-score\">\n                    {isPractice ? `${aiScore} pts` : `${aiScore.toLocaleString()} NGN`}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground\">AI Winnings</div>\n                </div>\n              </div>\n              \n              <Button \n                onClick={resetGame}\n                className=\"w-full\"\n                data-testid=\"button-play-again\"\n              >\n                <RotateCcw className=\"h-4 w-4 mr-2\" />\n                Play Again\n              </Button>\n            </motion.div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":26674,"size_tokens":null},"client/src/pages/send-secret.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useParams } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Send, \n  Eye,\n  Check,\n  AlertTriangle,\n  Clock,\n  Sparkles,\n  Lock\n} from \"lucide-react\";\n\ntype LinkInfo = {\n  title: string;\n  backgroundColor: string;\n  isActive: boolean;\n};\n\nexport default function SendSecretPage() {\n  const params = useParams<{ code: string }>();\n  const code = params.code;\n  const { toast } = useToast();\n  const [message, setMessage] = useState(\"\");\n  const [sent, setSent] = useState(false);\n\n  const { data: linkInfo, isLoading, isError, error } = useQuery<LinkInfo>({\n    queryKey: [\"/api/secret-links\", code],\n    queryFn: async () => {\n      const res = await fetch(`/api/secret-links/${code}`);\n      if (!res.ok) {\n        const data = await res.json();\n        throw new Error(data.message || \"Link not found\");\n      }\n      return res.json();\n    },\n    retry: false,\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: async (content: string) => {\n      const res = await fetch(`/api/secret-messages/${code}`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ content }),\n      });\n      const data = await res.json();\n      if (!res.ok) {\n        throw new Error(data.message || \"Failed to send message\");\n      }\n      return data;\n    },\n    onSuccess: (data) => {\n      setSent(true);\n      setMessage(\"\");\n      toast({\n        title: \"Message sent!\",\n        description: data.message || \"Your anonymous message has been delivered.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to send message\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!message.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter a message\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    sendMessageMutation.mutate(message);\n  };\n\n  const resetForm = () => {\n    setSent(false);\n    setMessage(\"\");\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-b from-purple-950/50 to-zinc-950 flex items-center justify-center p-4\">\n        <motion.div\n          initial={{ opacity: 0, scale: 0.9 }}\n          animate={{ opacity: 1, scale: 1 }}\n          className=\"text-center\"\n        >\n          <div className=\"inline-block h-10 w-10 animate-spin rounded-full border-4 border-solid border-purple-500 border-r-transparent mb-4\"></div>\n          <p className=\"text-purple-300\">Loading...</p>\n        </motion.div>\n      </div>\n    );\n  }\n\n  if (isError || !linkInfo) {\n    const errorMessage = error instanceof Error ? error.message : \"Link not found\";\n    const isInactive = errorMessage.includes(\"no longer active\");\n    \n    return (\n      <div className=\"min-h-screen bg-gradient-to-b from-purple-950/50 to-zinc-950 flex items-center justify-center p-4\">\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"max-w-md w-full\"\n        >\n          <Card className=\"bg-zinc-900/80 border-zinc-800\">\n            <CardContent className=\"p-8 text-center\">\n              <div className=\"w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-4\">\n                <AlertTriangle className=\"h-8 w-8 text-red-400\" />\n              </div>\n              <h1 className=\"text-xl font-bold mb-2\">\n                {isInactive ? \"Link Inactive\" : \"Link Not Found\"}\n              </h1>\n              <p className=\"text-muted-foreground mb-6\">\n                {isInactive \n                  ? \"This secret message link is no longer accepting messages.\"\n                  : \"This secret message link doesn't exist or has been deleted.\"\n                }\n              </p>\n              <Button \n                variant=\"outline\" \n                onClick={() => window.location.href = \"/\"}\n                data-testid=\"button-go-home\"\n              >\n                Go to Homepage\n              </Button>\n            </CardContent>\n          </Card>\n        </motion.div>\n      </div>\n    );\n  }\n\n  return (\n    <div \n      className=\"min-h-screen flex items-center justify-center p-4 transition-colors\"\n      style={{ \n        background: `linear-gradient(to bottom, ${linkInfo.backgroundColor}33, #09090b)` \n      }}\n    >\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"max-w-md w-full\"\n      >\n        <AnimatePresence mode=\"wait\">\n          {sent ? (\n            <motion.div\n              key=\"success\"\n              initial={{ opacity: 0, scale: 0.9 }}\n              animate={{ opacity: 1, scale: 1 }}\n              exit={{ opacity: 0, scale: 0.9 }}\n            >\n              <Card className=\"bg-zinc-900/80 border-zinc-800\">\n                <CardContent className=\"p-8 text-center\">\n                  <motion.div\n                    initial={{ scale: 0 }}\n                    animate={{ scale: 1 }}\n                    transition={{ type: \"spring\", delay: 0.1 }}\n                    className=\"w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6\"\n                    style={{ backgroundColor: `${linkInfo.backgroundColor}33` }}\n                  >\n                    <Check className=\"h-10 w-10\" style={{ color: linkInfo.backgroundColor }} />\n                  </motion.div>\n                  <h1 className=\"text-2xl font-bold mb-2\">Message Sent!</h1>\n                  <p className=\"text-muted-foreground mb-6\">\n                    Your anonymous message has been delivered successfully.\n                  </p>\n                  <div className=\"space-y-3\">\n                    <Button \n                      onClick={resetForm}\n                      className=\"w-full\"\n                      style={{ backgroundColor: linkInfo.backgroundColor }}\n                      data-testid=\"button-send-another\"\n                    >\n                      <Send className=\"h-4 w-4 mr-2\" />\n                      Send Another Message\n                    </Button>\n                    <p className=\"text-xs text-muted-foreground flex items-center justify-center gap-1\">\n                      <Lock className=\"h-3 w-3\" />\n                      Your identity is completely anonymous\n                    </p>\n                  </div>\n                </CardContent>\n              </Card>\n            </motion.div>\n          ) : (\n            <motion.div\n              key=\"form\"\n              initial={{ opacity: 0, scale: 0.9 }}\n              animate={{ opacity: 1, scale: 1 }}\n              exit={{ opacity: 0, scale: 0.9 }}\n            >\n              <Card className=\"bg-zinc-900/80 border-zinc-800 overflow-visible\">\n                <CardContent className=\"p-6\">\n                  <div className=\"text-center mb-6\">\n                    <motion.div\n                      initial={{ scale: 0 }}\n                      animate={{ scale: 1 }}\n                      transition={{ type: \"spring\", delay: 0.1 }}\n                      className=\"w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4\"\n                      style={{ backgroundColor: `${linkInfo.backgroundColor}33` }}\n                    >\n                      <Eye className=\"h-8 w-8\" style={{ color: linkInfo.backgroundColor }} />\n                    </motion.div>\n                    <h1 className=\"text-xl font-bold mb-2\">{linkInfo.title}</h1>\n                    <p className=\"text-sm text-muted-foreground flex items-center justify-center gap-1\">\n                      <Lock className=\"h-3 w-3\" />\n                      Your message will be completely anonymous\n                    </p>\n                  </div>\n\n                  <form onSubmit={handleSubmit} className=\"space-y-4\">\n                    <div>\n                      <Textarea\n                        data-testid=\"textarea-secret-message\"\n                        value={message}\n                        onChange={(e) => setMessage(e.target.value)}\n                        placeholder=\"Write your anonymous message here...\"\n                        className=\"min-h-[150px] bg-zinc-800/50 border-zinc-700 focus:border-purple-500 resize-none\"\n                        maxLength={2000}\n                      />\n                      <div className=\"flex justify-between mt-2 text-xs text-muted-foreground\">\n                        <span>{message.length}/2000 characters</span>\n                        <span className=\"flex items-center gap-1\">\n                          <Sparkles className=\"h-3 w-3\" />\n                          No one will know it's you\n                        </span>\n                      </div>\n                    </div>\n\n                    <Button \n                      type=\"submit\"\n                      className=\"w-full\"\n                      style={{ backgroundColor: linkInfo.backgroundColor }}\n                      data-testid=\"button-send-message\"\n                      disabled={sendMessageMutation.isPending || !message.trim()}\n                    >\n                      {sendMessageMutation.isPending ? (\n                        <>\n                          <Clock className=\"h-4 w-4 mr-2 animate-spin\" />\n                          Sending...\n                        </>\n                      ) : (\n                        <>\n                          <Send className=\"h-4 w-4 mr-2\" />\n                          Send Anonymous Message\n                        </>\n                      )}\n                    </Button>\n                  </form>\n\n                  <div className=\"mt-6 pt-4 border-t border-zinc-800 text-center\">\n                    <p className=\"text-xs text-muted-foreground mb-2\">\n                      Want to create your own secret message link?\n                    </p>\n                    <Button \n                      variant=\"ghost\" \n                      className=\"text-purple-400 text-sm\"\n                      onClick={() => window.location.href = \"/\"}\n                      data-testid=\"button-create-own-link\"\n                    >\n                      Create your link on EKSU Marketplace\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <motion.div\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                transition={{ delay: 0.3 }}\n                className=\"mt-6 text-center\"\n              >\n                <p className=\"text-xs text-zinc-500\">\n                  Powered by EKSU Marketplace Secret Messages\n                </p>\n              </motion.div>\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </motion.div>\n    </div>\n  );\n}\n","path":null,"size_bytes":11117,"size_tokens":null},"client/src/pages/secret-messages.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Link2, \n  Copy, \n  Check, \n  Plus, \n  Trash2, \n  Eye,\n  EyeOff,\n  MessageSquare,\n  Clock,\n  Inbox,\n  ExternalLink,\n  ArrowLeft,\n  Sparkles\n} from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { Link } from \"wouter\";\nimport type { SecretMessageLink, SecretMessage } from \"@shared/schema\";\n\ntype SecretMessageWithLink = SecretMessage & { link: SecretMessageLink };\n\nfunction CreateLinkForm({ onClose }: { onClose: () => void }) {\n  const { toast } = useToast();\n  const [title, setTitle] = useState(\"Send me an anonymous message\");\n  const [backgroundColor, setBackgroundColor] = useState(\"#6b21a8\");\n\n  const createLinkMutation = useMutation({\n    mutationFn: async (data: { title: string; backgroundColor: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/secret-links\", data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/secret-links/mine\"] });\n      toast({\n        title: \"Link created!\",\n        description: \"Your secret message link is ready to share.\",\n      });\n      onClose();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create link\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    createLinkMutation.mutate({ title, backgroundColor });\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"title\">Prompt Message</Label>\n        <Input\n          id=\"title\"\n          data-testid=\"input-link-title\"\n          value={title}\n          onChange={(e) => setTitle(e.target.value)}\n          placeholder=\"Send me an anonymous message...\"\n          maxLength={200}\n        />\n        <p className=\"text-xs text-muted-foreground\">This is what people will see when they visit your link</p>\n      </div>\n      \n      <div className=\"space-y-2\">\n        <Label htmlFor=\"color\">Theme Color</Label>\n        <div className=\"flex items-center gap-3\">\n          <input\n            type=\"color\"\n            id=\"color\"\n            data-testid=\"input-link-color\"\n            value={backgroundColor}\n            onChange={(e) => setBackgroundColor(e.target.value)}\n            className=\"w-12 h-10 rounded-md border cursor-pointer\"\n          />\n          <Input\n            value={backgroundColor}\n            onChange={(e) => setBackgroundColor(e.target.value)}\n            placeholder=\"#6b21a8\"\n            pattern=\"^#[0-9A-Fa-f]{6}$\"\n            className=\"flex-1\"\n          />\n        </div>\n      </div>\n\n      <DialogFooter>\n        <Button type=\"button\" variant=\"outline\" onClick={onClose}>Cancel</Button>\n        <Button \n          type=\"submit\" \n          data-testid=\"button-create-link\"\n          disabled={createLinkMutation.isPending}\n          className=\"bg-purple-600 hover:bg-purple-700\"\n        >\n          {createLinkMutation.isPending ? \"Creating...\" : \"Create Link\"}\n        </Button>\n      </DialogFooter>\n    </form>\n  );\n}\n\nfunction LinkCard({ link, onDelete }: { link: SecretMessageLink; onDelete: (id: string) => void }) {\n  const { toast } = useToast();\n  const [copied, setCopied] = useState(false);\n  \n  const baseUrl = typeof window !== 'undefined' ? window.location.origin : '';\n  const fullUrl = `${baseUrl}/secret/${link.linkCode}`;\n\n  const toggleMutation = useMutation({\n    mutationFn: async ({ id, isActive }: { id: string; isActive: boolean }) => {\n      const res = await apiRequest(\"PATCH\", `/api/secret-links/${id}/toggle`, { isActive });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/secret-links/mine\"] });\n    },\n  });\n\n  const copyToClipboard = async () => {\n    try {\n      await navigator.clipboard.writeText(fullUrl);\n      setCopied(true);\n      toast({\n        title: \"Copied!\",\n        description: \"Link copied to clipboard\",\n      });\n      setTimeout(() => setCopied(false), 2000);\n    } catch (err) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to copy link\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, y: -20 }}\n    >\n      <Card className=\"bg-gradient-to-r from-purple-900/40 to-pink-900/30 border-purple-500/30 hover:border-purple-500/50 transition-colors\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-start justify-between gap-3\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center gap-2 mb-2 flex-wrap\">\n                <div \n                  className=\"w-4 h-4 rounded-full shadow-lg\" \n                  style={{ backgroundColor: link.backgroundColor || \"#6b21a8\" }}\n                />\n                <span className=\"font-medium text-sm truncate text-purple-100\">{link.title}</span>\n                <Badge \n                  variant={link.isActive ? \"default\" : \"secondary\"}\n                  className={link.isActive ? \"bg-green-500/30 text-green-300 border-green-500/50\" : \"bg-zinc-500/30 text-zinc-300 border-zinc-500/30\"}\n                >\n                  {link.isActive ? \"Active\" : \"Inactive\"}\n                </Badge>\n              </div>\n              \n              <div className=\"flex items-center gap-2 mb-3\">\n                <code className=\"text-xs text-muted-foreground bg-zinc-800/50 px-2 py-1 rounded truncate flex-1\">\n                  {fullUrl}\n                </code>\n              </div>\n\n              <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                <Clock className=\"h-3 w-3\" />\n                Created {formatDistanceToNow(new Date(link.createdAt!), { addSuffix: true })}\n              </div>\n            </div>\n\n            <div className=\"flex flex-col gap-2\">\n              <Button \n                size=\"icon\" \n                variant=\"ghost\"\n                data-testid={`button-copy-link-${link.id}`}\n                onClick={copyToClipboard}\n                className=\"h-8 w-8\"\n              >\n                {copied ? <Check className=\"h-4 w-4 text-green-400\" /> : <Copy className=\"h-4 w-4\" />}\n              </Button>\n              <Button \n                size=\"icon\" \n                variant=\"ghost\"\n                data-testid={`button-open-link-${link.id}`}\n                onClick={() => window.open(fullUrl, '_blank')}\n                className=\"h-8 w-8\"\n              >\n                <ExternalLink className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-between mt-4 pt-3 border-t border-zinc-800/50\">\n            <div className=\"flex items-center gap-2\">\n              <Switch\n                id={`active-${link.id}`}\n                data-testid={`switch-link-active-${link.id}`}\n                checked={link.isActive || false}\n                onCheckedChange={(checked) => toggleMutation.mutate({ id: link.id, isActive: checked })}\n              />\n              <Label htmlFor={`active-${link.id}`} className=\"text-sm text-muted-foreground\">\n                {link.isActive ? \"Accepting messages\" : \"Not accepting messages\"}\n              </Label>\n            </div>\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              data-testid={`button-delete-link-${link.id}`}\n              onClick={() => onDelete(link.id)}\n              className=\"text-red-400 hover:text-red-300 hover:bg-red-500/10\"\n            >\n              <Trash2 className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nfunction MessageCard({ \n  message, \n  onMarkRead, \n  onDelete \n}: { \n  message: SecretMessageWithLink; \n  onMarkRead: (id: string) => void;\n  onDelete: (id: string) => void;\n}) {\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, y: -20 }}\n    >\n      <Card className={`bg-gradient-to-r from-purple-900/30 to-pink-900/20 border-purple-500/30 hover:border-purple-500/50 transition-colors ${!message.isRead ? 'border-l-4 border-l-pink-500 shadow-lg shadow-pink-500/20' : ''}`}>\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-start gap-3\">\n            <div \n              className=\"w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg\"\n              style={{ backgroundColor: message.link.backgroundColor || \"#6b21a8\" }}\n            >\n              <Eye className=\"h-5 w-5 text-white\" />\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center gap-2 mb-2 flex-wrap\">\n                <span className=\"text-xs text-muted-foreground\">\n                  Via: {message.link.title}\n                </span>\n                {!message.isRead && (\n                  <Badge className=\"bg-purple-500/20 text-purple-400 text-xs\">New</Badge>\n                )}\n              </div>\n              <p className=\"text-sm whitespace-pre-wrap break-words\">{message.content}</p>\n              <div className=\"flex items-center gap-2 mt-3 text-xs text-muted-foreground\">\n                <Clock className=\"h-3 w-3\" />\n                {formatDistanceToNow(new Date(message.createdAt!), { addSuffix: true })}\n              </div>\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-end gap-2 mt-4 pt-3 border-t border-zinc-800/50\">\n            {!message.isRead && (\n              <Button\n                size=\"sm\"\n                variant=\"ghost\"\n                data-testid={`button-mark-read-${message.id}`}\n                onClick={() => onMarkRead(message.id)}\n                className=\"text-purple-400 hover:text-purple-300\"\n              >\n                <EyeOff className=\"h-4 w-4 mr-1\" />\n                Mark as read\n              </Button>\n            )}\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              data-testid={`button-delete-message-${message.id}`}\n              onClick={() => onDelete(message.id)}\n              className=\"text-red-400 hover:text-red-300 hover:bg-red-500/10\"\n            >\n              <Trash2 className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nexport default function SecretMessagesPage() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [deleteTarget, setDeleteTarget] = useState<{ type: 'link' | 'message'; id: string } | null>(null);\n\n  const { data: links, isLoading: linksLoading } = useQuery<SecretMessageLink[]>({\n    queryKey: [\"/api/secret-links/mine\"],\n  });\n\n  const { data: messages, isLoading: messagesLoading } = useQuery<SecretMessageWithLink[]>({\n    queryKey: [\"/api/secret-messages\"],\n  });\n\n  const { data: unreadCount } = useQuery<{ count: number }>({\n    queryKey: [\"/api/secret-messages/unread-count\"],\n  });\n\n  const markReadMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const res = await apiRequest(\"PATCH\", `/api/secret-messages/${id}/read`);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/secret-messages\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/secret-messages/unread-count\"] });\n    },\n  });\n\n  const deleteLinkMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const res = await apiRequest(\"DELETE\", `/api/secret-links/${id}`);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/secret-links/mine\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/secret-messages\"] });\n      toast({\n        title: \"Link deleted\",\n        description: \"The link and all associated messages have been deleted.\",\n      });\n      setDeleteTarget(null);\n    },\n  });\n\n  const deleteMessageMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const res = await apiRequest(\"DELETE\", `/api/secret-messages/${id}`);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/secret-messages\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/secret-messages/unread-count\"] });\n      toast({\n        title: \"Message deleted\",\n        description: \"The message has been deleted.\",\n      });\n      setDeleteTarget(null);\n    },\n  });\n\n  const handleDelete = () => {\n    if (!deleteTarget) return;\n    if (deleteTarget.type === 'link') {\n      deleteLinkMutation.mutate(deleteTarget.id);\n    } else {\n      deleteMessageMutation.mutate(deleteTarget.id);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-purple-950/20 to-background pb-20 lg:pb-4\">\n      <div className=\"max-w-2xl mx-auto p-4\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <Link href=\"/confessions\">\n            <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back-confessions\">\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Button>\n          </Link>\n          <div>\n            <h1 className=\"text-2xl font-bold flex items-center gap-2\">\n              <Sparkles className=\"h-6 w-6 text-purple-400\" />\n              Secret Messages\n            </h1>\n            <p className=\"text-sm text-muted-foreground\">Create links to receive anonymous messages</p>\n          </div>\n        </div>\n\n        <div className=\"space-y-6\">\n          <Card className=\"bg-gradient-to-r from-purple-900/40 via-purple-800/30 to-pink-900/30 border-purple-500/40 shadow-lg\">\n            <CardContent className=\"p-5\">\n              <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                <div>\n                  <h3 className=\"font-semibold text-purple-100 text-lg flex items-center gap-2\">\n                    <Sparkles className=\"h-5 w-5 text-purple-300\" />\n                    Create a new link\n                  </h3>\n                  <p className=\"text-sm text-purple-300/80 mt-1\">Share with anyone and receive anonymous messages</p>\n                </div>\n                <Button \n                  data-testid=\"button-create-new-link\"\n                  onClick={() => setShowCreateDialog(true)}\n                  className=\"bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white whitespace-nowrap\"\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  New Link\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n\n          <div>\n            <div className=\"flex items-center gap-2 mb-4\">\n              <Link2 className=\"h-5 w-5 text-purple-400\" />\n              <h2 className=\"text-lg font-semibold\">My Links</h2>\n              {links && links.length > 0 && (\n                <Badge variant=\"secondary\" className=\"bg-purple-500/20 text-purple-400\">\n                  {links.length}\n                </Badge>\n              )}\n            </div>\n            \n            {linksLoading ? (\n              <div className=\"space-y-3\">\n                <Skeleton className=\"h-32 w-full\" />\n                <Skeleton className=\"h-32 w-full\" />\n              </div>\n            ) : links && links.length > 0 ? (\n              <div className=\"space-y-3\">\n                <AnimatePresence>\n                  {links.map((link) => (\n                    <LinkCard \n                      key={link.id} \n                      link={link} \n                      onDelete={(id) => setDeleteTarget({ type: 'link', id })}\n                    />\n                  ))}\n                </AnimatePresence>\n              </div>\n            ) : (\n              <Card className=\"bg-zinc-900/50 border-zinc-800/50\">\n                <CardContent className=\"p-8 text-center\">\n                  <Link2 className=\"h-12 w-12 text-muted-foreground mx-auto mb-3 opacity-50\" />\n                  <p className=\"text-muted-foreground\">No links created yet</p>\n                  <p className=\"text-sm text-muted-foreground/70 mb-4\">Create your first link to start receiving anonymous messages</p>\n                  <Button \n                    onClick={() => setShowCreateDialog(true)}\n                    className=\"bg-purple-600 hover:bg-purple-700\"\n                  >\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Create Your First Link\n                  </Button>\n                </CardContent>\n              </Card>\n            )}\n          </div>\n\n          <div>\n            <div className=\"flex items-center gap-2 mb-4\">\n              <Inbox className=\"h-5 w-5 text-purple-400\" />\n              <h2 className=\"text-lg font-semibold\">Received Messages</h2>\n              {unreadCount && unreadCount.count > 0 && (\n                <Badge className=\"bg-purple-500 text-white\">\n                  {unreadCount.count} new\n                </Badge>\n              )}\n            </div>\n\n            {messagesLoading ? (\n              <div className=\"space-y-3\">\n                <Skeleton className=\"h-28 w-full\" />\n                <Skeleton className=\"h-28 w-full\" />\n              </div>\n            ) : messages && messages.length > 0 ? (\n              <ScrollArea className=\"max-h-[500px]\">\n                <div className=\"space-y-3 pr-4\">\n                  <AnimatePresence>\n                    {messages.map((message) => (\n                      <MessageCard\n                        key={message.id}\n                        message={message}\n                        onMarkRead={(id) => markReadMutation.mutate(id)}\n                        onDelete={(id) => setDeleteTarget({ type: 'message', id })}\n                      />\n                    ))}\n                  </AnimatePresence>\n                </div>\n              </ScrollArea>\n            ) : (\n              <Card className=\"bg-zinc-900/50 border-zinc-800/50\">\n                <CardContent className=\"p-8 text-center\">\n                  <MessageSquare className=\"h-12 w-12 text-muted-foreground mx-auto mb-3 opacity-50\" />\n                  <p className=\"text-muted-foreground\">No messages yet</p>\n                  <p className=\"text-sm text-muted-foreground/70\">Share your link to start receiving anonymous messages</p>\n                </CardContent>\n              </Card>\n            )}\n          </div>\n        </div>\n      </div>\n\n      <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n        <DialogContent className=\"bg-zinc-900 border-zinc-800\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Link2 className=\"h-5 w-5 text-purple-400\" />\n              Create Secret Message Link\n            </DialogTitle>\n            <DialogDescription>\n              Create a link that you can share. Anyone with the link can send you anonymous messages.\n            </DialogDescription>\n          </DialogHeader>\n          <CreateLinkForm onClose={() => setShowCreateDialog(false)} />\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!deleteTarget} onOpenChange={() => setDeleteTarget(null)}>\n        <DialogContent className=\"bg-zinc-900 border-zinc-800\">\n          <DialogHeader>\n            <DialogTitle>Confirm Delete</DialogTitle>\n            <DialogDescription>\n              {deleteTarget?.type === 'link' \n                ? \"Are you sure you want to delete this link? All messages associated with it will also be deleted.\"\n                : \"Are you sure you want to delete this message? This action cannot be undone.\"\n              }\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeleteTarget(null)}>Cancel</Button>\n            <Button \n              variant=\"destructive\"\n              data-testid=\"button-confirm-delete\"\n              onClick={handleDelete}\n              disabled={deleteLinkMutation.isPending || deleteMessageMutation.isPending}\n            >\n              {deleteLinkMutation.isPending || deleteMessageMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":21241,"size_tokens":null},"client/src/components/ui/lightbox.tsx":{"content":"import { useState, useCallback, useEffect } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { X, ZoomIn, ZoomOut, Download, ExternalLink, ChevronLeft, ChevronRight } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface LightboxProps {\n  src: string;\n  alt?: string;\n  isOpen: boolean;\n  onClose: () => void;\n  images?: string[];\n  initialIndex?: number;\n}\n\nexport function Lightbox({ \n  src, \n  alt = \"Image preview\", \n  isOpen, \n  onClose,\n  images,\n  initialIndex = 0\n}: LightboxProps) {\n  const [zoom, setZoom] = useState(1);\n  const [currentIndex, setCurrentIndex] = useState(initialIndex);\n  \n  const hasMultipleImages = images && images.length > 1;\n  const currentSrc = images ? images[currentIndex] : src;\n  \n  const handleZoomIn = useCallback(() => {\n    setZoom(prev => Math.min(prev + 0.5, 3));\n  }, []);\n  \n  const handleZoomOut = useCallback(() => {\n    setZoom(prev => Math.max(prev - 0.5, 0.5));\n  }, []);\n  \n  const handleDownload = useCallback(() => {\n    const link = document.createElement('a');\n    link.href = currentSrc;\n    link.download = `image-${Date.now()}.jpg`;\n    link.target = '_blank';\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  }, [currentSrc]);\n  \n  const handleOpenInNewTab = useCallback(() => {\n    window.open(currentSrc, '_blank');\n  }, [currentSrc]);\n  \n  const handlePrevious = useCallback(() => {\n    if (images) {\n      setCurrentIndex(prev => (prev > 0 ? prev - 1 : images.length - 1));\n    }\n  }, [images]);\n  \n  const handleNext = useCallback(() => {\n    if (images) {\n      setCurrentIndex(prev => (prev < images.length - 1 ? prev + 1 : 0));\n    }\n  }, [images]);\n  \n  useEffect(() => {\n    if (!isOpen) {\n      setZoom(1);\n      setCurrentIndex(initialIndex);\n    }\n  }, [isOpen, initialIndex]);\n  \n  useEffect(() => {\n    if (!isOpen) return;\n    \n    const handleKeyDown = (e: KeyboardEvent) => {\n      switch (e.key) {\n        case 'Escape':\n          onClose();\n          break;\n        case 'ArrowLeft':\n          if (hasMultipleImages) handlePrevious();\n          break;\n        case 'ArrowRight':\n          if (hasMultipleImages) handleNext();\n          break;\n        case '+':\n        case '=':\n          handleZoomIn();\n          break;\n        case '-':\n          handleZoomOut();\n          break;\n      }\n    };\n    \n    document.addEventListener('keydown', handleKeyDown);\n    return () => document.removeEventListener('keydown', handleKeyDown);\n  }, [isOpen, onClose, handlePrevious, handleNext, handleZoomIn, handleZoomOut, hasMultipleImages]);\n  \n  useEffect(() => {\n    if (isOpen) {\n      document.body.style.overflow = 'hidden';\n    } else {\n      document.body.style.overflow = '';\n    }\n    return () => {\n      document.body.style.overflow = '';\n    };\n  }, [isOpen]);\n  \n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          exit={{ opacity: 0 }}\n          className=\"fixed inset-0 z-[100] bg-black/90 flex items-center justify-center\"\n          onClick={onClose}\n          data-testid=\"lightbox-overlay\"\n        >\n          <motion.div\n            initial={{ scale: 0.95, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            exit={{ scale: 0.95, opacity: 0 }}\n            className=\"relative max-w-[90vw] max-h-[90vh] flex flex-col\"\n            onClick={e => e.stopPropagation()}\n            data-testid=\"lightbox-container\"\n          >\n            <div className=\"absolute top-2 right-2 z-10 bg-black/70 backdrop-blur-sm rounded-md p-1 flex items-center gap-1\">\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={handleZoomOut}\n                disabled={zoom <= 0.5}\n                className=\"text-white\"\n                data-testid=\"lightbox-zoom-out\"\n              >\n                <ZoomOut className=\"h-4 w-4\" />\n              </Button>\n              <span className=\"text-white text-sm px-2\">\n                {Math.round(zoom * 100)}%\n              </span>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={handleZoomIn}\n                disabled={zoom >= 3}\n                className=\"text-white\"\n                data-testid=\"lightbox-zoom-in\"\n              >\n                <ZoomIn className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={handleDownload}\n                className=\"text-white\"\n                data-testid=\"lightbox-download\"\n              >\n                <Download className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={handleOpenInNewTab}\n                className=\"text-white\"\n                data-testid=\"lightbox-external\"\n              >\n                <ExternalLink className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={onClose}\n                className=\"text-white\"\n                data-testid=\"lightbox-close\"\n              >\n                <X className=\"h-4 w-4\" />\n              </Button>\n            </div>\n            \n            {hasMultipleImages && (\n              <>\n                <div className=\"absolute left-2 top-1/2 -translate-y-1/2 z-10 bg-black/70 backdrop-blur-sm rounded-md p-1\">\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={handlePrevious}\n                    className=\"text-white\"\n                    data-testid=\"lightbox-previous\"\n                  >\n                    <ChevronLeft className=\"h-6 w-6\" />\n                  </Button>\n                </div>\n                <div className=\"absolute right-2 top-1/2 -translate-y-1/2 z-10 bg-black/70 backdrop-blur-sm rounded-md p-1\">\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={handleNext}\n                    className=\"text-white\"\n                    data-testid=\"lightbox-next\"\n                  >\n                    <ChevronRight className=\"h-6 w-6\" />\n                  </Button>\n                </div>\n              </>\n            )}\n            \n            <div className=\"overflow-auto\">\n              <motion.img\n                src={currentSrc}\n                alt={alt}\n                style={{ transform: `scale(${zoom})` }}\n                className=\"max-w-full max-h-[85vh] object-contain transition-transform duration-200\"\n                data-testid=\"lightbox-image\"\n                draggable={false}\n              />\n            </div>\n            \n            {hasMultipleImages && (\n              <div className=\"absolute bottom-2 left-1/2 -translate-x-1/2 z-10 bg-black/70 backdrop-blur-sm rounded-md px-3 py-1.5 flex items-center gap-2\">\n                {images.map((_, index) => (\n                  <button\n                    key={index}\n                    onClick={() => setCurrentIndex(index)}\n                    className={`w-2 h-2 rounded-full transition-colors ${\n                      index === currentIndex ? 'bg-white' : 'bg-white/40'\n                    }`}\n                    data-testid={`lightbox-dot-${index}`}\n                  />\n                ))}\n                <span className=\"text-white text-xs ml-1\">\n                  {currentIndex + 1} / {images.length}\n                </span>\n              </div>\n            )}\n          </motion.div>\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}\n\nexport function useLightbox() {\n  const [isOpen, setIsOpen] = useState(false);\n  const [currentImage, setCurrentImage] = useState<string>(\"\");\n  const [images, setImages] = useState<string[]>([]);\n  const [initialIndex, setInitialIndex] = useState(0);\n  \n  const openLightbox = useCallback((src: string, allImages?: string[], index?: number) => {\n    setCurrentImage(src);\n    if (allImages) {\n      setImages(allImages);\n      setInitialIndex(index ?? allImages.indexOf(src));\n    } else {\n      setImages([]);\n      setInitialIndex(0);\n    }\n    setIsOpen(true);\n  }, []);\n  \n  const closeLightbox = useCallback(() => {\n    setIsOpen(false);\n  }, []);\n  \n  return {\n    isOpen,\n    currentImage,\n    images,\n    initialIndex,\n    openLightbox,\n    closeLightbox\n  };\n}\n","path":null,"size_bytes":8501,"size_tokens":null},"client/src/hooks/useGeolocation.ts":{"content":"import { useState, useEffect, useCallback, useRef } from 'react';\nimport { \n  getCurrentPosition, \n  mapToLocationName, \n  getUnknownLocation, \n  clearLocationCache,\n  getDistanceToSeller,\n  getSellerLocationName,\n  type GeolocationInfo \n} from '@/lib/geolocation';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useAuth } from '@/hooks/useAuth';\n\nexport interface UseGeolocationOptions {\n  enableHighAccuracy?: boolean;\n  timeout?: number;\n  maximumAge?: number;\n  autoUpdate?: boolean;\n  updateInterval?: number;\n  sendToServer?: boolean;\n}\n\nexport interface UseGeolocationResult {\n  location: GeolocationInfo;\n  isLoading: boolean;\n  error: string | null;\n  permissionState: PermissionState | null;\n  refresh: (forceRefresh?: boolean) => Promise<void>;\n  clearCache: () => void;\n}\n\nconst DEFAULT_OPTIONS: UseGeolocationOptions = {\n  enableHighAccuracy: false,\n  timeout: 10000,\n  maximumAge: 300000, // 5 minutes\n  autoUpdate: true,\n  updateInterval: 5 * 60 * 1000, // 5 minutes\n  sendToServer: true,\n};\n\n/**\n * Hook for getting and tracking the user's geolocation\n * Automatically updates the server with location data when authenticated\n */\nexport function useGeolocation(options?: UseGeolocationOptions): UseGeolocationResult {\n  const mergedOptions = { ...DEFAULT_OPTIONS, ...options };\n  const { isAuthenticated } = useAuth();\n  \n  const [location, setLocation] = useState<GeolocationInfo>(getUnknownLocation());\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [permissionState, setPermissionState] = useState<PermissionState | null>(null);\n  \n  const updateIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  const lastServerUpdateRef = useRef<number>(0);\n\n  // Check geolocation permission status\n  useEffect(() => {\n    if ('permissions' in navigator) {\n      navigator.permissions.query({ name: 'geolocation' as PermissionName }).then((result) => {\n        setPermissionState(result.state);\n        result.addEventListener('change', () => {\n          setPermissionState(result.state);\n        });\n      }).catch(() => {\n        // Permissions API not fully supported\n      });\n    }\n  }, []);\n\n  // Send location to server\n  const sendLocationToServer = useCallback(async (lat: number, lng: number) => {\n    if (!isAuthenticated || !mergedOptions.sendToServer) return;\n    \n    // Throttle server updates to at most once per minute\n    const now = Date.now();\n    if (now - lastServerUpdateRef.current < 60000) return;\n    \n    try {\n      await apiRequest('PATCH', '/api/users/me/location', {\n        latitude: lat,\n        longitude: lng,\n      });\n      lastServerUpdateRef.current = now;\n    } catch (err) {\n      // Silently fail - don't interrupt the user experience\n      console.warn('Failed to update location on server:', err);\n    }\n  }, [isAuthenticated, mergedOptions.sendToServer]);\n\n  // Fetch location\n  const fetchLocation = useCallback(async (forceRefresh = false) => {\n    setIsLoading(true);\n    setError(null);\n\n    try {\n      const locationInfo = await getCurrentPosition({\n        enableHighAccuracy: mergedOptions.enableHighAccuracy,\n        timeout: mergedOptions.timeout,\n        maximumAge: mergedOptions.maximumAge,\n        forceRefresh,\n      });\n\n      setLocation(locationInfo);\n\n      // Send to server if we got valid coordinates\n      if (locationInfo.latitude && locationInfo.longitude) {\n        sendLocationToServer(locationInfo.latitude, locationInfo.longitude);\n      }\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Failed to get location';\n      setError(errorMessage);\n      setLocation(getUnknownLocation());\n    } finally {\n      setIsLoading(false);\n    }\n  }, [mergedOptions, sendLocationToServer]);\n\n  // Initial fetch and interval setup\n  useEffect(() => {\n    fetchLocation();\n\n    // Setup auto-update interval\n    if (mergedOptions.autoUpdate && mergedOptions.updateInterval) {\n      updateIntervalRef.current = setInterval(() => {\n        fetchLocation(true);\n      }, mergedOptions.updateInterval);\n    }\n\n    return () => {\n      if (updateIntervalRef.current) {\n        clearInterval(updateIntervalRef.current);\n      }\n    };\n  }, [fetchLocation, mergedOptions.autoUpdate, mergedOptions.updateInterval]);\n\n  // Refresh function\n  const refresh = useCallback(async (forceRefresh = true) => {\n    await fetchLocation(forceRefresh);\n  }, [fetchLocation]);\n\n  // Clear cache function\n  const clearCache = useCallback(() => {\n    clearLocationCache();\n    setLocation(getUnknownLocation());\n  }, []);\n\n  return {\n    location,\n    isLoading,\n    error,\n    permissionState,\n    refresh,\n    clearCache,\n  };\n}\n\n/**\n * Hook for calculating distance between the current user and a seller\n */\nexport function useDistanceToSeller(\n  sellerLat: number | string | null | undefined,\n  sellerLng: number | string | null | undefined,\n  userLat?: number | string | null | undefined,\n  userLng?: number | string | null | undefined\n): {\n  distance: string | null;\n  sellerLocationName: string | null;\n} {\n  const distance = getDistanceToSeller(userLat, userLng, sellerLat, sellerLng);\n  const sellerLocationName = getSellerLocationName(sellerLat, sellerLng);\n\n  return {\n    distance,\n    sellerLocationName,\n  };\n}\n\n/**\n * Hook that returns location info for any user based on their stored coordinates\n */\nexport function useUserLocationInfo(\n  lat: number | string | null | undefined,\n  lng: number | string | null | undefined\n): GeolocationInfo {\n  const parsedLat = typeof lat === 'string' ? parseFloat(lat) : lat;\n  const parsedLng = typeof lng === 'string' ? parseFloat(lng) : lng;\n\n  if (parsedLat == null || isNaN(parsedLat) || parsedLng == null || isNaN(parsedLng)) {\n    return getUnknownLocation();\n  }\n\n  return mapToLocationName(parsedLat, parsedLng);\n}\n\nexport default useGeolocation;\n","path":null,"size_bytes":5871,"size_tokens":null},"client/src/components/LocationBadge.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport { MapPin, School, Map, Globe } from \"lucide-react\";\nimport { \n  type LocationLevel, \n  type GeolocationInfo,\n  getLocationLevelColor,\n  mapToLocationName,\n  getDistanceToSeller\n} from \"@/lib/geolocation\";\nimport { cn } from \"@/lib/utils\";\n\ninterface LocationBadgeProps {\n  locationInfo?: GeolocationInfo | null;\n  latitude?: number | string | null;\n  longitude?: number | string | null;\n  showDistance?: boolean;\n  userLat?: number | string | null;\n  userLng?: number | string | null;\n  className?: string;\n  variant?: \"default\" | \"compact\" | \"distance-only\";\n}\n\nfunction getIconForLevel(level: LocationLevel) {\n  switch (level) {\n    case \"on_campus\":\n      return <School className=\"h-3 w-3\" />;\n    case \"near_campus\":\n    case \"iworoko\":\n    case \"osekita\":\n    case \"ado_ekiti\":\n      return <MapPin className=\"h-3 w-3\" />;\n    case \"ekiti_state\":\n      return <Map className=\"h-3 w-3\" />;\n    default:\n      return <Globe className=\"h-3 w-3\" />;\n  }\n}\n\nexport function LocationBadge({\n  locationInfo,\n  latitude,\n  longitude,\n  showDistance = false,\n  userLat,\n  userLng,\n  className,\n  variant = \"default\",\n}: LocationBadgeProps) {\n  // Get location info from coordinates if not provided directly\n  let info = locationInfo;\n  if (!info && latitude != null && longitude != null) {\n    const lat = typeof latitude === 'string' ? parseFloat(latitude) : latitude;\n    const lng = typeof longitude === 'string' ? parseFloat(longitude) : longitude;\n    if (!isNaN(lat) && !isNaN(lng)) {\n      info = mapToLocationName(lat, lng);\n    }\n  }\n\n  // If no valid location info, don't render anything\n  if (!info || info.locationLevel === \"unknown\") {\n    return null;\n  }\n\n  // Calculate distance if requested\n  let distanceText: string | null = null;\n  if (showDistance && userLat != null && userLng != null && info.latitude != null && info.longitude != null) {\n    distanceText = getDistanceToSeller(userLat, userLng, info.latitude, info.longitude);\n  }\n\n  const colorClasses = getLocationLevelColor(info.locationLevel);\n\n  // Distance-only variant\n  if (variant === \"distance-only\" && distanceText) {\n    return (\n      <Badge \n        variant=\"secondary\" \n        className={cn(\"text-[10px] py-0 px-1.5 gap-0.5\", className)}\n        data-testid=\"badge-distance\"\n      >\n        <MapPin className=\"h-2.5 w-2.5\" />\n        {distanceText}\n      </Badge>\n    );\n  }\n\n  // Compact variant - just icon and short name\n  if (variant === \"compact\") {\n    return (\n      <Badge \n        variant=\"secondary\" \n        className={cn(\"text-[10px] py-0 px-1.5 gap-0.5\", colorClasses, className)}\n        data-testid=\"badge-location-compact\"\n      >\n        {getIconForLevel(info.locationLevel)}\n        <span>{info.shortName}</span>\n        {distanceText && (\n          <span className=\"opacity-75 ml-0.5\">{distanceText}</span>\n        )}\n      </Badge>\n    );\n  }\n\n  // Default variant - full display\n  return (\n    <Badge \n      variant=\"secondary\" \n      className={cn(\"text-xs py-0.5 px-2 gap-1\", colorClasses, className)}\n      data-testid=\"badge-location\"\n    >\n      {getIconForLevel(info.locationLevel)}\n      <span>{info.displayName}</span>\n      {distanceText && (\n        <span className=\"opacity-75 border-l border-current/20 pl-1 ml-1\">\n          {distanceText}\n        </span>\n      )}\n    </Badge>\n  );\n}\n\ninterface DistanceBadgeProps {\n  userLat: number | string | null | undefined;\n  userLng: number | string | null | undefined;\n  sellerLat: number | string | null | undefined;\n  sellerLng: number | string | null | undefined;\n  className?: string;\n}\n\nexport function DistanceBadge({\n  userLat,\n  userLng,\n  sellerLat,\n  sellerLng,\n  className,\n}: DistanceBadgeProps) {\n  const distanceText = getDistanceToSeller(userLat, userLng, sellerLat, sellerLng);\n\n  if (!distanceText) {\n    return null;\n  }\n\n  return (\n    <Badge \n      variant=\"secondary\" \n      className={cn(\"text-[10px] py-0 px-1.5 gap-0.5\", className)}\n      data-testid=\"badge-distance\"\n    >\n      <MapPin className=\"h-2.5 w-2.5\" />\n      {distanceText}\n    </Badge>\n  );\n}\n\ninterface SellerLocationBadgeProps {\n  sellerLat: number | string | null | undefined;\n  sellerLng: number | string | null | undefined;\n  sellerLocation?: string | null;\n  userLat?: number | string | null | undefined;\n  userLng?: number | string | null | undefined;\n  showDistance?: boolean;\n  className?: string;\n}\n\nexport function SellerLocationBadge({\n  sellerLat,\n  sellerLng,\n  sellerLocation,\n  userLat,\n  userLng,\n  showDistance = true,\n  className,\n}: SellerLocationBadgeProps) {\n  // If we have coordinates, show GPS-based location\n  if (sellerLat != null && sellerLng != null) {\n    return (\n      <LocationBadge\n        latitude={sellerLat}\n        longitude={sellerLng}\n        showDistance={showDistance}\n        userLat={userLat}\n        userLng={userLng}\n        variant=\"compact\"\n        className={className}\n      />\n    );\n  }\n\n  // Fallback to text-based location\n  if (sellerLocation) {\n    return (\n      <Badge \n        variant=\"secondary\" \n        className={cn(\"text-[10px] py-0 px-1.5 gap-0.5\", className)}\n        data-testid=\"badge-location-text\"\n      >\n        <MapPin className=\"h-2.5 w-2.5\" />\n        <span className=\"truncate max-w-[80px]\">{sellerLocation}</span>\n      </Badge>\n    );\n  }\n\n  return null;\n}\n\nexport default LocationBadge;\n","path":null,"size_bytes":5368,"size_tokens":null},"client/src/lib/geolocation.ts":{"content":"/**\n * Geolocation utility for EKSU Digital Marketplace\n * Handles GPS coordinates, campus location mapping, and distance calculations\n */\n\nexport interface CampusLocation {\n  id: string;\n  name: string;\n  latitude: number;\n  longitude: number;\n  radiusKm: number;\n}\n\nexport const CAMPUS_LOCATIONS: CampusLocation[] = [\n  {\n    id: \"eksu_campus\",\n    name: \"EKSU Campus\",\n    latitude: 7.6556,\n    longitude: 5.2247,\n    radiusKm: 1.5,\n  },\n  {\n    id: \"ado_ekiti\",\n    name: \"Ado Ekiti\",\n    latitude: 7.6211,\n    longitude: 5.2207,\n    radiusKm: 8,\n  },\n  {\n    id: \"iworoko\",\n    name: \"Iworoko\",\n    latitude: 7.6789,\n    longitude: 5.2456,\n    radiusKm: 2,\n  },\n  {\n    id: \"osekita\",\n    name: \"Osekita\",\n    latitude: 7.6323,\n    longitude: 5.1956,\n    radiusKm: 1.5,\n  },\n];\n\nexport const EKSU_MAIN_CAMPUS = CAMPUS_LOCATIONS.find(l => l.id === \"eksu_campus\")!;\n\nexport type LocationLevel = \n  | \"on_campus\" \n  | \"near_campus\" \n  | \"iworoko\" \n  | \"osekita\" \n  | \"ado_ekiti\" \n  | \"ekiti_state\" \n  | \"far_away\" \n  | \"unknown\";\n\nexport interface GeolocationInfo {\n  latitude: number | null;\n  longitude: number | null;\n  accuracy: number | null;\n  timestamp: number | null;\n  displayName: string;\n  shortName: string;\n  distanceFromCampus: number | null;\n  locationLevel: LocationLevel;\n  nearestLocation: CampusLocation | null;\n  isOnCampus: boolean;\n}\n\n/**\n * Calculate the distance between two geographic coordinates using the Haversine formula\n * @returns Distance in kilometers\n */\nexport function calculateHaversineDistance(\n  lat1: number,\n  lon1: number,\n  lat2: number,\n  lon2: number\n): number {\n  const R = 6371; // Earth's radius in kilometers\n  \n  const toRad = (deg: number) => deg * (Math.PI / 180);\n  \n  const dLat = toRad(lat2 - lat1);\n  const dLon = toRad(lon2 - lon1);\n  \n  const a =\n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *\n    Math.sin(dLon / 2) * Math.sin(dLon / 2);\n  \n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  \n  return R * c;\n}\n\n/**\n * Format distance for display\n */\nexport function formatDistance(distanceInKm: number): string {\n  if (distanceInKm < 0.1) {\n    return \"< 100m\";\n  } else if (distanceInKm < 1) {\n    const meters = Math.round(distanceInKm * 1000);\n    return `${meters}m`;\n  } else if (distanceInKm < 10) {\n    return `${distanceInKm.toFixed(1)}km`;\n  } else {\n    return `${Math.round(distanceInKm)}km`;\n  }\n}\n\n/**\n * Find the nearest campus location to given coordinates\n */\nexport function findNearestLocation(lat: number, lng: number): { location: CampusLocation; distance: number } | null {\n  let nearestLocation: CampusLocation | null = null;\n  let minDistance = Infinity;\n\n  for (const location of CAMPUS_LOCATIONS) {\n    const distance = calculateHaversineDistance(lat, lng, location.latitude, location.longitude);\n    if (distance < minDistance) {\n      minDistance = distance;\n      nearestLocation = location;\n    }\n  }\n\n  if (nearestLocation) {\n    return { location: nearestLocation, distance: minDistance };\n  }\n  return null;\n}\n\n/**\n * Map coordinates to a known campus location\n */\nexport function mapToLocationName(lat: number, lng: number): GeolocationInfo {\n  const distanceFromCampus = calculateHaversineDistance(lat, lng, EKSU_MAIN_CAMPUS.latitude, EKSU_MAIN_CAMPUS.longitude);\n  const nearest = findNearestLocation(lat, lng);\n  \n  // Check EKSU Campus first (priority)\n  if (distanceFromCampus <= EKSU_MAIN_CAMPUS.radiusKm) {\n    return {\n      latitude: lat,\n      longitude: lng,\n      accuracy: null,\n      timestamp: Date.now(),\n      displayName: \"EKSU Campus\",\n      shortName: \"Campus\",\n      distanceFromCampus,\n      locationLevel: \"on_campus\",\n      nearestLocation: EKSU_MAIN_CAMPUS,\n      isOnCampus: true,\n    };\n  }\n\n  // Check if near campus (within 3km)\n  if (distanceFromCampus <= 3) {\n    return {\n      latitude: lat,\n      longitude: lng,\n      accuracy: null,\n      timestamp: Date.now(),\n      displayName: `${formatDistance(distanceFromCampus)} from EKSU`,\n      shortName: \"Near EKSU\",\n      distanceFromCampus,\n      locationLevel: \"near_campus\",\n      nearestLocation: EKSU_MAIN_CAMPUS,\n      isOnCampus: false,\n    };\n  }\n\n  // Check Iworoko\n  const iworoko = CAMPUS_LOCATIONS.find(l => l.id === \"iworoko\")!;\n  const distanceFromIworoko = calculateHaversineDistance(lat, lng, iworoko.latitude, iworoko.longitude);\n  if (distanceFromIworoko <= iworoko.radiusKm) {\n    return {\n      latitude: lat,\n      longitude: lng,\n      accuracy: null,\n      timestamp: Date.now(),\n      displayName: \"Iworoko\",\n      shortName: \"Iworoko\",\n      distanceFromCampus,\n      locationLevel: \"iworoko\",\n      nearestLocation: iworoko,\n      isOnCampus: false,\n    };\n  }\n\n  // Check Osekita\n  const osekita = CAMPUS_LOCATIONS.find(l => l.id === \"osekita\")!;\n  const distanceFromOsekita = calculateHaversineDistance(lat, lng, osekita.latitude, osekita.longitude);\n  if (distanceFromOsekita <= osekita.radiusKm) {\n    return {\n      latitude: lat,\n      longitude: lng,\n      accuracy: null,\n      timestamp: Date.now(),\n      displayName: \"Osekita\",\n      shortName: \"Osekita\",\n      distanceFromCampus,\n      locationLevel: \"osekita\",\n      nearestLocation: osekita,\n      isOnCampus: false,\n    };\n  }\n\n  // Check Ado Ekiti (larger radius, lower priority)\n  const adoEkiti = CAMPUS_LOCATIONS.find(l => l.id === \"ado_ekiti\")!;\n  const distanceFromAdo = calculateHaversineDistance(lat, lng, adoEkiti.latitude, adoEkiti.longitude);\n  if (distanceFromAdo <= adoEkiti.radiusKm) {\n    return {\n      latitude: lat,\n      longitude: lng,\n      accuracy: null,\n      timestamp: Date.now(),\n      displayName: \"Ado Ekiti\",\n      shortName: \"Ado\",\n      distanceFromCampus,\n      locationLevel: \"ado_ekiti\",\n      nearestLocation: adoEkiti,\n      isOnCampus: false,\n    };\n  }\n\n  // Check if still in Ekiti State (within ~50km of Ado)\n  if (distanceFromAdo <= 50) {\n    return {\n      latitude: lat,\n      longitude: lng,\n      accuracy: null,\n      timestamp: Date.now(),\n      displayName: \"Ekiti State\",\n      shortName: \"Ekiti\",\n      distanceFromCampus,\n      locationLevel: \"ekiti_state\",\n      nearestLocation: nearest?.location || null,\n      isOnCampus: false,\n    };\n  }\n\n  // Far away\n  return {\n    latitude: lat,\n    longitude: lng,\n    accuracy: null,\n    timestamp: Date.now(),\n    displayName: `${formatDistance(distanceFromCampus)} away`,\n    shortName: \"Far\",\n    distanceFromCampus,\n    locationLevel: \"far_away\",\n    nearestLocation: nearest?.location || null,\n    isOnCampus: false,\n  };\n}\n\n/**\n * Get an unknown location placeholder\n */\nexport function getUnknownLocation(): GeolocationInfo {\n  return {\n    latitude: null,\n    longitude: null,\n    accuracy: null,\n    timestamp: null,\n    displayName: \"\",\n    shortName: \"\",\n    distanceFromCampus: null,\n    locationLevel: \"unknown\",\n    nearestLocation: null,\n    isOnCampus: false,\n  };\n}\n\n/**\n * Calculate distance between user and seller\n * @returns Formatted distance string or null if coordinates are invalid\n */\nexport function getDistanceToSeller(\n  userLat: number | string | null | undefined,\n  userLng: number | string | null | undefined,\n  sellerLat: number | string | null | undefined,\n  sellerLng: number | string | null | undefined\n): string | null {\n  const parsedUserLat = typeof userLat === 'string' ? parseFloat(userLat) : userLat;\n  const parsedUserLng = typeof userLng === 'string' ? parseFloat(userLng) : userLng;\n  const parsedSellerLat = typeof sellerLat === 'string' ? parseFloat(sellerLat) : sellerLat;\n  const parsedSellerLng = typeof sellerLng === 'string' ? parseFloat(sellerLng) : sellerLng;\n\n  if (\n    parsedUserLat == null || isNaN(parsedUserLat) ||\n    parsedUserLng == null || isNaN(parsedUserLng) ||\n    parsedSellerLat == null || isNaN(parsedSellerLat) ||\n    parsedSellerLng == null || isNaN(parsedSellerLng)\n  ) {\n    return null;\n  }\n\n  const distance = calculateHaversineDistance(\n    parsedUserLat,\n    parsedUserLng,\n    parsedSellerLat,\n    parsedSellerLng\n  );\n\n  return formatDistance(distance);\n}\n\n/**\n * Get seller's location display name from coordinates\n */\nexport function getSellerLocationName(\n  sellerLat: number | string | null | undefined,\n  sellerLng: number | string | null | undefined\n): string | null {\n  const parsedLat = typeof sellerLat === 'string' ? parseFloat(sellerLat) : sellerLat;\n  const parsedLng = typeof sellerLng === 'string' ? parseFloat(sellerLng) : sellerLng;\n\n  if (parsedLat == null || isNaN(parsedLat) || parsedLng == null || isNaN(parsedLng)) {\n    return null;\n  }\n\n  const locationInfo = mapToLocationName(parsedLat, parsedLng);\n  return locationInfo.shortName || locationInfo.displayName;\n}\n\n// Geolocation caching\nlet cachedPosition: GeolocationInfo | null = null;\nlet lastFetchTime: number = 0;\nconst CACHE_DURATION_MS = 5 * 60 * 1000; // 5 minutes\n\n/**\n * Get current position using browser geolocation API\n * Returns cached result if available and not expired\n */\nexport async function getCurrentPosition(options?: {\n  enableHighAccuracy?: boolean;\n  timeout?: number;\n  maximumAge?: number;\n  forceRefresh?: boolean;\n}): Promise<GeolocationInfo> {\n  const {\n    enableHighAccuracy = false,\n    timeout = 10000,\n    maximumAge = 300000,\n    forceRefresh = false,\n  } = options || {};\n\n  // Return cached position if valid and not forcing refresh\n  if (!forceRefresh && cachedPosition && Date.now() - lastFetchTime < CACHE_DURATION_MS) {\n    return cachedPosition;\n  }\n\n  // Check if geolocation is supported\n  if (!navigator.geolocation) {\n    return getUnknownLocation();\n  }\n\n  try {\n    const position = await new Promise<GeolocationPosition>((resolve, reject) => {\n      navigator.geolocation.getCurrentPosition(\n        resolve,\n        reject,\n        {\n          enableHighAccuracy,\n          timeout,\n          maximumAge,\n        }\n      );\n    });\n\n    const locationInfo = mapToLocationName(\n      position.coords.latitude,\n      position.coords.longitude\n    );\n\n    // Add accuracy info\n    locationInfo.accuracy = position.coords.accuracy;\n    locationInfo.timestamp = position.timestamp;\n\n    // Cache the result\n    cachedPosition = locationInfo;\n    lastFetchTime = Date.now();\n\n    return locationInfo;\n  } catch (error) {\n    // Try fallback to IP-based location\n    try {\n      const response = await fetch('https://ipapi.co/json/', {\n        signal: AbortSignal.timeout(5000),\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        if (data.latitude && data.longitude) {\n          const locationInfo = mapToLocationName(data.latitude, data.longitude);\n          cachedPosition = locationInfo;\n          lastFetchTime = Date.now();\n          return locationInfo;\n        }\n      }\n    } catch {\n      // IP lookup failed silently\n    }\n\n    return getUnknownLocation();\n  }\n}\n\n/**\n * Clear cached position\n */\nexport function clearLocationCache(): void {\n  cachedPosition = null;\n  lastFetchTime = 0;\n}\n\n/**\n * Get location level color for styling\n */\nexport function getLocationLevelColor(level: LocationLevel): string {\n  switch (level) {\n    case \"on_campus\":\n      return \"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400\";\n    case \"near_campus\":\n      return \"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400\";\n    case \"iworoko\":\n    case \"osekita\":\n      return \"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400\";\n    case \"ado_ekiti\":\n      return \"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400\";\n    case \"ekiti_state\":\n      return \"bg-gray-100 text-gray-800 dark:bg-gray-800/30 dark:text-gray-400\";\n    case \"far_away\":\n      return \"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400\";\n    default:\n      return \"bg-muted text-muted-foreground\";\n  }\n}\n\n/**\n * Get location icon name for display\n */\nexport function getLocationIcon(level: LocationLevel): \"school\" | \"map-pin\" | \"map\" | \"globe\" {\n  switch (level) {\n    case \"on_campus\":\n      return \"school\";\n    case \"near_campus\":\n    case \"iworoko\":\n    case \"osekita\":\n    case \"ado_ekiti\":\n      return \"map-pin\";\n    case \"ekiti_state\":\n      return \"map\";\n    default:\n      return \"globe\";\n  }\n}\n","path":null,"size_bytes":12221,"size_tokens":null},"client/src/components/EmailVerificationBanner.tsx":{"content":"import { AlertCircle, Mail, X } from \"lucide-react\";\nimport { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\nconst BANNER_DISMISS_KEY = \"eksu_email_verify_dismissed\";\nconst BANNER_DISMISS_DURATION = 24 * 60 * 60 * 1000; // 24 hours in ms\n\ninterface EmailVerificationBannerProps {\n  email?: string;\n  onDismiss?: () => void;\n}\n\nfunction isDismissedInStorage(): boolean {\n  try {\n    const dismissed = localStorage.getItem(BANNER_DISMISS_KEY);\n    if (!dismissed) return false;\n    \n    const dismissedAt = parseInt(dismissed, 10);\n    const now = Date.now();\n    \n    // Check if dismissal has expired (24 hours)\n    if (now - dismissedAt > BANNER_DISMISS_DURATION) {\n      localStorage.removeItem(BANNER_DISMISS_KEY);\n      return false;\n    }\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nfunction setDismissedInStorage(): void {\n  try {\n    localStorage.setItem(BANNER_DISMISS_KEY, Date.now().toString());\n  } catch {\n    // Ignore storage errors\n  }\n}\n\nexport function EmailVerificationBanner({ email, onDismiss }: EmailVerificationBannerProps) {\n  const [isResending, setIsResending] = useState(false);\n  const [isDismissed, setIsDismissed] = useState(() => isDismissedInStorage());\n  const { toast } = useToast();\n\n  const handleResendVerification = async () => {\n    setIsResending(true);\n    try {\n      await apiRequest(\"POST\", \"/api/auth/resend-verification\");\n      toast({\n        title: \"Verification email sent\",\n        description: \"Please check your inbox for the verification link.\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Failed to send verification\",\n        description: error.message || \"Please try again later.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsResending(false);\n    }\n  };\n\n  const handleDismiss = () => {\n    setDismissedInStorage();\n    setIsDismissed(true);\n    onDismiss?.();\n  };\n\n  if (isDismissed) {\n    return null;\n  }\n\n  return (\n    <Alert \n      className=\"border-amber-500/50 bg-amber-50 dark:bg-amber-950/20 mb-4 relative\"\n      data-testid=\"alert-email-verification\"\n    >\n      <AlertCircle className=\"h-4 w-4 text-amber-600 dark:text-amber-400\" />\n      <AlertDescription className=\"flex flex-wrap items-center justify-between gap-2 ml-2\">\n        <div className=\"flex-1 text-amber-800 dark:text-amber-200\">\n          <span className=\"font-medium\">Email not verified.</span>\n          <span className=\"ml-1 text-amber-700 dark:text-amber-300\">\n            Verify your email to access all features. Unverified accounts are limited to 3 listings and cannot message, buy, or post in The Plug.\n          </span>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Button\n            size=\"sm\"\n            variant=\"outline\"\n            onClick={handleResendVerification}\n            disabled={isResending}\n            className=\"border-amber-500 text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/30\"\n            data-testid=\"button-resend-verification\"\n          >\n            <Mail className=\"h-4 w-4 mr-1\" />\n            {isResending ? \"Sending...\" : \"Resend Email\"}\n          </Button>\n          <Button\n            size=\"icon\"\n            variant=\"ghost\"\n            onClick={handleDismiss}\n            className=\"h-8 w-8 text-amber-600 hover:bg-amber-100 dark:hover:bg-amber-900/30\"\n            data-testid=\"button-dismiss-verification-banner\"\n          >\n            <X className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </AlertDescription>\n    </Alert>\n  );\n}\n","path":null,"size_bytes":3751,"size_tokens":null},"client/src/pages/secret-hub.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Eye,\n  Lock,\n  MessageCircle,\n  Sparkles,\n  ArrowRight,\n  Shield,\n  User,\n  Ghost,\n  Link2,\n  Copy,\n  Check\n} from \"lucide-react\";\n\nexport default function SecretHubPage() {\n  const [copied, setCopied] = useState(false);\n  const baseUrl = typeof window !== \"undefined\" ? window.location.origin : \"\";\n\n  const copyLink = () => {\n    navigator.clipboard.writeText(baseUrl + \"/secret\");\n    setCopied(true);\n    setTimeout(() => setCopied(false), 2000);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-zinc-950 via-purple-950/20 to-zinc-950\">\n      <div className=\"max-w-2xl mx-auto px-4 py-12\">\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5 }}\n          className=\"text-center mb-12\"\n        >\n          <div className=\"inline-flex items-center justify-center w-20 h-20 rounded-full bg-purple-500/20 border border-purple-500/30 mb-6\">\n            <Ghost className=\"h-10 w-10 text-purple-400\" />\n          </div>\n          <h1 className=\"text-3xl md:text-4xl font-bold text-white mb-4\">\n            Anonymous Secret Messages\n          </h1>\n          <p className=\"text-lg text-purple-200/70\">\n            Send and receive anonymous messages. Complete privacy guaranteed.\n          </p>\n        </motion.div>\n\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.1, duration: 0.5 }}\n          className=\"grid gap-4 mb-8\"\n        >\n          <Card className=\"bg-zinc-900/80 border-purple-500/20 hover:border-purple-500/40 transition-colors\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start gap-4\">\n                <div className=\"w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center flex-shrink-0\">\n                  <Eye className=\"h-6 w-6 text-purple-400\" />\n                </div>\n                <div className=\"flex-1\">\n                  <h3 className=\"text-lg font-semibold text-white mb-2\">\n                    100% Anonymous\n                  </h3>\n                  <p className=\"text-sm text-gray-400\">\n                    Your identity is completely hidden. The recipient will never know who sent the message.\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"bg-zinc-900/80 border-purple-500/20 hover:border-purple-500/40 transition-colors\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start gap-4\">\n                <div className=\"w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center flex-shrink-0\">\n                  <Lock className=\"h-6 w-6 text-purple-400\" />\n                </div>\n                <div className=\"flex-1\">\n                  <h3 className=\"text-lg font-semibold text-white mb-2\">\n                    End-to-End Privacy\n                  </h3>\n                  <p className=\"text-sm text-gray-400\">\n                    No tracking, no logs. Your messages are private between you and the recipient.\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"bg-zinc-900/80 border-purple-500/20 hover:border-purple-500/40 transition-colors\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start gap-4\">\n                <div className=\"w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center flex-shrink-0\">\n                  <Link2 className=\"h-6 w-6 text-purple-400\" />\n                </div>\n                <div className=\"flex-1\">\n                  <h3 className=\"text-lg font-semibold text-white mb-2\">\n                    Create Your Link\n                  </h3>\n                  <p className=\"text-sm text-gray-400\">\n                    Sign in to create your personal anonymous message link and share it anywhere.\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </motion.div>\n\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.2, duration: 0.5 }}\n          className=\"space-y-4\"\n        >\n          <Link href=\"/api/login\">\n            <Button \n              className=\"w-full bg-purple-600 hover:bg-purple-700 text-white py-6 text-lg\"\n              data-testid=\"button-login-secret\"\n            >\n              <User className=\"h-5 w-5 mr-2\" />\n              Sign In to Get Started\n              <ArrowRight className=\"h-5 w-5 ml-2\" />\n            </Button>\n          </Link>\n\n          <div className=\"text-center\">\n            <p className=\"text-sm text-gray-500 mb-2\">Or share this page</p>\n            <Button \n              variant=\"outline\" \n              onClick={copyLink}\n              className=\"bg-zinc-900/50 border-purple-500/30 text-purple-300 hover:bg-purple-500/10\"\n              data-testid=\"button-copy-hub-link\"\n            >\n              {copied ? (\n                <>\n                  <Check className=\"h-4 w-4 mr-2\" />\n                  Link Copied!\n                </>\n              ) : (\n                <>\n                  <Copy className=\"h-4 w-4 mr-2\" />\n                  Copy Page Link\n                </>\n              )}\n            </Button>\n          </div>\n        </motion.div>\n\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          transition={{ delay: 0.4, duration: 0.5 }}\n          className=\"mt-12 pt-8 border-t border-purple-500/10\"\n        >\n          <div className=\"flex items-center justify-center gap-2 text-sm text-gray-500\">\n            <Shield className=\"h-4 w-4\" />\n            <span>Part of EKSU Marketplace</span>\n          </div>\n          <p className=\"text-center text-xs text-gray-600 mt-2\">\n            Powered by secure, anonymous messaging technology\n          </p>\n        </motion.div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6314,"size_tokens":null},"client/src/components/VerificationBadge.tsx":{"content":"import { BadgeCheck, Crown, Store, Shield } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\n\nexport type VerificationType = \"verified\" | \"official\" | \"seller\" | \"admin\";\n\ninterface VerificationBadgeProps {\n  type: VerificationType;\n  size?: \"sm\" | \"md\" | \"lg\";\n  showTooltip?: boolean;\n  className?: string;\n}\n\nconst badgeConfig = {\n  verified: {\n    icon: BadgeCheck,\n    color: \"text-blue-500\",\n    bgColor: \"bg-blue-500/10\",\n    label: \"Verified User\",\n    description: \"This user has been verified\",\n  },\n  official: {\n    icon: Crown,\n    color: \"text-purple-500\",\n    bgColor: \"bg-purple-500/10\",\n    label: \"Official Campus Account\",\n    description: \"Official EKSU campus account\",\n  },\n  seller: {\n    icon: Store,\n    color: \"text-amber-500\",\n    bgColor: \"bg-amber-500/10\",\n    label: \"Verified Seller\",\n    description: \"Trusted seller on the marketplace\",\n  },\n  admin: {\n    icon: Shield,\n    color: \"text-red-500\",\n    bgColor: \"bg-red-500/10\",\n    label: \"Admin\",\n    description: \"Platform administrator\",\n  },\n};\n\nconst sizeClasses = {\n  sm: \"h-3.5 w-3.5\",\n  md: \"h-4 w-4\",\n  lg: \"h-5 w-5\",\n};\n\nexport function VerificationBadge({ \n  type, \n  size = \"md\", \n  showTooltip = true,\n  className \n}: VerificationBadgeProps) {\n  const config = badgeConfig[type];\n  const Icon = config.icon;\n\n  const badge = (\n    <span \n      className={cn(\"inline-flex items-center\", className)}\n      data-testid={`badge-${type}`}\n    >\n      <Icon className={cn(sizeClasses[size], config.color)} />\n    </span>\n  );\n\n  if (!showTooltip) {\n    return badge;\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>\n        {badge}\n      </TooltipTrigger>\n      <TooltipContent side=\"top\" className=\"text-xs\">\n        <p className=\"font-medium\">{config.label}</p>\n        <p className=\"text-muted-foreground\">{config.description}</p>\n      </TooltipContent>\n    </Tooltip>\n  );\n}\n\nexport function getUserBadgeType(user: {\n  isVerified?: boolean;\n  isSeller?: boolean;\n  isAdmin?: boolean;\n  isOfficial?: boolean;\n  role?: string;\n}): VerificationType | null {\n  if (user.isAdmin || user.role === 'admin') return 'admin';\n  if (user.isOfficial) return 'official';\n  if (user.isSeller) return 'seller';\n  if (user.isVerified) return 'verified';\n  return null;\n}\n\nexport function UserBadges({ user, size = \"md\" }: { \n  user: {\n    isVerified?: boolean;\n    isSeller?: boolean;\n    isAdmin?: boolean;\n    isOfficial?: boolean;\n    role?: string;\n  };\n  size?: \"sm\" | \"md\" | \"lg\";\n}) {\n  const badges: VerificationType[] = [];\n  \n  if (user.isAdmin || user.role === 'admin') badges.push('admin');\n  if (user.isOfficial) badges.push('official');\n  if (user.isSeller) badges.push('seller');\n  if (user.isVerified && !user.isOfficial && !user.isAdmin) badges.push('verified');\n\n  if (badges.length === 0) return null;\n\n  return (\n    <span className=\"inline-flex items-center gap-0.5\">\n      {badges.map((type) => (\n        <VerificationBadge key={type} type={type} size={size} />\n      ))}\n    </span>\n  );\n}\n","path":null,"size_bytes":3093,"size_tokens":null},"client/src/pages/hostels.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetHeader,\n  SheetTitle,\n  SheetTrigger,\n} from \"@/components/ui/sheet\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Search,\n  Filter,\n  Home,\n  MapPin,\n  Bed,\n  Bath,\n  Eye,\n  Plus,\n  Loader2,\n  MessageCircle,\n  ChevronLeft,\n  ChevronRight,\n  X,\n  Wifi,\n  Zap,\n  Droplets,\n  Shield,\n  Car,\n  Building2,\n  ImageIcon,\n  Phone,\n} from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport type { Hostel, User } from \"@shared/schema\";\nimport { Link } from \"wouter\";\n\ntype HostelWithAgent = Hostel & { agent: User };\n\nconst LOCATIONS = [\n  { value: \"all\", label: \"All Locations\" },\n  { value: \"Campus Gate\", label: \"Campus Gate\" },\n  { value: \"Oke-Oja\", label: \"Oke-Oja\" },\n  { value: \"Temidire\", label: \"Temidire\" },\n  { value: \"Iworoko Road\", label: \"Iworoko Road\" },\n  { value: \"Basiri\", label: \"Basiri\" },\n  { value: \"Ajilosun\", label: \"Ajilosun\" },\n  { value: \"Adebayo\", label: \"Adebayo\" },\n  { value: \"Fajuyi\", label: \"Fajuyi\" },\n  { value: \"Stadium Road\", label: \"Stadium Road\" },\n  { value: \"NTA Road\", label: \"NTA Road\" },\n  { value: \"Ijigbo\", label: \"Ijigbo\" },\n  { value: \"Oroke\", label: \"Oroke\" },\n];\n\nconst BEDROOMS = [\n  { value: \"all\", label: \"Any Rooms\" },\n  { value: \"1\", label: \"1 Bedroom (Self-contain)\" },\n  { value: \"2\", label: \"2 Bedrooms\" },\n  { value: \"3\", label: \"3 Bedrooms\" },\n  { value: \"4\", label: \"4+ Bedrooms\" },\n];\n\nconst AMENITIES = [\n  { value: \"wifi\", label: \"WiFi\", icon: Wifi },\n  { value: \"electricity\", label: \"24/7 Electricity\", icon: Zap },\n  { value: \"water\", label: \"Running Water\", icon: Droplets },\n  { value: \"security\", label: \"Security\", icon: Shield },\n  { value: \"parking\", label: \"Parking Space\", icon: Car },\n  { value: \"tiles\", label: \"Tiled Floor\", icon: Building2 },\n  { value: \"wardrobe\", label: \"Wardrobe\", icon: Building2 },\n  { value: \"kitchen\", label: \"Kitchen\", icon: Building2 },\n  { value: \"bathroom_ensuite\", label: \"Ensuite Bathroom\", icon: Bath },\n  { value: \"borehole\", label: \"Borehole\", icon: Droplets },\n  { value: \"generator\", label: \"Generator\", icon: Zap },\n  { value: \"prepaid_meter\", label: \"Prepaid Meter\", icon: Zap },\n];\n\nfunction getAmenityIcon(amenity: string) {\n  const found = AMENITIES.find(a => a.value === amenity);\n  return found?.icon || Building2;\n}\n\nfunction HostelCard({ \n  hostel, \n  onView, \n}: { \n  hostel: Hostel;\n  onView: (hostel: Hostel) => void;\n}) {\n  const [currentImageIndex, setCurrentImageIndex] = useState(0);\n  const images = hostel.images || [];\n  const hasImages = images.length > 0;\n  const price = parseFloat(hostel.price || \"0\");\n\n  const nextImage = (e: React.MouseEvent) => {\n    e.stopPropagation();\n    setCurrentImageIndex((prev) => (prev + 1) % images.length);\n  };\n\n  const prevImage = (e: React.MouseEvent) => {\n    e.stopPropagation();\n    setCurrentImageIndex((prev) => (prev - 1 + images.length) % images.length);\n  };\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, y: -20 }}\n      transition={{ duration: 0.3 }}\n    >\n      <Card \n        className=\"overflow-visible cursor-pointer transition-all duration-200\" \n        onClick={() => onView(hostel)}\n        data-testid={`card-hostel-${hostel.id}`}\n      >\n        <div className=\"relative aspect-[4/3] bg-muted rounded-t-lg overflow-hidden\">\n          {hasImages ? (\n            <>\n              <img \n                src={images[currentImageIndex]} \n                alt={hostel.title}\n                className=\"w-full h-full object-cover\"\n              />\n              {images.length > 1 && (\n                <>\n                  <Button \n                    size=\"icon\" \n                    variant=\"secondary\"\n                    className=\"absolute left-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity h-7 w-7\"\n                    onClick={prevImage}\n                  >\n                    <ChevronLeft className=\"h-4 w-4\" />\n                  </Button>\n                  <Button \n                    size=\"icon\" \n                    variant=\"secondary\"\n                    className=\"absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity h-7 w-7\"\n                    onClick={nextImage}\n                  >\n                    <ChevronRight className=\"h-4 w-4\" />\n                  </Button>\n                  <div className=\"absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1\">\n                    {images.map((_, idx) => (\n                      <div \n                        key={idx}\n                        className={`w-1.5 h-1.5 rounded-full ${idx === currentImageIndex ? 'bg-white' : 'bg-white/50'}`}\n                      />\n                    ))}\n                  </div>\n                </>\n              )}\n            </>\n          ) : (\n            <div className=\"w-full h-full flex items-center justify-center\">\n              <ImageIcon className=\"h-12 w-12 text-muted-foreground/50\" />\n            </div>\n          )}\n          <Badge className=\"absolute top-2 right-2 bg-background/90 text-foreground\">\n            {\"\\u20A6\"}{price.toLocaleString()}/yr\n          </Badge>\n        </div>\n        <CardContent className=\"p-4\">\n          <h3 className=\"font-semibold text-sm truncate\" data-testid={`text-title-${hostel.id}`}>\n            {hostel.title}\n          </h3>\n          <div className=\"flex items-center gap-1 text-xs text-muted-foreground mt-1\">\n            <MapPin className=\"h-3 w-3\" />\n            <span className=\"truncate\">{hostel.location}</span>\n          </div>\n          \n          <div className=\"flex items-center gap-4 mt-3 text-xs text-muted-foreground\">\n            {hostel.bedrooms && (\n              <span className=\"flex items-center gap-1\">\n                <Bed className=\"h-3 w-3\" />\n                {hostel.bedrooms} {hostel.bedrooms === 1 ? 'Bed' : 'Beds'}\n              </span>\n            )}\n            {hostel.bathrooms && (\n              <span className=\"flex items-center gap-1\">\n                <Bath className=\"h-3 w-3\" />\n                {hostel.bathrooms} {hostel.bathrooms === 1 ? 'Bath' : 'Baths'}\n              </span>\n            )}\n            <span className=\"flex items-center gap-1 ml-auto\">\n              <Eye className=\"h-3 w-3\" />\n              {hostel.views || 0}\n            </span>\n          </div>\n\n          {hostel.amenities && hostel.amenities.length > 0 && (\n            <div className=\"flex flex-wrap gap-1 mt-2\">\n              {hostel.amenities.slice(0, 3).map((amenity) => (\n                <Badge key={amenity} variant=\"outline\" className=\"text-xs\">\n                  {AMENITIES.find(a => a.value === amenity)?.label || amenity}\n                </Badge>\n              ))}\n              {hostel.amenities.length > 3 && (\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  +{hostel.amenities.length - 3} more\n                </Badge>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nfunction HostelCardSkeleton() {\n  return (\n    <Card>\n      <Skeleton className=\"aspect-[4/3] rounded-t-lg\" />\n      <CardContent className=\"p-4\">\n        <Skeleton className=\"h-4 w-3/4 mb-2\" />\n        <Skeleton className=\"h-3 w-1/2 mb-3\" />\n        <div className=\"flex gap-4 mb-2\">\n          <Skeleton className=\"h-3 w-16\" />\n          <Skeleton className=\"h-3 w-16\" />\n        </div>\n        <div className=\"flex gap-1\">\n          <Skeleton className=\"h-5 w-12\" />\n          <Skeleton className=\"h-5 w-12\" />\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction CreateHostelDialog({ \n  open, \n  onOpenChange, \n  onSuccess \n}: { \n  open: boolean; \n  onOpenChange: (open: boolean) => void;\n  onSuccess: () => void;\n}) {\n  const { toast } = useToast();\n  const [images, setImages] = useState<File[]>([]);\n  const [selectedAmenities, setSelectedAmenities] = useState<string[]>([]);\n  const [formData, setFormData] = useState({\n    title: \"\",\n    description: \"\",\n    location: \"\",\n    address: \"\",\n    price: \"\",\n    bedrooms: \"1\",\n    bathrooms: \"1\",\n    distanceFromCampus: \"\",\n    agentFee: \"\",\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: FormData) => {\n      const response = await fetch(\"/api/hostels\", {\n        method: \"POST\",\n        body: data,\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to create listing\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Success\", description: \"Hostel listing created successfully!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/hostels\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/hostels/my-listings\"] });\n      onSuccess();\n      onOpenChange(false);\n      resetForm();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const resetForm = () => {\n    setImages([]);\n    setSelectedAmenities([]);\n    setFormData({\n      title: \"\",\n      description: \"\",\n      location: \"\",\n      address: \"\",\n      price: \"\",\n      bedrooms: \"1\",\n      bathrooms: \"1\",\n      distanceFromCampus: \"\",\n      agentFee: \"\",\n    });\n  };\n\n  const handleSubmit = () => {\n    if (!formData.title.trim()) {\n      toast({ title: \"Error\", description: \"Please enter a title\", variant: \"destructive\" });\n      return;\n    }\n    if (!formData.description.trim()) {\n      toast({ title: \"Error\", description: \"Please enter a description\", variant: \"destructive\" });\n      return;\n    }\n    if (!formData.location) {\n      toast({ title: \"Error\", description: \"Please select a location\", variant: \"destructive\" });\n      return;\n    }\n    if (!formData.price.trim()) {\n      toast({ title: \"Error\", description: \"Please enter a price\", variant: \"destructive\" });\n      return;\n    }\n\n    const data = new FormData();\n    images.forEach((image) => {\n      data.append(\"images\", image);\n    });\n    data.append(\"title\", formData.title);\n    data.append(\"description\", formData.description);\n    data.append(\"location\", formData.location);\n    data.append(\"address\", formData.address);\n    data.append(\"price\", formData.price);\n    data.append(\"bedrooms\", formData.bedrooms);\n    data.append(\"bathrooms\", formData.bathrooms);\n    data.append(\"distanceFromCampus\", formData.distanceFromCampus);\n    data.append(\"agentFee\", formData.agentFee);\n    data.append(\"amenities\", JSON.stringify(selectedAmenities));\n\n    createMutation.mutate(data);\n  };\n\n  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (files) {\n      const newImages = Array.from(files);\n      if (images.length + newImages.length > 10) {\n        toast({ title: \"Error\", description: \"Maximum 10 images allowed\", variant: \"destructive\" });\n        return;\n      }\n      setImages(prev => [...prev, ...newImages]);\n    }\n  };\n\n  const removeImage = (index: number) => {\n    setImages(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const toggleAmenity = (amenity: string) => {\n    setSelectedAmenities(prev => \n      prev.includes(amenity) \n        ? prev.filter(a => a !== amenity)\n        : [...prev, amenity]\n    );\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-lg max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>List Your Hostel</DialogTitle>\n          <DialogDescription>\n            Add your hostel or apartment to help students find accommodation near EKSU.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"images\">Photos (up to 10)</Label>\n            <Input\n              id=\"images\"\n              type=\"file\"\n              accept=\"image/*\"\n              multiple\n              onChange={handleImageChange}\n              data-testid=\"input-images\"\n            />\n            {images.length > 0 && (\n              <div className=\"grid grid-cols-4 gap-2 mt-2\">\n                {images.map((image, idx) => (\n                  <div key={idx} className=\"relative aspect-square rounded-md overflow-hidden\">\n                    <img \n                      src={URL.createObjectURL(image)} \n                      alt={`Preview ${idx + 1}`}\n                      className=\"w-full h-full object-cover\"\n                    />\n                    <Button\n                      size=\"icon\"\n                      variant=\"destructive\"\n                      className=\"absolute top-1 right-1 h-5 w-5\"\n                      onClick={() => removeImage(idx)}\n                    >\n                      <X className=\"h-3 w-3\" />\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"title\">Title *</Label>\n            <Input\n              id=\"title\"\n              placeholder=\"e.g., Spacious 2-Bedroom Apartment at Campus Gate\"\n              value={formData.title}\n              onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}\n              data-testid=\"input-title\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"description\">Description *</Label>\n            <Textarea\n              id=\"description\"\n              placeholder=\"Describe the hostel, its features, and what makes it special...\"\n              value={formData.description}\n              onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}\n              rows={4}\n              data-testid=\"input-description\"\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"location\">Location *</Label>\n              <Select\n                value={formData.location}\n                onValueChange={(value) => setFormData(prev => ({ ...prev, location: value }))}\n              >\n                <SelectTrigger data-testid=\"select-location\">\n                  <SelectValue placeholder=\"Select area\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {LOCATIONS.filter(l => l.value !== \"all\").map(loc => (\n                    <SelectItem key={loc.value} value={loc.value}>\n                      {loc.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"price\">Price per Year ({\"\\u20A6\"}) *</Label>\n              <Input\n                id=\"price\"\n                type=\"number\"\n                placeholder=\"e.g., 150000\"\n                value={formData.price}\n                onChange={(e) => setFormData(prev => ({ ...prev, price: e.target.value }))}\n                data-testid=\"input-price\"\n              />\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"address\">Full Address</Label>\n            <Input\n              id=\"address\"\n              placeholder=\"e.g., No. 5, Abiodun Street, Campus Gate\"\n              value={formData.address}\n              onChange={(e) => setFormData(prev => ({ ...prev, address: e.target.value }))}\n              data-testid=\"input-address\"\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"bedrooms\">Bedrooms</Label>\n              <Select\n                value={formData.bedrooms}\n                onValueChange={(value) => setFormData(prev => ({ ...prev, bedrooms: value }))}\n              >\n                <SelectTrigger data-testid=\"select-bedrooms\">\n                  <SelectValue placeholder=\"Select\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"1\">1 (Self-contain)</SelectItem>\n                  <SelectItem value=\"2\">2 Bedrooms</SelectItem>\n                  <SelectItem value=\"3\">3 Bedrooms</SelectItem>\n                  <SelectItem value=\"4\">4+ Bedrooms</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"bathrooms\">Bathrooms</Label>\n              <Select\n                value={formData.bathrooms}\n                onValueChange={(value) => setFormData(prev => ({ ...prev, bathrooms: value }))}\n              >\n                <SelectTrigger data-testid=\"select-bathrooms\">\n                  <SelectValue placeholder=\"Select\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"1\">1 Bathroom</SelectItem>\n                  <SelectItem value=\"2\">2 Bathrooms</SelectItem>\n                  <SelectItem value=\"3\">3+ Bathrooms</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"distance\">Distance from Campus (km)</Label>\n              <Input\n                id=\"distance\"\n                type=\"number\"\n                step=\"0.1\"\n                placeholder=\"e.g., 0.5\"\n                value={formData.distanceFromCampus}\n                onChange={(e) => setFormData(prev => ({ ...prev, distanceFromCampus: e.target.value }))}\n                data-testid=\"input-distance\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"agentFee\">Agent Fee ({\"\\u20A6\"})</Label>\n              <Input\n                id=\"agentFee\"\n                type=\"number\"\n                placeholder=\"e.g., 10000\"\n                value={formData.agentFee}\n                onChange={(e) => setFormData(prev => ({ ...prev, agentFee: e.target.value }))}\n                data-testid=\"input-agent-fee\"\n              />\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label>Amenities</Label>\n            <div className=\"grid grid-cols-2 gap-2\">\n              {AMENITIES.map((amenity) => (\n                <div key={amenity.value} className=\"flex items-center space-x-2\">\n                  <Checkbox\n                    id={amenity.value}\n                    checked={selectedAmenities.includes(amenity.value)}\n                    onCheckedChange={() => toggleAmenity(amenity.value)}\n                    data-testid={`checkbox-amenity-${amenity.value}`}\n                  />\n                  <label\n                    htmlFor={amenity.value}\n                    className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer\"\n                  >\n                    {amenity.label}\n                  </label>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)}>\n            Cancel\n          </Button>\n          <Button \n            onClick={handleSubmit} \n            disabled={createMutation.isPending}\n            data-testid=\"button-create-submit\"\n          >\n            {createMutation.isPending ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Creating...\n              </>\n            ) : (\n              <>\n                <Plus className=\"mr-2 h-4 w-4\" />\n                Create Listing\n              </>\n            )}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction HostelDetailDialog({ \n  hostel, \n  open, \n  onOpenChange,\n}: { \n  hostel: Hostel | null;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}) {\n  const [currentImageIndex, setCurrentImageIndex] = useState(0);\n\n  const { data: hostelWithAgent } = useQuery<HostelWithAgent>({\n    queryKey: [\"/api/hostels\", hostel?.id],\n    enabled: !!hostel?.id && open,\n  });\n\n  if (!hostel) return null;\n\n  const images = hostel.images || [];\n  const price = parseFloat(hostel.price || \"0\");\n  const agentFee = parseFloat(hostel.agentFee || \"0\");\n  const agent = hostelWithAgent?.agent;\n\n  const nextImage = () => {\n    setCurrentImageIndex((prev) => (prev + 1) % images.length);\n  };\n\n  const prevImage = () => {\n    setCurrentImageIndex((prev) => (prev - 1 + images.length) % images.length);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Home className=\"h-5 w-5\" />\n            {hostel.title}\n          </DialogTitle>\n          <DialogDescription className=\"flex items-center gap-1\">\n            <MapPin className=\"h-3 w-3\" />\n            {hostel.location}{hostel.address && ` - ${hostel.address}`}\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          {images.length > 0 && (\n            <div className=\"relative aspect-video rounded-lg overflow-hidden bg-muted\">\n              <img \n                src={images[currentImageIndex]} \n                alt={`${hostel.title} - Image ${currentImageIndex + 1}`}\n                className=\"w-full h-full object-cover\"\n              />\n              {images.length > 1 && (\n                <>\n                  <Button \n                    size=\"icon\" \n                    variant=\"secondary\"\n                    className=\"absolute left-2 top-1/2 -translate-y-1/2\"\n                    onClick={prevImage}\n                  >\n                    <ChevronLeft className=\"h-4 w-4\" />\n                  </Button>\n                  <Button \n                    size=\"icon\" \n                    variant=\"secondary\"\n                    className=\"absolute right-2 top-1/2 -translate-y-1/2\"\n                    onClick={nextImage}\n                  >\n                    <ChevronRight className=\"h-4 w-4\" />\n                  </Button>\n                  <div className=\"absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1\">\n                    {images.map((_, idx) => (\n                      <button\n                        key={idx}\n                        onClick={() => setCurrentImageIndex(idx)}\n                        className={`w-2 h-2 rounded-full transition-colors ${idx === currentImageIndex ? 'bg-white' : 'bg-white/50'}`}\n                      />\n                    ))}\n                  </div>\n                </>\n              )}\n            </div>\n          )}\n\n          <div className=\"flex flex-wrap gap-2\">\n            <Badge className=\"bg-primary/10 text-primary text-lg px-3 py-1\">\n              {\"\\u20A6\"}{price.toLocaleString()}/yr\n            </Badge>\n            {hostel.bedrooms && (\n              <Badge variant=\"outline\" className=\"gap-1\">\n                <Bed className=\"h-3 w-3\" />\n                {hostel.bedrooms} {hostel.bedrooms === 1 ? 'Bedroom' : 'Bedrooms'}\n              </Badge>\n            )}\n            {hostel.bathrooms && (\n              <Badge variant=\"outline\" className=\"gap-1\">\n                <Bath className=\"h-3 w-3\" />\n                {hostel.bathrooms} {hostel.bathrooms === 1 ? 'Bathroom' : 'Bathrooms'}\n              </Badge>\n            )}\n            {hostel.distanceFromCampus && (\n              <Badge variant=\"outline\" className=\"gap-1\">\n                <MapPin className=\"h-3 w-3\" />\n                {hostel.distanceFromCampus}km from campus\n              </Badge>\n            )}\n            {hostel.isAvailable ? (\n              <Badge className=\"bg-green-500/10 text-green-600 dark:text-green-400\">\n                Available\n              </Badge>\n            ) : (\n              <Badge variant=\"secondary\">\n                Not Available\n              </Badge>\n            )}\n          </div>\n\n          <div className=\"p-4 rounded-lg bg-muted/50\">\n            <p className=\"text-sm whitespace-pre-wrap\">{hostel.description}</p>\n          </div>\n\n          {hostel.amenities && hostel.amenities.length > 0 && (\n            <div className=\"space-y-2\">\n              <h4 className=\"font-medium text-sm\">Amenities</h4>\n              <div className=\"flex flex-wrap gap-2\">\n                {hostel.amenities.map((amenity) => {\n                  const AmenityIcon = getAmenityIcon(amenity);\n                  return (\n                    <Badge key={amenity} variant=\"outline\" className=\"gap-1\">\n                      <AmenityIcon className=\"h-3 w-3\" />\n                      {AMENITIES.find(a => a.value === amenity)?.label || amenity}\n                    </Badge>\n                  );\n                })}\n              </div>\n            </div>\n          )}\n\n          <div className=\"grid grid-cols-2 gap-4 text-sm\">\n            {agentFee > 0 && (\n              <div className=\"flex items-center gap-2 text-muted-foreground\">\n                <span>Agent Fee:</span>\n                <span className=\"font-medium text-foreground\">{\"\\u20A6\"}{agentFee.toLocaleString()}</span>\n              </div>\n            )}\n            <div className=\"flex items-center gap-2 text-muted-foreground\">\n              <Eye className=\"h-4 w-4\" />\n              <span>{hostel.views || 0} views</span>\n            </div>\n            {hostel.createdAt && (\n              <div className=\"flex items-center gap-2 text-muted-foreground col-span-2\">\n                <span>Listed {formatDistanceToNow(new Date(hostel.createdAt), { addSuffix: true })}</span>\n              </div>\n            )}\n          </div>\n\n          {agent && (\n            <div className=\"p-4 rounded-lg border bg-card\">\n              <h4 className=\"font-medium text-sm mb-3\">Agent / Landlord</h4>\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-12 h-12 rounded-full bg-muted flex items-center justify-center\">\n                  {agent.profileImageUrl ? (\n                    <img src={agent.profileImageUrl} alt={agent.firstName || ''} className=\"w-full h-full rounded-full object-cover\" />\n                  ) : (\n                    <span className=\"text-lg font-semibold\">\n                      {agent.firstName?.[0]}{agent.lastName?.[0]}\n                    </span>\n                  )}\n                </div>\n                <div className=\"flex-1\">\n                  <p className=\"font-medium\">{agent.firstName} {agent.lastName}</p>\n                  {agent.phoneNumber && (\n                    <p className=\"text-sm text-muted-foreground flex items-center gap-1\">\n                      <Phone className=\"h-3 w-3\" />\n                      {agent.phoneNumber}\n                    </p>\n                  )}\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n\n        <DialogFooter className=\"flex-col sm:flex-row gap-2\">\n          {agent && (\n            <Link href={`/messages/${agent.id}`} className=\"w-full sm:w-auto\">\n              <Button className=\"w-full\" data-testid=\"button-contact-agent\">\n                <MessageCircle className=\"mr-2 h-4 w-4\" />\n                Contact Agent\n              </Button>\n            </Link>\n          )}\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction FiltersPanel({ \n  filters, \n  onFilterChange,\n  onReset,\n}: { \n  filters: {\n    location: string;\n    bedrooms: string;\n    priceRange: number[];\n  };\n  onFilterChange: (key: string, value: any) => void;\n  onReset: () => void;\n}) {\n  return (\n    <div className=\"space-y-6 p-4\">\n      <div className=\"space-y-2\">\n        <Label>Location</Label>\n        <Select\n          value={filters.location}\n          onValueChange={(value) => onFilterChange(\"location\", value)}\n        >\n          <SelectTrigger data-testid=\"filter-location\">\n            <SelectValue placeholder=\"Select location\" />\n          </SelectTrigger>\n          <SelectContent>\n            {LOCATIONS.map(loc => (\n              <SelectItem key={loc.value} value={loc.value}>\n                {loc.label}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label>Bedrooms</Label>\n        <Select\n          value={filters.bedrooms}\n          onValueChange={(value) => onFilterChange(\"bedrooms\", value)}\n        >\n          <SelectTrigger data-testid=\"filter-bedrooms\">\n            <SelectValue placeholder=\"Select rooms\" />\n          </SelectTrigger>\n          <SelectContent>\n            {BEDROOMS.map(room => (\n              <SelectItem key={room.value} value={room.value}>\n                {room.label}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <Label>Price Range (yearly)</Label>\n          <span className=\"text-sm text-muted-foreground\">\n            {\"\\u20A6\"}{filters.priceRange[0].toLocaleString()} - {\"\\u20A6\"}{filters.priceRange[1].toLocaleString()}\n          </span>\n        </div>\n        <Slider\n          value={filters.priceRange}\n          min={0}\n          max={500000}\n          step={10000}\n          onValueChange={(value) => onFilterChange(\"priceRange\", value)}\n          data-testid=\"filter-price-range\"\n        />\n      </div>\n\n      <Button variant=\"outline\" className=\"w-full\" onClick={onReset} data-testid=\"button-reset-filters\">\n        Reset Filters\n      </Button>\n    </div>\n  );\n}\n\nexport default function HostelsPage() {\n  const { user, isEmailVerified } = useAuth();\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [createDialogOpen, setCreateDialogOpen] = useState(false);\n  const [selectedHostel, setSelectedHostel] = useState<Hostel | null>(null);\n  const [detailDialogOpen, setDetailDialogOpen] = useState(false);\n  const [showMyListings, setShowMyListings] = useState(false);\n  const [filters, setFilters] = useState({\n    location: \"all\",\n    bedrooms: \"all\",\n    priceRange: [0, 500000] as number[],\n  });\n\n  // Fetch all hostels\n  const { data: hostels, isLoading: hostelsLoading } = useQuery<Hostel[]>({\n    queryKey: [\"/api/hostels\", { \n      search: searchQuery,\n      location: filters.location !== \"all\" ? filters.location : undefined,\n      bedrooms: filters.bedrooms !== \"all\" ? filters.bedrooms : undefined,\n      minPrice: filters.priceRange[0] > 0 ? filters.priceRange[0] : undefined,\n      maxPrice: filters.priceRange[1] < 500000 ? filters.priceRange[1] : undefined,\n    }],\n  });\n\n  // Fetch user's hostels\n  const { data: myHostels, isLoading: myHostelsLoading } = useQuery<Hostel[]>({\n    queryKey: [\"/api/hostels/my-listings\"],\n    enabled: !!user && showMyListings,\n  });\n\n  const handleFilterChange = (key: string, value: any) => {\n    setFilters(prev => ({ ...prev, [key]: value }));\n  };\n\n  const resetFilters = () => {\n    setFilters({\n      location: \"all\",\n      bedrooms: \"all\",\n      priceRange: [0, 500000],\n    });\n    setSearchQuery(\"\");\n  };\n\n  const handleViewHostel = (hostel: Hostel) => {\n    setSelectedHostel(hostel);\n    setDetailDialogOpen(true);\n  };\n\n  const handleCreateClick = () => {\n    if (!isEmailVerified) {\n      toast({\n        title: \"Email Verification Required\",\n        description: \"Please verify your email before listing a hostel.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setCreateDialogOpen(true);\n  };\n\n  const displayedHostels = showMyListings ? myHostels : hostels;\n  const isLoading = showMyListings ? myHostelsLoading : hostelsLoading;\n\n  // Apply client-side price filtering\n  const filteredHostels = displayedHostels?.filter(hostel => {\n    const price = parseFloat(hostel.price || \"0\");\n    return price >= filters.priceRange[0] && price <= filters.priceRange[1];\n  });\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"container mx-auto px-4 py-6 max-w-6xl\">\n        <div className=\"flex items-center justify-between mb-6 gap-4 flex-wrap\">\n          <div>\n            <h1 className=\"text-2xl font-bold flex items-center gap-2\">\n              <Home className=\"h-6 w-6\" />\n              Hostel Finder\n            </h1>\n            <p className=\"text-sm text-muted-foreground\">\n              Find your perfect accommodation near EKSU\n            </p>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant={showMyListings ? \"default\" : \"outline\"}\n              onClick={() => setShowMyListings(!showMyListings)}\n              data-testid=\"button-toggle-my-listings\"\n            >\n              {showMyListings ? \"All Hostels\" : \"My Listings\"}\n            </Button>\n            <Button onClick={handleCreateClick} data-testid=\"button-list-hostel\">\n              <Plus className=\"mr-2 h-4 w-4\" />\n              List Hostel\n            </Button>\n          </div>\n        </div>\n\n        <div className=\"flex gap-6\">\n          <Sheet>\n            <SheetTrigger asChild>\n              <Button variant=\"outline\" className=\"lg:hidden\" data-testid=\"button-open-filters\">\n                <Filter className=\"mr-2 h-4 w-4\" />\n                Filters\n              </Button>\n            </SheetTrigger>\n            <SheetContent side=\"left\" className=\"w-80\">\n              <SheetHeader>\n                <SheetTitle>Filters</SheetTitle>\n              </SheetHeader>\n              <FiltersPanel \n                filters={filters} \n                onFilterChange={handleFilterChange}\n                onReset={resetFilters}\n              />\n            </SheetContent>\n          </Sheet>\n\n          <aside className=\"hidden lg:block w-64 flex-shrink-0\">\n            <Card className=\"sticky top-4\">\n              <CardContent className=\"p-0\">\n                <div className=\"p-4 border-b\">\n                  <h3 className=\"font-semibold flex items-center gap-2\">\n                    <Filter className=\"h-4 w-4\" />\n                    Filters\n                  </h3>\n                </div>\n                <FiltersPanel \n                  filters={filters} \n                  onFilterChange={handleFilterChange}\n                  onReset={resetFilters}\n                />\n              </CardContent>\n            </Card>\n          </aside>\n\n          <div className=\"flex-1\">\n            <div className=\"mb-4\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search by title or location...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-10\"\n                  data-testid=\"input-search\"\n                />\n              </div>\n            </div>\n\n            {isLoading ? (\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-4\">\n                {Array.from({ length: 6 }).map((_, i) => (\n                  <HostelCardSkeleton key={i} />\n                ))}\n              </div>\n            ) : filteredHostels && filteredHostels.length > 0 ? (\n              <>\n                <p className=\"text-sm text-muted-foreground mb-4\">\n                  {filteredHostels.length} hostel{filteredHostels.length !== 1 ? 's' : ''} found\n                </p>\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                  <AnimatePresence mode=\"popLayout\">\n                    {filteredHostels.map(hostel => (\n                      <HostelCard\n                        key={hostel.id}\n                        hostel={hostel}\n                        onView={handleViewHostel}\n                      />\n                    ))}\n                  </AnimatePresence>\n                </div>\n              </>\n            ) : (\n              <Card className=\"p-8 text-center\">\n                <Home className=\"h-12 w-12 mx-auto text-muted-foreground/50 mb-4\" />\n                <h3 className=\"font-semibold mb-2\">\n                  {showMyListings ? \"No listings yet\" : \"No hostels found\"}\n                </h3>\n                <p className=\"text-sm text-muted-foreground mb-4\">\n                  {showMyListings \n                    ? \"You haven't listed any hostels yet. Click the button above to list your first property.\"\n                    : \"Try adjusting your filters or search query.\"}\n                </p>\n                {showMyListings && (\n                  <Button onClick={handleCreateClick} data-testid=\"button-create-first\">\n                    <Plus className=\"mr-2 h-4 w-4\" />\n                    List Your First Hostel\n                  </Button>\n                )}\n              </Card>\n            )}\n          </div>\n        </div>\n      </div>\n\n      <CreateHostelDialog\n        open={createDialogOpen}\n        onOpenChange={setCreateDialogOpen}\n        onSuccess={() => {}}\n      />\n\n      <HostelDetailDialog\n        hostel={selectedHostel}\n        open={detailDialogOpen}\n        onOpenChange={setDetailDialogOpen}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":38273,"size_tokens":null},"client/src/pages/study-materials.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetHeader,\n  SheetTitle,\n  SheetTrigger,\n} from \"@/components/ui/sheet\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Search,\n  Filter,\n  Upload,\n  Download,\n  Eye,\n  Star,\n  FileText,\n  BookOpen,\n  GraduationCap,\n  FlaskConical,\n  Lightbulb,\n  ClipboardList,\n  FolderOpen,\n  ShoppingCart,\n  Check,\n  X,\n  ChevronRight,\n  Loader2,\n  Plus,\n  Wallet,\n} from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport type { StudyMaterial, User } from \"@shared/schema\";\n\ntype StudyMaterialWithUploader = StudyMaterial & { uploader: User };\n\nconst LEVELS = [\n  { value: \"all\", label: \"All Levels\" },\n  { value: \"100L\", label: \"100 Level\" },\n  { value: \"200L\", label: \"200 Level\" },\n  { value: \"300L\", label: \"300 Level\" },\n  { value: \"400L\", label: \"400 Level\" },\n  { value: \"500L\", label: \"500 Level\" },\n  { value: \"postgraduate\", label: \"Postgraduate\" },\n];\n\nconst MATERIAL_TYPES = [\n  { value: \"all\", label: \"All Types\", icon: FolderOpen },\n  { value: \"past_question\", label: \"Past Questions\", icon: ClipboardList },\n  { value: \"lecture_note\", label: \"Lecture Notes\", icon: FileText },\n  { value: \"handout\", label: \"Handouts\", icon: BookOpen },\n  { value: \"summary\", label: \"Summaries\", icon: Lightbulb },\n  { value: \"textbook\", label: \"Textbooks\", icon: BookOpen },\n  { value: \"lab_report\", label: \"Lab Reports\", icon: FlaskConical },\n  { value: \"project\", label: \"Projects\", icon: GraduationCap },\n];\n\nconst FACULTIES = [\n  { value: \"all\", label: \"All Faculties\" },\n  { value: \"Sciences\", label: \"Faculty of Sciences\" },\n  { value: \"Arts\", label: \"Faculty of Arts\" },\n  { value: \"Social Sciences\", label: \"Faculty of Social Sciences\" },\n  { value: \"Education\", label: \"Faculty of Education\" },\n  { value: \"Engineering\", label: \"Faculty of Engineering\" },\n  { value: \"Law\", label: \"Faculty of Law\" },\n  { value: \"Agriculture\", label: \"Faculty of Agriculture\" },\n  { value: \"Management Sciences\", label: \"Faculty of Management Sciences\" },\n];\n\nfunction MaterialTypeIcon({ type }: { type: string }) {\n  const MaterialIcon = MATERIAL_TYPES.find(t => t.value === type)?.icon || FileText;\n  return <MaterialIcon className=\"h-4 w-4\" />;\n}\n\nfunction MaterialCard({ \n  material, \n  onView, \n  onPurchase,\n  currentUserId,\n}: { \n  material: StudyMaterialWithUploader;\n  onView: (material: StudyMaterialWithUploader) => void;\n  onPurchase: (material: StudyMaterialWithUploader) => void;\n  currentUserId?: string;\n}) {\n  const isOwner = material.uploaderId === currentUserId;\n  const isFree = material.isFree;\n  const price = parseFloat(material.price || \"0\");\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, y: -20 }}\n      transition={{ duration: 0.3 }}\n    >\n      <Card \n        className=\"overflow-visible cursor-pointer transition-all duration-200\" \n        onClick={() => onView(material)}\n        data-testid={`card-material-${material.id}`}\n      >\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-start gap-3\">\n            <div className=\"flex-shrink-0 w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center\">\n              <MaterialTypeIcon type={material.materialType} />\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-start justify-between gap-2\">\n                <div className=\"min-w-0\">\n                  <h3 className=\"font-semibold text-sm truncate\" data-testid={`text-title-${material.id}`}>\n                    {material.title}\n                  </h3>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {material.courseCode} {material.courseName && `- ${material.courseName}`}\n                  </p>\n                </div>\n                <div className=\"flex-shrink-0\">\n                  {isFree ? (\n                    <Badge variant=\"secondary\" className=\"text-xs bg-green-500/10 text-green-600 dark:text-green-400\">\n                      Free\n                    </Badge>\n                  ) : (\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      {\"\\u20A6\"}{price.toLocaleString()}\n                    </Badge>\n                  )}\n                </div>\n              </div>\n              \n              <div className=\"flex items-center gap-2 mt-2 flex-wrap\">\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  {material.level}\n                </Badge>\n                <Badge variant=\"outline\" className=\"text-xs gap-1\">\n                  <MaterialTypeIcon type={material.materialType} />\n                  {MATERIAL_TYPES.find(t => t.value === material.materialType)?.label || material.materialType}\n                </Badge>\n              </div>\n\n              <div className=\"flex items-center justify-between mt-3\">\n                <div className=\"flex items-center gap-3 text-xs text-muted-foreground\">\n                  <span className=\"flex items-center gap-1\">\n                    <Eye className=\"h-3 w-3\" />\n                    {material.views || 0}\n                  </span>\n                  <span className=\"flex items-center gap-1\">\n                    <Download className=\"h-3 w-3\" />\n                    {material.downloads || 0}\n                  </span>\n                  {(material.rating && parseFloat(material.rating) > 0) && (\n                    <span className=\"flex items-center gap-1\">\n                      <Star className=\"h-3 w-3 fill-yellow-500 text-yellow-500\" />\n                      {parseFloat(material.rating).toFixed(1)}\n                    </span>\n                  )}\n                </div>\n                <span className=\"text-xs text-muted-foreground\">\n                  {material.createdAt && formatDistanceToNow(new Date(material.createdAt), { addSuffix: true })}\n                </span>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nfunction MaterialCardSkeleton() {\n  return (\n    <Card>\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-start gap-3\">\n          <Skeleton className=\"w-12 h-12 rounded-lg\" />\n          <div className=\"flex-1\">\n            <Skeleton className=\"h-4 w-3/4 mb-2\" />\n            <Skeleton className=\"h-3 w-1/2 mb-2\" />\n            <div className=\"flex gap-2 mb-2\">\n              <Skeleton className=\"h-5 w-16\" />\n              <Skeleton className=\"h-5 w-24\" />\n            </div>\n            <div className=\"flex justify-between\">\n              <Skeleton className=\"h-3 w-20\" />\n              <Skeleton className=\"h-3 w-16\" />\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction UploadMaterialDialog({ \n  open, \n  onOpenChange, \n  onSuccess \n}: { \n  open: boolean; \n  onOpenChange: (open: boolean) => void;\n  onSuccess: () => void;\n}) {\n  const { toast } = useToast();\n  const [file, setFile] = useState<File | null>(null);\n  const [formData, setFormData] = useState({\n    title: \"\",\n    description: \"\",\n    courseCode: \"\",\n    courseName: \"\",\n    faculty: \"\",\n    department: \"\",\n    level: \"100L\",\n    materialType: \"past_question\",\n    semester: \"\",\n    academicYear: \"\",\n    price: \"0\",\n    isFree: true,\n  });\n\n  const uploadMutation = useMutation({\n    mutationFn: async (data: FormData) => {\n      const response = await fetch(\"/api/study-materials\", {\n        method: \"POST\",\n        body: data,\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Upload failed\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Success\", description: \"Material uploaded successfully!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/study-materials\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/study-materials/my-uploads\"] });\n      onSuccess();\n      onOpenChange(false);\n      setFile(null);\n      setFormData({\n        title: \"\",\n        description: \"\",\n        courseCode: \"\",\n        courseName: \"\",\n        faculty: \"\",\n        department: \"\",\n        level: \"100L\",\n        materialType: \"past_question\",\n        semester: \"\",\n        academicYear: \"\",\n        price: \"0\",\n        isFree: true,\n      });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const handleSubmit = () => {\n    if (!file) {\n      toast({ title: \"Error\", description: \"Please select a file to upload\", variant: \"destructive\" });\n      return;\n    }\n    if (!formData.title.trim()) {\n      toast({ title: \"Error\", description: \"Please enter a title\", variant: \"destructive\" });\n      return;\n    }\n    if (!formData.courseCode.trim()) {\n      toast({ title: \"Error\", description: \"Please enter a course code\", variant: \"destructive\" });\n      return;\n    }\n\n    const data = new FormData();\n    data.append(\"file\", file);\n    data.append(\"title\", formData.title);\n    data.append(\"description\", formData.description);\n    data.append(\"courseCode\", formData.courseCode.toUpperCase());\n    data.append(\"courseName\", formData.courseName);\n    data.append(\"faculty\", formData.faculty);\n    data.append(\"department\", formData.department);\n    data.append(\"level\", formData.level);\n    data.append(\"materialType\", formData.materialType);\n    data.append(\"semester\", formData.semester);\n    data.append(\"academicYear\", formData.academicYear);\n    data.append(\"price\", formData.isFree ? \"0\" : formData.price);\n    data.append(\"isFree\", String(formData.isFree));\n\n    uploadMutation.mutate(data);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-lg max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>Upload Study Material</DialogTitle>\n          <DialogDescription>\n            Share your study materials with fellow students. You can set a price or make it free.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"file\">File (PDF, DOC, etc.)</Label>\n            <Input\n              id=\"file\"\n              type=\"file\"\n              accept=\".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt\"\n              onChange={(e) => setFile(e.target.files?.[0] || null)}\n              data-testid=\"input-file\"\n            />\n            {file && (\n              <p className=\"text-xs text-muted-foreground\">\n                Selected: {file.name} ({(file.size / 1024 / 1024).toFixed(2)} MB)\n              </p>\n            )}\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"title\">Title *</Label>\n            <Input\n              id=\"title\"\n              placeholder=\"e.g., CSC 201 Past Questions 2023\"\n              value={formData.title}\n              onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}\n              data-testid=\"input-title\"\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"courseCode\">Course Code *</Label>\n              <Input\n                id=\"courseCode\"\n                placeholder=\"e.g., CSC 201\"\n                value={formData.courseCode}\n                onChange={(e) => setFormData(prev => ({ ...prev, courseCode: e.target.value }))}\n                data-testid=\"input-course-code\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"courseName\">Course Name</Label>\n              <Input\n                id=\"courseName\"\n                placeholder=\"e.g., Data Structures\"\n                value={formData.courseName}\n                onChange={(e) => setFormData(prev => ({ ...prev, courseName: e.target.value }))}\n                data-testid=\"input-course-name\"\n              />\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"level\">Level *</Label>\n              <Select\n                value={formData.level}\n                onValueChange={(value) => setFormData(prev => ({ ...prev, level: value }))}\n              >\n                <SelectTrigger data-testid=\"select-level\">\n                  <SelectValue placeholder=\"Select level\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {LEVELS.filter(l => l.value !== \"all\").map(level => (\n                    <SelectItem key={level.value} value={level.value}>\n                      {level.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"materialType\">Type *</Label>\n              <Select\n                value={formData.materialType}\n                onValueChange={(value) => setFormData(prev => ({ ...prev, materialType: value }))}\n              >\n                <SelectTrigger data-testid=\"select-type\">\n                  <SelectValue placeholder=\"Select type\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {MATERIAL_TYPES.filter(t => t.value !== \"all\").map(type => (\n                    <SelectItem key={type.value} value={type.value}>\n                      {type.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"faculty\">Faculty</Label>\n            <Select\n              value={formData.faculty}\n              onValueChange={(value) => setFormData(prev => ({ ...prev, faculty: value }))}\n            >\n              <SelectTrigger data-testid=\"select-faculty\">\n                <SelectValue placeholder=\"Select faculty\" />\n              </SelectTrigger>\n              <SelectContent>\n                {FACULTIES.filter(f => f.value !== \"all\").map(faculty => (\n                  <SelectItem key={faculty.value} value={faculty.value}>\n                    {faculty.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"description\">Description</Label>\n            <Textarea\n              id=\"description\"\n              placeholder=\"Brief description of the material...\"\n              value={formData.description}\n              onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}\n              rows={3}\n              data-testid=\"input-description\"\n            />\n          </div>\n\n          <div className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\">\n            <div className=\"flex items-center gap-2\">\n              <Switch\n                id=\"isFree\"\n                checked={formData.isFree}\n                onCheckedChange={(checked) => setFormData(prev => ({ ...prev, isFree: checked }))}\n                data-testid=\"switch-free\"\n              />\n              <Label htmlFor=\"isFree\">Make it free</Label>\n            </div>\n            {!formData.isFree && (\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-sm\">{\"\\u20A6\"}</span>\n                <Input\n                  type=\"number\"\n                  min=\"0\"\n                  step=\"50\"\n                  value={formData.price}\n                  onChange={(e) => setFormData(prev => ({ ...prev, price: e.target.value }))}\n                  className=\"w-24\"\n                  data-testid=\"input-price\"\n                />\n              </div>\n            )}\n          </div>\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)}>\n            Cancel\n          </Button>\n          <Button \n            onClick={handleSubmit} \n            disabled={uploadMutation.isPending}\n            data-testid=\"button-upload-submit\"\n          >\n            {uploadMutation.isPending ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Uploading...\n              </>\n            ) : (\n              <>\n                <Upload className=\"mr-2 h-4 w-4\" />\n                Upload Material\n              </>\n            )}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction MaterialDetailDialog({ \n  material, \n  open, \n  onOpenChange,\n  onPurchase,\n  onDownload,\n  currentUserId,\n}: { \n  material: StudyMaterialWithUploader | null;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onPurchase: (material: StudyMaterialWithUploader) => void;\n  onDownload: (material: StudyMaterialWithUploader) => void;\n  currentUserId?: string;\n}) {\n  const { data: walletData } = useQuery<{ balance: string }>({\n    queryKey: [\"/api/wallet\"],\n  });\n\n  const { data: detailData } = useQuery<StudyMaterialWithUploader & { hasPurchased: boolean }>({\n    queryKey: [\"/api/study-materials\", material?.id],\n    enabled: !!material?.id && open,\n  });\n\n  if (!material) return null;\n\n  const isOwner = material.uploaderId === currentUserId;\n  const isFree = material.isFree;\n  const hasPurchased = detailData?.hasPurchased || false;\n  const canAccess = isOwner || hasPurchased || isFree;\n  const price = parseFloat(material.price || \"0\");\n  const walletBalance = parseFloat(walletData?.balance || \"0\");\n  const canAfford = walletBalance >= price;\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <MaterialTypeIcon type={material.materialType} />\n            {material.title}\n          </DialogTitle>\n          <DialogDescription>\n            {material.courseCode} {material.courseName && `- ${material.courseName}`}\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          <div className=\"flex flex-wrap gap-2\">\n            <Badge variant=\"outline\">{material.level}</Badge>\n            <Badge variant=\"outline\" className=\"gap-1\">\n              <MaterialTypeIcon type={material.materialType} />\n              {MATERIAL_TYPES.find(t => t.value === material.materialType)?.label}\n            </Badge>\n            {material.faculty && (\n              <Badge variant=\"outline\">{material.faculty}</Badge>\n            )}\n            {isFree ? (\n              <Badge className=\"bg-green-500/10 text-green-600 dark:text-green-400\">Free</Badge>\n            ) : (\n              <Badge className=\"bg-primary/10 text-primary\">{\"\\u20A6\"}{price.toLocaleString()}</Badge>\n            )}\n          </div>\n\n          {material.description && (\n            <div className=\"p-4 rounded-lg bg-muted/50\">\n              <p className=\"text-sm\">{material.description}</p>\n            </div>\n          )}\n\n          <div className=\"grid grid-cols-2 gap-4 text-sm\">\n            <div className=\"flex items-center gap-2 text-muted-foreground\">\n              <Eye className=\"h-4 w-4\" />\n              <span>{material.views || 0} views</span>\n            </div>\n            <div className=\"flex items-center gap-2 text-muted-foreground\">\n              <Download className=\"h-4 w-4\" />\n              <span>{material.downloads || 0} downloads</span>\n            </div>\n            {material.rating && parseFloat(material.rating) > 0 && (\n              <div className=\"flex items-center gap-2 text-muted-foreground\">\n                <Star className=\"h-4 w-4 fill-yellow-500 text-yellow-500\" />\n                <span>{parseFloat(material.rating).toFixed(1)} ({material.ratingCount} ratings)</span>\n              </div>\n            )}\n            {material.fileSize && (\n              <div className=\"flex items-center gap-2 text-muted-foreground\">\n                <FileText className=\"h-4 w-4\" />\n                <span>{(material.fileSize / 1024 / 1024).toFixed(2)} MB</span>\n              </div>\n            )}\n          </div>\n\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <span>Uploaded by</span>\n            <span className=\"font-medium text-foreground\">\n              {material.uploader.firstName} {material.uploader.lastName}\n            </span>\n            <span>\n              {material.createdAt && formatDistanceToNow(new Date(material.createdAt), { addSuffix: true })}\n            </span>\n          </div>\n        </div>\n\n        <DialogFooter className=\"flex-col sm:flex-row gap-2\">\n          {canAccess ? (\n            <Button onClick={() => onDownload(material)} className=\"w-full sm:w-auto\" data-testid=\"button-download\">\n              <Download className=\"mr-2 h-4 w-4\" />\n              Download Material\n            </Button>\n          ) : (\n            <>\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground w-full sm:w-auto\">\n                <Wallet className=\"h-4 w-4\" />\n                <span>Balance: {\"\\u20A6\"}{walletBalance.toLocaleString()}</span>\n              </div>\n              <Button \n                onClick={() => onPurchase(material)} \n                disabled={!canAfford}\n                className=\"w-full sm:w-auto\"\n                data-testid=\"button-purchase\"\n              >\n                <ShoppingCart className=\"mr-2 h-4 w-4\" />\n                {canAfford ? `Purchase for \\u20A6${price.toLocaleString()}` : \"Insufficient Balance\"}\n              </Button>\n            </>\n          )}\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction FilterSidebar({\n  filters,\n  onFilterChange,\n  onReset,\n}: {\n  filters: { level: string; faculty: string; materialType: string };\n  onFilterChange: (key: string, value: string) => void;\n  onReset: () => void;\n}) {\n  const hasFilters = filters.level !== \"all\" || filters.faculty !== \"all\" || filters.materialType !== \"all\";\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h3 className=\"font-semibold\">Filters</h3>\n        {hasFilters && (\n          <Button variant=\"ghost\" size=\"sm\" onClick={onReset} data-testid=\"button-reset-filters\">\n            Reset\n          </Button>\n        )}\n      </div>\n\n      <div className=\"space-y-4\">\n        <div className=\"space-y-2\">\n          <Label>Level</Label>\n          <Select value={filters.level} onValueChange={(v) => onFilterChange(\"level\", v)}>\n            <SelectTrigger data-testid=\"filter-level\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              {LEVELS.map(level => (\n                <SelectItem key={level.value} value={level.value}>\n                  {level.label}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n\n        <div className=\"space-y-2\">\n          <Label>Faculty</Label>\n          <Select value={filters.faculty} onValueChange={(v) => onFilterChange(\"faculty\", v)}>\n            <SelectTrigger data-testid=\"filter-faculty\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              {FACULTIES.map(faculty => (\n                <SelectItem key={faculty.value} value={faculty.value}>\n                  {faculty.label}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n\n        <div className=\"space-y-2\">\n          <Label>Material Type</Label>\n          <Select value={filters.materialType} onValueChange={(v) => onFilterChange(\"materialType\", v)}>\n            <SelectTrigger data-testid=\"filter-type\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              {MATERIAL_TYPES.map(type => (\n                <SelectItem key={type.value} value={type.value}>\n                  <span className=\"flex items-center gap-2\">\n                    <type.icon className=\"h-4 w-4\" />\n                    {type.label}\n                  </span>\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function StudyMaterialsPage() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filters, setFilters] = useState({\n    level: \"all\",\n    faculty: \"all\",\n    materialType: \"all\",\n  });\n  const [uploadDialogOpen, setUploadDialogOpen] = useState(false);\n  const [selectedMaterial, setSelectedMaterial] = useState<StudyMaterialWithUploader | null>(null);\n  const [detailDialogOpen, setDetailDialogOpen] = useState(false);\n  const [mobileFilterOpen, setMobileFilterOpen] = useState(false);\n\n  const buildQueryParams = () => {\n    const params = new URLSearchParams();\n    if (searchQuery) params.set(\"search\", searchQuery);\n    if (filters.level !== \"all\") params.set(\"level\", filters.level);\n    if (filters.faculty !== \"all\") params.set(\"faculty\", filters.faculty);\n    if (filters.materialType !== \"all\") params.set(\"materialType\", filters.materialType);\n    return params.toString();\n  };\n\n  const { data: materials, isLoading } = useQuery<StudyMaterialWithUploader[]>({\n    queryKey: [\"/api/study-materials\", buildQueryParams()],\n  });\n\n  const purchaseMutation = useMutation({\n    mutationFn: async (materialId: string) => {\n      const res = await apiRequest(\"POST\", `/api/study-materials/${materialId}/purchase`);\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Success\", description: \"Material purchased successfully!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/study-materials\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wallet\"] });\n      setDetailDialogOpen(false);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Purchase Failed\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const downloadMutation = useMutation({\n    mutationFn: async (materialId: string) => {\n      const res = await apiRequest(\"GET\", `/api/study-materials/${materialId}/download`);\n      return res.json();\n    },\n    onSuccess: (data) => {\n      if (data.downloadUrl) {\n        window.open(data.downloadUrl, \"_blank\");\n        toast({ title: \"Success\", description: \"Download started!\" });\n      }\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Download Failed\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const handleViewMaterial = (material: StudyMaterialWithUploader) => {\n    setSelectedMaterial(material);\n    setDetailDialogOpen(true);\n  };\n\n  const handlePurchase = (material: StudyMaterialWithUploader) => {\n    purchaseMutation.mutate(material.id);\n  };\n\n  const handleDownload = (material: StudyMaterialWithUploader) => {\n    downloadMutation.mutate(material.id);\n  };\n\n  const handleFilterChange = (key: string, value: string) => {\n    setFilters(prev => ({ ...prev, [key]: value }));\n  };\n\n  const handleResetFilters = () => {\n    setFilters({ level: \"all\", faculty: \"all\", materialType: \"all\" });\n    setSearchQuery(\"\");\n  };\n\n  const hasActiveFilters = filters.level !== \"all\" || filters.faculty !== \"all\" || filters.materialType !== \"all\" || searchQuery;\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"container max-w-7xl mx-auto px-4 py-6\">\n        <div className=\"flex flex-col lg:flex-row gap-6\">\n          <aside className=\"hidden lg:block w-64 flex-shrink-0\">\n            <Card className=\"sticky top-20\">\n              <CardContent className=\"p-4\">\n                <FilterSidebar\n                  filters={filters}\n                  onFilterChange={handleFilterChange}\n                  onReset={handleResetFilters}\n                />\n              </CardContent>\n            </Card>\n          </aside>\n\n          <main className=\"flex-1\">\n            <div className=\"flex flex-col gap-4 mb-6\">\n              <div className=\"flex items-center justify-between gap-4\">\n                <div>\n                  <h1 className=\"text-2xl font-bold\">Study Materials</h1>\n                  <p className=\"text-muted-foreground text-sm\">Past questions, notes, and more from fellow students</p>\n                </div>\n                <Button onClick={() => setUploadDialogOpen(true)} data-testid=\"button-upload\">\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  <span className=\"hidden sm:inline\">Upload Material</span>\n                  <span className=\"sm:hidden\">Upload</span>\n                </Button>\n              </div>\n\n              <div className=\"flex gap-2\">\n                <div className=\"relative flex-1\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Search by title or course code...\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"input-search\"\n                  />\n                </div>\n                <Sheet open={mobileFilterOpen} onOpenChange={setMobileFilterOpen}>\n                  <SheetTrigger asChild>\n                    <Button variant=\"outline\" size=\"icon\" className=\"lg:hidden\" data-testid=\"button-mobile-filter\">\n                      <Filter className=\"h-4 w-4\" />\n                    </Button>\n                  </SheetTrigger>\n                  <SheetContent side=\"right\">\n                    <SheetHeader>\n                      <SheetTitle>Filter Materials</SheetTitle>\n                    </SheetHeader>\n                    <div className=\"mt-6\">\n                      <FilterSidebar\n                        filters={filters}\n                        onFilterChange={(key, value) => {\n                          handleFilterChange(key, value);\n                        }}\n                        onReset={() => {\n                          handleResetFilters();\n                          setMobileFilterOpen(false);\n                        }}\n                      />\n                    </div>\n                  </SheetContent>\n                </Sheet>\n              </div>\n\n              {hasActiveFilters && (\n                <div className=\"flex items-center gap-2 flex-wrap\">\n                  <span className=\"text-sm text-muted-foreground\">Active filters:</span>\n                  {filters.level !== \"all\" && (\n                    <Badge variant=\"secondary\" className=\"gap-1\">\n                      {LEVELS.find(l => l.value === filters.level)?.label}\n                      <X \n                        className=\"h-3 w-3 cursor-pointer\" \n                        onClick={() => handleFilterChange(\"level\", \"all\")} \n                      />\n                    </Badge>\n                  )}\n                  {filters.faculty !== \"all\" && (\n                    <Badge variant=\"secondary\" className=\"gap-1\">\n                      {filters.faculty}\n                      <X \n                        className=\"h-3 w-3 cursor-pointer\" \n                        onClick={() => handleFilterChange(\"faculty\", \"all\")} \n                      />\n                    </Badge>\n                  )}\n                  {filters.materialType !== \"all\" && (\n                    <Badge variant=\"secondary\" className=\"gap-1\">\n                      {MATERIAL_TYPES.find(t => t.value === filters.materialType)?.label}\n                      <X \n                        className=\"h-3 w-3 cursor-pointer\" \n                        onClick={() => handleFilterChange(\"materialType\", \"all\")} \n                      />\n                    </Badge>\n                  )}\n                  {searchQuery && (\n                    <Badge variant=\"secondary\" className=\"gap-1\">\n                      Search: {searchQuery}\n                      <X \n                        className=\"h-3 w-3 cursor-pointer\" \n                        onClick={() => setSearchQuery(\"\")} \n                      />\n                    </Badge>\n                  )}\n                </div>\n              )}\n            </div>\n\n            {isLoading ? (\n              <div className=\"space-y-4\">\n                {[1, 2, 3, 4, 5].map(i => (\n                  <MaterialCardSkeleton key={i} />\n                ))}\n              </div>\n            ) : materials && materials.length > 0 ? (\n              <AnimatePresence mode=\"popLayout\">\n                <div className=\"space-y-4\">\n                  {materials.map(material => (\n                    <MaterialCard\n                      key={material.id}\n                      material={material}\n                      onView={handleViewMaterial}\n                      onPurchase={handlePurchase}\n                      currentUserId={user?.id}\n                    />\n                  ))}\n                </div>\n              </AnimatePresence>\n            ) : (\n              <Card>\n                <CardContent className=\"flex flex-col items-center justify-center py-12\">\n                  <FileText className=\"h-12 w-12 text-muted-foreground mb-4\" />\n                  <h3 className=\"font-semibold text-lg mb-2\">No materials found</h3>\n                  <p className=\"text-muted-foreground text-sm text-center mb-4\">\n                    {hasActiveFilters\n                      ? \"Try adjusting your filters or search query\"\n                      : \"Be the first to upload study materials!\"}\n                  </p>\n                  <Button onClick={() => setUploadDialogOpen(true)} data-testid=\"button-upload-empty\">\n                    <Upload className=\"mr-2 h-4 w-4\" />\n                    Upload Material\n                  </Button>\n                </CardContent>\n              </Card>\n            )}\n          </main>\n        </div>\n      </div>\n\n      <UploadMaterialDialog\n        open={uploadDialogOpen}\n        onOpenChange={setUploadDialogOpen}\n        onSuccess={() => {}}\n      />\n\n      <MaterialDetailDialog\n        material={selectedMaterial}\n        open={detailDialogOpen}\n        onOpenChange={setDetailDialogOpen}\n        onPurchase={handlePurchase}\n        onDownload={handleDownload}\n        currentUserId={user?.id}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":35387,"size_tokens":null},"client/src/components/games/AyoOloponGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  RotateCcw, \n  Trophy, \n  Bot, \n  User, \n  Play,\n  Circle,\n  Crown,\n  Sparkles,\n  Target,\n  Hand,\n  Home\n} from \"lucide-react\";\n\ninterface AyoOloponGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype Player = \"player\" | \"ai\";\ntype GamePhase = \"ready\" | \"playing\" | \"animating\" | \"finished\";\n\ninterface GameState {\n  pits: number[];\n  playerStore: number;\n  aiStore: number;\n  currentPlayer: Player;\n}\n\nconst PITS_PER_SIDE = 6;\nconst INITIAL_SEEDS = 4;\nconst TOTAL_PITS = PITS_PER_SIDE * 2;\n\nconst createInitialState = (): GameState => ({\n  pits: Array(TOTAL_PITS).fill(INITIAL_SEEDS),\n  playerStore: 0,\n  aiStore: 0,\n  currentPlayer: \"player\",\n});\n\nconst Pit = ({\n  seeds,\n  index,\n  isPlayable,\n  isHighlighted,\n  onClick,\n  isPlayerSide,\n  isAnimating,\n}: {\n  seeds: number;\n  index: number;\n  isPlayable: boolean;\n  isHighlighted: boolean;\n  onClick?: () => void;\n  isPlayerSide: boolean;\n  isAnimating?: boolean;\n}) => {\n  return (\n    <motion.button\n      className={`\n        relative w-14 h-14 sm:w-16 sm:h-16 rounded-full border-2 \n        flex items-center justify-center\n        transition-all duration-200\n        ${isPlayable \n          ? 'cursor-pointer border-primary ring-2 ring-primary/30' \n          : 'cursor-default border-muted-foreground/30'\n        }\n        ${isHighlighted ? 'ring-4 ring-yellow-500/50 border-yellow-500' : ''}\n        ${isPlayerSide \n          ? 'bg-amber-900/30 dark:bg-amber-800/20' \n          : 'bg-emerald-900/30 dark:bg-emerald-800/20'\n        }\n      `}\n      onClick={isPlayable ? onClick : undefined}\n      whileHover={isPlayable ? { scale: 1.1 } : {}}\n      whileTap={isPlayable ? { scale: 0.95 } : {}}\n      data-testid={`pit-${index}`}\n      disabled={!isPlayable}\n    >\n      <AnimatePresence mode=\"wait\">\n        <motion.div\n          key={seeds}\n          initial={{ scale: 0.8, opacity: 0 }}\n          animate={{ scale: 1, opacity: 1 }}\n          exit={{ scale: 0.8, opacity: 0 }}\n          className=\"flex flex-col items-center\"\n        >\n          <div className=\"flex flex-wrap justify-center gap-0.5 max-w-[40px]\">\n            {seeds <= 8 ? (\n              [...Array(seeds)].map((_, i) => (\n                <motion.div\n                  key={i}\n                  initial={isAnimating ? { scale: 0, y: -20 } : {}}\n                  animate={{ scale: 1, y: 0 }}\n                  transition={{ delay: i * 0.05 }}\n                  className={`w-2 h-2 rounded-full ${\n                    isPlayerSide \n                      ? 'bg-amber-500 dark:bg-amber-400' \n                      : 'bg-emerald-500 dark:bg-emerald-400'\n                  }`}\n                />\n              ))\n            ) : (\n              <span className={`text-lg font-bold ${\n                isPlayerSide \n                  ? 'text-amber-600 dark:text-amber-400' \n                  : 'text-emerald-600 dark:text-emerald-400'\n              }`}>\n                {seeds}\n              </span>\n            )}\n          </div>\n        </motion.div>\n      </AnimatePresence>\n      \n      {isPlayable && (\n        <motion.div\n          className=\"absolute inset-0 rounded-full border-2 border-primary\"\n          animate={{ scale: [1, 1.15, 1], opacity: [0.5, 0.2, 0.5] }}\n          transition={{ duration: 1.5, repeat: Infinity }}\n        />\n      )}\n    </motion.button>\n  );\n};\n\nconst Store = ({\n  seeds,\n  player,\n  isActive,\n}: {\n  seeds: number;\n  player: Player;\n  isActive: boolean;\n}) => {\n  const isPlayerStore = player === \"player\";\n  \n  return (\n    <motion.div\n      className={`\n        relative w-16 h-28 sm:w-20 sm:h-32 rounded-full border-2\n        flex flex-col items-center justify-center gap-1\n        ${isActive ? 'border-primary ring-2 ring-primary/30' : 'border-muted-foreground/30'}\n        ${isPlayerStore \n          ? 'bg-amber-900/40 dark:bg-amber-800/30' \n          : 'bg-emerald-900/40 dark:bg-emerald-800/30'\n        }\n      `}\n      animate={isActive ? { scale: [1, 1.02, 1] } : {}}\n      transition={{ duration: 1, repeat: isActive ? Infinity : 0 }}\n      data-testid={`store-${player}`}\n    >\n      <div className=\"flex items-center gap-1 mb-1\">\n        {isPlayerStore ? (\n          <User className=\"h-4 w-4 text-amber-600 dark:text-amber-400\" />\n        ) : (\n          <Bot className=\"h-4 w-4 text-emerald-600 dark:text-emerald-400\" />\n        )}\n      </div>\n      \n      <AnimatePresence mode=\"wait\">\n        <motion.span\n          key={seeds}\n          initial={{ scale: 0.5, opacity: 0 }}\n          animate={{ scale: 1, opacity: 1 }}\n          exit={{ scale: 0.5, opacity: 0 }}\n          className={`text-2xl sm:text-3xl font-bold ${\n            isPlayerStore \n              ? 'text-amber-600 dark:text-amber-400' \n              : 'text-emerald-600 dark:text-emerald-400'\n          }`}\n        >\n          {seeds}\n        </motion.span>\n      </AnimatePresence>\n      \n      <span className=\"text-[10px] text-muted-foreground\">\n        {isPlayerStore ? \"You\" : \"AI\"}\n      </span>\n    </motion.div>\n  );\n};\n\nconst Board = ({\n  gameState,\n  currentPlayer,\n  onPitClick,\n  isAnimating,\n  lastMovedPit,\n}: {\n  gameState: GameState;\n  currentPlayer: Player;\n  onPitClick: (index: number) => void;\n  isAnimating: boolean;\n  lastMovedPit: number | null;\n}) => {\n  const getPlayablePits = (): number[] => {\n    if (isAnimating || currentPlayer !== \"player\") return [];\n    \n    const playable: number[] = [];\n    for (let i = 0; i < PITS_PER_SIDE; i++) {\n      if (gameState.pits[i] > 0) {\n        playable.push(i);\n      }\n    }\n    return playable;\n  };\n  \n  const playablePits = getPlayablePits();\n  \n  const aiPits = gameState.pits.slice(PITS_PER_SIDE).reverse();\n  const aiPitIndices = [...Array(PITS_PER_SIDE)].map((_, i) => TOTAL_PITS - 1 - i);\n  \n  const playerPits = gameState.pits.slice(0, PITS_PER_SIDE);\n  const playerPitIndices = [...Array(PITS_PER_SIDE)].map((_, i) => i);\n  \n  return (\n    <div className=\"flex items-center justify-center gap-3 sm:gap-4 p-4 bg-gradient-to-br from-amber-950/20 via-background to-emerald-950/20 rounded-xl border-2 border-muted\" data-testid=\"game-board\">\n      <Store \n        seeds={gameState.aiStore} \n        player=\"ai\" \n        isActive={currentPlayer === \"ai\" && !isAnimating}\n      />\n      \n      <div className=\"flex flex-col gap-3 sm:gap-4\">\n        <div className=\"flex gap-2 sm:gap-3\">\n          {aiPits.map((seeds, visualIndex) => {\n            const actualIndex = aiPitIndices[visualIndex];\n            return (\n              <Pit\n                key={actualIndex}\n                seeds={seeds}\n                index={actualIndex}\n                isPlayable={false}\n                isHighlighted={lastMovedPit === actualIndex}\n                isPlayerSide={false}\n                isAnimating={isAnimating && lastMovedPit === actualIndex}\n              />\n            );\n          })}\n        </div>\n        \n        <div className=\"flex gap-2 sm:gap-3\">\n          {playerPits.map((seeds, visualIndex) => {\n            const actualIndex = playerPitIndices[visualIndex];\n            return (\n              <Pit\n                key={actualIndex}\n                seeds={seeds}\n                index={actualIndex}\n                isPlayable={playablePits.includes(actualIndex)}\n                isHighlighted={lastMovedPit === actualIndex}\n                onClick={() => onPitClick(actualIndex)}\n                isPlayerSide={true}\n                isAnimating={isAnimating && lastMovedPit === actualIndex}\n              />\n            );\n          })}\n        </div>\n      </div>\n      \n      <Store \n        seeds={gameState.playerStore} \n        player=\"player\" \n        isActive={currentPlayer === \"player\" && !isAnimating}\n      />\n    </div>\n  );\n};\n\nconst sowSeeds = (\n  state: GameState,\n  pitIndex: number,\n  player: Player\n): { newState: GameState; captured: number; endsInStore: boolean; lastPit: number } => {\n  const newState: GameState = {\n    pits: [...state.pits],\n    playerStore: state.playerStore,\n    aiStore: state.aiStore,\n    currentPlayer: state.currentPlayer,\n  };\n  \n  let seeds = newState.pits[pitIndex];\n  newState.pits[pitIndex] = 0;\n  \n  let currentIndex = pitIndex;\n  let captured = 0;\n  let endsInStore = false;\n  let lastPit = pitIndex;\n  \n  const playerStorePosition = PITS_PER_SIDE;\n  const aiStorePosition = TOTAL_PITS + 1;\n  \n  while (seeds > 0) {\n    currentIndex++;\n    \n    if (currentIndex === TOTAL_PITS) {\n      if (player === \"player\") {\n        newState.playerStore++;\n        seeds--;\n        if (seeds === 0) {\n          endsInStore = true;\n          lastPit = -1;\n        }\n        continue;\n      }\n      currentIndex = 0;\n    }\n    \n    if (player === \"ai\" && currentIndex === 0 && seeds > 0) {\n      newState.aiStore++;\n      seeds--;\n      if (seeds === 0) {\n        endsInStore = true;\n        lastPit = -2;\n      }\n      if (seeds === 0) continue;\n    }\n    \n    if (currentIndex >= TOTAL_PITS) {\n      currentIndex = 0;\n    }\n    \n    if (seeds > 0) {\n      newState.pits[currentIndex]++;\n      seeds--;\n      lastPit = currentIndex;\n    }\n  }\n  \n  if (!endsInStore && lastPit >= 0) {\n    const isPlayerSide = lastPit < PITS_PER_SIDE;\n    const isAiSide = lastPit >= PITS_PER_SIDE;\n    \n    if (player === \"player\" && isAiSide) {\n      const finalSeeds = newState.pits[lastPit];\n      if (finalSeeds === 2 || finalSeeds === 3) {\n        captured = finalSeeds;\n        newState.playerStore += finalSeeds;\n        newState.pits[lastPit] = 0;\n        \n        let checkPit = lastPit - 1;\n        while (checkPit >= PITS_PER_SIDE) {\n          const pitSeeds = newState.pits[checkPit];\n          if (pitSeeds === 2 || pitSeeds === 3) {\n            captured += pitSeeds;\n            newState.playerStore += pitSeeds;\n            newState.pits[checkPit] = 0;\n            checkPit--;\n          } else {\n            break;\n          }\n        }\n      }\n    } else if (player === \"ai\" && isPlayerSide) {\n      const finalSeeds = newState.pits[lastPit];\n      if (finalSeeds === 2 || finalSeeds === 3) {\n        captured = finalSeeds;\n        newState.aiStore += finalSeeds;\n        newState.pits[lastPit] = 0;\n        \n        let checkPit = lastPit + 1;\n        while (checkPit < PITS_PER_SIDE) {\n          const pitSeeds = newState.pits[checkPit];\n          if (pitSeeds === 2 || pitSeeds === 3) {\n            captured += pitSeeds;\n            newState.aiStore += pitSeeds;\n            newState.pits[checkPit] = 0;\n            checkPit++;\n          } else {\n            break;\n          }\n        }\n      }\n    }\n  }\n  \n  return { newState, captured, endsInStore, lastPit };\n};\n\nconst checkGameEnd = (state: GameState): boolean => {\n  const playerSideEmpty = state.pits.slice(0, PITS_PER_SIDE).every(p => p === 0);\n  const aiSideEmpty = state.pits.slice(PITS_PER_SIDE).every(p => p === 0);\n  return playerSideEmpty || aiSideEmpty;\n};\n\nconst collectRemainingSeeds = (state: GameState): GameState => {\n  const newState = { ...state, pits: [...state.pits] };\n  \n  const playerSideSeeds = newState.pits.slice(0, PITS_PER_SIDE).reduce((a, b) => a + b, 0);\n  const aiSideSeeds = newState.pits.slice(PITS_PER_SIDE).reduce((a, b) => a + b, 0);\n  \n  newState.playerStore += playerSideSeeds;\n  newState.aiStore += aiSideSeeds;\n  \n  for (let i = 0; i < TOTAL_PITS; i++) {\n    newState.pits[i] = 0;\n  }\n  \n  return newState;\n};\n\nconst evaluateMove = (state: GameState, pitIndex: number, player: Player): number => {\n  const result = sowSeeds(state, pitIndex, player);\n  let score = 0;\n  \n  score += result.captured * 10;\n  \n  if (result.endsInStore) {\n    score += 15;\n  }\n  \n  if (player === \"ai\") {\n    score += result.newState.aiStore - state.aiStore;\n    \n    const aiSideSeeds = result.newState.pits.slice(PITS_PER_SIDE).reduce((a, b) => a + b, 0);\n    score += aiSideSeeds * 0.5;\n  }\n  \n  return score;\n};\n\nconst getAiMove = (state: GameState): number => {\n  const validMoves: number[] = [];\n  for (let i = PITS_PER_SIDE; i < TOTAL_PITS; i++) {\n    if (state.pits[i] > 0) {\n      validMoves.push(i);\n    }\n  }\n  \n  if (validMoves.length === 0) return -1;\n  \n  let bestMove = validMoves[0];\n  let bestScore = -Infinity;\n  \n  for (const move of validMoves) {\n    const score = evaluateMove(state, move, \"ai\");\n    if (score > bestScore) {\n      bestScore = score;\n      bestMove = move;\n    }\n  }\n  \n  if (bestScore <= 0 && Math.random() < 0.2) {\n    return validMoves[Math.floor(Math.random() * validMoves.length)];\n  }\n  \n  return bestMove;\n};\n\nexport default function AyoOloponGame({ stake, onGameEnd, isPractice }: AyoOloponGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"ready\");\n  const [gameState, setGameState] = useState<GameState>(createInitialState());\n  const [currentPlayer, setCurrentPlayer] = useState<Player>(\"player\");\n  const [message, setMessage] = useState(\"Click a pit to sow seeds!\");\n  const [winner, setWinner] = useState<Player | null>(null);\n  const [isAnimating, setIsAnimating] = useState(false);\n  const [lastMovedPit, setLastMovedPit] = useState<number | null>(null);\n  const [isAiThinking, setIsAiThinking] = useState(false);\n  \n  const aiTurnRef = useRef(false);\n  const timeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current);\n      }\n    };\n  }, []);\n\n  const startGame = useCallback(() => {\n    setGameState(createInitialState());\n    setCurrentPlayer(\"player\");\n    setGamePhase(\"playing\");\n    setMessage(\"Your turn! Click a pit to sow seeds.\");\n    setWinner(null);\n    setIsAnimating(false);\n    setLastMovedPit(null);\n    aiTurnRef.current = false;\n  }, []);\n\n  const endGame = useCallback((finalState: GameState) => {\n    const collectedState = collectRemainingSeeds(finalState);\n    setGameState(collectedState);\n    setGamePhase(\"finished\");\n    \n    const playerTotal = collectedState.playerStore;\n    const aiTotal = collectedState.aiStore;\n    \n    if (playerTotal > aiTotal) {\n      setWinner(\"player\");\n      setMessage(`You win! ${playerTotal} vs ${aiTotal}`);\n      onGameEnd(true, playerTotal * 10);\n    } else if (aiTotal > playerTotal) {\n      setWinner(\"ai\");\n      setMessage(`AI wins! ${aiTotal} vs ${playerTotal}`);\n      onGameEnd(false, 0);\n    } else {\n      setWinner(null);\n      setMessage(`It's a tie! ${playerTotal} vs ${aiTotal}`);\n      onGameEnd(false, playerTotal * 5);\n    }\n  }, [onGameEnd]);\n\n  const makeMove = useCallback((pitIndex: number, player: Player) => {\n    if (gameState.pits[pitIndex] === 0) return;\n    \n    setIsAnimating(true);\n    setLastMovedPit(pitIndex);\n    \n    const result = sowSeeds(gameState, pitIndex, player);\n    \n    timeoutRef.current = setTimeout(() => {\n      setGameState(result.newState);\n      setLastMovedPit(result.lastPit >= 0 ? result.lastPit : null);\n      \n      if (result.captured > 0) {\n        setMessage(`${player === \"player\" ? \"You\" : \"AI\"} captured ${result.captured} seeds!`);\n      }\n      \n      timeoutRef.current = setTimeout(() => {\n        setIsAnimating(false);\n        \n        if (checkGameEnd(result.newState)) {\n          endGame(result.newState);\n          return;\n        }\n        \n        if (result.endsInStore) {\n          setMessage(`${player === \"player\" ? \"You get\" : \"AI gets\"} another turn!`);\n          if (player === \"ai\") {\n            aiTurnRef.current = true;\n          }\n        } else {\n          const nextPlayer = player === \"player\" ? \"ai\" : \"player\";\n          setCurrentPlayer(nextPlayer);\n          \n          if (nextPlayer === \"player\") {\n            setMessage(\"Your turn! Click a pit to sow seeds.\");\n          } else {\n            setMessage(\"AI is thinking...\");\n            aiTurnRef.current = true;\n          }\n        }\n      }, 300);\n    }, 600);\n  }, [gameState, endGame]);\n\n  const handlePitClick = useCallback((pitIndex: number) => {\n    if (gamePhase !== \"playing\" || isAnimating) return;\n    if (currentPlayer !== \"player\") return;\n    if (pitIndex >= PITS_PER_SIDE) return;\n    if (gameState.pits[pitIndex] === 0) return;\n    \n    makeMove(pitIndex, \"player\");\n  }, [gamePhase, isAnimating, currentPlayer, gameState.pits, makeMove]);\n\n  useEffect(() => {\n    if (gamePhase !== \"playing\") return;\n    if (isAnimating) return;\n    if (currentPlayer !== \"ai\") return;\n    \n    if (!aiTurnRef.current) {\n      aiTurnRef.current = true;\n    }\n    \n    setIsAiThinking(true);\n    \n    timeoutRef.current = setTimeout(() => {\n      const aiMove = getAiMove(gameState);\n      \n      if (aiMove === -1) {\n        endGame(gameState);\n        setIsAiThinking(false);\n        return;\n      }\n      \n      setIsAiThinking(false);\n      makeMove(aiMove, \"ai\");\n    }, 800 + Math.random() * 400);\n    \n    return () => {\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current);\n      }\n    };\n  }, [gamePhase, isAnimating, currentPlayer, gameState, makeMove, endGame]);\n\n  const resetGame = useCallback(() => {\n    if (timeoutRef.current) {\n      clearTimeout(timeoutRef.current);\n    }\n    setGamePhase(\"ready\");\n    setGameState(createInitialState());\n    setCurrentPlayer(\"player\");\n    setWinner(null);\n    setIsAnimating(false);\n    setLastMovedPit(null);\n    setIsAiThinking(false);\n    aiTurnRef.current = false;\n  }, []);\n\n  if (gamePhase === \"ready\") {\n    return (\n      <div className=\"w-full max-w-3xl mx-auto space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"text-xl flex items-center gap-2\">\n              <Circle className=\"h-6 w-6 text-amber-600 dark:text-amber-400\" />\n              Ayo Olopon (Mancala)\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"text-center space-y-4\"\n            >\n              <Board\n                gameState={gameState}\n                currentPlayer=\"player\"\n                onPitClick={() => {}}\n                isAnimating={false}\n                lastMovedPit={null}\n              />\n              \n              <div className=\"space-y-2\">\n                <h3 className=\"text-lg font-semibold\">Classic Nigerian Board Game</h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  Capture more seeds than your opponent to win!\n                </p>\n              </div>\n            </motion.div>\n\n            <div className=\"p-4 bg-muted/50 rounded-md space-y-3\">\n              <h4 className=\"font-medium flex items-center gap-2\">\n                <Target className=\"h-4 w-4 text-primary\" />\n                How to Play\n              </h4>\n              <ul className=\"text-sm text-muted-foreground space-y-2\">\n                <li className=\"flex items-start gap-2\">\n                  <span className=\"text-primary mt-0.5\">1.</span>\n                  <span>Click any pit on your side (bottom row) to sow seeds counter-clockwise</span>\n                </li>\n                <li className=\"flex items-start gap-2\">\n                  <span className=\"text-primary mt-0.5\">2.</span>\n                  <span>Seeds are dropped one per pit, including your store (right side)</span>\n                </li>\n                <li className=\"flex items-start gap-2\">\n                  <span className=\"text-primary mt-0.5\">3.</span>\n                  <span>Landing in opponent's pit with 2 or 3 seeds captures them</span>\n                </li>\n                <li className=\"flex items-start gap-2\">\n                  <span className=\"text-primary mt-0.5\">4.</span>\n                  <span>The game ends when one side is empty. Most seeds wins!</span>\n                </li>\n              </ul>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"p-3 bg-amber-500/10 rounded-md\">\n                <div className=\"flex items-center gap-2 text-sm font-medium text-amber-600 dark:text-amber-400\">\n                  <User className=\"h-4 w-4\" />\n                  Your Side\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-1\">Bottom row + right store</p>\n              </div>\n              <div className=\"p-3 bg-emerald-500/10 rounded-md\">\n                <div className=\"flex items-center gap-2 text-sm font-medium text-emerald-600 dark:text-emerald-400\">\n                  <Bot className=\"h-4 w-4\" />\n                  AI Side\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-1\">Top row + left store</p>\n              </div>\n            </div>\n\n            {!isPractice && (\n              <div className=\"flex items-center justify-between gap-4 p-3 bg-primary/10 rounded-md\">\n                <span className=\"text-sm font-medium\">Stake Amount</span>\n                <Badge variant=\"secondary\" data-testid=\"badge-stake\">\n                  {stake.toLocaleString()} NGN\n                </Badge>\n              </div>\n            )}\n\n            <Button \n              onClick={startGame} \n              className=\"w-full\" \n              size=\"lg\"\n              data-testid=\"button-start-game\"\n            >\n              <Play className=\"h-5 w-5 mr-2\" />\n              Start Game\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (gamePhase === \"playing\" || gamePhase === \"animating\") {\n    return (\n      <div className=\"w-full max-w-3xl mx-auto space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <CardTitle className=\"text-xl flex items-center gap-2\">\n                <Circle className=\"h-6 w-6 text-amber-600 dark:text-amber-400\" />\n                Ayo Olopon\n              </CardTitle>\n              <div className=\"flex items-center gap-2\">\n                <Badge \n                  className={currentPlayer === \"player\" \n                    ? \"bg-amber-500/20 text-amber-600 dark:text-amber-400\" \n                    : \"bg-emerald-500/20 text-emerald-600 dark:text-emerald-400\"\n                  }\n                  data-testid=\"badge-current-player\"\n                >\n                  {currentPlayer === \"player\" ? (\n                    <>\n                      <User className=\"h-3 w-3 mr-1\" />\n                      Your Turn\n                    </>\n                  ) : (\n                    <>\n                      <Bot className=\"h-3 w-3 mr-1\" />\n                      AI Turn\n                    </>\n                  )}\n                </Badge>\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <Board\n              gameState={gameState}\n              currentPlayer={currentPlayer}\n              onPitClick={handlePitClick}\n              isAnimating={isAnimating}\n              lastMovedPit={lastMovedPit}\n            />\n\n            <motion.div\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              className=\"text-center\"\n            >\n              <p className=\"text-sm font-medium text-muted-foreground\" data-testid=\"text-message\">\n                {isAiThinking ? (\n                  <motion.span\n                    animate={{ opacity: [0.5, 1, 0.5] }}\n                    transition={{ duration: 1.5, repeat: Infinity }}\n                  >\n                    AI is thinking...\n                  </motion.span>\n                ) : (\n                  message\n                )}\n              </p>\n            </motion.div>\n\n            <div className=\"flex items-center justify-between p-4 bg-muted/30 rounded-md\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex items-center gap-2 px-3 py-2 bg-amber-500/20 rounded-md\">\n                  <User className=\"h-4 w-4 text-amber-600 dark:text-amber-400\" />\n                  <span className=\"font-bold text-amber-600 dark:text-amber-400\" data-testid=\"text-player-score\">\n                    {gameState.playerStore}\n                  </span>\n                </div>\n                <span className=\"text-muted-foreground\">vs</span>\n                <div className=\"flex items-center gap-2 px-3 py-2 bg-emerald-500/20 rounded-md\">\n                  <Bot className=\"h-4 w-4 text-emerald-600 dark:text-emerald-400\" />\n                  <span className=\"font-bold text-emerald-600 dark:text-emerald-400\" data-testid=\"text-ai-score\">\n                    {gameState.aiStore}\n                  </span>\n                </div>\n              </div>\n              \n              {!isPractice && (\n                <Badge variant=\"secondary\" data-testid=\"badge-stake-playing\">\n                  {stake.toLocaleString()} NGN\n                </Badge>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const playerTotal = gameState.playerStore;\n  const aiTotal = gameState.aiStore;\n  const isDraw = playerTotal === aiTotal;\n  const playerWon = playerTotal > aiTotal;\n\n  return (\n    <div className=\"w-full max-w-3xl mx-auto space-y-4\">\n      <Card>\n        <CardHeader className=\"pb-4\">\n          <CardTitle className=\"text-xl flex items-center gap-2\">\n            <Trophy className=\"h-6 w-6 text-yellow-500\" />\n            Game Over!\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <Board\n            gameState={gameState}\n            currentPlayer=\"player\"\n            onPitClick={() => {}}\n            isAnimating={false}\n            lastMovedPit={null}\n          />\n\n          <motion.div\n            initial={{ scale: 0.8, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            className=\"text-center space-y-4\"\n          >\n            <AnimatePresence>\n              {playerWon && (\n                <motion.div\n                  initial={{ scale: 0 }}\n                  animate={{ scale: 1 }}\n                  className=\"flex justify-center\"\n                >\n                  <Crown className=\"h-16 w-16 text-yellow-500\" />\n                </motion.div>\n              )}\n            </AnimatePresence>\n\n            {playerWon ? (\n              <div className=\"space-y-2\">\n                <h3 className=\"text-2xl font-bold text-green-600 dark:text-green-400\" data-testid=\"text-result\">\n                  You Win!\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  {isPractice \n                    ? `Great game! You captured ${playerTotal} seeds vs AI's ${aiTotal}`\n                    : `You won ${(playerTotal * 10).toLocaleString()} points!`\n                  }\n                </p>\n              </div>\n            ) : isDraw ? (\n              <div className=\"space-y-2\">\n                <h3 className=\"text-2xl font-bold text-muted-foreground\" data-testid=\"text-result\">\n                  It's a Draw!\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  Both players captured {playerTotal} seeds each\n                </p>\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                <h3 className=\"text-2xl font-bold text-red-600 dark:text-red-400\" data-testid=\"text-result\">\n                  AI Wins!\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  {isPractice \n                    ? `AI captured ${aiTotal} seeds vs your ${playerTotal}. Try again!`\n                    : \"Better luck next time!\"\n                  }\n                </p>\n              </div>\n            )}\n          </motion.div>\n\n          <div className=\"flex items-center justify-center gap-6 p-4 bg-muted/30 rounded-md\">\n            <div className=\"text-center\">\n              <div className={`text-3xl font-bold ${playerWon ? 'text-green-600 dark:text-green-400' : 'text-muted-foreground'}`}>\n                {playerTotal}\n              </div>\n              <div className=\"text-xs text-muted-foreground flex items-center gap-1 justify-center mt-1\">\n                <User className=\"h-3 w-3\" />\n                You\n              </div>\n            </div>\n            <div className=\"text-2xl text-muted-foreground\">vs</div>\n            <div className=\"text-center\">\n              <div className={`text-3xl font-bold ${!playerWon && !isDraw ? 'text-green-600 dark:text-green-400' : 'text-muted-foreground'}`}>\n                {aiTotal}\n              </div>\n              <div className=\"text-xs text-muted-foreground flex items-center gap-1 justify-center mt-1\">\n                <Bot className=\"h-3 w-3\" />\n                AI\n              </div>\n            </div>\n          </div>\n\n          <div className=\"flex gap-3\">\n            <Button \n              onClick={resetGame} \n              variant=\"outline\" \n              className=\"flex-1\"\n              data-testid=\"button-play-again\"\n            >\n              <RotateCcw className=\"h-4 w-4 mr-2\" />\n              Play Again\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":29351,"size_tokens":null},"client/src/components/games/SpinWheelGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  RotateCcw, \n  Trophy, \n  Play,\n  History,\n  Sparkles,\n  Crown,\n  Star,\n  Zap,\n  Target,\n  ChevronDown\n} from \"lucide-react\";\n\ninterface SpinWheelGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype GamePhase = \"ready\" | \"spinning\" | \"result\";\n\ninterface WheelSegment {\n  multiplier: number;\n  label: string;\n  color: string;\n  textColor: string;\n  probability: number;\n}\n\ninterface SpinHistoryItem {\n  id: number;\n  multiplier: number;\n  timestamp: number;\n}\n\nconst WHEEL_SEGMENTS: WheelSegment[] = [\n  { multiplier: 1, label: \"1x\", color: \"#4B5563\", textColor: \"#FFFFFF\", probability: 0.35 },\n  { multiplier: 2, label: \"2x\", color: \"#3B82F6\", textColor: \"#FFFFFF\", probability: 0.30 },\n  { multiplier: 1, label: \"1x\", color: \"#6B7280\", textColor: \"#FFFFFF\", probability: 0.35 },\n  { multiplier: 5, label: \"5x\", color: \"#10B981\", textColor: \"#FFFFFF\", probability: 0.15 },\n  { multiplier: 1, label: \"1x\", color: \"#4B5563\", textColor: \"#FFFFFF\", probability: 0.35 },\n  { multiplier: 2, label: \"2x\", color: \"#6366F1\", textColor: \"#FFFFFF\", probability: 0.30 },\n  { multiplier: 1, label: \"1x\", color: \"#6B7280\", textColor: \"#FFFFFF\", probability: 0.35 },\n  { multiplier: 10, label: \"10x\", color: \"#F59E0B\", textColor: \"#000000\", probability: 0.05 },\n  { multiplier: 1, label: \"1x\", color: \"#4B5563\", textColor: \"#FFFFFF\", probability: 0.35 },\n  { multiplier: 2, label: \"2x\", color: \"#3B82F6\", textColor: \"#FFFFFF\", probability: 0.30 },\n  { multiplier: 1, label: \"1x\", color: \"#6B7280\", textColor: \"#FFFFFF\", probability: 0.35 },\n  { multiplier: 50, label: \"50x\", color: \"#EF4444\", textColor: \"#FFFFFF\", probability: 0.008 },\n  { multiplier: 1, label: \"1x\", color: \"#4B5563\", textColor: \"#FFFFFF\", probability: 0.35 },\n  { multiplier: 2, label: \"2x\", color: \"#6366F1\", textColor: \"#FFFFFF\", probability: 0.30 },\n  { multiplier: 1, label: \"1x\", color: \"#6B7280\", textColor: \"#FFFFFF\", probability: 0.35 },\n  { multiplier: 100, label: \"Jackpot\", color: \"#8B5CF6\", textColor: \"#FFFFFF\", probability: 0.002 },\n];\n\nconst WEIGHTED_OUTCOMES: { segmentIndex: number; weight: number }[] = [\n  { segmentIndex: 0, weight: 18 },\n  { segmentIndex: 1, weight: 10 },\n  { segmentIndex: 2, weight: 18 },\n  { segmentIndex: 3, weight: 5 },\n  { segmentIndex: 4, weight: 18 },\n  { segmentIndex: 5, weight: 10 },\n  { segmentIndex: 6, weight: 18 },\n  { segmentIndex: 7, weight: 1.5 },\n  { segmentIndex: 8, weight: 18 },\n  { segmentIndex: 9, weight: 10 },\n  { segmentIndex: 10, weight: 18 },\n  { segmentIndex: 11, weight: 0.35 },\n  { segmentIndex: 12, weight: 18 },\n  { segmentIndex: 13, weight: 10 },\n  { segmentIndex: 14, weight: 18 },\n  { segmentIndex: 15, weight: 0.15 },\n];\n\nconst TOTAL_WEIGHT = WEIGHTED_OUTCOMES.reduce((sum, o) => sum + o.weight, 0);\n\nconst generateSecureOutcome = (): number => {\n  const array = new Uint32Array(1);\n  crypto.getRandomValues(array);\n  const randomValue = (array[0] / 0x100000000) * TOTAL_WEIGHT;\n  \n  let cumulativeWeight = 0;\n  for (const outcome of WEIGHTED_OUTCOMES) {\n    cumulativeWeight += outcome.weight;\n    if (randomValue <= cumulativeWeight) {\n      return outcome.segmentIndex;\n    }\n  }\n  \n  return 0;\n};\n\nconst getMultiplierColor = (multiplier: number): string => {\n  if (multiplier === 1) return \"bg-gray-500/20 text-gray-600 dark:text-gray-400\";\n  if (multiplier === 2) return \"bg-blue-500/20 text-blue-600 dark:text-blue-400\";\n  if (multiplier === 5) return \"bg-green-500/20 text-green-600 dark:text-green-400\";\n  if (multiplier === 10) return \"bg-amber-500/20 text-amber-600 dark:text-amber-400\";\n  if (multiplier === 50) return \"bg-red-500/20 text-red-600 dark:text-red-400\";\n  return \"bg-purple-500/20 text-purple-600 dark:text-purple-400\";\n};\n\nconst formatMultiplier = (value: number): string => {\n  if (value === 100) return \"Jackpot!\";\n  return value + \"x\";\n};\n\nconst SpinWheel = ({ \n  rotation, \n  isSpinning \n}: { \n  rotation: number; \n  isSpinning: boolean;\n}) => {\n  const segmentCount = WHEEL_SEGMENTS.length;\n  const segmentAngle = 360 / segmentCount;\n  const radius = 140;\n  const centerX = 150;\n  const centerY = 150;\n\n  const polarToCartesian = (centerX: number, centerY: number, radius: number, angleInDegrees: number) => {\n    const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;\n    return {\n      x: centerX + radius * Math.cos(angleInRadians),\n      y: centerY + radius * Math.sin(angleInRadians)\n    };\n  };\n\n  const describeArc = (x: number, y: number, radius: number, startAngle: number, endAngle: number) => {\n    const start = polarToCartesian(x, y, radius, endAngle);\n    const end = polarToCartesian(x, y, radius, startAngle);\n    const largeArcFlag = endAngle - startAngle <= 180 ? \"0\" : \"1\";\n    return [\n      \"M\", x, y,\n      \"L\", start.x, start.y,\n      \"A\", radius, radius, 0, largeArcFlag, 0, end.x, end.y,\n      \"Z\"\n    ].join(\" \");\n  };\n\n  return (\n    <div className=\"relative w-[300px] h-[300px]\" data-testid=\"spin-wheel\">\n      <motion.div\n        className=\"absolute inset-0\"\n        style={{ transformOrigin: 'center center' }}\n        animate={{ rotate: rotation }}\n        transition={isSpinning ? {\n          duration: 5,\n          ease: [0.2, 0.8, 0.3, 1],\n        } : { duration: 0 }}\n      >\n        <svg width=\"300\" height=\"300\" viewBox=\"0 0 300 300\">\n          <defs>\n            <filter id=\"wheelShadow\" x=\"-20%\" y=\"-20%\" width=\"140%\" height=\"140%\">\n              <feDropShadow dx=\"0\" dy=\"4\" stdDeviation=\"4\" floodOpacity=\"0.3\"/>\n            </filter>\n            <radialGradient id=\"wheelGlow\" cx=\"50%\" cy=\"50%\" r=\"50%\">\n              <stop offset=\"0%\" stopColor=\"rgba(255,255,255,0.1)\" />\n              <stop offset=\"100%\" stopColor=\"rgba(0,0,0,0.1)\" />\n            </radialGradient>\n          </defs>\n          \n          <circle cx={centerX} cy={centerY} r={radius + 8} fill=\"#1F2937\" filter=\"url(#wheelShadow)\" />\n          <circle cx={centerX} cy={centerY} r={radius + 5} fill=\"#374151\" />\n          \n          {WHEEL_SEGMENTS.map((segment, index) => {\n            const startAngle = index * segmentAngle;\n            const endAngle = (index + 1) * segmentAngle;\n            const middleAngle = startAngle + segmentAngle / 2;\n            const labelRadius = radius * 0.65;\n            const labelPos = polarToCartesian(centerX, centerY, labelRadius, middleAngle);\n            \n            return (\n              <g key={index}>\n                <path\n                  d={describeArc(centerX, centerY, radius, startAngle, endAngle)}\n                  fill={segment.color}\n                  stroke=\"#1F2937\"\n                  strokeWidth=\"2\"\n                />\n                <text\n                  x={labelPos.x}\n                  y={labelPos.y}\n                  fill={segment.textColor}\n                  fontSize={segment.multiplier >= 50 ? \"11\" : \"14\"}\n                  fontWeight=\"bold\"\n                  textAnchor=\"middle\"\n                  dominantBaseline=\"middle\"\n                  transform={`rotate(${middleAngle}, ${labelPos.x}, ${labelPos.y})`}\n                >\n                  {segment.label}\n                </text>\n              </g>\n            );\n          })}\n          \n          <circle cx={centerX} cy={centerY} r={radius} fill=\"url(#wheelGlow)\" />\n          \n          <circle cx={centerX} cy={centerY} r=\"30\" fill=\"#1F2937\" stroke=\"#4B5563\" strokeWidth=\"3\" />\n          <circle cx={centerX} cy={centerY} r=\"20\" fill=\"#374151\" />\n          <text x={centerX} y={centerY} fill=\"white\" fontSize=\"10\" fontWeight=\"bold\" textAnchor=\"middle\" dominantBaseline=\"middle\">\n            SPIN\n          </text>\n          \n          {[...Array(16)].map((_, i) => {\n            const angle = (i * 360 / 16) - 90;\n            const rad = angle * Math.PI / 180;\n            const x1 = centerX + (radius + 5) * Math.cos(rad);\n            const y1 = centerY + (radius + 5) * Math.sin(rad);\n            const x2 = centerX + (radius + 12) * Math.cos(rad);\n            const y2 = centerY + (radius + 12) * Math.sin(rad);\n            return (\n              <line key={i} x1={x1} y1={y1} x2={x2} y2={y2} stroke=\"#9CA3AF\" strokeWidth=\"2\" />\n            );\n          })}\n        </svg>\n      </motion.div>\n      \n      <div className=\"absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1 z-10\" data-testid=\"wheel-pointer\">\n        <div className=\"relative\">\n          <ChevronDown className=\"h-10 w-10 text-yellow-500 drop-shadow-lg\" strokeWidth={4} />\n          <motion.div\n            className=\"absolute inset-0 flex items-center justify-center\"\n            animate={isSpinning ? {} : { scale: [1, 1.2, 1] }}\n            transition={{ duration: 1, repeat: Infinity }}\n          >\n            <ChevronDown className=\"h-10 w-10 text-yellow-400 opacity-50\" strokeWidth={4} />\n          </motion.div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default function SpinWheelGame({ stake, onGameEnd, isPractice }: SpinWheelGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"ready\");\n  const [rotation, setRotation] = useState(0);\n  const [winningSegmentIndex, setWinningSegmentIndex] = useState<number | null>(null);\n  const [spinHistory, setSpinHistory] = useState<SpinHistoryItem[]>([]);\n  const [showCelebration, setShowCelebration] = useState(false);\n  const [currentWinnings, setCurrentWinnings] = useState(0);\n  \n  const spinTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (spinTimeoutRef.current) {\n        clearTimeout(spinTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  const spinWheel = useCallback(() => {\n    if (gamePhase === \"spinning\") return;\n    \n    setGamePhase(\"spinning\");\n    setShowCelebration(false);\n    \n    const winningIndex = generateSecureOutcome();\n    setWinningSegmentIndex(winningIndex);\n    \n    const segmentAngle = 360 / WHEEL_SEGMENTS.length;\n    const segmentCenterOffset = segmentAngle / 2;\n    \n    const targetAngle = 360 - (winningIndex * segmentAngle) - segmentCenterOffset;\n    \n    const fullRotations = 5 + Math.floor(Math.random() * 3);\n    const finalRotation = rotation + (fullRotations * 360) + targetAngle + (Math.random() * (segmentAngle * 0.6) - segmentAngle * 0.3);\n    \n    setRotation(finalRotation);\n    \n    spinTimeoutRef.current = setTimeout(() => {\n      const segment = WHEEL_SEGMENTS[winningIndex];\n      const winnings = Math.round(stake * segment.multiplier);\n      setCurrentWinnings(winnings);\n      \n      setSpinHistory(prev => {\n        const newHistory = [\n          { \n            id: Date.now(), \n            multiplier: segment.multiplier, \n            timestamp: Date.now() \n          },\n          ...prev\n        ].slice(0, 10);\n        return newHistory;\n      });\n      \n      if (segment.multiplier >= 5) {\n        setShowCelebration(true);\n      }\n      \n      setGamePhase(\"result\");\n      \n      const won = segment.multiplier > 1;\n      onGameEnd(won, won ? winnings : 0);\n    }, 5200);\n  }, [gamePhase, rotation, stake, onGameEnd]);\n\n  const resetGame = useCallback(() => {\n    setGamePhase(\"ready\");\n    setWinningSegmentIndex(null);\n    setShowCelebration(false);\n    setCurrentWinnings(0);\n  }, []);\n\n  const getWinningSegment = () => {\n    if (winningSegmentIndex === null) return null;\n    return WHEEL_SEGMENTS[winningSegmentIndex];\n  };\n\n  if (gamePhase === \"ready\") {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"text-xl flex items-center gap-2\">\n              <Target className=\"h-6 w-6 text-primary\" />\n              Spin The Wheel\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"flex flex-col items-center space-y-4\"\n            >\n              <SpinWheel rotation={rotation} isSpinning={false} />\n              \n              <div className=\"text-center space-y-2\">\n                <h3 className=\"text-lg font-semibold\">Test Your Luck!</h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  Spin the wheel and win up to 100x your stake!\n                </p>\n              </div>\n            </motion.div>\n\n            <div className=\"space-y-4\">\n              <div className=\"p-4 bg-muted/50 rounded-md space-y-3\">\n                <h4 className=\"font-medium flex items-center gap-2\">\n                  <Sparkles className=\"h-4 w-4 text-primary\" />\n                  Multipliers\n                </h4>\n                <div className=\"flex flex-wrap gap-2\">\n                  <Badge className=\"bg-gray-500/20 text-gray-600 dark:text-gray-400\">1x</Badge>\n                  <Badge className=\"bg-blue-500/20 text-blue-600 dark:text-blue-400\">2x</Badge>\n                  <Badge className=\"bg-green-500/20 text-green-600 dark:text-green-400\">5x</Badge>\n                  <Badge className=\"bg-amber-500/20 text-amber-600 dark:text-amber-400\">10x</Badge>\n                  <Badge className=\"bg-red-500/20 text-red-600 dark:text-red-400\">50x</Badge>\n                  <Badge className=\"bg-purple-500/20 text-purple-600 dark:text-purple-400\">Jackpot (100x)</Badge>\n                </div>\n              </div>\n\n              {spinHistory.length > 0 && (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2 text-sm font-medium\">\n                    <History className=\"h-4 w-4 text-muted-foreground\" />\n                    Recent Spins\n                  </div>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {spinHistory.slice(0, 8).map((item) => (\n                      <Badge\n                        key={item.id}\n                        className={getMultiplierColor(item.multiplier)}\n                        data-testid={`badge-history-${item.id}`}\n                      >\n                        {formatMultiplier(item.multiplier)}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {!isPractice && (\n                <div className=\"flex items-center justify-between gap-4 p-3 bg-primary/10 rounded-md\">\n                  <span className=\"text-sm font-medium\">Stake Amount</span>\n                  <Badge variant=\"secondary\" data-testid=\"badge-stake\">\n                    {stake.toLocaleString()} NGN\n                  </Badge>\n                </div>\n              )}\n            </div>\n\n            <Button \n              onClick={spinWheel} \n              className=\"w-full\" \n              size=\"lg\"\n              data-testid=\"button-spin\"\n            >\n              <Play className=\"h-5 w-5 mr-2\" />\n              Spin The Wheel\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (gamePhase === \"spinning\") {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <CardTitle className=\"text-xl flex items-center gap-2\">\n                <Target className=\"h-6 w-6 text-primary\" />\n                Spin The Wheel\n              </CardTitle>\n              <Badge className=\"bg-amber-500/20 text-amber-600 dark:text-amber-400\" data-testid=\"badge-spinning\">\n                <motion.div\n                  animate={{ rotate: 360 }}\n                  transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\n                  className=\"mr-1\"\n                >\n                  <Zap className=\"h-3 w-3\" />\n                </motion.div>\n                Spinning...\n              </Badge>\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <div className=\"flex flex-col items-center space-y-4\">\n              <SpinWheel rotation={rotation} isSpinning={true} />\n              \n              <motion.p\n                animate={{ opacity: [0.5, 1, 0.5] }}\n                transition={{ duration: 1.5, repeat: Infinity }}\n                className=\"text-lg font-semibold text-muted-foreground\"\n              >\n                Good luck!\n              </motion.p>\n            </div>\n\n            {!isPractice && (\n              <div className=\"flex items-center justify-between gap-4 p-3 bg-primary/10 rounded-md\">\n                <span className=\"text-sm font-medium\">Stake Amount</span>\n                <Badge variant=\"secondary\" data-testid=\"badge-stake-spinning\">\n                  {stake.toLocaleString()} NGN\n                </Badge>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const winningSegment = getWinningSegment();\n  const won = winningSegment && winningSegment.multiplier > 1;\n  const isBigWin = winningSegment && winningSegment.multiplier >= 10;\n  const isJackpot = winningSegment && winningSegment.multiplier === 100;\n\n  return (\n    <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n      <Card className=\"overflow-visible\">\n        <CardHeader className=\"pb-4\">\n          <CardTitle className=\"text-xl flex items-center gap-2\">\n            <Trophy className=\"h-6 w-6 text-yellow-500\" />\n            Spin Complete!\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <AnimatePresence>\n            {showCelebration && (\n              <motion.div\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                exit={{ opacity: 0 }}\n                className=\"absolute inset-0 pointer-events-none overflow-hidden\"\n              >\n                {[...Array(20)].map((_, i) => (\n                  <motion.div\n                    key={i}\n                    className=\"absolute\"\n                    initial={{ \n                      x: \"50%\", \n                      y: \"50%\",\n                      scale: 0 \n                    }}\n                    animate={{ \n                      x: `${Math.random() * 100}%`,\n                      y: `${Math.random() * 100}%`,\n                      scale: [0, 1, 0],\n                      rotate: [0, 180, 360]\n                    }}\n                    transition={{ \n                      duration: 2,\n                      delay: i * 0.1,\n                      repeat: 2\n                    }}\n                  >\n                    <Star className={`h-6 w-6 ${isJackpot ? 'text-purple-500' : 'text-yellow-500'}`} />\n                  </motion.div>\n                ))}\n              </motion.div>\n            )}\n          </AnimatePresence>\n\n          <div className=\"flex flex-col items-center space-y-4\">\n            <SpinWheel rotation={rotation} isSpinning={false} />\n          </div>\n\n          <motion.div\n            initial={{ scale: 0.8, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            className=\"text-center\"\n          >\n            {isJackpot ? (\n              <div className=\"space-y-3\">\n                <motion.div\n                  animate={{ \n                    rotate: [0, -10, 10, -10, 10, 0],\n                    scale: [1, 1.1, 1]\n                  }}\n                  transition={{ duration: 0.5, repeat: 3 }}\n                >\n                  <Crown className=\"h-20 w-20 mx-auto text-purple-500\" />\n                </motion.div>\n                <h3 className=\"text-3xl font-black text-purple-600 dark:text-purple-400\" data-testid=\"text-result\">\n                  JACKPOT!!!\n                </h3>\n                <p className=\"text-xl font-bold text-foreground\">\n                  {isPractice \n                    ? \"You hit the jackpot!\"\n                    : `You won ${currentWinnings.toLocaleString()} NGN!`\n                  }\n                </p>\n              </div>\n            ) : isBigWin ? (\n              <div className=\"space-y-2\">\n                <motion.div\n                  animate={{ rotate: [0, -10, 10, -10, 10, 0] }}\n                  transition={{ duration: 0.5 }}\n                >\n                  <Crown className=\"h-16 w-16 mx-auto text-yellow-500\" />\n                </motion.div>\n                <h3 className=\"text-2xl font-bold text-yellow-600 dark:text-yellow-400\" data-testid=\"text-result\">\n                  Big Win! {winningSegment?.label}\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  {isPractice \n                    ? `Amazing! You landed on ${winningSegment?.label}!`\n                    : `You won ${currentWinnings.toLocaleString()} NGN!`\n                  }\n                </p>\n              </div>\n            ) : won ? (\n              <div className=\"space-y-2\">\n                <motion.div\n                  animate={{ scale: [1, 1.1, 1] }}\n                  transition={{ duration: 0.3 }}\n                >\n                  <Trophy className=\"h-16 w-16 mx-auto text-green-500\" />\n                </motion.div>\n                <h3 className=\"text-2xl font-bold text-green-600 dark:text-green-400\" data-testid=\"text-result\">\n                  You Win! {winningSegment?.label}\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  {isPractice \n                    ? `Nice! You landed on ${winningSegment?.label}!`\n                    : `You won ${currentWinnings.toLocaleString()} NGN!`\n                  }\n                </p>\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                <div className=\"h-16 w-16 mx-auto rounded-full bg-muted flex items-center justify-center\">\n                  <span className=\"text-3xl font-bold text-muted-foreground\">1x</span>\n                </div>\n                <h3 className=\"text-2xl font-bold text-muted-foreground\" data-testid=\"text-result\">\n                  Break Even\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  {isPractice \n                    ? \"You landed on 1x. Your stake is returned!\"\n                    : `You get back ${stake.toLocaleString()} NGN`\n                  }\n                </p>\n              </div>\n            )}\n          </motion.div>\n\n          <div className=\"flex items-center justify-center gap-2 p-4 bg-muted/30 rounded-md\">\n            <span className=\"text-sm font-medium\">Result:</span>\n            <Badge className={getMultiplierColor(winningSegment?.multiplier || 1)} data-testid=\"badge-result\">\n              {formatMultiplier(winningSegment?.multiplier || 1)}\n            </Badge>\n            {!isPractice && (\n              <>\n                <span className=\"text-muted-foreground mx-2\">|</span>\n                <span className=\"text-sm font-medium\">Winnings:</span>\n                <Badge variant=\"secondary\" data-testid=\"badge-winnings\">\n                  {currentWinnings.toLocaleString()} NGN\n                </Badge>\n              </>\n            )}\n          </div>\n\n          {spinHistory.length > 0 && (\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 text-sm font-medium\">\n                <History className=\"h-4 w-4 text-muted-foreground\" />\n                Recent Spins\n              </div>\n              <div className=\"flex flex-wrap gap-2\">\n                {spinHistory.slice(0, 8).map((item) => (\n                  <Badge\n                    key={item.id}\n                    className={getMultiplierColor(item.multiplier)}\n                    data-testid={`badge-history-result-${item.id}`}\n                  >\n                    {formatMultiplier(item.multiplier)}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n          )}\n\n          <Button \n            onClick={resetGame} \n            className=\"w-full\" \n            size=\"lg\"\n            data-testid=\"button-spin-again\"\n          >\n            <RotateCcw className=\"h-5 w-5 mr-2\" />\n            Spin Again\n          </Button>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":24289,"size_tokens":null},"client/src/components/games/DiceDuelGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  Dice1, \n  Dice2, \n  Dice3, \n  Dice4, \n  Dice5, \n  Dice6, \n  RotateCcw, \n  Trophy, \n  Bot, \n  User, \n  Play,\n  Crown,\n  Sparkles,\n  Zap,\n  Target\n} from \"lucide-react\";\n\ninterface DiceDuelGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype GamePhase = \"ready\" | \"rolling\" | \"result\";\n\ntype HandRank = \n  | \"five_of_a_kind\"\n  | \"four_of_a_kind\"\n  | \"full_house\"\n  | \"straight\"\n  | \"three_of_a_kind\"\n  | \"two_pair\"\n  | \"one_pair\"\n  | \"high_card\";\n\ninterface HandResult {\n  rank: HandRank;\n  rankValue: number;\n  name: string;\n  highDice: number[];\n}\n\nconst HAND_RANKINGS: Record<HandRank, { value: number; name: string }> = {\n  five_of_a_kind: { value: 8, name: \"Five of a Kind\" },\n  four_of_a_kind: { value: 7, name: \"Four of a Kind\" },\n  full_house: { value: 6, name: \"Full House\" },\n  straight: { value: 5, name: \"Straight\" },\n  three_of_a_kind: { value: 4, name: \"Three of a Kind\" },\n  two_pair: { value: 3, name: \"Two Pair\" },\n  one_pair: { value: 2, name: \"One Pair\" },\n  high_card: { value: 1, name: \"High Card\" },\n};\n\nconst DiceIcons = [Dice1, Dice2, Dice3, Dice4, Dice5, Dice6];\n\nconst secureRandom = (): number => {\n  const array = new Uint32Array(1);\n  crypto.getRandomValues(array);\n  return array[0] / 0x100000000;\n};\n\nconst rollDice = (): number[] => {\n  const dice: number[] = [];\n  for (let i = 0; i < 5; i++) {\n    dice.push(Math.floor(secureRandom() * 6) + 1);\n  }\n  return dice;\n};\n\nconst evaluateHand = (dice: number[]): HandResult => {\n  const counts: Record<number, number> = {};\n  dice.forEach(d => {\n    counts[d] = (counts[d] || 0) + 1;\n  });\n  \n  const countValues = Object.values(counts).sort((a, b) => b - a);\n  const uniqueValues = Object.keys(counts).map(Number).sort((a, b) => b - a);\n  const sortedDice = [...dice].sort((a, b) => b - a);\n  \n  const isStraight = (vals: number[]): boolean => {\n    const sorted = Array.from(new Set(vals)).sort((a, b) => a - b);\n    if (sorted.length !== 5) return false;\n    return sorted[4] - sorted[0] === 4;\n  };\n  \n  if (countValues[0] === 5) {\n    return {\n      rank: \"five_of_a_kind\",\n      rankValue: HAND_RANKINGS.five_of_a_kind.value,\n      name: HAND_RANKINGS.five_of_a_kind.name,\n      highDice: [uniqueValues[0]]\n    };\n  }\n  \n  if (countValues[0] === 4) {\n    const fourKind = uniqueValues.find(v => counts[v] === 4)!;\n    return {\n      rank: \"four_of_a_kind\",\n      rankValue: HAND_RANKINGS.four_of_a_kind.value,\n      name: HAND_RANKINGS.four_of_a_kind.name,\n      highDice: [fourKind]\n    };\n  }\n  \n  if (countValues[0] === 3 && countValues[1] === 2) {\n    const threeKind = uniqueValues.find(v => counts[v] === 3)!;\n    const pair = uniqueValues.find(v => counts[v] === 2)!;\n    return {\n      rank: \"full_house\",\n      rankValue: HAND_RANKINGS.full_house.value,\n      name: HAND_RANKINGS.full_house.name,\n      highDice: [threeKind, pair]\n    };\n  }\n  \n  if (isStraight(dice)) {\n    return {\n      rank: \"straight\",\n      rankValue: HAND_RANKINGS.straight.value,\n      name: HAND_RANKINGS.straight.name,\n      highDice: [Math.max(...dice)]\n    };\n  }\n  \n  if (countValues[0] === 3) {\n    const threeKind = uniqueValues.find(v => counts[v] === 3)!;\n    return {\n      rank: \"three_of_a_kind\",\n      rankValue: HAND_RANKINGS.three_of_a_kind.value,\n      name: HAND_RANKINGS.three_of_a_kind.name,\n      highDice: [threeKind]\n    };\n  }\n  \n  if (countValues[0] === 2 && countValues[1] === 2) {\n    const pairs = uniqueValues.filter(v => counts[v] === 2).sort((a, b) => b - a);\n    return {\n      rank: \"two_pair\",\n      rankValue: HAND_RANKINGS.two_pair.value,\n      name: HAND_RANKINGS.two_pair.name,\n      highDice: pairs\n    };\n  }\n  \n  if (countValues[0] === 2) {\n    const pairValue = uniqueValues.find(v => counts[v] === 2)!;\n    return {\n      rank: \"one_pair\",\n      rankValue: HAND_RANKINGS.one_pair.value,\n      name: HAND_RANKINGS.one_pair.name,\n      highDice: [pairValue]\n    };\n  }\n  \n  return {\n    rank: \"high_card\",\n    rankValue: HAND_RANKINGS.high_card.value,\n    name: HAND_RANKINGS.high_card.name,\n    highDice: sortedDice\n  };\n};\n\nconst compareHands = (playerHand: HandResult, aiHand: HandResult): \"player\" | \"ai\" | \"tie\" => {\n  if (playerHand.rankValue > aiHand.rankValue) return \"player\";\n  if (playerHand.rankValue < aiHand.rankValue) return \"ai\";\n  \n  for (let i = 0; i < Math.min(playerHand.highDice.length, aiHand.highDice.length); i++) {\n    if (playerHand.highDice[i] > aiHand.highDice[i]) return \"player\";\n    if (playerHand.highDice[i] < aiHand.highDice[i]) return \"ai\";\n  }\n  \n  return \"tie\";\n};\n\nconst getHandColor = (rank: HandRank): string => {\n  switch (rank) {\n    case \"five_of_a_kind\":\n      return \"bg-purple-500/20 text-purple-600 dark:text-purple-400\";\n    case \"four_of_a_kind\":\n      return \"bg-yellow-500/20 text-yellow-600 dark:text-yellow-400\";\n    case \"full_house\":\n      return \"bg-orange-500/20 text-orange-600 dark:text-orange-400\";\n    case \"straight\":\n      return \"bg-blue-500/20 text-blue-600 dark:text-blue-400\";\n    case \"three_of_a_kind\":\n      return \"bg-green-500/20 text-green-600 dark:text-green-400\";\n    case \"two_pair\":\n      return \"bg-cyan-500/20 text-cyan-600 dark:text-cyan-400\";\n    case \"one_pair\":\n      return \"bg-pink-500/20 text-pink-600 dark:text-pink-400\";\n    default:\n      return \"bg-gray-500/20 text-gray-600 dark:text-gray-400\";\n  }\n};\n\nconst calculateScore = (hand: HandResult): number => {\n  const baseScores: Record<HandRank, number> = {\n    five_of_a_kind: 100,\n    four_of_a_kind: 80,\n    full_house: 70,\n    straight: 60,\n    three_of_a_kind: 50,\n    two_pair: 40,\n    one_pair: 30,\n    high_card: 20,\n  };\n  return baseScores[hand.rank];\n};\n\nconst DiceDisplay = ({ \n  dice, \n  isRolling, \n  label,\n  isWinner,\n  handResult\n}: { \n  dice: number[]; \n  isRolling: boolean;\n  label: string;\n  isWinner: boolean;\n  handResult: HandResult | null;\n}) => {\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      className={`p-4 rounded-lg border-2 ${isWinner ? 'border-yellow-500 bg-yellow-500/10' : 'border-muted bg-muted/30'}`}\n    >\n      <div className=\"flex items-center gap-2 mb-3\">\n        {label === \"You\" ? (\n          <User className=\"h-5 w-5 text-blue-500\" />\n        ) : (\n          <Bot className=\"h-5 w-5 text-purple-500\" />\n        )}\n        <span className=\"font-semibold\">{label}</span>\n        {isWinner && (\n          <motion.div\n            initial={{ scale: 0 }}\n            animate={{ scale: 1 }}\n            transition={{ type: \"spring\", stiffness: 500, damping: 30 }}\n          >\n            <Crown className=\"h-5 w-5 text-yellow-500\" />\n          </motion.div>\n        )}\n      </div>\n      \n      <div className=\"flex items-center justify-center gap-2 mb-3\">\n        {dice.map((value, index) => {\n          const DiceIcon = DiceIcons[value - 1] || Dice1;\n          return (\n            <motion.div\n              key={index}\n              animate={isRolling ? { \n                rotate: [0, 90, 180, 270, 360],\n                scale: [1, 1.1, 1, 1.1, 1]\n              } : { rotate: 0 }}\n              transition={{ \n                duration: 0.4, \n                repeat: isRolling ? Infinity : 0,\n                delay: index * 0.1\n              }}\n              className=\"relative\"\n            >\n              <div className=\"absolute inset-0 bg-gradient-to-br from-white/20 to-transparent rounded-lg\" />\n              <DiceIcon className={`h-10 w-10 ${isWinner ? 'text-yellow-600' : ''} drop-shadow-lg`} />\n            </motion.div>\n          );\n        })}\n      </div>\n      \n      {handResult && !isRolling && (\n        <motion.div\n          initial={{ opacity: 0, scale: 0.8 }}\n          animate={{ opacity: 1, scale: 1 }}\n          className=\"text-center\"\n        >\n          <Badge className={getHandColor(handResult.rank)} data-testid={`badge-hand-${label.toLowerCase().replace(' ', '-')}`}>\n            {handResult.name}\n          </Badge>\n        </motion.div>\n      )}\n    </motion.div>\n  );\n};\n\nexport default function DiceDuelGame({ stake, onGameEnd, isPractice }: DiceDuelGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"ready\");\n  const [playerDice, setPlayerDice] = useState<number[]>([1, 2, 3, 4, 5]);\n  const [aiDice, setAiDice] = useState<number[]>([1, 2, 3, 4, 5]);\n  const [playerHand, setPlayerHand] = useState<HandResult | null>(null);\n  const [aiHand, setAiHand] = useState<HandResult | null>(null);\n  const [winner, setWinner] = useState<\"player\" | \"ai\" | \"tie\" | null>(null);\n  const [isRolling, setIsRolling] = useState(false);\n  const [message, setMessage] = useState(\"Roll the dice to duel!\");\n  \n  const rollTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const resultTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (rollTimeoutRef.current) {\n        clearTimeout(rollTimeoutRef.current);\n      }\n      if (resultTimeoutRef.current) {\n        clearTimeout(resultTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  const startGame = useCallback(() => {\n    setGamePhase(\"rolling\");\n    setIsRolling(true);\n    setMessage(\"Rolling dice...\");\n    setWinner(null);\n    setPlayerHand(null);\n    setAiHand(null);\n    \n    let rollCount = 0;\n    const maxRolls = 15;\n    \n    const animateRoll = () => {\n      setPlayerDice(rollDice());\n      setAiDice(rollDice());\n      rollCount++;\n      \n      if (rollCount < maxRolls) {\n        rollTimeoutRef.current = setTimeout(animateRoll, 100);\n      } else {\n        const finalPlayerDice = rollDice();\n        const finalAiDice = rollDice();\n        \n        setPlayerDice(finalPlayerDice);\n        setAiDice(finalAiDice);\n        setIsRolling(false);\n        \n        const pHand = evaluateHand(finalPlayerDice);\n        const aHand = evaluateHand(finalAiDice);\n        \n        setPlayerHand(pHand);\n        setAiHand(aHand);\n        \n        const result = compareHands(pHand, aHand);\n        setWinner(result);\n        setGamePhase(\"result\");\n        \n        if (result === \"player\") {\n          setMessage(\"You win the duel!\");\n          const score = calculateScore(pHand);\n          onGameEnd(true, score);\n        } else if (result === \"ai\") {\n          setMessage(\"AI wins the duel!\");\n          onGameEnd(false, 0);\n        } else {\n          setMessage(\"It's a tie! Dice are rolled again.\");\n          resultTimeoutRef.current = setTimeout(() => {\n            startGame();\n          }, 2000);\n        }\n      }\n    };\n    \n    animateRoll();\n  }, [onGameEnd]);\n\n  const resetGame = useCallback(() => {\n    if (rollTimeoutRef.current) {\n      clearTimeout(rollTimeoutRef.current);\n    }\n    if (resultTimeoutRef.current) {\n      clearTimeout(resultTimeoutRef.current);\n    }\n    \n    setGamePhase(\"ready\");\n    setPlayerDice([1, 2, 3, 4, 5]);\n    setAiDice([1, 2, 3, 4, 5]);\n    setPlayerHand(null);\n    setAiHand(null);\n    setWinner(null);\n    setIsRolling(false);\n    setMessage(\"Roll the dice to duel!\");\n  }, []);\n\n  if (gamePhase === \"ready\") {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"text-xl flex items-center gap-2\">\n              <Target className=\"h-6 w-6 text-primary\" />\n              Dice Duel\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"text-center space-y-4\"\n            >\n              <div className=\"relative mx-auto w-24 h-24 mb-4\">\n                <motion.div\n                  animate={{ \n                    scale: [1, 1.1, 1],\n                    rotate: [0, 5, -5, 0]\n                  }}\n                  transition={{ \n                    duration: 1.5, \n                    repeat: Infinity,\n                    repeatType: \"reverse\"\n                  }}\n                  className=\"w-full h-full rounded-full bg-gradient-to-br from-red-500 via-orange-500 to-yellow-500 flex items-center justify-center shadow-lg\"\n                >\n                  <Dice6 className=\"h-12 w-12 text-white\" />\n                </motion.div>\n                <motion.div\n                  animate={{ \n                    scale: [1, 1.3, 1],\n                    opacity: [0.5, 1, 0.5]\n                  }}\n                  transition={{ \n                    duration: 1.5, \n                    repeat: Infinity \n                  }}\n                  className=\"absolute -top-1 -right-1 w-8 h-8 rounded-full bg-yellow-400 flex items-center justify-center\"\n                >\n                  <Sparkles className=\"h-4 w-4 text-yellow-800\" />\n                </motion.div>\n              </div>\n              \n              <div>\n                <h3 className=\"text-lg font-semibold\">Roll for Victory!</h3>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Roll 5 dice and get the best poker hand to beat the AI!\n                </p>\n              </div>\n            </motion.div>\n\n            <div className=\"space-y-4\">\n              <div className=\"p-4 bg-muted/50 rounded-md space-y-3\">\n                <h4 className=\"font-medium flex items-center gap-2\">\n                  <Crown className=\"h-4 w-4 text-yellow-500\" />\n                  Hand Rankings (Best to Worst)\n                </h4>\n                <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                  <div className=\"flex items-center gap-2\">\n                    <Badge className=\"bg-purple-500/20 text-purple-600 dark:text-purple-400\">1</Badge>\n                    <span>Five of a Kind</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge className=\"bg-yellow-500/20 text-yellow-600 dark:text-yellow-400\">2</Badge>\n                    <span>Four of a Kind</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge className=\"bg-orange-500/20 text-orange-600 dark:text-orange-400\">3</Badge>\n                    <span>Full House</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge className=\"bg-blue-500/20 text-blue-600 dark:text-blue-400\">4</Badge>\n                    <span>Straight</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge className=\"bg-green-500/20 text-green-600 dark:text-green-400\">5</Badge>\n                    <span>Three of a Kind</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge className=\"bg-cyan-500/20 text-cyan-600 dark:text-cyan-400\">6</Badge>\n                    <span>Two Pair</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge className=\"bg-pink-500/20 text-pink-600 dark:text-pink-400\">7</Badge>\n                    <span>One Pair</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge className=\"bg-gray-500/20 text-gray-600 dark:text-gray-400\">8</Badge>\n                    <span>High Card</span>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                <div className=\"flex items-center gap-2 p-3 bg-muted/30 rounded-md\">\n                  <User className=\"h-4 w-4 text-blue-500\" />\n                  <span>You</span>\n                </div>\n                <div className=\"flex items-center gap-2 p-3 bg-muted/30 rounded-md\">\n                  <Bot className=\"h-4 w-4 text-purple-500\" />\n                  <span>AI Opponent</span>\n                </div>\n              </div>\n\n              {!isPractice && (\n                <div className=\"flex items-center justify-between gap-4 p-3 bg-primary/10 rounded-md\">\n                  <span className=\"text-sm font-medium\">Stake Amount</span>\n                  <Badge variant=\"secondary\" data-testid=\"badge-stake\">\n                    {stake.toLocaleString()} NGN\n                  </Badge>\n                </div>\n              )}\n            </div>\n\n            <Button \n              onClick={startGame} \n              className=\"w-full\" \n              size=\"lg\"\n              data-testid=\"button-start-diceduel\"\n            >\n              <Play className=\"h-5 w-5 mr-2\" />\n              Roll the Dice\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (gamePhase === \"rolling\") {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <CardTitle className=\"text-xl flex items-center gap-2\">\n                <Target className=\"h-6 w-6 text-primary\" />\n                Dice Duel\n              </CardTitle>\n              <Badge className=\"bg-amber-500/20 text-amber-600 dark:text-amber-400\" data-testid=\"badge-rolling\">\n                <motion.div\n                  animate={{ rotate: 360 }}\n                  transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\n                  className=\"mr-1\"\n                >\n                  <Zap className=\"h-3 w-3\" />\n                </motion.div>\n                Rolling...\n              </Badge>\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <div className=\"grid gap-4\">\n              <DiceDisplay \n                dice={playerDice} \n                isRolling={isRolling}\n                label=\"You\"\n                isWinner={false}\n                handResult={null}\n              />\n              \n              <div className=\"flex items-center justify-center\">\n                <Badge variant=\"outline\" className=\"text-lg px-4 py-1\">\n                  VS\n                </Badge>\n              </div>\n              \n              <DiceDisplay \n                dice={aiDice} \n                isRolling={isRolling}\n                label=\"AI\"\n                isWinner={false}\n                handResult={null}\n              />\n            </div>\n\n            <motion.p\n              animate={{ opacity: [0.5, 1, 0.5] }}\n              transition={{ duration: 1.5, repeat: Infinity }}\n              className=\"text-lg font-semibold text-center text-muted-foreground\"\n              data-testid=\"text-message\"\n            >\n              {message}\n            </motion.p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const playerWon = winner === \"player\";\n  const isTie = winner === \"tie\";\n\n  return (\n    <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n      <Card className=\"overflow-visible\">\n        <CardHeader className=\"pb-4\">\n          <CardTitle className=\"text-xl flex items-center gap-2\">\n            <Trophy className=\"h-6 w-6 text-yellow-500\" />\n            Duel Complete!\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <AnimatePresence>\n            {playerWon && (\n              <motion.div\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                exit={{ opacity: 0 }}\n                className=\"absolute inset-0 pointer-events-none overflow-hidden\"\n              >\n                {[...Array(15)].map((_, i) => (\n                  <motion.div\n                    key={i}\n                    className=\"absolute\"\n                    initial={{ \n                      x: \"50%\", \n                      y: \"50%\",\n                      scale: 0 \n                    }}\n                    animate={{ \n                      x: `${Math.random() * 100}%`,\n                      y: `${Math.random() * 100}%`,\n                      scale: [0, 1, 0],\n                      rotate: [0, 180, 360]\n                    }}\n                    transition={{ \n                      duration: 2,\n                      delay: i * 0.1,\n                      repeat: 2\n                    }}\n                  >\n                    <Sparkles className=\"h-6 w-6 text-yellow-500\" />\n                  </motion.div>\n                ))}\n              </motion.div>\n            )}\n          </AnimatePresence>\n\n          <div className=\"grid gap-4\">\n            <DiceDisplay \n              dice={playerDice} \n              isRolling={false}\n              label=\"You\"\n              isWinner={playerWon}\n              handResult={playerHand}\n            />\n            \n            <div className=\"flex items-center justify-center\">\n              <Badge variant=\"outline\" className=\"text-lg px-4 py-1\">\n                VS\n              </Badge>\n            </div>\n            \n            <DiceDisplay \n              dice={aiDice} \n              isRolling={false}\n              label=\"AI\"\n              isWinner={winner === \"ai\"}\n              handResult={aiHand}\n            />\n          </div>\n\n          <motion.div\n            initial={{ scale: 0.8, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            className=\"text-center\"\n          >\n            {playerWon ? (\n              <div className=\"space-y-2\">\n                <motion.div\n                  animate={{ \n                    rotate: [0, -10, 10, -10, 10, 0],\n                    scale: [1, 1.1, 1]\n                  }}\n                  transition={{ duration: 0.5 }}\n                >\n                  <Trophy className=\"h-16 w-16 mx-auto text-yellow-500\" />\n                </motion.div>\n                <h3 className=\"text-2xl font-bold text-green-600 dark:text-green-400\" data-testid=\"text-result\">\n                  You Win!\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  {isPractice \n                    ? `Your ${playerHand?.name} beats AI's ${aiHand?.name}!`\n                    : `You won with ${playerHand?.name}!`\n                  }\n                </p>\n              </div>\n            ) : isTie ? (\n              <div className=\"space-y-2\">\n                <div className=\"h-16 w-16 mx-auto rounded-full bg-muted flex items-center justify-center\">\n                  <span className=\"text-3xl font-bold text-muted-foreground\">=</span>\n                </div>\n                <h3 className=\"text-2xl font-bold text-muted-foreground\" data-testid=\"text-result\">\n                  It's a Tie!\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  Both rolled {playerHand?.name}. Rolling again...\n                </p>\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                <div className=\"h-16 w-16 mx-auto rounded-full bg-muted flex items-center justify-center\">\n                  <Bot className=\"h-10 w-10 text-purple-500\" />\n                </div>\n                <h3 className=\"text-2xl font-bold text-red-600 dark:text-red-400\" data-testid=\"text-result\">\n                  AI Wins!\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  AI's {aiHand?.name} beats your {playerHand?.name}\n                </p>\n              </div>\n            )}\n          </motion.div>\n\n          {!isTie && (\n            <div className=\"flex items-center justify-center gap-2 p-4 bg-muted/30 rounded-md\">\n              <span className=\"text-sm font-medium\">Your Hand:</span>\n              <Badge className={playerHand ? getHandColor(playerHand.rank) : \"\"} data-testid=\"badge-player-hand\">\n                {playerHand?.name || \"Unknown\"}\n              </Badge>\n              <span className=\"text-muted-foreground mx-2\">vs</span>\n              <Badge className={aiHand ? getHandColor(aiHand.rank) : \"\"} data-testid=\"badge-ai-hand\">\n                {aiHand?.name || \"Unknown\"}\n              </Badge>\n            </div>\n          )}\n\n          {!isTie && (\n            <Button \n              onClick={resetGame} \n              variant=\"outline\" \n              className=\"w-full\"\n              data-testid=\"button-play-again\"\n            >\n              <RotateCcw className=\"h-4 w-4 mr-2\" />\n              Play Again\n            </Button>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":24607,"size_tokens":null},"client/src/components/games/ColourColourGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  RotateCcw, \n  Trophy, \n  Play,\n  Target,\n  History,\n  Sparkles,\n  Crown,\n  X,\n  Coins,\n  Palette,\n  Hash,\n  Check,\n  Loader2\n} from \"lucide-react\";\n\ninterface ColourColourGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype GamePhase = \"betting\" | \"spinning\" | \"result\";\ntype WheelColor = \"red\" | \"green\" | \"purple\" | \"yellow\";\n\ninterface Bet {\n  type: \"color\" | \"number\";\n  value: WheelColor | number;\n  amount: number;\n}\n\ninterface WheelSegment {\n  color: WheelColor;\n  number: number;\n}\n\ninterface SpinResult {\n  segment: WheelSegment;\n  timestamp: number;\n}\n\nconst COLORS: WheelColor[] = [\"red\", \"green\", \"purple\", \"yellow\"];\nconst COLOR_PAYOUT = 1.95;\nconst NUMBER_PAYOUT = 9;\n\nconst WHEEL_SEGMENTS: WheelSegment[] = [];\nfor (let i = 0; i < 10; i++) {\n  const color = COLORS[i % 4];\n  WHEEL_SEGMENTS.push({ color, number: i });\n}\n\nconst COLOR_STYLES: Record<WheelColor, { bg: string; text: string; border: string; gradient: string }> = {\n  red: { \n    bg: \"bg-red-500\", \n    text: \"text-red-600 dark:text-red-400\", \n    border: \"border-red-500\",\n    gradient: \"from-red-500 to-red-600\"\n  },\n  green: { \n    bg: \"bg-green-500\", \n    text: \"text-green-600 dark:text-green-400\", \n    border: \"border-green-500\",\n    gradient: \"from-green-500 to-green-600\"\n  },\n  purple: { \n    bg: \"bg-purple-500\", \n    text: \"text-purple-600 dark:text-purple-400\", \n    border: \"border-purple-500\",\n    gradient: \"from-purple-500 to-purple-600\"\n  },\n  yellow: { \n    bg: \"bg-yellow-500\", \n    text: \"text-yellow-600 dark:text-yellow-400\", \n    border: \"border-yellow-500\",\n    gradient: \"from-yellow-500 to-yellow-600\"\n  },\n};\n\nconst generateSecureResult = (): WheelSegment => {\n  const array = new Uint32Array(1);\n  crypto.getRandomValues(array);\n  const randomIndex = array[0] % WHEEL_SEGMENTS.length;\n  return WHEEL_SEGMENTS[randomIndex];\n};\n\nconst formatCurrency = (amount: number): string => {\n  return amount.toLocaleString() + \" NGN\";\n};\n\nconst calculateWinnings = (bets: Bet[], result: WheelSegment): number => {\n  let totalWinnings = 0;\n  \n  for (const bet of bets) {\n    if (bet.type === \"color\" && bet.value === result.color) {\n      totalWinnings += Math.round(bet.amount * COLOR_PAYOUT);\n    } else if (bet.type === \"number\" && bet.value === result.number) {\n      totalWinnings += Math.round(bet.amount * NUMBER_PAYOUT);\n    }\n  }\n  \n  return totalWinnings;\n};\n\nconst hasWinningBet = (bets: Bet[], result: WheelSegment): boolean => {\n  return bets.some(bet => \n    (bet.type === \"color\" && bet.value === result.color) ||\n    (bet.type === \"number\" && bet.value === result.number)\n  );\n};\n\nconst SpinningWheel = ({ \n  rotation, \n  isSpinning, \n  resultSegment \n}: { \n  rotation: number; \n  isSpinning: boolean;\n  resultSegment: WheelSegment | null;\n}) => {\n  const segmentAngle = 360 / WHEEL_SEGMENTS.length;\n  \n  return (\n    <div className=\"relative w-64 h-64 mx-auto\" data-testid=\"wheel-container\">\n      <div className=\"absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 z-20\">\n        <div className=\"w-0 h-0 border-l-[12px] border-r-[12px] border-t-[20px] border-l-transparent border-r-transparent border-t-primary drop-shadow-lg\" />\n      </div>\n      \n      <motion.div\n        className=\"relative w-full h-full rounded-full border-4 border-primary shadow-2xl overflow-hidden\"\n        style={{ transformOrigin: \"center center\" }}\n        animate={{ rotate: rotation }}\n        transition={isSpinning ? {\n          duration: 5,\n          ease: [0.2, 0.8, 0.3, 1],\n        } : {\n          duration: 0.3,\n          ease: \"easeOut\"\n        }}\n        data-testid=\"wheel-spinner\"\n      >\n        <svg viewBox=\"0 0 100 100\" className=\"w-full h-full\">\n          {WHEEL_SEGMENTS.map((segment, index) => {\n            const startAngle = index * segmentAngle;\n            const endAngle = startAngle + segmentAngle;\n            const startRad = (startAngle - 90) * (Math.PI / 180);\n            const endRad = (endAngle - 90) * (Math.PI / 180);\n            \n            const x1 = 50 + 50 * Math.cos(startRad);\n            const y1 = 50 + 50 * Math.sin(startRad);\n            const x2 = 50 + 50 * Math.cos(endRad);\n            const y2 = 50 + 50 * Math.sin(endRad);\n            \n            const largeArcFlag = segmentAngle > 180 ? 1 : 0;\n            \n            const d = `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;\n            \n            const textAngle = startAngle + segmentAngle / 2 - 90;\n            const textRad = textAngle * (Math.PI / 180);\n            const textX = 50 + 35 * Math.cos(textRad);\n            const textY = 50 + 35 * Math.sin(textRad);\n            \n            const colors: Record<WheelColor, string> = {\n              red: \"#ef4444\",\n              green: \"#22c55e\",\n              purple: \"#a855f7\",\n              yellow: \"#eab308\",\n            };\n            \n            return (\n              <g key={index}>\n                <path\n                  d={d}\n                  fill={colors[segment.color]}\n                  stroke=\"#fff\"\n                  strokeWidth=\"0.5\"\n                />\n                <text\n                  x={textX}\n                  y={textY}\n                  fill=\"white\"\n                  fontSize=\"8\"\n                  fontWeight=\"bold\"\n                  textAnchor=\"middle\"\n                  dominantBaseline=\"middle\"\n                  style={{ \n                    transform: `rotate(${startAngle + segmentAngle / 2}deg)`,\n                    transformOrigin: `${textX}px ${textY}px`,\n                    textShadow: \"1px 1px 2px rgba(0,0,0,0.5)\"\n                  }}\n                >\n                  {segment.number}\n                </text>\n              </g>\n            );\n          })}\n          \n          <circle cx=\"50\" cy=\"50\" r=\"10\" fill=\"hsl(var(--background))\" stroke=\"hsl(var(--border))\" strokeWidth=\"1\" />\n          <text x=\"50\" y=\"50\" fill=\"hsl(var(--foreground))\" fontSize=\"6\" fontWeight=\"bold\" textAnchor=\"middle\" dominantBaseline=\"middle\">\n            SPIN\n          </text>\n        </svg>\n      </motion.div>\n      \n      {!isSpinning && resultSegment && (\n        <motion.div\n          initial={{ scale: 0, opacity: 0 }}\n          animate={{ scale: 1, opacity: 1 }}\n          transition={{ delay: 0.3, duration: 0.5, type: \"spring\" }}\n          className=\"absolute inset-0 flex items-center justify-center pointer-events-none\"\n        >\n          <div className={`w-20 h-20 rounded-full bg-gradient-to-br ${COLOR_STYLES[resultSegment.color].gradient} flex items-center justify-center shadow-xl border-4 border-white dark:border-gray-800`}>\n            <span className=\"text-3xl font-black text-white drop-shadow-lg\">\n              {resultSegment.number}\n            </span>\n          </div>\n        </motion.div>\n      )}\n    </div>\n  );\n};\n\nconst BettingOptions = ({\n  selectedColorBets,\n  selectedNumberBets,\n  onToggleColorBet,\n  onToggleNumberBet,\n  stake,\n}: {\n  selectedColorBets: Set<WheelColor>;\n  selectedNumberBets: Set<number>;\n  onToggleColorBet: (color: WheelColor) => void;\n  onToggleNumberBet: (number: number) => void;\n  stake: number;\n}) => {\n  const betPerSelection = stake;\n  \n  return (\n    <div className=\"space-y-4\">\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center gap-2\">\n          <Palette className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm font-medium\">Bet on Color ({COLOR_PAYOUT}x payout)</span>\n        </div>\n        <div className=\"grid grid-cols-4 gap-2\">\n          {COLORS.map((color) => {\n            const isSelected = selectedColorBets.has(color);\n            const styles = COLOR_STYLES[color];\n            \n            return (\n              <motion.button\n                key={color}\n                className={`\n                  relative p-4 rounded-lg border-2 transition-all\n                  ${isSelected \n                    ? `${styles.bg} ${styles.border} text-white ring-2 ring-offset-2 ring-primary` \n                    : `bg-muted/30 border-muted-foreground/20 ${styles.text}`\n                  }\n                `}\n                whileHover={{ scale: 1.05 }}\n                whileTap={{ scale: 0.95 }}\n                onClick={() => onToggleColorBet(color)}\n                data-testid={`button-bet-color-${color}`}\n              >\n                <div className=\"flex flex-col items-center gap-1\">\n                  <div className={`w-6 h-6 rounded-full ${styles.bg} ${isSelected ? 'ring-2 ring-white' : ''}`} />\n                  <span className=\"text-xs font-medium capitalize\">{color}</span>\n                </div>\n                {isSelected && (\n                  <motion.div\n                    initial={{ scale: 0 }}\n                    animate={{ scale: 1 }}\n                    className=\"absolute -top-1 -right-1 w-5 h-5 bg-primary rounded-full flex items-center justify-center\"\n                  >\n                    <Check className=\"h-3 w-3 text-primary-foreground\" />\n                  </motion.div>\n                )}\n              </motion.button>\n            );\n          })}\n        </div>\n      </div>\n      \n      <div className=\"space-y-3\">\n        <div className=\"flex items-center gap-2\">\n          <Hash className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm font-medium\">Bet on Number ({NUMBER_PAYOUT}x payout)</span>\n        </div>\n        <div className=\"grid grid-cols-5 gap-2\">\n          {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => {\n            const isSelected = selectedNumberBets.has(num);\n            const segment = WHEEL_SEGMENTS.find(s => s.number === num)!;\n            const styles = COLOR_STYLES[segment.color];\n            \n            return (\n              <motion.button\n                key={num}\n                className={`\n                  relative p-3 rounded-lg border-2 transition-all\n                  ${isSelected \n                    ? `bg-gradient-to-br ${styles.gradient} border-transparent text-white ring-2 ring-offset-2 ring-primary` \n                    : `bg-muted/30 border-muted-foreground/20`\n                  }\n                `}\n                whileHover={{ scale: 1.05 }}\n                whileTap={{ scale: 0.95 }}\n                onClick={() => onToggleNumberBet(num)}\n                data-testid={`button-bet-number-${num}`}\n              >\n                <div className=\"flex flex-col items-center gap-1\">\n                  <span className=\"text-lg font-bold\">{num}</span>\n                  <div className={`w-3 h-3 rounded-full ${styles.bg}`} />\n                </div>\n                {isSelected && (\n                  <motion.div\n                    initial={{ scale: 0 }}\n                    animate={{ scale: 1 }}\n                    className=\"absolute -top-1 -right-1 w-5 h-5 bg-primary rounded-full flex items-center justify-center\"\n                  >\n                    <Check className=\"h-3 w-3 text-primary-foreground\" />\n                  </motion.div>\n                )}\n              </motion.button>\n            );\n          })}\n        </div>\n      </div>\n      \n      {(selectedColorBets.size > 0 || selectedNumberBets.size > 0) && (\n        <motion.div\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"p-3 bg-muted/50 rounded-md space-y-2\"\n        >\n          <div className=\"text-sm font-medium flex items-center gap-2\">\n            <Coins className=\"h-4 w-4 text-primary\" />\n            Your Bets\n          </div>\n          <div className=\"flex flex-wrap gap-2\">\n            {Array.from(selectedColorBets).map(color => (\n              <Badge \n                key={`color-${color}`} \n                className={`${COLOR_STYLES[color].bg} text-white`}\n                data-testid={`badge-bet-color-${color}`}\n              >\n                {color.charAt(0).toUpperCase() + color.slice(1)} ({formatCurrency(betPerSelection)})\n              </Badge>\n            ))}\n            {Array.from(selectedNumberBets).map(num => {\n              const segment = WHEEL_SEGMENTS.find(s => s.number === num)!;\n              return (\n                <Badge \n                  key={`number-${num}`} \n                  className={`${COLOR_STYLES[segment.color].bg} text-white`}\n                  data-testid={`badge-bet-number-${num}`}\n                >\n                  #{num} ({formatCurrency(betPerSelection)})\n                </Badge>\n              );\n            })}\n          </div>\n          <div className=\"text-xs text-muted-foreground\">\n            Total bet: {formatCurrency(betPerSelection * (selectedColorBets.size + selectedNumberBets.size))}\n          </div>\n        </motion.div>\n      )}\n    </div>\n  );\n};\n\nexport default function ColourColourGame({ stake, onGameEnd, isPractice }: ColourColourGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"betting\");\n  const [selectedColorBets, setSelectedColorBets] = useState<Set<WheelColor>>(new Set());\n  const [selectedNumberBets, setSelectedNumberBets] = useState<Set<number>>(new Set());\n  const [wheelRotation, setWheelRotation] = useState(0);\n  const [isSpinning, setIsSpinning] = useState(false);\n  const [resultSegment, setResultSegment] = useState<WheelSegment | null>(null);\n  const [spinHistory, setSpinHistory] = useState<SpinResult[]>([]);\n  const [winnings, setWinnings] = useState(0);\n  const [totalBetAmount, setTotalBetAmount] = useState(0);\n  \n  const spinTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (spinTimeoutRef.current) {\n        clearTimeout(spinTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  const toggleColorBet = useCallback((color: WheelColor) => {\n    setSelectedColorBets(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(color)) {\n        newSet.delete(color);\n      } else {\n        newSet.add(color);\n      }\n      return newSet;\n    });\n  }, []);\n\n  const toggleNumberBet = useCallback((num: number) => {\n    setSelectedNumberBets(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(num)) {\n        newSet.delete(num);\n      } else {\n        newSet.add(num);\n      }\n      return newSet;\n    });\n  }, []);\n\n  const getBets = useCallback((): Bet[] => {\n    const bets: Bet[] = [];\n    const betAmount = stake;\n    \n    selectedColorBets.forEach(color => {\n      bets.push({ type: \"color\", value: color, amount: betAmount });\n    });\n    \n    selectedNumberBets.forEach(num => {\n      bets.push({ type: \"number\", value: num, amount: betAmount });\n    });\n    \n    return bets;\n  }, [selectedColorBets, selectedNumberBets, stake]);\n\n  const spinWheel = useCallback(() => {\n    if (selectedColorBets.size === 0 && selectedNumberBets.size === 0) return;\n    \n    const result = generateSecureResult();\n    const bets = getBets();\n    const totalBet = bets.reduce((sum, bet) => sum + bet.amount, 0);\n    \n    setTotalBetAmount(totalBet);\n    setGamePhase(\"spinning\");\n    setIsSpinning(true);\n    setResultSegment(null);\n    \n    const segmentIndex = WHEEL_SEGMENTS.findIndex(\n      s => s.color === result.color && s.number === result.number\n    );\n    const segmentAngle = 360 / WHEEL_SEGMENTS.length;\n    const targetAngle = segmentIndex * segmentAngle;\n    \n    const fullRotations = 5 * 360;\n    const finalRotation = wheelRotation + fullRotations + (360 - targetAngle) + segmentAngle / 2;\n    \n    setWheelRotation(finalRotation);\n    \n    spinTimeoutRef.current = setTimeout(() => {\n      setIsSpinning(false);\n      setResultSegment(result);\n      \n      const calculatedWinnings = calculateWinnings(bets, result);\n      setWinnings(calculatedWinnings);\n      \n      setSpinHistory(prev => [\n        { segment: result, timestamp: Date.now() },\n        ...prev\n      ].slice(0, 10));\n      \n      setGamePhase(\"result\");\n      \n      const won = calculatedWinnings > 0;\n      onGameEnd(won, won ? calculatedWinnings : 0);\n    }, 5000);\n  }, [selectedColorBets, selectedNumberBets, getBets, wheelRotation, onGameEnd]);\n\n  const resetGame = useCallback(() => {\n    setGamePhase(\"betting\");\n    setSelectedColorBets(new Set());\n    setSelectedNumberBets(new Set());\n    setResultSegment(null);\n    setWinnings(0);\n    setTotalBetAmount(0);\n  }, []);\n\n  const hasBets = selectedColorBets.size > 0 || selectedNumberBets.size > 0;\n\n  if (gamePhase === \"betting\") {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"text-xl flex items-center gap-2\">\n              <Palette className=\"h-6 w-6 text-primary\" />\n              Colour Colour\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"text-center space-y-4\"\n            >\n              <SpinningWheel rotation={wheelRotation} isSpinning={false} resultSegment={null} />\n              \n              <div>\n                <h3 className=\"text-lg font-semibold\">Pick Your Lucky Colour or Number</h3>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Bet on colors for 1.95x or exact numbers for 9x payout!\n                </p>\n              </div>\n            </motion.div>\n\n            <div className=\"space-y-4\">\n              <div className=\"p-4 bg-muted/50 rounded-md space-y-3\">\n                <h4 className=\"font-medium flex items-center gap-2\">\n                  <Target className=\"h-4 w-4 text-primary\" />\n                  How to Play\n                </h4>\n                <ul className=\"text-sm text-muted-foreground space-y-2\">\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-primary mt-0.5\">1.</span>\n                    <span>Select one or more colors and/or numbers to bet on</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-primary mt-0.5\">2.</span>\n                    <span>Color bets pay 1.95x your stake</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-primary mt-0.5\">3.</span>\n                    <span>Number bets pay 9x your stake</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-primary mt-0.5\">4.</span>\n                    <span>Spin the wheel and win if it lands on your selection!</span>\n                  </li>\n                </ul>\n              </div>\n\n              <BettingOptions\n                selectedColorBets={selectedColorBets}\n                selectedNumberBets={selectedNumberBets}\n                onToggleColorBet={toggleColorBet}\n                onToggleNumberBet={toggleNumberBet}\n                stake={stake}\n              />\n\n              {spinHistory.length > 0 && (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2 text-sm font-medium\">\n                    <History className=\"h-4 w-4 text-muted-foreground\" />\n                    Recent Spins\n                  </div>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {spinHistory.slice(0, 8).map((result, index) => (\n                      <Badge\n                        key={result.timestamp}\n                        className={`${COLOR_STYLES[result.segment.color].bg} text-white`}\n                        data-testid={`badge-history-${index}`}\n                      >\n                        {result.segment.number}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {!isPractice && (\n                <div className=\"flex items-center justify-between gap-4 p-3 bg-primary/10 rounded-md\">\n                  <span className=\"text-sm font-medium\">Stake per Selection</span>\n                  <Badge variant=\"secondary\" data-testid=\"badge-stake\">\n                    {formatCurrency(stake)}\n                  </Badge>\n                </div>\n              )}\n            </div>\n\n            <Button \n              onClick={spinWheel} \n              className=\"w-full\" \n              size=\"lg\"\n              disabled={!hasBets}\n              data-testid=\"button-spin\"\n            >\n              <Play className=\"h-5 w-5 mr-2\" />\n              {hasBets \n                ? `Spin the Wheel (${formatCurrency(stake * (selectedColorBets.size + selectedNumberBets.size))})` \n                : \"Select at least one bet\"\n              }\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (gamePhase === \"spinning\") {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <CardTitle className=\"text-xl flex items-center gap-2\">\n                <Palette className=\"h-6 w-6 text-primary\" />\n                Colour Colour\n              </CardTitle>\n              <Badge className=\"bg-amber-500/20 text-amber-600 dark:text-amber-400\" data-testid=\"badge-spinning\">\n                <Loader2 className=\"h-3 w-3 mr-1 animate-spin\" />\n                Spinning...\n              </Badge>\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <SpinningWheel rotation={wheelRotation} isSpinning={isSpinning} resultSegment={resultSegment} />\n            \n            <motion.div\n              animate={{ scale: [1, 1.02, 1] }}\n              transition={{ duration: 0.5, repeat: Infinity }}\n              className=\"text-center\"\n            >\n              <p className=\"text-lg font-medium text-muted-foreground\">\n                Good luck! The wheel is spinning...\n              </p>\n            </motion.div>\n\n            <div className=\"p-4 bg-muted/30 rounded-md\">\n              <div className=\"text-sm font-medium mb-2 flex items-center gap-2\">\n                <Coins className=\"h-4 w-4 text-primary\" />\n                Your Active Bets\n              </div>\n              <div className=\"flex flex-wrap gap-2\">\n                {Array.from(selectedColorBets).map(color => (\n                  <Badge \n                    key={`color-${color}`} \n                    className={`${COLOR_STYLES[color].bg} text-white`}\n                  >\n                    {color.charAt(0).toUpperCase() + color.slice(1)}\n                  </Badge>\n                ))}\n                {Array.from(selectedNumberBets).map(num => {\n                  const segment = WHEEL_SEGMENTS.find(s => s.number === num)!;\n                  return (\n                    <Badge \n                      key={`number-${num}`} \n                      className={`${COLOR_STYLES[segment.color].bg} text-white`}\n                    >\n                      #{num}\n                    </Badge>\n                  );\n                })}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const won = winnings > 0;\n  const bets = getBets();\n  const hasWinningColorBet = resultSegment && Array.from(selectedColorBets).includes(resultSegment.color);\n  const hasWinningNumberBet = resultSegment && Array.from(selectedNumberBets).includes(resultSegment.number);\n\n  return (\n    <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n      <Card>\n        <CardHeader className=\"pb-4\">\n          <CardTitle className=\"text-xl flex items-center gap-2\">\n            <Trophy className=\"h-6 w-6 text-yellow-500\" />\n            Spin Complete!\n            <Badge \n              className={won \n                ? \"ml-2 bg-green-500/20 text-green-600 dark:text-green-400\" \n                : \"ml-2 bg-red-500/20 text-red-600 dark:text-red-400\"\n              }\n              data-testid=\"badge-result\"\n            >\n              {resultSegment && (\n                <>\n                  <div className={`w-3 h-3 rounded-full ${COLOR_STYLES[resultSegment.color].bg} mr-1`} />\n                  {resultSegment.color.charAt(0).toUpperCase() + resultSegment.color.slice(1)} {resultSegment.number}\n                </>\n              )}\n            </Badge>\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <SpinningWheel rotation={wheelRotation} isSpinning={false} resultSegment={resultSegment} />\n\n          <motion.div\n            initial={{ scale: 0.8, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            className=\"text-center\"\n          >\n            {won ? (\n              <div className=\"space-y-2\">\n                <motion.div\n                  animate={{ rotate: [0, -10, 10, -10, 10, 0] }}\n                  transition={{ duration: 0.5 }}\n                >\n                  <Crown className=\"h-16 w-16 mx-auto text-yellow-500\" />\n                </motion.div>\n                <h3 className=\"text-2xl font-bold text-green-600 dark:text-green-400\" data-testid=\"text-result\">\n                  You Won!\n                </h3>\n                <div className=\"space-y-1\">\n                  {hasWinningColorBet && (\n                    <p className=\"text-sm text-muted-foreground\">\n                      Color bet on {resultSegment?.color} won! ({COLOR_PAYOUT}x)\n                    </p>\n                  )}\n                  {hasWinningNumberBet && (\n                    <p className=\"text-sm text-muted-foreground\">\n                      Number bet on #{resultSegment?.number} won! ({NUMBER_PAYOUT}x)\n                    </p>\n                  )}\n                </div>\n                <p className=\"text-lg font-semibold text-green-600 dark:text-green-400\" data-testid=\"text-winnings\">\n                  {isPractice \n                    ? `Practice win: ${formatCurrency(winnings)}!`\n                    : `You won ${formatCurrency(winnings)}!`\n                  }\n                </p>\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                <motion.div\n                  animate={{ scale: [1, 1.1, 1] }}\n                  transition={{ duration: 0.3 }}\n                >\n                  <X className=\"h-16 w-16 mx-auto text-red-500\" />\n                </motion.div>\n                <h3 className=\"text-2xl font-bold text-red-600 dark:text-red-400\" data-testid=\"text-result\">\n                  No Match\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  {isPractice \n                    ? `The wheel landed on ${resultSegment?.color} ${resultSegment?.number}. Try again!`\n                    : `You lost ${formatCurrency(totalBetAmount)}. The wheel landed on ${resultSegment?.color} ${resultSegment?.number}.`\n                  }\n                </p>\n              </div>\n            )}\n          </motion.div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"p-4 bg-muted/30 rounded-md text-center\">\n              <div className=\"flex items-center justify-center gap-2 mb-2\">\n                <Target className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"text-sm font-medium\">Your Bets</span>\n              </div>\n              <div className=\"flex flex-wrap gap-1 justify-center\">\n                {Array.from(selectedColorBets).map(color => {\n                  const isWinner = color === resultSegment?.color;\n                  return (\n                    <Badge \n                      key={`color-${color}`} \n                      className={`${isWinner ? 'ring-2 ring-green-500' : 'opacity-50'} ${COLOR_STYLES[color].bg} text-white`}\n                    >\n                      {color}\n                      {isWinner && <Check className=\"h-3 w-3 ml-1\" />}\n                    </Badge>\n                  );\n                })}\n                {Array.from(selectedNumberBets).map(num => {\n                  const isWinner = num === resultSegment?.number;\n                  const segment = WHEEL_SEGMENTS.find(s => s.number === num)!;\n                  return (\n                    <Badge \n                      key={`number-${num}`} \n                      className={`${isWinner ? 'ring-2 ring-green-500' : 'opacity-50'} ${COLOR_STYLES[segment.color].bg} text-white`}\n                    >\n                      #{num}\n                      {isWinner && <Check className=\"h-3 w-3 ml-1\" />}\n                    </Badge>\n                  );\n                })}\n              </div>\n            </div>\n            <div className=\"p-4 bg-muted/30 rounded-md text-center\">\n              <div className=\"flex items-center justify-center gap-2 mb-2\">\n                <Sparkles className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"text-sm font-medium\">Result</span>\n              </div>\n              {resultSegment && (\n                <div className=\"flex items-center justify-center gap-2\">\n                  <div className={`w-6 h-6 rounded-full ${COLOR_STYLES[resultSegment.color].bg}`} />\n                  <span className=\"text-xl font-bold\">{resultSegment.number}</span>\n                </div>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex gap-3\">\n            <Button \n              onClick={resetGame} \n              className=\"flex-1\" \n              size=\"lg\"\n              data-testid=\"button-play-again\"\n            >\n              <RotateCcw className=\"h-5 w-5 mr-2\" />\n              Play Again\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":29897,"size_tokens":null},"client/src/components/games/QuickDrawGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  Zap, \n  Timer, \n  Trophy, \n  Bot, \n  User, \n  RotateCcw, \n  Play,\n  Target,\n  Crosshair,\n  AlertTriangle,\n  Crown,\n  Clock,\n  Flame,\n  Hand,\n  Skull\n} from \"lucide-react\";\n\ninterface QuickDrawGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype GamePhase = \"ready\" | \"waiting\" | \"draw\" | \"finished\";\ntype GameResult = \"player_win\" | \"ai_win\" | \"player_false_start\" | \"ai_false_start\" | null;\n\nconst generateAIReactionTime = (): number => {\n  const randomValue = Math.random();\n  \n  if (randomValue < 0.05) {\n    return Math.floor(Math.random() * 50) + 150;\n  } else if (randomValue < 0.15) {\n    return Math.floor(Math.random() * 50) + 200;\n  } else if (randomValue < 0.70) {\n    return Math.floor(Math.random() * 150) + 250;\n  } else if (randomValue < 0.90) {\n    return Math.floor(Math.random() * 150) + 400;\n  } else {\n    return Math.floor(Math.random() * 200) + 550;\n  }\n};\n\nconst generateRandomDelay = (): number => {\n  return Math.floor(Math.random() * 7000) + 3000;\n};\n\nconst getReactionRating = (time: number): { label: string; color: string; icon: typeof Zap } => {\n  if (time < 200) return { label: \"Lightning Fast\", color: \"text-yellow-500\", icon: Zap };\n  if (time < 250) return { label: \"Blazing\", color: \"text-orange-500\", icon: Flame };\n  if (time < 300) return { label: \"Quick\", color: \"text-green-500\", icon: Target };\n  if (time < 400) return { label: \"Good\", color: \"text-blue-500\", icon: Crosshair };\n  if (time < 500) return { label: \"Average\", color: \"text-cyan-500\", icon: Timer };\n  return { label: \"Slow\", color: \"text-muted-foreground\", icon: Clock };\n};\n\nconst calculateScore = (reactionTime: number, won: boolean): number => {\n  if (!won) return 0;\n  const baseScore = 100;\n  const timePenalty = Math.max(0, reactionTime - 150) / 5;\n  return Math.round(Math.max(10, baseScore - timePenalty));\n};\n\nexport default function QuickDrawGame({ stake, onGameEnd, isPractice }: QuickDrawGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"ready\");\n  const [gameResult, setGameResult] = useState<GameResult>(null);\n  const [playerReactionTime, setPlayerReactionTime] = useState<number | null>(null);\n  const [aiReactionTime, setAIReactionTime] = useState<number | null>(null);\n  const [countdown, setCountdown] = useState(3);\n  const [message, setMessage] = useState(\"Get ready for the duel!\");\n  const [drawStartTime, setDrawStartTime] = useState<number | null>(null);\n  const [showFlash, setShowFlash] = useState(false);\n  \n  const drawTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const aiTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const gameStartedRef = useRef(false);\n  const clickedRef = useRef(false);\n\n  useEffect(() => {\n    return () => {\n      if (drawTimeoutRef.current) {\n        clearTimeout(drawTimeoutRef.current);\n      }\n      if (aiTimeoutRef.current) {\n        clearTimeout(aiTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  const startGame = useCallback(() => {\n    setGamePhase(\"waiting\");\n    setMessage(\"Wait for it...\");\n    setCountdown(3);\n    gameStartedRef.current = true;\n    clickedRef.current = false;\n    setPlayerReactionTime(null);\n    setAIReactionTime(null);\n    setGameResult(null);\n    setDrawStartTime(null);\n    \n    const delay = generateRandomDelay();\n    \n    drawTimeoutRef.current = setTimeout(() => {\n      if (clickedRef.current) return;\n      \n      setGamePhase(\"draw\");\n      setMessage(\"DRAW!\");\n      setShowFlash(true);\n      const startTime = Date.now();\n      setDrawStartTime(startTime);\n      \n      setTimeout(() => setShowFlash(false), 100);\n      \n      const aiTime = generateAIReactionTime();\n      setAIReactionTime(aiTime);\n      \n      aiTimeoutRef.current = setTimeout(() => {\n        if (!clickedRef.current) {\n          const playerTime = Date.now() - startTime;\n          setPlayerReactionTime(playerTime > 2000 ? 2000 : playerTime);\n          setGameResult(\"ai_win\");\n          setGamePhase(\"finished\");\n          setMessage(\"Too slow! AI wins!\");\n          onGameEnd(false, 0);\n        }\n      }, aiTime);\n    }, delay);\n  }, [onGameEnd]);\n\n  const handleClick = useCallback(() => {\n    if (gamePhase === \"ready\") return;\n    if (clickedRef.current) return;\n    \n    clickedRef.current = true;\n    \n    if (gamePhase === \"waiting\") {\n      if (drawTimeoutRef.current) {\n        clearTimeout(drawTimeoutRef.current);\n      }\n      if (aiTimeoutRef.current) {\n        clearTimeout(aiTimeoutRef.current);\n      }\n      \n      setGameResult(\"player_false_start\");\n      setGamePhase(\"finished\");\n      setMessage(\"False start! You clicked too early!\");\n      setPlayerReactionTime(null);\n      onGameEnd(false, 0);\n      return;\n    }\n    \n    if (gamePhase === \"draw\" && drawStartTime) {\n      if (aiTimeoutRef.current) {\n        clearTimeout(aiTimeoutRef.current);\n      }\n      \n      const reactionTime = Date.now() - drawStartTime;\n      setPlayerReactionTime(reactionTime);\n      \n      const aiTime = aiReactionTime || generateAIReactionTime();\n      setAIReactionTime(aiTime);\n      \n      if (reactionTime < aiTime) {\n        setGameResult(\"player_win\");\n        setMessage(\"You won! Faster draw!\");\n        const score = calculateScore(reactionTime, true);\n        onGameEnd(true, score);\n      } else if (reactionTime === aiTime) {\n        if (Math.random() > 0.5) {\n          setGameResult(\"player_win\");\n          setMessage(\"Tie breaker - You won!\");\n          const score = calculateScore(reactionTime, true);\n          onGameEnd(true, score);\n        } else {\n          setGameResult(\"ai_win\");\n          setMessage(\"Tie breaker - AI won!\");\n          onGameEnd(false, 0);\n        }\n      } else {\n        setGameResult(\"ai_win\");\n        setMessage(\"AI was faster!\");\n        onGameEnd(false, 0);\n      }\n      \n      setGamePhase(\"finished\");\n    }\n  }, [gamePhase, drawStartTime, aiReactionTime, onGameEnd]);\n\n  const resetGame = useCallback(() => {\n    if (drawTimeoutRef.current) {\n      clearTimeout(drawTimeoutRef.current);\n    }\n    if (aiTimeoutRef.current) {\n      clearTimeout(aiTimeoutRef.current);\n    }\n    \n    setGamePhase(\"ready\");\n    setGameResult(null);\n    setPlayerReactionTime(null);\n    setAIReactionTime(null);\n    setMessage(\"Get ready for the duel!\");\n    setDrawStartTime(null);\n    setShowFlash(false);\n    gameStartedRef.current = false;\n    clickedRef.current = false;\n  }, []);\n\n  const playerWon = gameResult === \"player_win\";\n  const playerRating = playerReactionTime ? getReactionRating(playerReactionTime) : null;\n  const aiRating = aiReactionTime ? getReactionRating(aiReactionTime) : null;\n\n  if (gamePhase === \"ready\") {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"text-xl flex items-center gap-2\">\n              <Crosshair className=\"h-6 w-6 text-primary\" />\n              Quick Draw Duel\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"text-center space-y-4\"\n            >\n              <div className=\"relative mx-auto w-24 h-24 mb-4\">\n                <motion.div\n                  animate={{ \n                    scale: [1, 1.1, 1],\n                  }}\n                  transition={{ \n                    duration: 1.5, \n                    repeat: Infinity,\n                    repeatType: \"reverse\"\n                  }}\n                  className=\"w-full h-full rounded-full bg-gradient-to-br from-amber-500 via-orange-500 to-red-500 flex items-center justify-center shadow-lg\"\n                >\n                  <Crosshair className=\"h-12 w-12 text-white\" />\n                </motion.div>\n                <motion.div\n                  animate={{ \n                    scale: [1, 1.3, 1],\n                    opacity: [0.5, 1, 0.5]\n                  }}\n                  transition={{ \n                    duration: 1.5, \n                    repeat: Infinity \n                  }}\n                  className=\"absolute -top-1 -right-1 w-8 h-8 rounded-full bg-yellow-400 flex items-center justify-center\"\n                >\n                  <Zap className=\"h-4 w-4 text-yellow-800\" />\n                </motion.div>\n              </div>\n              \n              <div>\n                <h3 className=\"text-lg font-semibold\">Test Your Reflexes</h3>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Wait for \"DRAW!\" to appear, then click as fast as you can!\n                </p>\n              </div>\n            </motion.div>\n\n            <div className=\"space-y-4\">\n              <div className=\"p-4 bg-muted/50 rounded-md space-y-3\">\n                <h4 className=\"font-medium flex items-center gap-2\">\n                  <AlertTriangle className=\"h-4 w-4 text-yellow-500\" />\n                  Rules\n                </h4>\n                <ul className=\"text-sm text-muted-foreground space-y-2\">\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-primary mt-0.5\">1.</span>\n                    <span>Wait for the \"DRAW!\" signal (3-10 seconds delay)</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-primary mt-0.5\">2.</span>\n                    <span>Click/tap as fast as you can when you see \"DRAW!\"</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-primary mt-0.5\">3.</span>\n                    <span>Clicking before \"DRAW!\" = instant loss (false start)</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-primary mt-0.5\">4.</span>\n                    <span>First to draw wins the duel!</span>\n                  </li>\n                </ul>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                <div className=\"flex items-center gap-2 p-3 bg-muted/30 rounded-md\">\n                  <User className=\"h-4 w-4 text-blue-500\" />\n                  <span>You</span>\n                </div>\n                <div className=\"flex items-center gap-2 p-3 bg-muted/30 rounded-md\">\n                  <Bot className=\"h-4 w-4 text-purple-500\" />\n                  <span>AI Opponent</span>\n                </div>\n              </div>\n\n              {!isPractice && (\n                <div className=\"flex items-center justify-between gap-4 p-3 bg-primary/10 rounded-md\">\n                  <span className=\"text-sm font-medium\">Stake Amount</span>\n                  <Badge variant=\"secondary\" data-testid=\"badge-stake\">\n                    {stake.toLocaleString()} NGN\n                  </Badge>\n                </div>\n              )}\n            </div>\n\n            <Button \n              onClick={startGame} \n              className=\"w-full\" \n              size=\"lg\"\n              data-testid=\"button-start-quickdraw\"\n            >\n              <Play className=\"h-5 w-5 mr-2\" />\n              Start Duel\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (gamePhase === \"waiting\" || gamePhase === \"draw\") {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n        <Card className=\"relative overflow-visible\">\n          <AnimatePresence>\n            {showFlash && (\n              <motion.div\n                initial={{ opacity: 1 }}\n                animate={{ opacity: 0 }}\n                exit={{ opacity: 0 }}\n                transition={{ duration: 0.1 }}\n                className=\"absolute inset-0 bg-yellow-400 z-10 rounded-lg\"\n              />\n            )}\n          </AnimatePresence>\n          \n          <CardHeader className=\"pb-4\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <CardTitle className=\"text-xl flex items-center gap-2\">\n                <Crosshair className=\"h-6 w-6 text-primary\" />\n                Quick Draw Duel\n              </CardTitle>\n              <div className=\"flex items-center gap-2\">\n                <Badge \n                  className={gamePhase === \"draw\" \n                    ? \"bg-red-500/20 text-red-600 dark:text-red-400\" \n                    : \"bg-yellow-500/20 text-yellow-600 dark:text-yellow-400\"\n                  }\n                  data-testid=\"badge-phase\"\n                >\n                  {gamePhase === \"draw\" ? \"DRAW!\" : \"Waiting...\"}\n                </Badge>\n              </div>\n            </div>\n          </CardHeader>\n          \n          <CardContent className=\"space-y-6\">\n            <motion.div\n              className={`\n                relative w-full aspect-video rounded-lg flex flex-col items-center justify-center cursor-pointer\n                transition-colors duration-100\n                ${gamePhase === \"draw\" \n                  ? \"bg-gradient-to-br from-red-500 via-orange-500 to-yellow-500\" \n                  : \"bg-gradient-to-br from-gray-700 via-gray-800 to-gray-900 dark:from-gray-800 dark:via-gray-900 dark:to-black\"\n                }\n              `}\n              onClick={handleClick}\n              whileTap={{ scale: 0.98 }}\n              data-testid=\"draw-area\"\n            >\n              <AnimatePresence mode=\"wait\">\n                {gamePhase === \"waiting\" && (\n                  <motion.div\n                    key=\"waiting\"\n                    initial={{ opacity: 0, scale: 0.8 }}\n                    animate={{ opacity: 1, scale: 1 }}\n                    exit={{ opacity: 0, scale: 0.8 }}\n                    className=\"text-center space-y-4\"\n                  >\n                    <motion.div\n                      animate={{ \n                        scale: [1, 1.05, 1],\n                        opacity: [0.5, 1, 0.5]\n                      }}\n                      transition={{ \n                        duration: 1.5, \n                        repeat: Infinity \n                      }}\n                    >\n                      <Hand className=\"h-16 w-16 mx-auto text-white/70\" />\n                    </motion.div>\n                    <div className=\"space-y-2\">\n                      <p className=\"text-2xl font-bold text-white\" data-testid=\"text-waiting\">\n                        Wait for it...\n                      </p>\n                      <p className=\"text-sm text-white/60\">\n                        Don't click yet!\n                      </p>\n                    </div>\n                  </motion.div>\n                )}\n                \n                {gamePhase === \"draw\" && (\n                  <motion.div\n                    key=\"draw\"\n                    initial={{ opacity: 0, scale: 0.5 }}\n                    animate={{ opacity: 1, scale: 1 }}\n                    exit={{ opacity: 0 }}\n                    transition={{ type: \"spring\", stiffness: 500, damping: 25 }}\n                    className=\"text-center space-y-4\"\n                  >\n                    <motion.div\n                      animate={{ \n                        rotate: [0, -10, 10, -10, 0],\n                        scale: [1, 1.1, 1]\n                      }}\n                      transition={{ \n                        duration: 0.3,\n                        repeat: Infinity,\n                        repeatDelay: 0.5\n                      }}\n                    >\n                      <Crosshair className=\"h-20 w-20 mx-auto text-white drop-shadow-lg\" />\n                    </motion.div>\n                    <motion.p \n                      className=\"text-5xl font-black text-white drop-shadow-lg\"\n                      animate={{ scale: [1, 1.05, 1] }}\n                      transition={{ duration: 0.2, repeat: Infinity }}\n                      data-testid=\"text-draw\"\n                    >\n                      DRAW!\n                    </motion.p>\n                    <p className=\"text-lg text-white/90 font-medium\">\n                      Click NOW!\n                    </p>\n                  </motion.div>\n                )}\n              </AnimatePresence>\n            </motion.div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"p-3 bg-muted/30 rounded-md text-center\">\n                <div className=\"flex items-center justify-center gap-2 mb-1\">\n                  <User className=\"h-4 w-4 text-blue-500\" />\n                  <span className=\"text-sm font-medium\">You</span>\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  {gamePhase === \"waiting\" ? \"Waiting...\" : \"Click to draw!\"}\n                </p>\n              </div>\n              <div className=\"p-3 bg-muted/30 rounded-md text-center\">\n                <div className=\"flex items-center justify-center gap-2 mb-1\">\n                  <Bot className=\"h-4 w-4 text-purple-500\" />\n                  <span className=\"text-sm font-medium\">AI</span>\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  {gamePhase === \"waiting\" ? \"Ready...\" : \"Drawing...\"}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n      <Card>\n        <CardHeader className=\"pb-4\">\n          <CardTitle className=\"text-xl flex items-center gap-2\">\n            <Trophy className=\"h-6 w-6 text-yellow-500\" />\n            Duel Complete!\n            {gameResult === \"player_false_start\" && (\n              <Badge className=\"ml-2 bg-red-500/20 text-red-600\">False Start</Badge>\n            )}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <motion.div\n            initial={{ scale: 0.8, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            className=\"text-center\"\n          >\n            {playerWon ? (\n              <div className=\"space-y-2\">\n                <motion.div\n                  animate={{ rotate: [0, -10, 10, -10, 10, 0] }}\n                  transition={{ duration: 0.5 }}\n                >\n                  <Crown className=\"h-16 w-16 mx-auto text-yellow-500\" />\n                </motion.div>\n                <h3 className=\"text-2xl font-bold text-green-600 dark:text-green-400\" data-testid=\"text-result\">\n                  You Won!\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  {isPractice \n                    ? \"Lightning reflexes! You beat the AI.\"\n                    : `You earned ${Math.round(stake * 1.9).toLocaleString()} NGN!`\n                  }\n                </p>\n              </div>\n            ) : gameResult === \"player_false_start\" ? (\n              <div className=\"space-y-2\">\n                <Skull className=\"h-16 w-16 mx-auto text-red-500\" />\n                <h3 className=\"text-2xl font-bold text-red-600 dark:text-red-400\" data-testid=\"text-result\">\n                  False Start!\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  {isPractice \n                    ? \"You clicked before 'DRAW!' appeared. Patience is key!\"\n                    : `You lost ${stake.toLocaleString()} NGN. Don't jump the gun!`\n                  }\n                </p>\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                <Bot className=\"h-16 w-16 mx-auto text-muted-foreground\" />\n                <h3 className=\"text-2xl font-bold text-red-600 dark:text-red-400\" data-testid=\"text-result\">\n                  AI Wins\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  {isPractice \n                    ? \"The AI was faster this time. Keep practicing!\"\n                    : `You lost ${stake.toLocaleString()} NGN. Better luck next time!`\n                  }\n                </p>\n              </div>\n            )}\n          </motion.div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <Card className={`p-4 ${playerWon ? 'ring-2 ring-green-500' : ''}`}>\n              <div className=\"flex items-center gap-2 mb-3\">\n                <User className=\"h-5 w-5 text-blue-500\" />\n                <span className=\"font-medium\">You</span>\n                {playerWon && (\n                  <Badge className=\"ml-auto bg-green-500/20 text-green-600\">Winner</Badge>\n                )}\n              </div>\n              {gameResult === \"player_false_start\" ? (\n                <div className=\"space-y-1\">\n                  <p className=\"text-2xl font-bold text-red-500\">FALSE START</p>\n                  <p className=\"text-xs text-muted-foreground\">Disqualified</p>\n                </div>\n              ) : playerReactionTime !== null ? (\n                <div className=\"space-y-1\">\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-player-time\">\n                    {playerReactionTime}ms\n                  </p>\n                  {playerRating && (\n                    <div className={`flex items-center gap-1 ${playerRating.color}`}>\n                      <playerRating.icon className=\"h-3 w-3\" />\n                      <span className=\"text-xs\">{playerRating.label}</span>\n                    </div>\n                  )}\n                </div>\n              ) : (\n                <p className=\"text-xl text-muted-foreground\">--</p>\n              )}\n            </Card>\n            \n            <Card className={`p-4 ${!playerWon && gameResult !== \"player_false_start\" ? 'ring-2 ring-purple-500' : ''}`}>\n              <div className=\"flex items-center gap-2 mb-3\">\n                <Bot className=\"h-5 w-5 text-purple-500\" />\n                <span className=\"font-medium\">AI</span>\n                {!playerWon && gameResult !== \"player_false_start\" && (\n                  <Badge className=\"ml-auto bg-purple-500/20 text-purple-600\">Winner</Badge>\n                )}\n              </div>\n              {aiReactionTime !== null ? (\n                <div className=\"space-y-1\">\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-ai-time\">\n                    {aiReactionTime}ms\n                  </p>\n                  {aiRating && (\n                    <div className={`flex items-center gap-1 ${aiRating.color}`}>\n                      <aiRating.icon className=\"h-3 w-3\" />\n                      <span className=\"text-xs\">{aiRating.label}</span>\n                    </div>\n                  )}\n                </div>\n              ) : (\n                <p className=\"text-xl text-muted-foreground\">--</p>\n              )}\n            </Card>\n          </div>\n\n          {playerReactionTime !== null && aiReactionTime !== null && gameResult !== \"player_false_start\" && (\n            <div className=\"p-4 bg-muted/50 rounded-md\">\n              <div className=\"flex items-center justify-between gap-4 text-sm\">\n                <span className=\"text-muted-foreground\">Time Difference</span>\n                <span className={`font-bold ${playerWon ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                  {playerWon ? '-' : '+'}{Math.abs(playerReactionTime - aiReactionTime)}ms\n                </span>\n              </div>\n            </div>\n          )}\n\n          {!isPractice && (\n            <div className=\"p-4 bg-primary/10 rounded-md\">\n              <div className=\"flex items-center justify-between gap-4\">\n                <span className=\"text-sm font-medium\">Result</span>\n                <span className={`font-bold ${playerWon ? 'text-green-600' : 'text-red-600'}`}>\n                  {playerWon ? `+${Math.round(stake * 0.9).toLocaleString()}` : `-${stake.toLocaleString()}`} NGN\n                </span>\n              </div>\n            </div>\n          )}\n\n          <div className=\"flex gap-3\">\n            <Button \n              onClick={resetGame} \n              variant=\"outline\" \n              className=\"flex-1\"\n              data-testid=\"button-play-again\"\n            >\n              <RotateCcw className=\"h-4 w-4 mr-2\" />\n              Play Again\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":24561,"size_tokens":null},"client/src/components/games/AviatorGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { \n  Plane, \n  Rocket, \n  Trophy, \n  Bot, \n  User, \n  RotateCcw, \n  Play,\n  TrendingUp,\n  Zap,\n  AlertTriangle,\n  Crown,\n  Flame,\n  Target,\n  History,\n  DollarSign,\n  Timer,\n  X,\n  Check\n} from \"lucide-react\";\n\ninterface AviatorGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype GamePhase = \"betting\" | \"flying\" | \"crashed\" | \"cashed_out\";\n\ninterface CrashHistoryItem {\n  id: number;\n  crashPoint: number;\n  timestamp: number;\n}\n\nconst generateSecureCrashPoint = (): number => {\n  const array = new Uint32Array(1);\n  crypto.getRandomValues(array);\n  const randomValue = array[0] / 0x100000000;\n  \n  const houseEdge = 0.03;\n  const crashPoint = (1 - houseEdge) / (1 - randomValue);\n  \n  return Math.max(1.0, Math.min(crashPoint, 1000));\n};\n\nconst formatMultiplier = (value: number): string => {\n  return value.toFixed(2) + \"x\";\n};\n\nconst getCrashPointColor = (crashPoint: number): string => {\n  if (crashPoint < 1.5) return \"bg-red-500/20 text-red-600 dark:text-red-400\";\n  if (crashPoint < 2.0) return \"bg-orange-500/20 text-orange-600 dark:text-orange-400\";\n  if (crashPoint < 3.0) return \"bg-yellow-500/20 text-yellow-600 dark:text-yellow-400\";\n  if (crashPoint < 5.0) return \"bg-green-500/20 text-green-600 dark:text-green-400\";\n  if (crashPoint < 10.0) return \"bg-emerald-500/20 text-emerald-600 dark:text-emerald-400\";\n  return \"bg-purple-500/20 text-purple-600 dark:text-purple-400\";\n};\n\nconst getMultiplierColor = (multiplier: number): string => {\n  if (multiplier < 1.5) return \"text-foreground\";\n  if (multiplier < 2.0) return \"text-yellow-500\";\n  if (multiplier < 3.0) return \"text-orange-500\";\n  if (multiplier < 5.0) return \"text-green-500\";\n  if (multiplier < 10.0) return \"text-emerald-500\";\n  return \"text-purple-500\";\n};\n\nconst calculatePotentialWinnings = (stake: number, multiplier: number): number => {\n  return Math.round(stake * multiplier);\n};\n\nexport default function AviatorGame({ stake, onGameEnd, isPractice }: AviatorGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"betting\");\n  const [currentMultiplier, setCurrentMultiplier] = useState(1.0);\n  const [crashPoint, setCrashPoint] = useState<number | null>(null);\n  const [cashedOutAt, setCashedOutAt] = useState<number | null>(null);\n  const [autoCashoutEnabled, setAutoCashoutEnabled] = useState(false);\n  const [autoCashoutTarget, setAutoCashoutTarget] = useState(\"2.00\");\n  const [crashHistory, setCrashHistory] = useState<CrashHistoryItem[]>([]);\n  const [flightPath, setFlightPath] = useState<{ x: number; y: number }[]>([]);\n  const [showExplosion, setShowExplosion] = useState(false);\n  \n  const animationFrameRef = useRef<number | null>(null);\n  const gameLoopRef = useRef<NodeJS.Timeout | null>(null);\n  const startTimeRef = useRef<number | null>(null);\n  const crashPointRef = useRef<number | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (animationFrameRef.current) {\n        cancelAnimationFrame(animationFrameRef.current);\n      }\n      if (gameLoopRef.current) {\n        clearTimeout(gameLoopRef.current);\n      }\n    };\n  }, []);\n\n  const startGame = useCallback(() => {\n    const newCrashPoint = generateSecureCrashPoint();\n    setCrashPoint(newCrashPoint);\n    crashPointRef.current = newCrashPoint;\n    setCurrentMultiplier(1.0);\n    setCashedOutAt(null);\n    setShowExplosion(false);\n    setFlightPath([{ x: 0, y: 0 }]);\n    setGamePhase(\"flying\");\n    startTimeRef.current = Date.now();\n    \n    const updateMultiplier = () => {\n      if (!startTimeRef.current || !crashPointRef.current) return;\n      \n      const elapsed = Date.now() - startTimeRef.current;\n      const growthRate = 0.00006;\n      const newMultiplier = Math.exp(growthRate * elapsed);\n      \n      if (newMultiplier >= crashPointRef.current) {\n        setCurrentMultiplier(crashPointRef.current);\n        setGamePhase(\"crashed\");\n        setShowExplosion(true);\n        \n        setCrashHistory(prev => {\n          const newHistory = [\n            { \n              id: Date.now(), \n              crashPoint: crashPointRef.current!, \n              timestamp: Date.now() \n            },\n            ...prev\n          ].slice(0, 10);\n          return newHistory;\n        });\n        \n        onGameEnd(false, 0);\n        return;\n      }\n      \n      setCurrentMultiplier(newMultiplier);\n      \n      setFlightPath(prev => {\n        const x = Math.min(100, (elapsed / 100) * 2);\n        const y = Math.min(100, (newMultiplier - 1) * 20);\n        return [...prev, { x, y }].slice(-50);\n      });\n      \n      if (autoCashoutEnabled) {\n        const targetMultiplier = parseFloat(autoCashoutTarget);\n        if (!isNaN(targetMultiplier) && newMultiplier >= targetMultiplier) {\n          handleCashOut(newMultiplier);\n          return;\n        }\n      }\n      \n      animationFrameRef.current = requestAnimationFrame(updateMultiplier);\n    };\n    \n    animationFrameRef.current = requestAnimationFrame(updateMultiplier);\n  }, [autoCashoutEnabled, autoCashoutTarget, onGameEnd]);\n\n  const handleCashOut = useCallback((multiplierAtCashout?: number) => {\n    if (gamePhase !== \"flying\") return;\n    \n    if (animationFrameRef.current) {\n      cancelAnimationFrame(animationFrameRef.current);\n    }\n    \n    const finalMultiplier = multiplierAtCashout || currentMultiplier;\n    setCashedOutAt(finalMultiplier);\n    setGamePhase(\"cashed_out\");\n    \n    const winnings = calculatePotentialWinnings(stake, finalMultiplier);\n    onGameEnd(true, winnings);\n  }, [gamePhase, currentMultiplier, stake, onGameEnd]);\n\n  const resetGame = useCallback(() => {\n    if (animationFrameRef.current) {\n      cancelAnimationFrame(animationFrameRef.current);\n    }\n    if (gameLoopRef.current) {\n      clearTimeout(gameLoopRef.current);\n    }\n    \n    setGamePhase(\"betting\");\n    setCurrentMultiplier(1.0);\n    setCrashPoint(null);\n    crashPointRef.current = null;\n    setCashedOutAt(null);\n    setShowExplosion(false);\n    setFlightPath([]);\n    startTimeRef.current = null;\n  }, []);\n\n  const potentialWinnings = calculatePotentialWinnings(stake, currentMultiplier);\n\n  if (gamePhase === \"betting\") {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"text-xl flex items-center gap-2\">\n              <Rocket className=\"h-6 w-6 text-primary\" />\n              Aviator\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"text-center space-y-4\"\n            >\n              <div className=\"relative mx-auto w-24 h-24 mb-4\">\n                <motion.div\n                  animate={{ \n                    y: [-5, 5, -5],\n                    rotate: [0, 5, -5, 0]\n                  }}\n                  transition={{ \n                    duration: 3, \n                    repeat: Infinity,\n                    repeatType: \"reverse\"\n                  }}\n                  className=\"w-full h-full rounded-full bg-gradient-to-br from-red-500 via-orange-500 to-yellow-500 flex items-center justify-center shadow-lg\"\n                >\n                  <Plane className=\"h-12 w-12 text-white -rotate-45\" />\n                </motion.div>\n                <motion.div\n                  animate={{ \n                    scale: [1, 1.3, 1],\n                    opacity: [0.5, 1, 0.5]\n                  }}\n                  transition={{ \n                    duration: 1.5, \n                    repeat: Infinity \n                  }}\n                  className=\"absolute -top-1 -right-1 w-8 h-8 rounded-full bg-green-400 flex items-center justify-center\"\n                >\n                  <TrendingUp className=\"h-4 w-4 text-green-800\" />\n                </motion.div>\n              </div>\n              \n              <div>\n                <h3 className=\"text-lg font-semibold\">Take Off Before It Crashes</h3>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Watch the multiplier rise and cash out before the plane flies away!\n                </p>\n              </div>\n            </motion.div>\n\n            <div className=\"space-y-4\">\n              <div className=\"p-4 bg-muted/50 rounded-md space-y-3\">\n                <h4 className=\"font-medium flex items-center gap-2\">\n                  <Target className=\"h-4 w-4 text-primary\" />\n                  How to Play\n                </h4>\n                <ul className=\"text-sm text-muted-foreground space-y-2\">\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-primary mt-0.5\">1.</span>\n                    <span>Place your bet and watch the multiplier rise</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-primary mt-0.5\">2.</span>\n                    <span>Cash out anytime to secure your winnings</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-primary mt-0.5\">3.</span>\n                    <span>If the plane crashes before you cash out, you lose!</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-primary mt-0.5\">4.</span>\n                    <span>Higher multipliers = bigger wins, but higher risk!</span>\n                  </li>\n                </ul>\n              </div>\n\n              <div className=\"space-y-3 p-4 bg-muted/30 rounded-md\">\n                <div className=\"flex items-center justify-between gap-4\">\n                  <div className=\"flex items-center gap-2\">\n                    <Timer className=\"h-4 w-4 text-muted-foreground\" />\n                    <Label htmlFor=\"auto-cashout\" className=\"text-sm\">Auto Cash Out</Label>\n                  </div>\n                  <Switch\n                    id=\"auto-cashout\"\n                    checked={autoCashoutEnabled}\n                    onCheckedChange={setAutoCashoutEnabled}\n                    data-testid=\"switch-auto-cashout\"\n                  />\n                </div>\n                \n                <AnimatePresence>\n                  {autoCashoutEnabled && (\n                    <motion.div\n                      initial={{ opacity: 0, height: 0 }}\n                      animate={{ opacity: 1, height: \"auto\" }}\n                      exit={{ opacity: 0, height: 0 }}\n                      className=\"space-y-2\"\n                    >\n                      <Label htmlFor=\"target-multiplier\" className=\"text-xs text-muted-foreground\">\n                        Target Multiplier\n                      </Label>\n                      <div className=\"flex items-center gap-2\">\n                        <Input\n                          id=\"target-multiplier\"\n                          type=\"number\"\n                          step=\"0.1\"\n                          min=\"1.1\"\n                          max=\"100\"\n                          value={autoCashoutTarget}\n                          onChange={(e) => setAutoCashoutTarget(e.target.value)}\n                          className=\"w-24\"\n                          data-testid=\"input-auto-cashout-target\"\n                        />\n                        <span className=\"text-sm text-muted-foreground\">x</span>\n                      </div>\n                    </motion.div>\n                  )}\n                </AnimatePresence>\n              </div>\n\n              {crashHistory.length > 0 && (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2 text-sm font-medium\">\n                    <History className=\"h-4 w-4 text-muted-foreground\" />\n                    Recent Crashes\n                  </div>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {crashHistory.slice(0, 8).map((item) => (\n                      <Badge\n                        key={item.id}\n                        className={getCrashPointColor(item.crashPoint)}\n                        data-testid={`badge-history-${item.id}`}\n                      >\n                        {formatMultiplier(item.crashPoint)}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {!isPractice && (\n                <div className=\"flex items-center justify-between gap-4 p-3 bg-primary/10 rounded-md\">\n                  <span className=\"text-sm font-medium\">Stake Amount</span>\n                  <Badge variant=\"secondary\" data-testid=\"badge-stake\">\n                    {stake.toLocaleString()} NGN\n                  </Badge>\n                </div>\n              )}\n            </div>\n\n            <Button \n              onClick={startGame} \n              className=\"w-full\" \n              size=\"lg\"\n              data-testid=\"button-start-aviator\"\n            >\n              <Play className=\"h-5 w-5 mr-2\" />\n              Place Bet & Take Off\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (gamePhase === \"flying\") {\n    return (\n      <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n        <Card className=\"overflow-visible\">\n          <CardHeader className=\"pb-4\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <CardTitle className=\"text-xl flex items-center gap-2\">\n                <Rocket className=\"h-6 w-6 text-primary\" />\n                Aviator\n              </CardTitle>\n              <Badge className=\"bg-green-500/20 text-green-600 dark:text-green-400\" data-testid=\"badge-flying\">\n                <Plane className=\"h-3 w-3 mr-1 -rotate-45\" />\n                Flying...\n              </Badge>\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <div \n              className=\"relative w-full aspect-video rounded-lg bg-gradient-to-br from-sky-900 via-sky-700 to-sky-500 dark:from-sky-950 dark:via-sky-900 dark:to-sky-800 overflow-hidden\"\n              data-testid=\"flight-area\"\n            >\n              <div className=\"absolute inset-0\">\n                {[...Array(20)].map((_, i) => (\n                  <motion.div\n                    key={i}\n                    className=\"absolute w-1 h-1 bg-white rounded-full opacity-50\"\n                    style={{\n                      left: `${Math.random() * 100}%`,\n                      top: `${Math.random() * 100}%`,\n                    }}\n                    animate={{\n                      x: [-10, -50],\n                      opacity: [0.5, 0],\n                    }}\n                    transition={{\n                      duration: 2,\n                      repeat: Infinity,\n                      delay: Math.random() * 2,\n                    }}\n                  />\n                ))}\n              </div>\n              \n              <svg className=\"absolute inset-0 w-full h-full\">\n                <defs>\n                  <linearGradient id=\"pathGradient\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\n                    <stop offset=\"0%\" stopColor=\"rgba(34, 197, 94, 0.3)\" />\n                    <stop offset=\"100%\" stopColor=\"rgba(34, 197, 94, 0.8)\" />\n                  </linearGradient>\n                </defs>\n                <motion.path\n                  d={flightPath.length > 1 \n                    ? `M ${flightPath.map(p => `${p.x}% ${100 - p.y}%`).join(\" L \")}` \n                    : \"M 0% 100%\"\n                  }\n                  fill=\"none\"\n                  stroke=\"url(#pathGradient)\"\n                  strokeWidth=\"3\"\n                  strokeLinecap=\"round\"\n                />\n              </svg>\n\n              <motion.div\n                className=\"absolute\"\n                style={{\n                  left: `${Math.min(85, flightPath[flightPath.length - 1]?.x || 0)}%`,\n                  bottom: `${Math.min(85, flightPath[flightPath.length - 1]?.y || 0)}%`,\n                }}\n                animate={{\n                  y: [-2, 2, -2],\n                }}\n                transition={{\n                  duration: 0.5,\n                  repeat: Infinity,\n                }}\n              >\n                <div className=\"relative\">\n                  <motion.div\n                    animate={{ rotate: [0, 5, -5, 0] }}\n                    transition={{ duration: 0.5, repeat: Infinity }}\n                  >\n                    <Plane className=\"h-10 w-10 text-white drop-shadow-lg -rotate-45\" />\n                  </motion.div>\n                  <motion.div\n                    className=\"absolute -bottom-2 -left-2 w-8 h-4\"\n                    animate={{ opacity: [1, 0.5, 1], scale: [1, 1.2, 1] }}\n                    transition={{ duration: 0.2, repeat: Infinity }}\n                  >\n                    <div className=\"w-full h-full bg-gradient-to-l from-orange-500 to-transparent rounded-full blur-sm\" />\n                  </motion.div>\n                </div>\n              </motion.div>\n\n              <div className=\"absolute inset-0 flex items-center justify-center\">\n                <motion.div\n                  className=\"text-center\"\n                  animate={{ scale: [1, 1.02, 1] }}\n                  transition={{ duration: 0.5, repeat: Infinity }}\n                >\n                  <motion.p\n                    className={`text-6xl font-black drop-shadow-lg ${getMultiplierColor(currentMultiplier)}`}\n                    data-testid=\"text-multiplier\"\n                  >\n                    {formatMultiplier(currentMultiplier)}\n                  </motion.p>\n                  {autoCashoutEnabled && (\n                    <p className=\"text-sm text-white/70 mt-2\">\n                      Auto: {autoCashoutTarget}x\n                    </p>\n                  )}\n                </motion.div>\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"p-4 bg-muted/30 rounded-md text-center\">\n                <div className=\"flex items-center justify-center gap-2 mb-2\">\n                  <DollarSign className=\"h-4 w-4 text-green-500\" />\n                  <span className=\"text-sm font-medium\">Potential Win</span>\n                </div>\n                <p className=\"text-2xl font-bold text-green-600 dark:text-green-400\" data-testid=\"text-potential-win\">\n                  {potentialWinnings.toLocaleString()} NGN\n                </p>\n              </div>\n              <div className=\"p-4 bg-muted/30 rounded-md text-center\">\n                <div className=\"flex items-center justify-center gap-2 mb-2\">\n                  <TrendingUp className=\"h-4 w-4 text-primary\" />\n                  <span className=\"text-sm font-medium\">Current Multiplier</span>\n                </div>\n                <p className={`text-2xl font-bold ${getMultiplierColor(currentMultiplier)}`}>\n                  {formatMultiplier(currentMultiplier)}\n                </p>\n              </div>\n            </div>\n\n            <Button \n              onClick={() => handleCashOut()} \n              className=\"w-full bg-green-600 hover:bg-green-700\" \n              size=\"lg\"\n              data-testid=\"button-cash-out\"\n            >\n              <Zap className=\"h-5 w-5 mr-2\" />\n              Cash Out @ {formatMultiplier(currentMultiplier)} ({potentialWinnings.toLocaleString()} NGN)\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"w-full max-w-2xl mx-auto space-y-4\">\n      <Card>\n        <CardHeader className=\"pb-4\">\n          <CardTitle className=\"text-xl flex items-center gap-2\">\n            <Trophy className=\"h-6 w-6 text-yellow-500\" />\n            Flight Complete!\n            {gamePhase === \"crashed\" && (\n              <Badge className=\"ml-2 bg-red-500/20 text-red-600 dark:text-red-400\" data-testid=\"badge-crashed\">\n                Crashed @ {crashPoint ? formatMultiplier(crashPoint) : \"---\"}\n              </Badge>\n            )}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <AnimatePresence>\n            {showExplosion && gamePhase === \"crashed\" && (\n              <motion.div\n                initial={{ scale: 0, opacity: 1 }}\n                animate={{ scale: 2, opacity: 0 }}\n                exit={{ opacity: 0 }}\n                transition={{ duration: 0.5 }}\n                className=\"absolute inset-0 flex items-center justify-center pointer-events-none\"\n              >\n                <div className=\"w-32 h-32 bg-gradient-to-r from-red-500 via-orange-500 to-yellow-500 rounded-full blur-xl\" />\n              </motion.div>\n            )}\n          </AnimatePresence>\n\n          <motion.div\n            initial={{ scale: 0.8, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            className=\"text-center\"\n          >\n            {gamePhase === \"cashed_out\" ? (\n              <div className=\"space-y-2\">\n                <motion.div\n                  animate={{ rotate: [0, -10, 10, -10, 10, 0] }}\n                  transition={{ duration: 0.5 }}\n                >\n                  <Crown className=\"h-16 w-16 mx-auto text-yellow-500\" />\n                </motion.div>\n                <h3 className=\"text-2xl font-bold text-green-600 dark:text-green-400\" data-testid=\"text-result\">\n                  You Cashed Out!\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  {isPractice \n                    ? `Great timing! You cashed out at ${formatMultiplier(cashedOutAt || 1)}`\n                    : `You won ${calculatePotentialWinnings(stake, cashedOutAt || 1).toLocaleString()} NGN!`\n                  }\n                </p>\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                <motion.div\n                  animate={{ scale: [1, 1.1, 1] }}\n                  transition={{ duration: 0.3 }}\n                >\n                  <X className=\"h-16 w-16 mx-auto text-red-500\" />\n                </motion.div>\n                <h3 className=\"text-2xl font-bold text-red-600 dark:text-red-400\" data-testid=\"text-result\">\n                  Crashed!\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  {isPractice \n                    ? `The plane crashed at ${formatMultiplier(crashPoint || 1)}. Better luck next time!`\n                    : `You lost ${stake.toLocaleString()} NGN. The plane crashed at ${formatMultiplier(crashPoint || 1)}`\n                  }\n                </p>\n              </div>\n            )}\n          </motion.div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <Card className={`p-4 ${gamePhase === \"cashed_out\" ? 'ring-2 ring-green-500' : ''}`}>\n              <div className=\"flex items-center gap-2 mb-3\">\n                <User className=\"h-5 w-5 text-blue-500\" />\n                <span className=\"font-medium\">Your Result</span>\n                {gamePhase === \"cashed_out\" && (\n                  <Badge className=\"ml-auto bg-green-500/20 text-green-600\">\n                    <Check className=\"h-3 w-3 mr-1\" />\n                    Win\n                  </Badge>\n                )}\n              </div>\n              {gamePhase === \"cashed_out\" && cashedOutAt ? (\n                <div className=\"space-y-1\">\n                  <p className=\"text-2xl font-bold text-green-600 dark:text-green-400\" data-testid=\"text-cashout-multiplier\">\n                    {formatMultiplier(cashedOutAt)}\n                  </p>\n                  <p className=\"text-sm text-green-600\">\n                    +{calculatePotentialWinnings(stake, cashedOutAt).toLocaleString()} NGN\n                  </p>\n                </div>\n              ) : (\n                <div className=\"space-y-1\">\n                  <p className=\"text-2xl font-bold text-red-500\" data-testid=\"text-lost\">\n                    {formatMultiplier(crashPoint || 1)}\n                  </p>\n                  <p className=\"text-sm text-red-500\">\n                    -{stake.toLocaleString()} NGN\n                  </p>\n                </div>\n              )}\n            </Card>\n            \n            <Card className=\"p-4\">\n              <div className=\"flex items-center gap-2 mb-3\">\n                <Flame className=\"h-5 w-5 text-orange-500\" />\n                <span className=\"font-medium\">Crash Point</span>\n              </div>\n              <div className=\"space-y-1\">\n                <p className={`text-2xl font-bold ${getCrashPointColor(crashPoint || 1).replace('bg-', 'text-').replace('/20', '')}`} data-testid=\"text-crash-point\">\n                  {formatMultiplier(crashPoint || 1)}\n                </p>\n                <p className=\"text-xs text-muted-foreground\">\n                  {crashPoint && crashPoint >= 2 ? \"Good run!\" : \"Early crash\"}\n                </p>\n              </div>\n            </Card>\n          </div>\n\n          {crashHistory.length > 0 && (\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 text-sm font-medium\">\n                <History className=\"h-4 w-4 text-muted-foreground\" />\n                Recent Crashes\n              </div>\n              <div className=\"flex flex-wrap gap-2\">\n                {crashHistory.slice(0, 10).map((item) => (\n                  <Badge\n                    key={item.id}\n                    className={getCrashPointColor(item.crashPoint)}\n                    data-testid={`badge-history-${item.id}`}\n                  >\n                    {formatMultiplier(item.crashPoint)}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n          )}\n\n          <div className=\"flex gap-3\">\n            <Button \n              onClick={resetGame} \n              variant=\"outline\"\n              className=\"flex-1\"\n              size=\"lg\"\n              data-testid=\"button-play-again\"\n            >\n              <RotateCcw className=\"h-5 w-5 mr-2\" />\n              Play Again\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":26569,"size_tokens":null},"client/src/components/games/ChessBlitzGame.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  RotateCcw, \n  Trophy, \n  Bot, \n  User, \n  Play,\n  Clock,\n  Crown\n} from \"lucide-react\";\n\ninterface ChessBlitzGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype Player = \"white\" | \"black\";\ntype PieceType = \"king\" | \"queen\" | \"rook\" | \"bishop\" | \"knight\" | \"pawn\";\ntype GamePhase = \"ready\" | \"playing\" | \"finished\";\n\ninterface Piece {\n  type: PieceType;\n  color: Player;\n  hasMoved?: boolean;\n}\n\ninterface Position { row: number; col: number; }\n\ninterface Move {\n  from: Position;\n  to: Position;\n  capture?: Piece;\n  promotion?: PieceType;\n  isCastle?: \"kingside\" | \"queenside\";\n  isEnPassant?: boolean;\n}\n\ninterface GameState {\n  board: Board;\n  enPassantTarget: Position | null;\n}\n\ntype Board = (Piece | null)[][];\n\nconst BOARD_SIZE = 8;\nconst TIME_LIMIT = 180;\n\nconst PIECE_SYMBOLS: Record<PieceType, Record<Player, string>> = {\n  king: { white: \"♔\", black: \"♚\" },\n  queen: { white: \"♕\", black: \"♛\" },\n  rook: { white: \"♖\", black: \"♜\" },\n  bishop: { white: \"♗\", black: \"♝\" },\n  knight: { white: \"♘\", black: \"♞\" },\n  pawn: { white: \"♙\", black: \"♟\" },\n};\n\nconst PIECE_VALUES: Record<PieceType, number> = { pawn: 1, knight: 3, bishop: 3, rook: 5, queen: 9, king: 100 };\n\nconst createInitialBoard = (): Board => {\n  const board: Board = Array(8).fill(null).map(() => Array(8).fill(null));\n  const backRow: PieceType[] = [\"rook\", \"knight\", \"bishop\", \"queen\", \"king\", \"bishop\", \"knight\", \"rook\"];\n  for (let col = 0; col < 8; col++) {\n    board[0][col] = { type: backRow[col], color: \"black\" };\n    board[1][col] = { type: \"pawn\", color: \"black\" };\n    board[6][col] = { type: \"pawn\", color: \"white\" };\n    board[7][col] = { type: backRow[col], color: \"white\" };\n  }\n  return board;\n};\n\nconst copyBoard = (board: Board): Board => board.map(row => row.map(cell => cell ? { ...cell } : null));\n\nconst isValid = (r: number, c: number): boolean => r >= 0 && r < BOARD_SIZE && c >= 0 && c < BOARD_SIZE;\n\nconst findKing = (board: Board, color: Player): Position | null => {\n  for (let r = 0; r < BOARD_SIZE; r++) {\n    for (let c = 0; c < BOARD_SIZE; c++) {\n      const p = board[r][c];\n      if (p && p.type === \"king\" && p.color === color) return { row: r, col: c };\n    }\n  }\n  return null;\n};\n\nconst getRawMoves = (state: GameState, pos: Position, piece: Piece): Move[] => {\n  const moves: Move[] = [];\n  const { board, enPassantTarget } = state;\n  const { row, col } = pos;\n  \n  const addMove = (tr: number, tc: number): boolean => {\n    if (!isValid(tr, tc)) return false;\n    const target = board[tr][tc];\n    if (target && target.color === piece.color) return false;\n    moves.push({ from: pos, to: { row: tr, col: tc }, capture: target || undefined });\n    return !target;\n  };\n  \n  switch (piece.type) {\n    case \"pawn\": {\n      const dir = piece.color === \"white\" ? -1 : 1;\n      const start = piece.color === \"white\" ? 6 : 1;\n      const promoRow = piece.color === \"white\" ? 0 : 7;\n      \n      if (isValid(row + dir, col) && !board[row + dir][col]) {\n        if (row + dir === promoRow) {\n          moves.push({ from: pos, to: { row: row + dir, col }, promotion: \"queen\" });\n        } else {\n          moves.push({ from: pos, to: { row: row + dir, col } });\n        }\n        if (row === start && !board[row + dir * 2][col]) {\n          moves.push({ from: pos, to: { row: row + dir * 2, col } });\n        }\n      }\n      \n      for (const dc of [-1, 1]) {\n        const tr = row + dir, tc = col + dc;\n        if (isValid(tr, tc)) {\n          const target = board[tr][tc];\n          if (target && target.color !== piece.color) {\n            if (tr === promoRow) {\n              moves.push({ from: pos, to: { row: tr, col: tc }, capture: target, promotion: \"queen\" });\n            } else {\n              moves.push({ from: pos, to: { row: tr, col: tc }, capture: target });\n            }\n          }\n          if (enPassantTarget && enPassantTarget.row === tr && enPassantTarget.col === tc) {\n            moves.push({ from: pos, to: { row: tr, col: tc }, isEnPassant: true, capture: board[row][tc] || undefined });\n          }\n        }\n      }\n      break;\n    }\n    case \"knight\": {\n      for (const [dr, dc] of [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]]) addMove(row + dr, col + dc);\n      break;\n    }\n    case \"bishop\": {\n      for (const [dr, dc] of [[-1,-1],[-1,1],[1,-1],[1,1]]) {\n        for (let i = 1; i < BOARD_SIZE; i++) if (!addMove(row + dr * i, col + dc * i)) break;\n      }\n      break;\n    }\n    case \"rook\": {\n      for (const [dr, dc] of [[-1,0],[1,0],[0,-1],[0,1]]) {\n        for (let i = 1; i < BOARD_SIZE; i++) if (!addMove(row + dr * i, col + dc * i)) break;\n      }\n      break;\n    }\n    case \"queen\": {\n      for (const [dr, dc] of [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]]) {\n        for (let i = 1; i < BOARD_SIZE; i++) if (!addMove(row + dr * i, col + dc * i)) break;\n      }\n      break;\n    }\n    case \"king\": {\n      for (const [dr, dc] of [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]]) addMove(row + dr, col + dc);\n      break;\n    }\n  }\n  return moves;\n};\n\nconst isSquareAttacked = (board: Board, pos: Position, by: Player): boolean => {\n  for (let r = 0; r < BOARD_SIZE; r++) {\n    for (let c = 0; c < BOARD_SIZE; c++) {\n      const p = board[r][c];\n      if (p && p.color === by) {\n        if (p.type === \"pawn\") {\n          const dir = p.color === \"white\" ? -1 : 1;\n          if (pos.row === r + dir && (pos.col === c - 1 || pos.col === c + 1)) return true;\n        } else {\n          const state: GameState = { board, enPassantTarget: null };\n          const moves = getRawMoves(state, { row: r, col: c }, p);\n          if (moves.some(m => m.to.row === pos.row && m.to.col === pos.col)) return true;\n        }\n      }\n    }\n  }\n  return false;\n};\n\nconst isInCheck = (board: Board, color: Player): boolean => {\n  const k = findKing(board, color);\n  return k ? isSquareAttacked(board, k, color === \"white\" ? \"black\" : \"white\") : false;\n};\n\nconst applyMove = (state: GameState, move: Move): GameState => {\n  const newBoard = copyBoard(state.board);\n  const piece = newBoard[move.from.row][move.from.col];\n  if (!piece) return state;\n  \n  newBoard[move.from.row][move.from.col] = null;\n  \n  let newEnPassant: Position | null = null;\n  \n  if (move.isCastle) {\n    const backRank = piece.color === \"white\" ? 7 : 0;\n    if (move.isCastle === \"kingside\") {\n      newBoard[backRank][7] = null;\n      newBoard[backRank][5] = { type: \"rook\", color: piece.color, hasMoved: true };\n      newBoard[backRank][6] = { ...piece, hasMoved: true };\n    } else {\n      newBoard[backRank][0] = null;\n      newBoard[backRank][3] = { type: \"rook\", color: piece.color, hasMoved: true };\n      newBoard[backRank][2] = { ...piece, hasMoved: true };\n    }\n    return { board: newBoard, enPassantTarget: null };\n  }\n  \n  if (move.isEnPassant) {\n    const captureRow = move.to.row + (piece.color === \"white\" ? 1 : -1);\n    newBoard[captureRow][move.to.col] = null;\n  }\n  \n  if (piece.type === \"pawn\" && Math.abs(move.to.row - move.from.row) === 2) {\n    newEnPassant = { row: (move.from.row + move.to.row) / 2, col: move.from.col };\n  }\n  \n  if (move.promotion) {\n    newBoard[move.to.row][move.to.col] = { type: move.promotion, color: piece.color, hasMoved: true };\n  } else {\n    newBoard[move.to.row][move.to.col] = { ...piece, hasMoved: true };\n  }\n  \n  return { board: newBoard, enPassantTarget: newEnPassant };\n};\n\nconst getValidMoves = (state: GameState, player: Player): Move[] => {\n  const allMoves: Move[] = [];\n  const { board } = state;\n  \n  for (let r = 0; r < BOARD_SIZE; r++) {\n    for (let c = 0; c < BOARD_SIZE; c++) {\n      const piece = board[r][c];\n      if (piece && piece.color === player) {\n        const moves = getRawMoves(state, { row: r, col: c }, piece);\n        for (const m of moves) {\n          const newState = applyMove(state, m);\n          if (!isInCheck(newState.board, player)) allMoves.push(m);\n        }\n        \n        if (piece.type === \"king\" && !piece.hasMoved && !isInCheck(board, player)) {\n          const backRank = player === \"white\" ? 7 : 0;\n          if (r === backRank && c === 4) {\n            const ksRook = board[backRank][7];\n            if (ksRook && ksRook.type === \"rook\" && !ksRook.hasMoved &&\n                !board[backRank][5] && !board[backRank][6] &&\n                !isSquareAttacked(board, { row: backRank, col: 5 }, player === \"white\" ? \"black\" : \"white\") &&\n                !isSquareAttacked(board, { row: backRank, col: 6 }, player === \"white\" ? \"black\" : \"white\")) {\n              allMoves.push({ from: { row: r, col: c }, to: { row: backRank, col: 6 }, isCastle: \"kingside\" });\n            }\n            \n            const qsRook = board[backRank][0];\n            if (qsRook && qsRook.type === \"rook\" && !qsRook.hasMoved &&\n                !board[backRank][1] && !board[backRank][2] && !board[backRank][3] &&\n                !isSquareAttacked(board, { row: backRank, col: 3 }, player === \"white\" ? \"black\" : \"white\") &&\n                !isSquareAttacked(board, { row: backRank, col: 2 }, player === \"white\" ? \"black\" : \"white\")) {\n              allMoves.push({ from: { row: r, col: c }, to: { row: backRank, col: 2 }, isCastle: \"queenside\" });\n            }\n          }\n        }\n      }\n    }\n  }\n  return allMoves;\n};\n\nconst evaluateBoard = (board: Board): number => {\n  let score = 0;\n  for (let r = 0; r < BOARD_SIZE; r++) {\n    for (let c = 0; c < BOARD_SIZE; c++) {\n      const p = board[r][c];\n      if (p) {\n        const v = PIECE_VALUES[p.type];\n        const posBonus = p.type === \"pawn\" ? (p.color === \"white\" ? (6 - r) * 0.1 : (r - 1) * 0.1) : 0;\n        score += (p.color === \"black\" ? 1 : -1) * (v + posBonus);\n      }\n    }\n  }\n  return score;\n};\n\nconst minimax = (state: GameState, depth: number, alpha: number, beta: number, isMax: boolean): { score: number; move: Move | null } => {\n  const player = isMax ? \"black\" : \"white\";\n  const moves = getValidMoves(state, player);\n  \n  if (depth === 0) return { score: evaluateBoard(state.board), move: null };\n  \n  if (moves.length === 0) {\n    if (isInCheck(state.board, player)) return { score: isMax ? -1000 : 1000, move: null };\n    return { score: 0, move: null };\n  }\n  \n  moves.sort((a, b) => (b.capture ? PIECE_VALUES[b.capture.type] : 0) - (a.capture ? PIECE_VALUES[a.capture.type] : 0));\n  \n  let best: Move | null = null;\n  \n  if (isMax) {\n    let maxS = -Infinity;\n    for (const m of moves) {\n      const ns = applyMove(state, m);\n      const res = minimax(ns, depth - 1, alpha, beta, false);\n      if (res.score > maxS) { maxS = res.score; best = m; }\n      alpha = Math.max(alpha, res.score);\n      if (beta <= alpha) break;\n    }\n    return { score: maxS, move: best };\n  } else {\n    let minS = Infinity;\n    for (const m of moves) {\n      const ns = applyMove(state, m);\n      const res = minimax(ns, depth - 1, alpha, beta, true);\n      if (res.score < minS) { minS = res.score; best = m; }\n      beta = Math.min(beta, res.score);\n      if (beta <= alpha) break;\n    }\n    return { score: minS, move: best };\n  }\n};\n\nconst getAIMove = (state: GameState): Move | null => minimax(state, 3, -Infinity, Infinity, true).move;\n\nexport default function ChessBlitzGame({ stake, onGameEnd, isPractice }: ChessBlitzGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"ready\");\n  const [gameState, setGameState] = useState<GameState>({ board: createInitialBoard(), enPassantTarget: null });\n  const [currentPlayer, setCurrentPlayer] = useState<Player>(\"white\");\n  const [selectedPiece, setSelectedPiece] = useState<Position | null>(null);\n  const [validMoves, setValidMoves] = useState<Move[]>([]);\n  const [winner, setWinner] = useState<Player | \"draw\" | null>(null);\n  const [message, setMessage] = useState(\"Click Start to begin!\");\n  const [isAIThinking, setIsAIThinking] = useState(false);\n  const [whiteTime, setWhiteTime] = useState(TIME_LIMIT);\n  const [blackTime, setBlackTime] = useState(TIME_LIMIT);\n  const timerRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    if (gamePhase === \"playing\" && !winner) {\n      if (timerRef.current) clearInterval(timerRef.current);\n      timerRef.current = setInterval(() => {\n        if (currentPlayer === \"white\") {\n          setWhiteTime(prev => {\n            if (prev <= 1) {\n              setWinner(\"black\");\n              setGamePhase(\"finished\");\n              setMessage(\"Time's up! AI wins!\");\n              return 0;\n            }\n            return prev - 1;\n          });\n        } else {\n          setBlackTime(prev => {\n            if (prev <= 1) {\n              setWinner(\"white\");\n              setGamePhase(\"finished\");\n              setMessage(\"Time's up! You win!\");\n              return 0;\n            }\n            return prev - 1;\n          });\n        }\n      }, 1000);\n    }\n    return () => { if (timerRef.current) clearInterval(timerRef.current); };\n  }, [gamePhase, currentPlayer, winner]);\n\n  const checkGameEnd = useCallback((state: GameState, nextPlayer: Player) => {\n    const moves = getValidMoves(state, nextPlayer);\n    if (moves.length === 0) {\n      if (isInCheck(state.board, nextPlayer)) {\n        const w = nextPlayer === \"white\" ? \"black\" : \"white\";\n        setWinner(w);\n        setGamePhase(\"finished\");\n        setMessage(w === \"white\" ? \"Checkmate! You win!\" : \"Checkmate! AI wins!\");\n      } else {\n        setWinner(\"draw\");\n        setGamePhase(\"finished\");\n        setMessage(\"Stalemate! It's a draw!\");\n      }\n      return true;\n    }\n    if (isInCheck(state.board, nextPlayer)) {\n      setMessage(nextPlayer === \"white\" ? \"Check! Defend your king!\" : \"Check!\");\n    }\n    return false;\n  }, []);\n\n  const makeAIMove = useCallback(() => {\n    setIsAIThinking(true);\n    setMessage(\"AI is thinking...\");\n    setTimeout(() => {\n      const aiMove = getAIMove(gameState);\n      if (aiMove) {\n        const newState = applyMove(gameState, aiMove);\n        setGameState(newState);\n        if (!checkGameEnd(newState, \"white\")) {\n          setCurrentPlayer(\"white\");\n          if (!isInCheck(newState.board, \"white\")) setMessage(\"Your turn\");\n        }\n      } else {\n        setWinner(\"white\");\n        setGamePhase(\"finished\");\n        setMessage(\"You win!\");\n      }\n      setIsAIThinking(false);\n    }, 600);\n  }, [gameState, checkGameEnd]);\n\n  useEffect(() => {\n    if (gamePhase === \"playing\" && currentPlayer === \"black\" && !isAIThinking && !winner) makeAIMove();\n  }, [currentPlayer, gamePhase, isAIThinking, makeAIMove, winner]);\n\n  const startGame = () => {\n    setGameState({ board: createInitialBoard(), enPassantTarget: null });\n    setCurrentPlayer(\"white\");\n    setSelectedPiece(null);\n    setValidMoves([]);\n    setWinner(null);\n    setGamePhase(\"playing\");\n    setMessage(\"Your turn\");\n    setWhiteTime(TIME_LIMIT);\n    setBlackTime(TIME_LIMIT);\n  };\n\n  const handleCellClick = (row: number, col: number) => {\n    if (gamePhase !== \"playing\" || currentPlayer !== \"white\" || isAIThinking) return;\n    \n    const piece = gameState.board[row][col];\n    \n    if (selectedPiece) {\n      const move = validMoves.find(m => m.to.row === row && m.to.col === col);\n      if (move) {\n        const newState = applyMove(gameState, move);\n        setGameState(newState);\n        setSelectedPiece(null);\n        setValidMoves([]);\n        if (!checkGameEnd(newState, \"black\")) setCurrentPlayer(\"black\");\n        return;\n      }\n      if (piece && piece.color === \"white\") {\n        const allMoves = getValidMoves(gameState, \"white\");\n        const pieceMoves = allMoves.filter(m => m.from.row === row && m.from.col === col);\n        setSelectedPiece({ row, col });\n        setValidMoves(pieceMoves);\n        return;\n      }\n      setSelectedPiece(null);\n      setValidMoves([]);\n      return;\n    }\n    \n    if (piece && piece.color === \"white\") {\n      const allMoves = getValidMoves(gameState, \"white\");\n      const pieceMoves = allMoves.filter(m => m.from.row === row && m.from.col === col);\n      if (pieceMoves.length > 0) {\n        setSelectedPiece({ row, col });\n        setValidMoves(pieceMoves);\n      }\n    }\n  };\n\n  const handleGameEnd = () => {\n    if (timerRef.current) clearInterval(timerRef.current);\n    onGameEnd(winner === \"white\");\n  };\n\n  const formatTime = (s: number): string => `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, \"0\")}`;\n\n  const renderCell = (row: number, col: number) => {\n    const isDark = (row + col) % 2 === 1;\n    const piece = gameState.board[row][col];\n    const isSelected = selectedPiece?.row === row && selectedPiece?.col === col;\n    const isValidMove = validMoves.some(m => m.to.row === row && m.to.col === col);\n    const isCapture = validMoves.some(m => m.to.row === row && m.to.col === col && (m.capture || m.isEnPassant));\n    \n    return (\n      <motion.div\n        key={`${row}-${col}`}\n        className={`w-9 h-9 sm:w-11 sm:h-11 flex items-center justify-center relative cursor-pointer\n          ${isDark ? \"bg-emerald-700 dark:bg-emerald-800\" : \"bg-emerald-100 dark:bg-emerald-200\"}\n          ${isSelected ? \"ring-2 ring-yellow-500\" : \"\"}\n          ${isValidMove && !isCapture ? \"ring-2 ring-blue-500\" : \"\"}\n          ${isCapture ? \"ring-2 ring-red-500\" : \"\"}`}\n        onClick={() => handleCellClick(row, col)}\n        whileHover={{ scale: 1.02 }}\n        whileTap={{ scale: 0.98 }}\n      >\n        {piece && (\n          <motion.span initial={{ scale: 0 }} animate={{ scale: 1 }}\n            className={`text-2xl sm:text-3xl select-none ${piece.color === \"white\" ? \"text-white drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]\" : \"text-gray-900 drop-shadow-[0_1px_1px_rgba(255,255,255,0.3)]\"}`}>\n            {PIECE_SYMBOLS[piece.type][piece.color]}\n          </motion.span>\n        )}\n        {isValidMove && !piece && <div className=\"w-3 h-3 rounded-full bg-blue-500/50\" />}\n      </motion.div>\n    );\n  };\n\n  if (gamePhase === \"ready\") {\n    return (\n      <Card className=\"border-2\">\n        <CardHeader className=\"text-center pb-4\">\n          <div className=\"flex items-center justify-center gap-2 mb-2\">\n            <Crown className=\"h-6 w-6 text-primary\" />\n            <CardTitle className=\"text-xl\">Chess Blitz</CardTitle>\n          </div>\n          <p className=\"text-sm text-muted-foreground\">3-minute rapid chess against AI</p>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"space-y-4 text-sm text-muted-foreground\">\n            <h3 className=\"font-semibold text-foreground\">How to Play:</h3>\n            <ul className=\"list-disc list-inside space-y-1\">\n              <li>Standard chess rules apply</li>\n              <li>Each player has 3 minutes on their clock</li>\n              <li>Tap a piece to see valid moves</li>\n              <li>Tap a highlighted square to move</li>\n              <li>Checkmate the opponent's king to win</li>\n              <li>Running out of time loses the game</li>\n            </ul>\n          </div>\n          <div className=\"flex items-center justify-between p-3 bg-muted/50 rounded-lg\">\n            <div className=\"flex items-center gap-2\"><User className=\"h-5 w-5\" /><span>You (White)</span></div>\n            <span className=\"text-muted-foreground\">vs</span>\n            <div className=\"flex items-center gap-2\"><span>AI (Black)</span><Bot className=\"h-5 w-5\" /></div>\n          </div>\n          {!isPractice && (\n            <div className=\"p-3 bg-amber-500/10 rounded-lg text-center\">\n              <p className=\"text-sm\"><span className=\"font-semibold\">Stake:</span> {stake.toLocaleString()} NGN</p>\n            </div>\n          )}\n          <Button onClick={startGame} className=\"w-full\" size=\"lg\" data-testid=\"button-start-chess\">\n            <Play className=\"h-5 w-5 mr-2\" />Start Game\n          </Button>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <Card className=\"border-2\">\n        <CardHeader className=\"pb-2\">\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <CardTitle className=\"text-lg flex items-center gap-2\"><Crown className=\"h-5 w-5\" />Chess Blitz</CardTitle>\n            {!isPractice && <Badge variant=\"secondary\">{stake.toLocaleString()} NGN</Badge>}\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex justify-between items-center\">\n            <div className={`flex items-center gap-2 p-2 rounded ${currentPlayer === \"white\" ? \"bg-primary/10\" : \"\"}`}>\n              <User className=\"h-4 w-4\" /><span className=\"text-sm font-medium\">You</span>\n              <Badge variant={whiteTime < 30 ? \"destructive\" : \"outline\"} className=\"tabular-nums\"><Clock className=\"h-3 w-3 mr-1\" />{formatTime(whiteTime)}</Badge>\n            </div>\n            <div className={`flex items-center gap-2 p-2 rounded ${currentPlayer === \"black\" ? \"bg-primary/10\" : \"\"}`}>\n              <Badge variant={blackTime < 30 ? \"destructive\" : \"outline\"} className=\"tabular-nums\"><Clock className=\"h-3 w-3 mr-1\" />{formatTime(blackTime)}</Badge>\n              <span className=\"text-sm font-medium\">AI</span><Bot className=\"h-4 w-4\" />\n            </div>\n          </div>\n          <div className=\"flex justify-center\">\n            <div className=\"border-4 border-emerald-900 rounded-md overflow-hidden shadow-xl\">\n              {Array(BOARD_SIZE).fill(null).map((_, row) => (\n                <div key={row} className=\"flex\">{Array(BOARD_SIZE).fill(null).map((_, col) => renderCell(row, col))}</div>\n              ))}\n            </div>\n          </div>\n          <AnimatePresence mode=\"wait\">\n            <motion.div key={message} initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 10 }} className=\"text-center text-sm text-muted-foreground\">\n              {message}\n            </motion.div>\n          </AnimatePresence>\n        </CardContent>\n      </Card>\n      <AnimatePresence>\n        {gamePhase === \"finished\" && (\n          <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.9 }}>\n            <Card className={`border-2 ${winner === \"white\" ? \"border-green-500\" : winner === \"draw\" ? \"border-yellow-500\" : \"border-red-500\"}`}>\n              <CardContent className=\"p-6 text-center space-y-4\">\n                <div className={`inline-flex p-4 rounded-full ${winner === \"white\" ? \"bg-green-500/10\" : winner === \"draw\" ? \"bg-yellow-500/10\" : \"bg-red-500/10\"}`}>\n                  <Trophy className={`h-10 w-10 ${winner === \"white\" ? \"text-green-500\" : winner === \"draw\" ? \"text-yellow-500\" : \"text-red-500\"}`} />\n                </div>\n                <h2 className=\"text-2xl font-bold\">{winner === \"white\" ? \"Victory!\" : winner === \"draw\" ? \"Draw!\" : \"Defeat\"}</h2>\n                <p className=\"text-muted-foreground\">\n                  {winner === \"white\" ? \"Congratulations! You defeated the AI!\" : winner === \"draw\" ? \"The game ended in a stalemate.\" : \"The AI was victorious this time.\"}\n                </p>\n                {!isPractice && (\n                  <p className={`font-semibold ${winner === \"white\" ? \"text-green-600\" : winner === \"draw\" ? \"text-yellow-600\" : \"text-red-600\"}`}>\n                    {winner === \"white\" ? `+${(stake * 0.95 * 2).toLocaleString()} NGN` : winner === \"draw\" ? \"Stake returned\" : `-${stake.toLocaleString()} NGN`}\n                  </p>\n                )}\n                <div className=\"flex gap-2 justify-center flex-wrap\">\n                  <Button onClick={startGame} variant=\"outline\"><RotateCcw className=\"h-4 w-4 mr-2\" />Play Again</Button>\n                  <Button onClick={handleGameEnd} data-testid=\"button-finish-chess\">Finish</Button>\n                </div>\n              </CardContent>\n            </Card>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n","path":null,"size_bytes":24158,"size_tokens":null},"client/src/components/games/DraughtsGame.tsx":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  RotateCcw, \n  Trophy, \n  Bot, \n  User, \n  Play,\n  Crown,\n  Target\n} from \"lucide-react\";\n\ninterface DraughtsGameProps {\n  stake: number;\n  onGameEnd: (won: boolean, score?: number) => void;\n  isPractice: boolean;\n}\n\ntype Player = \"player\" | \"ai\";\ntype PieceType = \"normal\" | \"king\";\ntype GamePhase = \"ready\" | \"playing\" | \"finished\";\n\ninterface Piece {\n  owner: Player;\n  type: PieceType;\n}\n\ninterface Position {\n  row: number;\n  col: number;\n}\n\ninterface Move {\n  from: Position;\n  to: Position;\n  captures: Position[];\n  isJump: boolean;\n}\n\ntype Board = (Piece | null)[][];\n\nconst BOARD_SIZE = 10;\n\nconst createInitialBoard = (): Board => {\n  const board: Board = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(null));\n  \n  for (let row = 0; row < 4; row++) {\n    for (let col = 0; col < BOARD_SIZE; col++) {\n      if ((row + col) % 2 === 1) {\n        board[row][col] = { owner: \"ai\", type: \"normal\" };\n      }\n    }\n  }\n  \n  for (let row = 6; row < BOARD_SIZE; row++) {\n    for (let col = 0; col < BOARD_SIZE; col++) {\n      if ((row + col) % 2 === 1) {\n        board[row][col] = { owner: \"player\", type: \"normal\" };\n      }\n    }\n  }\n  \n  return board;\n};\n\nconst copyBoard = (board: Board): Board => {\n  return board.map(row => row.map(cell => cell ? { ...cell } : null));\n};\n\nconst posEqual = (a: Position, b: Position): boolean => a.row === b.row && a.col === b.col;\n\nconst getSimpleMoves = (board: Board, pos: Position, piece: Piece): Move[] => {\n  const moves: Move[] = [];\n  const directions = piece.type === \"king\" \n    ? [[-1, -1], [-1, 1], [1, -1], [1, 1]]\n    : piece.owner === \"player\" \n      ? [[-1, -1], [-1, 1]]\n      : [[1, -1], [1, 1]];\n  \n  const maxDist = piece.type === \"king\" ? BOARD_SIZE - 1 : 1;\n  \n  for (const [dr, dc] of directions) {\n    for (let d = 1; d <= maxDist; d++) {\n      const nr = pos.row + dr * d;\n      const nc = pos.col + dc * d;\n      if (nr < 0 || nr >= BOARD_SIZE || nc < 0 || nc >= BOARD_SIZE) break;\n      if (board[nr][nc] !== null) break;\n      moves.push({ from: pos, to: { row: nr, col: nc }, captures: [], isJump: false });\n    }\n  }\n  return moves;\n};\n\nconst getJumpMoves = (board: Board, pos: Position, piece: Piece, capturedSoFar: Position[]): Move[] => {\n  const moves: Move[] = [];\n  const directions = [[-1, -1], [-1, 1], [1, -1], [1, 1]];\n  \n  for (const [dr, dc] of directions) {\n    if (piece.type === \"normal\") {\n      const jumpRow = pos.row + dr;\n      const jumpCol = pos.col + dc;\n      const landRow = pos.row + dr * 2;\n      const landCol = pos.col + dc * 2;\n      \n      if (landRow < 0 || landRow >= BOARD_SIZE || landCol < 0 || landCol >= BOARD_SIZE) continue;\n      if (jumpRow < 0 || jumpRow >= BOARD_SIZE || jumpCol < 0 || jumpCol >= BOARD_SIZE) continue;\n      \n      const jumped = board[jumpRow][jumpCol];\n      if (!jumped || jumped.owner === piece.owner) continue;\n      if (capturedSoFar.some(c => posEqual(c, { row: jumpRow, col: jumpCol }))) continue;\n      if (board[landRow][landCol] !== null) continue;\n      \n      const newCaptures = [...capturedSoFar, { row: jumpRow, col: jumpCol }];\n      const tempBoard = copyBoard(board);\n      tempBoard[pos.row][pos.col] = null;\n      tempBoard[jumpRow][jumpCol] = null;\n      \n      let landingPiece = { ...piece };\n      if ((piece.owner === \"player\" && landRow === 0) || (piece.owner === \"ai\" && landRow === BOARD_SIZE - 1)) {\n        landingPiece.type = \"king\";\n      }\n      tempBoard[landRow][landCol] = landingPiece;\n      \n      const further = getJumpMoves(tempBoard, { row: landRow, col: landCol }, landingPiece, newCaptures);\n      \n      if (further.length > 0) {\n        for (const fj of further) {\n          moves.push({ from: pos, to: fj.to, captures: newCaptures.concat(fj.captures.filter(c => !newCaptures.some(nc => posEqual(nc, c)))), isJump: true });\n        }\n      } else {\n        moves.push({ from: pos, to: { row: landRow, col: landCol }, captures: newCaptures, isJump: true });\n      }\n    } else {\n      for (let d = 1; d < BOARD_SIZE; d++) {\n        const jumpRow = pos.row + dr * d;\n        const jumpCol = pos.col + dc * d;\n        if (jumpRow < 0 || jumpRow >= BOARD_SIZE || jumpCol < 0 || jumpCol >= BOARD_SIZE) break;\n        \n        const cell = board[jumpRow][jumpCol];\n        if (cell === null) continue;\n        if (cell.owner === piece.owner) break;\n        if (capturedSoFar.some(c => posEqual(c, { row: jumpRow, col: jumpCol }))) break;\n        \n        for (let ld = 1; ld < BOARD_SIZE; ld++) {\n          const landRow = jumpRow + dr * ld;\n          const landCol = jumpCol + dc * ld;\n          if (landRow < 0 || landRow >= BOARD_SIZE || landCol < 0 || landCol >= BOARD_SIZE) break;\n          if (board[landRow][landCol] !== null) break;\n          \n          const newCaptures = [...capturedSoFar, { row: jumpRow, col: jumpCol }];\n          const tempBoard = copyBoard(board);\n          tempBoard[pos.row][pos.col] = null;\n          tempBoard[jumpRow][jumpCol] = null;\n          tempBoard[landRow][landCol] = piece;\n          \n          const further = getJumpMoves(tempBoard, { row: landRow, col: landCol }, piece, newCaptures);\n          \n          if (further.length > 0) {\n            for (const fj of further) {\n              moves.push({ from: pos, to: fj.to, captures: newCaptures.concat(fj.captures.filter(c => !newCaptures.some(nc => posEqual(nc, c)))), isJump: true });\n            }\n          } else {\n            moves.push({ from: pos, to: { row: landRow, col: landCol }, captures: newCaptures, isJump: true });\n          }\n        }\n        break;\n      }\n    }\n  }\n  return moves;\n};\n\nconst getValidMoves = (board: Board, player: Player): Move[] => {\n  const allJumps: Move[] = [];\n  const allSimple: Move[] = [];\n  \n  for (let row = 0; row < BOARD_SIZE; row++) {\n    for (let col = 0; col < BOARD_SIZE; col++) {\n      const piece = board[row][col];\n      if (piece && piece.owner === player) {\n        const jumps = getJumpMoves(board, { row, col }, piece, []);\n        allJumps.push(...jumps);\n        if (allJumps.length === 0) {\n          const simple = getSimpleMoves(board, { row, col }, piece);\n          allSimple.push(...simple);\n        }\n      }\n    }\n  }\n  \n  if (allJumps.length > 0) {\n    const maxCaptures = Math.max(...allJumps.map(m => m.captures.length));\n    return allJumps.filter(m => m.captures.length === maxCaptures);\n  }\n  return allSimple;\n};\n\nconst applyMove = (board: Board, move: Move): Board => {\n  const newBoard = copyBoard(board);\n  const piece = newBoard[move.from.row][move.from.col];\n  if (!piece) return newBoard;\n  \n  newBoard[move.from.row][move.from.col] = null;\n  move.captures.forEach(cap => { newBoard[cap.row][cap.col] = null; });\n  \n  if ((piece.owner === \"player\" && move.to.row === 0) || (piece.owner === \"ai\" && move.to.row === BOARD_SIZE - 1)) {\n    piece.type = \"king\";\n  }\n  newBoard[move.to.row][move.to.col] = piece;\n  return newBoard;\n};\n\nconst countPieces = (board: Board): { player: number; ai: number } => {\n  let player = 0, ai = 0;\n  for (let r = 0; r < BOARD_SIZE; r++) {\n    for (let c = 0; c < BOARD_SIZE; c++) {\n      const p = board[r][c];\n      if (p) { p.owner === \"player\" ? player++ : ai++; }\n    }\n  }\n  return { player, ai };\n};\n\nconst evaluateBoard = (board: Board): number => {\n  let score = 0;\n  for (let r = 0; r < BOARD_SIZE; r++) {\n    for (let c = 0; c < BOARD_SIZE; c++) {\n      const p = board[r][c];\n      if (p) {\n        const val = p.type === \"king\" ? 3 : 1;\n        const posBonus = p.owner === \"ai\" ? (r / BOARD_SIZE) * 0.3 : ((BOARD_SIZE - 1 - r) / BOARD_SIZE) * 0.3;\n        score += (p.owner === \"ai\" ? 1 : -1) * (val + posBonus);\n      }\n    }\n  }\n  return score;\n};\n\nconst minimax = (board: Board, depth: number, alpha: number, beta: number, isMax: boolean): { score: number; move: Move | null } => {\n  const player = isMax ? \"ai\" : \"player\";\n  const moves = getValidMoves(board, player);\n  \n  if (depth === 0 || moves.length === 0) {\n    return { score: evaluateBoard(board), move: null };\n  }\n  \n  let best: Move | null = null;\n  \n  if (isMax) {\n    let maxS = -Infinity;\n    for (const m of moves) {\n      const nb = applyMove(board, m);\n      const res = minimax(nb, depth - 1, alpha, beta, false);\n      if (res.score > maxS) { maxS = res.score; best = m; }\n      alpha = Math.max(alpha, res.score);\n      if (beta <= alpha) break;\n    }\n    return { score: maxS, move: best };\n  } else {\n    let minS = Infinity;\n    for (const m of moves) {\n      const nb = applyMove(board, m);\n      const res = minimax(nb, depth - 1, alpha, beta, true);\n      if (res.score < minS) { minS = res.score; best = m; }\n      beta = Math.min(beta, res.score);\n      if (beta <= alpha) break;\n    }\n    return { score: minS, move: best };\n  }\n};\n\nconst getAIMove = (board: Board): Move | null => minimax(board, 4, -Infinity, Infinity, true).move;\n\nexport default function DraughtsGame({ stake, onGameEnd, isPractice }: DraughtsGameProps) {\n  const [gamePhase, setGamePhase] = useState<GamePhase>(\"ready\");\n  const [board, setBoard] = useState<Board>(createInitialBoard());\n  const [currentPlayer, setCurrentPlayer] = useState<Player>(\"player\");\n  const [selectedPiece, setSelectedPiece] = useState<Position | null>(null);\n  const [validMoves, setValidMoves] = useState<Move[]>([]);\n  const [winner, setWinner] = useState<Player | null>(null);\n  const [message, setMessage] = useState(\"Click Start to begin!\");\n  const [isAIThinking, setIsAIThinking] = useState(false);\n\n  const checkGameEnd = useCallback((currentBoard: Board, nextPlayer: Player) => {\n    const counts = countPieces(currentBoard);\n    \n    if (counts.player === 0) {\n      setWinner(\"ai\");\n      setGamePhase(\"finished\");\n      setMessage(\"AI wins! All your pieces were captured.\");\n      return true;\n    }\n    \n    if (counts.ai === 0) {\n      setWinner(\"player\");\n      setGamePhase(\"finished\");\n      setMessage(\"You win! You captured all AI pieces!\");\n      return true;\n    }\n    \n    const moves = getValidMoves(currentBoard, nextPlayer);\n    if (moves.length === 0) {\n      const w = nextPlayer === \"player\" ? \"ai\" : \"player\";\n      setWinner(w);\n      setGamePhase(\"finished\");\n      setMessage(w === \"player\" ? \"You win! AI has no moves left!\" : \"AI wins! You have no moves left.\");\n      return true;\n    }\n    return false;\n  }, []);\n\n  const makeAIMove = useCallback(() => {\n    setIsAIThinking(true);\n    setMessage(\"AI is thinking...\");\n    \n    setTimeout(() => {\n      const aiMove = getAIMove(board);\n      if (aiMove) {\n        const newBoard = applyMove(board, aiMove);\n        setBoard(newBoard);\n        if (!checkGameEnd(newBoard, \"player\")) {\n          setCurrentPlayer(\"player\");\n          setMessage(\"Your turn - select a piece to move\");\n        }\n      } else {\n        setWinner(\"player\");\n        setGamePhase(\"finished\");\n        setMessage(\"You win! AI has no valid moves!\");\n      }\n      setIsAIThinking(false);\n    }, 800);\n  }, [board, checkGameEnd]);\n\n  useEffect(() => {\n    if (gamePhase === \"playing\" && currentPlayer === \"ai\" && !isAIThinking) {\n      makeAIMove();\n    }\n  }, [currentPlayer, gamePhase, isAIThinking, makeAIMove]);\n\n  const startGame = () => {\n    setBoard(createInitialBoard());\n    setCurrentPlayer(\"player\");\n    setSelectedPiece(null);\n    setValidMoves([]);\n    setWinner(null);\n    setGamePhase(\"playing\");\n    setMessage(\"Your turn - select a piece to move\");\n  };\n\n  const handleCellClick = (row: number, col: number) => {\n    if (gamePhase !== \"playing\" || currentPlayer !== \"player\" || isAIThinking) return;\n    \n    const piece = board[row][col];\n    \n    if (selectedPiece) {\n      const move = validMoves.find(m => m.to.row === row && m.to.col === col);\n      if (move) {\n        const newBoard = applyMove(board, move);\n        setBoard(newBoard);\n        setSelectedPiece(null);\n        setValidMoves([]);\n        if (!checkGameEnd(newBoard, \"ai\")) {\n          setCurrentPlayer(\"ai\");\n        }\n        return;\n      }\n      \n      if (piece && piece.owner === \"player\") {\n        const allMoves = getValidMoves(board, \"player\");\n        const pieceMoves = allMoves.filter(m => m.from.row === row && m.from.col === col);\n        if (pieceMoves.length > 0) {\n          setSelectedPiece({ row, col });\n          setValidMoves(pieceMoves);\n        } else {\n          setMessage(\"This piece has no valid moves - you must capture if possible!\");\n        }\n        return;\n      }\n      \n      setSelectedPiece(null);\n      setValidMoves([]);\n      return;\n    }\n    \n    if (piece && piece.owner === \"player\") {\n      const allMoves = getValidMoves(board, \"player\");\n      const pieceMoves = allMoves.filter(m => m.from.row === row && m.from.col === col);\n      \n      if (pieceMoves.length > 0) {\n        setSelectedPiece({ row, col });\n        setValidMoves(pieceMoves);\n      } else {\n        const hasAnyMoves = allMoves.length > 0;\n        setMessage(hasAnyMoves ? \"This piece has no valid moves - you must capture if possible!\" : \"No moves available\");\n      }\n    }\n  };\n\n  const handleGameEnd = () => {\n    onGameEnd(winner === \"player\", countPieces(board).player);\n  };\n\n  const renderCell = (row: number, col: number) => {\n    const isDark = (row + col) % 2 === 1;\n    const piece = board[row][col];\n    const isSelected = selectedPiece?.row === row && selectedPiece?.col === col;\n    const isValidMove = validMoves.some(m => m.to.row === row && m.to.col === col);\n    const isCapture = validMoves.some(m => m.captures.some(c => c.row === row && c.col === col));\n    \n    return (\n      <motion.div\n        key={`${row}-${col}`}\n        className={`\n          w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center relative cursor-pointer\n          ${isDark ? \"bg-amber-800 dark:bg-amber-900\" : \"bg-amber-100 dark:bg-amber-200\"}\n          ${isSelected ? \"ring-2 ring-blue-500\" : \"\"}\n          ${isValidMove ? \"ring-2 ring-green-500\" : \"\"}\n        `}\n        onClick={() => handleCellClick(row, col)}\n        whileHover={{ scale: isDark ? 1.05 : 1 }}\n        whileTap={{ scale: 0.95 }}\n      >\n        {isCapture && <div className=\"absolute inset-0 bg-red-500/30 animate-pulse\" />}\n        \n        {piece && (\n          <motion.div\n            initial={{ scale: 0 }}\n            animate={{ scale: 1 }}\n            className={`\n              w-6 h-6 sm:w-8 sm:h-8 rounded-full flex items-center justify-center\n              ${piece.owner === \"player\" \n                ? \"bg-gradient-to-br from-red-400 to-red-600 border-2 border-red-300\" \n                : \"bg-gradient-to-br from-gray-700 to-gray-900 border-2 border-gray-500\"\n              }\n              shadow-lg\n            `}\n          >\n            {piece.type === \"king\" && <Crown className=\"w-3 h-3 sm:w-4 sm:h-4 text-yellow-400\" />}\n          </motion.div>\n        )}\n        \n        {isValidMove && !piece && <div className=\"w-3 h-3 rounded-full bg-green-500/60 animate-pulse\" />}\n      </motion.div>\n    );\n  };\n\n  if (gamePhase === \"ready\") {\n    return (\n      <Card className=\"border-2\">\n        <CardHeader className=\"text-center pb-4\">\n          <div className=\"flex items-center justify-center gap-2 mb-2\">\n            <Target className=\"h-6 w-6 text-primary\" />\n            <CardTitle className=\"text-xl\">Draughts (Checkers)</CardTitle>\n          </div>\n          <p className=\"text-sm text-muted-foreground\">10x10 International Draughts with flying kings</p>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"space-y-4 text-sm text-muted-foreground\">\n            <h3 className=\"font-semibold text-foreground\">How to Play:</h3>\n            <ul className=\"list-disc list-inside space-y-1\">\n              <li>Move diagonally forward to empty squares</li>\n              <li>Capture by jumping over opponent pieces</li>\n              <li>Captures are mandatory - you must take the maximum</li>\n              <li>Kings can move and capture in all diagonal directions</li>\n              <li>Kings fly across the board (multiple squares)</li>\n              <li>Win by capturing all opponent pieces or blocking them</li>\n            </ul>\n          </div>\n          \n          <div className=\"flex items-center justify-between p-3 bg-muted/50 rounded-lg\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-6 h-6 rounded-full bg-gradient-to-br from-red-400 to-red-600\" />\n              <span>You</span>\n            </div>\n            <span className=\"text-muted-foreground\">vs</span>\n            <div className=\"flex items-center gap-2\">\n              <span>AI</span>\n              <div className=\"w-6 h-6 rounded-full bg-gradient-to-br from-gray-700 to-gray-900\" />\n            </div>\n          </div>\n          \n          {!isPractice && (\n            <div className=\"p-3 bg-amber-500/10 rounded-lg text-center\">\n              <p className=\"text-sm\"><span className=\"font-semibold\">Stake:</span> {stake.toLocaleString()} NGN</p>\n            </div>\n          )}\n          \n          <Button onClick={startGame} className=\"w-full\" size=\"lg\" data-testid=\"button-start-draughts\">\n            <Play className=\"h-5 w-5 mr-2\" />\n            Start Game\n          </Button>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <Card className=\"border-2\">\n        <CardHeader className=\"pb-2\">\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <Target className=\"h-5 w-5\" />\n              Draughts\n            </CardTitle>\n            <div className=\"flex items-center gap-2\">\n              {!isPractice && <Badge variant=\"secondary\">{stake.toLocaleString()} NGN</Badge>}\n              <Badge variant={currentPlayer === \"player\" ? \"default\" : \"outline\"}>\n                {currentPlayer === \"player\" ? <><User className=\"h-3 w-3 mr-1\" />Your Turn</> : <><Bot className=\"h-3 w-3 mr-1\" />AI Turn</>}\n              </Badge>\n            </div>\n          </div>\n        </CardHeader>\n        \n        <CardContent className=\"space-y-4\">\n          <div className=\"flex justify-between items-center text-sm\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 rounded-full bg-gradient-to-br from-red-400 to-red-600\" />\n              <span>You: {countPieces(board).player}</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <span>AI: {countPieces(board).ai}</span>\n              <div className=\"w-4 h-4 rounded-full bg-gradient-to-br from-gray-700 to-gray-900\" />\n            </div>\n          </div>\n          \n          <div className=\"flex justify-center\">\n            <div className=\"border-4 border-amber-900 rounded-md overflow-hidden shadow-xl\">\n              {Array(BOARD_SIZE).fill(null).map((_, row) => (\n                <div key={row} className=\"flex\">\n                  {Array(BOARD_SIZE).fill(null).map((_, col) => renderCell(row, col))}\n                </div>\n              ))}\n            </div>\n          </div>\n          \n          <AnimatePresence mode=\"wait\">\n            <motion.div key={message} initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 10 }} className=\"text-center text-sm text-muted-foreground\">\n              {message}\n            </motion.div>\n          </AnimatePresence>\n        </CardContent>\n      </Card>\n\n      <AnimatePresence>\n        {gamePhase === \"finished\" && (\n          <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.9 }}>\n            <Card className={`border-2 ${winner === \"player\" ? \"border-green-500\" : \"border-red-500\"}`}>\n              <CardContent className=\"p-6 text-center space-y-4\">\n                <div className={`inline-flex p-4 rounded-full ${winner === \"player\" ? \"bg-green-500/10\" : \"bg-red-500/10\"}`}>\n                  <Trophy className={`h-10 w-10 ${winner === \"player\" ? \"text-green-500\" : \"text-red-500\"}`} />\n                </div>\n                <h2 className=\"text-2xl font-bold\">{winner === \"player\" ? \"Victory!\" : \"Defeat\"}</h2>\n                <p className=\"text-muted-foreground\">\n                  {winner === \"player\" ? `You won with ${countPieces(board).player} pieces remaining!` : \"The AI was victorious this time.\"}\n                </p>\n                {!isPractice && (\n                  <p className={`font-semibold ${winner === \"player\" ? \"text-green-600\" : \"text-red-600\"}`}>\n                    {winner === \"player\" ? `+${(stake * 0.95 * 2).toLocaleString()} NGN` : `-${stake.toLocaleString()} NGN`}\n                  </p>\n                )}\n                <div className=\"flex gap-2 justify-center flex-wrap\">\n                  <Button onClick={startGame} variant=\"outline\"><RotateCcw className=\"h-4 w-4 mr-2\" />Play Again</Button>\n                  <Button onClick={handleGameEnd} data-testid=\"button-finish-draughts\">Finish</Button>\n                </div>\n              </CardContent>\n            </Card>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n","path":null,"size_bytes":21370,"size_tokens":null}},"version":2}